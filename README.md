[TOC]

# é¡¹ç›®åœ°å€

é¡¹ç›®åœ°å€ https://github.com/SpringSunYY/yp_picture 

# 1 - é¡¹ç›®æ€»è§ˆ

## ä¸€ã€é¡¹ç›®ä»‹ç» - é±¼å›¾å›¾

åŸºäº Vue 3 + Spring Boot + COS + WebSocket çš„ **ä¼ä¸šçº§æ™ºèƒ½ååŒäº‘å›¾åº“å¹³å°**ã€‚

å¹³å°çš„æ ¸å¿ƒåŠŸèƒ½å¯åˆ†ä¸º 4 å¤§ç±»ï¼š

1ï¼‰æ‰€æœ‰ç”¨æˆ·éƒ½å¯ä»¥åœ¨å¹³å°å…¬å¼€ä¸Šä¼ å’Œæ£€ç´¢å›¾ç‰‡ç´ æï¼Œå¿«é€Ÿæ‰¾åˆ°éœ€è¦çš„å›¾ç‰‡ã€‚å¯ç”¨ä½œè¡¨æƒ…åŒ…ç½‘ç«™ã€è®¾è®¡ç´ æç½‘ç«™ã€å£çº¸ç½‘ç«™ç­‰ï¼š

![img](./assets/rwN0ueItVjwgP8BC.webp)

2ï¼‰ç®¡ç†å‘˜å¯ä»¥ä¸Šä¼ ã€å®¡æ ¸å’Œç®¡ç†å›¾ç‰‡ï¼Œå¹¶å¯¹ç³»ç»Ÿå†…çš„å›¾ç‰‡è¿›è¡Œåˆ†æï¼šp87QUult0bZDR05AO5soQVixQ5nCQ+HA+P5tLSHK/hI=

![img](./assets/vjorA40uOaf8IrES.webp)

3ï¼‰å¯¹äºä¸ªäººç”¨æˆ·ï¼Œå¯å°†å›¾ç‰‡ä¸Šä¼ è‡³ç§æœ‰ç©ºé—´è¿›è¡Œæ‰¹é‡ç®¡ç†ã€æ£€ç´¢ã€ç¼–è¾‘å’Œåˆ†æï¼Œç”¨ä½œä¸ªäººç½‘ç›˜ã€ä¸ªäººç›¸å†Œã€ä½œå“é›†ç­‰ï¼š

![img](./assets/dXt3bfD2zgCSDyqU.webp)

4ï¼‰å¯¹äºä¼ä¸šï¼Œå¯å¼€é€šå›¢é˜Ÿç©ºé—´å¹¶é‚€è¯·æˆå‘˜ï¼Œå…±äº«å›¾ç‰‡å¹¶å®æ—¶ååŒç¼–è¾‘å›¾ç‰‡ï¼Œæé«˜å›¢é˜Ÿåä½œæ•ˆç‡ã€‚å¯ç”¨äºæä¾›å•†ä¸šæœåŠ¡ï¼Œå¦‚ä¼ä¸šæ´»åŠ¨ç›¸å†Œã€ä¼ä¸šå†…éƒ¨ç´ æåº“ç­‰ï¼š

![img](./assets/fJcbyE0T9HAmJ9EW.webp)

è¯¥é¡¹ç›®åŠŸèƒ½ä¸°å¯Œï¼Œæ¶‰åŠæ–‡ä»¶å­˜ç®¡ã€å†…å®¹æ£€ç´¢ã€æƒé™æ§åˆ¶ã€å®æ—¶ååŒç­‰ä¼ä¸šä¸»æµä¸šåŠ¡åœºæ™¯ï¼Œå¹¶è¿ç”¨å¤šç§ç¼–ç¨‹æ€æƒ³ã€æ¶æ„è®¾è®¡æ–¹æ³•å’Œä¼˜åŒ–ç­–ç•¥æ¥ä¿è¯é¡¹ç›®çš„é«˜é€Ÿè¿­ä»£å’Œç¨³å®šè¿è¡Œã€‚

æœ‰ä¸šåŠ¡ã€æœ‰æŠ€æœ¯ï¼Œä» 0 åˆ° 1 çš„çœŸå®ä¼ä¸šçº§ï¼ˆå•†ä¸šçº§ï¼‰é¡¹ç›®è®¾è®¡å¼€å‘ï¼Œç»å¯¹è®©ä½ æ”¶è·æ»¡æ»¡ï¼

### é¡¹ç›®ä¸‰å¤§é˜¶æ®µ

ä¸ºäº†å¸®å¤§å®¶å¾ªåºæ¸è¿›åœ°å­¦ä¹ ï¼Œé±¼çš®å°†é¡¹ç›®è®¾è®¡ä¸ºä¸‰ä¸ªé˜¶æ®µï¼Œå¯ä»¥æ ¹æ®è‡ªå·±çš„æ—¶é—´å’Œæ°´å¹³æŒ‰éœ€å­¦ä¹ ã€‚

1ï¼‰ç¬¬ä¸€é˜¶æ®µï¼Œå¼€å‘å…¬å…±çš„å›¾åº“å¹³å°ã€‚å®æˆ˜ Vue 3 + Spring Boot å›¾ç‰‡ç´ æç½‘ç«™çš„å¿«é€Ÿå¼€å‘ï¼Œå­¦ä¹ æ–‡ä»¶å­˜ç®¡ä¸šåŠ¡çš„å¼€å‘å’Œä¼˜åŒ–æŠ€å·§ã€‚

æˆæœï¼šå¯ç”¨ä½œè¡¨æƒ…åŒ…ç½‘ç«™ã€è®¾è®¡ç´ æç½‘ç«™ã€å£çº¸ç½‘ç«™ç­‰

![img](./assets/Idf82XIX3NA3DZ64.webp)

2ï¼‰ç¬¬äºŒé˜¶æ®µï¼Œå¯¹é¡¹ç›® C ç«¯åŠŸèƒ½è¿›è¡Œå¤§é‡æ‰©å±•ã€‚ç”¨æˆ·å¯å¼€é€šç§æœ‰ç©ºé—´ï¼Œå¹¶å¯¹ç©ºé—´å›¾ç‰‡è¿›è¡Œå¤šç»´æ£€ç´¢ã€æ‰«ç åˆ†äº«ã€æ‰¹é‡ç®¡ç†ã€å¿«é€Ÿç¼–è¾‘ã€ç”¨é‡åˆ†æã€‚è¯¥é˜¶æ®µæ¶‰åŠå¤§é‡ä¸»æµä¸šåŠ¡åŠŸèƒ½å¼€å‘ï¼Œèƒ½å­¦åˆ°å¾ˆå¤šä¸šåŠ¡çŸ¥è¯†å’Œå¼€å‘ç»éªŒã€‚

æˆæœï¼šå¯ç”¨ä½œä¸ªäººç½‘ç›˜ã€ä¸ªäººç›¸å†Œã€ä½œå“é›†ç­‰

![img](./assets/2Sr1JrsGLafkkPD1.webp)

3ï¼‰ç¬¬ä¸‰é˜¶æ®µï¼Œå¯¹é¡¹ç›® B ç«¯åŠŸèƒ½è¿›è¡Œå¤§é‡æ‰©å±•ã€‚ä¼ä¸šå¯å¼€é€šå›¢é˜Ÿç©ºé—´ï¼Œé‚€è¯·å’Œç®¡ç†ç©ºé—´æˆå‘˜ï¼Œå›¢é˜Ÿå†…å…±äº«å›¾ç‰‡å¹¶å®æ—¶ååŒç¼–è¾‘å›¾ç‰‡ã€‚è¯¥é˜¶æ®µæ¶‰åŠå¤§é‡å•†ä¸šé¡¹ç›®çš„åº”ç”¨åœºæ™¯ï¼Œèƒ½å­¦åˆ°å¾ˆå¤šæ¶æ„è®¾è®¡å’Œé¡¹ç›®ä¼˜åŒ–çš„æŠ€å·§ã€‚

æˆæœï¼šå¯ç”¨äºæä¾›å•†ä¸šæœåŠ¡ï¼Œå¦‚ä¼ä¸šæ´»åŠ¨ç›¸å†Œã€ä¼ä¸šå†…éƒ¨ç´ æåº“ç­‰

![img](./assets/284MzilnMyCRTN3Y.webp)

## äºŒã€é¡¹ç›®ä¼˜åŠ¿

### é¡¹ç›®æ”¶è·

æœ¬é¡¹ç›®é€‰é¢˜æ–°é¢–ã€åŠŸèƒ½ä¸°å¯Œã€ä¸šåŠ¡çœŸå®ã€åº”ç”¨å¹¿æ³›ã€‚åŒºåˆ«äºå¢åˆ æ”¹æŸ¥çš„ â€œçƒ‚å¤§è¡—â€ é¡¹ç›®ï¼Œé±¼çš®ä¼šå¸¦ä½ å®æˆ˜å¤§é‡æ–°æŠ€æœ¯å’Œå•†ä¸šåº”ç”¨åœºæ™¯ï¼ŒæŒæ¡å±‚å±‚é€’è¿›çš„ç³»ç»Ÿè®¾è®¡ã€é¡¹ç›®æ‰©å±•å’Œä¼˜åŒ–æ–¹æ¡ˆï¼Œç»™ä½ çš„ç®€å†å¤§å¹…å¢åŠ ç«äº‰åŠ›ã€‚

é±¼çš®ç»™å¤§å®¶è®²çš„éƒ½æ˜¯ **é€šç”¨çš„é¡¹ç›®å¼€å‘æ–¹æ³•å’Œæ¶æ„è®¾è®¡å¥—è·¯**ï¼Œä»è¿™ä¸ªé¡¹ç›®ä¸­ä½ å¯ä»¥å­¦åˆ°ï¼š

- å¦‚ä½•æ‹†è§£å¤æ‚ä¸šåŠ¡ï¼Œä» 0 å¼€å§‹è®¾è®¡å®ç°ä¼ä¸šçº§ç³»ç»Ÿï¼Ÿ
- å¦‚ä½•å·§ç”¨ RBAC æƒé™æ¨¡å‹å’Œæ¡†æ¶å®ç°å¤æ‚æƒé™æ§åˆ¶ï¼Ÿ
- å¦‚ä½•ç»“åˆ Redis + Caffeine æ„å»ºé«˜æ€§èƒ½å¤šçº§ç¼“å­˜ï¼Ÿ
- å¦‚ä½•å®ç°æ–‡ä»¶çš„é«˜æ•ˆå­˜å‚¨ï¼Œå¹¶é€šè¿‡åå‡ ç§ç­–ç•¥è¿›è¡Œä¼˜åŒ–ï¼Ÿ
- å¦‚ä½•ä½¿ç”¨é«˜çº§æ•°æ®ç»“æ„ Disruptor æ— é”é˜Ÿåˆ—æå‡å¹¶å‘æ€§èƒ½ï¼Ÿ
- å¦‚ä½•ä½¿ç”¨ ShardingSphere å®ç°åŠ¨æ€æ‰©å®¹çš„åˆ†åº“åˆ†è¡¨ï¼Ÿ
- å¦‚ä½•ä½¿ç”¨ WebSocket å¤šç«¯é€šä¿¡ï¼Œå®ç°ä¼ä¸šçº§å®æ—¶åä½œåŠŸèƒ½ï¼Ÿ
- å¦‚ä½•æ¥å…¥ AI ç»˜å›¾å¤§æ¨¡å‹ï¼Œå®ç°æ›´å¤šé«˜çº§å›¾ç‰‡å¤„ç†èƒ½åŠ›ï¼Ÿ
- å¦‚ä½•ä½¿ç”¨ DDD æ¶æ„å®ç°å¤§å‹ä¼ä¸šçº§é¡¹ç›®ï¼Ÿ
- å¦‚ä½•å¿«é€Ÿéƒ¨ç½²ä¸Šçº¿é¡¹ç›®ï¼Ÿ

æ­¤å¤–ï¼Œè¿˜èƒ½å­¦ä¼šå¾ˆå¤šä½œå›¾ã€æ€è€ƒé—®é¢˜ã€å¯¹æ¯”æ–¹æ¡ˆçš„æ–¹æ³•ï¼Œæå‡æ’æŸ¥é—®é¢˜ã€è‡ªä¸»è§£å†³ Bug çš„èƒ½åŠ›ã€‚é±¼çš®è¿˜ç»™å¤§å®¶æä¾›äº†å¤§é‡çš„é¡¹ç›®æ‰©å±•ç‚¹ï¼Œæœ‰èƒ½åŠ›çš„åŒå­¦å¯ä»¥è¿›ä¸€æ­¥æ‹‰å¼€å’Œåˆ«äººçš„åŒºåˆ†åº¦ï¼Œæ— é™è¿›æ­¥ï¼

### é±¼çš®ç³»åˆ—é¡¹ç›®ä¼˜åŠ¿

é±¼çš®åŸåˆ›é¡¹ç›®ç³»åˆ—ä»¥ **å®æˆ˜** ä¸ºä¸»ï¼Œç”¨ **å…¨ç¨‹ç›´æ’­** çš„æ–¹å¼ï¼Œ**ä» 0 åˆ° 1 ** å¸¦å¤§å®¶å­¦ä¹ æŠ€æœ¯çŸ¥è¯†ï¼Œå¹¶ç«‹å³å®è·µè¿ç”¨åˆ°é¡¹ç›®ä¸­ï¼Œåšåˆ°å­¦ä»¥è‡´ç”¨ã€‚

æ­¤å¤–ï¼Œè¿˜æä¾›å¦‚ä¸‹æœåŠ¡ï¼š

- è¯¦ç»†çš„æ–‡å­—æ•™ç¨‹æˆ–ç›´æ’­ç¬”è®°
- å®Œæ•´çš„é¡¹ç›®æºç 
- 1 å¯¹ 1 ç­”ç–‘è§£æƒ‘
- ä¸“å±é¡¹ç›®äº¤æµç¾¤
- â­ï¸ ç°æˆçš„ç®€å†å†™æ³•ï¼ˆç›´æ¥å†™æ»¡ç®€å†ï¼‰
- â­ï¸ é¡¹ç›®çš„æ‰©å±•æ€è·¯ï¼ˆæ‹‰å¼€å’Œå…¶ä»–äººçš„å·®è·ï¼‰
- â­ï¸ é¡¹ç›®ç›¸å…³é¢è¯•é¢˜ã€é¢˜è§£å’ŒçœŸå®é¢ç»ï¼ˆæå‰å‡†å¤‡ï¼Œé¢è¯•ä¸æ‡µé€¼ï¼‰
- â­ï¸ å‰ç«¯ + Java åç«¯ä¸‡ç”¨é¡¹ç›®æ¨¡æ¿ï¼ˆå¿«é€Ÿåˆ›å»ºé¡¹ç›®ï¼‰

æ¯”èµ·çœ‹ç½‘ä¸Šçš„æ•™ç¨‹å­¦ä¹ ï¼Œé±¼çš®é¡¹ç›®ç³»åˆ—çš„ä¼˜åŠ¿ï¼šä»å­¦çŸ¥è¯† => å®è·µé¡¹ç›® => å¤ä¹ ç¬”è®° => é¡¹ç›®ç­”ç–‘ => ç®€å†å†™æ³• => é¢è¯•é¢˜è§£çš„ä¸€æ¡é¾™æœåŠ¡

ä»éœ€æ±‚åˆ†æã€æŠ€æœ¯é€‰å‹ã€é¡¹ç›®è®¾è®¡ã€é¡¹ç›®åˆå§‹åŒ–ã€Demo ç¼–å†™ã€å‰åç«¯å¼€å‘å®ç°ã€é¡¹ç›®ä¼˜åŒ–ã€éƒ¨ç½²ä¸Šçº¿ç­‰ï¼Œæ¯ä¸ªç¯èŠ‚æˆ‘éƒ½ **ä»ç†è®ºåˆ°å®è·µ** ç»™å¤§å®¶è®²çš„æ˜æ˜ç™½ç™½ã€æ¯ä¸ªç»†èŠ‚éƒ½ä¸æ”¾è¿‡ï¼

| å¯¹æ¯”ç»´åº¦ | è·Ÿå­¦é±¼çš®é¡¹ç›®                                                 | è‡ªå­¦ç½‘ä¸Šå…è´¹é¡¹ç›®                                             | â­ï¸ é±¼çš®é¡¹ç›®ä¼˜åŠ¿               |
| -------- | ------------------------------------------------------------ | ------------------------------------------------------------ | ---------------------------- |
| é¡¹ç›®é€‰é¢˜ | âœ… é€‰é¢˜æ–°é¢–ï¼Œåˆ»æ„é¿å¼€ç½‘ä¸Šçƒ­é—¨é¡¹ç›®                             | ä¼ ç»Ÿé¡¹ç›®åœºæ™¯ï¼ˆåšå®¢ã€å•†åŸã€ç®¡ç†ç³»ç»Ÿï¼‰                         | å¢åŠ åŒºåˆ†åº¦ï¼Œæé«˜ç®€å†é€šè¿‡ç‡   |
| å­¦ä¹ äººæ•° | âœ… å°‘ï¼Œä¸å®¹æ˜“æ’è½¦                                             | ç™¾ä¸‡ä»¥ä¸Šï¼Œçƒ‚å¤§è¡—                                             | å¢åŠ åŒºåˆ†åº¦ï¼Œæé«˜ç®€å†é€šè¿‡ç‡   |
| æ•™å­¦æ–¹å¼ | âœ… å…¨ç¨‹ç›´æ’­ï¼Œå¸¦ä½ æ•²æ¯ä¸€è¡Œä»£ç ã€å¸¦ä½ è¸©å‘å’Œè§£å†³ Bugï¼Œä¸æ¼è¿‡æ¯ä¸€ä¸ªç»†èŠ‚ | å½•åˆ¶è¯¾ç¨‹ï¼Œè§†é¢‘è™½ç„¶çœ‹èµ·æ¥ç®€çŸ­ã€ä¸€å¸†é£é¡ºï¼Œä½†ä½ é‡åˆ°é”™è¯¯æ— ä»ä¸‹æ‰‹ | é™ä½å­¦ä¹ é—¨æ§›ï¼Œå‡å°‘å­¦ä¹ æ—¶é•¿   |
| ç›´æ’­ç¬”è®° | âœ… è¯¦ç»†çš„å®˜æ–¹ç¬”è®° + ç²¾é€‰å­¦å‘˜ä¼˜è´¨ç¬”è®°                          | æœ‰ç¬”è®°ï¼Œä½†æœªç»ç­›é€‰                                           | å­¦åˆ°æ›´å¤šçŸ¥è¯†ç»†èŠ‚             |
| è§†é¢‘å†…å®¹ | âœ… é¡¹ç›®æ•™ç¨‹ + ç»éªŒåˆ†äº«                                        | é¡¹ç›®æ•™ç¨‹                                                     | å­¦åˆ°æ›´å¤šç¼–ç¨‹ç»éªŒ             |
| é¡¹ç›®æºç  | âœ… å®Œæ•´æºç ä»“åº“ + æ¯ç« çš„æäº¤è®°å½• + å®šæœŸæ›´æ–°                   | åªæœ‰ä»£ç åŒ…ã€ä¸æ›´æ–°                                           | èŠ‚çœæ—¶é—´ï¼Œé¿å…è¸©å‘           |
| é¡¹ç›®ç­”ç–‘ | âœ… å„é¡¹ç›®äº¤æµç¾¤ + ç­”ç–‘è§£æƒ‘ + å¸¸è§é—®é¢˜æ•´ç†                     | æ— å…è´¹çš„ç­”ç–‘æœåŠ¡ï¼Œé‡åˆ°é—®é¢˜è‡ªè¡Œè§£å†³                           | èŠ‚çœæ—¶é—´                     |
| ç®€å†å†™æ³• | âœ… ç°æˆçš„ç®€å†å†™æ³•                                             | æ—                                                            | èŠ‚çœæ—¶é—´ã€æé«˜ç®€å†é€šè¿‡ç‡     |
| é¡¹ç›®æ‰©å±• | âœ… ç»™å‡ºæ‰©å±•æ€è·¯ + å­¦å‘˜ä½œå“å…±äº«                                | æ—                                                            | å¼€æ‹“æ€è·¯ã€æ‹‰å¼€å’Œå…¶ä»–äººçš„å·®è· |
| é¡¹ç›®é¢è¯• | âœ… é¡¹ç›®ç›¸å…³é¢è¯•é¢˜ã€é¢˜è§£å’ŒçœŸå®é¢ç»                             | æ—                                                            | æå‰å‡†å¤‡ï¼Œé¢è¯•ä¸æ‡µé€¼         |

ç¼–ç¨‹å¯¼èˆªå·²æœ‰ **10 å¤šå¥—é¡¹ç›®æ•™ç¨‹ï¼**æ¯ä¸ªé¡¹ç›®çš„å­¦ä¹ é‡ç‚¹ä¸åŒï¼Œå‡ ä¹å…¨éƒ½æ˜¯å‰ç«¯ + åç«¯çš„ **å…¨æ ˆé¡¹ç›®** ã€‚

è¯¦ç»†è¯·è§ï¼š[https://codefather.cn/course](https://www.codefather.cn/course)ï¼ˆåœ¨è¯¥é¡µé¢å³ä¾§æœ‰æ•™ç¨‹æ¨èå’Œå­¦ä¹ å»ºè®®ï¼‰Kvj0N9UsvjnA2JCtBYVVlZvRih721R4WfPhhdfsvDfk=

å¾€æœŸé¡¹ç›®ä»‹ç»è§†é¢‘ï¼š[https://bilibili.com/video/BV1YvmbYbEgS](https://www.bilibili.com/video/BV1YvmbYbEgS/)

## ä¸‰ã€æ ¸å¿ƒä¸šåŠ¡æµç¨‹

### ç¬¬ä¸€é˜¶æ®µ - å…¬å…±å›¾åº“å¹³å°

![img](./assets/Azv14HDTAx7LHaR3.webp)

### ç¬¬äºŒé˜¶æ®µ - ç”¨æˆ·ç§æœ‰å›¾åº“

![img](./assets/hhXfk5ybOWguDR6h.webp)

### ç¬¬ä¸‰é˜¶æ®µ - å›¢é˜Ÿå…±äº«å›¾åº“

![img](./assets/LnhweNpxB2q9zG5U.webp)

## å››ã€é¡¹ç›®åŠŸèƒ½æ¢³ç†

### ç¬¬ä¸€é˜¶æ®µ - å…¬å…±å›¾åº“å¹³å°

#### ç”¨æˆ·æ¨¡å—

- ç”¨æˆ·ç™»å½•
- ç”¨æˆ·æ³¨å†Œ
- ç”¨æˆ·æ³¨é”€
- ç”¨æˆ·æƒé™æ§åˆ¶
- ã€ç®¡ç†å‘˜ã€‘ç®¡ç†ç”¨æˆ·

#### å›¾ç‰‡æ¨¡å—

- ã€ç®¡ç†å‘˜ã€‘ä¸Šä¼ åˆ›å»ºå›¾ç‰‡
- ã€ç®¡ç†å‘˜ã€‘å›¾ç‰‡ä¿¡æ¯ç¼–è¾‘ï¼ˆæ ‡ç­¾ / åˆ†ç±»ç­‰ï¼‰
- ã€ç®¡ç†å‘˜ã€‘ç®¡ç†å›¾ç‰‡
- æŸ¥çœ‹å’Œæœç´¢å›¾ç‰‡åˆ—è¡¨
- æŸ¥çœ‹å›¾ç‰‡è¯¦æƒ…ï¼ˆè¿›å…¥å›¾ç‰‡è¯¦æƒ…é¡µï¼‰
- å›¾ç‰‡ä¸‹è½½
- ç”¨æˆ·ä¸Šä¼ åˆ›å»ºå›¾ç‰‡
- ã€ç®¡ç†å‘˜ã€‘å®¡æ ¸å›¾ç‰‡
- å¯¼å…¥å›¾ç‰‡
- - é€šè¿‡ URL å¯¼å…¥å›¾ç‰‡
  - ã€ç®¡ç†å‘˜ã€‘æ‰¹é‡æŠ“å–å’Œåˆ›å»ºå›¾ç‰‡
- ã€ä¼˜åŒ–ã€‘å›¾ç‰‡æŸ¥è¯¢ä¼˜åŒ– - åˆ†å¸ƒå¼ç¼“å­˜ã€æœ¬åœ°ç¼“å­˜ã€å¤šçº§ç¼“å­˜
- ã€ä¼˜åŒ–ã€‘å›¾ç‰‡ä¸Šä¼ ä¼˜åŒ– - å‹ç¼©ã€ç§’ä¼ ã€åˆ†ç‰‡ä¸Šä¼ ã€æ–­ç‚¹ç»­ä¼ 
- ã€ä¼˜åŒ–ã€‘å›¾ç‰‡åŠ è½½ä¼˜åŒ– - æ‡’åŠ è½½ã€ç¼©ç•¥å›¾ã€CDN åŠ é€Ÿã€æµè§ˆå™¨ç¼“å­˜
- ã€ä¼˜åŒ–ã€‘å›¾ç‰‡å­˜å‚¨ä¼˜åŒ– - é™é¢‘å­˜å‚¨ï¼ˆå†·çƒ­æ•°æ®åˆ†ç¦»ï¼‰ã€æ¸…ç†ç­–ç•¥

### ç¬¬äºŒé˜¶æ®µ - ç”¨æˆ·ç§æœ‰å›¾åº“

#### ç©ºé—´æ¨¡å—

- ã€ç®¡ç†å‘˜ã€‘ç®¡ç†ç©ºé—´
- ç”¨æˆ·å¼€é€šç§æœ‰ç©ºé—´
- ç§æœ‰ç©ºé—´æƒé™æ§åˆ¶
- ç©ºé—´çº§åˆ«å’Œé™é¢æ§åˆ¶
- ç©ºé—´å›¾åº“åˆ†æ
- - ç”¨æˆ·ç©ºé—´å›¾åº“åˆ†æ
  - ã€ç®¡ç†å‘˜ã€‘å…¨ç©ºé—´åˆ†æ

#### å›¾ç‰‡æ¨¡å—

- å›¾ç‰‡æœç´¢
- - åŸºç¡€å±æ€§æœç´¢
  - ä»¥å›¾æœå›¾
  - é¢œè‰²æœç´¢
- å›¾ç‰‡åˆ†äº«
- - é“¾æ¥åˆ†äº«
  - æ‰«ç åˆ†äº«
- å›¾ç‰‡æ‰¹é‡ç®¡ç†
- - æ‰¹é‡ä¿®æ”¹ä¿¡æ¯
  - æ‰¹é‡é‡å‘½å
- å›¾ç‰‡ç¼–è¾‘
- - åŸºç¡€å›¾ç‰‡ç¼–è¾‘
  - AI å›¾ç‰‡ç¼–è¾‘

### ç¬¬ä¸‰é˜¶æ®µ - å›¢é˜Ÿå…±äº«å›¾åº“

#### ç©ºé—´æ¨¡å—

- åˆ›å»ºå›¢é˜Ÿå…±äº«ç©ºé—´
- ç©ºé—´æˆå‘˜ç®¡ç†
- - æˆå‘˜é‚€è¯·
  - è®¾ç½®æƒé™
- ç©ºé—´æˆå‘˜æƒé™æ§åˆ¶

#### å›¾ç‰‡æ¨¡å—

- å›¾ç‰‡ååŒç¼–è¾‘

## äº”ã€æŠ€æœ¯é€‰å‹

### åç«¯

- Java Spring Boot æ¡†æ¶
- MySQL æ•°æ®åº“ + MyBatis-Plus æ¡†æ¶ + MyBatis X
- Redis åˆ†å¸ƒå¼ç¼“å­˜ + Caffeine æœ¬åœ°ç¼“å­˜
- Jsoup æ•°æ®æŠ“å–
- â­ï¸ COS å¯¹è±¡å­˜å‚¨
- â­ï¸ ShardingSphere åˆ†åº“åˆ†è¡¨
- â­ï¸ Sa-Token æƒé™æ§åˆ¶
- â­ï¸ DDD é¢†åŸŸé©±åŠ¨è®¾è®¡
- â­ï¸ WebSocket åŒå‘é€šä¿¡
- â­ï¸ Disruptor é«˜æ€§èƒ½æ— é”é˜Ÿåˆ—
- â­ï¸ JUC å¹¶å‘å’Œå¼‚æ­¥ç¼–ç¨‹
- â­ï¸ AI ç»˜å›¾å¤§æ¨¡å‹æ¥å…¥
- â­ï¸ å¤šç§è®¾è®¡æ¨¡å¼çš„è¿ç”¨
- â­ï¸ å¤šè§’åº¦é¡¹ç›®ä¼˜åŒ–ï¼šæ€§èƒ½ã€æˆæœ¬ã€å®‰å…¨æ€§ç­‰

### å‰ç«¯

- Vue 3 æ¡†æ¶
- Vite æ‰“åŒ…å·¥å…·
- Ant Design Vue ç»„ä»¶åº“
- Axios è¯·æ±‚åº“
- Pinia å…¨å±€çŠ¶æ€ç®¡ç†
- å…¶ä»–ç»„ä»¶ï¼šæ•°æ®å¯è§†åŒ–ã€å›¾ç‰‡ç¼–è¾‘ç­‰
- â­ï¸ å‰ç«¯å·¥ç¨‹åŒ–ï¼šESLint + Prettier + TypeScript
- â­ï¸ OpenAPI å‰ç«¯ä»£ç ç”Ÿæˆ

## å…­ã€æ¶æ„è®¾è®¡

![img](./assets/EgAmpl2keFkqj8q5.webp)

## æ–°å»ºä»£ç ä»“åº“

æ­å»ºä»“åº“ï¼Œç‚¹ star çš„éƒ½æ˜¯ç²¾ç¥è‚¡ä¸œ

ä»£ç ä»“åº“ï¼šhttps://github.com/liyupi/yu-picture

## æ•™ç¨‹è®¡åˆ’

### ç¬¬ä¸€é˜¶æ®µ - å…¬å…±å›¾åº“å¹³å°

ç¬¬ 1 æœŸï¼šé¡¹ç›®ä»‹ç»ã€‚åŒ…æ‹¬ä»‹ç»é¡¹ç›®èƒŒæ™¯ã€é¡¹ç›®ä¼˜åŠ¿ã€æ ¸å¿ƒä¸šåŠ¡æµç¨‹ã€é¡¹ç›®åŠŸèƒ½ã€æŠ€æœ¯é€‰å‹ã€æ¶æ„è®¾è®¡ã€æ•™ç¨‹è®¡åˆ’ç­‰ã€‚

ç¬¬ 2 æœŸï¼šé¡¹ç›®åˆå§‹åŒ–

- åç«¯é¡¹ç›®åˆå§‹åŒ–
- å‰ç«¯é¡¹ç›®åˆå§‹åŒ–

ç¬¬ 3 æœŸï¼šç”¨æˆ·æ¨¡å—å¼€å‘ï¼ˆå‰åç«¯ï¼‰

- ç”¨æˆ·ç™»å½•
- ç”¨æˆ·æ³¨å†Œ
- ç”¨æˆ·æ³¨é”€
- ç”¨æˆ·æƒé™æ§åˆ¶
- ç”¨æˆ·ç®¡ç†

ç¬¬ 4 æœŸï¼šå›¾ç‰‡æ¨¡å—å¼€å‘ï¼ˆå‰åç«¯ï¼‰

- ã€ç®¡ç†å‘˜ã€‘å›¾ç‰‡ä¸Šä¼ å’Œåˆ›å»º
- ã€ç®¡ç†å‘˜ã€‘ç®¡ç†å›¾ç‰‡
- ã€ç®¡ç†å‘˜ã€‘å›¾ç‰‡ä¿¡æ¯ç¼–è¾‘ï¼ˆæ ‡ç­¾ / åˆ†ç±»ç­‰ï¼‰
- æŸ¥çœ‹å’Œæœç´¢å›¾ç‰‡åˆ—è¡¨
- æŸ¥çœ‹å›¾ç‰‡è¯¦æƒ…ï¼ˆè¿›å…¥å›¾ç‰‡è¯¦æƒ…é¡µï¼‰
- å›¾ç‰‡ä¸‹è½½

ç¬¬ 5 æœŸï¼šç”¨æˆ·ä¸Šä¼ å›¾ç‰‡æ¨¡å—ï¼ˆå‰åç«¯ï¼‰

- ç”¨æˆ·ä¸Šä¼ åˆ›å»ºå›¾ç‰‡
- ã€ç®¡ç†å‘˜ã€‘å®¡æ ¸å›¾ç‰‡
- å¯¼å…¥å›¾ç‰‡
- - é€šè¿‡ URL å¯¼å…¥å›¾ç‰‡
  - ã€ç®¡ç†å‘˜ã€‘æ‰¹é‡æŠ“å–å’Œåˆ›å»ºå›¾ç‰‡

ç¬¬ 6 æœŸï¼šå›¾ç‰‡ä¼˜åŒ–

- å›¾ç‰‡æŸ¥è¯¢ä¼˜åŒ– - åˆ†å¸ƒå¼ç¼“å­˜ã€æœ¬åœ°ç¼“å­˜ã€å¤šçº§ç¼“å­˜
- å›¾ç‰‡ä¸Šä¼ ä¼˜åŒ– - å‹ç¼©ã€ç§’ä¼ ã€åˆ†ç‰‡ä¸Šä¼ ã€æ–­ç‚¹ç»­ä¼ 
- å›¾ç‰‡åŠ è½½ä¼˜åŒ– - æ‡’åŠ è½½ã€ç¼©ç•¥å›¾ã€CDN åŠ é€Ÿã€æµè§ˆå™¨ç¼“å­˜
- å›¾ç‰‡å­˜å‚¨ä¼˜åŒ– - é™é¢‘å­˜å‚¨ï¼ˆå†·çƒ­æ•°æ®åˆ†ç¦»ï¼‰ã€æ¸…ç†ç­–ç•¥

### ç¬¬äºŒé˜¶æ®µ - ç”¨æˆ·ç§æœ‰å›¾åº“

ç¬¬ 7 æœŸï¼šç©ºé—´æ¨¡å—å¼€å‘

- ã€ç®¡ç†å‘˜ã€‘ç®¡ç†ç©ºé—´
- ç”¨æˆ·å¼€é€šç§æœ‰ç©ºé—´
- ç§æœ‰ç©ºé—´æƒé™æ§åˆ¶
- ç©ºé—´çº§åˆ«å’Œé™é¢æ§åˆ¶

ç¬¬ 8 æœŸï¼šå›¾ç‰‡åŠŸèƒ½æ‰©å±•

- å›¾ç‰‡æœç´¢
- - åŸºç¡€å±æ€§æœç´¢
  - ä»¥å›¾æœå›¾
  - é¢œè‰²æœç´¢
- å›¾ç‰‡åˆ†äº«
- - é“¾æ¥åˆ†äº«
  - æ‰«ç åˆ†äº«
- å›¾ç‰‡æ‰¹é‡ç®¡ç†
- - æ‰¹é‡ä¿®æ”¹ä¿¡æ¯
  - æ‰¹é‡é‡å‘½å

ç¬¬ 9 æœŸï¼šå›¾ç‰‡ç¼–è¾‘èƒ½åŠ›

- å›¾ç‰‡ç¼–è¾‘
- - åŸºç¡€å›¾ç‰‡ç¼–è¾‘
  - AI å›¾ç‰‡ç¼–è¾‘

ç¬¬ 10 æœŸï¼šç©ºé—´å›¾ç‰‡åˆ†æ

- ç©ºé—´å›¾åº“åˆ†æ
- - ç”¨æˆ·ç©ºé—´å›¾åº“åˆ†æ
  - ã€ç®¡ç†å‘˜ã€‘å…¨ç©ºé—´åˆ†æ

### ç¬¬ä¸‰é˜¶æ®µ - å›¢é˜Ÿå…±äº«å›¾åº“

ç¬¬ 11 æœŸï¼šå›¢é˜Ÿå…±äº«ç©ºé—´

- åˆ›å»ºå›¢é˜Ÿå…±äº«ç©ºé—´
- ç©ºé—´æˆå‘˜ç®¡ç†
- - æˆå‘˜é‚€è¯·
  - è®¾ç½®æƒé™
- ç©ºé—´æˆå‘˜æƒé™æ§åˆ¶

ç¬¬ 12 æœŸï¼šå›¾ç‰‡ååŒç¼–è¾‘

ç¬¬ 13 æœŸï¼šDDD é¡¹ç›®æ”¹é€ 

ç¬¬ 14 æœŸï¼šé¡¹ç›®éƒ¨ç½²ä¸Šçº¿





# 2 - é¡¹ç›®åˆå§‹åŒ–

## æœ¬èŠ‚é‡ç‚¹

ä» 0 å¼€å§‹æ­å»ºåç«¯å’Œå‰ç«¯é¡¹ç›®ï¼Œä¼šåç»­æ­£å¼å¼€å‘é¡¹ç›®æ‰“å¥½åŸºç¡€ã€‚

åŒ…æ‹¬ï¼š

- åç«¯é¡¹ç›®åˆå§‹åŒ–
- å‰ç«¯é¡¹ç›®åˆå§‹åŒ–

æœ¬èŠ‚æ•™ç¨‹çš„åç«¯å’Œå‰ç«¯äº’ä¸å½±å“ï¼Œå¯ä»¥æŒ‰éœ€ç‹¬ç«‹å­¦ä¹ ï¼Œå»ºè®®ä¼˜å…ˆå­¦ä¹ è‡ªå·±æ±‚èŒæ–¹å‘çš„å†…å®¹ã€‚

## ä¸€ã€åç«¯é¡¹ç›®åˆå§‹åŒ–

### ç¯å¢ƒå‡†å¤‡

1ï¼‰å®‰è£…çš„ JDK ç‰ˆæœ¬å¿…é¡»æ˜¯ 8ã€11 æˆ– 17ï¼Œ**ä¸èƒ½è¶…è¿‡ 17ï¼**

æ¨èä½¿ç”¨ 11 ç‰ˆæœ¬ï¼Œå› ä¸ºåç»­å¯èƒ½è¦ç”¨åˆ°çš„ç¼“å­˜åº“ Caffeine è¦æ±‚ä½¿ç”¨ 11 ç‰ˆæœ¬ã€‚

å¯å‚è€ƒè§†é¢‘å®‰è£… JDKï¼šhttps://www.bilibili.com/video/BV14SUNYREv8

2ï¼‰MySQL æ•°æ®åº“æœ€å¥½å®‰è£… 8.x ç‰ˆæœ¬ï¼Œæˆ–è€… 5.7 ç‰ˆæœ¬ã€‚

### æ–°å»ºé¡¹ç›®

åœ¨ IDEA ä¸­æ–°å»ºé¡¹ç›®ï¼Œé€‰æ‹© Spring Initializr æ¨¡æ¿ï¼Œè€ƒè™‘åˆ°ç¨³å®šæ€§ï¼Œæ­¤å¤„é€‰æ‹©åˆ›å»º Java 8 ç‰ˆæœ¬çš„é¡¹ç›®ã€‚

æ³¨æ„éœ€è¦æ›¿æ¢ Server URL ä¸º https://start.aliyun.com/ï¼Œå› ä¸ºå®˜æ–¹çš„ Server URL ä¸æ”¯æŒé€‰æ‹© Java 8ã€‚

é…ç½®å¦‚å›¾ï¼š

![img](./assets/GUzAfYi5pwKtrdGH.webp)

é€‰æ‹© Spring Boot 2.7.6 ç‰ˆæœ¬ï¼Œå¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€è¦æ·»åŠ ä¸€äº›ä¾èµ–ï¼Œæ¯”å¦‚ Spring Webã€MyBatisã€MySQLã€Lombokï¼š

![img](./assets/sRkevqdJCHu8aoH5.webp)

> å½“ç„¶ï¼Œåç»­é€šè¿‡ä¿®æ”¹ Maven é…ç½®æ·»åŠ ä¾èµ–ä¹Ÿæ˜¯å¯ä»¥çš„ã€‚

ç‚¹å‡»åˆ›å»ºï¼Œå°±å¾—åˆ°äº†ä¸€ä¸ª Spring Boot é¡¹ç›®ï¼Œéœ€è¦ç­‰å¾… Maven ä¸ºæˆ‘ä»¬å®‰è£…ä¾èµ–ã€‚

å®‰è£…å®Œä¾èµ–åï¼Œå…ˆå°è¯•å¯åŠ¨ä¸€ä¸‹é¡¹ç›®ï¼Œç»“æœä¼šæŠ¥é”™ï¼š

![img](./assets/37FgGCXDIyLjQT0N.webp)

å› ä¸ºæˆ‘ä»¬åœ¨ Maven ä¸­å¼•å…¥äº† MySQL ä¾èµ–ï¼Œä½†æ˜¯é¡¹ç›®é…ç½®æ–‡ä»¶ä¸­å¹¶æ²¡æœ‰å¡«å†™ MySQL çš„é…ç½®ã€‚

ä¿®æ”¹èµ„æºç›®å½•ä¸‹çš„é…ç½®æ–‡ä»¶ä¸º `application.yml`ï¼ŒæŒ‡å®šé¡¹ç›®å¯åŠ¨çš„ç«¯å£å·å’Œè®¿é—®åœ°å€å‰ç¼€ã€é¡¹ç›®åç§°ã€æ•°æ®åº“é…ç½®ç­‰ã€‚ä»£ç å¦‚ä¸‹ï¼š

```yaml
server:
  port: 8123
  servlet:
    context-path: /api
spring:
  application:
    name: yu-picture-backend
  # æ•°æ®åº“é…ç½®
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://localhost:3306/yu_picture
    username: root
    password: 123456
```

è¿™æ¬¡é¡¹ç›®å°±å¯ä»¥æ­£å¸¸å¯åŠ¨äº†ï¼š

![img](./assets/UYApmAhjTArrPR9G.webp)

### æ•´åˆä¾èµ–

æ¥ä¸‹æ¥æˆ‘ä»¬è¦æ•´åˆä¸€äº›å¼€å‘é¡¹ç›®å¸¸ç”¨çš„ä¾èµ–ã€‚

#### 1ã€MyBatis Plus æ•°æ®åº“æ“ä½œ

MyBatis Plus æ˜¯ MyBatis çš„å¢å¼ºå·¥å…·ï¼Œæ—¨åœ¨ç®€åŒ–å¼€å‘æµç¨‹ã€‚å®ƒæä¾›äº†å¼€ç®±å³ç”¨çš„ CRUD æ–¹æ³•ã€åŠ¨æ€æŸ¥è¯¢æ„é€ å™¨ã€åˆ†é¡µæ’ä»¶å’Œä»£ç ç”Ÿæˆå™¨ç­‰åŠŸèƒ½ï¼Œå¤§å¹…å‡å°‘é‡å¤ä»£ç ï¼ŒåŒæ—¶ä¿æŒä¸ MyBatis åŸç”ŸåŠŸèƒ½çš„å…¼å®¹æ€§ã€‚ä¾‹å¦‚ï¼Œé€šè¿‡è°ƒç”¨ `baseMapper.selectById(id)`ï¼Œå¯ä»¥ç›´æ¥æŸ¥è¯¢æ•°æ®åº“ä¸­çš„è®°å½•ï¼Œè€Œæ— éœ€æ‰‹åŠ¨ç¼–å†™ SQLã€‚

å‚è€ƒå®˜æ–¹æ–‡æ¡£å¼•å…¥ï¼šhttps://baomidou.com/getting-started/#spring-boot2

åœ¨ Maven çš„ pom.xml ä¸­æ·»åŠ ä¾èµ–ï¼š

```xml
<dependency>
    <groupId>com.baomidou</groupId>
    <artifactId>mybatis-plus-boot-starter</artifactId>
    <version>3.5.9</version>
</dependency>
```

**æ³¨æ„ï¼Œæ·»åŠ è¯¥ä¾èµ–åï¼Œè®°å¾—ç§»é™¤ MyBatis ç›¸å…³çš„ä¾èµ–ï¼å¦åˆ™å¾ˆå®¹æ˜“å¯¼è‡´ç‰ˆæœ¬å†²çªï¼ï¼ï¼**

![img](./assets/cjTIN1jZdCRN1baf.webp)

åœ¨é¡¹ç›®ä¸­æ–°å»º mapper åŒ…ï¼Œåç»­ç”¨äºå­˜æ”¾æ“ä½œæ•°æ®åº“çš„ Mapper ç±»ï¼Œç„¶ååœ¨é¡¹ç›®å¯åŠ¨ç±»ä¸­æ·»åŠ æ‰«æ Mapper çš„ `@MapperScan` æ³¨è§£ï¼š

```java
@SpringBootApplication
@MapperScan("com.yupi.yupicturebackend.mapper")
public class YuPictureBackendApplication {

    public static void main(String[] args) {
        SpringApplication.run(YuPictureBackendApplication.class, args);
    }

}
```

åœ¨ application.yml ä¸­è¿½åŠ é…ç½®ï¼Œå¼€å¯æ—¥å¿—å’Œé€»è¾‘åˆ é™¤åŠŸèƒ½ï¼š

```yaml
mybatis-plus:
  configuration:
    map-underscore-to-camel-case: false
    # ä»…åœ¨å¼€å‘ç¯å¢ƒå¼€å¯æ—¥å¿—
    log-impl: org.apache.ibatis.logging.stdout.StdOutImpl
  global-config:
    db-config:
      logic-delete-field: isDelete # å…¨å±€é€»è¾‘åˆ é™¤çš„å®ä½“å­—æ®µå
      logic-delete-value: 1 # é€»è¾‘å·²åˆ é™¤å€¼ï¼ˆé»˜è®¤ä¸º 1ï¼‰
      logic-not-delete-value: 0 # é€»è¾‘æœªåˆ é™¤å€¼ï¼ˆé»˜è®¤ä¸º 0ï¼‰
```

#### 2ã€Hutool å·¥å…·åº“

Hutool æ˜¯ä¸»æµçš„ Java å·¥å…·ç±»åº“ï¼Œé›†åˆäº†ä¸°å¯Œçš„å·¥å…·ç±»ï¼Œæ¶µç›–å­—ç¬¦ä¸²å¤„ç†ã€æ—¥æœŸæ“ä½œã€æ–‡ä»¶å¤„ç†ã€åŠ è§£å¯†ã€åå°„ã€æ­£åˆ™åŒ¹é…ç­‰å¸¸è§åŠŸèƒ½ã€‚å®ƒçš„è½»é‡åŒ–å’Œæ— ä¾µå…¥æ€§è®©å¼€å‘è€…èƒ½å¤Ÿä¸“æ³¨äºä¸šåŠ¡é€»è¾‘è€Œä¸å¿…ç¼–å†™é‡å¤çš„å·¥å…·ä»£ç ã€‚ä¾‹å¦‚ï¼Œ`DateUtil.formatDate(new Date())` å¯ä»¥å¿«é€Ÿå°†å½“å‰æ—¥æœŸæ ¼å¼åŒ–ä¸ºå­—ç¬¦ä¸²ã€‚

å‚è€ƒå®˜æ–¹æ–‡æ¡£å¼•å…¥ï¼š[https://doc.hutool.cn/pages/index/#%F0%9F%8D%8Amaven](https://doc.hutool.cn/pages/index/#ğŸŠmaven)

åœ¨ Maven çš„ pom.xml ä¸­æ·»åŠ ä¾èµ–ï¼š

```xml
<dependency>
    <groupId>cn.hutool</groupId>
    <artifactId>hutool-all</artifactId>
    <version>5.8.26</version>
</dependency>
```

#### 3ã€Knife4j æ¥å£æ–‡æ¡£

Knife4j æ˜¯åŸºäº Swagger æ¥å£æ–‡æ¡£çš„å¢å¼ºå·¥å…·ï¼Œæä¾›äº†æ›´åŠ å‹å¥½çš„ API æ–‡æ¡£ç•Œé¢å’ŒåŠŸèƒ½æ‰©å±•ï¼Œä¾‹å¦‚åŠ¨æ€å‚æ•°è°ƒè¯•ã€åˆ†ç»„æ–‡æ¡£ç­‰ã€‚å®ƒé€‚åˆç”¨äº Spring Boot é¡¹ç›®ä¸­ï¼Œèƒ½å¤Ÿé€šè¿‡ç®€å•çš„é…ç½®è‡ªåŠ¨ç”Ÿæˆæ¥å£æ–‡æ¡£ï¼Œè®©å¼€å‘è€…å’Œå‰ç«¯å¿«é€Ÿäº†è§£å’Œè°ƒè¯•æ¥å£ï¼Œæé«˜å†™ä½œæ•ˆç‡ã€‚

å‚è€ƒå®˜æ–¹æ–‡æ¡£å¼•å…¥ï¼šhttps://doc.xiaominfo.com/docs/quick-start#spring-boot-2bgMhj83Bt96lFcj29lBZCF0o0+YPCGWOWUw0OPyFB/Q=

ç”±äºä½¿ç”¨çš„æ˜¯ Spring Boot 2.xï¼Œæ³¨æ„è¦é€‰æ‹© OpenAPI 2 çš„ç‰ˆæœ¬ã€‚

åœ¨ Maven çš„ pom.xml ä¸­æ·»åŠ ä¾èµ–ï¼š

```xml
<dependency>
    <groupId>com.github.xiaoymin</groupId>
    <artifactId>knife4j-openapi2-spring-boot-starter</artifactId>
    <version>4.4.0</version>
</dependency>
```

æ–°å»º controller åŒ…ç”¨äºå­˜æ”¾ API æ¥å£ï¼Œå°†æ¨¡æ¿åˆ›å»ºçš„ demos.web åŒ…ä¸‹çš„ä»£ç éƒ½ç§»åŠ¨åˆ°å…¶ä¸­ï¼Œä»…ç”¨äºæµ‹è¯•ï¼š

![img](./assets/b2AI11lzAexgqj0A.webp)

åœ¨ application.yml ä¸­è¿½åŠ æ¥å£æ–‡æ¡£é…ç½®ï¼Œæ‰«æ Controller åŒ…ï¼š

```yaml
# æ¥å£æ–‡æ¡£é…ç½®
knife4j:
  enable: true
  openapi:
    title: "æ¥å£æ–‡æ¡£"
    version: 1.0
    group:
      default:
        api-rule: package
        api-rule-resources:
          - com.yupi.yupicturebackend.controller
```

é‡å¯é¡¹ç›®ï¼Œè®¿é—® http://localhost:8123/api/doc.html èƒ½å¤Ÿçœ‹åˆ°æ¥å£æ–‡æ¡£ï¼Œå¯ä»¥æµ‹è¯•è°ƒç”¨ï¼š

![img](./assets/gTmmWgSsMn3bdnSk.webp)

#### 4ã€å…¶ä»–ä¾èµ–

å¯ä»¥æŒ‰éœ€å¼•å…¥å…¶ä»–ä¾èµ–ï¼Œæ¯”å¦‚ AOP åˆ‡é¢ç¼–ç¨‹ï¼š

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-aop</artifactId>
</dependency>
```

ç»™å¯åŠ¨ç±»æ·»åŠ æ³¨è§£ï¼ˆå¯é€‰ï¼‰ï¼š

```java
@EnableAspectJAutoProxy(exposeProxy = true)
```

è§£é‡Šä¸€ä¸‹ `exposeProxy = true` çš„ä½œç”¨ï¼šé€šè¿‡ Spring AOP æä¾›å¯¹å½“å‰ä»£ç†å¯¹è±¡çš„è®¿é—®ï¼Œä½¿å¾—å¯ä»¥åœ¨ä¸šåŠ¡é€»è¾‘ä¸­è®¿é—®åˆ°å½“å‰çš„ä»£ç†å¯¹è±¡ã€‚ä½ å¯ä»¥åœ¨æ–¹æ³•æ‰§è¡Œæ—¶é€šè¿‡ `AopContext.currentProxy()` è·å–å½“å‰çš„ä»£ç†å¯¹è±¡ã€‚qHT6Kxg12X1vklSWA3QVO0Z9aqth3Yj5Z1UQTagntCA=

è¿˜æœ‰æ›´å¤šçš„ä¾èµ–ï¼Œåç»­æˆ‘ä»¬éšç”¨éšè£…ã€‚

### é€šç”¨åŸºç¡€ä»£ç 

é€šç”¨åŸºç¡€ä»£ç æ˜¯æŒ‡ï¼šæ— è®ºåœ¨ä»»ä½•åç«¯é¡¹ç›®ä¸­ï¼Œéƒ½å¯ä»¥å¤ç”¨çš„ä»£ç ã€‚è¿™ç§ä»£ç ä¸€èˆ¬ â€œä¸€è¾ˆå­åªç”¨å†™ä¸€æ¬¡â€ï¼Œäº†è§£ä½œç”¨ä¹‹åå¤åˆ¶ç²˜è´´å³å¯ï¼Œæ— éœ€è®°å¿†ã€‚

ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š

![img](./assets/8nzV6TW0kiTW1pFD.webp)

#### 1ã€è‡ªå®šä¹‰å¼‚å¸¸

è‡ªå®šä¹‰é”™è¯¯ç ï¼Œå¯¹é”™è¯¯è¿›è¡Œæ”¶æ•›ï¼Œä¾¿äºå‰ç«¯ç»Ÿä¸€å¤„ç†ã€‚

ğŸ’¡ è¿™é‡Œæœ‰ 2 ä¸ªå°æŠ€å·§ï¼š

1. è‡ªå®šä¹‰é”™è¯¯ç æ—¶ï¼Œå»ºè®®è·Ÿä¸»æµçš„é”™è¯¯ç ï¼ˆæ¯”å¦‚ HTTP é”™è¯¯ç ï¼‰çš„å«ä¹‰ä¿æŒä¸€è‡´ï¼Œæ¯”å¦‚ â€œæœªç™»å½•â€ å®šä¹‰ä¸º 40100ï¼Œå’Œ HTTP 401 é”™è¯¯ï¼ˆç”¨æˆ·éœ€è¦è¿›è¡Œèº«ä»½è®¤è¯ï¼‰ä¿æŒä¸€è‡´ï¼Œä¼šæ›´å®¹æ˜“ç†è§£ã€‚
2. é”™è¯¯ç ä¸è¦å®Œå…¨è¿ç»­ï¼Œé¢„ç•™ä¸€äº›é—´éš”ï¼Œä¾¿äºåç»­æ‰©å±•ã€‚

åœ¨ `exception` åŒ…ä¸‹æ–°å»ºé”™è¯¯ç æšä¸¾ç±»ï¼š

```java
@Getter
public enum ErrorCode {

    SUCCESS(0, "ok"),
    PARAMS_ERROR(40000, "è¯·æ±‚å‚æ•°é”™è¯¯"),
    NOT_LOGIN_ERROR(40100, "æœªç™»å½•"),
    NO_AUTH_ERROR(40101, "æ— æƒé™"),
    NOT_FOUND_ERROR(40400, "è¯·æ±‚æ•°æ®ä¸å­˜åœ¨"),
    FORBIDDEN_ERROR(40300, "ç¦æ­¢è®¿é—®"),
    SYSTEM_ERROR(50000, "ç³»ç»Ÿå†…éƒ¨å¼‚å¸¸"),
    OPERATION_ERROR(50001, "æ“ä½œå¤±è´¥");

    /**
     * çŠ¶æ€ç 
     */
    private final int code;

    /**
     * ä¿¡æ¯
     */
    private final String message;

    ErrorCode(int code, String message) {
        this.code = code;
        this.message = message;
    }

}
```

ä¸€èˆ¬ä¸å»ºè®®ç›´æ¥æŠ›å‡º Java å†…ç½®çš„ RuntimeExceptionï¼Œè€Œæ˜¯è‡ªå®šä¹‰ä¸€ä¸ªä¸šåŠ¡å¼‚å¸¸ï¼Œå’Œå†…ç½®çš„å¼‚å¸¸ç±»åŒºåˆ†å¼€ï¼Œä¾¿äºå®šåˆ¶åŒ–è¾“å‡ºé”™è¯¯ä¿¡æ¯ï¼šXJ858sBsdVoQsBlQbSlEZH9bgQFu4XZchClXOymxgUA=

```java
@Getter
public class BusinessException extends RuntimeException {

    /**
     * é”™è¯¯ç 
     */
    private final int code;

    public BusinessException(int code, String message) {
        super(message);
        this.code = code;
    }

    public BusinessException(ErrorCode errorCode) {
        super(errorCode.getMessage());
        this.code = errorCode.getCode();
    }

    public BusinessException(ErrorCode errorCode, String message) {
        super(message);
        this.code = errorCode.getCode();
    }

}
```

ä¸ºäº†æ›´æ–¹ä¾¿åœ°æ ¹æ®æƒ…å†µæŠ›å‡ºå¼‚å¸¸ï¼Œå¯ä»¥å°è£…ä¸€ä¸ª ThrowUtilsï¼Œç±»ä¼¼æ–­è¨€ç±»ï¼Œç®€åŒ–æŠ›å¼‚å¸¸çš„ä»£ç ï¼š

```java
public class ThrowUtils {

    /**
     * æ¡ä»¶æˆç«‹åˆ™æŠ›å¼‚å¸¸
     *
     * @param condition        æ¡ä»¶
     * @param runtimeException å¼‚å¸¸
     */
    public static void throwIf(boolean condition, RuntimeException runtimeException) {
        if (condition) {
            throw runtimeException;
        }
    }

    /**
     * æ¡ä»¶æˆç«‹åˆ™æŠ›å¼‚å¸¸
     *
     * @param condition æ¡ä»¶
     * @param errorCode é”™è¯¯ç 
     */
    public static void throwIf(boolean condition, ErrorCode errorCode) {
        throwIf(condition, new BusinessException(errorCode));
    }

    /**
     * æ¡ä»¶æˆç«‹åˆ™æŠ›å¼‚å¸¸
     *
     * @param condition æ¡ä»¶
     * @param errorCode é”™è¯¯ç 
     * @param message   é”™è¯¯ä¿¡æ¯
     */
    public static void throwIf(boolean condition, ErrorCode errorCode, String message) {
        throwIf(condition, new BusinessException(errorCode, message));
    }
}
```

#### 2ã€å“åº”åŒ…è£…ç±»

ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæ¯ä¸ªåç«¯æ¥å£éƒ½è¦è¿”å›è°ƒç”¨ç ã€æ•°æ®ã€è°ƒç”¨ä¿¡æ¯ç­‰ï¼Œå‰ç«¯å¯ä»¥æ ¹æ®è¿™äº›ä¿¡æ¯è¿›è¡Œç›¸åº”çš„å¤„ç†ã€‚

æˆ‘ä»¬å¯ä»¥å°è£…ç»Ÿä¸€çš„å“åº”ç»“æœç±»ï¼Œä¾¿äºå‰ç«¯ç»Ÿä¸€è·å–è¿™äº›ä¿¡æ¯ã€‚

é€šç”¨å“åº”ç±»ï¼š

```java
@Data
public class BaseResponse<T> implements Serializable {

    private int code;

    private T data;

    private String message;

    public BaseResponse(int code, T data, String message) {
        this.code = code;
        this.data = data;
        this.message = message;
    }

    public BaseResponse(int code, T data) {
        this(code, data, "");
    }

    public BaseResponse(ErrorCode errorCode) {
        this(errorCode.getCode(), null, errorCode.getMessage());
    }
}
```

ä½†ä¹‹åæ¯æ¬¡æ¥å£è¿”å›å€¼æ—¶ï¼Œéƒ½è¦æ‰‹åŠ¨ new ä¸€ä¸ª BaseResponse å¯¹è±¡å¹¶ä¼ å…¥å‚æ•°ï¼Œæ¯”è¾ƒéº»çƒ¦ï¼Œæˆ‘ä»¬å¯ä»¥æ–°å»ºä¸€ä¸ªå·¥å…·ç±»ï¼Œæä¾›æˆåŠŸè°ƒç”¨å’Œå¤±è´¥è°ƒç”¨çš„æ–¹æ³•ï¼Œæ”¯æŒçµæ´»åœ°ä¼ å‚ï¼Œç®€åŒ–è°ƒç”¨ã€‚

```java
public class ResultUtils {

    /**
     * æˆåŠŸ
     *
     * @param data æ•°æ®
     * @param <T>  æ•°æ®ç±»å‹
     * @return å“åº”
     */
    public static <T> BaseResponse<T> success(T data) {
        return new BaseResponse<>(0, data, "ok");
    }

    /**
     * å¤±è´¥
     *
     * @param errorCode é”™è¯¯ç 
     * @return å“åº”
     */
    public static BaseResponse<?> error(ErrorCode errorCode) {
        return new BaseResponse<>(errorCode);
    }

    /**
     * å¤±è´¥
     *
     * @param code    é”™è¯¯ç 
     * @param message é”™è¯¯ä¿¡æ¯
     * @return å“åº”
     */
    public static BaseResponse<?> error(int code, String message) {
        return new BaseResponse<>(code, null, message);
    }

    /**
     * å¤±è´¥
     *
     * @param errorCode é”™è¯¯ç 
     * @return å“åº”
     */
    public static BaseResponse<?> error(ErrorCode errorCode, String message) {
        return new BaseResponse<>(errorCode.getCode(), null, message);
    }
}
```

#### 3ã€å…¨å±€å¼‚å¸¸å¤„ç†å™¨

ä¸ºäº†é˜²æ­¢æ„æ–™ä¹‹å¤–çš„å¼‚å¸¸ï¼Œåˆ©ç”¨ AOP åˆ‡é¢å…¨å±€å¯¹ä¸šåŠ¡å¼‚å¸¸å’Œ RuntimeException è¿›è¡Œæ•è·ï¼šcT00UyE1JKn/y8Q147TQRzbDavEs+V72bbBFCS1wu6g=

```java
@RestControllerAdvice
@Slf4j
public class GlobalExceptionHandler {

    @ExceptionHandler(BusinessException.class)
    public BaseResponse<?> businessExceptionHandler(BusinessException e) {
        log.error("BusinessException", e);
        return ResultUtils.error(e.getCode(), e.getMessage());
    }

    @ExceptionHandler(RuntimeException.class)
    public BaseResponse<?> runtimeExceptionHandler(RuntimeException e) {
        log.error("RuntimeException", e);
        return ResultUtils.error(ErrorCode.SYSTEM_ERROR, "ç³»ç»Ÿé”™è¯¯");
    }
}
```

#### 4ã€è¯·æ±‚åŒ…è£…ç±»

å¯¹äº â€œåˆ†é¡µâ€ã€â€œåˆ é™¤æŸæ¡æ•°æ®â€ è¿™ç±»é€šç”¨çš„è¯·æ±‚ï¼Œå¯ä»¥å°è£…ç»Ÿä¸€çš„è¯·æ±‚åŒ…è£…ç±»ï¼Œç”¨äºæ¥å—å‰ç«¯ä¼ æ¥çš„å‚æ•°ï¼Œä¹‹åç›¸åŒå‚æ•°çš„è¯·æ±‚å°±ä¸ç”¨ä¸“é—¨å†æ–°å»ºä¸€ä¸ªç±»äº†ã€‚

åˆ†é¡µè¯·æ±‚åŒ…è£…ç±»ï¼Œæ¥å—é¡µå·ã€é¡µé¢å¤§å°ã€æ’åºå­—æ®µã€æ’åºé¡ºåºå‚æ•°ï¼š

```java
@Data
public class PageRequest {

    /**
     * å½“å‰é¡µå·
     */
    private int current = 1;

    /**
     * é¡µé¢å¤§å°
     */
    private int pageSize = 10;

    /**
     * æ’åºå­—æ®µ
     */
    private String sortField;

    /**
     * æ’åºé¡ºåºï¼ˆé»˜è®¤é™åºï¼‰
     */
    private String sortOrder = "descend";
}
```

åˆ é™¤è¯·æ±‚åŒ…è£…ç±»ï¼Œæ¥å—è¦åˆ é™¤æ•°æ®çš„ id ä½œä¸ºå‚æ•°ï¼š

```java
@Data
public class DeleteRequest implements Serializable {

    /**
     * id
     */
    private Long id;

    private static final long serialVersionUID = 1L;
}
```

#### 5ã€å…¨å±€è·¨åŸŸé…ç½®

è·¨åŸŸæ˜¯æŒ‡æµè§ˆå™¨è®¿é—®çš„ URLï¼ˆå‰ç«¯åœ°å€ï¼‰å’Œåç«¯æ¥å£åœ°å€çš„åŸŸåï¼ˆæˆ–ç«¯å£å·ï¼‰ä¸ä¸€è‡´å¯¼è‡´çš„ï¼Œæµè§ˆå™¨ä¸ºäº†å®‰å…¨ï¼Œé»˜è®¤ç¦æ­¢è·¨åŸŸè¯·æ±‚è®¿é—®ã€‚

ä¸ºäº†å¼€å‘è°ƒè¯•æ–¹ä¾¿ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å…¨å±€è·¨åŸŸé…ç½®ï¼Œè®©æ•´ä¸ªé¡¹ç›®æ‰€æœ‰çš„æ¥å£æ”¯æŒè·¨åŸŸï¼Œè§£å†³è·¨åŸŸæŠ¥é”™ã€‚

æ–°å»º config åŒ…ï¼Œç”¨äºå­˜æ”¾æ‰€æœ‰çš„é…ç½®ç›¸å…³ä»£ç ã€‚å…¨å±€è·¨åŸŸé…ç½®ä»£ç å¦‚ä¸‹ï¼š

```java
@Configuration
public class CorsConfig implements WebMvcConfigurer {

    @Override
    public void addCorsMappings(CorsRegistry registry) {
        // è¦†ç›–æ‰€æœ‰è¯·æ±‚
        registry.addMapping("/**")
                // å…è®¸å‘é€ Cookie
                .allowCredentials(true)
                // æ”¾è¡Œå“ªäº›åŸŸåï¼ˆå¿…é¡»ç”¨ patternsï¼Œå¦åˆ™ * ä¼šå’Œ allowCredentials å†²çªï¼‰
                .allowedOriginPatterns("*")
                .allowedMethods("GET", "POST", "PUT", "DELETE", "OPTIONS")
                .allowedHeaders("*")
                .exposedHeaders("*");
    }
}
```

### ç¼–å†™ç¤ºä¾‹æ¥å£

ç§»é™¤ controller åŒ…ä¸‹çš„å…¶ä»–ä»£ç ï¼Œè®©é¡¹ç›®å¹²å‡€ä¸€äº›ï¼Œç„¶åç¼–å†™ä¸€ä¸ªçº¯å‡€çš„ `/health` æ¥å£ç”¨äºå¥åº·æ£€æŸ¥ï¼š

```java
@RestController
@RequestMapping("/")
public class MainController {

    /**
     * å¥åº·æ£€æŸ¥
     */
    @GetMapping("/health")
    public BaseResponse<String> health() {
        return ResultUtils.success("ok");
    }
}
```

ğŸ’¡ å¥åº·æ£€æŸ¥æ˜¯æŒ‡å¯ä»¥é€šè¿‡è®¿é—®è¯¥æ¥å£ï¼Œæ¥å¿«é€ŸéªŒè¯åç«¯æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œï¼Œæ‰€ä»¥è¯¥æ¥å£çš„è¿”å›å€¼éå¸¸ç®€å•ã€‚

æ­¤æ—¶çš„é¡¹ç›®ç»“æ„å¦‚å›¾ï¼š

![img](./assets/jfvjwfxCPEHRMCIp.webp)

è®¿é—® http://localhost:8123/api/healthï¼Œçœ‹åˆ°è¾“å‡ºç»“æœï¼Œè¡¨ç¤ºåç«¯åˆå§‹åŒ–å®Œæˆï¼š

![img](./assets/7Hp1xBK2iZd5CRre.webp)

## äºŒã€å‰ç«¯é¡¹ç›®åˆå§‹åŒ–

### ç¯å¢ƒå‡†å¤‡

å‰ç«¯ Node.js ç‰ˆæœ¬å¿…é¡» >= 18.12ï¼Œé±¼çš®æ•™ç¨‹ä¸­ä½¿ç”¨ 20 ç‰ˆæœ¬ã€‚åœ¨å®˜ç½‘å®‰è£…å¥½ Node åä¼šè‡ªåŠ¨å®‰è£… NPM å‰ç«¯åŒ…ç®¡ç†å™¨ã€‚

å¯å‚è€ƒè§†é¢‘å®‰è£… Node.jsï¼šhttps://www.bilibili.com/video/BV14SUNYREv8/MBNmaRtUhzDE9b4tB/jsqs1ClvvhzK+S4KVLPihc/I=

### åˆ›å»ºé¡¹ç›®

ä½¿ç”¨ Vue å®˜æ–¹æ¨èçš„è„šæ‰‹æ¶ create-vue å¿«é€Ÿåˆ›å»º Vue3 çš„é¡¹ç›®ï¼šhttps://cn.vuejs.org/guide/quick-start.html

ğŸ’¡ Vue æä¾›äº†åœ¨çº¿ç¼–ç æµ‹è¯•ï¼Œå¯ä»¥é€šè¿‡ Playground æ¥å­¦ä¹  Vueï¼šhttps://play.vuejs.org/p87QUult0bZDR05AO5soQVixQ5nCQ+HA+P5tLSHK/hI=

åœ¨ç»ˆç«¯ä¸­è¾“å…¥å‘½ä»¤ï¼š

```shell
npm create vue@latest
```

NPM ä¼šè‡ªåŠ¨å®‰è£… create-vue å·¥å…·ï¼š

![img](./assets/YdlRG2HXZ84ug0hv.webp)

**æ³¨æ„æœ¬æ•™ç¨‹ä½¿ç”¨çš„ç‰ˆæœ¬å·æ˜¯ 3.12.1ï¼Œå¦‚æœä¹‹åç‰ˆæœ¬æ›´æ–°å¯¼è‡´è·Ÿé±¼çš®çš„æ•™ç¨‹ä¸ä¸€è‡´ï¼Œè®°å¾—å®‰è£…ç‰¹å®šç‰ˆæœ¬çš„å·¥å…·ï¼Œè€Œä¸æ˜¯ latest æœ€æ–°ç‰ˆï¼**

æ¥ä¸‹æ¥æŒ‰ç…§å¦‚ä¸‹é€‰é¡¹åˆ›å»ºé¡¹ç›®ï¼Œè„šæ‰‹æ¶ä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬å®‰è£… Vue Router è·¯ç”±ã€Pinia å…¨å±€çŠ¶æ€ç®¡ç†ç­‰å®ç”¨ç±»åº“ï¼š

![img](./assets/iVb3qq4uRl03jEH5.webp)

ç„¶åç”¨ WebStorm æ‰“å¼€é¡¹ç›®ï¼Œå…ˆåœ¨ç»ˆç«¯æ‰§è¡Œ `npm install` å®‰è£…ä¾èµ–ï¼Œç„¶åæ‰§è¡Œ `npm run dev` èƒ½è®¿é—®ç½‘é¡µå°±æˆåŠŸäº†ã€‚

![img](./assets/DR1GXgYOJnvak0tp.webp)

ğŸ’¡ å¯ä»¥çœ‹åˆ° Vue è„šæ‰‹æ¶æä¾›äº†ä¸€ä¸ªè°ƒè¯•å·¥å…· devtoolsï¼ˆ[http://localhost:5173/**devtools**/](http://localhost:5173/__devtools__/)ï¼‰ï¼Œä½ å¯ä»¥ä½¿ç”¨å®ƒæ¥è°ƒè¯•åˆ†æé¡¹ç›®ï¼š

![img](./assets/h1bI8dJy9PXIw0SO.webp)

### å‰ç«¯å·¥ç¨‹åŒ–é…ç½®

è„šæ‰‹æ¶å·²ç»å¸®æˆ‘ä»¬æ•´åˆäº† Prettier ä»£ç ç¾åŒ–ã€ESLint è‡ªåŠ¨æ ¡éªŒã€TypeScript ç±»å‹æ ¡éªŒï¼Œæ— éœ€å†è‡ªè¡Œæ•´åˆã€‚

ä½†æ˜¯éœ€è¦åœ¨ webstorm é‡Œå¼€å¯ä»£ç ç¾åŒ–æ’ä»¶ï¼š

![img](./assets/97Cj0aNolqKEY12c.webp)

åœ¨ vue æ–‡ä»¶ä¸­æ‰§è¡Œæ ¼å¼åŒ–å¿«æ·é”®ï¼Œä¸æŠ¥é”™ï¼Œè¡¨ç¤ºé…ç½®å·¥ç¨‹åŒ–æˆåŠŸã€‚

å¦‚æœå‘ç°æ ¼å¼åŒ–æ•ˆæœä¸å¥½ï¼Œä¹Ÿæ²¡å…³ç³»ï¼Œä¹‹åå¯ä»¥ä½¿ç”¨å¦å¤–ä¸€ç§æ ¼å¼åŒ–å¿«æ·é”®ï¼š

![img](./assets/YVy1ApcVuhHScwGy.webp)

ä¸ºäº†å¼€å‘æ•ˆç‡æ›´é«˜ï¼Œä½ å¯èƒ½æƒ³å…³é—­ç”±äº ESLint æ ¡éªŒå¯¼è‡´çš„ç¼–è¯‘é”™è¯¯ï¼ŒåŒæ ·å¯ä»¥åœ¨å¼€å‘å·¥å…·ä¸­ç¦ç”¨ ESLintï¼š

![img](./assets/HQ7n06Nn5dpiNo1U.webp)

ä¿®æ”¹ eslint.config.jsã€.prettierrc.jsonã€tsconfig.json æ–‡ä»¶å¯ä»¥æ”¹å˜æ ¡éªŒè§„åˆ™ã€‚

å¦‚æœä¸ä½¿ç”¨è„šæ‰‹æ¶ï¼Œå°±éœ€è¦è‡ªå·±æ•´åˆè¿™äº›å·¥å…·ï¼š

- ä»£ç è§„èŒƒï¼šhttps://eslint.org/docs/latest/use/getting-started
- ä»£ç ç¾åŒ–ï¼šhttps://prettier.io/docs/en/install.html
- ç›´æ¥æ•´åˆï¼šhttps://github.com/prettier/eslint-plugin-prettier#recommended-configurationï¼ˆåŒ…æ‹¬äº† https://github.com/prettier/eslint-config-prettier#installationï¼‰

å¯¹äºå‰ç«¯æ–°æ‰‹æ¥è¯´ï¼Œä½ ä¸éœ€è¦æ·±å…¥äº†è§£è¿™äº›ï¼Œçº¯å½“å·¥å…·å»ä½¿ç”¨å³å¯ï¼Œåº”è¯¥å°½å¿«ä¸Šæ‰‹é¡¹ç›®ã€‚Kvj0N9UsvjnA2JCtBYVVlZvRih721R4WfPhhdfsvDfk=

### å¼•å…¥ç»„ä»¶åº“

å¼•å…¥ Ant Design Vue ç»„ä»¶åº“ï¼Œå‚è€ƒ [å®˜æ–¹æ–‡æ¡£](https://antdv.com/docs/vue/getting-started-cn) å¿«é€Ÿä¸Šæ‰‹ã€‚

æ³¨æ„ï¼Œæœ¬æ•™ç¨‹ä½¿ç”¨çš„æ˜¯ v4.2.6 çš„ç»„ä»¶åº“ç‰ˆæœ¬ï¼Œå¦‚æœåç»­é˜…è¯»æœ¬æ•™ç¨‹ä¸­å‘ç°æœ‰ç»„ä»¶æˆ–è¯­æ³•ä¸ä¸€è‡´ï¼Œä»¥å®˜æ–¹æ–‡æ¡£ä¸ºä¸»ï¼Œæˆ–è€…åœ¨ç½‘ç«™å³ä¸Šè§’åˆ‡æ¢å¯¹åº”ç‰ˆæœ¬çš„æ–‡æ¡£å³å¯ï¼š

![img](./assets/vVHtPMAIOYVozFQf.webp)

æ‰§è¡Œå®‰è£…ï¼š

```shell
npm i --save ant-design-vue@4.x
```

æ”¹å˜ä¸»å…¥å£æ–‡ä»¶ main.tsï¼Œå…¨å±€æ³¨å†Œç»„ä»¶ï¼ˆä¸ºäº†æ–¹ä¾¿ï¼‰ï¼š

```typescript
import App from './App.vue'
import router from './router'
import Antd from 'ant-design-vue'
import 'ant-design-vue/dist/reset.css'
import { createPinia } from 'pinia'
import { createApp } from 'vue'

const app = createApp(App)
app.use(Antd)
app.use(createPinia())
app.use(router)

app.mount('#app')
```

éšä¾¿å¼•å…¥ä¸€ä¸ªç»„ä»¶ï¼Œå¦‚æœæ˜¾ç¤ºå‡ºæ¥ï¼Œå°±è¡¨ç¤ºå¼•å…¥æˆåŠŸã€‚

æ¯”å¦‚å¼•å…¥æŒ‰é’®ï¼š

```typescript
<a-button type="primary">Primary Button</a-button>
```

æ•ˆæœå¦‚å›¾ï¼š

![img](./assets/EG58mZocc8yatzPB.webp)

### å¼€å‘è§„èŒƒ

å»ºè®®éµå¾ª Vue3 çš„ç»„åˆå¼ API (Composition API)ï¼Œè€Œä¸æ˜¯ [é€‰é¡¹å¼ API](https://cn.vuejs.org/guide/introduction.html#composition-api)ï¼Œå¼€å‘æ›´è‡ªç”±é«˜æ•ˆä¸€äº›ã€‚

ç¤ºä¾‹ä»£ç ï¼š

```vue
<template>
  <div id="xxPage">

  </div>
</template>

<script setup lang="ts">

</script>

<style scoped>
#xxPage {
}

</style>
```

### é¡µé¢åŸºæœ¬ä¿¡æ¯

å¯ä»¥ä¿®æ”¹é¡¹ç›®æ ¹ç›®å½•ä¸‹çš„ `index.html` æ–‡ä»¶ï¼Œæ¥å®šä¹‰é¡µé¢çš„å…ƒä¿¡æ¯ï¼Œæ¯”å¦‚ä¿®æ”¹æ ‡é¢˜ï¼š

```html
<!DOCTYPE html>
<html lang="">
  <head>
    <meta charset="UTF-8">
    <link rel="icon" href="/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é±¼çš®äº‘å›¾åº“</title>
  </head>
  <body>
    <div id="app"></div>
    <script type="module" src="/src/main.ts"></script>
  </body>
</html>
```

è¿˜å¯ä»¥æ›¿æ¢ public ç›®å½•ä¸‹é»˜è®¤çš„ ico å›¾æ ‡ä¸ºè‡ªå·±çš„ï¼Œæœ‰å¾ˆå¤š [ç°æˆçš„ç½‘ç«™](https://www.bitbug.net/) å¯ä»¥åˆ¶ä½œ ico å›¾æ ‡ã€‚

æ•ˆæœå¦‚å›¾ï¼š

![img](./assets/bk8gPn0yFsZU4Bkc.png)

### å…¨å±€é€šç”¨å¸ƒå±€

#### 1ã€åŸºç¡€å¸ƒå±€ç»“æ„

åœ¨ layouts ç›®å½•ä¸‹æ–°å»ºä¸€ä¸ªå¸ƒå±€ `BasicLayout.vue`ï¼Œ åœ¨ App.vue å…¨å±€é¡µé¢å…¥å£æ–‡ä»¶ä¸­å¼•å…¥ã€‚

App.vue ä»£ç å¦‚ä¸‹ï¼š

```typescript
<template>
  <div id="app">
    <BasicLayout />
  </div>
</template>

<script setup lang="ts">
import BasicLayout from "@/layouts/BasicLayout.vue";
</script>
```

å¯ä»¥ç§»é™¤é¡µé¢å†…çš„é»˜è®¤æ ·å¼ã€å¹¶ä¸”ç§»é™¤ main.ts ä¸­é»˜è®¤å¼•å…¥çš„ main.cssï¼Œé˜²æ­¢æ ·å¼æ±¡æŸ“ï¼š

```css
<style>
#app {
}
</style>
```

é€‰ç”¨ Ant Design ç»„ä»¶åº“çš„ [Layout ç»„ä»¶](https://antdv.com/components/layout-cn) ï¼Œå…ˆæŠŠã€ä¸Šä¸­ä¸‹ã€‘å¸ƒå±€ç¼–æ’å¥½ï¼Œç„¶åå†å¡«å……å†…å®¹ï¼š

![img](./assets/kJS5TSGYKESmhJFM.webp)

ä»£ç å¦‚ä¸‹ï¼š

```vue
<template>
  <div id="basicLayout">
    <a-layout style="min-height: 100vh">
      <a-layout-header>Header</a-layout-header>
      <a-layout-content>Content</a-layout-content>
      <a-layout-footer>Footer</a-layout-footer>
    </a-layout>
  </div>
</template>

<script setup lang="ts"></script>
```

æ ·å¼ï¼š

```typescript
<style scoped>
#basicLayout {
}
</style>
```

#### 2ã€å…¨å±€åº•éƒ¨æ 

é€šå¸¸ç”¨äºå±•ç¤ºç‰ˆæƒä¿¡æ¯ï¼š

```tsx
<a-layout-footer class="footer">
  <a href="https://www.codefather.cn" target="_blank">
    ç¼–ç¨‹å¯¼èˆª by ç¨‹åºå‘˜é±¼çš®
  </a>
</a-layout-footer>
```

æ ·å¼ï¼š

```typescript
#basicLayout .footer {
  background: #efefef;
  padding: 16px;
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  text-align: center;
}
```

#### 3ã€åŠ¨æ€æ›¿æ¢å†…å®¹

é¡¹ç›®ä½¿ç”¨äº† [Vue Router](https://router.vuejs.org/zh/introduction.html) è·¯ç”±åº“ï¼Œå¯ä»¥åœ¨ `router/index.ts` é…ç½®è·¯ç”±ï¼Œèƒ½å¤Ÿæ ¹æ®è®¿é—®çš„é¡µé¢åœ°å€æ‰¾åˆ°ä¸åŒçš„æ–‡ä»¶å¹¶åŠ è½½æ¸²æŸ“ã€‚

ä¿®æ”¹ BasicLayout å†…å®¹éƒ¨åˆ†çš„ä»£ç å¦‚ä¸‹ï¼š

```typescript
<a-layout-content class="content">
  <router-view />
</a-layout-content>
```

ä¿®æ”¹æ ·å¼ï¼Œè¦å’Œåº•éƒ¨æ ä¿æŒä¸€å®šçš„å¤–è¾¹è·ï¼Œå¦åˆ™å†…å®¹ä¼šè¢«é®ä½ï¼š

```typescript
<style scoped>
#basicLayout .content {
  background: linear-gradient(to right, #fefefe, #fff);
  margin-bottom: 28px;
  padding: 20px;
}
</style>
```

#### 4ã€å…¨å±€é¡¶éƒ¨æ 

ç”±äºé¡¶éƒ¨æ çš„å¼€å‘ç›¸å¯¹å¤æ‚ï¼Œå¯ä»¥åŸºäº [Ant Design çš„èœå•ç»„ä»¶](https://antdv.com/components/menu-cn) æ¥åˆ›å»º `GlobalHeader` å…¨å±€é¡¶éƒ¨æ ç»„ä»¶ï¼Œ**ç»„ä»¶ç»Ÿä¸€æ”¾åœ¨ components ç›®å½•ä¸­ **ã€‚

å…ˆç›´æ¥å¤åˆ¶ç°æˆçš„ç»„ä»¶ç¤ºä¾‹ä»£ç åˆ° GlobalHeader ä¸­å³å¯ã€‚

![img](./assets/4wA4zaDAL98eCerU.webp)

åœ¨åŸºç¡€å¸ƒå±€ä¸­å¼•å…¥é¡¶éƒ¨æ ç»„ä»¶ï¼š

```vue
<a-layout-header class="header">
  <GlobalHeader />
</a-layout-header>
```

å¼•å…¥ä»£ç å¦‚ä¸‹ï¼š

```vue
<script setup lang="ts">
import GlobalHeader from "@/components/GlobalHeader.vue";
</script>
```

æ•ˆæœå¦‚ä¸‹ï¼š

![img](./assets/LTuD3h4i8J4wZ7EA.webp)

å¯ä»¥ä¿®æ”¹ä¸‹å…¨å±€ Header çš„æ ·å¼ï¼Œæ¸…é™¤ä¸€äº›é»˜è®¤æ ·å¼ï¼ˆæ¯”å¦‚èƒŒæ™¯è‰²ç­‰ï¼‰ï¼Œæ ·å¼ä»£ç å¦‚ä¸‹ï¼š

```css
#basicLayout .header {
  padding-inline: 20px;
  margin-bottom: 16px;
  color: unset;
  background: white;
}
```

æ¥ä¸‹æ¥è¦ä¿®æ”¹ GlobalHeader ç»„ä»¶ï¼Œå®Œå–„æ›´å¤šå†…å®¹ã€‚

1ï¼‰ç»™èœå•å¤–å¥—ä¸€å±‚å…ƒç´ ï¼Œç”¨äºæ•´ä½“æ§åˆ¶æ ·å¼ï¼š

```vue
<div id="globalHeader">
  <a-menu v-model:selectedKeys="current" mode="horizontal" :items="items" />
</div>
```

2ï¼‰æ ¹æ®æˆ‘ä»¬çš„éœ€æ±‚ä¿®æ”¹èœå•é…ç½®ï¼Œkey ä¸ºè¦è·³è½¬çš„ URL è·¯å¾„ï¼š

```vue
<script lang="ts" setup>
import { h, ref } from 'vue'
import { HomeOutlined } from '@ant-design/icons-vue'
import { MenuProps } from 'ant-design-vue'

const current = ref<string[]>(['home'])
const items = ref<MenuProps['items']>([
  {
    key: '/',
    icon: () => h(HomeOutlined),
    label: 'ä¸»é¡µ',
    title: 'ä¸»é¡µ',
  },
  {
    key: '/about',
    label: 'å…³äº',
    title: 'å…³äº',
  },
  {
    key: 'others',
    label: h('a', { href: 'https://www.codefather.cn', target: '_blank' }, 'ç¼–ç¨‹å¯¼èˆª'),
    title: 'ç¼–ç¨‹å¯¼èˆª',
  },
])
</script>
```

æ•ˆæœå¦‚å›¾ï¼š

![img](./assets/3ktqpmgIKLzV4cBj.webp)

3ï¼‰å®Œå–„å…¨å±€é¡¶éƒ¨æ ï¼Œå·¦ä¾§è¡¥å……ç½‘ç«™å›¾æ ‡å’Œæ ‡é¢˜ã€‚

å…ˆæŠŠ logo.png æ”¾åˆ° src/assets ç›®å½•ä¸‹ï¼Œæ›¿æ¢æ‰åŸæœ¬çš„é»˜è®¤ Logoï¼š

![img](./assets/7NpC45MKgn29z1jg.png)

ä¿®æ”¹ GlobalHeader ä»£ç ï¼Œè¡¥å…… HTMLï¼š

```tsx
<RouterLink to="/">
  <div class="title-bar">
    <img class="logo" src="../assets/logo.png" alt="logo" />
    <div class="title">é±¼çš®äº‘å›¾åº“</div>
  </div>
</RouterLink>
```

å…¶ä¸­ï¼ŒRouterLink ç»„ä»¶çš„ä½œç”¨æ˜¯æ”¯æŒè¶…é“¾æ¥è·³è½¬ï¼ˆä¸åˆ·æ–°é¡µé¢ï¼‰ã€‚

è¡¥å…… CSS æ ·å¼ï¼š

```css
<style scoped>
.title-bar {
  display: flex;
  align-items: center;
}

.title {
  color: black;
  font-size: 18px;
  margin-left: 16px;
}

.logo {
  height: 48px;
}
</style>
```

4ï¼‰å®Œå–„é¡¶éƒ¨å¯¼èˆªæ ï¼Œå³ä¾§å±•ç¤ºå½“å‰ç”¨æˆ·çš„ç™»å½•çŠ¶æ€ï¼ˆæš‚æ—¶ç”¨ç™»å½•æŒ‰é’®ä»£æ›¿ï¼‰ï¼š

```vue
<div class="user-login-status">
  <a-button type="primary" href="/user/login">ç™»å½•</a-button>
</div>
```

5ï¼‰ä¼˜åŒ–å¯¼èˆªæ çš„å¸ƒå±€ï¼Œé‡‡ç”¨ [æ …æ ¼ç»„ä»¶çš„è‡ªé€‚åº”å¸ƒå±€](https://antdv.com/components/grid-cn#components-grid-demo-flex-stretch)ï¼ˆå·¦ä¸­å³ç»“æ„ï¼Œå·¦ä¾§å³ä¾§å®½åº¦å›ºå®šï¼Œä¸­é—´èœå•æ è‡ªé€‚åº”ï¼‰

```vue
<a-row :wrap="false">
  <a-col flex="200px">
    <RouterLink to="/">
      <div class="title-bar">
        <img class="logo" src="../assets/logo.png" alt="logo" />
        <div class="title">é±¼çš®äº‘å›¾åº“</div>
      </div>
    </RouterLink>
  </a-col>
  <a-col flex="auto">
    <a-menu
      v-model:selectedKeys="current"
      mode="horizontal"
      :items="items"
    />
  </a-col>
  <a-col flex="120px">
    <div class="user-login-status">
      <a-button type="primary" href="/user/login">ç™»å½•</a-button>
    </div>
  </a-col>
</a-row>
```

æ•ˆæœå¦‚å›¾ï¼Œå¯ä»¥å°è¯•ç¼©å°æµè§ˆå™¨çª—å£è§‚å¯Ÿå¯¼èˆªæ¡çš„å˜åŒ–ï¼š

![img](./assets/E8gMQlaF0AtwQ9Yi.webp)

### è·¯ç”±

ç›®æ ‡ï¼šç‚¹å‡»èœå•é¡¹åï¼Œå¯ä»¥è·³è½¬åˆ°å¯¹åº”çš„é¡µé¢ï¼›å¹¶ä¸”åˆ·æ–°é¡µé¢åï¼Œå¯¹åº”çš„èœå•è‡ªåŠ¨é«˜äº®ã€‚

#### 1ã€ä¿®æ”¹è·¯ç”±é…ç½®

æŒ‰éœ€ä¿®æ”¹ router/index.ts æ–‡ä»¶çš„ routes é…ç½®ï¼Œå®šä¹‰æˆ‘ä»¬éœ€è¦çš„é¡µé¢è·¯ç”±ï¼Œæ¯ä¸ª path å¯¹åº”ä¸€ä¸ª componentï¼ˆè¦åŠ è½½çš„ç»„ä»¶ï¼‰ï¼šcT00UyE1JKn/y8Q147TQRzbDavEs+V72bbBFCS1wu6g=

```css
routes: [
  {
    path: '/',
    name: 'home',
    component: HomeView,
  },
  {
    path: '/about',
    name: 'about',
    // route level code-splitting
    // this generates a separate chunk (About.[hash].js) for this route
    // which is lazy-loaded when the route is visited.
    component: () => import('../views/AboutView.vue'),
  },
],
```

è§‚å¯Ÿä¸Šè¿°ä»£ç ï¼Œä¼šå‘ç° component æ”¯æŒç›´æ¥ä¼ å…¥ç»„ä»¶ã€æˆ–è€…ä½¿ç”¨ import æŒ‰éœ€æ‡’åŠ è½½ç»„ä»¶ï¼ŒæŒ‰éœ€åŠ è½½æ˜¯ä¸€ç§ä¼˜åŒ–é¦–æ¬¡æ‰“å¼€ç«™ç‚¹æ€§èƒ½çš„æ–¹å¼ã€‚

#### 2ã€è·¯ç”±è·³è½¬

ç»™ GlobalHeader çš„èœå•ç»„ä»¶ç»‘å®šè·³è½¬äº‹ä»¶ï¼š

```typescript
import { useRouter } from "vue-router";
const router = useRouter();

// è·¯ç”±è·³è½¬äº‹ä»¶
const doMenuClick = ({ key }: { key: string }) => {
  router.push({
    path: key,
  });
};
```

ä¿®æ”¹ HTML æ¨¡æ¿ï¼Œç»‘å®šäº‹ä»¶ï¼š

```vue
<a-menu
  v-model:selectedKeys="current"
  mode="horizontal"
  :items="items"
  @click="doMenuClick"
/>
```

#### 3ã€é«˜äº®åŒæ­¥

åˆ·æ–°é¡µé¢åï¼Œä½ ä¼šå‘ç°å½“å‰èœå•é¡¹å¹¶æ²¡æœ‰é«˜äº®ï¼Œæ‰€ä»¥éœ€è¦åŒæ­¥è·¯ç”±çš„æ›´æ–°åˆ°èœå•é¡¹é«˜äº®ã€‚cT00UyE1JKn/y8Q147TQRzbDavEs+V72bbBFCS1wu6g=

åŒæ­¥é«˜äº®åŸç†ï¼š

1. ç‚¹å‡»èœå•æ—¶ï¼ŒAnt Design ç»„ä»¶å·²ç»é€šè¿‡ v-model ç»‘å®š current å˜é‡å®ç°äº†é«˜äº®ã€‚
2. åˆ·æ–°é¡µé¢æ—¶ï¼Œéœ€è¦è·å–åˆ°å½“å‰ URL è·¯å¾„ï¼Œç„¶åä¿®æ”¹ current å˜é‡çš„å€¼ï¼Œä»è€Œå®ç°åŒæ­¥ã€‚

ä½¿ç”¨ Vue Router çš„ afterEach è·¯ç”±é’©å­å®ç°ï¼Œæ¯æ¬¡æ”¹å˜è·¯ç”±æˆ–åˆ·æ–°é¡µé¢æ—¶éƒ½ä¼šè‡ªåŠ¨æ›´æ–° current çš„å€¼ï¼Œä»è€Œå®ç°é«˜äº®ï¼šsqWmWUk8kFL4uPey9+8ro5dv7g8fCeOwW9uL7T8/Q4k=

```tsx
const router = useRouter();
// å½“å‰é€‰ä¸­èœå•
const current = ref<string[]>([]);
// ç›‘å¬è·¯ç”±å˜åŒ–ï¼Œæ›´æ–°å½“å‰é€‰ä¸­èœå•
router.afterEach((to, from, next) => {
  current.value = [to.path];
});
```

ğŸ’¡æ€è€ƒï¼šå¤§å®¶æœ‰æ²¡æœ‰å‘ç°ï¼Œè·¯ç”±å’Œèœå•é…ç½®ä¸­ï¼Œæœ‰ä¸€äº›æ˜¯é‡å¤çš„å‘¢ï¼Ÿæœ‰æ²¡æœ‰æ›´å¥½åœ°æ–¹å¼æ¥é…ç½®è·¯ç”±å’Œèœå•é¡¹ï¼Œä¸ç”¨æ¯æ¬¡ä¿®æ”¹æ—¶éƒ½è¦æ”¹ä¸¤è¾¹çš„ä»£ç å‘¢ï¼Ÿç­”æ¡ˆå°±æ˜¯å°†è·¯ç”±é…ç½®æ•°ç»„ä¼ é€’ç»™èœå•ç»„ä»¶ï¼Œå¤§å®¶å¯ä»¥å°è¯•è‡ªè¡Œå®ç°ã€‚ï¼ˆé±¼çš®çš„ [OJ åˆ¤é¢˜ç³»ç»Ÿé¡¹ç›®](https://www.codefather.cn/course)ã€[é±¼ç­”ç­” AI ç­”é¢˜åº”ç”¨å¹³å°é¡¹ç›®](https://www.codefather.cn/course) ä¸­æœ‰è®²è¿‡ï¼‰

### è¯·æ±‚

> å¼•å…¥ Axios è¯·æ±‚åº“

ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå‰ç«¯åªè´Ÿè´£ç•Œé¢å±•ç¤ºå’ŒåŠ¨æ•ˆäº¤äº’ï¼Œå°½é‡é¿å…å†™å¤æ‚çš„é€»è¾‘ï¼›å½“éœ€è¦è·å–æ•°æ®æ—¶ï¼Œé€šå¸¸æ˜¯å‘åç«¯æä¾›çš„æ¥å£å‘é€è¯·æ±‚ï¼Œç”±åç«¯æ‰§è¡Œæ“ä½œï¼ˆæ¯”å¦‚ä¿å­˜æ•°æ®ï¼‰å¹¶å“åº”æ•°æ®ç»™å‰ç«¯ã€‚

å‰ç«¯å¦‚ä½•å‘åç«¯å‘é€è¯·æ±‚å‘¢ï¼Ÿæœ€ä¼ ç»Ÿçš„æ–¹å¼æ˜¯ä½¿ç”¨ AJAX æŠ€æœ¯ã€‚ä½†å…¶ä»£ç æœ‰äº›å¤æ‚ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ç¬¬ä¸‰æ–¹çš„å°è£…åº“ï¼Œæ¥ç®€åŒ–å‘é€è¯·æ±‚çš„ä»£ç ï¼Œæ¯”å¦‚ä¸»æµçš„è¯·æ±‚å·¥å…·åº“ Axiosã€‚

#### 1ã€è¯·æ±‚å·¥å…·åº“

å®‰è£…è¯·æ±‚å·¥å…·ç±» Axiosï¼Œå‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼šhttps://axios-http.com/docs/intro

ä»£ç ï¼š

```shell
npm install axios
```

#### 2ã€å…¨å±€è‡ªå®šä¹‰è¯·æ±‚

éœ€è¦è‡ªå®šä¹‰å…¨å±€è¯·æ±‚åœ°å€ç­‰ï¼Œå‚è€ƒ Axios å®˜æ–¹æ–‡æ¡£ï¼Œç¼–å†™è¯·æ±‚é…ç½®æ–‡ä»¶ `request.ts`ã€‚åŒ…æ‹¬å…¨å±€æ¥å£è¯·æ±‚åœ°å€ã€è¶…æ—¶æ—¶é—´ã€è‡ªå®šä¹‰è¯·æ±‚å“åº”æ‹¦æˆªå™¨ç­‰ã€‚

å“åº”æ‹¦æˆªå™¨çš„åº”ç”¨åœºæ™¯ï¼šæˆ‘ä»¬éœ€è¦å¯¹æ¥å£çš„ **é€šç”¨å“åº”** è¿›è¡Œç»Ÿä¸€å¤„ç†ï¼Œæ¯”å¦‚ä» response ä¸­å–å‡º dataï¼›æˆ–è€…æ ¹æ® code å»é›†ä¸­å¤„ç†é”™è¯¯ã€‚è¿™æ ·ä¸ç”¨åœ¨æ¯ä¸ªæ¥å£è¯·æ±‚ä¸­éƒ½å»å†™ç›¸åŒçš„é€»è¾‘ã€‚

æ¯”å¦‚å¯ä»¥åœ¨å…¨å±€å“åº”æ‹¦æˆªå™¨ä¸­ï¼Œè¯»å–å‡ºç»“æœä¸­çš„ dataï¼Œå¹¶æ ¡éªŒ code æ˜¯å¦åˆæ³•ï¼Œå¦‚æœæ˜¯æœªç™»å½•çŠ¶æ€ï¼Œåˆ™è‡ªåŠ¨ç™»å½•ã€‚

ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼Œå…¶ä¸­ `withCredentials: true` ä¸€å®šè¦å†™ï¼Œå¦åˆ™æ— æ³•åœ¨å‘è¯·æ±‚æ—¶æºå¸¦ Cookieï¼Œå°±æ— æ³•å®Œæˆç™»å½•ã€‚

ä»£ç å¦‚ä¸‹ï¼š

```typescript
import axios from 'axios'
import { message } from 'ant-design-vue'

// åˆ›å»º Axios å®ä¾‹
const myAxios = axios.create({
  baseURL: 'http://localhost:8123',
  timeout: 60000,
  withCredentials: true,
})

// å…¨å±€è¯·æ±‚æ‹¦æˆªå™¨
myAxios.interceptors.request.use(
  function (config) {
    // Do something before request is sent
    return config
  },
  function (error) {
    // Do something with request error
    return Promise.reject(error)
  },
)

// å…¨å±€å“åº”æ‹¦æˆªå™¨
myAxios.interceptors.response.use(
  function (response) {
    const { data } = response
    // æœªç™»å½•
    if (data.code === 40100) {
      // ä¸æ˜¯è·å–ç”¨æˆ·ä¿¡æ¯çš„è¯·æ±‚ï¼Œå¹¶ä¸”ç”¨æˆ·ç›®å‰ä¸æ˜¯å·²ç»åœ¨ç”¨æˆ·ç™»å½•é¡µé¢ï¼Œåˆ™è·³è½¬åˆ°ç™»å½•é¡µé¢
      if (
        !response.request.responseURL.includes('user/get/login') &&
        !window.location.pathname.includes('/user/login')
      ) {
        message.warning('è¯·å…ˆç™»å½•')
        window.location.href = `/user/login?redirect=${window.location.href}`
      }
    }
    return response
  },
  function (error) {
    // Any status codes that falls outside the range of 2xx cause this function to trigger
    // Do something with response error
    return Promise.reject(error)
  },
)

export default myAxios
```

#### 3ã€è‡ªåŠ¨ç”Ÿæˆè¯·æ±‚ä»£ç 

å¦‚æœé‡‡ç”¨ä¼ ç»Ÿå¼€å‘æ–¹å¼ï¼Œé’ˆå¯¹æ¯ä¸ªè¯·æ±‚éƒ½è¦å•ç‹¬ç¼–å†™ä»£ç ï¼Œå¾ˆéº»çƒ¦ã€‚

æ¨èä½¿ç”¨ OpenAPI å·¥å…·ï¼Œç›´æ¥è‡ªåŠ¨ç”Ÿæˆå³å¯ï¼šhttps://www.npmjs.com/package/@umijs/openapi

æŒ‰ç…§å®˜æ–¹æ–‡æ¡£çš„æ­¥éª¤ï¼Œå…ˆå®‰è£…ï¼š

```shell
npm i --save-dev @umijs/openapi
```

åœ¨ **é¡¹ç›®æ ¹ç›®å½• **æ–°å»º `openapi.config.js`ï¼Œæ ¹æ®è‡ªå·±çš„éœ€è¦å®šåˆ¶ç”Ÿæˆçš„ä»£ç ï¼š

```typescript
import { generateService } from '@umijs/openapi'

generateService({
  requestLibPath: "import request from '@/request'",
  schemaPath: 'http://localhost:8123/api/v2/api-docs',
  serversPath: './src',
})
```

**æ³¨æ„ï¼Œè¦å°† schemaPath æ”¹ä¸ºè‡ªå·±åç«¯æœåŠ¡æä¾›çš„ Swagger æ¥å£æ–‡æ¡£çš„åœ°å€ã€‚**

åœ¨ package.json çš„ script ä¸­æ·»åŠ  `"openapi": "node openapi.config.js"`

æ‰§è¡Œå³å¯ç”Ÿæˆè¯·æ±‚ä»£ç ï¼Œè¿˜åŒ…æ‹¬ TypeScript ç±»å‹ï¼š![img](./assets/rjPby2IANNsRZEEx.webp)

ä»¥åæ¯æ¬¡åç«¯æ¥å£å˜æ›´æ—¶ï¼Œåªéœ€è¦é‡æ–°ç”Ÿæˆä¸€éå°±å¥½ï¼Œéå¸¸æ–¹ä¾¿~

#### 4ã€æµ‹è¯•è¯·æ±‚

å¯ä»¥å°è¯•åœ¨ä»»æ„é¡µé¢ä»£ç ä¸­è°ƒç”¨ APIï¼š

```typescript
import { healthUsingGet } from '@/api/mainController'

healthUsingGet().then((res) => {
  console.log(res)
})
```

æŒ‰ F12 æ‰“å¼€å¼€å‘è€…å·¥å…·æŸ¥çœ‹è¯·æ±‚ï¼Œç”±äºæˆ‘ä»¬åç«¯å·²ç»æ·»åŠ äº†å…¨å±€è·¨åŸŸé…ç½®ï¼Œæ­£å¸¸æƒ…å†µä¸‹åº”è¯¥èƒ½çœ‹åˆ°å¦‚ä¸‹å“åº”ï¼š

![img](./assets/Bqn7baGH3Qjeoxqx.webp)

#### 5ã€è§£å†³è·¨åŸŸï¼ˆå¯é€‰ï¼‰

å¦‚æœå‘ç°è¯·æ±‚é”™è¯¯ï¼Œè¦æŸ¥çœ‹é”™è¯¯ä¿¡æ¯å…·ä½“åˆ†æã€‚æ¯”å¦‚é‡åˆ° **è·¨åŸŸé—®é¢˜**ï¼Œè¿™æ˜¯ç”±äºå‰ç«¯ç½‘é¡µåœ°å€å’Œåç«¯è¯·æ±‚æ¥å£åœ°å€ä¸åŒå¯¼è‡´çš„ï¼š

![img](./assets/bDwJvewtotrHjVOJ.webp)

è¿™ç§æƒ…å†µä¸‹ï¼Œå¯ä»¥é€šè¿‡ä¿®æ”¹åç«¯ä»£ç ï¼Œå¢åŠ å…¨å±€è·¨åŸŸé…ç½®æˆ–è€…è·¨åŸŸæ³¨è§£æ¥è§£å†³ï¼š

![è·¨åŸŸæ³¨è§£](./assets/KO0O6l3lmodj4g1U.webp)

å¦‚æœåç«¯ä»£ç æ— æ³•ä¿®æ”¹ï¼Œè¿˜å¯ä»¥é€šè¿‡å‰ç«¯ä»£ç†æœåŠ¡å™¨æ¥è§£å†³ï¼Œå¦‚æœé¡¹ç›®ä½¿ç”¨ Viteï¼Œå†…ç½®äº†ä»£ç†æœåŠ¡å™¨ã€‚å¯ä»¥ä¿®æ”¹ vite.config.ts æ–‡ä»¶ï¼Œå¢åŠ ä»£ç†é…ç½®ï¼š

```typescript
export default defineConfig({
  server: {
    proxy: {
      '/api': 'http://localhost:8123',
    }
  },
})
```

åŒæ—¶ä¿®æ”¹ request.tsï¼Œç§»é™¤è¯·æ±‚å‰ç¼€ï¼š

```typescript
// åˆ›å»º Axios å®ä¾‹
const myAxios = axios.create({
  baseURL: '',
  timeout: 60000,
  withCredentials: true,
})
```

è¿™æ ·ä¸€æ¥ï¼Œå‰ç«¯å‘é€çš„è¯·æ±‚åŸŸåå°±ç­‰åŒäºå½“å‰ URL çš„åŸŸåï¼Œå°±ä¸ä¼šå‡ºç°è·¨åŸŸã€‚ä½†æ˜¯è®¿é—®åˆ° /api å¼€å¤´çš„æ¥å£æ—¶ï¼Œä¼šè¢«ä»£ç†åˆ°è¯·æ±‚ 8123 ç«¯å£çš„åç«¯æœåŠ¡å™¨ï¼Œä»è€Œå®Œæˆè¯·æ±‚ã€‚

ğŸ’¡ è¿˜æœ‰å¾ˆå¤šå‰ç«¯ä»£ç†å·¥å…·ï¼Œæ¯”å¦‚ [Whistle](https://wproxy.org/whistle/install.html)ï¼Œå‰ç«¯æ–¹å‘çš„åŒå­¦å¯ä»¥å»äº†è§£ä¸‹ã€‚

### å…¨å±€çŠ¶æ€ç®¡ç†

ä»€ä¹ˆæ˜¯å…¨å±€çŠ¶æ€ç®¡ç†ï¼Ÿ

ç­”ï¼šæ‰€æœ‰é¡µé¢å…¨å±€å…±äº«çš„å˜é‡ï¼Œè€Œä¸æ˜¯å±€é™åœ¨æŸä¸€ä¸ªé¡µé¢ä¸­ã€‚

é€‚åˆä½œä¸ºå…¨å±€çŠ¶æ€çš„æ•°æ®ï¼šå·²ç™»å½•ç”¨æˆ·ä¿¡æ¯ï¼ˆæ¯ä¸ªé¡µé¢å‡ ä¹éƒ½è¦ç”¨ï¼‰

Pinia æ˜¯ä¸€ä¸ªä¸»æµçš„çŠ¶æ€ç®¡ç†åº“ï¼Œç›¸æ¯”äº Vuex æ¥è¯´ä½¿ç”¨æ›´ç®€å•ï¼Œå¯å‚è€ƒ [å…¥é—¨æ–‡æ¡£](https://pinia.vuejs.org/zh/getting-started.html) è¿›è¡Œå¼•å…¥ã€‚

#### 1ã€å¼•å…¥ Pinia

æ­¤å¤„ç”±äº create-vue è„šæ‰‹æ¶å·²ç»å¸®æˆ‘ä»¬æ•´åˆäº† Piniaï¼Œæ— éœ€æ‰‹åŠ¨å¼•å…¥ï¼Œç›´æ¥ä½¿ç”¨å³å¯ã€‚

#### 2ã€å®šä¹‰çŠ¶æ€

åœ¨ src/stores ç›®å½•ä¸‹å®šä¹‰ user æ¨¡å—ï¼Œå®šä¹‰äº†ç”¨æˆ·çš„å­˜å‚¨ã€è¿œç¨‹è·å–ã€ä¿®æ”¹é€»è¾‘ï¼š

```typescript
import { defineStore } from "pinia";
import { ref } from "vue";

export const useLoginUserStore = defineStore("loginUser", () => {
  const loginUser = ref<any>({
    userName: "æœªç™»å½•",
  });

  async function fetchLoginUser() {
    // todo ç”±äºåç«¯è¿˜æ²¡æä¾›æ¥å£ï¼Œæš‚æ—¶æ³¨é‡Š
    // const res = await getCurrentUser();
    // if (res.data.code === 0 && res.data.data) {
    //   loginUser.value = res.data.data;
    // }
  }

  function setLoginUser(newLoginUser: any) {
    loginUser.value = newLoginUser;
  }

  return { loginUser, setLoginUser, fetchLoginUser };
});
```

#### 3ã€ä½¿ç”¨çŠ¶æ€

å¯ä»¥ç›´æ¥ä½¿ç”¨ store ä¸­å¯¼å‡ºçš„çŠ¶æ€å˜é‡å’Œå‡½æ•°ã€‚

åœ¨é¦–æ¬¡è¿›å…¥åˆ°é¡µé¢æ—¶ï¼Œä¸€èˆ¬æˆ‘ä»¬ä¼šå°è¯•è·å–ç™»å½•ç”¨æˆ·ä¿¡æ¯ã€‚ä¿®æ”¹ App.vueï¼Œç¼–å†™è¿œç¨‹è·å–æ•°æ®ä»£ç ï¼š

```typescript
const loginUserStore = useLoginUserStore()
loginUserStore.fetchLoginUser()
```

åœ¨ä»»ä½•é¡µé¢ä¸­éƒ½å¯ä»¥ä½¿ç”¨æ•°æ®ï¼Œæ¯”å¦‚ GlobalHeader å…¨å±€é¡¶éƒ¨æ ç»„ä»¶ä¸­ç›´æ¥å±•ç¤ºï¼šqHT6Kxg12X1vklSWA3QVO0Z9aqth3Yj5Z1UQTagntCA=

```typescript
{{ JSON.stringify(loginUserStore.loginUser) }}
```

ä¿®æ”¹å…¨å±€é¡¶éƒ¨æ ç»„ä»¶ï¼Œåœ¨å³ä¾§å±•ç¤ºç™»å½•çŠ¶æ€ï¼š

```vue
<div class="user-login-status">
  <div v-if="loginUserStore.loginUser.id">
    {{ loginUserStore.loginUser.userName ?? 'æ— å' }}
  </div>
  <div v-else>
    <a-button type="primary" href="/user/login">ç™»å½•</a-button>
  </div>
</div>
```

#### 4ã€æµ‹è¯•å…¨å±€çŠ¶æ€ç®¡ç†

åœ¨ userStore ä¸­ç¼–å†™æµ‹è¯•ä»£ç ï¼Œæµ‹è¯•ç”¨æˆ·çŠ¶æ€çš„æ›´æ–°ï¼š

```typescript
async function fetchLoginUser() {
  // æµ‹è¯•ç”¨æˆ·ç™»å½•ï¼Œ3 ç§’åç™»å½•
  setTimeout(() => {
    loginUser.value = { userName: 'æµ‹è¯•ç”¨æˆ·', id: 1 }
  }, 3000)
}
```

æŸ¥çœ‹æ•ˆæœï¼Œç­‰å¾… 3 ç§’åç½‘ç«™å³ä¸Šæ–¹ä¼šå±•ç¤ºå‡ºç™»å½•ç”¨æˆ·ä¿¡æ¯ï¼š

![img](./assets/YTpW1ZzxrBuyTY2f.webp)

è‡³æ­¤ï¼Œä¸€ä¸ªå…¥é—¨çº§çš„å‰ç«¯é¡¹ç›®å°±åˆå§‹åŒ–å¥½äº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±å¯ä»¥è¿›è¡Œé¡µé¢å¼€å‘ã€‚

### é¡µé¢å¼€å‘æµç¨‹

æˆ‘ä»¬é€šè¿‡å¼€å‘ä¸€ä¸ªç®€æ˜“çš„ç¤ºä¾‹é¡µé¢ï¼Œæ¥äº†è§£é¡µé¢å¼€å‘çš„æµç¨‹ã€‚

1ï¼‰æ–°å»º src/pages ç›®å½•ï¼Œç”¨äºå­˜æ”¾æ‰€æœ‰çš„é¡µé¢æ–‡ä»¶ã€‚

ç„¶ååœ¨ pages ç›®å½•ä¸‹æ–°å»ºé¡µé¢æ–‡ä»¶ï¼Œå°†æ‰€æœ‰é¡µé¢æŒ‰ç…§ url å±‚çº§è¿›è¡Œåˆ›å»ºï¼Œå¹¶ä¸”é¡µé¢åç§°å°½é‡åšåˆ°â€œè§åçŸ¥æ„â€ã€‚

ä¸¾ä¸ªä¾‹å­ï¼š

![img](./assets/d7kjkupXHeupqQa4.webp)

å…¶ä¸­ï¼Œ/user/login åœ°å€å°±å¯¹åº”äº† UserLoginPageã€‚

æ­¤å¤„æˆ‘ä»¬æ–°å»º HomePage.vue å³å¯ã€‚

2ï¼‰æ¯æ¬¡æ–°å»ºé¡µé¢æ—¶ï¼Œéœ€è¦åœ¨ router/index.ts ä¸­é…ç½®è·¯ç”±ï¼Œæ¯”å¦‚æ¬¢è¿é¡µçš„è·¯ç”±ä¸ºï¼šKvj0N9UsvjnA2JCtBYVVlZvRih721R4WfPhhdfsvDfk=

```typescript
const routes: Array<RouteRecordRaw> = [
  {
    path: "/",
    name: "home",
    component: HomeView,
  },
  ...
]
```

ç„¶ååœ¨è·¯ç”±æ–‡ä»¶ä¸­ï¼Œå¼•å…¥é¡µé¢ HomePageï¼š

```typescript
import HomePage from "@/pages/HomePage.vue";

const routes: Array<RouteRecordRaw> = [
  {
    path: "/",
    name: "home",
    component: HomePage,
  },
  ...
]
```

ä»»æ„ä¿®æ”¹é¡µé¢ä»£ç ï¼š

```vue
<template>
  <div id="homePage">
    <h1>{{ msg }}</h1>
  </div>
</template>

<script setup lang="ts">
const msg = "æ¬¢è¿æ¥åˆ°ç¼–ç¨‹å¯¼èˆªï¼Œä½ å°†ä»è¿™é‡Œå¼€å§‹é¡¹ç›®å­¦ä¹ ä¹‹æ—…~";
</script>

<style scoped>
#homePage {
}
</style>
```

é¡µé¢æ•ˆæœå¦‚å›¾ï¼š

![img](./assets/J6Aikr4YIjlz6dLK.webp)

### æ‰©å±•

åœ¨åç»­å¼€å‘ä¸­ä½ ä¼šå‘ç°ï¼ŒAnt Design Vue é»˜è®¤ä½¿ç”¨çš„æ˜¯è‹±æ–‡æ–‡æ¡ˆï¼Œå¦‚æœéœ€è¦æ›¿æ¢ä¸ºä¸­æ–‡ï¼Œå¯ä»¥å‚è€ƒ [å›½é™…åŒ–æ–‡æ¡£](https://antdv.com/docs/vue/i18n-cn)ï¼Œåªéœ€ç»™æ•´ä¸ªåº”ç”¨åŒ…è£¹ä¸€å±‚ç»„ä»¶å³å¯å®Œæˆã€‚

------

æœ¬èŠ‚æ•™ç¨‹åˆ°è¿™é‡Œå°±ç»“æŸäº†ï¼Œå»ºè®®å¤§å®¶ä» 0 å®æ“ä¸‹é¡¹ç›®åˆå§‹åŒ–ï¼Œä»¥åè‡ªå·±æ­å»ºä¸€ä¸ªæ–°é¡¹ç›®ï¼Œä¹Ÿä¸ä¼šè§‰å¾—å›°éš¾å•¦~





# 3 - ç”¨æˆ·æ¨¡å—

## æœ¬èŠ‚é‡ç‚¹

é¦–å…ˆå¼€å‘æ¯ä¸ªé¡¹ç›®åŸºæœ¬éƒ½å…·æœ‰çš„ç”¨æˆ·æ¨¡å—ï¼Œæœ¬èŠ‚æ•™ç¨‹å¯ä»¥å½“åšä¸€ä¸ª **ç”¨æˆ·ç®¡ç†ç³»ç»Ÿé¡¹ç›®** ç‹¬ç«‹å­¦ä¹ ï¼Œé€‚åˆæ–°æ‰‹å…¥é—¨ï¼Œåç«¯å’Œå‰ç«¯éƒ¨åˆ†ä¹Ÿå¯ä»¥æŒ‰éœ€ç‹¬ç«‹å­¦ä¹ ã€‚

æœ¬èŠ‚å¤§çº²ï¼š

- éœ€æ±‚åˆ†æ
- æ–¹æ¡ˆè®¾è®¡
- åç«¯å¼€å‘
- å‰ç«¯å¼€å‘

## ä¸€ã€éœ€æ±‚åˆ†æ

å¯¹äºç”¨æˆ·æ¨¡å—ï¼Œé€šå¸¸è¦å…·æœ‰ä¸‹åˆ—åŠŸèƒ½ï¼š

- ç”¨æˆ·æ³¨å†Œ
- ç”¨æˆ·ç™»å½•
- è·å–å½“å‰ç™»å½•ç”¨æˆ·
- ç”¨æˆ·æ³¨é”€
- ç”¨æˆ·æƒé™æ§åˆ¶
- ã€ç®¡ç†å‘˜ã€‘ç®¡ç†ç”¨æˆ·

å…·ä½“åˆ†ææ¯ä¸ªéœ€æ±‚ï¼š

1ï¼‰ç”¨æˆ·æ³¨å†Œï¼šç”¨æˆ·å¯ä»¥é€šè¿‡è¾“å…¥è´¦å·ã€å¯†ç ã€ç¡®è®¤å¯†ç è¿›è¡Œæ³¨å†Œ

2ï¼‰ç”¨æˆ·ç™»å½•ï¼šç”¨æˆ·å¯ä»¥é€šè¿‡è¾“å…¥è´¦å·å’Œå¯†ç ç™»å½•

3ï¼‰è·å–å½“å‰ç™»å½•ç”¨æˆ·ï¼šå¾—åˆ°å½“å‰å·²ç»ç™»å½•çš„ç”¨æˆ·ä¿¡æ¯ï¼ˆä¸ç”¨é‡å¤ç™»å½•ï¼‰

4ï¼‰ç”¨æˆ·æ³¨é”€ï¼šç”¨æˆ·å¯ä»¥é€€å‡ºç™»å½•

5ï¼‰ç”¨æˆ·æƒé™æ§åˆ¶ï¼šç”¨æˆ·åˆåˆ†ä¸ºæ™®é€šç”¨æˆ·å’Œç®¡ç†å‘˜ï¼Œç®¡ç†å‘˜æ‹¥æœ‰æ•´ä¸ªç³»ç»Ÿçš„æœ€é«˜æƒé™ï¼Œæ¯”å¦‚å¯ä»¥ç®¡ç†å…¶ä»–ç”¨æˆ·

6ï¼‰ç”¨æˆ·ç®¡ç†ï¼šä»…ç®¡ç†å‘˜å¯ç”¨ï¼Œå¯ä»¥å¯¹æ•´ä¸ªç³»ç»Ÿä¸­çš„ç”¨æˆ·è¿›è¡Œç®¡ç†ï¼Œæ¯”å¦‚æœç´¢ç”¨æˆ·ã€åˆ é™¤ç”¨æˆ·

## äºŒã€æ–¹æ¡ˆè®¾è®¡

å®ç°ç”¨æˆ·æ¨¡å—çš„éš¾åº¦ä¸å¤§ï¼Œæ–¹æ¡ˆè®¾è®¡é˜¶æ®µæˆ‘ä»¬éœ€è¦ç¡®è®¤ï¼š

- åº“è¡¨è®¾è®¡
- ç”¨æˆ·ç™»å½•æµç¨‹
- å¦‚ä½•å¯¹ç”¨æˆ·æƒé™è¿›è¡Œæ§åˆ¶ï¼Ÿ

### åº“è¡¨è®¾è®¡

åº“åï¼šyu_picture

è¡¨åï¼šuserï¼ˆç”¨æˆ·è¡¨ï¼‰

é±¼çš®ä¼šå…ˆè®²æœ¬é¡¹ç›®éœ€è¦çš„æ ¸å¿ƒè®¾è®¡ï¼Œå†è¡¥å……ä¸€äº›æ‰©å±•è®¾è®¡ï¼Œä¾¿äºå¤§å®¶å­¦ä¹ ã€‚XJ858sBsdVoQsBlQbSlEZH9bgQFu4XZchClXOymxgUA=

#### 1ã€æ ¸å¿ƒè®¾è®¡

ç”¨æˆ·è¡¨çš„æ ¸å¿ƒæ˜¯ç”¨æˆ·ç™»å½•å‡­è¯ï¼ˆè´¦å·å¯†ç ï¼‰å’Œä¸ªäººä¿¡æ¯ï¼ŒSQL å¦‚ä¸‹ï¼š

```sql
â–¼-- ç”¨æˆ·è¡¨
create table if not exists user
(
    id           bigint auto_increment comment 'id' primary key,
    userAccount  varchar(256)                           not null comment 'è´¦å·',
    userPassword varchar(512)                           not null comment 'å¯†ç ',
    userName     varchar(256)                           null comment 'ç”¨æˆ·æ˜µç§°',
    userAvatar   varchar(1024)                          null comment 'ç”¨æˆ·å¤´åƒ',
    userProfile  varchar(512)                           null comment 'ç”¨æˆ·ç®€ä»‹',
    userRole     varchar(256) default 'user'            not null comment 'ç”¨æˆ·è§’è‰²ï¼šuser/admin',
    editTime     datetime     default CURRENT_TIMESTAMP not null comment 'ç¼–è¾‘æ—¶é—´',
    createTime   datetime     default CURRENT_TIMESTAMP not null comment 'åˆ›å»ºæ—¶é—´',
    updateTime   datetime     default CURRENT_TIMESTAMP not null on update CURRENT_TIMESTAMP comment 'æ›´æ–°æ—¶é—´',
    isDelete     tinyint      default 0                 not null comment 'æ˜¯å¦åˆ é™¤',
    UNIQUE KEY uk_userAccount (userAccount),
    INDEX idx_userName (userName)
) comment 'ç”¨æˆ·' collate = utf8mb4_unicode_ci;
```

å‡ ä¸ªæ³¨æ„äº‹é¡¹ï¼š

1ï¼‰editTime å’Œ updateTime çš„åŒºåˆ«ï¼šeditTime è¡¨ç¤ºç”¨æˆ·ç¼–è¾‘ä¸ªäººä¿¡æ¯çš„æ—¶é—´ï¼ˆéœ€è¦ä¸šåŠ¡ä»£ç æ¥æ›´æ–°ï¼‰ï¼Œè€Œ updateTime è¡¨ç¤ºè¿™æ¡ç”¨æˆ·è®°å½•ä»»ä½•å­—æ®µå‘ç”Ÿä¿®æ”¹çš„æ—¶é—´ï¼ˆç”±æ•°æ®åº“è‡ªåŠ¨æ›´æ–°ï¼‰ã€‚

2ï¼‰ç»™å”¯ä¸€å€¼æ·»åŠ å”¯ä¸€é”®ï¼ˆå”¯ä¸€ç´¢å¼•ï¼‰ï¼Œæ¯”å¦‚è´¦å· userAccountï¼Œåˆ©ç”¨æ•°æ®åº“å¤©ç„¶é˜²é‡å¤ï¼ŒåŒæ—¶å¯ä»¥å¢åŠ æŸ¥è¯¢æ•ˆç‡ã€‚

3ï¼‰ç»™ç»å¸¸ç”¨äºæŸ¥è¯¢çš„å­—æ®µæ·»åŠ ç´¢å¼•ï¼Œæ¯”å¦‚ç”¨æˆ·æ˜µç§° userNameï¼Œå¯ä»¥å¢åŠ æŸ¥è¯¢æ•ˆç‡ã€‚

ğŸ’¡ å»ºè®®å…»æˆå¥½ä¹ æƒ¯ï¼Œå°†åº“è¡¨è®¾è®¡ SQL ä¿å­˜åˆ°é¡¹ç›®çš„ç›®å½•ä¸­ï¼Œæ¯”å¦‚æ–°å»º `sql/create_table.sql` æ–‡ä»¶ï¼Œè¿™æ ·å…¶ä»–å¼€å‘è€…å°±èƒ½æ›´å¿«åœ°äº†è§£é¡¹ç›®ã€‚

#### 2ã€æ‰©å±•è®¾è®¡

1ï¼‰å¦‚æœè¦å®ç°ä¼šå‘˜åŠŸèƒ½ï¼Œå¯ä»¥å¯¹è¡¨è¿›è¡Œå¦‚ä¸‹æ‰©å±•ï¼š

1. ç»™ userRole å­—æ®µæ–°å¢æšä¸¾å€¼ `vip`ï¼Œè¡¨ç¤ºä¼šå‘˜ç”¨æˆ·ï¼Œå¯æ ¹æ®è¯¥å€¼åˆ¤æ–­ç”¨æˆ·æƒé™
2. æ–°å¢ä¼šå‘˜è¿‡æœŸæ—¶é—´å­—æ®µï¼Œå¯ç”¨äºè®°å½•ä¼šå‘˜æœ‰æ•ˆæœŸ
3. æ–°å¢ä¼šå‘˜å…‘æ¢ç å­—æ®µï¼Œå¯ç”¨äºè®°å½•ä¼šå‘˜çš„å¼€é€šæ–¹å¼
4. æ–°å¢ä¼šå‘˜ç¼–å·å­—æ®µï¼Œå¯ä¾¿äºå®šä½ç”¨æˆ·å¹¶æä¾›é¢å¤–æœåŠ¡ï¼Œå¹¶å¢åŠ ä¼šå‘˜å½’å±æ„Ÿ

å¯¹åº”çš„ SQL å¦‚ä¸‹ï¼š

```sql
vipExpireTime datetime     null comment 'ä¼šå‘˜è¿‡æœŸæ—¶é—´',
vipCode       varchar(128) null comment 'ä¼šå‘˜å…‘æ¢ç ',
vipNumber     bigint       null comment 'ä¼šå‘˜ç¼–å·'
```

2ï¼‰å¦‚æœè¦å®ç°ç”¨æˆ·é‚€è¯·åŠŸèƒ½ï¼Œå¯ä»¥å¯¹è¡¨è¿›è¡Œå¦‚ä¸‹æ‰©å±•ï¼š

1. æ–°å¢ shareCode åˆ†äº«ç å­—æ®µï¼Œç”¨äºè®°å½•æ¯ä¸ªç”¨æˆ·çš„å”¯ä¸€é‚€è¯·æ ‡è¯†ï¼Œå¯æ‹¼æ¥åˆ°é‚€è¯·ç½‘å€åé¢ï¼Œæ¯”å¦‚ https://mianshiya.com/?shareCode=xxx
2. æ–°å¢ inviteUser å­—æ®µï¼Œç”¨äºè®°å½•è¯¥ç”¨æˆ·è¢«å“ªä¸ªç”¨æˆ·é‚€è¯·äº†ï¼Œå¯é€šè¿‡è¿™ä¸ªå­—æ®µæŸ¥è¯¢æŸç”¨æˆ·é‚€è¯·çš„ç”¨æˆ·åˆ—è¡¨ã€‚

å¯¹åº”çš„ SQL å¦‚ä¸‹ï¼š

```sql
shareCode     varchar(20)  DEFAULT NULL COMMENT 'åˆ†äº«ç ',
inviteUser    bigint       DEFAULT NULL COMMENT 'é‚€è¯·ç”¨æˆ· id'
```

### ç”¨æˆ·ç™»å½•æµç¨‹

1ï¼‰å»ºç«‹åˆå§‹ä¼šè¯ï¼šå‰ç«¯ä¸æœåŠ¡å™¨å»ºç«‹è¿æ¥åï¼ŒæœåŠ¡å™¨ä¼šä¸ºè¯¥å®¢æˆ·ç«¯åˆ›å»ºä¸€ä¸ªåˆå§‹çš„åŒ¿å Sessionï¼Œå¹¶å°†å…¶çŠ¶æ€ä¿å­˜ä¸‹æ¥ã€‚è¿™ä¸ª Session çš„ ID ä¼šä½œä¸ºå”¯ä¸€æ ‡è¯†ï¼Œè¿”å›ç»™å‰ç«¯ã€‚

2ï¼‰ç™»å½•æˆåŠŸï¼Œæ›´æ–°ä¼šè¯ä¿¡æ¯ï¼šå½“ç”¨æˆ·åœ¨å‰ç«¯è¾“å…¥æ­£ç¡®çš„è´¦å·å¯†ç å¹¶æäº¤åˆ°åç«¯éªŒè¯æˆåŠŸåï¼Œåç«¯ä¼šæ›´æ–°è¯¥ç”¨æˆ·çš„ Sessionï¼Œå°†ç”¨æˆ·çš„ç™»å½•ä¿¡æ¯ï¼ˆå¦‚ç”¨æˆ· IDã€ç”¨æˆ·åç­‰ï¼‰ä¿å­˜åˆ°ä¸è¯¥ Session å…³è”çš„å­˜å‚¨ä¸­ã€‚åŒæ—¶ï¼ŒæœåŠ¡å™¨ä¼šç”Ÿæˆä¸€ä¸ª Set-Cookie çš„å“åº”å¤´ï¼ŒæŒ‡ç¤ºå‰ç«¯ä¿å­˜è¯¥ç”¨æˆ·çš„ Session IDã€‚

3ï¼‰å‰ç«¯ä¿å­˜ Cookieï¼šå‰ç«¯æ¥æ”¶åˆ°åç«¯çš„å“åº”åï¼Œæµè§ˆå™¨ä¼šè‡ªåŠ¨æ ¹æ® Set-Cookie æŒ‡ä»¤ï¼Œå°† Session ID å­˜å‚¨åˆ°æµè§ˆå™¨çš„ Cookie ä¸­ï¼Œä¸è¯¥åŸŸåç»‘å®šã€‚

4ï¼‰å¸¦ Cookie çš„åç»­è¯·æ±‚ï¼šå½“å‰ç«¯å†æ¬¡å‘ç›¸åŒåŸŸåçš„æœåŠ¡å™¨å‘é€è¯·æ±‚æ—¶ï¼Œæµè§ˆå™¨ä¼šè‡ªåŠ¨åœ¨è¯·æ±‚å¤´ä¸­é™„å¸¦ä¹‹å‰ä¿å­˜çš„ Cookieï¼Œå…¶ä¸­åŒ…å« Session IDã€‚

5ï¼‰åç«¯éªŒè¯ä¼šè¯ï¼šæœåŠ¡å™¨æ¥æ”¶åˆ°è¯·æ±‚åï¼Œä»è¯·æ±‚å¤´ä¸­æå– Session IDï¼Œæ‰¾åˆ°å¯¹åº”çš„ Session æ•°æ®ã€‚

6ï¼‰è·å–ä¼šè¯ä¸­å­˜å‚¨çš„ä¿¡æ¯ï¼šåç«¯é€šè¿‡è¯¥ Session è·å–ä¹‹å‰å­˜å‚¨çš„ç”¨æˆ·ä¿¡æ¯ï¼ˆå¦‚ç™»å½•åã€æƒé™ç­‰ï¼‰ï¼Œä»è€Œè¯†åˆ«ç”¨æˆ·èº«ä»½å¹¶æ‰§è¡Œç›¸åº”çš„ä¸šåŠ¡é€»è¾‘ã€‚

![afd3837a80c36e49d17bfb04f6a7cb21.png](./assets/jBcQuVlh8pVktFau.webp)

### å¦‚ä½•å¯¹ç”¨æˆ·æƒé™è¿›è¡Œæ§åˆ¶ï¼Ÿ

å¯ä»¥å°†æ¥å£åˆ†ä¸º 4 ç§æƒé™ï¼š

1. æœªç™»å½•ä¹Ÿå¯ä»¥ä½¿ç”¨
2. ç™»å½•ç”¨æˆ·æ‰èƒ½ä½¿ç”¨
3. æœªç™»å½•ä¹Ÿå¯ä»¥ä½¿ç”¨ï¼Œä½†æ˜¯ç™»å½•ç”¨æˆ·èƒ½è¿›è¡Œæ›´å¤šæ“ä½œï¼ˆæ¯”å¦‚ç™»å½•åæŸ¥çœ‹å…¨æ–‡ï¼‰
4. ä»…ç®¡ç†å‘˜æ‰èƒ½ä½¿ç”¨

ä¼ ç»Ÿçš„æƒé™æ§åˆ¶æ–¹æ³•æ˜¯ï¼Œåœ¨æ¯ä¸ªæ¥å£å†…å•ç‹¬ç¼–å†™é€»è¾‘ï¼šå…ˆè·å–åˆ°å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯ï¼Œç„¶ååˆ¤æ–­ç”¨æˆ·çš„æƒé™æ˜¯å¦ç¬¦åˆè¦æ±‚ã€‚

è¿™ç§æ–¹æ³•æœ€çµæ´»ï¼Œä½†æ˜¯ä¼šå†™å¾ˆå¤šé‡å¤çš„ä»£ç ï¼Œè€Œä¸”å…¶ä»–å¼€å‘è€…æ— æ³•ä¸€çœ¼å¾—çŸ¥æ¥å£æ‰€éœ€è¦çš„æƒé™ã€‚

æƒé™æ ¡éªŒå…¶å®æ˜¯ä¸€ä¸ªæ¯”è¾ƒé€šç”¨çš„ä¸šåŠ¡éœ€æ±‚ï¼Œä¸€èˆ¬ä¼šé€šè¿‡ **Spring AOP åˆ‡é¢ + è‡ªå®šä¹‰æƒé™æ ¡éªŒæ³¨è§£ **å®ç°ç»Ÿä¸€çš„æ¥å£æ‹¦æˆªå’Œæƒé™æ ¡éªŒï¼›å¦‚æœæœ‰ç‰¹æ®Šçš„æƒé™æ ¡éªŒé€»è¾‘ï¼Œå†å•ç‹¬åœ¨æ¥å£ä¸­ç¼–ç ã€‚

ğŸ’¡ å¦‚æœéœ€è¦æ›´å¤æ‚æ›´çµæ´»çš„æƒé™æ§åˆ¶ï¼Œå¯ä»¥å¼•å…¥ Shiro / Spring Security / Sa-Token ç­‰ä¸“é—¨çš„æƒé™ç®¡ç†æ¡†æ¶ã€‚

------

OKï¼Œæœ‰äº†å®ç°æ–¹æ¡ˆåï¼Œæˆ‘ä»¬å…ˆæ¥å¼€å‘åç«¯æ¥å£ã€‚

## ä¸‰ã€åç«¯å¼€å‘

ä»¥åæ¯æ¬¡å¼€å‘æ¥å£æ—¶ï¼Œéƒ½å¯ä»¥éµå¾ªä»¥ä¸‹æµç¨‹ã€‚

### æ•°æ®è®¿é—®å±‚ä»£ç ç”Ÿæˆ

é¦–å…ˆåˆ©ç”¨ IDEA è¿æ¥ MySQL æ•°æ®åº“ï¼š

![img](./assets/hElBvedKcp6BhFO5.webp)

æ‰§è¡Œ SQL è„šæœ¬ï¼Œåˆ›å»ºæ•°æ®åº“è¡¨ï¼š

![img](./assets/pNIFxBDYjcoa0lGi.webp)

æ•°æ®è®¿é—®å±‚çš„ä»£ç ä¸€èˆ¬åŒ…æ‹¬å®ä½“ç±»ã€MyBatis çš„ Mapper ç±»å’Œ XML ç­‰ã€‚æ¯”èµ·æ‰‹åŠ¨ç¼–å†™ï¼Œå»ºè®®ä½¿ç”¨ MyBatisX ä»£ç ç”Ÿæˆæ’ä»¶ï¼Œå¯ä»¥å¿«é€Ÿå¾—åˆ°è¿™äº›æ–‡ä»¶ã€‚6vlRn/br/m8Ymr8D02hZYIBP3pqlW5Sp8qJklXCk9AY=

é€‰ä¸­æ•°æ®åº“çš„è¡¨ï¼Œå³é”®é€‰æ‹© MybatisX ç”Ÿæˆå™¨ï¼š

![img](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMIAAADDCAYAAADQvc6UAAABRWlDQ1BJQ0MgUHJvZmlsZQAAKJFjYGASSSwoyGFhYGDIzSspCnJ3UoiIjFJgf8LAwSDCIMogwMCcmFxc4BgQ4ANUwgCjUcG3awyMIPqyLsis7PPOq3QdDFcvjV3jOD1boQVTPQrgSkktTgbSf4A4LbmgqISBgTEFyFYuLykAsTuAbJEioKOA7DkgdjqEvQHEToKwj4DVhAQ5A9k3gGyB5IxEoBmML4BsnSQk8XQkNtReEOBxcfXxUQg1Mjc0dyHgXNJBSWpFCYh2zi+oLMpMzyhRcASGUqqCZ16yno6CkYGRAQMDKMwhqj/fAIcloxgHQqxAjIHBEugw5sUIsSQpBobtQPdLciLEVJYzMPBHMDBsayhILEqEO4DxG0txmrERhM29nYGBddr//5/DGRjYNRkY/l7////39v///y4Dmn+LgeHANwDrkl1AuO+pmgAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAwqADAAQAAAABAAAAwwAAAAD9b/HnAAAHlklEQVR4Ae3dP3PTWBSGcbGzM6GCKqlIBRV0dHRJFarQ0eUT8LH4BnRU0NHR0UEFVdIlFRV7TzRksomPY8uykTk/zewQfKw/9znv4yvJynLv4uLiV2dBoDiBf4qP3/ARuCRABEFAoBEgghggQAQZQKAnYEaQBAQaASKIAQJEkAEEegJmBElAoBEgghggQAQZQKAnYEaQBAQaASKIAQJEkAEEegJmBElAoBEgghggQAQZQKAnYEaQBAQaASKIAQJEkAEEegJmBElAoBEgghggQAQZQKAnYEaQBAQaASKIAQJEkAEEegJmBElAoBEgghggQAQZQKAnYEaQBAQaASKIAQJEkAEEegJmBElAoBEgghggQAQZQKAnYEaQBAQaASKIAQJEkAEEegJmBElAoBEgghggQAQZQKAnYEaQBAQaASKIAQJEkAEEegJmBElAoBEgghggQAQZQKAnYEaQBAQaASKIAQJEkAEEegJmBElAoBEgghggQAQZQKAnYEaQBAQaASKIAQJEkAEEegJmBElAoBEgghggQAQZQKAnYEaQBAQaASKIAQJEkAEEegJmBElAoBEgghggQAQZQKAnYEaQBAQaASKIAQJEkAEEegJmBElAoBEgghggQAQZQKAnYEaQBAQaASKIAQJEkAEEegJmBElAoBEgghgg0Aj8i0JO4OzsrPv69Wv+hi2qPHr0qNvf39+iI97soRIh4f3z58/u7du3SXX7Xt7Z2enevHmzfQe+oSN2apSAPj09TSrb+XKI/f379+08+A0cNRE2ANkupk+ACNPvkSPcAAEibACyXUyfABGm3yNHuAECRNgAZLuYPgEirKlHu7u7XdyytGwHAd8jjNyng4OD7vnz51dbPT8/7z58+NB9+/bt6jU/TI+AGWHEnrx48eJ/EsSmHzx40L18+fLyzxF3ZVMjEyDCiEDjMYZZS5wiPXnyZFbJaxMhQIQRGzHvWR7XCyOCXsOmiDAi1HmPMMQjDpbpEiDCiL358eNHurW/5SnWdIBbXiDCiA38/Pnzrce2YyZ4//59F3ePLNMl4PbpiL2J0L979+7yDtHDhw8vtzzvdGnEXdvUigSIsCLAWavHp/+qM0BcXMd/q25n1vF57TYBp0a3mUzilePj4+7k5KSLb6gt6ydAhPUzXnoPR0dHl79WGTNCfBnn1uvSCJdegQhLI1vvCk+fPu2ePXt2tZOYEV6/fn31dz+shwAR1sP1cqvLntbEN9MxA9xcYjsxS1jWR4AIa2Ibzx0tc44fYX/16lV6NDFLXH+YL32jwiACRBiEbf5KcXoTIsQSpzXx4N28Ja4BQoK7rgXiydbHjx/P25TaQAJEGAguWy0+2Q8PD6/Ki4R8EVl+bzBOnZY95fq9rj9zAkTI2SxdidBHqG9+skdw43borCXO/ZcJdraPWdv22uIEiLA4q7nvvCug8WTqzQveOH26fodo7g6uFe/a17W3+nFBAkRYENRdb1vkkz1CH9cPsVy/jrhr27PqMYvENYNlHAIesRiBYwRy0V+8iXP8+/fvX11Mr7L7ECueb/r48eMqm7FuI2BGWDEG8cm+7G3NEOfmdcTQw4h9/55lhm7DekRYKQPZF2ArbXTAyu4kDYB2YxUzwg0gi/41ztHnfQG26HbGel/crVrm7tNY+/1btkOEAZ2M05r4FB7r9GbAIdxaZYrHdOsgJ/wCEQY0J74TmOKnbxxT9n3FgGGWWsVdowHtjt9Nnvf7yQM2aZU/TIAIAxrw6dOnAWtZZcoEnBpNuTuObWMEiLAx1HY0ZQJEmHJ3HNvGCBBhY6jtaMoEiJB0Z29vL6ls58vxPcO8/zfrdo5qvKO+d3Fx8Wu8zf1dW4p/cPzLly/dtv9Ts/EbcvGAHhHyfBIhZ6NSiIBTo0LNNtScABFyNiqFCBChULMNNSdAhJyNSiECRCjUbEPNCRAhZ6NSiAARCjXbUHMCRMjZqBQiQIRCzTbUnAARcjYqhQgQoVCzDTUnQIScjUohAkQo1GxDzQkQIWejUogAEQo121BzAkTI2agUIkCEQs021JwAEXI2KoUIEKFQsw01J0CEnI1KIQJEKNRsQ80JECFno1KIABEKNdtQcwJEyNmoFCJAhELNNtScABFyNiqFCBChULMNNSdAhJyNSiECRCjUbEPNCRAhZ6NSiAARCjXbUHMCRMjZqBQiQIRCzTbUnAARcjYqhQgQoVCzDTUnQIScjUohAkQo1GxDzQkQIWejUogAEQo121BzAkTI2agUIkCEQs021JwAEXI2KoUIEKFQsw01J0CEnI1KIQJEKNRsQ80JECFno1KIABEKNdtQcwJEyNmoFCJAhELNNtScABFyNiqFCBChULMNNSdAhJyNSiECRCjUbEPNCRAhZ6NSiAARCjXbUHMCRMjZqBQiQIRCzTbUnAARcjYqhQgQoVCzDTUnQIScjUohAkQo1GxDzQkQIWejUogAEQo121BzAkTI2agUIkCEQs021JwAEXI2KoUIEKFQsw01J0CEnI1KIQJEKNRsQ80JECFno1KIABEKNdtQcwJEyNmoFCJAhELNNtScABFyNiqFCBChULMNNSdAhJyNSiEC/wGgKKC4YMA4TAAAAABJRU5ErkJggg==)

æŒ‰ç…§ä¸‹å›¾è¿›è¡Œé…ç½®ï¼š

![img](./assets/RKBGNOh3yMe21Hnm.webp)![img](./assets/suvboYmGN7RfYNKk.webp)

å¯ä»¥çœ‹åˆ°ç”Ÿæˆçš„ä»£ç ï¼ŒåŒ…æ‹¬å®ä½“ç±»ã€Mapper![img](./assets/XLQ3q3kz7DGE97hQ.webp)

æˆ‘ä»¬éœ€è¦å°†è¿™äº›ä»£ç ç§»åŠ¨åˆ°é¡¹ç›®å¯¹åº”çš„ä½ç½®ï¼Œæ¯”å¦‚å°† Mapper ç§»åŠ¨åˆ° `mapper` åŒ…ã€User ç§»åŠ¨åˆ° `model.entity` åŒ…ã€Service ç§»åŠ¨åˆ° `service` åŒ…ã€‚è®°å¾—å°†æœ‰ç”¨çš„æ–‡ä»¶æ·»åŠ åˆ° Git è¿›è¡Œæ‰˜ç®¡ã€‚

ç§»åŠ¨ä¹‹åï¼Œæ³¨æ„ä¿®æ”¹ UserMapper.xml ç­‰æ–‡ä»¶çš„åŒ…åï¼š

![img](./assets/GFyTpiYUxwY8ivC1.webp)

### æ•°æ®æ¨¡å‹å¼€å‘

#### 1ã€å®ä½“ç±»

ç”Ÿæˆçš„ä»£ç ä¹Ÿè®¸ä¸èƒ½å®Œå…¨æ»¡è¶³æˆ‘ä»¬çš„è¦æ±‚ï¼Œæ¯”å¦‚æ•°æ®åº“å®ä½“ç±»ï¼Œæˆ‘ä»¬å¯ä»¥æ‰‹åŠ¨æ›´æ”¹å…¶å­—æ®µé…ç½®ï¼ŒæŒ‡å®šä¸»é”®ç­–ç•¥å’Œé€»è¾‘åˆ é™¤ã€‚

1. id é»˜è®¤æ˜¯è¿ç»­ç”Ÿæˆçš„ï¼Œå®¹æ˜“è¢«çˆ¬è™«æŠ“å–ï¼Œæ‰€ä»¥æ›´æ¢ç­–ç•¥ä¸º `ASSIGN_ID` é›ªèŠ±ç®—æ³•ç”Ÿæˆã€‚
2. æ•°æ®åˆ é™¤æ—¶é»˜è®¤ä¸ºå½»åº•åˆ é™¤è®°å½•ï¼Œå¦‚æœå‡ºç°è¯¯åˆ ï¼Œå°†éš¾ä»¥æ¢å¤ï¼Œæ‰€ä»¥é‡‡ç”¨é€»è¾‘åˆ é™¤ â€”â€” é€šè¿‡ä¿®æ”¹ isDelete å­—æ®µä¸º 1 è¡¨ç¤ºå·²å¤±æ•ˆçš„æ•°æ®ã€‚

ä¿®æ”¹çš„ä»£ç å¦‚ä¸‹ï¼š

```java
â–¼@TableName(value ="user")
@Data
public class User implements Serializable {
    /**
     * idï¼ˆè¦æŒ‡å®šä¸»é”®ç­–ç•¥ï¼‰
     */
    @TableId(type = IdType.ASSIGN_ID)
    private Long id;

    // ...
    
    /**
     * æ˜¯å¦åˆ é™¤ï¼ˆé€»è¾‘åˆ é™¤ï¼‰
     */
    @TableLogic
    private Integer isDelete;
}
```

ä½¿ç”¨æ¡†æ¶çš„è¿‡ç¨‹ä¸­ï¼Œæœ‰ä»»ä½•ç–‘é—®ï¼Œéƒ½å¯ä»¥åœ¨å®˜æ–¹æ–‡æ¡£æŸ¥é˜…ï¼Œæ¯”å¦‚äº†è§£ MyBatis Plus çš„ä¸»é”®ç”Ÿæˆæ³¨è§£ï¼šhttps://baomidou.com/reference/annotation/#tableid

#### 2ã€æšä¸¾ç±»

å¯¹äºç”¨æˆ·è§’è‰²è¿™æ ·å€¼çš„æ•°é‡æœ‰é™çš„ã€å¯æšä¸¾çš„å­—æ®µï¼Œæœ€å¥½å®šä¹‰ä¸€ä¸ªæšä¸¾ç±»ï¼Œä¾¿äºåœ¨é¡¹ç›®ä¸­è·å–å€¼ã€å‡å°‘æšä¸¾å€¼è¾“å…¥é”™è¯¯çš„æƒ…å†µã€‚

åœ¨ `model.enums` åŒ…ä¸‹æ–°å»º UserRoleEnumï¼š

```java
@Getter
public enum UserRoleEnum {

    USER("ç”¨æˆ·", "user"),
    ADMIN("ç®¡ç†å‘˜", "admin");

    private final String text;

    private final String value;

    UserRoleEnum(String text, String value) {
        this.text = text;
        this.value = value;
    }

    /**
     * æ ¹æ® value è·å–æšä¸¾
     *
     * @param value æšä¸¾å€¼çš„value
     * @return æšä¸¾å€¼
     */
    public static UserRoleEnum getEnumByValue(String value) {
        if (ObjUtil.isEmpty(value)) {
            return null;
        }
        for (UserRoleEnum anEnum : UserRoleEnum.values()) {
            if (anEnum.value.equals(value)) {
                return anEnum;
            }
        }
        return null;
    }
}
```

å…¶ä¸­ï¼ŒgetEnumByValue æ˜¯é€šè¿‡ value æ‰¾åˆ°å…·ä½“çš„æšä¸¾å¯¹è±¡ã€‚

ğŸ’¡ å¦‚æœæšä¸¾å€¼ç‰¹åˆ«å¤šï¼Œå¯ä»¥ Map ç¼“å­˜æ‰€æœ‰æšä¸¾å€¼æ¥åŠ é€ŸæŸ¥æ‰¾ï¼Œè€Œä¸æ˜¯éå†åˆ—è¡¨ã€‚

------

ä¸‹é¢ä¾æ¬¡è¿›è¡Œå„åŠŸèƒ½æ¥å£çš„å¼€å‘ã€‚

### ç”¨æˆ·æ³¨å†Œ

#### 1ã€æ•°æ®æ¨¡å‹

åœ¨ `model.dto.user` ä¸‹æ–°å»ºç”¨äºæ¥å—è¯·æ±‚å‚æ•°çš„ç±»ï¼š

```java
@Data
public class UserRegisterRequest implements Serializable {

    private static final long serialVersionUID = 3191241716373120793L;

    /**
     * è´¦å·
     */
    private String userAccount;

    /**
     * å¯†ç 
     */
    private String userPassword;

    /**
     * ç¡®è®¤å¯†ç 
     */
    private String checkPassword;
}
```

ğŸ’¡ åœ¨ Java æ¥å£å¼€å‘ä¸­ï¼Œä¸ºæ¯ä¸ªæ¥å£å®šä¹‰ä¸€ä¸ªä¸“é—¨çš„ç±»æ¥æ¥æ”¶è¯·æ±‚å‚æ•°ï¼Œå¯ä»¥æé«˜ä»£ç çš„å¯è¯»æ€§å’Œç»´æŠ¤æ€§ï¼Œä¾¿äºå¯¹å‚æ•°è¿›è¡Œç»Ÿä¸€éªŒè¯å’Œæ‰©å±•ï¼ŒåŒæ—¶å‡å°‘æ¥å£æ–¹æ³•å‚æ•°è¿‡å¤šå¯¼è‡´çš„å¤æ‚æ€§ï¼Œæœ‰åŠ©äºåœ¨å¤æ‚åœºæ™¯ä¸‹æ›´æ¸…æ™°åœ°ç®¡ç†å’Œä¼ é€’æ•°æ®ã€‚

#### 2ã€æœåŠ¡å¼€å‘

åœ¨ `service` åŒ…çš„ UserService ä¸­å¢åŠ æ–¹æ³•å£°æ˜ï¼š

```java
/**
 * ç”¨æˆ·æ³¨å†Œ
 *
 * @param userAccount   ç”¨æˆ·è´¦æˆ·
 * @param userPassword  ç”¨æˆ·å¯†ç 
 * @param checkPassword æ ¡éªŒå¯†ç 
 * @return æ–°ç”¨æˆ· id
 */
long userRegister(String userAccount, String userPassword, String checkPassword);
```

åœ¨ UserServiceImpl ä¸­å¢åŠ å®ç°ä»£ç ï¼Œæ³¨æ„å¤šè¡¥å……ä¸€äº›æ ¡éªŒæ¡ä»¶ï¼š

```java
@Override
public long userRegister(String userAccount, String userPassword, String checkPassword) {
    // 1. æ ¡éªŒ
    if (StrUtil.hasBlank(userAccount, userPassword, checkPassword)) {
        throw new BusinessException(ErrorCode.PARAMS_ERROR, "å‚æ•°ä¸ºç©º");
    }
    if (userAccount.length() < 4) {
        throw new BusinessException(ErrorCode.PARAMS_ERROR, "ç”¨æˆ·è´¦å·è¿‡çŸ­");
    }
    if (userPassword.length() < 8 || checkPassword.length() < 8) {
        throw new BusinessException(ErrorCode.PARAMS_ERROR, "ç”¨æˆ·å¯†ç è¿‡çŸ­");
    }
    if (!userPassword.equals(checkPassword)) {
        throw new BusinessException(ErrorCode.PARAMS_ERROR, "ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´");
    }
    // 2. æ£€æŸ¥æ˜¯å¦é‡å¤
    QueryWrapper<User> queryWrapper = new QueryWrapper<>();
    queryWrapper.eq("userAccount", userAccount);
    long count = this.baseMapper.selectCount(queryWrapper);
    if (count > 0) {
        throw new BusinessException(ErrorCode.PARAMS_ERROR, "è´¦å·é‡å¤");
    }
    // 3. åŠ å¯†
    String encryptPassword = getEncryptPassword(userPassword);
    // 4. æ’å…¥æ•°æ®
    User user = new User();
    user.setUserAccount(userAccount);
    user.setUserPassword(encryptPassword);
    user.setUserName("æ— å");
    user.setUserRole(UserRoleEnum.USER.getValue());
    boolean saveResult = this.save(user);
    if (!saveResult) {
        throw new BusinessException(ErrorCode.SYSTEM_ERROR, "æ³¨å†Œå¤±è´¥ï¼Œæ•°æ®åº“é”™è¯¯");
    }
    return user.getId();
}
```

æ³¨æ„ï¼Œä¸Šè¿°ä»£ç ä¸­ï¼Œæˆ‘ä»¬éœ€è¦å°†ç”¨æˆ·å¯†ç åŠ å¯†åè¿›è¡Œå­˜å‚¨ã€‚å¯ä»¥å°è£…ä¸€ä¸ªæ–¹æ³•ï¼Œä¾¿äºåç»­å¤ç”¨ï¼š

```java
@Override
public String getEncryptPassword(String userPassword) {
    // ç›å€¼ï¼Œæ··æ·†å¯†ç 
    final String SALT = "yupi";
    return DigestUtils.md5DigestAsHex((SALT + userPassword).getBytes());
}
```

#### 3ã€æ¥å£å¼€å‘

åœ¨ `controller` åŒ…ä¸­æ–°å»º UserControllerï¼Œæ–°å¢ç”¨æˆ·æ³¨å†Œæ¥å£ï¼š

```java
@RestController
@RequestMapping("/user")
public class UserController {

    @Resource
    private UserService userService;

    /**
     * ç”¨æˆ·æ³¨å†Œ
     */
    @PostMapping("/register")
    public BaseResponse<Long> userRegister(@RequestBody UserRegisterRequest userRegisterRequest) {
        ThrowUtils.throwIf(userRegisterRequest == null, ErrorCode.PARAMS_ERROR);
        String userAccount = userRegisterRequest.getUserAccount();
        String userPassword = userRegisterRequest.getUserPassword();
        String checkPassword = userRegisterRequest.getCheckPassword();
        long result = userService.userRegister(userAccount, userPassword, checkPassword);
        return ResultUtils.success(result);
    }
}
```

#### 4ã€æµ‹è¯•

æ¯å¼€å‘å®Œä¸€ä¸ªæ¥å£ï¼Œéƒ½å¯ä»¥ä½¿ç”¨ Swagger æ¥å£æ–‡æ¡£æ¥æµ‹è¯•ï¼š

![img](./assets/n4OZJJskiOvyB9Ly.webp)

ğŸ’¡ æµ‹è¯•æ—¶è¦å°¤å…¶æ³¨æ„è¾¹ç•Œå€¼å’Œç‰¹æ®Šå€¼ï¼Œä¸èƒ½åªæµ‹è¯•æ­£å¸¸çš„æƒ…å†µã€‚

### ç”¨æˆ·ç™»å½•

#### 1ã€æ•°æ®æ¨¡å‹

åœ¨ `model.dto.user` ä¸‹æ–°å»ºç”¨äºæ¥å—è¯·æ±‚å‚æ•°çš„ç±»ï¼š

```java
@Data
public class UserLoginRequest implements Serializable {

    private static final long serialVersionUID = 3191241716373120793L;

    /**
     * è´¦å·
     */
    private String userAccount;

    /**
     * å¯†ç 
     */
    private String userPassword;
}
```

#### 2ã€æœåŠ¡å¼€å‘

åœ¨ `service` åŒ…çš„ UserService ä¸­å¢åŠ æ–¹æ³•å£°æ˜ï¼š

```java
/**
 * ç”¨æˆ·ç™»å½•
 *
 * @param userAccount  ç”¨æˆ·è´¦æˆ·
 * @param userPassword ç”¨æˆ·å¯†ç 
 * @param request
 * @return è„±æ•åçš„ç”¨æˆ·ä¿¡æ¯
 */
LoginUserVO userLogin(String userAccount, String userPassword, HttpServletRequest request);
```

åœ¨ UserServiceImpl ä¸­å¢åŠ å®ç°ä»£ç ï¼Œæ³¨æ„å¤šè¡¥å……ä¸€äº›æ ¡éªŒæ¡ä»¶ï¼Œåœ¨ç”¨æˆ·ç™»å½•æˆåŠŸåï¼Œå°†ç”¨æˆ·ä¿¡æ¯å­˜å‚¨åœ¨å½“å‰çš„ Session ä¸­ã€‚ä»£ç å¦‚ä¸‹ï¼š

```java
@Override
public LoginUserVO userLogin(String userAccount, String userPassword, HttpServletRequest request) {
    // 1. æ ¡éªŒ
    if (StrUtil.hasBlank(userAccount, userPassword)) {
        throw new BusinessException(ErrorCode.PARAMS_ERROR, "å‚æ•°ä¸ºç©º");
    }
    if (userAccount.length() < 4) {
        throw new BusinessException(ErrorCode.PARAMS_ERROR, "è´¦å·é”™è¯¯");
    }
    if (userPassword.length() < 8) {
        throw new BusinessException(ErrorCode.PARAMS_ERROR, "å¯†ç é”™è¯¯");
    }
    // 2. åŠ å¯†
    String encryptPassword = getEncryptPassword(userPassword);
    // æŸ¥è¯¢ç”¨æˆ·æ˜¯å¦å­˜åœ¨
    QueryWrapper<User> queryWrapper = new QueryWrapper<>();
    queryWrapper.eq("userAccount", userAccount);
    queryWrapper.eq("userPassword", encryptPassword);
    User user = this.baseMapper.selectOne(queryWrapper);
    // ç”¨æˆ·ä¸å­˜åœ¨
    if (user == null) {
        log.info("user login failed, userAccount cannot match userPassword");
        throw new BusinessException(ErrorCode.PARAMS_ERROR, "ç”¨æˆ·ä¸å­˜åœ¨æˆ–å¯†ç é”™è¯¯");
    }
    // 3. è®°å½•ç”¨æˆ·çš„ç™»å½•æ€
    request.getSession().setAttribute(USER_LOGIN_STATE, user);
    return this.getLoginUserVO(user);
}
```

æ³¨æ„ï¼Œç”±äºæ³¨å†Œç”¨æˆ·æ—¶å­˜å…¥æ•°æ®åº“çš„å¯†ç æ˜¯åŠ å¯†åçš„ï¼ŒæŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯æ—¶ï¼Œä¹Ÿè¦å¯¹ç”¨æˆ·è¾“å…¥çš„å¯†ç è¿›è¡ŒåŒæ ·ç®—æ³•çš„åŠ å¯†ï¼Œæ‰èƒ½è·Ÿæ•°æ®åº“çš„ä¿¡æ¯å¯¹åº”ä¸Šã€‚

å¯ä»¥æŠŠä¸Šè¿°çš„ Session ç†è§£ä¸ºä¸€ä¸ª Mapï¼Œå¯ä»¥ç»™ Map è®¾ç½® key å’Œ valueï¼Œæ¯ä¸ªä¸åŒçš„ SessionID å¯¹åº”çš„ Session å­˜å‚¨éƒ½æ˜¯ä¸åŒçš„ï¼Œä¸ç”¨æ‹…å¿ƒä¼šæ±¡æŸ“ã€‚æ‰€ä»¥ä¸Šè¿°ä»£ç ä¸­ï¼Œç»™ Session è®¾ç½®äº†å›ºå®šçš„ keyï¼ˆUSER_LOGIN_STATEï¼‰ï¼Œå¯ä»¥å°†è¿™ä¸ª key å€¼æå–ä¸ºå¸¸é‡ï¼Œä¾¿äºåç»­è·å–ã€‚

åœ¨ `constant` åŒ…ä¸‹æ–°å»º UserConstant ç±»ï¼Œç»Ÿä¸€å£°æ˜ç”¨æˆ·ç›¸å…³çš„å¸¸é‡ï¼š

```java
public interface UserConstant {

    /**
     * ç”¨æˆ·ç™»å½•æ€é”®
     */
    String USER_LOGIN_STATE = "user_login";

    //  region æƒé™

    /**
     * é»˜è®¤è§’è‰²
     */
    String DEFAULT_ROLE = "user";

    /**
     * ç®¡ç†å‘˜è§’è‰²
     */
    String ADMIN_ROLE = "admin";
    
    // endregion
}
```

#### 3ã€æ¥å£å¼€å‘

åœ¨ UserController ä¸­æ–°å¢ç”¨æˆ·ç™»å½•æ¥å£ï¼š

```java
@PostMapping("/login")
public BaseResponse<LoginUserVO> userLogin(@RequestBody UserLoginRequest userLoginRequest, HttpServletRequest request) {
    ThrowUtils.throwIf(userLoginRequest == null, ErrorCode.PARAMS_ERROR);
    String userAccount = userLoginRequest.getUserAccount();
    String userPassword = userLoginRequest.getUserPassword();
    LoginUserVO loginUserVO = userService.userLogin(userAccount, userPassword, request);
    return ResultUtils.success(loginUserVO);
}
```

### è·å–å½“å‰ç™»å½•ç”¨æˆ·

å¯ä»¥ä» request è¯·æ±‚å¯¹è±¡å¯¹åº”çš„ Session ä¸­ç›´æ¥è·å–åˆ°ä¹‹å‰ä¿å­˜çš„ç™»å½•ç”¨æˆ·ä¿¡æ¯ï¼Œæ— éœ€å…¶ä»–è¯·æ±‚å‚æ•°ã€‚

#### 1ã€æœåŠ¡å¼€å‘

åœ¨ `service` åŒ…çš„ UserService ä¸­å¢åŠ æ–¹æ³•å£°æ˜ï¼š

```java
/**
 * è·å–å½“å‰ç™»å½•ç”¨æˆ·
 *
 * @param request
 * @return
 */
User getLoginUser(HttpServletRequest request);
```

åœ¨ UserServiceImpl ä¸­å¢åŠ å®ç°ä»£ç ï¼Œæ­¤å¤„ä¸ºäº†ä¿è¯è·å–åˆ°çš„æ•°æ®å§‹ç»ˆæ˜¯æœ€æ–°çš„ï¼Œå…ˆä» Session ä¸­è·å–ç™»å½•ç”¨æˆ·çš„ idï¼Œç„¶åä»æ•°æ®åº“ä¸­æŸ¥è¯¢æœ€æ–°çš„ç»“æœã€‚ä»£ç å¦‚ä¸‹ï¼š

```java
@Override
public User getLoginUser(HttpServletRequest request) {
    // å…ˆåˆ¤æ–­æ˜¯å¦å·²ç™»å½•
    Object userObj = request.getSession().getAttribute(USER_LOGIN_STATE);
    User currentUser = (User) userObj;
    if (currentUser == null || currentUser.getId() == null) {
        throw new BusinessException(ErrorCode.NOT_LOGIN_ERROR);
    }
    // ä»æ•°æ®åº“æŸ¥è¯¢ï¼ˆè¿½æ±‚æ€§èƒ½çš„è¯å¯ä»¥æ³¨é‡Šï¼Œç›´æ¥è¿”å›ä¸Šè¿°ç»“æœï¼‰
    long userId = currentUser.getId();
    currentUser = this.getById(userId);
    if (currentUser == null) {
        throw new BusinessException(ErrorCode.NOT_LOGIN_ERROR);
    }
    return currentUser;
}
```

#### 2ã€æ¥å£å¼€å‘

åœ¨ UserController ä¸­æ–°å¢è·å–å½“å‰ç™»å½•ç”¨æˆ·æ¥å£ï¼š

```java
@GetMapping("/get/login")
public BaseResponse<LoginUserVO> getLoginUser(HttpServletRequest request) {
    User loginUser = userService.getLoginUser(request);
    return ResultUtils.success(userService.getLoginUserVO(loginUser));
}
```

æ³¨æ„ï¼Œä¸Šè¿°ä»£ç æ˜¯ç›´æ¥å°†æ•°æ®åº“æŸ¥åˆ°çš„æ‰€æœ‰ä¿¡æ¯éƒ½è¿”å›ç»™äº†å‰ç«¯ï¼ˆåŒ…æ‹¬å¯†ç ï¼‰ï¼Œå¯èƒ½å­˜åœ¨ä¿¡æ¯æ³„éœ²çš„å®‰å…¨é£é™©ã€‚å› æ­¤ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å¯¹è¿”å›ç»“æœè¿›è¡Œè„±æ•å¤„ç†ã€‚

#### 3ã€æ•°æ®è„±æ•

åœ¨ `model.vo` åŒ…ä¸‹æ–°å»º `LoginUserVO` ç±»ï¼Œè¡¨ç¤ºè„±æ•åçš„ç™»å½•ç”¨æˆ·ä¿¡æ¯ï¼š

```java
@Data
public class LoginUserVO implements Serializable {

    /**
     * ç”¨æˆ· id
     */
    private Long id;

    /**
     * è´¦å·
     */
    private String userAccount;

    /**
     * ç”¨æˆ·æ˜µç§°
     */
    private String userName;

    /**
     * ç”¨æˆ·å¤´åƒ
     */
    private String userAvatar;

    /**
     * ç”¨æˆ·ç®€ä»‹
     */
    private String userProfile;

    /**
     * ç”¨æˆ·è§’è‰²ï¼šuser/admin
     */
    private String userRole;

    /**
     * åˆ›å»ºæ—¶é—´
     */
    private Date createTime;

    /**
     * æ›´æ–°æ—¶é—´
     */
    private Date updateTime;

    private static final long serialVersionUID = 1L;
}
```

åœ¨ UserService ä¸­æ–°å¢è·å–è„±æ•åçš„å·²ç™»å½•ç”¨æˆ·ä¿¡æ¯æ–¹æ³•ï¼šqHT6Kxg12X1vklSWA3QVO0Z9aqth3Yj5Z1UQTagntCA=

```java
/**
 * è·å–è„±æ•çš„å·²ç™»å½•ç”¨æˆ·ä¿¡æ¯
 *
 * @return
 */
LoginUserVO getLoginUserVO(User user);
```

ç¼–å†™æ–¹æ³•å¯¹åº”çš„å®ç°ç±»ï¼Œå…¶å®å°±æ˜¯å°† User ç±»çš„å±æ€§å¤åˆ¶åˆ° LoginUserVO ä¸­ï¼Œä¸å­˜åœ¨çš„å­—æ®µå°±è¢«è¿‡æ»¤æ‰äº†ï¼š

```java
@Override
public LoginUserVO getLoginUserVO(User user) {
    if (user == null) {
        return null;
    }
    LoginUserVO loginUserVO = new LoginUserVO();
    BeanUtils.copyProperties(user, loginUserVO);
    return loginUserVO;
}
```

ä¿®æ”¹ Controller çš„ getLoginUser æ¥å£ï¼Œæ”¹ä¸ºè¿”å›è„±æ•åçš„ç”¨æˆ·ä¿¡æ¯ï¼š

```java
@GetMapping("/get/login")
public BaseResponse<LoginUserVO> getLoginUser(HttpServletRequest request) {
    User user = userService.getLoginUser(request);
    return ResultUtils.success(userService.getLoginUserVO(user));
}
```

### ç”¨æˆ·æ³¨é”€

å¯ä»¥ä» request è¯·æ±‚å¯¹è±¡å¯¹åº”çš„ Session ä¸­ç›´æ¥è·å–åˆ°ä¹‹å‰ä¿å­˜çš„ç™»å½•ç”¨æˆ·ä¿¡æ¯ï¼Œæ¥å®Œæˆæ³¨é”€ï¼Œæ— éœ€å…¶ä»–è¯·æ±‚å‚æ•°ã€‚

#### 1ã€æœåŠ¡å¼€å‘

åœ¨ `service` åŒ…çš„ UserService ä¸­å¢åŠ æ–¹æ³•å£°æ˜ï¼š

```java
/**
 * ç”¨æˆ·æ³¨é”€
 *
 * @param request
 * @return
 */
boolean userLogout(HttpServletRequest request);
```

åœ¨ UserServiceImpl ä¸­å¢åŠ å®ç°ä»£ç ï¼Œä» Session ä¸­ç§»é™¤æ‰å½“å‰ç”¨æˆ·çš„ç™»å½•æ€å³å¯ï¼š

```java
@Override
public boolean userLogout(HttpServletRequest request) {
    // å…ˆåˆ¤æ–­æ˜¯å¦å·²ç™»å½•
    Object userObj = request.getSession().getAttribute(USER_LOGIN_STATE);
    if (userObj == null) {
        throw new BusinessException(ErrorCode.OPERATION_ERROR, "æœªç™»å½•");
    }
    // ç§»é™¤ç™»å½•æ€
    request.getSession().removeAttribute(USER_LOGIN_STATE);
    return true;
}
```

#### 2ã€æ¥å£å¼€å‘

åœ¨ UserController ä¸­æ–°å¢ç”¨æˆ·æ³¨é”€æ¥å£ï¼š

```java
@PostMapping("/logout")
public BaseResponse<Boolean> userLogout(HttpServletRequest request) {
    ThrowUtils.throwIf(request == null, ErrorCode.PARAMS_ERROR);
    boolean result = userService.userLogout(request);
    return ResultUtils.success(result);
}
```

### ç”¨æˆ·æƒé™æ§åˆ¶

åœ¨æœ¬èŠ‚æ•™ç¨‹çš„æ–¹æ¡ˆè®¾è®¡ä¸­è®²åˆ°ï¼šæƒé™æ ¡éªŒå…¶å®æ˜¯ä¸€ä¸ªæ¯”è¾ƒé€šç”¨çš„ä¸šåŠ¡éœ€æ±‚ï¼Œä¸€èˆ¬ä¼šé€šè¿‡ **Spring AOP åˆ‡é¢ + è‡ªå®šä¹‰æƒé™æ ¡éªŒæ³¨è§£ **å®ç°ç»Ÿä¸€çš„æ¥å£æ‹¦æˆªå’Œæƒé™æ ¡éªŒï¼›å¦‚æœæœ‰ç‰¹æ®Šçš„æƒé™æ ¡éªŒé€»è¾‘ï¼Œå†å•ç‹¬åœ¨æ¥å£ä¸­ç¼–ç ã€‚

#### 1ã€æƒé™æ ¡éªŒæ³¨è§£

é¦–å…ˆç¼–å†™æƒé™æ ¡éªŒæ³¨è§£ï¼Œæ”¾åˆ° `annotation` åŒ…ä¸‹ï¼š

```java
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface AuthCheck {

    /**
     * å¿…é¡»æœ‰æŸä¸ªè§’è‰²
     */
    String mustRole() default "";
}
```

#### 2ã€æƒé™æ ¡éªŒåˆ‡é¢

ç¼–å†™æƒé™æ ¡éªŒ AOPï¼Œé‡‡ç”¨ç¯ç»•é€šçŸ¥ï¼Œåœ¨ **æ‰“ä¸Šè¯¥æ³¨è§£çš„æ–¹æ³• **æ‰§è¡Œå‰åè¿›è¡Œä¸€äº›é¢å¤–çš„æ“ä½œï¼Œæ¯”å¦‚æ ¡éªŒæƒé™ã€‚

ä»£ç å¦‚ä¸‹ï¼Œæ”¾åˆ° `aop` åŒ…ä¸‹ï¼š

```java
@Aspect
@Component
public class AuthInterceptor {

    @Resource
    private UserService userService;

    /**
     * æ‰§è¡Œæ‹¦æˆª
     *
     * @param joinPoint åˆ‡å…¥ç‚¹
     * @param authCheck æƒé™æ ¡éªŒæ³¨è§£
     */
    @Around("@annotation(authCheck)")
    public Object doInterceptor(ProceedingJoinPoint joinPoint, AuthCheck authCheck) throws Throwable {
        String mustRole = authCheck.mustRole();
        RequestAttributes requestAttributes = RequestContextHolder.currentRequestAttributes();
        HttpServletRequest request = ((ServletRequestAttributes) requestAttributes).getRequest();
        // å½“å‰ç™»å½•ç”¨æˆ·
        User loginUser = userService.getLoginUser(request);
        UserRoleEnum mustRoleEnum = UserRoleEnum.getEnumByValue(mustRole);
        // ä¸éœ€è¦æƒé™ï¼Œæ”¾è¡Œ
        if (mustRoleEnum == null) {
            return joinPoint.proceed();
        }
        // ä»¥ä¸‹ä¸ºï¼šå¿…é¡»æœ‰è¯¥æƒé™æ‰é€šè¿‡
        // è·å–å½“å‰ç”¨æˆ·å…·æœ‰çš„æƒé™
        UserRoleEnum userRoleEnum = UserRoleEnum.getEnumByValue(loginUser.getUserRole());
        // æ²¡æœ‰æƒé™ï¼Œæ‹’ç»
        if (userRoleEnum == null) {
            throw new BusinessException(ErrorCode.NO_AUTH_ERROR);
        }
        // è¦æ±‚å¿…é¡»æœ‰ç®¡ç†å‘˜æƒé™ï¼Œä½†ç”¨æˆ·æ²¡æœ‰ç®¡ç†å‘˜æƒé™ï¼Œæ‹’ç»
        if (UserRoleEnum.ADMIN.equals(mustRoleEnum) && !UserRoleEnum.ADMIN.equals(userRoleEnum)) {
            throw new BusinessException(ErrorCode.NO_AUTH_ERROR);
        }
        // é€šè¿‡æƒé™æ ¡éªŒï¼Œæ”¾è¡Œ
        return joinPoint.proceed();
    }
}
```

#### 3ã€ä½¿ç”¨æ³¨è§£

åªè¦ç»™æ–¹æ³•æ·»åŠ äº† @AuthCheck æ³¨è§£ï¼Œå°±å¿…é¡»è¦ç™»å½•ï¼Œå¦åˆ™ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚

å¯ä»¥è®¾ç½® mustRole ä¸ºç®¡ç†å‘˜ï¼Œè¿™æ ·ä»…ç®¡ç†å‘˜æ‰èƒ½ä½¿ç”¨è¯¥æ¥å£ï¼š

```java
@AuthCheck(mustRole = UserConstant.ADMIN_ROLE)
```

å¯¹äºä¸éœ€è¦ç™»å½•å°±èƒ½ä½¿ç”¨çš„æ¥å£ï¼Œä¸éœ€è¦ä½¿ç”¨è¯¥æ³¨è§£ã€‚

### ç”¨æˆ·ç®¡ç†

ç”¨æˆ·ç®¡ç†åŠŸèƒ½å…·ä½“å¯ä»¥æ‹†åˆ†ä¸ºï¼š

- ã€ç®¡ç†å‘˜ã€‘åˆ›å»ºç”¨æˆ·
- ã€ç®¡ç†å‘˜ã€‘æ ¹æ® id åˆ é™¤ç”¨æˆ·
- ã€ç®¡ç†å‘˜ã€‘æ›´æ–°ç”¨æˆ·
- ã€ç®¡ç†å‘˜ã€‘åˆ†é¡µè·å–ç”¨æˆ·åˆ—è¡¨ï¼ˆéœ€è¦è„±æ•ï¼‰
- ã€ç®¡ç†å‘˜ã€‘æ ¹æ® id è·å–ç”¨æˆ·ï¼ˆæœªè„±æ•ï¼‰
- æ ¹æ® id è·å–ç”¨æˆ·ï¼ˆè„±æ•ï¼‰

#### 1ã€æ•°æ®æ¨¡å‹

1ï¼‰æ¯ä¸ªæ“ä½œéƒ½éœ€è¦æä¾›ä¸€ä¸ªè¯·æ±‚ç±»ï¼Œéƒ½æ”¾åœ¨ `dto.user` åŒ…ä¸‹ã€‚

![img](./assets/VrMvMbj2tUwssOzR.webp)

ç”¨æˆ·åˆ›å»ºè¯·æ±‚ï¼š

```java
@Data
public class UserAddRequest implements Serializable {

    /**
     * ç”¨æˆ·æ˜µç§°
     */
    private String userName;

    /**
     * è´¦å·
     */
    private String userAccount;

    /**
     * ç”¨æˆ·å¤´åƒ
     */
    private String userAvatar;

    /**
     * ç”¨æˆ·ç®€ä»‹
     */
    private String userProfile;

    /**
     * ç”¨æˆ·è§’è‰²: user, admin
     */
    private String userRole;

    private static final long serialVersionUID = 1L;
}
```

ç”¨æˆ·æ›´æ–°è¯·æ±‚ï¼š

```java
@Data
public class UserUpdateRequest implements Serializable {

    /**
     * id
     */
    private Long id;

    /**
     * ç”¨æˆ·æ˜µç§°
     */
    private String userName;

    /**
     * ç”¨æˆ·å¤´åƒ
     */
    private String userAvatar;

    /**
     * ç®€ä»‹
     */
    private String userProfile;

    /**
     * ç”¨æˆ·è§’è‰²ï¼šuser/admin
     */
    private String userRole;

    private static final long serialVersionUID = 1L;
}
```

ç”¨æˆ·æŸ¥è¯¢è¯·æ±‚ï¼Œéœ€è¦ç»§æ‰¿å…¬å…±åŒ…ä¸­çš„ `PageRequest` æ¥æ”¯æŒåˆ†é¡µæŸ¥è¯¢ï¼š

```java
@EqualsAndHashCode(callSuper = true)
@Data
public class UserQueryRequest extends PageRequest implements Serializable {

    /**
     * id
     */
    private Long id;

    /**
     * ç”¨æˆ·æ˜µç§°
     */
    private String userName;

    /**
     * è´¦å·
     */
    private String userAccount;

    /**
     * ç®€ä»‹
     */
    private String userProfile;

    /**
     * ç”¨æˆ·è§’è‰²ï¼šuser/admin/ban
     */
    private String userRole;

    private static final long serialVersionUID = 1L;
}
```

2ï¼‰ç”±äºè¦æä¾›è·å–ç”¨æˆ·ä¿¡æ¯çš„æ¥å£ï¼Œéœ€è¦å’Œè·å–å½“å‰ç™»å½•ç”¨æˆ·æ¥å£ä¸€æ ·å¯¹ç”¨æˆ·ä¿¡æ¯è¿›è¡Œè„±æ•ã€‚6vlRn/br/m8Ymr8D02hZYIBP3pqlW5Sp8qJklXCk9AY=

åœ¨ `model.vo` åŒ…ä¸‹æ–°å»º UserVOï¼Œè¡¨ç¤ºè„±æ•åçš„ç”¨æˆ·ï¼š

```java
@Data
public class UserVO implements Serializable {

    /**
     * id
     */
    private Long id;
    
    /**
     * è´¦å·
     */
    private String userAccount;

    /**
     * ç”¨æˆ·æ˜µç§°
     */
    private String userName;

    /**
     * ç”¨æˆ·å¤´åƒ
     */
    private String userAvatar;

    /**
     * ç”¨æˆ·ç®€ä»‹
     */
    private String userProfile;

    /**
     * ç”¨æˆ·è§’è‰²ï¼šuser/admin
     */
    private String userRole;

    /**
     * åˆ›å»ºæ—¶é—´
     */
    private Date createTime;

    private static final long serialVersionUID = 1L;
}
```

#### 2ã€æœåŠ¡å¼€å‘

1ï¼‰åœ¨ UserService ä¸­ç¼–å†™è·å–è„±æ•åçš„å•ä¸ªç”¨æˆ·ä¿¡æ¯ã€è·å–è„±æ•åçš„ç”¨æˆ·åˆ—è¡¨æ–¹æ³•ï¼š

```java
@Override
public UserVO getUserVO(User user) {
    if (user == null) {
        return null;
    }
    UserVO userVO = new UserVO();
    BeanUtils.copyProperties(user, userVO);
    return userVO;
}

@Override
public List<UserVO> getUserVOList(List<User> userList) {
    if (CollUtil.isEmpty(userList)) {
        return new ArrayList<>();
    }
    return userList.stream().map(this::getUserVO).collect(Collectors.toList());
}
```

2ï¼‰é™¤äº†ä¸Šè¿°æ–¹æ³•å¤–ï¼Œå¯¹äºåˆ†é¡µæŸ¥è¯¢æ¥å£ï¼Œéœ€è¦æ ¹æ®ç”¨æˆ·ä¼ å…¥çš„å‚æ•°æ¥æ„é€  SQL æŸ¥è¯¢ã€‚ç”±äºä½¿ç”¨ MyBatis Plus æ¡†æ¶ï¼Œä¸ç”¨è‡ªå·±æ‹¼æ¥ SQL äº†ï¼Œè€Œæ˜¯é€šè¿‡æ„é€  QueryWrapper å¯¹è±¡æ¥ç”Ÿæˆ SQL æŸ¥è¯¢ã€‚/MBNmaRtUhzDE9b4tB/jsqs1ClvvhzK+S4KVLPihc/I=

å¯ä»¥åœ¨ UserService ä¸­ç¼–å†™ä¸€ä¸ªæ–¹æ³•ï¼Œä¸“é—¨ç”¨äºå°†æŸ¥è¯¢è¯·æ±‚è½¬ä¸º QueryWrapper å¯¹è±¡ï¼š

```java
@Override
public QueryWrapper<User> getQueryWrapper(UserQueryRequest userQueryRequest) {
    if (userQueryRequest == null) {
        throw new BusinessException(ErrorCode.PARAMS_ERROR, "è¯·æ±‚å‚æ•°ä¸ºç©º");
    }
    Long id = userQueryRequest.getId();
    String userAccount = userQueryRequest.getUserAccount();
    String userName = userQueryRequest.getUserName();
    String userProfile = userQueryRequest.getUserProfile();
    String userRole = userQueryRequest.getUserRole();
    String sortField = userQueryRequest.getSortField();
    String sortOrder = userQueryRequest.getSortOrder();
    QueryWrapper<User> queryWrapper = new QueryWrapper<>();
    queryWrapper.eq(ObjUtil.isNotNull(id), "id", id);
    queryWrapper.eq(StrUtil.isNotBlank(userRole), "userRole", userRole);
    queryWrapper.like(StrUtil.isNotBlank(userAccount), "userAccount", userAccount);
    queryWrapper.like(StrUtil.isNotBlank(userName), "userName", userName);
    queryWrapper.like(StrUtil.isNotBlank(userProfile), "userProfile", userProfile);
    queryWrapper.orderBy(StrUtil.isNotEmpty(sortField), sortOrder.equals("ascend"), sortField);
    return queryWrapper;
}
```

#### 3ã€æ¥å£å¼€å‘

ä¸Šè¿°åŠŸèƒ½å…¶å®éƒ½æ˜¯æ ·æ¿ä»£ç ï¼Œä¿—ç§° â€œå¢åˆ æ”¹æŸ¥â€ã€‚

ä»£ç å®ç°æ¯”è¾ƒç®€å•ï¼Œæ³¨æ„æ·»åŠ å¯¹åº”çš„æƒé™æ³¨è§£ã€åšå¥½å‚æ•°æ ¡éªŒå³å¯ï¼š

```java
/**
 * åˆ›å»ºç”¨æˆ·
 */
@PostMapping("/add")
@AuthCheck(mustRole = UserConstant.ADMIN_ROLE)
public BaseResponse<Long> addUser(@RequestBody UserAddRequest userAddRequest) {
    ThrowUtils.throwIf(userAddRequest == null, ErrorCode.PARAMS_ERROR);
    User user = new User();
    BeanUtils.copyProperties(userAddRequest, user);
    // é»˜è®¤å¯†ç  12345678
    final String DEFAULT_PASSWORD = "12345678";
    String encryptPassword = userService.getEncryptPassword(DEFAULT_PASSWORD);
    user.setUserPassword(encryptPassword);
    boolean result = userService.save(user);
    ThrowUtils.throwIf(!result, ErrorCode.OPERATION_ERROR);
    return ResultUtils.success(user.getId());
}

/**
 * æ ¹æ® id è·å–ç”¨æˆ·ï¼ˆä»…ç®¡ç†å‘˜ï¼‰
 */
@GetMapping("/get")
@AuthCheck(mustRole = UserConstant.ADMIN_ROLE)
public BaseResponse<User> getUserById(long id) {
    ThrowUtils.throwIf(id <= 0, ErrorCode.PARAMS_ERROR);
    User user = userService.getById(id);
    ThrowUtils.throwIf(user == null, ErrorCode.NOT_FOUND_ERROR);
    return ResultUtils.success(user);
}

/**
 * æ ¹æ® id è·å–åŒ…è£…ç±»
 */
@GetMapping("/get/vo")
public BaseResponse<UserVO> getUserVOById(long id) {
    BaseResponse<User> response = getUserById(id);
    User user = response.getData();
    return ResultUtils.success(userService.getUserVO(user));
}

/**
 * åˆ é™¤ç”¨æˆ·
 */
@PostMapping("/delete")
@AuthCheck(mustRole = UserConstant.ADMIN_ROLE)
public BaseResponse<Boolean> deleteUser(@RequestBody DeleteRequest deleteRequest) {
    if (deleteRequest == null || deleteRequest.getId() <= 0) {
        throw new BusinessException(ErrorCode.PARAMS_ERROR);
    }
    boolean b = userService.removeById(deleteRequest.getId());
    return ResultUtils.success(b);
}

/**
 * æ›´æ–°ç”¨æˆ·
 */
@PostMapping("/update")
@AuthCheck(mustRole = UserConstant.ADMIN_ROLE)
public BaseResponse<Boolean> updateUser(@RequestBody UserUpdateRequest userUpdateRequest) {
    if (userUpdateRequest == null || userUpdateRequest.getId() == null) {
        throw new BusinessException(ErrorCode.PARAMS_ERROR);
    }
    User user = new User();
    BeanUtils.copyProperties(userUpdateRequest, user);
    boolean result = userService.updateById(user);
    ThrowUtils.throwIf(!result, ErrorCode.OPERATION_ERROR);
    return ResultUtils.success(true);
}

/**
 * åˆ†é¡µè·å–ç”¨æˆ·å°è£…åˆ—è¡¨ï¼ˆä»…ç®¡ç†å‘˜ï¼‰
 *
 * @param userQueryRequest æŸ¥è¯¢è¯·æ±‚å‚æ•°
 */
@PostMapping("/list/page/vo")
@AuthCheck(mustRole = UserConstant.ADMIN_ROLE)
public BaseResponse<Page<UserVO>> listUserVOByPage(@RequestBody UserQueryRequest userQueryRequest) {
    ThrowUtils.throwIf(userQueryRequest == null, ErrorCode.PARAMS_ERROR);
    long current = userQueryRequest.getCurrent();
    long pageSize = userQueryRequest.getPageSize();
    Page<User> userPage = userService.page(new Page<>(current, pageSize),
            userService.getQueryWrapper(userQueryRequest));
    Page<UserVO> userVOPage = new Page<>(current, pageSize, userPage.getTotal());
    List<UserVO> userVOList = userService.getUserVOList(userPage.getRecords());
    userVOPage.setRecords(userVOList);
    return ResultUtils.success(userVOPage);
}
```

ğŸ’¡ æœ‰åŒå­¦å¯èƒ½ä¼šæœ‰ç–‘æƒ‘ï¼šä¸æ˜¯è¯´ä¸è¦åœ¨ Controller ä¸­å†™ä¸šåŠ¡é€»è¾‘ä»£ç ä¹ˆï¼Ÿ

æˆ‘çš„å»ºè®®æ˜¯å¼€å‘æ—¶è¦çµæ´»ä¸€äº›ï¼Œæˆ‘ä»¬è¦ä¿è¯ Controller çš„ç²¾ç®€æ²¡é”™ï¼Œä½†ä¸ä»£è¡¨ä»€ä¹ˆä»£ç éƒ½ä¸åœ¨ Controller é‡Œå†™ã€‚å¯¹äºæˆ‘ä»¬ä¸Šè¿°çš„ä»£ç ï¼Œæ ¹æœ¬å°±æ²¡æœ‰å¤æ‚çš„ä¸šåŠ¡é€»è¾‘ï¼Œå¦‚æœéè¦æŠ½ä¸€å±‚ Service æ–¹æ³•ä¹Ÿä¸æ˜¯ä¸è¡Œï¼Œä½†ä¼šæ›´éº»çƒ¦ä¸€äº›ã€‚

#### 4ã€åˆ†é¡µåŠŸèƒ½ä¿®å¤

ä½¿ç”¨ Swagger æ¥å£æ–‡æ¡£ä¾æ¬¡å¯¹ä¸Šè¿°æ¥å£è¿›è¡Œæµ‹è¯•ï¼Œå‘ç° listUserVOByPage æ¥å£æœ‰ä¸€äº›é—®é¢˜ï¼

åˆ†é¡µå¥½åƒæ²¡æœ‰ç”Ÿæ•ˆï¼Œè¿˜æ˜¯æŸ¥å‡ºäº†å…¨éƒ¨æ•°æ®ï¼š

![img](./assets/vBDbyN26BpYczr0c.webp)

ç”±äºæˆ‘ä»¬ç”¨çš„æ˜¯ MyBatis Plus æ¥æ“ä½œæ•°æ®åº“ï¼Œæ‰€ä»¥éœ€è¦é€šè¿‡ [å®˜æ–¹æ–‡æ¡£](https://baomidou.com/plugins/pagination/) æ¥æŸ¥è¯¢è§£å†³æ–¹æ¡ˆã€‚

æŸ¥é˜…åå‘ç°ï¼ŒåŸæ¥å¿…é¡»è¦é…ç½®ä¸€ä¸ªåˆ†é¡µæ’ä»¶ã€‚**å¿…é¡»è¦æ³¨æ„ï¼Œæœ¬é¡¹ç›®ä½¿ç”¨çš„ v3.5.9 ç‰ˆæœ¬å¼•å…¥åˆ†é¡µæ’ä»¶çš„æ–¹å¼å’Œä¹‹å‰ä¸åŒï¼v3.5.9 ç‰ˆæœ¬åéœ€è¦ç‹¬ç«‹å®‰è£…åˆ†é¡µæ’ä»¶ä¾èµ–ï¼ï¼ï¼**

![img](./assets/orvnNMAa8xXIzKOG.webp)

åœ¨ pom.xml ä¸­å¼•å…¥åˆ†é¡µæ’ä»¶ä¾èµ–ï¼š

```xml
<!-- MyBatis Plus åˆ†é¡µæ’ä»¶ -->
<dependency>
    <groupId>com.baomidou</groupId>
    <artifactId>mybatis-plus-jsqlparser-4.9</artifactId>
</dependency>
```

å…‰å¼•å…¥è¿™ä¸€æ¡ï¼Œå¤§æ¦‚ç‡æ˜¯æ— æ³•æˆåŠŸä¸‹è½½ä¾èµ–çš„ï¼Œè¿˜è¦åœ¨ pom.xml çš„ä¾èµ–ç®¡ç†é…ç½®ä¸­è¡¥å…… `mybatis-plus-bom`ï¼š

```xml
<dependencyManagement>
    <dependencies>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-dependencies</artifactId>
            <version>${spring-boot.version}</version>
            <type>pom</type>
            <scope>import</scope>
        </dependency>
        <dependency>
            <groupId>com.baomidou</groupId>
            <artifactId>mybatis-plus-bom</artifactId>
            <version>3.5.9</version>
            <type>pom</type>
            <scope>import</scope>
        </dependency>
    </dependencies>
</dependencyManagement>
```

ä¾èµ–ä¸‹è½½æˆåŠŸåï¼Œåœ¨ `config` åŒ…ä¸‹æ–°å»º MyBatis Plus æ‹¦æˆªå™¨é…ç½®ï¼Œæ·»åŠ åˆ†é¡µæ’ä»¶ï¼š

```java
@Configuration
@MapperScan("com.yupi.yupicturebackend.mapper")
public class MyBatisPlusConfig {

    /**
     * æ‹¦æˆªå™¨é…ç½®
     *
     * @return {@link MybatisPlusInterceptor}
     */
    @Bean
    public MybatisPlusInterceptor mybatisPlusInterceptor() {
        MybatisPlusInterceptor interceptor = new MybatisPlusInterceptor();
        // åˆ†é¡µæ’ä»¶
        interceptor.addInnerInterceptor(new PaginationInnerInterceptor(DbType.MYSQL));
        return interceptor;
    }
}
```

é‡å¯é¡¹ç›®ï¼Œè¿™æ¬¡å°±èƒ½æ­£å¸¸å®Œæˆåˆ†é¡µäº†~

#### 5ã€æ•°æ®ç²¾åº¦ä¿®å¤

ä½†æ˜¯ï¼Œåœ¨æµ‹è¯•ä¸­ï¼Œå¦‚æœä½ æ‰“å¼€ F12 æ§åˆ¶å°ï¼Œåˆ©ç”¨é¢„è§ˆæ¥æŸ¥çœ‹å“åº”æ•°æ®ï¼Œå°±ä¼šå‘ç°å¦ä¸€ä¸ªé—®é¢˜ï¼šid çš„æœ€åä¸¤ä½å¥½åƒéƒ½å˜æˆ 0 äº†ï¼6vlRn/br/m8Ymr8D02hZYIBP3pqlW5Sp8qJklXCk9AY=

![img](./assets/WeAd1XjAm58WdIGt.webp)

ä½†æ˜¯åœ¨å“åº”ä¸­ã€ä»¥åŠ Swagger ä¸­æŸ¥çœ‹ï¼Œå´æ˜¯æ­£å¸¸çš„ï¼š

![img](./assets/AxV74Rqu2JNg3GMC.webp)

è¿™æ˜¯ç”±äºå‰ç«¯ JS çš„ç²¾åº¦èŒƒå›´æœ‰é™ï¼Œæˆ‘ä»¬åç«¯è¿”å›çš„ id èŒƒå›´è¿‡å¤§ï¼Œå¯¼è‡´å‰ç«¯ç²¾åº¦ä¸¢å¤±ï¼Œä¼šå½±å“å‰ç«¯é¡µé¢è·å–åˆ°çš„æ•°æ®ç»“æœã€‚

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå¯ä»¥åœ¨åç«¯ `config` åŒ…ä¸‹æ–°å»ºä¸€ä¸ªå…¨å±€ JSON é…ç½®ï¼Œå°†æ•´ä¸ªåç«¯ Spring MVC æ¥å£è¿”å›å€¼çš„é•¿æ•´å‹æ•°å­—è½¬æ¢ä¸ºå­—ç¬¦ä¸²è¿›è¡Œè¿”å›ï¼Œä»è€Œé›†ä¸­è§£å†³é—®é¢˜ã€‚

```java
/**
 * Spring MVC Json é…ç½®
 */
@JsonComponent
public class JsonConfig {

    /**
     * æ·»åŠ  Long è½¬ json ç²¾åº¦ä¸¢å¤±çš„é…ç½®
     */
    @Bean
    public ObjectMapper jacksonObjectMapper(Jackson2ObjectMapperBuilder builder) {
        ObjectMapper objectMapper = builder.createXmlMapper(false).build();
        SimpleModule module = new SimpleModule();
        module.addSerializer(Long.class, ToStringSerializer.instance);
        module.addSerializer(Long.TYPE, ToStringSerializer.instance);
        objectMapper.registerModule(module);
        return objectMapper;
    }
}
```

é‡å¯é¡¹ç›®è¿›è¡Œæµ‹è¯•ï¼Œè¿™æ¬¡çœ‹åˆ°çš„ id å€¼å°±æ­£å¸¸äº†ï¼š

![img](./assets/BcMmyLnbxRWiT0VT.webp)

è‡³æ­¤ï¼Œç”¨æˆ·ç›¸å…³çš„åç«¯æ¥å£å¼€å‘å®Œæ¯•ï¼Œå¤§å®¶å¯ä»¥æŒ‰éœ€å®Œå–„ä¸Šè¿°ä»£ç ã€‚

## å››ã€å‰ç«¯å¼€å‘

### æ–°å»ºé¡µé¢å’Œè·¯ç”±

æŒ‰ç…§ä¸‹å›¾çš„ç»“æ„æ–°å»ºé¡µé¢æ–‡ä»¶ï¼š

![img](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMIAAADDCAYAAADQvc6UAAABRWlDQ1BJQ0MgUHJvZmlsZQAAKJFjYGASSSwoyGFhYGDIzSspCnJ3UoiIjFJgf8LAwSDCIMogwMCcmFxc4BgQ4ANUwgCjUcG3awyMIPqyLsis7PPOq3QdDFcvjV3jOD1boQVTPQrgSkktTgbSf4A4LbmgqISBgTEFyFYuLykAsTuAbJEioKOA7DkgdjqEvQHEToKwj4DVhAQ5A9k3gGyB5IxEoBmML4BsnSQk8XQkNtReEOBxcfXxUQg1Mjc0dyHgXNJBSWpFCYh2zi+oLMpMzyhRcASGUqqCZ16yno6CkYGRAQMDKMwhqj/fAIcloxgHQqxAjIHBEugw5sUIsSQpBobtQPdLciLEVJYzMPBHMDBsayhILEqEO4DxG0txmrERhM29nYGBddr//5/DGRjYNRkY/l7////39v///y4Dmn+LgeHANwDrkl1AuO+pmgAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAwqADAAQAAAABAAAAwwAAAAD9b/HnAAAHlklEQVR4Ae3dP3PTWBSGcbGzM6GCKqlIBRV0dHRJFarQ0eUT8LH4BnRU0NHR0UEFVdIlFRV7TzRksomPY8uykTk/zewQfKw/9znv4yvJynLv4uLiV2dBoDiBf4qP3/ARuCRABEFAoBEgghggQAQZQKAnYEaQBAQaASKIAQJEkAEEegJmBElAoBEgghggQAQZQKAnYEaQBAQaASKIAQJEkAEEegJmBElAoBEgghggQAQZQKAnYEaQBAQaASKIAQJEkAEEegJmBElAoBEgghggQAQZQKAnYEaQBAQaASKIAQJEkAEEegJmBElAoBEgghggQAQZQKAnYEaQBAQaASKIAQJEkAEEegJmBElAoBEgghggQAQZQKAnYEaQBAQaASKIAQJEkAEEegJmBElAoBEgghggQAQZQKAnYEaQBAQaASKIAQJEkAEEegJmBElAoBEgghggQAQZQKAnYEaQBAQaASKIAQJEkAEEegJmBElAoBEgghggQAQZQKAnYEaQBAQaASKIAQJEkAEEegJmBElAoBEgghggQAQZQKAnYEaQBAQaASKIAQJEkAEEegJmBElAoBEgghggQAQZQKAnYEaQBAQaASKIAQJEkAEEegJmBElAoBEgghggQAQZQKAnYEaQBAQaASKIAQJEkAEEegJmBElAoBEgghgg0Aj8i0JO4OzsrPv69Wv+hi2qPHr0qNvf39+iI97soRIh4f3z58/u7du3SXX7Xt7Z2enevHmzfQe+oSN2apSAPj09TSrb+XKI/f379+08+A0cNRE2ANkupk+ACNPvkSPcAAEibACyXUyfABGm3yNHuAECRNgAZLuYPgEirKlHu7u7XdyytGwHAd8jjNyng4OD7vnz51dbPT8/7z58+NB9+/bt6jU/TI+AGWHEnrx48eJ/EsSmHzx40L18+fLyzxF3ZVMjEyDCiEDjMYZZS5wiPXnyZFbJaxMhQIQRGzHvWR7XCyOCXsOmiDAi1HmPMMQjDpbpEiDCiL358eNHurW/5SnWdIBbXiDCiA38/Pnzrce2YyZ4//59F3ePLNMl4PbpiL2J0L979+7yDtHDhw8vtzzvdGnEXdvUigSIsCLAWavHp/+qM0BcXMd/q25n1vF57TYBp0a3mUzilePj4+7k5KSLb6gt6ydAhPUzXnoPR0dHl79WGTNCfBnn1uvSCJdegQhLI1vvCk+fPu2ePXt2tZOYEV6/fn31dz+shwAR1sP1cqvLntbEN9MxA9xcYjsxS1jWR4AIa2Ibzx0tc44fYX/16lV6NDFLXH+YL32jwiACRBiEbf5KcXoTIsQSpzXx4N28Ja4BQoK7rgXiydbHjx/P25TaQAJEGAguWy0+2Q8PD6/Ki4R8EVl+bzBOnZY95fq9rj9zAkTI2SxdidBHqG9+skdw43borCXO/ZcJdraPWdv22uIEiLA4q7nvvCug8WTqzQveOH26fodo7g6uFe/a17W3+nFBAkRYENRdb1vkkz1CH9cPsVy/jrhr27PqMYvENYNlHAIesRiBYwRy0V+8iXP8+/fvX11Mr7L7ECueb/r48eMqm7FuI2BGWDEG8cm+7G3NEOfmdcTQw4h9/55lhm7DekRYKQPZF2ArbXTAyu4kDYB2YxUzwg0gi/41ztHnfQG26HbGel/crVrm7tNY+/1btkOEAZ2M05r4FB7r9GbAIdxaZYrHdOsgJ/wCEQY0J74TmOKnbxxT9n3FgGGWWsVdowHtjt9Nnvf7yQM2aZU/TIAIAxrw6dOnAWtZZcoEnBpNuTuObWMEiLAx1HY0ZQJEmHJ3HNvGCBBhY6jtaMoEiJB0Z29vL6ls58vxPcO8/zfrdo5qvKO+d3Fx8Wu8zf1dW4p/cPzLly/dtv9Ts/EbcvGAHhHyfBIhZ6NSiIBTo0LNNtScABFyNiqFCBChULMNNSdAhJyNSiECRCjUbEPNCRAhZ6NSiAARCjXbUHMCRMjZqBQiQIRCzTbUnAARcjYqhQgQoVCzDTUnQIScjUohAkQo1GxDzQkQIWejUogAEQo121BzAkTI2agUIkCEQs021JwAEXI2KoUIEKFQsw01J0CEnI1KIQJEKNRsQ80JECFno1KIABEKNdtQcwJEyNmoFCJAhELNNtScABFyNiqFCBChULMNNSdAhJyNSiECRCjUbEPNCRAhZ6NSiAARCjXbUHMCRMjZqBQiQIRCzTbUnAARcjYqhQgQoVCzDTUnQIScjUohAkQo1GxDzQkQIWejUogAEQo121BzAkTI2agUIkCEQs021JwAEXI2KoUIEKFQsw01J0CEnI1KIQJEKNRsQ80JECFno1KIABEKNdtQcwJEyNmoFCJAhELNNtScABFyNiqFCBChULMNNSdAhJyNSiECRCjUbEPNCRAhZ6NSiAARCjXbUHMCRMjZqBQiQIRCzTbUnAARcjYqhQgQoVCzDTUnQIScjUohAkQo1GxDzQkQIWejUogAEQo121BzAkTI2agUIkCEQs021JwAEXI2KoUIEKFQsw01J0CEnI1KIQJEKNRsQ80JECFno1KIABEKNdtQcwJEyNmoFCJAhELNNtScABFyNiqFCBChULMNNSdAhJyNSiEC/wGgKKC4YMA4TAAAAABJRU5ErkJggg==)

ä¿®æ”¹ router/index.ts çš„è·¯ç”±é…ç½®ï¼š

```typescript
routes: [
  {
    path: '/',
    name: 'ä¸»é¡µ',
    component: HomePage,
  },
  {
    path: '/user/login',
    name: 'ç”¨æˆ·ç™»å½•',
    component: UserLoginPage,
  },
  {
    path: '/user/register',
    name: 'ç”¨æˆ·æ³¨å†Œ',
    component: UserRegisterPage,
  },
  {
    path: '/admin/userManage',
    name: 'ç”¨æˆ·ç®¡ç†',
    component: UserManagePage,
  },
],
```

è®°å¾—æ‰§è¡Œä¸€ä¸‹ openapi å‘½ä»¤ç”Ÿæˆæ¥å£å¯¹åº”çš„è¯·æ±‚ä»£ç ï¼Œæ¯æ¬¡åç«¯æ”¹åŠ¨æ—¶éƒ½éœ€è¦è¿™ä¹ˆåšã€‚

### è·å–å½“å‰ç™»å½•ç”¨æˆ·

åœ¨ä¹‹å‰çš„æ•™ç¨‹ä¸­ï¼Œå·²ç»åˆ›å»ºäº†å‰ç«¯ç™»å½•ç”¨æˆ·çš„çŠ¶æ€ç®¡ç†æ–‡ä»¶ useLoginUserStore.tsã€‚ç°åœ¨åç«¯æä¾›äº†è·å–å½“å‰ç™»å½•ç”¨æˆ·çš„æ¥å£ï¼Œç›´æ¥ä¿®æ”¹ fetchLoginUser å‡½æ•°å³å¯ï¼š

```typescript
async function fetchLoginUser() {
  const res = await getLoginUserUsingGet()
  if (res.data.code === 0 && res.data.data) {
    loginUser.value = res.data.data
  }
}
```

å¯ä»¥é¡ºä¾¿ç»™ loginUser å¢åŠ  TypeScript ç±»å‹ï¼Œè¿™æ ·åœ¨åç»­å¼€å‘æ—¶å°±ä¼šæœ‰å­—æ®µæç¤ºï¼š

```typescript
const loginUser = ref<API.LoginUserVO>({
  userName: 'æœªç™»å½•',
})
```

ä¹‹å‰åœ¨ GlobalHeader ä¸­å·²ç»ç¼–å†™å¥½æ˜¾ç¤ºå½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯çš„é¡µé¢ä»£ç ï¼š

```typescript
<div class="user-login-status">
  <div v-if="loginUserStore.loginUser.id">
    {{ loginUserStore.loginUser.userName ?? 'æ— å' }}
  </div>
  <div v-else>
    <a-button type="primary" href="/user/login">ç™»å½•</a-button>
  </div>
</div>
```

### ç”¨æˆ·ç™»å½•é¡µé¢

å¼€å‘ UserLoginPage.vueï¼Œå¯ä»¥åŸºäº [Ant Design çš„è¡¨å•ç»„ä»¶](https://antdv.com/components/form-cn) å¿«é€Ÿå¼€å‘ç™»å½•é¡µé¢ã€‚

å…ˆå¼€å‘åŸºç¡€é¡µé¢ï¼Œå¯ä»¥æŒ‰ç…§éœ€è¦å¢åŠ ä¸€äº›å‰ç«¯æ ¡éªŒï¼Œä»£ç å¦‚ä¸‹ï¼š

```vue
<template>
  <div id="userLoginPage">
    <h2 class="title">é±¼çš®äº‘å›¾åº“ - ç”¨æˆ·ç™»å½•</h2>
    <div class="desc">ä¼ä¸šçº§æ™ºèƒ½ååŒäº‘å›¾åº“</div>
    <a-form :model="formState" name="basic" autocomplete="off" @finish="handleSubmit">
      <a-form-item name="userAccount" :rules="[{ required: true, message: 'è¯·è¾“å…¥è´¦å·' }]">
        <a-input v-model:value="formState.userAccount" placeholder="è¯·è¾“å…¥è´¦å·" />
      </a-form-item>
      <a-form-item
        name="userPassword"
        :rules="[
          { required: true, message: 'è¯·è¾“å…¥å¯†ç ' },
          { min: 8, message: 'å¯†ç ä¸èƒ½å°äº 8 ä½' },
        ]"
      >
        <a-input-password v-model:value="formState.userPassword" placeholder="è¯·è¾“å…¥å¯†ç " />
      </a-form-item>
      <div class="tips">
        æ²¡æœ‰è´¦å·ï¼Ÿ
        <RouterLink to="/user/register">å»æ³¨å†Œ</RouterLink>
      </div>
      <a-form-item>
        <a-button type="primary" html-type="submit" style="width: 100%">ç™»å½•</a-button>
      </a-form-item>
    </a-form>
  </div>
</template>
```

å®šä¹‰ä¸€ä¸ªå“åº”å¼å˜é‡æ¥æ¥å—è¡¨å•è¾“å…¥çš„å€¼ï¼š

```typescript
const formState = reactive<API.UserLoginRequest>({
  userAccount: '',
  userPassword: '',
})
```

ç¼–å†™ CSS æ ·å¼ï¼Œç¾åŒ–é¡µé¢ï¼š

```css
#userLoginPage {
  max-width: 360px;
  margin: 0 auto;
}

.title {
  text-align: center;
  margin-bottom: 16px;
}

.desc {
  text-align: center;
  color: #bbb;
  margin-bottom: 16px;
}

.tips {
  margin-bottom: 16px;
  color: #bbb;
  font-size: 13px;
  text-align: right;
}
```

ç¼–å†™è¡¨å•æäº¤åæ‰§è¡Œçš„å‡½æ•°ï¼Œç™»é™†æˆåŠŸåéœ€è¦åœ¨å…¨å±€çŠ¶æ€ä¸­è®°å½•å½“å‰ç™»å½•ç”¨æˆ·çš„ä¿¡æ¯ï¼Œå¹¶è·³è½¬åˆ°ä¸»é¡µï¼šbgMhj83Bt96lFcj29lBZCF0o0+YPCGWOWUw0OPyFB/Q=

```typescript
const router = useRouter()
const loginUserStore = useLoginUserStore()

/**
 * æäº¤è¡¨å•
 * @param values
 */
const handleSubmit = async (values: any) => {
  const res = await userLoginUsingPost(values)
  // ç™»å½•æˆåŠŸï¼ŒæŠŠç™»å½•æ€ä¿å­˜åˆ°å…¨å±€çŠ¶æ€ä¸­
  if (res.data.code === 0 && res.data.data) {
    await loginUserStore.fetchLoginUser()
    message.success('ç™»å½•æˆåŠŸ')
    router.push({
      path: '/',
      replace: true,
    })
  } else {
    message.error('ç™»å½•å¤±è´¥ï¼Œ' + res.data.message)
  }
}
```

é¡µé¢æ•ˆæœå¦‚å›¾ï¼š

![img](./assets/wDYKxTTxwHXj7E3f.webp)

### ç”¨æˆ·æ³¨å†Œé¡µé¢

åŒæ ·ä½¿ç”¨è¡¨å•ç»„ä»¶ï¼Œåœ¨ç”¨æˆ·ç™»å½•é¡µé¢çš„åŸºç¡€ä¸Šè°ƒæ•´å³å¯ï¼Œæ¶‰åŠåˆ°æ›´å¤šè¡¨å•é¡¹çš„å¡«å†™ï¼š

```vue
<template>
  <div id="userRegisterPage">
    <h2 class="title">é±¼çš®äº‘å›¾åº“ - ç”¨æˆ·æ³¨å†Œ</h2>
    <div class="desc">ä¼ä¸šçº§æ™ºèƒ½ååŒäº‘å›¾åº“</div>
    <a-form
      :model="formState"
      name="basic"
      label-align="left"
      autocomplete="off"
      @finish="handleSubmit"
    >
      <a-form-item name="userAccount" :rules="[{ required: true, message: 'è¯·è¾“å…¥è´¦å·' }]">
        <a-input v-model:value="formState.userAccount" placeholder="è¯·è¾“å…¥è´¦å·" />
      </a-form-item>
      <a-form-item
        name="userPassword"
        :rules="[
          { required: true, message: 'è¯·è¾“å…¥å¯†ç ' },
          { min: 8, message: 'å¯†ç ä¸èƒ½å°äº 8 ä½' },
        ]"
      >
        <a-input-password v-model:value="formState.userPassword" placeholder="è¯·è¾“å…¥å¯†ç " />
      </a-form-item>
      <a-form-item
        name="checkPassword"
        :rules="[
          { required: true, message: 'è¯·è¾“å…¥ç¡®è®¤å¯†ç ' },
          { min: 8, message: 'ç¡®è®¤å¯†ç ä¸èƒ½å°äº 8 ä½' },
        ]"
      >
        <a-input-password v-model:value="formState.checkPassword" placeholder="è¯·è¾“å…¥ç¡®è®¤å¯†ç " />
      </a-form-item>
      <div class="tips">
        å·²æœ‰è´¦å·ï¼Ÿ
        <RouterLink to="/user/login">å»ç™»å½•</RouterLink>
      </div>
      <a-form-item>
        <a-button type="primary" html-type="submit" style="width: 100%">æ³¨å†Œ</a-button>
      </a-form-item>
    </a-form>
  </div>
</template>
```

å®šä¹‰è¡¨å•ä¿¡æ¯å˜é‡ï¼š

```typescript
const formState = reactive<API.UserRegisterRequest>({
  userAccount: '',
  userPassword: '',
  checkPassword: '',
})
```

ç¼–å†™æäº¤è¡¨å•å‡½æ•°ï¼Œå¯ä»¥å¢åŠ ä¸€äº›å‰ç«¯æ ¡éªŒï¼Œå¹¶ä¸”åœ¨æ³¨å†ŒæˆåŠŸåè·³è½¬åˆ°ç”¨æˆ·ç™»å½•é¡µï¼šcT00UyE1JKn/y8Q147TQRzbDavEs+V72bbBFCS1wu6g=

```typescript
const router = useRouter()

/**
 * æäº¤è¡¨å•
 * @param values
 */
const handleSubmit = async (values: any) => {
  // åˆ¤æ–­ä¸¤æ¬¡è¾“å…¥çš„å¯†ç æ˜¯å¦ä¸€è‡´
  if (formState.userPassword !== formState.checkPassword) {
    message.error('äºŒæ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´')
    return
  }
  const res = await userRegisterUsingPost(values)
  // æ³¨å†ŒæˆåŠŸï¼Œè·³è½¬åˆ°ç™»å½•é¡µé¢
  if (res.data.code === 0 && res.data.data) {
    message.success('æ³¨å†ŒæˆåŠŸ')
    router.push({
      path: '/user/login',
      replace: true,
    })
  } else {
    message.error('æ³¨å†Œå¤±è´¥ï¼Œ' + res.data.message)
  }
}
```

é¡µé¢æ•ˆæœå¦‚å›¾ï¼š

![img](./assets/uTQ3W8N8eLCze0G9.webp)

### ç”¨æˆ·æ³¨é”€

ä¸€èˆ¬é¼ æ ‡æ‚¬æµ®åœ¨å³ä¸Šè§’ç”¨æˆ·å¤´åƒæ—¶ï¼Œä¼šå±•ç¤ºåŒ…å«ç”¨æˆ·æ³¨é”€ï¼ˆé€€å‡ºç™»å½•ï¼‰åŠŸèƒ½çš„ä¸‹æ‹‰èœå•ã€‚

å…ˆå¼€å‘é¡µé¢ç»“æ„ï¼š

```vue
<div v-if="loginUserStore.loginUser.id">
  <a-dropdown>
    <ASpace>
      <a-avatar :src="loginUserStore.loginUser.userAvatar" />
      {{ loginUserStore.loginUser.userName ?? 'æ— å' }}
    </ASpace>
    <template #overlay>
      <a-menu>
        <a-menu-item @click="doLogout">
          <LogoutOutlined />
          é€€å‡ºç™»å½•
        </a-menu-item>
      </a-menu>
    </template>
  </a-dropdown>
</div>
```

ç¼–å†™ç”¨æˆ·æ³¨é”€äº‹ä»¶å‡½æ•°ï¼Œé€€å‡ºç™»å½•åè·³è½¬åˆ°ç™»å½•é¡µï¼š

```typescript
// ç”¨æˆ·æ³¨é”€
const doLogout = async () => {
  const res = await userLogoutUsingPost()
  console.log(res)
  if (res.data.code === 0) {
    loginUserStore.setLoginUser({
      userName: 'æœªç™»å½•',
    })
    message.success('é€€å‡ºç™»å½•æˆåŠŸ')
    await router.push('/user/login')
  } else {
    message.error('é€€å‡ºç™»å½•å¤±è´¥ï¼Œ' + res.data.message)
  }
}
```

æ•ˆæœå¦‚å›¾ï¼š

![img](./assets/Z9g6WnCBwRMOaHFU.webp)

### ç”¨æˆ·ç®¡ç†é¡µé¢

éœ€æ±‚ï¼šå…è®¸ç®¡ç†å‘˜æŸ¥çœ‹å·²æ³¨å†Œçš„ç”¨æˆ·ä¿¡æ¯ï¼Œèƒ½å¤Ÿæ ¹æ®ç”¨æˆ·åç§°æœç´¢ç”¨æˆ·ã€å¹¶åˆ é™¤éæ³•ç”¨æˆ·ã€‚

éœ€è¦æ³¨æ„ï¼Œè¦é˜²æ­¢æ™®é€šç”¨æˆ·ä¹Ÿèƒ½çœ‹åˆ°ç”¨æˆ·ä¿¡æ¯ï¼Œæ‰€ä»¥è¦å¢åŠ ä¸€å®šçš„æƒé™æ§åˆ¶ï¼Œå¯ä»¥åˆ†ä¸ºé¡µé¢å¼€å‘å’Œæƒé™æ§åˆ¶ä¸¤ä¸ªæ­¥éª¤æ¥å®ç°ã€‚

ç¼–å†™é¡µé¢ï¼šä¸Šæ–¹æœç´¢æ ï¼Œä¸‹æ–¹è¡¨æ ¼ï¼Œè¡¨æ ¼éœ€è¦æ”¯æŒåˆ†é¡µã€‚

æˆ‘ä»¬å¯ä»¥æ‹†åˆ†ä¸ºå‡ ä¸ªæ­¥éª¤æ¥å¼€å‘ï¼š

#### 1ã€è¡¨æ ¼

1ï¼‰åˆ©ç”¨ [Ant Design çš„è¡¨æ ¼ç»„ä»¶](https://antdv.com/components/table-cn#components-table-demo-basic)ï¼Œæ‰¾åˆ°éœ€è¦çš„ç»„ä»¶è¿›è¡Œå¤åˆ¶ï¼Œå…ˆå±•ç¤ºå…¨éƒ¨ç”¨æˆ·ä¿¡æ¯ã€‚

![img](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMIAAADDCAYAAADQvc6UAAABRWlDQ1BJQ0MgUHJvZmlsZQAAKJFjYGASSSwoyGFhYGDIzSspCnJ3UoiIjFJgf8LAwSDCIMogwMCcmFxc4BgQ4ANUwgCjUcG3awyMIPqyLsis7PPOq3QdDFcvjV3jOD1boQVTPQrgSkktTgbSf4A4LbmgqISBgTEFyFYuLykAsTuAbJEioKOA7DkgdjqEvQHEToKwj4DVhAQ5A9k3gGyB5IxEoBmML4BsnSQk8XQkNtReEOBxcfXxUQg1Mjc0dyHgXNJBSWpFCYh2zi+oLMpMzyhRcASGUqqCZ16yno6CkYGRAQMDKMwhqj/fAIcloxgHQqxAjIHBEugw5sUIsSQpBobtQPdLciLEVJYzMPBHMDBsayhILEqEO4DxG0txmrERhM29nYGBddr//5/DGRjYNRkY/l7////39v///y4Dmn+LgeHANwDrkl1AuO+pmgAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAwqADAAQAAAABAAAAwwAAAAD9b/HnAAAHlklEQVR4Ae3dP3PTWBSGcbGzM6GCKqlIBRV0dHRJFarQ0eUT8LH4BnRU0NHR0UEFVdIlFRV7TzRksomPY8uykTk/zewQfKw/9znv4yvJynLv4uLiV2dBoDiBf4qP3/ARuCRABEFAoBEgghggQAQZQKAnYEaQBAQaASKIAQJEkAEEegJmBElAoBEgghggQAQZQKAnYEaQBAQaASKIAQJEkAEEegJmBElAoBEgghggQAQZQKAnYEaQBAQaASKIAQJEkAEEegJmBElAoBEgghggQAQZQKAnYEaQBAQaASKIAQJEkAEEegJmBElAoBEgghggQAQZQKAnYEaQBAQaASKIAQJEkAEEegJmBElAoBEgghggQAQZQKAnYEaQBAQaASKIAQJEkAEEegJmBElAoBEgghggQAQZQKAnYEaQBAQaASKIAQJEkAEEegJmBElAoBEgghggQAQZQKAnYEaQBAQaASKIAQJEkAEEegJmBElAoBEgghggQAQZQKAnYEaQBAQaASKIAQJEkAEEegJmBElAoBEgghggQAQZQKAnYEaQBAQaASKIAQJEkAEEegJmBElAoBEgghggQAQZQKAnYEaQBAQaASKIAQJEkAEEegJmBElAoBEgghggQAQZQKAnYEaQBAQaASKIAQJEkAEEegJmBElAoBEgghgg0Aj8i0JO4OzsrPv69Wv+hi2qPHr0qNvf39+iI97soRIh4f3z58/u7du3SXX7Xt7Z2enevHmzfQe+oSN2apSAPj09TSrb+XKI/f379+08+A0cNRE2ANkupk+ACNPvkSPcAAEibACyXUyfABGm3yNHuAECRNgAZLuYPgEirKlHu7u7XdyytGwHAd8jjNyng4OD7vnz51dbPT8/7z58+NB9+/bt6jU/TI+AGWHEnrx48eJ/EsSmHzx40L18+fLyzxF3ZVMjEyDCiEDjMYZZS5wiPXnyZFbJaxMhQIQRGzHvWR7XCyOCXsOmiDAi1HmPMMQjDpbpEiDCiL358eNHurW/5SnWdIBbXiDCiA38/Pnzrce2YyZ4//59F3ePLNMl4PbpiL2J0L979+7yDtHDhw8vtzzvdGnEXdvUigSIsCLAWavHp/+qM0BcXMd/q25n1vF57TYBp0a3mUzilePj4+7k5KSLb6gt6ydAhPUzXnoPR0dHl79WGTNCfBnn1uvSCJdegQhLI1vvCk+fPu2ePXt2tZOYEV6/fn31dz+shwAR1sP1cqvLntbEN9MxA9xcYjsxS1jWR4AIa2Ibzx0tc44fYX/16lV6NDFLXH+YL32jwiACRBiEbf5KcXoTIsQSpzXx4N28Ja4BQoK7rgXiydbHjx/P25TaQAJEGAguWy0+2Q8PD6/Ki4R8EVl+bzBOnZY95fq9rj9zAkTI2SxdidBHqG9+skdw43borCXO/ZcJdraPWdv22uIEiLA4q7nvvCug8WTqzQveOH26fodo7g6uFe/a17W3+nFBAkRYENRdb1vkkz1CH9cPsVy/jrhr27PqMYvENYNlHAIesRiBYwRy0V+8iXP8+/fvX11Mr7L7ECueb/r48eMqm7FuI2BGWDEG8cm+7G3NEOfmdcTQw4h9/55lhm7DekRYKQPZF2ArbXTAyu4kDYB2YxUzwg0gi/41ztHnfQG26HbGel/crVrm7tNY+/1btkOEAZ2M05r4FB7r9GbAIdxaZYrHdOsgJ/wCEQY0J74TmOKnbxxT9n3FgGGWWsVdowHtjt9Nnvf7yQM2aZU/TIAIAxrw6dOnAWtZZcoEnBpNuTuObWMEiLAx1HY0ZQJEmHJ3HNvGCBBhY6jtaMoEiJB0Z29vL6ls58vxPcO8/zfrdo5qvKO+d3Fx8Wu8zf1dW4p/cPzLly/dtv9Ts/EbcvGAHhHyfBIhZ6NSiIBTo0LNNtScABFyNiqFCBChULMNNSdAhJyNSiECRCjUbEPNCRAhZ6NSiAARCjXbUHMCRMjZqBQiQIRCzTbUnAARcjYqhQgQoVCzDTUnQIScjUohAkQo1GxDzQkQIWejUogAEQo121BzAkTI2agUIkCEQs021JwAEXI2KoUIEKFQsw01J0CEnI1KIQJEKNRsQ80JECFno1KIABEKNdtQcwJEyNmoFCJAhELNNtScABFyNiqFCBChULMNNSdAhJyNSiECRCjUbEPNCRAhZ6NSiAARCjXbUHMCRMjZqBQiQIRCzTbUnAARcjYqhQgQoVCzDTUnQIScjUohAkQo1GxDzQkQIWejUogAEQo121BzAkTI2agUIkCEQs021JwAEXI2KoUIEKFQsw01J0CEnI1KIQJEKNRsQ80JECFno1KIABEKNdtQcwJEyNmoFCJAhELNNtScABFyNiqFCBChULMNNSdAhJyNSiECRCjUbEPNCRAhZ6NSiAARCjXbUHMCRMjZqBQiQIRCzTbUnAARcjYqhQgQoVCzDTUnQIScjUohAkQo1GxDzQkQIWejUogAEQo121BzAkTI2agUIkCEQs021JwAEXI2KoUIEKFQsw01J0CEnI1KIQJEKNRsQ80JECFno1KIABEKNdtQcwJEyNmoFCJAhELNNtScABFyNiqFCBChULMNNSdAhJyNSiEC/wGgKKC4YMA4TAAAAABJRU5ErkJggg==)

2ï¼‰åªéœ€è¦æ ¹æ®è‡ªå·±çš„æ•°æ®è¡¨ï¼Œç¼–å†™ columns è¡¨æ ¼åˆ—ï¼Œå¹¶ä¼ å…¥è·å–åˆ°çš„ data æ•°æ®ï¼Œç»„ä»¶å°±èƒ½è‡ªåŠ¨å¸®æˆ‘ä»¬å±•ç¤ºå‡ºè¡¨æ ¼ï¼Œéå¸¸æ–¹ä¾¿ã€‚

å®šä¹‰è¡¨æ ¼åˆ—ï¼š

```typescript
const columns = [
  {
    title: 'id',
    dataIndex: 'id',
  },
  {
    title: 'è´¦å·',
    dataIndex: 'userAccount',
  },
  {
    title: 'ç”¨æˆ·å',
    dataIndex: 'userName',
  },
  {
    title: 'å¤´åƒ',
    dataIndex: 'userAvatar',
  },
  {
    title: 'ç®€ä»‹',
    dataIndex: 'userProfile',
  },
  {
    title: 'ç”¨æˆ·è§’è‰²',
    dataIndex: 'userRole',
  },
  {
    title: 'åˆ›å»ºæ—¶é—´',
    dataIndex: 'createTime',
  },
  {
    title: 'æ›´æ–°æ—¶é—´',
    dataIndex: 'updateTime',
  },
  {
    title: 'æ“ä½œ',
    key: 'action',
  },
]
```

3ï¼‰ä»åç«¯è·å–æ•°æ®ï¼š

```typescript
// æ•°æ®
const dataList = ref([])
const total = ref(0)

// æœç´¢æ¡ä»¶
const searchParams = reactive<API.UserQueryRequest>({
  current: 1,
  pageSize: 10,
})

// è·å–æ•°æ®
const fetchData = async () => {
  const res = await listUserVoByPageUsingPost({
    ...searchParams
  })
  if (res.data.data) {
    dataList.value = res.data.data.records ?? []
    total.value = res.data.data.total ?? 0
  } else {
    message.error('è·å–æ•°æ®å¤±è´¥ï¼Œ' + res.data.message)
  }
}

// é¡µé¢åŠ è½½æ—¶è¯·æ±‚ä¸€æ¬¡
onMounted(() => {
  fetchData()
})
```

æ³¨æ„ï¼Œä¸Šè¿°ä»£ç ä¸­ï¼Œä½¿ç”¨ onMounted åŒ…è£¹è·å–æ•°æ®çš„å‡½æ•°ï¼Œå¯ä»¥ä½¿å¾—åœ¨é¡µé¢åŠ è½½æ—¶ä»…å‘é€ä¸€æ¬¡è¯·æ±‚ï¼Œé¿å…é‡å¤è·å–ã€‚

è¿è¡Œï¼Œå¯ä»¥çœ‹åˆ°æ•°æ®è¢«æ­£å¸¸åŠ è½½ï¼Œä½†æ˜¯æ˜¾ç„¶å±•ç¤ºæ•ˆæœå¹¶ä¸å¥½ã€‚

4ï¼‰å¯¹äºå›¾ç‰‡ã€ç”¨æˆ·è§’è‰²ã€åˆ›å»ºæ—¶é—´ã€æ›´æ–°æ—¶é—´ä¹‹ç±»çš„æ•°æ®ï¼Œæˆ‘ä»¬å¯ä»¥æœ‰æ›´å¥½çš„å±•ç¤ºæ–¹å¼ã€‚bgMhj83Bt96lFcj29lBZCF0o0+YPCGWOWUw0OPyFB/Q=

è¡¨æ ¼ç»„ä»¶æ”¯æŒæˆ‘ä»¬ä½¿ç”¨ Vue çš„æ’æ§½è‡ªå®šä¹‰åˆ—çš„å±•ç¤ºï¼Œå‚è€ƒ Demo æœ‰æ ·å­¦æ ·ä¿®æ”¹å³å¯ã€‚

```tsx
<template #bodyCell="{ column, record }">
  <template v-if="column.dataIndex === 'userAvatar'">
    <a-image :src="record.userAvatar" :width="120" />
  </template>
  <template v-else-if="column.dataIndex === 'userRole'">
    <div v-if="record.userRole === 'admin'">
      <a-tag color="green">ç®¡ç†å‘˜</a-tag>
    </div>
    <div v-else>
      <a-tag color="blue">æ™®é€šç”¨æˆ·</a-tag>
    </div>
  </template>
  <template v-else-if="column.dataIndex === 'createTime'">
    {{ dayjs(record.createTime).format('YYYY-MM-DD HH:mm:ss') }}
  </template>
  <template v-else-if="column.key === 'action'">
    <a-button danger>åˆ é™¤</a-button>
  </template>
</template>
```

æ•ˆæœå¦‚å›¾ï¼š

![img](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMIAAADDCAYAAADQvc6UAAABRWlDQ1BJQ0MgUHJvZmlsZQAAKJFjYGASSSwoyGFhYGDIzSspCnJ3UoiIjFJgf8LAwSDCIMogwMCcmFxc4BgQ4ANUwgCjUcG3awyMIPqyLsis7PPOq3QdDFcvjV3jOD1boQVTPQrgSkktTgbSf4A4LbmgqISBgTEFyFYuLykAsTuAbJEioKOA7DkgdjqEvQHEToKwj4DVhAQ5A9k3gGyB5IxEoBmML4BsnSQk8XQkNtReEOBxcfXxUQg1Mjc0dyHgXNJBSWpFCYh2zi+oLMpMzyhRcASGUqqCZ16yno6CkYGRAQMDKMwhqj/fAIcloxgHQqxAjIHBEugw5sUIsSQpBobtQPdLciLEVJYzMPBHMDBsayhILEqEO4DxG0txmrERhM29nYGBddr//5/DGRjYNRkY/l7////39v///y4Dmn+LgeHANwDrkl1AuO+pmgAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAwqADAAQAAAABAAAAwwAAAAD9b/HnAAAHlklEQVR4Ae3dP3PTWBSGcbGzM6GCKqlIBRV0dHRJFarQ0eUT8LH4BnRU0NHR0UEFVdIlFRV7TzRksomPY8uykTk/zewQfKw/9znv4yvJynLv4uLiV2dBoDiBf4qP3/ARuCRABEFAoBEgghggQAQZQKAnYEaQBAQaASKIAQJEkAEEegJmBElAoBEgghggQAQZQKAnYEaQBAQaASKIAQJEkAEEegJmBElAoBEgghggQAQZQKAnYEaQBAQaASKIAQJEkAEEegJmBElAoBEgghggQAQZQKAnYEaQBAQaASKIAQJEkAEEegJmBElAoBEgghggQAQZQKAnYEaQBAQaASKIAQJEkAEEegJmBElAoBEgghggQAQZQKAnYEaQBAQaASKIAQJEkAEEegJmBElAoBEgghggQAQZQKAnYEaQBAQaASKIAQJEkAEEegJmBElAoBEgghggQAQZQKAnYEaQBAQaASKIAQJEkAEEegJmBElAoBEgghggQAQZQKAnYEaQBAQaASKIAQJEkAEEegJmBElAoBEgghggQAQZQKAnYEaQBAQaASKIAQJEkAEEegJmBElAoBEgghggQAQZQKAnYEaQBAQaASKIAQJEkAEEegJmBElAoBEgghggQAQZQKAnYEaQBAQaASKIAQJEkAEEegJmBElAoBEgghgg0Aj8i0JO4OzsrPv69Wv+hi2qPHr0qNvf39+iI97soRIh4f3z58/u7du3SXX7Xt7Z2enevHmzfQe+oSN2apSAPj09TSrb+XKI/f379+08+A0cNRE2ANkupk+ACNPvkSPcAAEibACyXUyfABGm3yNHuAECRNgAZLuYPgEirKlHu7u7XdyytGwHAd8jjNyng4OD7vnz51dbPT8/7z58+NB9+/bt6jU/TI+AGWHEnrx48eJ/EsSmHzx40L18+fLyzxF3ZVMjEyDCiEDjMYZZS5wiPXnyZFbJaxMhQIQRGzHvWR7XCyOCXsOmiDAi1HmPMMQjDpbpEiDCiL358eNHurW/5SnWdIBbXiDCiA38/Pnzrce2YyZ4//59F3ePLNMl4PbpiL2J0L979+7yDtHDhw8vtzzvdGnEXdvUigSIsCLAWavHp/+qM0BcXMd/q25n1vF57TYBp0a3mUzilePj4+7k5KSLb6gt6ydAhPUzXnoPR0dHl79WGTNCfBnn1uvSCJdegQhLI1vvCk+fPu2ePXt2tZOYEV6/fn31dz+shwAR1sP1cqvLntbEN9MxA9xcYjsxS1jWR4AIa2Ibzx0tc44fYX/16lV6NDFLXH+YL32jwiACRBiEbf5KcXoTIsQSpzXx4N28Ja4BQoK7rgXiydbHjx/P25TaQAJEGAguWy0+2Q8PD6/Ki4R8EVl+bzBOnZY95fq9rj9zAkTI2SxdidBHqG9+skdw43borCXO/ZcJdraPWdv22uIEiLA4q7nvvCug8WTqzQveOH26fodo7g6uFe/a17W3+nFBAkRYENRdb1vkkz1CH9cPsVy/jrhr27PqMYvENYNlHAIesRiBYwRy0V+8iXP8+/fvX11Mr7L7ECueb/r48eMqm7FuI2BGWDEG8cm+7G3NEOfmdcTQw4h9/55lhm7DekRYKQPZF2ArbXTAyu4kDYB2YxUzwg0gi/41ztHnfQG26HbGel/crVrm7tNY+/1btkOEAZ2M05r4FB7r9GbAIdxaZYrHdOsgJ/wCEQY0J74TmOKnbxxT9n3FgGGWWsVdowHtjt9Nnvf7yQM2aZU/TIAIAxrw6dOnAWtZZcoEnBpNuTuObWMEiLAx1HY0ZQJEmHJ3HNvGCBBhY6jtaMoEiJB0Z29vL6ls58vxPcO8/zfrdo5qvKO+d3Fx8Wu8zf1dW4p/cPzLly/dtv9Ts/EbcvGAHhHyfBIhZ6NSiIBTo0LNNtScABFyNiqFCBChULMNNSdAhJyNSiECRCjUbEPNCRAhZ6NSiAARCjXbUHMCRMjZqBQiQIRCzTbUnAARcjYqhQgQoVCzDTUnQIScjUohAkQo1GxDzQkQIWejUogAEQo121BzAkTI2agUIkCEQs021JwAEXI2KoUIEKFQsw01J0CEnI1KIQJEKNRsQ80JECFno1KIABEKNdtQcwJEyNmoFCJAhELNNtScABFyNiqFCBChULMNNSdAhJyNSiECRCjUbEPNCRAhZ6NSiAARCjXbUHMCRMjZqBQiQIRCzTbUnAARcjYqhQgQoVCzDTUnQIScjUohAkQo1GxDzQkQIWejUogAEQo121BzAkTI2agUIkCEQs021JwAEXI2KoUIEKFQsw01J0CEnI1KIQJEKNRsQ80JECFno1KIABEKNdtQcwJEyNmoFCJAhELNNtScABFyNiqFCBChULMNNSdAhJyNSiECRCjUbEPNCRAhZ6NSiAARCjXbUHMCRMjZqBQiQIRCzTbUnAARcjYqhQgQoVCzDTUnQIScjUohAkQo1GxDzQkQIWejUogAEQo121BzAkTI2agUIkCEQs021JwAEXI2KoUIEKFQsw01J0CEnI1KIQJEKNRsQ80JECFno1KIABEKNdtQcwJEyNmoFCJAhELNNtScABFyNiqFCBChULMNNSdAhJyNSiEC/wGgKKC4YMA4TAAAAABJRU5ErkJggg==)

#### 2ã€åˆ†é¡µ

1ï¼‰è¡¨æ ¼ç»„ä»¶ [æ”¯æŒåˆ†é¡µ](https://antdv.com/components/table-cn#pagination)ï¼Œé¦–å…ˆç¼–å†™ä¸€ä¸ªåˆ†é¡µå˜é‡ï¼ŒæŒ‡å®šå½“å‰é¡µå·ã€é¡µé¢å¤§å°ã€æ•°æ®æ€»æ•°ã€å±•ç¤ºæ€»æ•°çš„æ–‡æ¡ˆç­‰å‚æ•°ï¼š6vlRn/br/m8Ymr8D02hZYIBP3pqlW5Sp8qJklXCk9AY=

```typescript
// åˆ†é¡µå‚æ•°
const pagination = computed(() => {
  return {
    current: searchParams.current ?? 1,
    pageSize: searchParams.pageSize ?? 10,
    total: total.value,
    showSizeChanger: true,
    showTotal: (total) => `å…± ${total} æ¡`,
  }
})
```

æ³¨æ„ï¼Œç”±äºè¿™äº›å‚æ•°éƒ½æ˜¯åŠ¨æ€å˜åŒ–çš„ï¼Œéœ€è¦ä½¿ç”¨ Vue çš„ computed è®¡ç®—å±æ€§ï¼Œå¦åˆ™å½“ searchParams æ”¹å˜æ—¶ï¼Œåˆ†é¡µå‚æ•°å¹¶ä¸ä¼šæ›´æ–°ã€‚

2ï¼‰ç¼–å†™ doTableChange å‡½æ•°ï¼Œå½“ç”¨æˆ·åˆ‡æ¢é¡µå·å’Œé¡µé¢å¤§å°æ—¶ï¼Œéœ€è¦æ›´æ–° searchParams æœç´¢æ¡ä»¶çš„å€¼ï¼Œå¹¶è§¦å‘æœç´¢ï¼šp87QUult0bZDR05AO5soQVixQ5nCQ+HA+P5tLSHK/hI=

```typescript
// è¡¨æ ¼å˜åŒ–å¤„ç†
const doTableChange = (page: any) => {
  searchParams.current = page.current
  searchParams.pageSize = page.pageSize
  fetchData()
}
```

3ï¼‰ç»™è¡¨æ ¼ç»„ä»¶ç»‘å®šåˆ†é¡µå‚æ•°å’Œè¡¨æ ¼åˆ‡æ¢äº‹ä»¶ï¼š

```tsx
<a-table
  :columns="columns"
  :data-source="dataList"
  :pagination="pagination"
  @change="doTableChange"
>
```

æ•ˆæœå¦‚å›¾ï¼š

![img](./assets/oVbPXPeNBmWNh9vM.webp)

#### 3ã€æœç´¢

åˆ©ç”¨ [Ant Design çš„æœç´¢ç»„ä»¶](https://antdv.com/components/input-cn#components-input-demo-search-input)ï¼Œå®ç°å¯¹æ•°æ®çš„æœç´¢ã€‚

1ï¼‰å…¶å®æœç´¢æœ¬è´¨ä¸Šå°±æ˜¯è®©ç”¨æˆ·å¡«å†™æœç´¢æ¡ä»¶è¡¨å•ï¼Œæ­¤å¤„æˆ‘ä»¬éœ€è¦æ ¹æ®è´¦å·å’Œç”¨æˆ·æ˜µç§°æœç´¢ï¼Œç¼–å†™è¡¨å•ä»£ç ï¼š

```tsx
<a-form layout="inline" :model="searchParams" @finish="doSearch">
  <a-form-item label="è´¦å·">
    <a-input v-model:value="searchParams.userAccount" placeholder="è¾“å…¥è´¦å·" />
  </a-form-item>
  <a-form-item label="ç”¨æˆ·å">
    <a-input v-model:value="searchParams.userName" placeholder="è¾“å…¥ç”¨æˆ·å" />
  </a-form-item>
  <a-form-item>
    <a-button type="primary" html-type="submit">æœç´¢</a-button>
  </a-form-item>
</a-form>
```

ä½¿ç”¨ searchParams æ¥å—ç”¨æˆ·çš„è¾“å…¥ï¼Œç›¸å½“äºæ‰€æœ‰çš„æœç´¢æ¡ä»¶å…¨éƒ¨å­˜åˆ°äº† seachParams ä¸­ï¼Œä¾¿äºç»Ÿä¸€ç»´æŠ¤ã€‚

2ï¼‰ç‚¹å‡»æœç´¢æŒ‰é’®æ—¶ä¼šè§¦å‘è¡¨å•æäº¤ï¼Œè¡¨å•æäº¤æ—¶éœ€è¦å°†é¡µå·é‡ç½®ä¸º 1ï¼Œå¹¶è·å–æ•°æ®ã€‚ç¼–å†™å¯¹åº”çš„å‡½æ•°ï¼š

```tsx
// è·å–æ•°æ®
const doSearch = () => {
  // é‡ç½®é¡µç 
  searchParams.current = 1
  fetchData()
}
```

æ•ˆæœå¦‚å›¾ï¼š

![img](./assets/EkM10lqzzv98Bi9i.webp)

#### 4ã€æ“ä½œ

æ¯”å¦‚å¼€å‘åˆ é™¤åŠŸèƒ½ï¼Œå…ˆç¼–å†™ç‚¹å‡»åˆ é™¤æŒ‰é’®åçš„å¤„ç†å‡½æ•°ï¼š

```typescript
// åˆ é™¤æ•°æ®
const doDelete = async (id: string) => {
  if (!id) {
    return
  }
  const res = await deleteUserUsingPost({ id })
  if (res.data.code === 0) {
    message.success('åˆ é™¤æˆåŠŸ')
    // åˆ·æ–°æ•°æ®
    fetchData()
  } else {
    message.error('åˆ é™¤å¤±è´¥')
  }
}
```

ç„¶åç»™åˆ é™¤æŒ‰é’®ç»‘å®šäº‹ä»¶ï¼š

```tsx
<a-button danger @click="doDelete(record.id)">åˆ é™¤</a-button>
```

### ç”¨æˆ·æƒé™æ§åˆ¶

è™½ç„¶åç«¯è·å–ç”¨æˆ·åˆ—è¡¨çš„æ¥å£åšäº†æƒé™æ ¡éªŒï¼Œé˜²æ­¢éç®¡ç†å‘˜ç”¨æˆ·è·å–åˆ°ã€‚ä½†ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä¸ºäº†ä¿è¯ç³»ç»Ÿå®‰å…¨å’Œæå‡ç”¨æˆ·ä½“éªŒï¼Œå‰ç«¯ä¹Ÿéœ€è¦å¯¹æƒé™è¿›è¡Œæ§åˆ¶ã€‚

æœ‰ 2 ç§å®ç°æ–¹å¼ï¼šå•é¡µé¢æ§åˆ¶æƒé™ï¼Œæˆ–è€…å…¨å±€æ§åˆ¶æƒé™ã€‚

æ€è·¯éƒ½æ˜¯ä¸€è‡´çš„ï¼Œåœ¨è¿›å…¥æŸä¸ªé¡µé¢æ—¶åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å…·æœ‰è¯¥é¡µé¢çš„æƒé™ï¼Œæ— éæ˜¯æŠŠæƒé™æ ¡éªŒç›¸å…³çš„ä»£ç å†™åœ¨å•ä¸ªé¡µé¢å†…ï¼Œè¿˜æ˜¯å†™åˆ°ä¸€ä¸ªç‹¬ç«‹çš„æ–‡ä»¶ä¸­ç½¢äº†ã€‚

**å»ºè®®ç¼–å†™ç‹¬ç«‹çš„å…¨å±€æƒé™æ§åˆ¶æ–‡ä»¶ã€‚**å¯ä»¥åˆ©ç”¨ Vue Router çš„è·¯ç”±å®ˆå«å®ç°ï¼Œæ¯æ¬¡åˆ‡æ¢å¹¶è¿›å…¥é¡µé¢å‰ï¼Œéƒ½ä¼šæ£€æŸ¥ä¸€ä¸‹å½“å‰ç”¨æˆ·æ˜¯å¦å…·æœ‰ç‰¹å®šé¡µé¢çš„æƒé™ã€‚

åœ¨ src ä¸‹ç¼–å†™ access.ts æƒé™æ ¡éªŒæ–‡ä»¶ï¼Œå¯ä»¥è‡ªå·±å®šä¹‰é€»è¾‘ï¼Œæ¯”å¦‚ç”¨é¡µé¢å‰ç¼€æ¥ç»Ÿä¸€åˆ¤æ–­ï¼š

```tsx
import { useLoginUserStore } from '@/stores/useLoginUserStore'
import { message } from 'ant-design-vue'
import router from '@/router'

// æ˜¯å¦ä¸ºé¦–æ¬¡è·å–ç™»å½•ç”¨æˆ·
let firstFetchLoginUser = true;

/**
 * å…¨å±€æƒé™æ ¡éªŒ
 */
router.beforeEach(async (to, from, next) => {
  const loginUserStore = useLoginUserStore()
  let loginUser = loginUserStore.loginUser
  // ç¡®ä¿é¡µé¢åˆ·æ–°ï¼Œé¦–æ¬¡åŠ è½½æ—¶ï¼Œèƒ½å¤Ÿç­‰åç«¯è¿”å›ç”¨æˆ·ä¿¡æ¯åå†æ ¡éªŒæƒé™
  if (firstFetchLoginUser) {
    await loginUserStore.fetchLoginUser()
    loginUser = loginUserStore.loginUser
    firstFetchLoginUser = false;
  }
  const toUrl = to.fullPath
  if (toUrl.startsWith('/admin')) {
    if (!loginUser || loginUser.userRole !== 'admin') {
      message.error('æ²¡æœ‰æƒé™')
      next(`/user/login?redirect=${to.fullPath}`)
      return
    }
  }
  next()
})
```

æ³¨æ„ï¼Œä¸Šè¿°ä»£ç ä¸­ï¼Œæˆ‘ä»¬ä¸ºäº†ç¡®ä¿é¡µé¢åˆ·æ–°æ—¶ï¼Œä»åç«¯æ‹¿åˆ°ç”¨æˆ·ä¿¡æ¯åå†è¿›è¡Œæƒé™æ ¡éªŒï¼Œä½¿ç”¨ await ç­‰å¾…åç«¯æ¥å£è¿”å›ï¼Œå¹¶é‡æ–°èµ‹å€¼ç»™ loginUserã€‚åŒæ—¶ï¼Œä¸ºäº†é˜²æ­¢æ¯æ¬¡åˆ‡æ¢è·¯ç”±éƒ½ä»è¿œç¨‹è·å–ç”¨æˆ·ä¿¡æ¯ï¼Œå®šä¹‰äº† firstFetchLoginUser å˜é‡ï¼Œç”¨äºæ§åˆ¶åœ¨åˆ·æ–°é¡µé¢ååªä¼šè¯·æ±‚åç«¯ä¸€æ¬¡ã€‚

ğŸ’¡ ç”±äºåœ¨ access.ts ä¸­å·²ç»è·å–åˆ°äº†ç™»å½•ç”¨æˆ·ä¿¡æ¯ï¼Œå¯ä»¥ç§»é™¤æ‰ä¹‹å‰åœ¨ App.vue ä¸­è·å–ç™»å½•ç”¨æˆ·ä¿¡æ¯çš„é€»è¾‘ï¼Œé¿å…é‡å¤è¯·æ±‚ã€‚

åœ¨ main.tsï¼ˆå…¨å±€å…¥å£æ–‡ä»¶ï¼‰ä¸­å¼•å…¥ï¼š

```tsx
import '@/access'
```

ç”¨ä¸€ä¸ªæœªç™»å½•çš„ç”¨æˆ·æ¥æµ‹è¯•ï¼Œå°è¯•è®¿é—®ç”¨æˆ·ç®¡ç†é¡µé¢ï¼Œä¼šæŠ¥æƒé™é”™è¯¯å¹¶è·³è½¬åˆ°ç™»å½•é¡µï¼š

![img](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMIAAADDCAYAAADQvc6UAAABRWlDQ1BJQ0MgUHJvZmlsZQAAKJFjYGASSSwoyGFhYGDIzSspCnJ3UoiIjFJgf8LAwSDCIMogwMCcmFxc4BgQ4ANUwgCjUcG3awyMIPqyLsis7PPOq3QdDFcvjV3jOD1boQVTPQrgSkktTgbSf4A4LbmgqISBgTEFyFYuLykAsTuAbJEioKOA7DkgdjqEvQHEToKwj4DVhAQ5A9k3gGyB5IxEoBmML4BsnSQk8XQkNtReEOBxcfXxUQg1Mjc0dyHgXNJBSWpFCYh2zi+oLMpMzyhRcASGUqqCZ16yno6CkYGRAQMDKMwhqj/fAIcloxgHQqxAjIHBEugw5sUIsSQpBobtQPdLciLEVJYzMPBHMDBsayhILEqEO4DxG0txmrERhM29nYGBddr//5/DGRjYNRkY/l7////39v///y4Dmn+LgeHANwDrkl1AuO+pmgAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAwqADAAQAAAABAAAAwwAAAAD9b/HnAAAHlklEQVR4Ae3dP3PTWBSGcbGzM6GCKqlIBRV0dHRJFarQ0eUT8LH4BnRU0NHR0UEFVdIlFRV7TzRksomPY8uykTk/zewQfKw/9znv4yvJynLv4uLiV2dBoDiBf4qP3/ARuCRABEFAoBEgghggQAQZQKAnYEaQBAQaASKIAQJEkAEEegJmBElAoBEgghggQAQZQKAnYEaQBAQaASKIAQJEkAEEegJmBElAoBEgghggQAQZQKAnYEaQBAQaASKIAQJEkAEEegJmBElAoBEgghggQAQZQKAnYEaQBAQaASKIAQJEkAEEegJmBElAoBEgghggQAQZQKAnYEaQBAQaASKIAQJEkAEEegJmBElAoBEgghggQAQZQKAnYEaQBAQaASKIAQJEkAEEegJmBElAoBEgghggQAQZQKAnYEaQBAQaASKIAQJEkAEEegJmBElAoBEgghggQAQZQKAnYEaQBAQaASKIAQJEkAEEegJmBElAoBEgghggQAQZQKAnYEaQBAQaASKIAQJEkAEEegJmBElAoBEgghggQAQZQKAnYEaQBAQaASKIAQJEkAEEegJmBElAoBEgghggQAQZQKAnYEaQBAQaASKIAQJEkAEEegJmBElAoBEgghggQAQZQKAnYEaQBAQaASKIAQJEkAEEegJmBElAoBEgghgg0Aj8i0JO4OzsrPv69Wv+hi2qPHr0qNvf39+iI97soRIh4f3z58/u7du3SXX7Xt7Z2enevHmzfQe+oSN2apSAPj09TSrb+XKI/f379+08+A0cNRE2ANkupk+ACNPvkSPcAAEibACyXUyfABGm3yNHuAECRNgAZLuYPgEirKlHu7u7XdyytGwHAd8jjNyng4OD7vnz51dbPT8/7z58+NB9+/bt6jU/TI+AGWHEnrx48eJ/EsSmHzx40L18+fLyzxF3ZVMjEyDCiEDjMYZZS5wiPXnyZFbJaxMhQIQRGzHvWR7XCyOCXsOmiDAi1HmPMMQjDpbpEiDCiL358eNHurW/5SnWdIBbXiDCiA38/Pnzrce2YyZ4//59F3ePLNMl4PbpiL2J0L979+7yDtHDhw8vtzzvdGnEXdvUigSIsCLAWavHp/+qM0BcXMd/q25n1vF57TYBp0a3mUzilePj4+7k5KSLb6gt6ydAhPUzXnoPR0dHl79WGTNCfBnn1uvSCJdegQhLI1vvCk+fPu2ePXt2tZOYEV6/fn31dz+shwAR1sP1cqvLntbEN9MxA9xcYjsxS1jWR4AIa2Ibzx0tc44fYX/16lV6NDFLXH+YL32jwiACRBiEbf5KcXoTIsQSpzXx4N28Ja4BQoK7rgXiydbHjx/P25TaQAJEGAguWy0+2Q8PD6/Ki4R8EVl+bzBOnZY95fq9rj9zAkTI2SxdidBHqG9+skdw43borCXO/ZcJdraPWdv22uIEiLA4q7nvvCug8WTqzQveOH26fodo7g6uFe/a17W3+nFBAkRYENRdb1vkkz1CH9cPsVy/jrhr27PqMYvENYNlHAIesRiBYwRy0V+8iXP8+/fvX11Mr7L7ECueb/r48eMqm7FuI2BGWDEG8cm+7G3NEOfmdcTQw4h9/55lhm7DekRYKQPZF2ArbXTAyu4kDYB2YxUzwg0gi/41ztHnfQG26HbGel/crVrm7tNY+/1btkOEAZ2M05r4FB7r9GbAIdxaZYrHdOsgJ/wCEQY0J74TmOKnbxxT9n3FgGGWWsVdowHtjt9Nnvf7yQM2aZU/TIAIAxrw6dOnAWtZZcoEnBpNuTuObWMEiLAx1HY0ZQJEmHJ3HNvGCBBhY6jtaMoEiJB0Z29vL6ls58vxPcO8/zfrdo5qvKO+d3Fx8Wu8zf1dW4p/cPzLly/dtv9Ts/EbcvGAHhHyfBIhZ6NSiIBTo0LNNtScABFyNiqFCBChULMNNSdAhJyNSiECRCjUbEPNCRAhZ6NSiAARCjXbUHMCRMjZqBQiQIRCzTbUnAARcjYqhQgQoVCzDTUnQIScjUohAkQo1GxDzQkQIWejUogAEQo121BzAkTI2agUIkCEQs021JwAEXI2KoUIEKFQsw01J0CEnI1KIQJEKNRsQ80JECFno1KIABEKNdtQcwJEyNmoFCJAhELNNtScABFyNiqFCBChULMNNSdAhJyNSiECRCjUbEPNCRAhZ6NSiAARCjXbUHMCRMjZqBQiQIRCzTbUnAARcjYqhQgQoVCzDTUnQIScjUohAkQo1GxDzQkQIWejUogAEQo121BzAkTI2agUIkCEQs021JwAEXI2KoUIEKFQsw01J0CEnI1KIQJEKNRsQ80JECFno1KIABEKNdtQcwJEyNmoFCJAhELNNtScABFyNiqFCBChULMNNSdAhJyNSiECRCjUbEPNCRAhZ6NSiAARCjXbUHMCRMjZqBQiQIRCzTbUnAARcjYqhQgQoVCzDTUnQIScjUohAkQo1GxDzQkQIWejUogAEQo121BzAkTI2agUIkCEQs021JwAEXI2KoUIEKFQsw01J0CEnI1KIQJEKNRsQ80JECFno1KIABEKNdtQcwJEyNmoFCJAhELNNtScABFyNiqFCBChULMNNSdAhJyNSiEC/wGgKKC4YMA4TAAAAABJRU5ErkJggg==)

è™½ç„¶å·²ç»æ»¡è¶³äº†éœ€æ±‚ï¼Œä½†æ˜¯å¦‚æœç”¨æˆ·ä¸æ˜¯ç®¡ç†å‘˜ï¼Œå…¶å®ä¹Ÿä¸åº”è¯¥çœ‹åˆ° â€œç”¨æˆ·ç®¡ç†â€ èœå•ã€‚å› æ­¤æˆ‘ä»¬è¿˜è¦ä¿®æ”¹ GlobalHeader èœå•é¡¹é…ç½®ï¼Œæ ¹æ®æƒé™å†³å®šæ˜¯å¦å±•ç¤ºæŸäº›èœå•é¡¹ã€‚

ç¼–å†™ä¸€ä¸ªè¿‡æ»¤èœå•é¡¹çš„å‡½æ•°ï¼š

```tsx
// èœå•åˆ—è¡¨
const originItems = [
  {
    key: '/',
    icon: () => h(HomeOutlined),
    label: 'ä¸»é¡µ',
    title: 'ä¸»é¡µ',
  },
  {
    key: '/admin/userManage',
    label: 'ç”¨æˆ·ç®¡ç†',
    title: 'ç”¨æˆ·ç®¡ç†',
  },
  {
    key: 'others',
    label: h('a', { href: 'https://www.codefather.cn', target: '_blank' }, 'ç¼–ç¨‹å¯¼èˆª'),
    title: 'ç¼–ç¨‹å¯¼èˆª',
  },
]

// è¿‡æ»¤èœå•é¡¹
const filterMenus = (menus = [] as MenuProps['items']) => {
  return menus?.filter((menu) => {
    if (menu.key.startsWith('/admin')) {
      const loginUser = loginUserStore.loginUser
      if (!loginUser || loginUser.userRole !== "admin") {
        return false
      }
    }
    return true
  })
}

// å±•ç¤ºåœ¨èœå•çš„è·¯ç”±æ•°ç»„
const items = computed<MenuProps['items']>(() => filterMenus(originItems))
```

æµ‹è¯•æ•ˆæœï¼Œæœªç™»å½•æ—¶ä¸ä¼šçœ‹åˆ° â€œç”¨æˆ·ç®¡ç†â€ èœå•ï¼š

![img](./assets/l22vo6kvBVO2mL0D.webp)

### æ‰©å±•

#### 1ã€ç¼–è¾‘ç”¨æˆ·ä¿¡æ¯

1ï¼‰ç›®å‰çš„ç”¨æˆ·ç®¡ç†é¡µé¢è¿˜ä¸æ”¯æŒç¼–è¾‘åŠŸèƒ½ï¼Œå‰ç«¯å¯ä»¥åˆ©ç”¨ [ç»„ä»¶åº“æ–‡æ¡£](https://antdv.com/components/table-cn#components-table-demo-edit-row) çš„ç¼–è¾‘è¡Œèƒ½åŠ›å¿«é€Ÿå®Œæˆã€‚

2ï¼‰ç›®å‰ç”¨æˆ·æ— æ³•ç¼–è¾‘ä¸ªäººçš„ä¿¡æ¯ï¼Œå¯ä»¥åœ¨å³ä¸Šè§’å¢åŠ  â€œä¸ªäººä¸­å¿ƒ / ä¸ªäººè®¾ç½®â€ï¼Œç‚¹å‡»åè¿›å…¥ç¼–è¾‘ç”¨æˆ·ä¿¡æ¯çš„è¡¨å•ã€‚

#### 2ã€å…¨å±€æƒé™ç®¡ç†

åœ¨æœ¬èŠ‚ â€œç”¨æˆ·æƒé™æ§åˆ¶â€ éƒ¨åˆ†ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†ä¸€ç§è¾ƒä¸ºç®€å•çš„æ–¹å¼å®ç°ï¼Œä½†æ˜¯ï¼Œåç»­è¡¥å……é¡µé¢å’Œæƒé™æ ¡éªŒé€»è¾‘æ—¶ï¼Œæˆ‘ä»¬è¦åŒæ—¶ä¿®æ”¹æƒé™ç®¡ç†æ–‡ä»¶å’Œå¯¼èˆªæ æ–‡ä»¶ï¼Œç›¸å½“äºç»´æŠ¤äº† 2 ä¸ªæ–‡ä»¶ï¼Œæ¯”è¾ƒéº»çƒ¦ï¼Œæœ‰æ²¡æœ‰æ›´å¥½çš„åŠæ³•å‘¢ï¼Ÿ

éœ€æ±‚ï¼šèƒ½å¤Ÿé€šè¿‡ç»´æŠ¤ **ä¸€ä¸ªé…ç½®æ–‡ä»¶**ï¼Œçµæ´»é…ç½®æ¯ä¸ªé¡µé¢æ‰€éœ€è¦çš„ç”¨æˆ·æƒé™ï¼Œç”±å…¨å±€æƒé™ç®¡ç†ç³»ç»Ÿè‡ªåŠ¨æ ¡éªŒå’Œæ‹¦æˆªï¼Œè€Œä¸éœ€è¦åœ¨æ¯ä¸ªé¡µé¢ä¸­ç¼–å†™æƒé™æ ¡éªŒä»£ç ï¼Œæé«˜å¼€å‘æ•ˆç‡ã€‚æ­¤å¤–ï¼Œè¿˜èƒ½æ ¹æ®è¯¥é…ç½®æ–‡ä»¶è‡ªåŠ¨éšè—æ²¡æƒé™çš„èœå•é¡¹çš„å±•ç¤ºã€‚

å®ç°æ–¹æ¡ˆï¼š

1. åœ¨è·¯ç”±é…ç½®æ–‡ä»¶ï¼Œåˆ©ç”¨ Vue Router çš„ meta é™„åŠ å‚æ•°ï¼Œå®šä¹‰æŸä¸ªè·¯ç”±çš„è®¿é—®æƒé™
2. ä½¿ç”¨å…¨å±€è·¯ç”±ç›‘å¬å™¨ï¼Œæ¯æ¬¡è®¿é—®é¡µé¢æ—¶ï¼Œæ ¹æ®ç”¨æˆ·è¦è®¿é—®é¡µé¢çš„è·¯ç”±æƒé™ä¿¡æ¯ï¼Œåˆ¤æ–­ç”¨æˆ·æ˜¯å¦æœ‰å¯¹åº”çš„è®¿é—®æƒé™ï¼Œå¹¶è¿›è¡Œç›¸åº”çš„æ‹¦æˆªå¤„ç†ã€‚

éœ€è¦å…ˆè‡ªè¡Œæ–°å»º NoAuth æ— æƒé™é¡µé¢ï¼Œå†…å®¹éšä¾¿å†™ï¼Œæ¯”å¦‚æ˜¾ç¤º â€œä½ æ²¡æœ‰æƒé™â€ã€‚

æ–°å»º access ç›®å½•ï¼Œæ‰€æœ‰æƒé™ç®¡ç†ç›¸å…³çš„ä»£ç éƒ½æ”¾åœ¨è¯¥ç›®å½•ä¸‹ï¼Œæ¨¡å—åŒ–ã€‚åªè¦ä¸å¼•å…¥ï¼Œå°±ä¸ä¼šç”Ÿæ•ˆã€‚sqWmWUk8kFL4uPey9+8ro5dv7g8fCeOwW9uL7T8/Q4k=

1ï¼‰å®šä¹‰æƒé™æšä¸¾æ–‡ä»¶ accessEnum.tsï¼š

```typescript
/**
 * æƒé™å®šä¹‰
 */
const ACCESS_ENUM = {
  NOT_LOGIN: "notLogin",
  USER: "user",
  ADMIN: "admin",
};

export default ACCESS_ENUM;
```

2ï¼‰ä¿®æ”¹è·¯ç”±é…ç½®æ–‡ä»¶ï¼Œåœ¨ meta ä¸­è¡¥å……éœ€è¦çš„æƒé™ï¼š

```typescript
{
  path: '/admin/userManage',
  name: 'adminUserManage',
  component: UserManagePage,
  meta: {
    access: ACCESS_ENUM.ADMIN,
  },
},
```

3ï¼‰ç¼–å†™é€šç”¨çš„æƒé™æ ¡éªŒæ–¹æ³•ã€‚

Qï¼šä¸ºä»€ä¹ˆï¼Ÿ

Aï¼šå› ä¸ºèœå•ç»„ä»¶ä¸­è¦åˆ¤æ–­æƒé™æ¥è¿‡æ»¤å±•ç¤ºçš„èœå•é¡¹ã€æƒé™æ‹¦æˆªä¹Ÿè¦ç”¨åˆ°æƒé™åˆ¤æ–­åŠŸèƒ½ï¼Œæ‰€ä»¥æŠ½ç¦»æˆå…¬å…±æ¨¡å—ã€‚

checkAccess.ts æ–‡ä»¶ï¼š

```typescript
import ACCESS_ENUM from "@/access/accessEnum";

/**
 * æ£€æŸ¥æƒé™ï¼ˆåˆ¤æ–­å½“å‰ç™»å½•ç”¨æˆ·æ˜¯å¦å…·æœ‰æŸä¸ªæƒé™ï¼‰
 * @param loginUser å½“å‰ç™»å½•ç”¨æˆ·
 * @param needAccess éœ€è¦æœ‰çš„æƒé™
 * @return boolean æœ‰æ— æƒé™
 */
const checkAccess = (loginUser: any, needAccess = ACCESS_ENUM.NOT_LOGIN) => {
  // è·å–å½“å‰ç™»å½•ç”¨æˆ·å…·æœ‰çš„æƒé™ï¼ˆå¦‚æœæ²¡æœ‰ loginUserï¼Œåˆ™è¡¨ç¤ºæœªç™»å½•ï¼‰
  const loginUserAccess = loginUser?.userRole ?? ACCESS_ENUM.NOT_LOGIN;
  if (needAccess === ACCESS_ENUM.NOT_LOGIN) {
    return true;
  }
  // å¦‚æœç”¨æˆ·ç™»å½•æ‰èƒ½è®¿é—®
  if (needAccess === ACCESS_ENUM.USER) {
    // å¦‚æœç”¨æˆ·æ²¡ç™»å½•ï¼Œé‚£ä¹ˆè¡¨ç¤ºæ— æƒé™
    if (loginUserAccess === ACCESS_ENUM.NOT_LOGIN) {
      return false;
    }
  }
  // å¦‚æœéœ€è¦ç®¡ç†å‘˜æƒé™
  if (needAccess === ACCESS_ENUM.ADMIN) {
    // å¦‚æœä¸ä¸ºç®¡ç†å‘˜ï¼Œè¡¨ç¤ºæ— æƒé™
    if (loginUserAccess !== ACCESS_ENUM.ADMIN) {
      return false;
    }
  }
  return true;
};

export default checkAccess;
```

4ï¼‰ç¼–å†™å…¨å±€æƒé™æ ¡éªŒæ ¸å¿ƒæ–‡ä»¶ `access/index.ts`ã€‚

é€»è¾‘å¦‚ä¸‹ï¼š

1. é¦–å…ˆåˆ¤æ–­é¡µé¢æ˜¯å¦éœ€è¦ç™»å½•æƒé™ï¼Œå¦‚æœä¸éœ€è¦ï¼Œç›´æ¥æ”¾è¡Œã€‚
2. å¦‚æœé¡µé¢éœ€è¦ç™»å½•æƒé™
   1. å¦‚æœç”¨æˆ·æœªç™»å½•ï¼Œåˆ™è·³è½¬åˆ°ç™»å½•é¡µé¢ã€‚
   2. å¦‚æœå·²ç™»å½•ï¼Œåˆ¤æ–­ç™»å½•ç”¨æˆ·çš„æƒé™æ˜¯å¦ç¬¦åˆè¦æ±‚ï¼Œå¦åˆ™è·³è½¬åˆ° 401 æ— æƒé™é¡µé¢ã€‚

å®ç°ä»£ç å¦‚ä¸‹ï¼š

```typescript
import router from '@/router'
import { useLoginUserStore } from '@/stores/useLoginUserStore'
import ACCESS_ENUM from './accessEnum'
import checkAccess from './checkAccess'

router.beforeEach(async (to, from, next) => {
  const loginUserStore = useLoginUserStore()
  let loginUser = loginUserStore.loginUser
  console.log('ç™»é™†ç”¨æˆ·ä¿¡æ¯', loginUser)
  const needAccess = (to.meta?.access as string) ?? ACCESS_ENUM.NOT_LOGIN
  // è¦è·³è½¬çš„é¡µé¢å¿…é¡»è¦ç™»é™†
  if (needAccess !== ACCESS_ENUM.NOT_LOGIN) {
    // å¦‚æœæ²¡ç™»é™†ï¼Œè·³è½¬åˆ°ç™»å½•é¡µé¢
    if (!loginUser || !loginUser.userRole || loginUser.userRole === ACCESS_ENUM.NOT_LOGIN) {
      next(`/user/login?redirect=${to.fullPath}`)
      return
    }
    // å¦‚æœå·²ç»ç™»é™†äº†ï¼Œä½†æ˜¯æƒé™ä¸è¶³ï¼Œé‚£ä¹ˆè·³è½¬åˆ°æ— æƒé™é¡µé¢
    if (!checkAccess(loginUser, needAccess)) {
      next('/noAuth')
      return
    }
  }
  next()
})
```

æ³¨æ„ï¼Œå¿…é¡»ä¿è¯ pinia åˆå§‹åŒ–åœ¨è¿™æ®µä»£ç æ‰§è¡Œå‰ï¼Œæ‰€ä»¥éœ€è¦å°† `useLoginUserStore()` å‡½æ•°æ”¾åˆ° `router.beforeEach` å‚æ•°é‡Œã€‚bgMhj83Bt96lFcj29lBZCF0o0+YPCGWOWUw0OPyFB/Q=

å‚è€ƒï¼šhttps://pinia.vuejs.org/core-concepts/outside-component-usage.html

åœ¨ main.ts ä¸­å¼•å…¥ï¼Œå³å¯ç”Ÿæ•ˆæƒé™æ ¡éªŒï¼š

```plain
import "@/access";
```

5ï¼‰æ”¯æŒå…¨å±€è‡ªåŠ¨ç™»å½•ã€‚å¦‚æœæ˜¯ **é¦–æ¬¡ **è¿›å…¥é¡µé¢ï¼ŒçŠ¶æ€ä¸ºæœªç™»é™†ï¼Œåˆ™è‡ªåŠ¨ç™»å½•ã€‚

å¦‚ä½•åŒºåˆ«æ˜¯å¦ä¸ºé¦–æ¬¡è¿›å…¥é¡µé¢ï¼ˆè¿˜æ²¡å°è¯•è¿‡è·å–ç™»å½•ç”¨æˆ·ï¼‰å‘¢ï¼Ÿ

é»˜è®¤çš„ loginUser æ˜¯æ²¡æœ‰ userRole çš„ï¼Œåªè¦è·å–è¿‡ï¼Œå“ªæ€•æœªç™»å½•ï¼Œä¹Ÿå¯ä»¥ç»™è®¾ç½®ä¸€ä¸ª userRole ä¸º "notLogin"ã€‚6vlRn/br/m8Ymr8D02hZYIBP3pqlW5Sp8qJklXCk9AY=

åœ¨ `access/index.ts` å¼€å¤´è¡¥å……è‡ªåŠ¨ç™»å½•é€»è¾‘

```typescript
// // å¦‚æœä¹‹å‰æ²¡ç™»é™†è¿‡ï¼Œè‡ªåŠ¨ç™»å½•
if (!loginUser || !loginUser.userRole) {
  // åŠ  await æ˜¯ä¸ºäº†ç­‰ç”¨æˆ·ç™»å½•æˆåŠŸä¹‹åï¼Œå†æ‰§è¡Œåç»­çš„ä»£ç 
  await loginUserStore.fetchLoginUser();
  loginUser = loginUserStore.loginUser;
}
```

ä¹‹åè®°å¾—ç§»é™¤ App.vue ä¸­è·å–ç™»å½•ä¿¡æ¯çš„è°ƒç”¨ã€‚

6ï¼‰æ ¹æ®æƒé™æ§åˆ¶èœå•æ˜¾éšã€‚

éœ€æ±‚ï¼šåªæœ‰å…·æœ‰æƒé™çš„èœå•ï¼Œæ‰å¯¹ç”¨æˆ·å¯è§

åŸç†ï¼š/MBNmaRtUhzDE9b4tB/jsqs1ClvvhzK+S4KVLPihc/I=

1. éå†åŸèœå•é¡¹åˆ—è¡¨ï¼Œé’ˆå¯¹èœå• key å¯¹åº”çš„ path è·¯å¾„ï¼Œæ‰¾åˆ°è·¯ç”±ä¸­å¯¹åº”çš„ meta æƒé™é…ç½®ã€‚åªè¦åˆ¤æ–­ç”¨æˆ·æ²¡æœ‰è¿™ä¸ªæƒé™ï¼Œå°±ç›´æ¥è¿‡æ»¤æ‰ã€‚
2. è¿˜å¯ä»¥é€šè¿‡åœ¨è·¯ç”±é…ç½®çš„ meta ä¸­æ·»åŠ  hideInMenuï¼Œçµæ´»æ§åˆ¶èœå•çš„æ˜¾éšã€‚

ä¿®æ”¹ GlobalHeader å…¨å±€å¯¼èˆªæ ï¼ˆé€šç”¨èœå•ï¼‰ç»„ä»¶ï¼Œè¡¥å……æ ¹æ®æƒé™æ¥è¿‡æ»¤èœå•çš„é€»è¾‘ï¼Œå¯è‡ªè¡Œå®ç°ã€‚

```typescript
// è¿‡æ»¤èœå•é¡¹
const items = menus.filter((menu) => {
  // todo éœ€è¦è‡ªå·±å®ç° menu åˆ°è·¯ç”± item çš„è½¬åŒ–
  const item = menuToRouteItem(menu);
  if (item.meta?.hideInMenu) {
    return false;
  }
  // æ ¹æ®æƒé™è¿‡æ»¤èœå•ï¼Œæœ‰æƒé™åˆ™è¿”å› trueï¼Œåˆ™ä¿ç•™è¯¥èœå•
  return checkAccess(loginUserStore.loginUser, item.meta?.access as string);
});
```







# 4 - å›¾ç‰‡æ¨¡å—

## æœ¬èŠ‚é‡ç‚¹

æœ¬èŠ‚æˆ‘ä»¬å°†å¼€å‘å®ç°å…¬å…±å›¾åº“å¹³å°çš„æ ¸å¿ƒä¸šåŠ¡æµç¨‹ã€‚æœ¬èŠ‚æ•™ç¨‹å¯ä»¥å½“åšä¸€ä¸ª **å›¾ç‰‡åˆ†äº«å¹³å°** ç‹¬ç«‹å­¦ä¹ ï¼Œé€‚åˆæ–°æ‰‹å…¥é—¨ã€‚æœ¬èŠ‚é‡ç‚¹éœ€è¦æŒæ¡æ–‡ä»¶ä¸Šä¼ ä¸‹è½½åŠŸèƒ½çš„å¼€å‘ï¼Œåç«¯å’Œå‰ç«¯éƒ¨åˆ†ä¹Ÿå¯ä»¥æŒ‰éœ€ç‹¬ç«‹å­¦ä¹ ã€‚

æœ¬èŠ‚å¤§çº²ï¼š

- éœ€æ±‚åˆ†æ
- æ–¹æ¡ˆè®¾è®¡
- åç«¯å¼€å‘
  - æ–‡ä»¶ä¸Šä¼ ä¸‹è½½èƒ½åŠ›
- å‰ç«¯å¼€å‘

## ä¸€ã€éœ€æ±‚åˆ†æ

åœ¨è®¾è®¡å›¾åº“ç³»ç»Ÿæ—¶ï¼Œè¦ä¼˜å…ˆç¡®ä¿ç”¨æˆ·èƒ½å¤ŸæŸ¥çœ‹å›¾ç‰‡åŠŸèƒ½çš„å®ç°ï¼Œè€Œä¸Šä¼ åŠŸèƒ½æš‚æ—¶ä»…é™ç®¡ç†å‘˜ä½¿ç”¨ï¼Œä»¥ä¿è¯ç³»ç»Ÿçš„å®‰å…¨æ€§å’Œç¨³å®šæ€§ã€‚

åŸºäºè¿™ä¸€åŸåˆ™ï¼Œæˆ‘ä»¬å°†ä¼˜å…ˆå®ç°ä»¥ä¸‹åŠŸèƒ½ï¼Œå¹¶æŒ‰ä¼˜å…ˆçº§æ’åˆ—å¦‚ä¸‹ï¼š

1ï¼‰ç®¡ç†å‘˜åŠŸèƒ½

- å›¾ç‰‡ä¸Šä¼ ä¸åˆ›å»º
- å›¾ç‰‡ç®¡ç†
- å›¾ç‰‡ä¿®æ”¹ï¼ˆç¼–è¾‘ä¿¡æ¯ï¼‰

2ï¼‰ç”¨æˆ·åŠŸèƒ½

- æŸ¥çœ‹ä¸æœç´¢å›¾ç‰‡åˆ—è¡¨ï¼ˆä¸»é¡µï¼‰
- æŸ¥çœ‹å›¾ç‰‡è¯¦æƒ…ï¼ˆè¯¦æƒ…é¡µï¼‰
- å›¾ç‰‡ä¸‹è½½

å…·ä½“åˆ†ææ¯ä¸ªéœ€æ±‚ï¼š

1ï¼‰å›¾ç‰‡ä¸Šä¼ ä¸åˆ›å»ºï¼šä»…ç®¡ç†å‘˜å¯ç”¨ï¼Œæ”¯æŒé€‰æ‹©æœ¬åœ°å›¾ç‰‡ä¸Šä¼ ï¼Œå¹¶å¡«å†™ç›¸å…³ä¿¡æ¯ï¼Œå¦‚åç§°ã€ç®€ä»‹ã€æ ‡ç­¾ã€åˆ†ç±»ç­‰ã€‚ç³»ç»Ÿä¼šè‡ªåŠ¨è§£æå›¾ç‰‡çš„åŸºç¡€ä¿¡æ¯ï¼ˆå¦‚å®½é«˜å’Œæ ¼å¼ç­‰ï¼‰ï¼Œä¾¿äºæ£€ç´¢ã€‚

2ï¼‰å›¾ç‰‡ç®¡ç†ï¼šç®¡ç†å‘˜å¯ä»¥å¯¹å›¾åº“å†…çš„å›¾ç‰‡èµ„æºè¿›è¡Œç®¡ç†ï¼ŒåŒ…æ‹¬æŸ¥è¯¢å’Œåˆ é™¤ã€‚

3ï¼‰å›¾ç‰‡ä¿®æ”¹ï¼šç®¡ç†å‘˜å¯ä»¥å¯¹å›¾ç‰‡ä¿¡æ¯è¿›è¡Œç¼–è¾‘ï¼Œä¾‹å¦‚ä¿®æ”¹åç§°ã€ç®€ä»‹ã€æ ‡ç­¾ã€åˆ†ç±»ç­‰ã€‚

4ï¼‰æŸ¥çœ‹ä¸æœç´¢å›¾ç‰‡åˆ—è¡¨ï¼šç”¨æˆ·åœ¨ä¸»é¡µä¸Šå¯æŒ‰å…³é”®è¯æœç´¢å›¾ç‰‡ï¼Œå¹¶æ”¯æŒæŒ‰åˆ†ç±»ã€æ ‡ç­¾ç­‰ç­›é€‰æ¡ä»¶åˆ†é¡µæŸ¥çœ‹å›¾ç‰‡åˆ—è¡¨ã€‚

5ï¼‰æŸ¥çœ‹å›¾ç‰‡è¯¦æƒ…ï¼šç”¨æˆ·ç‚¹å‡»åˆ—è¡¨ä¸­çš„å›¾ç‰‡åï¼Œå¯è¿›å…¥è¯¦æƒ…é¡µï¼ŒæŸ¥çœ‹å›¾ç‰‡çš„å¤§å›¾åŠç›¸å…³ä¿¡æ¯ï¼Œå¦‚åç§°ã€ç®€ä»‹ã€åˆ†ç±»ã€æ ‡ç­¾ã€å…¶ä»–å›¾ç‰‡ä¿¡æ¯ï¼ˆå¦‚å®½é«˜å’Œæ ¼å¼ç­‰ï¼‰ã€‚

6ï¼‰å›¾ç‰‡ä¸‹è½½ï¼šç”¨æˆ·åœ¨è¯¦æƒ…é¡µå¯ç‚¹å‡»ä¸‹è½½å›¾ç‰‡æŒ‰é’®ï¼Œå°†å›¾ç‰‡ä¿å­˜è‡³æœ¬åœ°ã€‚

## äºŒã€æ–¹æ¡ˆè®¾è®¡

æ–¹æ¡ˆè®¾è®¡é˜¶æ®µæˆ‘ä»¬éœ€è¦ç¡®è®¤ï¼š

- åº“è¡¨è®¾è®¡
- å¦‚ä½•å®ç°å›¾ç‰‡ä¸Šä¼ å’Œä¸‹è½½ï¼Ÿ
- åˆ›å»ºå›¾ç‰‡çš„ä¸šåŠ¡æµç¨‹
- å¦‚ä½•è§£æå›¾ç‰‡çš„ä¿¡æ¯ï¼Ÿ

### åº“è¡¨è®¾è®¡

è¡¨åï¼špictureï¼ˆå›¾ç‰‡è¡¨ï¼‰ï¼Œæ ¹æ®éœ€æ±‚å¯ä»¥åšå‡ºå¦‚ä¸‹ SQL è®¾è®¡ï¼š

```sql
-- å›¾ç‰‡è¡¨  
create table if not exists picture  
(  
    id           bigint auto_increment comment 'id' primary key,  
    url          varchar(512)                       not null comment 'å›¾ç‰‡ url',  
    name         varchar(128)                       not null comment 'å›¾ç‰‡åç§°',  
    introduction varchar(512)                       null comment 'ç®€ä»‹',  
    category     varchar(64)                        null comment 'åˆ†ç±»',  
    tags         varchar(512)                      null comment 'æ ‡ç­¾ï¼ˆJSON æ•°ç»„ï¼‰',  
    picSize      bigint                             null comment 'å›¾ç‰‡ä½“ç§¯',  
    picWidth     int                                null comment 'å›¾ç‰‡å®½åº¦',  
    picHeight    int                                null comment 'å›¾ç‰‡é«˜åº¦',  
    picScale     double                             null comment 'å›¾ç‰‡å®½é«˜æ¯”ä¾‹',  
    picFormat    varchar(32)                        null comment 'å›¾ç‰‡æ ¼å¼',  
    userId       bigint                             not null comment 'åˆ›å»ºç”¨æˆ· id',  
    createTime   datetime default CURRENT_TIMESTAMP not null comment 'åˆ›å»ºæ—¶é—´',  
    editTime     datetime default CURRENT_TIMESTAMP not null comment 'ç¼–è¾‘æ—¶é—´',  
    updateTime   datetime default CURRENT_TIMESTAMP not null on update CURRENT_TIMESTAMP comment 'æ›´æ–°æ—¶é—´',  
    isDelete     tinyint  default 0                 not null comment 'æ˜¯å¦åˆ é™¤',  
    INDEX idx_name (name),                 -- æå‡åŸºäºå›¾ç‰‡åç§°çš„æŸ¥è¯¢æ€§èƒ½  
    INDEX idx_introduction (introduction), -- ç”¨äºæ¨¡ç³Šæœç´¢å›¾ç‰‡ç®€ä»‹  
    INDEX idx_category (category),         -- æå‡åŸºäºåˆ†ç±»çš„æŸ¥è¯¢æ€§èƒ½  
    INDEX idx_tags (tags),                 -- æå‡åŸºäºæ ‡ç­¾çš„æŸ¥è¯¢æ€§èƒ½  
    INDEX idx_userId (userId)              -- æå‡åŸºäºç”¨æˆ· ID çš„æŸ¥è¯¢æ€§èƒ½  
) comment 'å›¾ç‰‡' collate = utf8mb4_unicode_ci;
```

å‡ ä¸ªæ³¨æ„äº‹é¡¹ï¼š

1ï¼‰å­—æ®µè®¾è®¡ï¼š

- åŸºç¡€ä¿¡æ¯ï¼šåŒ…æ‹¬å›¾ç‰‡çš„ URLã€åç§°ã€ç®€ä»‹ã€åˆ†ç±»ã€æ ‡ç­¾ç­‰ï¼Œæ»¡è¶³å›¾ç‰‡ç®¡ç†å’Œåˆ†ç±»ç­›é€‰çš„åŸºæœ¬éœ€æ±‚ã€‚
- å›¾ç‰‡å±æ€§ï¼šè®°å½•å›¾ç‰‡å¤§å°ã€åˆ†è¾¨ç‡ï¼ˆå®½åº¦ã€é«˜åº¦ï¼‰ã€å®½é«˜æ¯”å’Œæ ¼å¼ï¼Œæ–¹ä¾¿åç»­æŒ‰ç…§å¤šç§ç»´åº¦ç­›é€‰å›¾ç‰‡ã€‚
- ç”¨æˆ·å…³è”ï¼šé€šè¿‡ `userId` å­—æ®µå…³è”ç”¨æˆ·è¡¨ï¼Œè¡¨ç¤ºç”±å“ªä¸ªç”¨æˆ·åˆ›å»ºäº†è¯¥å›¾ç‰‡ã€‚
- å¤šä¸ªæ ‡ç­¾ï¼šç”±äºæ ‡ç­¾æ”¯æŒå¤šä¸ªå€¼ï¼Œä½¿ç”¨ JSON æ•°ç»„å­—ç¬¦ä¸²æ¥ç»´æŠ¤ï¼Œè€Œä¸æ˜¯å•ç‹¬æ–°å»ºä¸€ä¸ªè¡¨ï¼Œå¯ä»¥æé«˜å¼€å‘æ•ˆç‡ã€‚ç¤ºä¾‹æ ¼å¼ï¼š`["æ ‡ç­¾1", "æ ‡ç­¾2"]`

2ï¼‰æ—¶é—´å­—æ®µåŒºåˆ†ï¼š

- updateTimeï¼šä»»ä½•å­—æ®µçš„ä¿®æ”¹éƒ½ä¼šè§¦å‘æ•°æ®åº“è‡ªåŠ¨æ›´æ–°ï¼Œä¾¿äºè®°å½•æœ€æ–°å˜åŠ¨ã€‚**è¯¥å­—æ®µå¯ä»¥ä¸è®©ç”¨æˆ·çœ‹åˆ°**
- editTimeï¼šä¸“ç”¨äºè®°å½•å›¾ç‰‡ä¿¡æ¯è¢«ç¼–è¾‘çš„æ—¶é—´ï¼Œéœ€è¦é€šè¿‡ä¸šåŠ¡é€»è¾‘ä¸»åŠ¨æ›´æ–°ã€‚**è¯¥å­—æ®µå¯ä»¥å¯¹ç”¨æˆ·å…¬å¼€**

3ï¼‰ç´¢å¼•è®¾è®¡ï¼šä¸ºé«˜é¢‘æŸ¥è¯¢çš„å­—æ®µï¼ˆå¦‚å›¾ç‰‡åç§°ã€ç®€ä»‹ã€åˆ†ç±»ã€æ ‡ç­¾ã€ç”¨æˆ· idï¼‰æ·»åŠ ç´¢å¼•ï¼Œæé«˜æŸ¥è¯¢æ•ˆç‡ã€‚

4ï¼‰é€»è¾‘åˆ é™¤ï¼šä¹Ÿå°±æ˜¯ â€œè½¯åˆ é™¤â€ï¼Œä½¿ç”¨ `isDelete` å­—æ®µæ ‡è®°æ˜¯å¦åˆ é™¤ï¼Œé¿å…ç›´æ¥åˆ é™¤æ•°æ®å¯¼è‡´æ•°æ®ä¸å¯æ¢å¤é—®é¢˜

ğŸ’¡ ç´¢å¼•æ˜¯æ•°æ®åº“ä¼˜åŒ–çš„æ ¸å¿ƒæ‰‹æ®µï¼Œå¯¹äºæœ‰å¤§é‡æŸ¥è¯¢éœ€æ±‚çš„å­—æ®µï¼Œä¸è¦åå•¬ç´¢å¼•çš„æ·»åŠ ã€‚

å¦‚ä½•é€‰æ‹©åˆé€‚çš„å­—æ®µæ·»åŠ ç´¢å¼•ï¼Ÿè¿™æ˜¯ä¸€é“ç»å…¸çš„é¢è¯•é¢˜ï¼Œå¯ä»¥ [åœ¨é¢è¯•é¸­ä¸ŠæŸ¥çœ‹](https://www.mianshiya.com/question/1776483567317028866)ã€‚

### å¦‚ä½•å®ç°å›¾ç‰‡ä¸Šä¼ å’Œä¸‹è½½ï¼Ÿ

å›¾ç‰‡æœ¬è´¨ä¸Šæ˜¯ä¸€ç§ â€œå°å‹â€ æ–‡ä»¶ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¦æ€è€ƒï¼šå°†æ–‡ä»¶ä¸Šä¼ åˆ°å“ªé‡Œï¼Ÿä»å“ªé‡Œä¸‹è½½ï¼Ÿ

æœ€ç®€å•çš„æ–¹å¼å°±æ˜¯ä¸Šä¼ åˆ°åç«¯é¡¹ç›®æ‰€åœ¨çš„æœåŠ¡å™¨ï¼Œç›´æ¥ä½¿ç”¨ Java è‡ªå¸¦çš„æ–‡ä»¶è¯»å†™ API å°±èƒ½å®ç°ã€‚ä½†æ˜¯ï¼Œè¿™ç§æ–¹å¼å­˜åœ¨ä¸å°‘ç¼ºç‚¹ï¼Œæ¯”å¦‚ï¼š

1. ä¸åˆ©äºæ‰©å±•ï¼šå•ä¸ªæœåŠ¡å™¨çš„å­˜å‚¨æ˜¯æœ‰é™çš„ï¼Œå¦‚æœå­˜æ»¡äº†ï¼Œåªèƒ½å†æ–°å¢å­˜å‚¨ç©ºé—´æˆ–è€…æ¸…ç†æ–‡ä»¶ã€‚
2. ä¸åˆ©äºè¿ç§»ï¼šå¦‚æœåç«¯é¡¹ç›®è¦æ›´æ¢æœåŠ¡å™¨éƒ¨ç½²ï¼Œä¹‹å‰æ‰€æœ‰çš„æ–‡ä»¶éƒ½è¦è¿ç§»åˆ°æ–°æœåŠ¡å™¨ï¼Œéå¸¸éº»çƒ¦ã€‚
3. ä¸å¤Ÿå®‰å…¨ï¼šå¦‚æœå¿˜è®°æ§åˆ¶æƒé™ï¼Œç”¨æˆ·å¾ˆæœ‰å¯èƒ½é€šè¿‡æ¶æ„ä»£ç è®¿é—®æœåŠ¡å™¨ä¸Šçš„æ–‡ä»¶ï¼Œè€Œä¸”æƒ³æ§åˆ¶æƒé™ä¹Ÿæ¯”è¾ƒéº»çƒ¦ï¼Œéœ€è¦è‡ªå·±å®ç°ã€‚
4. ä¸åˆ©äºç®¡ç†ï¼šåªèƒ½é€šè¿‡ä¸€äº›æ–‡ä»¶ç®¡ç†å™¨è¿›è¡Œç®€å•çš„ç®¡ç†æ“ä½œï¼Œä½†æ˜¯ç¼ºä¹æ•°æ®å¤„ç†ã€æµé‡æ§åˆ¶ç­‰å¤šç§é«˜çº§èƒ½åŠ›ã€‚

å› æ­¤ï¼Œé™¤äº†å­˜å‚¨ä¸€äº›éœ€è¦æ¸…ç†çš„ä¸´æ—¶æ–‡ä»¶ä¹‹å¤–ï¼Œæˆ‘ä»¬é€šå¸¸ä¸ä¼šå°†ç”¨æˆ·ä¸Šä¼ å¹¶ä¿å­˜çš„æ–‡ä»¶ï¼ˆæ¯”å¦‚ç”¨æˆ·å¤´åƒå’Œå›¾ç‰‡ï¼‰ç›´æ¥ä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼Œè€Œæ˜¯æ›´æ¨èå¤§å®¶ä½¿ç”¨ä¸“ä¸šçš„ç¬¬ä¸‰æ–¹å­˜å‚¨æœåŠ¡ï¼Œä¸“ä¸šçš„å·¥å…·åšä¸“ä¸šçš„äº‹ã€‚å…¶ä¸­ï¼Œæœ€å¸¸ç”¨çš„ä¾¿æ˜¯ **å¯¹è±¡å­˜å‚¨** ã€‚

#### ä»€ä¹ˆæ˜¯å¯¹è±¡å­˜å‚¨ï¼Ÿ

å¯¹è±¡å­˜å‚¨æ˜¯ä¸€ç§å­˜å‚¨ **æµ·é‡æ–‡ä»¶** çš„ **åˆ†å¸ƒå¼** å­˜å‚¨æœåŠ¡ï¼Œå…·æœ‰é«˜æ‰©å±•æ€§ã€ä½æˆæœ¬ã€å¯é å®‰å…¨ç­‰ä¼˜ç‚¹ã€‚

æ¯”å¦‚å¼€æºçš„å¯¹è±¡å­˜å‚¨æœåŠ¡ MinIOï¼Œè¿˜æœ‰å•†ä¸šç‰ˆçš„äº‘æœåŠ¡ï¼Œåƒäºšé©¬é€Š S3ï¼ˆAmazon S3ï¼‰ã€é˜¿é‡Œäº‘å¯¹è±¡å­˜å‚¨ï¼ˆOSSï¼‰ã€è…¾è®¯äº‘å¯¹è±¡å­˜å‚¨ï¼ˆCOSï¼‰ç­‰ç­‰ã€‚

æˆ‘ä¸ªäººæ›´æ¨èå­¦ä¹ è€…å’Œå°å‹å›¢é˜Ÿä½¿ç”¨ç¬¬ä¸‰æ–¹äº‘æœåŠ¡ï¼Œä¸è¦è‡ªå·±å†å»æ­å»º MinIO ä¹‹ç±»çš„ï¼Œä¸»æ‰“ä¸€ä¸ªå¿«é€Ÿï¼

é±¼çš®ä½¿ç”¨æœ€å¤šçš„å¯¹è±¡å­˜å‚¨æœåŠ¡å½“å± **è…¾è®¯äº‘çš„ COS**ï¼Œé™¤äº†åŸºæœ¬çš„å¯¹è±¡å­˜å‚¨çš„ä¼˜ç‚¹å¤–ï¼Œè¿˜å¯ä»¥é€šè¿‡æ§åˆ¶å°ã€APIã€SDK å’Œå·¥å…·ç­‰å¤šæ ·åŒ–æ–¹å¼ï¼Œç®€å•å¿«é€Ÿåœ°æ¥å…¥ COSï¼Œè¿›è¡Œå¤šæ ¼å¼æ–‡ä»¶çš„ä¸Šä¼ ã€ä¸‹è½½å’Œç®¡ç†ï¼Œå®ç°æµ·é‡æ•°æ®å­˜å‚¨å’Œç®¡ç†ã€‚

æœ¬èŠ‚æ•™ç¨‹ä¸­ï¼Œå°±å°†ä½¿ç”¨è…¾è®¯äº‘ COS å¸¦å¤§å®¶å®ç°æ–‡ä»¶çš„ä¸Šä¼ å’Œä¸‹è½½ã€‚é±¼çš®ä¹‹å‰æ­å»ºçš„å›¾åºŠå°±æ˜¯ä½¿ç”¨äº† COS å¯¹è±¡å­˜å‚¨å®ç°ï¼Œå¾ˆç®€å•ã€‚

ğŸ’¡ å¯¹è±¡å­˜å‚¨ç­‰ç¬¬ä¸‰æ–¹äº‘æœåŠ¡é€šå¸¸æ˜¯ä»˜è´¹åŠŸèƒ½ï¼ŒæŒ‰ç…§å­˜å‚¨é‡ã€æµé‡ç­‰æ–¹å¼è®¡è´¹ã€‚ä¸è¿‡å¯¹äºå¤§å®¶å­¦ä¹ æ¥è¯´ï¼Œç”±äºå›¾ç‰‡å­˜å‚¨é‡å’Œè®¿é—®é‡ä¸å¤§ï¼Œä»·æ ¼éå¸¸ä¾¿å®œï¼ˆå‡ å…ƒ ~ å‡ åå…ƒï¼‰ï¼Œè€Œä¸”è¿˜æœ‰ä¸€å®šå…è´¹é¢åº¦ã€‚å¯ä»¥ç‚¹å‡» [é±¼çš®çš„åˆ†äº«é“¾æ¥](https://curl.qcloud.com/ke6zvAHm) ä¼˜æƒ è´­ä¹°ã€‚ä¸‹æ‹‰æ‰¾åˆ° **å…¨çº¿äº§å“**ï¼Œç‚¹å‡»å­˜å‚¨é¡µç­¾ï¼Œå°±èƒ½çœ‹åˆ°äº†ï¼š

![image](./assets/eeLexJ95zXXCPsAf.webp)

### åˆ›å»ºå›¾ç‰‡çš„ä¸šåŠ¡æµç¨‹

åˆ›å»ºå›¾ç‰‡å…¶å®åŒ…æ‹¬äº† 2 ä¸ªè¿‡ç¨‹ï¼šä¸Šä¼ å›¾ç‰‡æ–‡ä»¶ + è¡¥å……å›¾ç‰‡ä¿¡æ¯å¹¶ä¿å­˜åˆ°æ•°æ®åº“ä¸­

æœ‰ 2 ç§å¸¸è§çš„å¤„ç†æ–¹å¼ï¼š

1ï¼‰å…ˆä¸Šä¼ å†æäº¤æ•°æ®ï¼šç”¨æˆ·ç›´æ¥ä¸Šä¼ å›¾ç‰‡ï¼Œç³»ç»Ÿç”Ÿæˆå›¾ç‰‡çš„å­˜å‚¨ URLï¼›ç„¶ååœ¨ç”¨æˆ·å¡«å†™å…¶ä»–ç›¸å…³ä¿¡æ¯å¹¶æäº¤åï¼Œæ‰ä¿å­˜å›¾ç‰‡è®°å½•åˆ°æ•°æ®åº“ä¸­ã€‚

2ï¼‰ä¸Šä¼ å›¾ç‰‡æ—¶ç›´æ¥ä¿å­˜è®°å½•ï¼šåœ¨ç”¨æˆ·ä¸Šä¼ å›¾ç‰‡åï¼Œç³»ç»Ÿç«‹å³ç”Ÿæˆå›¾ç‰‡çš„å®Œæ•´æ•°æ®è®°å½•ï¼ˆåŒ…æ‹¬å›¾ç‰‡ URL å’Œå…¶ä»–å…ƒä¿¡æ¯ï¼‰ï¼Œæ— éœ€ç­‰å¾…ç”¨æˆ·ç‚¹å‡»æäº¤ï¼Œå›¾ç‰‡ä¿¡æ¯å°±ç«‹åˆ»å­˜å…¥äº†æ•°æ®åº“ä¸­ã€‚ä¹‹åç”¨æˆ·å†å¡«å†™å…¶ä»–å›¾ç‰‡ä¿¡æ¯ï¼Œç›¸å½“äºç¼–è¾‘äº†å·²æœ‰å›¾ç‰‡è®°å½•çš„ä¿¡æ¯ã€‚

æ–¹æ¡ˆ 1 çš„ä¼˜ç‚¹æ˜¯æµç¨‹ç®€å•ï¼Œä½†ç¼ºç‚¹æ˜¯å¦‚æœç”¨æˆ·ä¸æäº¤ï¼Œå›¾ç‰‡ä¼šæ®‹ç•™åœ¨å­˜å‚¨ä¸­ï¼Œå¯¼è‡´ç©ºé—´æµªè´¹ï¼›æ–¹æ¡ˆ 2 åˆ™å¯ä»¥ç†è§£ä¸ºä¿å­˜äº† â€œå›¾ç‰‡è‰ç¨¿â€ï¼Œå³ä½¿ç”¨æˆ·ä¸å¡«å†™ä»»ä½•é¢å¤–ä¿¡æ¯ï¼Œä¹Ÿèƒ½æ‰¾åˆ°ä¹‹å‰çš„åˆ›å»ºè®°å½•ã€‚

**åœ¨æˆ‘ä»¬çš„ç³»ç»Ÿä¸­ï¼Œç”±äºå›¾ç‰‡æ˜¯æ ¸å¿ƒèµ„æºï¼Œæ‰€ä»¥æ­¤å¤„é€‰æ‹©æ–¹æ¡ˆ 2ã€‚** ä¾¿äºå¯¹å›¾ç‰‡è¿›è¡Œæº¯æºï¼Œè¿˜å¯ä»¥å¯¹å›¾ç‰‡ä¸Šä¼ åšä¸€äº›é™åˆ¶ â€”â€” æ¯”å¦‚å‘ç°ç”¨æˆ·ä¸Šä¼ èµ„æºè¿‡å¤šï¼Œå°±ç¦æ­¢ä¸Šä¼ ã€‚

### å¦‚ä½•è§£æå›¾ç‰‡çš„ä¿¡æ¯ï¼Ÿ

æ ¹æ®éœ€æ±‚ï¼Œæˆ‘ä»¬è¦è·å–çš„å›¾ç‰‡ä¿¡æ¯åŒ…æ‹¬ï¼šå®½åº¦ã€é«˜åº¦ã€å®½é«˜æ¯”ã€å¤§å°ã€æ ¼å¼ã€åç§°ã€‚

ä¸»æµçš„è·å–å›¾ç‰‡ä¿¡æ¯çš„æ–¹æ³•ä¸»è¦æœ‰ 2 ç§ï¼š

1. åœ¨åç«¯æœåŠ¡å™¨ç›´æ¥å¤„ç†å›¾ç‰‡ï¼Œæ¯”å¦‚ Java åº“ ImageIOã€Python åº“ Pillowï¼Œè¿˜æœ‰æ›´æˆç†Ÿçš„ä¸“ä¸šå›¾åƒå¤„ç†åº“ OpenCV ç­‰ã€‚
2. é€šè¿‡ç¬¬ä¸‰æ–¹äº‘å­˜å‚¨æœåŠ¡ï¼ˆå¦‚è…¾è®¯äº‘ COSã€AWS S3ï¼‰æˆ–å›¾åƒå¤„ç† APIï¼ˆå¦‚ ImageMagickã€ExifToolï¼‰ç›´æ¥æå–å›¾ç‰‡çš„å…ƒæ•°æ®ã€‚

ç”±äºæœ¬æ•™ç¨‹ä¸­ä½¿ç”¨è…¾è®¯äº‘ COS å¯¹è±¡å­˜å‚¨æ¥å®ç°æ–‡ä»¶çš„ä¸Šä¼ å’Œä¸‹è½½ï¼Œè…¾è®¯äº‘ COS å¯¹è±¡å­˜å‚¨æ”¯æŒåœ¨å›¾ç‰‡ä¸Šä¼ æ—¶é€šè¿‡ [æ•°æ®ä¸‡è±¡](https://cloud.tencent.com/product/ci)** **æœåŠ¡ç›´æ¥è·å–åˆ°å›¾ç‰‡çš„å„ç§åŸºç¡€ä¿¡æ¯ï¼š

![image](./assets/YulwguCenpVcA5Sa.webp)

è¿™æ ·ä¸€æ¥ï¼Œæˆ‘ä»¬ä¸ç”¨å†å•ç‹¬å¼•å…¥ä¸€ä¸ªåº“æˆ–è€…è‡ªå·±ç¼–å†™è§£æä»£ç äº†ï¼Œæ›´æ–¹ä¾¿ï¼›è€Œä¸”æä¾›çš„å…è´¹é¢åº¦è¶³å¤Ÿç”¨äº†ï¼Œæ‰€ä»¥é‡‡ç”¨è¿™ç§æ–¹å¼ã€‚

![image](./assets/0u12Us8NYe89zhe3.webp)

------

OKï¼Œæœ‰äº†å®ç°æ–¹æ¡ˆåï¼Œæˆ‘ä»¬å…ˆæ¥å¼€å‘åç«¯æ¥å£ã€‚

## ä¸‰ã€åç«¯å¼€å‘

å…ˆå‡†å¤‡å¥½é¡¹ç›®æ‰€éœ€çš„ä¾èµ– â€”â€” å¯¹è±¡å­˜å‚¨ï¼Œç„¶åå†å¼€å‘æœåŠ¡å’Œæ¥å£ã€‚

### åˆ›å»ºå¹¶ä½¿ç”¨å¯¹è±¡å­˜å‚¨

é¦–å…ˆè¿›å…¥[å¯¹è±¡å­˜å‚¨çš„æ§åˆ¶å°](https://console.cloud.tencent.com/cos/bucket)ï¼Œåˆ›å»ºå­˜å‚¨æ¡¶ã€‚

å¯ä»¥æŠŠå­˜å‚¨æ¡¶ç†è§£ä¸ºä¸€ä¸ªå­˜å‚¨ç©ºé—´ï¼Œå’Œæ–‡ä»¶ç³»ç»Ÿç±»ä¼¼ï¼Œéƒ½æ˜¯æ ¹æ®è·¯å¾„æ‰¾åˆ°æ–‡ä»¶æˆ–ç›®å½•ï¼ˆæ¯”å¦‚ `/test/aaa.jpg`ï¼‰ã€‚å¯ä»¥å¤šä¸ªé¡¹ç›®å…±ç”¨ä¸€ä¸ªå­˜å‚¨æ¡¶ï¼Œä¹Ÿå¯ä»¥æ¯ä¸ªé¡¹ç›®ä¸€ä¸ªã€‚

ç‚¹å‡»åˆ›å»ºå­˜å‚¨æ¡¶ï¼Œæ³¨æ„åœ°åŸŸé€‰æ‹©å›½å†…ï¼ˆç¦»ç”¨æˆ·è¾ƒè¿‘çš„ä½ç½®ï¼‰ã€‚æ­¤å¤„è®¿é—®æƒé™å…ˆé€‰æ‹©â€œå…¬æœ‰è¯»ç§æœ‰å†™â€ï¼Œå› ä¸ºæˆ‘ä»¬çš„å­˜å‚¨æ¡¶è¦å­˜å‚¨å…è®¸ç”¨æˆ·å…¬å¼€è®¿é—®å›¾ç‰‡ã€‚è€Œå¦‚æœæ•´ä¸ªå­˜å‚¨æ¡¶è¦å­˜å‚¨çš„æ–‡ä»¶éƒ½ä¸å…è®¸ç”¨æˆ·è®¿é—®ï¼Œå»ºè®®é€‰æ‹©ç§æœ‰è¯»å†™ï¼Œæ›´å®‰å…¨ã€‚

é»˜è®¤å‘Šè­¦ä¸€å®šè¦å‹¾é€‰ï¼å› ä¸ºå¯¹è±¡å­˜å‚¨æœåŠ¡çš„å­˜å‚¨å’Œè®¿é—®æµé‡éƒ½æ˜¯è®¡è´¹çš„ï¼Œè¶…é™åæˆ‘ä»¬è¦ç¬¬ä¸€æ—¶é—´å¾—åˆ°é€šçŸ¥å¹¶è¿›è¡Œç›¸åº”çš„å¤„ç†ã€‚

> ä¸è¿‡ä¹Ÿä¸ç”¨å¤ªæ‹…å¿ƒï¼Œè‡ªå·±åšé¡¹ç›®çš„è¯ä¸€èˆ¬æ˜¯æ²¡äººæ”»å‡»ä½ çš„ï¼Œè€Œä¸”å¯¹è±¡å­˜å‚¨å¾ˆä¾¿å®œï¼Œæ­£å¸¸æƒ…å†µä¸‹æ¶ˆè€—çš„è´¹ç”¨å¯¥å¯¥æ— å‡ ã€‚

![image](./assets/bmNcn69SwhOFU2jT.webp)

ç„¶åä¸€ç›´ç‚¹å‡»â€œä¸‹ä¸€æ­¥â€å³å¯ï¼š

![image](./assets/SHLdqrX6OFK4B59M.webp)

å¼€é€šæˆåŠŸåï¼Œæˆ‘ä»¬å¯ä»¥è¯•ç€ä½¿ç”¨ web æ§åˆ¶å°ä¸Šä¼ å’Œæµè§ˆæ–‡ä»¶ï¼š

![image](./assets/93bLRBlijBqzEe60.webp)

ä¸Šä¼ æ–‡ä»¶åï¼Œå¯ä»¥ä½¿ç”¨å¯¹è±¡å­˜å‚¨æœåŠ¡ä¸ºæˆ‘ä»¬ç”Ÿæˆçš„é»˜è®¤åŸŸåï¼Œåœ¨çº¿è®¿é—®å›¾ç‰‡ï¼š

![image](./assets/rz8ztLbWTHpds3Mh.webp)

å½“ç„¶ï¼Œä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä»¬ä¼šä½¿ç”¨ç¨‹åºæ¥æ“ä½œå­˜å‚¨æ¡¶ï¼Œä¸‹é¢å°±æ¥å®ç°ã€‚

ğŸ’¡ ä½ å¯èƒ½æ³¨æ„åˆ°äº†ï¼Œç³»ç»Ÿæç¤ºæˆ‘ä»¬ â€œä½¿ç”¨é»˜è®¤åŸŸåâ€ æ˜¯é«˜é£é™©çš„ï¼Œå› ä¸ºå¯¹è±¡å­˜å‚¨çš„æºç«™åŸŸåé»˜è®¤æ˜¯ä¸æ”¯æŒæ›´æ¢çš„ï¼Œå¦‚æœæš´éœ²å‡ºå»è¢«æ”»å‡»è€…ç›¯ä¸Šäº†ï¼Œå¯èƒ½ä½ å°±åªèƒ½è¿ç§»åˆ°ä¸€ä¸ªæ–°çš„å­˜å‚¨æ¡¶äº†ã€‚æœ¬é¡¹ç›®æ•™ç¨‹åç»­ä¼šç»™å¤§å®¶åˆ†äº«æ›´å®‰å…¨çš„ä½¿ç”¨æ–¹å¼ã€‚

### åç«¯æ“ä½œå¯¹è±¡å­˜å‚¨

å¦‚ä½•åœ¨ Java ç¨‹åºä¸­ä½¿ç”¨å¯¹è±¡å­˜å‚¨å‘¢ï¼Ÿ

å…¶å®éå¸¸ç®€å•ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œç¬¬ä¸‰æ–¹æœåŠ¡éƒ½ä¼šæä¾›æ¯”è¾ƒè´´å¿ƒçš„æ–‡æ¡£æ•™ç¨‹ï¼Œæ¯”å¦‚è¿™é‡Œæˆ‘ä»¬å‚è€ƒ[å®˜æ–¹çš„å¿«é€Ÿå…¥é—¨æˆ– Java SDK æ–‡æ¡£](https://cloud.tencent.com/document/product/436/10199)ï¼Œå°±èƒ½å¿«é€Ÿå…¥é—¨åŸºæœ¬æ“ä½œï¼ˆå¢åˆ æ”¹æŸ¥éƒ½æœ‰ï¼‰ã€‚

è¿˜æœ‰æ›´é«˜çº§çš„å­¦ä¹ æ“ä½œæ–¹æ³•ï¼Œå¦‚æœä½ æ˜¯è…¾è®¯äº‘ç†Ÿç»ƒç”¨æˆ·ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ [API Explorer](https://console.cloud.tencent.com/api/explorer?Product=cos&Version=2018-11-26&Action=PutBucket)ï¼Œåœ¨çº¿å¯»æ‰¾æ“ä½œå’Œç¤ºä¾‹ä»£ç ã€‚

![image](./assets/udUsF7HaeCdbR4T2.webp)

#### 1ã€åˆå§‹åŒ–å®¢æˆ·ç«¯

å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼Œæˆ‘ä»¬è¦å…ˆåˆå§‹åŒ–ä¸€ä¸ª COS å®¢æˆ·ç«¯å¯¹è±¡ï¼Œå’Œå¯¹è±¡å­˜å‚¨æœåŠ¡è¿›è¡Œäº¤äº’ã€‚

![image](./assets/IofkqlxCEGxCohXj.webp)

å¯¹äºæˆ‘ä»¬çš„é¡¹ç›®ï¼Œåªéœ€è¦å¤ç”¨ä¸€ä¸ª COS å®¢æˆ·ç«¯å¯¹è±¡å³å¯ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡ç¼–å†™é…ç½®ç±»åˆå§‹åŒ–å®¢æˆ·ç«¯å¯¹è±¡ã€‚

1ï¼‰å¼•å…¥ COS ä¾èµ–ï¼š

```xml
<!-- è…¾è®¯äº‘ cos æœåŠ¡ -->  
<dependency>  
    <groupId>com.qcloud</groupId>  
    <artifactId>cos_api</artifactId>  
    <version>5.6.227</version>  
</dependency>
```

2ï¼‰åœ¨é¡¹ç›®çš„ `config` åŒ…ä¸‹æ–°å»º `CosClientConfig` ç±»ã€‚è´Ÿè´£è¯»å–é…ç½®æ–‡ä»¶ï¼Œå¹¶åˆ›å»ºä¸€ä¸ª COS å®¢æˆ·ç«¯çš„ Beanã€‚ä»£ç å¦‚ä¸‹ï¼š

```java
@Configuration  
@ConfigurationProperties(prefix = "cos.client")  
@Data  
public class CosClientConfig {  
  
    /**  
     * åŸŸå  
     */  
    private String host;  
  
    /**  
     * secretId  
     */  
    private String secretId;  
  
    /**  
     * å¯†é’¥ï¼ˆæ³¨æ„ä¸è¦æ³„éœ²ï¼‰  
     */  
    private String secretKey;  
  
    /**  
     * åŒºåŸŸ  
     */  
    private String region;  
  
    /**  
     * æ¡¶å  
     */  
    private String bucket;  
  
    @Bean  
    public COSClient cosClient() {  
        // åˆå§‹åŒ–ç”¨æˆ·èº«ä»½ä¿¡æ¯(secretId, secretKey)  
        COSCredentials cred = new BasicCOSCredentials(secretId, secretKey);  
        // è®¾ç½®bucketçš„åŒºåŸŸ, COSåœ°åŸŸçš„ç®€ç§°è¯·å‚ç…§ https://www.qcloud.com/document/product/436/6224  
        ClientConfig clientConfig = new ClientConfig(new Region(region));  
        // ç”Ÿæˆcoså®¢æˆ·ç«¯  
        return new COSClient(cred, clientConfig);  
    }  
}
```

3ï¼‰å¡«å†™é…ç½®æ–‡ä»¶ã€‚

**ä¸€å®šè¦æ³¨æ„é˜²æ­¢å¯†ç æ³„éœ²ï¼** æ‰€ä»¥æˆ‘ä»¬æ–°å»º `application-local.yml` æ–‡ä»¶ï¼Œå¹¶ä¸”åœ¨ `.gitignore` ä¸­å¿½ç•¥è¯¥æ–‡ä»¶çš„æäº¤ï¼Œè¿™æ ·å°±ä¸ä¼šå°†ä»£ç ç­‰æ•æ„Ÿé…ç½®æäº¤åˆ°ä»£ç ä»“åº“äº†ã€‚

![image](./assets/jcjrFFeFG20LOqp5.webp)

`application-local.yml` é…ç½®ä»£ç å¦‚ä¸‹ï¼š

```yaml
# å¯¹è±¡å­˜å‚¨é…ç½®ï¼ˆéœ€è¦ä»è…¾è®¯äº‘è·å–ï¼‰  
cos:  
  client:  
    host: xxx  
    secretId: xxx  
    secretKey: xxx  
    region: xxx  
    bucket: xxx
```

å¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹å¼åˆ†åˆ«è·å–éœ€è¦çš„é…ç½®ã€‚

host ä¸ºå­˜å‚¨æ¡¶åŸŸåï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å‰é¢è®¿é—®æµ‹è¯•ä¸Šä¼ çš„å›¾ç‰‡çš„åŸŸåï¼Œå¯ä»¥åœ¨ COS æ§åˆ¶å°çš„åŸŸåä¿¡æ¯éƒ¨åˆ†æ‰¾åˆ°ï¼š

![image](./assets/pkr0fNeP2Cu4iubN.webp)

secretIdã€secretKey å¯†é’¥å¯¹ï¼šåœ¨[è…¾è®¯äº‘è®¿é—®ç®¡ç†](https://console.cloud.tencent.com/cam/capi) => å¯†é’¥ç®¡ç†ä¸­è·å–ã€‚

![image](./assets/XfMgNQmJjovRXFaH.webp)

region è¡¨ç¤ºåœ°åŸŸåï¼Œå¯ä»¥ [ç‚¹æ­¤è·å–](https://cloud.tencent.com/document/product/436/6224)ã€‚

bucket æ˜¯å­˜å‚¨æ¡¶åï¼Œå¯ä»¥ç‚¹è¿›å­˜å‚¨æ¡¶è¯¦æƒ…é¡µè·å–ï¼š

![image](./assets/aYDHMtIm4QLSb61D.webp)

#### 2ã€é€šç”¨èƒ½åŠ›ç±»

åœ¨ `manager` åŒ…ä¸‹æ–°å»º `CosManager` ç±»ï¼Œæä¾›é€šç”¨çš„å¯¹è±¡å­˜å‚¨æ“ä½œï¼Œæ¯”å¦‚æ–‡ä»¶ä¸Šä¼ ã€æ–‡ä»¶ä¸‹è½½ç­‰ã€‚

ğŸ’¡ Manager ä¹Ÿæ˜¯äººä¸ºçº¦å®šçš„ä¸€ç§å†™æ³•ï¼Œè¡¨ç¤ºé€šç”¨çš„ã€å¯å¤ç”¨çš„èƒ½åŠ›ï¼Œå¯ä¾›å…¶ä»–ä»£ç ï¼ˆæ¯”å¦‚ Serviceï¼‰è°ƒç”¨ã€‚

è¯¥ç±»éœ€è¦å¼•å…¥å¯¹è±¡å­˜å‚¨é…ç½®å’Œ COS å®¢æˆ·ç«¯ï¼Œç”¨äºå’Œ COS è¿›è¡Œäº¤äº’ã€‚ä»£ç å¦‚ä¸‹ï¼š

```java
@Component  
public class CosManager {  
  
    @Resource  
    private CosClientConfig cosClientConfig;  
  
    @Resource  
    private COSClient cosClient;  
  
    // ... ä¸€äº›æ“ä½œ COS çš„æ–¹æ³•  
}
```

#### 3ã€æ–‡ä»¶ä¸Šä¼ 

å‚è€ƒ [å®˜æ–¹æ–‡æ¡£](https://cloud.tencent.com/document/product/436/65935) çš„â€œä¸Šä¼ å¯¹è±¡â€éƒ¨åˆ†ï¼Œå¯ä»¥ç¼–å†™å‡ºæ–‡ä»¶ä¸Šä¼ çš„ä»£ç ã€‚

1ï¼‰`CosManager` æ–°å¢ä¸Šä¼ å¯¹è±¡çš„æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š

```java
/**  
 * ä¸Šä¼ å¯¹è±¡  
 *  
 * @param key  å”¯ä¸€é”®  
 * @param file æ–‡ä»¶  
 */  
public PutObjectResult putObject(String key, File file) {  
    PutObjectRequest putObjectRequest = new PutObjectRequest(cosClientConfig.getBucket(), key,  
            file);  
    return cosClient.putObject(putObjectRequest);  
}
```

2ï¼‰ä¸ºäº†æ–¹ä¾¿æµ‹è¯•ï¼Œåœ¨ `FileController` ä¸­ç¼–å†™æµ‹è¯•æ–‡ä»¶ä¸Šä¼ æ¥å£ã€‚

æ ¸å¿ƒæµç¨‹æ˜¯å…ˆæ¥å—ç”¨æˆ·ä¸Šä¼ çš„æ–‡ä»¶ï¼ŒæŒ‡å®šä¸Šä¼ çš„è·¯å¾„ï¼Œç„¶åè°ƒç”¨ `cosManager.putObject` æ–¹æ³•ä¸Šä¼ æ–‡ä»¶åˆ° COS å¯¹è±¡å­˜å‚¨ï¼›ä¸Šä¼ æˆåŠŸåï¼Œä¼šè¿”å›ä¸€ä¸ªæ–‡ä»¶çš„ keyï¼ˆå…¶å®å°±æ˜¯æ–‡ä»¶è·¯å¾„ï¼‰ï¼Œä¾¿äºæˆ‘ä»¬è®¿é—®å’Œä¸‹è½½æ–‡ä»¶ã€‚

**éœ€è¦æ³¨æ„ï¼Œæµ‹è¯•æ¥å£ä¸€å®šè¦åŠ ä¸Šç®¡ç†å‘˜æƒé™ï¼é˜²æ­¢ä»»ä½•ç”¨æˆ·éšæ„ä¸Šä¼ æ–‡ä»¶ã€‚**

æµ‹è¯•æ–‡ä»¶ä¸Šä¼ æ¥å£ä»£ç å¦‚ä¸‹ï¼š

```java
/**  
 * æµ‹è¯•æ–‡ä»¶ä¸Šä¼   
 *  
 * @param multipartFile  
 * @return  
 */  
@AuthCheck(mustRole = UserConstant.ADMIN_ROLE)  
@PostMapping("/test/upload")  
public BaseResponse<String> testUploadFile(@RequestPart("file") MultipartFile multipartFile) {  
    // æ–‡ä»¶ç›®å½•  
    String filename = multipartFile.getOriginalFilename();  
    String filepath = String.format("/test/%s", filename);  
    File file = null;  
    try {  
        // ä¸Šä¼ æ–‡ä»¶  
        file = File.createTempFile(filepath, null);  
        multipartFile.transferTo(file);  
        cosManager.putObject(filepath, file);  
        // è¿”å›å¯è®¿é—®åœ°å€  
        return ResultUtils.success(filepath);  
    } catch (Exception e) {  
        log.error("file upload error, filepath = " + filepath, e);  
        throw new BusinessException(ErrorCode.SYSTEM_ERROR, "ä¸Šä¼ å¤±è´¥");  
    } finally {  
        if (file != null) {  
            // åˆ é™¤ä¸´æ—¶æ–‡ä»¶  
            boolean delete = file.delete();  
            if (!delete) {  
                log.error("file delete error, filepath = {}", filepath);  
            }  
        }  
    }  
}
```

4ï¼‰æµ‹è¯•æ¥å£ã€‚

ä½¿ç”¨ local é…ç½®å¯åŠ¨é¡¹ç›®ï¼š

![image](./assets/0c0dM1cszxYTjTT7.webp)

ä¹Ÿå¯ä»¥åœ¨ä¸»é…ç½®æ–‡ä»¶ä¸­æŒ‡å®šæ¿€æ´»çš„ç¯å¢ƒé…ç½®ï¼š

```yaml
spring:  
  profiles:  
    active: local
```

æ‰“å¼€ Swagger æ¥å£æ–‡æ¡£ï¼Œæµ‹è¯•æ–‡ä»¶ä¸Šä¼ ï¼š

#### 4ã€æ–‡ä»¶ä¸‹è½½

å®˜æ–¹æ–‡æ¡£ä»‹ç»äº† 2 ç§æ–‡ä»¶ä¸‹è½½æ–¹å¼ã€‚ä¸€ç§æ˜¯ç›´æ¥ä¸‹è½½ COS çš„æ–‡ä»¶åˆ°åç«¯æœåŠ¡å™¨ï¼ˆé€‚åˆæœåŠ¡å™¨ç«¯å¤„ç†æ–‡ä»¶ï¼‰ï¼Œå¦ä¸€ç§æ˜¯è·å–åˆ°æ–‡ä»¶ä¸‹è½½è¾“å…¥æµï¼ˆé€‚åˆè¿”å›ç»™å‰ç«¯ç”¨æˆ·ï¼‰ã€‚

å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼š

- https://cloud.tencent.com/document/product/436/65937
- https://cloud.tencent.com/document/product/436/10199#.E4.B8.8B.E8.BD.BD.E5.AF.B9.E8.B1.A1

å…¶å®è¿˜æœ‰ç¬¬ä¸‰ç§â€œä¸‹è½½æ–¹å¼â€ï¼Œç›´æ¥é€šè¿‡ URL è·¯å¾„é“¾æ¥è®¿é—®ï¼Œé€‚ç”¨äºå•ä¸€çš„ã€å¯ä»¥è¢«ç”¨æˆ·å…¬å¼€è®¿é—®çš„èµ„æºï¼Œæ¯”å¦‚ç”¨æˆ·å¤´åƒã€æœ¬é¡¹ç›®ä¸­çš„å…¬å¼€å›¾ç‰‡ã€‚

ğŸ’¡ å¯¹äºå®‰å…¨æ€§è¦æ±‚è¾ƒé«˜çš„åœºæ™¯ï¼Œå»ºè®®å…ˆé€šè¿‡åç«¯æœåŠ¡å™¨è¿›è¡Œæƒé™æ ¡éªŒï¼Œç„¶åä» COS ä¸‹è½½æ–‡ä»¶åˆ°æœåŠ¡å™¨ï¼Œå†è¿”å›ç»™å‰ç«¯ï¼Œè¿™æ ·å¯ä»¥åœ¨åç«¯é™åˆ¶åªæœ‰ç™»å½•ç”¨æˆ·æ‰èƒ½ä¸‹è½½ã€‚

ä¸è¿‡è¿˜æœ‰æ›´å·§å¦™çš„æ–¹å¼ï¼Œå…ˆé€šè¿‡åç«¯æœåŠ¡å™¨è¿›è¡Œæƒé™æ ¡éªŒï¼Œç„¶åè¿”å›ç»™å‰ç«¯ä¸€ä¸ªä¸´æ—¶ç§˜é’¥ï¼Œä¹‹åå‰ç«¯å¯ä»¥å‡­å€Ÿè¯¥ç§˜é’¥ç›´æ¥ä»å¯¹è±¡å­˜å‚¨ä¸‹è½½ï¼Œä¸ç”¨ç»è¿‡æœåŠ¡ç«¯ä¸­è½¬ï¼Œæ€§èƒ½æ›´é«˜ã€‚

**å¯¹äºæˆ‘ä»¬ç›®å‰çš„é¡¹ç›®ï¼Œå›¾ç‰‡æœ¬èº«å°±æ˜¯å…¬å¼€çš„ï¼Œç›´æ¥ä½¿ç”¨ç¬¬ä¸‰ç§æ–¹å¼ï¼Œå‡­å€Ÿ URL è¿æ¥è®¿é—®å³å¯ã€‚**

ä½†æ˜¯ä½œä¸ºä¸€ä¸ªå°çŸ¥è¯†ï¼Œè¿˜æ˜¯ç»™å¤§å®¶æ¼”ç¤ºå¦‚ä½•å°†å¯¹è±¡å­˜å‚¨çš„æ–‡ä»¶ä¸‹è½½åˆ°æœåŠ¡å™¨ä¸­ã€‚

1ï¼‰é¦–å…ˆåœ¨ `CosManager` ä¸­æ–°å¢å¯¹è±¡ä¸‹è½½æ–¹æ³•ï¼Œæ ¹æ®å¯¹è±¡çš„ key è·å–å­˜å‚¨ä¿¡æ¯ï¼š

```java
/**  
 * ä¸‹è½½å¯¹è±¡  
 *  
 * @param key å”¯ä¸€é”®  
 */  
public COSObject getObject(String key) {  
    GetObjectRequest getObjectRequest = new GetObjectRequest(cosClientConfig.getBucket(), key);  
    return cosClient.getObject(getObjectRequest);  
}
```

2ï¼‰ä¸ºäº†æ–¹ä¾¿æµ‹è¯•ï¼Œåœ¨ `FileController` ä¸­ç¼–å†™æµ‹è¯•æ–‡ä»¶ä¸‹è½½æ¥å£ã€‚

æ ¸å¿ƒæµç¨‹æ˜¯æ ¹æ®è·¯å¾„è·å–åˆ° COS æ–‡ä»¶å¯¹è±¡ï¼Œç„¶åå°†æ–‡ä»¶å¯¹è±¡è½¬æ¢ä¸ºæ–‡ä»¶æµï¼Œå¹¶å†™å…¥åˆ° Servlet çš„ Response å¯¹è±¡ä¸­ã€‚æ³¨æ„è¦è®¾ç½®æ–‡ä»¶ä¸‹è½½ä¸“å±çš„å“åº”å¤´ã€‚

åŒä¸Šï¼Œæµ‹è¯•æ¥å£ä¸€å®šè¦åŠ ä¸Šç®¡ç†å‘˜æƒé™ï¼é˜²æ­¢ä»»ä½•ç”¨æˆ·éšæ„ä¸Šä¼ æ–‡ä»¶ã€‚

æµ‹è¯•æ–‡ä»¶ä¸‹è½½æ¥å£ä»£ç å¦‚ä¸‹ï¼š

```java
/**  
 * æµ‹è¯•æ–‡ä»¶ä¸‹è½½  
 *  
 * @param filepath æ–‡ä»¶è·¯å¾„  
 * @param response å“åº”å¯¹è±¡  
 */  
@AuthCheck(mustRole = UserConstant.ADMIN_ROLE)  
@GetMapping("/test/download/")  
public void testDownloadFile(String filepath, HttpServletResponse response) throws IOException {  
    COSObjectInputStream cosObjectInput = null;  
    try {  
        COSObject cosObject = cosManager.getObject(filepath);  
        cosObjectInput = cosObject.getObjectContent();  
        // å¤„ç†ä¸‹è½½åˆ°çš„æµ  
        byte[] bytes = IOUtils.toByteArray(cosObjectInput);  
        // è®¾ç½®å“åº”å¤´  
        response.setContentType("application/octet-stream;charset=UTF-8");  
        response.setHeader("Content-Disposition", "attachment; filename=" + filepath);  
        // å†™å…¥å“åº”  
        response.getOutputStream().write(bytes);  
        response.getOutputStream().flush();  
    } catch (Exception e) {  
        log.error("file download error, filepath = " + filepath, e);  
        throw new BusinessException(ErrorCode.SYSTEM_ERROR, "ä¸‹è½½å¤±è´¥");  
    } finally {  
        if (cosObjectInput != null) {  
            cosObjectInput.close();  
        }  
    }  
}
```

3ï¼‰å¯åŠ¨é¡¹ç›®ï¼Œæ‰“å¼€ Swagger æ¥å£æ–‡æ¡£ï¼Œæµ‹è¯•æ–‡ä»¶ä¸‹è½½ï¼š

![image](./assets/4yWQPqKLhWhxA3Ju.webp)

åœ¨æŸäº›æ“ä½œç³»ç»Ÿï¼ˆæµè§ˆå™¨ï¼‰ä¸­ï¼Œè™½ç„¶å›¾ç‰‡æ²¡æœ‰æ˜¾ç¤ºï¼Œä½†é€šè¿‡å“åº”ç å’Œå“åº”å¤§å°ï¼Œä¹Ÿèƒ½åˆ¤æ–­å‡ºå›¾ç‰‡æ˜¯æˆåŠŸä¸‹è½½äº†ã€‚

è‡³æ­¤ï¼Œåç«¯æ“ä½œå¯¹è±¡å­˜å‚¨çš„ä»£ç å·²ç¼–å†™å®Œæˆï¼Œä¸‹é¢å¼€å‘æ¥å£ã€‚

### å›¾ç‰‡åŸºç¡€ä»£ç 

é¦–å…ˆåˆ©ç”¨ MyBatisX æ’ä»¶ç”Ÿæˆå›¾ç‰‡è¡¨ç›¸å…³çš„åŸºç¡€ä»£ç ï¼ŒåŒ…æ‹¬å®ä½“ç±»ã€Mapperã€Serviceã€‚

> ç”¨æˆ·æ¨¡å—ä¸­æœ‰è®²è§£è¯¦ç»†æµç¨‹ï¼Œæ­¤å¤„ä¸å†èµ˜è¿°ã€‚

ç„¶åæ ¹æ®éœ€æ±‚ä¼˜åŒ– Picture å®ä½“ç±»ï¼š

```java
@TableName(value ="picture")  
@Data  
public class Picture implements Serializable {  
    /**  
     * id  
     */  
    @TableId(type = IdType.ASSIGN_ID)  
    private Long id;  
  
    /**  
     * å›¾ç‰‡ url  
     */  
    private String url;  
  
    /**  
     * å›¾ç‰‡åç§°  
     */  
    private String name;  
  
    /**  
     * ç®€ä»‹  
     */  
    private String introduction;  
  
    /**  
     * åˆ†ç±»  
     */  
    private String category;  
  
    /**  
     * æ ‡ç­¾ï¼ˆJSON æ•°ç»„ï¼‰  
     */  
    private String tags;  
  
    /**  
     * å›¾ç‰‡ä½“ç§¯  
     */  
    private Long picSize;  
  
    /**  
     * å›¾ç‰‡å®½åº¦  
     */  
    private Integer picWidth;  
  
    /**  
     * å›¾ç‰‡é«˜åº¦  
     */  
    private Integer picHeight;  
  
    /**  
     * å›¾ç‰‡å®½é«˜æ¯”ä¾‹  
     */  
    private Double picScale;  
  
    /**  
     * å›¾ç‰‡æ ¼å¼  
     */  
    private String picFormat;  
  
    /**  
     * åˆ›å»ºç”¨æˆ· id  
     */  
    private Long userId;  
  
    /**  
     * åˆ›å»ºæ—¶é—´  
     */  
    private Date createTime;  
  
    /**  
     * ç¼–è¾‘æ—¶é—´  
     */  
    private Date editTime;  
  
    /**  
     * æ›´æ–°æ—¶é—´  
     */  
    private Date updateTime;  
  
    /**  
     * æ˜¯å¦åˆ é™¤  
     */  
    @TableLogic  
    private Integer isDelete;  
  
    @TableField(exist = false)  
    private static final long serialVersionUID = 1L;  
}
```

### å›¾ç‰‡ä¸Šä¼ 

#### 1ã€æ•°æ®æ¨¡å‹

åœ¨ `model.dto.picture` ä¸‹æ–°å»ºç”¨äºæ¥å—è¯·æ±‚å‚æ•°çš„ç±»ã€‚ç”±äºå›¾ç‰‡éœ€è¦æ”¯æŒé‡å¤ä¸Šä¼ ï¼ˆåŸºç¡€ä¿¡æ¯ä¸å˜ï¼Œåªæ”¹å˜å›¾ç‰‡æ–‡ä»¶ï¼‰ï¼Œæ‰€ä»¥è¦æ·»åŠ å›¾ç‰‡ id å‚æ•°ï¼š

```java
@Data  
public class PictureUploadRequest implements Serializable {  
  
    /**  
     * å›¾ç‰‡ idï¼ˆç”¨äºä¿®æ”¹ï¼‰  
     */  
    private Long id;  
  
    private static final long serialVersionUID = 1L;  
}
```

åœ¨ `model.vo` ä¸‹æ–°å»ºä¸Šä¼ æˆåŠŸåè¿”å›ç»™å‰ç«¯çš„å“åº”ç±»ï¼Œè¿™æ˜¯ä¸€ä¸ªè§†å›¾åŒ…è£…ç±»ï¼Œå¯ä»¥é¢å¤–å…³è”ä¸Šä¼ å›¾ç‰‡çš„ç”¨æˆ·ä¿¡æ¯ã€‚è¿˜å¯ä»¥ç¼–å†™ Picture å®ä½“ç±»å’Œè¯¥ VO ç±»çš„è½¬æ¢æ–¹æ³•ï¼Œä¾¿äºåç»­å¿«é€Ÿä¼ å€¼ã€‚

```java
@Data  
public class PictureVO implements Serializable {  
  
    /**  
     * id  
     */  
    private Long id;  
  
    /**  
     * å›¾ç‰‡ url  
     */  
    private String url;  
  
    /**  
     * å›¾ç‰‡åç§°  
     */  
    private String name;  
  
    /**  
     * ç®€ä»‹  
     */  
    private String introduction;  
  
    /**  
     * æ ‡ç­¾  
     */  
    private List<String> tags;  
  
    /**  
     * åˆ†ç±»  
     */  
    private String category;  
  
    /**  
     * æ–‡ä»¶ä½“ç§¯  
     */  
    private Long picSize;  
  
    /**  
     * å›¾ç‰‡å®½åº¦  
     */  
    private Integer picWidth;  
  
    /**  
     * å›¾ç‰‡é«˜åº¦  
     */  
    private Integer picHeight;  
  
    /**  
     * å›¾ç‰‡æ¯”ä¾‹  
     */  
    private Double picScale;  
  
    /**  
     * å›¾ç‰‡æ ¼å¼  
     */  
    private String picFormat;  
  
    /**  
     * ç”¨æˆ· id  
     */  
    private Long userId;  
  
    /**  
     * åˆ›å»ºæ—¶é—´  
     */  
    private Date createTime;  
  
    /**  
     * ç¼–è¾‘æ—¶é—´  
     */  
    private Date editTime;  
  
    /**  
     * æ›´æ–°æ—¶é—´  
     */  
    private Date updateTime;  
  
    /**  
     * åˆ›å»ºç”¨æˆ·ä¿¡æ¯  
     */  
    private UserVO user;  
  
    private static final long serialVersionUID = 1L;  
  
    /**  
     * å°è£…ç±»è½¬å¯¹è±¡  
     */  
    public static Picture voToObj(PictureVO pictureVO) {  
        if (pictureVO == null) {  
            return null;  
        }  
        Picture picture = new Picture();  
        BeanUtils.copyProperties(pictureVO, picture);  
        // ç±»å‹ä¸åŒï¼Œéœ€è¦è½¬æ¢  
        picture.setTags(JSONUtil.toJsonStr(pictureVO.getTags()));  
        return picture;  
    }  
  
    /**  
     * å¯¹è±¡è½¬å°è£…ç±»  
     */  
    public static PictureVO objToVo(Picture picture) {  
        if (picture == null) {  
            return null;  
        }  
        PictureVO pictureVO = new PictureVO();  
        BeanUtils.copyProperties(picture, pictureVO);  
        // ç±»å‹ä¸åŒï¼Œéœ€è¦è½¬æ¢  
        pictureVO.setTags(JSONUtil.toList(picture.getTags(), String.class));  
        return pictureVO;  
    }  
}
```

#### 2ã€é€šç”¨æ–‡ä»¶ä¸Šä¼ æœåŠ¡

ä¹‹å‰è™½ç„¶æˆ‘ä»¬å·²ç»ç¼–å†™äº†é€šç”¨çš„å¯¹è±¡å­˜å‚¨æ“ä½œç±» CosManagerï¼Œä½†è¿™ä¸ªç±»å¹¶ä¸èƒ½ç›´æ¥æ»¡è¶³æˆ‘ä»¬çš„å›¾ç‰‡ä¸Šä¼ éœ€æ±‚ã€‚

æ¯”å¦‚ï¼š

- å›¾ç‰‡æ˜¯å¦ç¬¦åˆè¦æ±‚ï¼Ÿéœ€è¦æ ¡éªŒ
- å°†å›¾ç‰‡ä¸Šä¼ åˆ°å“ªé‡Œï¼Ÿéœ€è¦æŒ‡å®šè·¯å¾„
- å¦‚ä½•è§£æå›¾ç‰‡ï¼Ÿéœ€è¦ä½¿ç”¨æ•°æ®ä¸‡è±¡æœåŠ¡

æ‰€ä»¥ï¼Œå¯ä»¥é’ˆå¯¹æˆ‘ä»¬çš„é¡¹ç›®ï¼Œç¼–å†™ä¸€ä¸ªæ›´è´´åˆä¸šåŠ¡çš„æ–‡ä»¶ä¸Šä¼ æœåŠ¡ FileManagerï¼ˆè¿™é‡Œç”¨ Service ä¹Ÿå¯ä»¥ï¼‰ï¼Œè¯¥æœåŠ¡æä¾›ä¸€ä¸ªä¸Šä¼ å›¾ç‰‡å¹¶è¿”å›å›¾ç‰‡è§£æä¿¡æ¯çš„æ–¹æ³•ã€‚

```java
@Service  
@Slf4j  
public class FileManager {  
  
    @Resource  
    private CosClientConfig cosClientConfig;  
  
    @Resource  
    private CosManager cosManager;  
  
    // ...  
}
```

1ï¼‰åœ¨ `model.dto.file` ä¸­æ–°å¢ç”¨äºæ¥å—å›¾ç‰‡è§£æä¿¡æ¯çš„åŒ…è£…ç±»ï¼š

```java
@Data  
public class UploadPictureResult {  
  
    /**  
     * å›¾ç‰‡åœ°å€  
     */  
    private String url;  
  
    /**  
     * å›¾ç‰‡åç§°  
     */  
    private String picName;  
  
    /**  
     * æ–‡ä»¶ä½“ç§¯  
     */  
    private Long picSize;  
  
    /**  
     * å›¾ç‰‡å®½åº¦  
     */  
    private int picWidth;  
  
    /**  
     * å›¾ç‰‡é«˜åº¦  
     */  
    private int picHeight;  
  
    /**  
     * å›¾ç‰‡å®½é«˜æ¯”  
     */  
    private Double picScale;  
  
    /**  
     * å›¾ç‰‡æ ¼å¼  
     */  
    private String picFormat;  
  
}
```

2ï¼‰å‚è€ƒ [æ•°æ®ä¸‡è±¡](https://cloud.tencent.com/document/product/436/55377) çš„æ–‡æ¡£ï¼Œåœ¨ CosManager ä¸­æ·»åŠ ä¸Šä¼ å›¾ç‰‡å¹¶è§£æå›¾ç‰‡çš„æ–¹æ³•ï¼š

```java
/**  
 * ä¸Šä¼ å¯¹è±¡ï¼ˆé™„å¸¦å›¾ç‰‡ä¿¡æ¯ï¼‰  
 *  
 * @param key  å”¯ä¸€é”®  
 * @param file æ–‡ä»¶  
 */  
public PutObjectResult putPictureObject(String key, File file) {  
    PutObjectRequest putObjectRequest = new PutObjectRequest(cosClientConfig.getBucket(), key,  
            file);  
    // å¯¹å›¾ç‰‡è¿›è¡Œå¤„ç†ï¼ˆè·å–åŸºæœ¬ä¿¡æ¯ä¹Ÿè¢«è§†ä½œä¸ºä¸€ç§å¤„ç†ï¼‰  
    PicOperations picOperations = new PicOperations();  
    // 1 è¡¨ç¤ºè¿”å›åŸå›¾ä¿¡æ¯  
    picOperations.setIsPicInfo(1);  
    // æ„é€ å¤„ç†å‚æ•°  
    putObjectRequest.setPicOperations(picOperations);  
    return cosClient.putObject(putObjectRequest);  
}
```

å¦‚æœä½ ä¹‹å‰æ²¡æœ‰ä½¿ç”¨è¿‡æ•°æ®ä¸‡è±¡ï¼Œéœ€è¦å…ˆ [å¼€é€šæ•°æ®ä¸‡è±¡å¹¶æˆæƒ](https://console.cloud.tencent.com/ci)ï¼Œå¦åˆ™ä¼šæŠ¥é”™ï¼š

![image](./assets/9dDLLQiGnBom9Uqp.webp)

3ï¼‰åœ¨ FileManager ä¸­ç¼–å†™ä¸Šä¼ å›¾ç‰‡çš„æ–¹æ³•ï¼š

```java
/**  
 * ä¸Šä¼ å›¾ç‰‡  
 *  
 * @param multipartFile    æ–‡ä»¶  
 * @param uploadPathPrefix ä¸Šä¼ è·¯å¾„å‰ç¼€  
 * @return  
 */  
public UploadPictureResult uploadPicture(MultipartFile multipartFile, String uploadPathPrefix) {  
    // æ ¡éªŒå›¾ç‰‡  
    validPicture(multipartFile);  
    // å›¾ç‰‡ä¸Šä¼ åœ°å€  
    String uuid = RandomUtil.randomString(16);  
    String originFilename = multipartFile.getOriginalFilename();  
    String uploadFilename = String.format("%s_%s.%s", DateUtil.formatDate(new Date()), uuid,  
            FileUtil.getSuffix(originFilename));  
    String uploadPath = String.format("/%s/%s", uploadPathPrefix, uploadFilename);  
    File file = null;  
    try {  
        // åˆ›å»ºä¸´æ—¶æ–‡ä»¶  
        file = File.createTempFile(uploadPath, null);  
        multipartFile.transferTo(file);  
        // ä¸Šä¼ å›¾ç‰‡  
        PutObjectResult putObjectResult = cosManager.putPictureObject(uploadPath, file);  
        ImageInfo imageInfo = putObjectResult.getCiUploadResult().getOriginalInfo().getImageInfo();  
        // å°è£…è¿”å›ç»“æœ  
        UploadPictureResult uploadPictureResult = new UploadPictureResult();  
        int picWidth = imageInfo.getWidth();  
        int picHeight = imageInfo.getHeight();  
        double picScale = NumberUtil.round(picWidth * 1.0 / picHeight, 2).doubleValue();  
        uploadPictureResult.setPicName(FileUtil.mainName(originFilename));  
        uploadPictureResult.setPicWidth(picWidth);  
        uploadPictureResult.setPicHeight(picHeight);  
        uploadPictureResult.setPicScale(picScale);  
        uploadPictureResult.setPicFormat(imageInfo.getFormat());  
        uploadPictureResult.setPicSize(FileUtil.size(file));  
        uploadPictureResult.setUrl(cosClientConfig.getHost() + "/" + uploadPath);  
        return uploadPictureResult;  
    } catch (Exception e) {  
        log.error("å›¾ç‰‡ä¸Šä¼ åˆ°å¯¹è±¡å­˜å‚¨å¤±è´¥", e);  
        throw new BusinessException(ErrorCode.SYSTEM_ERROR, "ä¸Šä¼ å¤±è´¥");  
    } finally {  
        this.deleteTempFile(file);  
    }  
}  
  
/**  
 * æ ¡éªŒæ–‡ä»¶  
 *  
 * @param multipartFile multipart æ–‡ä»¶  
 */  
public void validPicture(MultipartFile multipartFile) {  
    ThrowUtils.throwIf(multipartFile == null, ErrorCode.PARAMS_ERROR, "æ–‡ä»¶ä¸èƒ½ä¸ºç©º");  
    // 1. æ ¡éªŒæ–‡ä»¶å¤§å°  
    long fileSize = multipartFile.getSize();  
    final long ONE_M = 1024 * 1024L;  
    ThrowUtils.throwIf(fileSize > 2 * ONE_M, ErrorCode.PARAMS_ERROR, "æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡ 2M");  
    // 2. æ ¡éªŒæ–‡ä»¶åç¼€  
    String fileSuffix = FileUtil.getSuffix(multipartFile.getOriginalFilename());  
    // å…è®¸ä¸Šä¼ çš„æ–‡ä»¶åç¼€  
    final List<String> ALLOW_FORMAT_LIST = Arrays.asList("jpeg", "jpg", "png", "webp");  
    ThrowUtils.throwIf(!ALLOW_FORMAT_LIST.contains(fileSuffix), ErrorCode.PARAMS_ERROR, "æ–‡ä»¶ç±»å‹é”™è¯¯");  
}  
  
/**  
 * åˆ é™¤ä¸´æ—¶æ–‡ä»¶  
 */  
public void deleteTempFile(File file) {  
    if (file == null) {  
        return;  
    }  
    // åˆ é™¤ä¸´æ—¶æ–‡ä»¶  
    boolean deleteResult = file.delete();  
    if (!deleteResult) {  
        log.error("file delete error, filepath = {}", file.getAbsolutePath());  
    }  
}
```

ä¸Šè¿°ä»£ç ä¸­æœ‰å‡ ä¸ªå®ç°å…³é”®ï¼š

1. ç”±äºæ–‡ä»¶æ ¡éªŒè§„åˆ™è¾ƒå¤æ‚ï¼Œå•ç‹¬æŠ½è±¡ä¸º validPicture æ–¹æ³•ï¼Œå¯¹æ–‡ä»¶å¤§å°ã€ç±»å‹è¿›è¡Œæ ¡éªŒã€‚
2. æ–‡ä»¶ä¸Šä¼ æ—¶ï¼Œä¼šå…ˆåœ¨æœ¬åœ°åˆ›å»ºä¸´æ—¶æ–‡ä»¶ï¼Œæ— è®ºä¸Šä¼ æ˜¯å¦æˆåŠŸï¼Œéƒ½è¦è®°å¾—åˆ é™¤ä¸´æ—¶æ–‡ä»¶ï¼Œå¦åˆ™ä¼šå¯¼è‡´èµ„æºæ³„éœ²ã€‚
3. å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€æ±‚å®šä¹‰æ–‡ä»¶ä¸Šä¼ åœ°å€ï¼Œæ¯”å¦‚æ­¤å¤„é±¼çš®ç»™æ–‡ä»¶åå‰å¢åŠ äº†ä¸Šä¼ æ—¥æœŸå’Œ 16 ä½ uuid éšæœºæ•°ï¼Œä¾¿äºäº†è§£æ–‡ä»¶ä¸Šä¼ æ—¶é—´å¹¶é˜²æ­¢æ–‡ä»¶é‡å¤ã€‚è¿˜é¢„ç•™äº†ä¸€ä¸ª uploadPathPrefix å‚æ•°ï¼Œç”±è°ƒç”¨æ–¹æŒ‡å®šä¸Šä¼ æ–‡ä»¶åˆ°å“ªä¸ªç›®å½•ã€‚

ğŸ’¡ å¦‚æœå¤šä¸ªé¡¹ç›®å…±äº«å­˜å‚¨æ¡¶ï¼Œå¯ä»¥ç»™ä¸Šä¼ æ–‡ä»¶è·¯å¾„å†åŠ ä¸€ä¸ª ProjectName å‰ç¼€ã€‚ä¸è¿‡å»ºè®®è¿˜æ˜¯æ¯ä¸ªé¡¹ç›®ç‹¬ç«‹åˆ†é…èµ„æºã€‚

#### 3ã€æœåŠ¡å¼€å‘

åœ¨ PictureService ä¸­ç¼–å†™ä¸Šä¼ å›¾ç‰‡çš„æ–¹æ³•ï¼š

æ¥å£ï¼š

```java
/**  
 * ä¸Šä¼ å›¾ç‰‡  
 *  
 * @param multipartFile  
 * @param pictureUploadRequest  
 * @param loginUser  
 * @return  
 */  
PictureVO uploadPicture(MultipartFile multipartFile,  
                        PictureUploadRequest pictureUploadRequest,  
                        User loginUser);
```

å®ç°ç±»ï¼š

```java
@Override  
public PictureVO uploadPicture(MultipartFile multipartFile, PictureUploadRequest pictureUploadRequest, User loginUser) {  
    ThrowUtils.throwIf(loginUser == null, ErrorCode.NO_AUTH_ERROR);  
    // ç”¨äºåˆ¤æ–­æ˜¯æ–°å¢è¿˜æ˜¯æ›´æ–°å›¾ç‰‡  
    Long pictureId = null;  
    if (pictureUploadRequest != null) {  
        pictureId = pictureUploadRequest.getId();  
    }  
    // å¦‚æœæ˜¯æ›´æ–°å›¾ç‰‡ï¼Œéœ€è¦æ ¡éªŒå›¾ç‰‡æ˜¯å¦å­˜åœ¨  
    if (pictureId != null) {  
        boolean exists = this.lambdaQuery()  
                .eq(Picture::getId, pictureId)  
                .exists();  
        ThrowUtils.throwIf(!exists, ErrorCode.NOT_FOUND_ERROR, "å›¾ç‰‡ä¸å­˜åœ¨");  
    }  
    // ä¸Šä¼ å›¾ç‰‡ï¼Œå¾—åˆ°ä¿¡æ¯  
    // æŒ‰ç…§ç”¨æˆ· id åˆ’åˆ†ç›®å½•  
    String uploadPathPrefix = String.format("public/%s", loginUser.getId());  
    UploadPictureResult uploadPictureResult = fileManager.uploadPicture(multipartFile, uploadPathPrefix);  
    // æ„é€ è¦å…¥åº“çš„å›¾ç‰‡ä¿¡æ¯  
    Picture picture = new Picture();  
    picture.setUrl(uploadPictureResult.getUrl());  
    picture.setName(uploadPictureResult.getPicName());  
    picture.setPicSize(uploadPictureResult.getPicSize());  
    picture.setPicWidth(uploadPictureResult.getPicWidth());  
    picture.setPicHeight(uploadPictureResult.getPicHeight());  
    picture.setPicScale(uploadPictureResult.getPicScale());  
    picture.setPicFormat(uploadPictureResult.getPicFormat());  
    picture.setUserId(loginUser.getId());  
    // å¦‚æœ pictureId ä¸ä¸ºç©ºï¼Œè¡¨ç¤ºæ›´æ–°ï¼Œå¦åˆ™æ˜¯æ–°å¢  
    if (pictureId != null) {  
        // å¦‚æœæ˜¯æ›´æ–°ï¼Œéœ€è¦è¡¥å…… id å’Œç¼–è¾‘æ—¶é—´  
        picture.setId(pictureId);  
        picture.setEditTime(new Date());  
    }  
    boolean result = this.saveOrUpdate(picture);  
    ThrowUtils.throwIf(!result, ErrorCode.OPERATION_ERROR, "å›¾ç‰‡ä¸Šä¼ å¤±è´¥");  
    return PictureVO.objToVo(picture);  
}
```

ä¸Šè¿°ä»£ç ä¸­ï¼Œæ³¨æ„ï¼š

1. æˆ‘ä»¬å°†æ‰€æœ‰å›¾ç‰‡éƒ½æ”¾åˆ°äº† public ç›®å½•ä¸‹ï¼Œå¹¶ä¸”æ¯ä¸ªç”¨æˆ·çš„å›¾ç‰‡å­˜å‚¨åˆ°å¯¹åº”ç”¨æˆ· id çš„ç›®å½•ä¸‹ï¼Œä¾¿äºç®¡ç†ã€‚
2. å¦‚æœ pictureId ä¸ä¸ºç©ºï¼Œè¡¨ç¤ºæ›´æ–°å·²æœ‰å›¾ç‰‡çš„ä¿¡æ¯ï¼Œéœ€è¦åˆ¤æ–­å¯¹åº” id çš„å›¾ç‰‡æ˜¯å¦å­˜åœ¨ï¼Œå¹¶ä¸”æ›´æ–°æ—¶è¦æŒ‡å®š editTime ç¼–è¾‘æ—¶é—´ã€‚å¯ä»¥è°ƒç”¨ MyBatis Plus æä¾›çš„ saveOrUpdate æ–¹æ³•å…¼å®¹åˆ›å»ºå’Œæ›´æ–°æ“ä½œã€‚

#### 4ã€æ¥å£å¼€å‘

åœ¨ PictureController ä¸­ç¼–å†™ä¸Šä¼ å›¾ç‰‡æ¥å£ï¼Œæ³¨æ„ä»…ç®¡ç†å‘˜å¯ç”¨ï¼š

```java
/**  
 * ä¸Šä¼ å›¾ç‰‡ï¼ˆå¯é‡æ–°ä¸Šä¼ ï¼‰  
 */  
@PostMapping("/upload")  
@AuthCheck(mustRole = UserConstant.ADMIN_ROLE)  
public BaseResponse<PictureVO> uploadPicture(  
        @RequestPart("file") MultipartFile multipartFile,  
        PictureUploadRequest pictureUploadRequest,  
        HttpServletRequest request) {  
    User loginUser = userService.getLoginUser(request);  
    PictureVO pictureVO = pictureService.uploadPicture(multipartFile, pictureUploadRequest, loginUser);  
    return ResultUtils.success(pictureVO);  
}
```

#### 5ã€æµ‹è¯•

ä½¿ç”¨ Swagger è¿›è¡Œæµ‹è¯•ï¼Œå‘ç°å½“ä¸Šä¼ å›¾ç‰‡è¿‡å¤§æ—¶ï¼Œä¼šè§¦å‘ä¸€æ®µæŠ¥é”™ã€‚ä½†è¿™ä¸ªæŠ¥é”™ä¸æ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„å¼‚å¸¸å¯¼è‡´çš„ï¼Œè€Œæ˜¯ç”±äº Tomcat æœåŠ¡å™¨é»˜è®¤é™åˆ¶äº†è¯·æ±‚ä¸­æ–‡ä»¶ä¸Šä¼ çš„å¤§å°ã€‚

éœ€è¦åœ¨ `application.yml` ä¸­æ›´æ”¹é…ç½®ï¼Œè°ƒå¤§å…è®¸ä¸Šä¼ çš„æ–‡ä»¶å¤§å°ï¼š

```yaml
spring:  
  # å¼€æ”¾æ›´å¤§çš„æ–‡ä»¶ä¸Šä¼ ä½“ç§¯  
  servlet:  
    multipart:  
      max-file-size: 10MB
```

#### æ‰©å±•æ€è·¯

1ï¼‰å¯ä»¥ç”¨æšä¸¾ç±»ï¼ˆFileUploadBizEnumï¼‰æ”¯æŒæ ¹æ®ä¸šåŠ¡åœºæ™¯åŒºåˆ†æ–‡ä»¶ä¸Šä¼ è·¯å¾„ã€æ ¡éªŒè§„åˆ™ç­‰ï¼Œä»è€Œå¤ç”¨ FileManagerã€‚

2ï¼‰ç›®å‰åœ¨æ–‡ä»¶ä¸Šä¼ æ—¶ï¼Œä¼šå…ˆåœ¨æœ¬åœ°åˆ›å»ºä¸´æ—¶æ–‡ä»¶ã€‚å¦‚æœä½ ä¸éœ€è¦å¯¹æ–‡ä»¶è¿›è¡Œé¢å¤–çš„å¤„ç†ã€æƒ³è¿›ä¸€æ­¥æé«˜æ€§èƒ½ï¼Œå¯ä»¥ç›´æ¥ç”¨æµçš„æ–¹å¼å°†è¯·æ±‚ä¸­çš„æ–‡ä»¶ä¸Šä¼ åˆ° COSã€‚ä»¥ä¸‹ä»£ç ä»…ä¾›å‚è€ƒï¼š

```java
// ä¸Šä¼ æ–‡ä»¶  
public static String uploadToCOS(MultipartFile multipartFile, String bucketName, String key) throws Exception {  
    // åˆ›å»º COS å®¢æˆ·ç«¯  
    COSClient cosClient = createCOSClient();  
  
    try (InputStream inputStream = multipartFile.getInputStream()) {  
        // å…ƒä¿¡æ¯é…ç½®  
        ObjectMetadata metadata = new ObjectMetadata();  
        metadata.setContentLength(multipartFile.getSize());  
        metadata.setContentType(multipartFile.getContentType());  
  
        // åˆ›å»ºä¸Šä¼ è¯·æ±‚  
        PutObjectRequest putObjectRequest = new PutObjectRequest(bucketName, key, inputStream, metadata);  
  
        // ä¸Šä¼ æ–‡ä»¶  
        cosClient.putObject(putObjectRequest);  
  
        // ç”Ÿæˆè®¿é—®é“¾æ¥  
        return "https://" + bucketName + ".cos." + cosClient.getClientConfig().getRegion().getRegionName()  
               + ".myqcloud.com/" + key;  
    } finally {  
        cosClient.shutdown();  
    }  
}
```

3ï¼‰è¡¥å……æ›´ä¸¥æ ¼çš„æ ¡éªŒï¼Œæ¯”å¦‚ä¸ºæ”¯æŒçš„å›¾ç‰‡æ ¼å¼å®šä¹‰æšä¸¾ï¼Œä»…å…è®¸ä¸Šä¼ æšä¸¾å®šä¹‰çš„æ ¼å¼ã€‚

### å›¾ç‰‡ç®¡ç†

å›¾ç‰‡ç®¡ç†åŠŸèƒ½å…·ä½“å¯ä»¥æ‹†åˆ†ä¸ºï¼š

- ã€ç®¡ç†å‘˜ã€‘æ ¹æ® id åˆ é™¤å›¾ç‰‡
- ã€ç®¡ç†å‘˜ã€‘æ›´æ–°å›¾ç‰‡
- ã€ç®¡ç†å‘˜ã€‘åˆ†é¡µè·å–å›¾ç‰‡åˆ—è¡¨ï¼ˆä¸éœ€è¦è„±æ•å’Œé™åˆ¶æ¡æ•°ï¼‰
- ã€ç®¡ç†å‘˜ã€‘æ ¹æ® id è·å–å›¾ç‰‡ï¼ˆä¸éœ€è¦è„±æ•ï¼‰
- åˆ†é¡µè·å–å›¾ç‰‡åˆ—è¡¨ï¼ˆéœ€è¦è„±æ•å’Œé™åˆ¶æ¡æ•°ï¼‰
- æ ¹æ® id è·å–å›¾ç‰‡ï¼ˆéœ€è¦è„±æ•ï¼‰
- ä¿®æ”¹å›¾ç‰‡

#### 1ã€æ•°æ®æ¨¡å‹

æ¯ä¸ªæ“ä½œéƒ½éœ€è¦æä¾›ä¸€ä¸ªè¯·æ±‚ç±»ï¼Œéƒ½æ”¾åœ¨ `model.dto.picture` åŒ…ä¸‹ã€‚

![image](./assets/9ls8lPOBw0dzQRe6.webp)

1ï¼‰å›¾ç‰‡æ›´æ–°è¯·æ±‚ï¼Œç»™ç®¡ç†å‘˜ä½¿ç”¨ã€‚æ³¨æ„è¦å°† tags çš„ç±»å‹æ”¹ä¸º `List<String>`ï¼Œä¾¿äºå‰ç«¯ä¸Šä¼ ï¼š

```java
@Data  
public class PictureUpdateRequest implements Serializable {  
  
    /**  
     * id  
     */  
    private Long id;  
  
    /**  
     * å›¾ç‰‡åç§°  
     */  
    private String name;  
  
    /**  
     * ç®€ä»‹  
     */  
    private String introduction;  
  
    /**  
     * åˆ†ç±»  
     */  
    private String category;  
  
    /**  
     * æ ‡ç­¾  
     */  
    private List<String> tags;  
  
    private static final long serialVersionUID = 1L;  
}
```

2ï¼‰å›¾ç‰‡ä¿®æ”¹è¯·æ±‚ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ç»™æ™®é€šç”¨æˆ·ä½¿ç”¨ï¼Œå¯ä¿®æ”¹çš„å­—æ®µèŒƒå›´å°äºæ›´æ–°è¯·æ±‚ï¼š

```java
@Data  
public class PictureEditRequest implements Serializable {  
  
    /**  
     * id  
     */  
    private Long id;  
  
    /**  
     * å›¾ç‰‡åç§°  
     */  
    private String name;  
  
    /**  
     * ç®€ä»‹  
     */  
    private String introduction;  
  
    /**  
     * åˆ†ç±»  
     */  
    private String category;  
  
    /**  
     * æ ‡ç­¾  
     */  
    private List<String> tags;  
  
    private static final long serialVersionUID = 1L;  
}
```

3ï¼‰å›¾ç‰‡æŸ¥è¯¢è¯·æ±‚ï¼Œéœ€è¦ç»§æ‰¿å…¬å…±åŒ…ä¸­çš„ `PageRequest` æ¥æ”¯æŒåˆ†é¡µæŸ¥è¯¢ï¼š

```java
@EqualsAndHashCode(callSuper = true)  
@Data  
public class PictureQueryRequest extends PageRequest implements Serializable {  
  
    /**  
     * id  
     */  
    private Long id;  
  
    /**  
     * å›¾ç‰‡åç§°  
     */  
    private String name;  
  
    /**  
     * ç®€ä»‹  
     */  
    private String introduction;  
  
    /**  
     * åˆ†ç±»  
     */  
    private String category;  
  
    /**  
     * æ ‡ç­¾  
     */  
    private List<String> tags;  
  
    /**  
     * æ–‡ä»¶ä½“ç§¯  
     */  
    private Long picSize;  
  
    /**  
     * å›¾ç‰‡å®½åº¦  
     */  
    private Integer picWidth;  
  
    /**  
     * å›¾ç‰‡é«˜åº¦  
     */  
    private Integer picHeight;  
  
    /**  
     * å›¾ç‰‡æ¯”ä¾‹  
     */  
    private Double picScale;  
  
    /**  
     * å›¾ç‰‡æ ¼å¼  
     */  
    private String picFormat;  
  
    /**  
     * æœç´¢è¯ï¼ˆåŒæ—¶æœåç§°ã€ç®€ä»‹ç­‰ï¼‰  
     */  
    private String searchText;  
  
    /**  
     * ç”¨æˆ· id  
     */  
    private Long userId;  
  
    private static final long serialVersionUID = 1L;  
}
```

#### 2ã€æœåŠ¡å¼€å‘

1ï¼‰åœ¨ UserService ä¸­ç¼–å†™åˆ¤æ–­ç”¨æˆ·æ˜¯å¦ä¸ºç®¡ç†å‘˜çš„æ–¹æ³•ï¼Œåç»­å¼€å‘ä¸­ä¼šç”¨åˆ°ã€‚

æ¥å£ä»£ç ï¼š

```java
/**  
 * æ˜¯å¦ä¸ºç®¡ç†å‘˜  
 *  
 * @param user  
 * @return  
 */  
boolean isAdmin(User user);
```

å®ç°ç±»ï¼š

```java
@Override  
public boolean isAdmin(User user) {  
    return user != null && UserRoleEnum.ADMIN.getValue().equals(user.getUserRole());  
}
```

2ï¼‰å¯¹äºåˆ†é¡µæŸ¥è¯¢æ¥å£ï¼Œéœ€è¦æ ¹æ®ç”¨æˆ·ä¼ å…¥çš„å‚æ•°æ¥æ„é€  SQL æŸ¥è¯¢ã€‚ç”±äºä½¿ç”¨ MyBatis Plus æ¡†æ¶ï¼Œä¸ç”¨è‡ªå·±æ‹¼æ¥ SQL äº†ï¼Œè€Œæ˜¯é€šè¿‡æ„é€  QueryWrapper å¯¹è±¡æ¥ç”Ÿæˆ SQL æŸ¥è¯¢ã€‚

å¯ä»¥åœ¨ PictureService ä¸­ç¼–å†™ä¸€ä¸ªæ–¹æ³•ï¼Œä¸“é—¨ç”¨äºå°†æŸ¥è¯¢è¯·æ±‚è½¬ä¸º QueryWrapper å¯¹è±¡ï¼š

```java
@Override  
public QueryWrapper<Picture> getQueryWrapper(PictureQueryRequest pictureQueryRequest) {  
    QueryWrapper<Picture> queryWrapper = new QueryWrapper<>();  
    if (pictureQueryRequest == null) {  
        return queryWrapper;  
    }  
    // ä»å¯¹è±¡ä¸­å–å€¼  
    Long id = pictureQueryRequest.getId();  
    String name = pictureQueryRequest.getName();  
    String introduction = pictureQueryRequest.getIntroduction();  
    String category = pictureQueryRequest.getCategory();  
    List<String> tags = pictureQueryRequest.getTags();  
    Long picSize = pictureQueryRequest.getPicSize();  
    Integer picWidth = pictureQueryRequest.getPicWidth();  
    Integer picHeight = pictureQueryRequest.getPicHeight();  
    Double picScale = pictureQueryRequest.getPicScale();  
    String picFormat = pictureQueryRequest.getPicFormat();  
    String searchText = pictureQueryRequest.getSearchText();  
    Long userId = pictureQueryRequest.getUserId();  
    String sortField = pictureQueryRequest.getSortField();  
    String sortOrder = pictureQueryRequest.getSortOrder();  
    // ä»å¤šå­—æ®µä¸­æœç´¢  
    if (StrUtil.isNotBlank(searchText)) {  
        // éœ€è¦æ‹¼æ¥æŸ¥è¯¢æ¡ä»¶  
        queryWrapper.and(qw -> qw.like("name", searchText)  
                .or()  
                .like("introduction", searchText)  
        );  
    }  
    queryWrapper.eq(ObjUtil.isNotEmpty(id), "id", id);  
    queryWrapper.eq(ObjUtil.isNotEmpty(userId), "userId", userId);  
    queryWrapper.like(StrUtil.isNotBlank(name), "name", name);  
    queryWrapper.like(StrUtil.isNotBlank(introduction), "introduction", introduction);  
    queryWrapper.like(StrUtil.isNotBlank(picFormat), "picFormat", picFormat);  
    queryWrapper.eq(StrUtil.isNotBlank(category), "category", category);  
    queryWrapper.eq(ObjUtil.isNotEmpty(picWidth), "picWidth", picWidth);  
    queryWrapper.eq(ObjUtil.isNotEmpty(picHeight), "picHeight", picHeight);  
    queryWrapper.eq(ObjUtil.isNotEmpty(picSize), "picSize", picSize);  
    queryWrapper.eq(ObjUtil.isNotEmpty(picScale), "picScale", picScale);  
    // JSON æ•°ç»„æŸ¥è¯¢  
    if (CollUtil.isNotEmpty(tags)) {  
        for (String tag : tags) {  
            queryWrapper.like("tags", "\"" + tag + "\"");  
        }  
    }  
    // æ’åº  
    queryWrapper.orderBy(StrUtil.isNotEmpty(sortField), sortOrder.equals("ascend"), sortField);  
    return queryWrapper;  
}
```

ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæ³¨æ„ä¸¤ç‚¹ï¼š

1. searchText æ”¯æŒåŒæ—¶ä» name å’Œ introduction ä¸­æ£€ç´¢ï¼Œå¯ä»¥ç”¨ queryWrapper çš„ or è¯­æ³•æ„é€ æŸ¥è¯¢æ¡ä»¶ã€‚
2. ç”±äº tags åœ¨æ•°æ®åº“ä¸­å­˜å‚¨çš„æ˜¯ JSON æ ¼å¼çš„å­—ç¬¦ä¸²ï¼Œå¦‚æœå‰ç«¯è¦ä¼ å¤šä¸ª tagï¼ˆå¿…é¡»åŒæ—¶å­˜åœ¨æ‰æŸ¥å‡ºï¼‰ï¼Œéœ€è¦éå† tags æ•°ç»„ï¼Œæ¯ä¸ªæ ‡ç­¾éƒ½ä½¿ç”¨ like æ¨¡ç³ŠæŸ¥è¯¢ï¼Œå°†è¿™äº›æ¡ä»¶ç»„åˆåœ¨ä¸€èµ·ã€‚

ğŸ’¡ ä» MySQL 5.7 å¼€å§‹ï¼ŒMySQL æä¾›äº† `JSON_CONTAINS` å‡½æ•°ï¼Œå¯ä»¥ç”¨æ¥æ£€æŸ¥ä¸€ä¸ª JSON æ•°ç»„ä¸­æ˜¯å¦åŒ…å«æŸä¸ªå…ƒç´ ï¼š

```sql
SELECT * FROM picture  
WHERE JSON_CONTAINS(tags, 'yupi');
```

éœ€è¦åœ¨ç¨‹åºä¸­ç¼–å†™ MyBatis çš„è‡ªå®šä¹‰ SQL å®ç°ã€‚

3ï¼‰ç¼–å†™è·å–å›¾ç‰‡å°è£…çš„æ–¹æ³•ï¼Œå¯ä»¥ä¸ºåŸæœ‰çš„å›¾ç‰‡å…³è”åˆ›å»ºç”¨æˆ·çš„ä¿¡æ¯ã€‚

è·å–å•ä¸ªå›¾ç‰‡å°è£…ï¼š

```java
@Override  
public PictureVO getPictureVO(Picture picture, HttpServletRequest request) {  
    // å¯¹è±¡è½¬å°è£…ç±»  
    PictureVO pictureVO = PictureVO.objToVo(picture);  
    // å…³è”æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯  
    Long userId = picture.getUserId();  
    if (userId != null && userId > 0) {  
        User user = userService.getById(userId);  
        UserVO userVO = userService.getUserVO(user);  
        pictureVO.setUser(userVO);  
    }  
    return pictureVO;  
}
```

åˆ†é¡µè·å–å›¾ç‰‡å°è£…ï¼š

```java
/**  
 * åˆ†é¡µè·å–å›¾ç‰‡å°è£…  
 */  
@Override  
public Page<PictureVO> getPictureVOPage(Page<Picture> picturePage, HttpServletRequest request) {  
    List<Picture> pictureList = picturePage.getRecords();  
    Page<PictureVO> pictureVOPage = new Page<>(picturePage.getCurrent(), picturePage.getSize(), picturePage.getTotal());  
    if (CollUtil.isEmpty(pictureList)) {  
        return pictureVOPage;  
    }  
    // å¯¹è±¡åˆ—è¡¨ => å°è£…å¯¹è±¡åˆ—è¡¨  
    List<PictureVO> pictureVOList = pictureList.stream().map(PictureVO::objToVo).collect(Collectors.toList());  
    // 1. å…³è”æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯  
    Set<Long> userIdSet = pictureList.stream().map(Picture::getUserId).collect(Collectors.toSet());  
    Map<Long, List<User>> userIdUserListMap = userService.listByIds(userIdSet).stream()  
            .collect(Collectors.groupingBy(User::getId));  
    // 2. å¡«å……ä¿¡æ¯  
    pictureVOList.forEach(pictureVO -> {  
        Long userId = pictureVO.getUserId();  
        User user = null;  
        if (userIdUserListMap.containsKey(userId)) {  
            user = userIdUserListMap.get(userId).get(0);  
        }  
        pictureVO.setUser(userService.getUserVO(user));  
    });  
    pictureVOPage.setRecords(pictureVOList);  
    return pictureVOPage;  
}
```

æ³¨æ„ï¼Œè¿™é‡Œæˆ‘ä»¬åšäº†ä¸ªå°ä¼˜åŒ–ï¼Œä¸æ˜¯é’ˆå¯¹æ¯æ¡æ•°æ®éƒ½æŸ¥è¯¢ä¸€æ¬¡ç”¨æˆ·ï¼Œè€Œæ˜¯å…ˆè·å–åˆ°è¦æŸ¥è¯¢çš„ç”¨æˆ· id åˆ—è¡¨ï¼Œåªå‘é€ä¸€æ¬¡æŸ¥è¯¢ç”¨æˆ·è¡¨çš„è¯·æ±‚ï¼Œå†å°†æŸ¥åˆ°çš„å€¼è®¾ç½®åˆ°å›¾ç‰‡å¯¹è±¡ä¸­ã€‚

4ï¼‰ç¼–å†™å›¾ç‰‡æ•°æ®æ ¡éªŒæ–¹æ³•ï¼Œç”¨äºæ›´æ–°å’Œä¿®æ”¹å›¾ç‰‡æ—¶è¿›è¡Œåˆ¤æ–­ï¼š

```java
@Override  
public void validPicture(Picture picture) {  
    ThrowUtils.throwIf(picture == null, ErrorCode.PARAMS_ERROR);  
    // ä»å¯¹è±¡ä¸­å–å€¼  
    Long id = picture.getId();  
    String url = picture.getUrl();  
    String introduction = picture.getIntroduction();  
    // ä¿®æ”¹æ•°æ®æ—¶ï¼Œid ä¸èƒ½ä¸ºç©ºï¼Œæœ‰å‚æ•°åˆ™æ ¡éªŒ  
    ThrowUtils.throwIf(ObjUtil.isNull(id), ErrorCode.PARAMS_ERROR, "id ä¸èƒ½ä¸ºç©º");  
    if (StrUtil.isNotBlank(url)) {  
        ThrowUtils.throwIf(url.length() > 1024, ErrorCode.PARAMS_ERROR, "url è¿‡é•¿");  
    }  
    if (StrUtil.isNotBlank(introduction)) {  
        ThrowUtils.throwIf(introduction.length() > 800, ErrorCode.PARAMS_ERROR, "ç®€ä»‹è¿‡é•¿");  
    }  
}
```

å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€è¦ï¼Œè¡¥å……æ›´å¤šæ ¡éªŒè§„åˆ™ã€‚

#### 3ã€æ¥å£å¼€å‘

ä¸Šè¿°åŠŸèƒ½å…¶å®éƒ½æ˜¯æ ·æ¿ä»£ç ï¼Œä¿—ç§° â€œå¢åˆ æ”¹æŸ¥â€ã€‚

ä»£ç å®ç°æ¯”è¾ƒç®€å•ï¼Œæ³¨æ„æ·»åŠ å¯¹åº”çš„æƒé™æ³¨è§£ã€åšå¥½å‚æ•°æ ¡éªŒå³å¯ï¼š

```java
/**  
 * åˆ é™¤å›¾ç‰‡  
 */  
@PostMapping("/delete")  
public BaseResponse<Boolean> deletePicture(@RequestBody DeleteRequest deleteRequest, HttpServletRequest request) {  
    if (deleteRequest == null || deleteRequest.getId() <= 0) {  
        throw new BusinessException(ErrorCode.PARAMS_ERROR);  
    }  
    User loginUser = userService.getLoginUser(request);  
    long id = deleteRequest.getId();  
    // åˆ¤æ–­æ˜¯å¦å­˜åœ¨  
    Picture oldPicture = pictureService.getById(id);  
    ThrowUtils.throwIf(oldPicture == null, ErrorCode.NOT_FOUND_ERROR);  
    // ä»…æœ¬äººæˆ–ç®¡ç†å‘˜å¯åˆ é™¤  
    if (!oldPicture.getUserId().equals(loginUser.getId()) && !userService.isAdmin(loginUser)) {  
        throw new BusinessException(ErrorCode.NO_AUTH_ERROR);  
    }  
    // æ“ä½œæ•°æ®åº“  
    boolean result = pictureService.removeById(id);  
    ThrowUtils.throwIf(!result, ErrorCode.OPERATION_ERROR);  
    return ResultUtils.success(true);  
}  
  
/**  
 * æ›´æ–°å›¾ç‰‡ï¼ˆä»…ç®¡ç†å‘˜å¯ç”¨ï¼‰  
 */  
@PostMapping("/update")  
@AuthCheck(mustRole = UserConstant.ADMIN_ROLE)  
public BaseResponse<Boolean> updatePicture(@RequestBody PictureUpdateRequest pictureUpdateRequest) {  
    if (pictureUpdateRequest == null || pictureUpdateRequest.getId() <= 0) {  
        throw new BusinessException(ErrorCode.PARAMS_ERROR);  
    }  
    // å°†å®ä½“ç±»å’Œ DTO è¿›è¡Œè½¬æ¢  
    Picture picture = new Picture();  
    BeanUtils.copyProperties(pictureUpdateRequest, picture);  
    // æ³¨æ„å°† list è½¬ä¸º string  
    picture.setTags(JSONUtil.toJsonStr(pictureUpdateRequest.getTags()));  
    // æ•°æ®æ ¡éªŒ  
    pictureService.validPicture(picture);  
    // åˆ¤æ–­æ˜¯å¦å­˜åœ¨  
    long id = pictureUpdateRequest.getId();  
    Picture oldPicture = pictureService.getById(id);  
    ThrowUtils.throwIf(oldPicture == null, ErrorCode.NOT_FOUND_ERROR);  
    // æ“ä½œæ•°æ®åº“  
    boolean result = pictureService.updateById(picture);  
    ThrowUtils.throwIf(!result, ErrorCode.OPERATION_ERROR);  
    return ResultUtils.success(true);  
}  
  
/**  
 * æ ¹æ® id è·å–å›¾ç‰‡ï¼ˆä»…ç®¡ç†å‘˜å¯ç”¨ï¼‰  
 */  
@GetMapping("/get")  
@AuthCheck(mustRole = UserConstant.ADMIN_ROLE)  
public BaseResponse<Picture> getPictureById(long id, HttpServletRequest request) {  
    ThrowUtils.throwIf(id <= 0, ErrorCode.PARAMS_ERROR);  
    // æŸ¥è¯¢æ•°æ®åº“  
    Picture picture = pictureService.getById(id);  
    ThrowUtils.throwIf(picture == null, ErrorCode.NOT_FOUND_ERROR);  
    // è·å–å°è£…ç±»  
    return ResultUtils.success(picture);  
}  
  
/**  
 * æ ¹æ® id è·å–å›¾ç‰‡ï¼ˆå°è£…ç±»ï¼‰  
 */  
@GetMapping("/get/vo")  
public BaseResponse<PictureVO> getPictureVOById(long id, HttpServletRequest request) {  
    ThrowUtils.throwIf(id <= 0, ErrorCode.PARAMS_ERROR);  
    // æŸ¥è¯¢æ•°æ®åº“  
    Picture picture = pictureService.getById(id);  
    ThrowUtils.throwIf(picture == null, ErrorCode.NOT_FOUND_ERROR);  
    // è·å–å°è£…ç±»  
    return ResultUtils.success(pictureService.getPictureVO(picture, request));  
}  
  
/**  
 * åˆ†é¡µè·å–å›¾ç‰‡åˆ—è¡¨ï¼ˆä»…ç®¡ç†å‘˜å¯ç”¨ï¼‰  
 */  
@PostMapping("/list/page")  
@AuthCheck(mustRole = UserConstant.ADMIN_ROLE)  
public BaseResponse<Page<Picture>> listPictureByPage(@RequestBody PictureQueryRequest pictureQueryRequest) {  
    long current = pictureQueryRequest.getCurrent();  
    long size = pictureQueryRequest.getPageSize();  
    // æŸ¥è¯¢æ•°æ®åº“  
    Page<Picture> picturePage = pictureService.page(new Page<>(current, size),  
            pictureService.getQueryWrapper(pictureQueryRequest));  
    return ResultUtils.success(picturePage);  
}  
  
/**  
 * åˆ†é¡µè·å–å›¾ç‰‡åˆ—è¡¨ï¼ˆå°è£…ç±»ï¼‰  
 */  
@PostMapping("/list/page/vo")  
public BaseResponse<Page<PictureVO>> listPictureVOByPage(@RequestBody PictureQueryRequest pictureQueryRequest,  
                                                         HttpServletRequest request) {  
    long current = pictureQueryRequest.getCurrent();  
    long size = pictureQueryRequest.getPageSize();  
    // é™åˆ¶çˆ¬è™«  
    ThrowUtils.throwIf(size > 20, ErrorCode.PARAMS_ERROR);  
    // æŸ¥è¯¢æ•°æ®åº“  
    Page<Picture> picturePage = pictureService.page(new Page<>(current, size),  
            pictureService.getQueryWrapper(pictureQueryRequest));  
    // è·å–å°è£…ç±»  
    return ResultUtils.success(pictureService.getPictureVOPage(picturePage, request));  
}  
  
/**  
 * ç¼–è¾‘å›¾ç‰‡ï¼ˆç»™ç”¨æˆ·ä½¿ç”¨ï¼‰  
 */  
@PostMapping("/edit")  
public BaseResponse<Boolean> editPicture(@RequestBody PictureEditRequest pictureEditRequest, HttpServletRequest request) {  
    if (pictureEditRequest == null || pictureEditRequest.getId() <= 0) {  
        throw new BusinessException(ErrorCode.PARAMS_ERROR);  
    }  
    // åœ¨æ­¤å¤„å°†å®ä½“ç±»å’Œ DTO è¿›è¡Œè½¬æ¢  
    Picture picture = new Picture();  
    BeanUtils.copyProperties(pictureEditRequest, picture);  
    // æ³¨æ„å°† list è½¬ä¸º string  
    picture.setTags(JSONUtil.toJsonStr(pictureEditRequest.getTags()));  
    // è®¾ç½®ç¼–è¾‘æ—¶é—´  
    picture.setEditTime(new Date());  
    // æ•°æ®æ ¡éªŒ  
    pictureService.validPicture(picture);  
    User loginUser = userService.getLoginUser(request);  
    // åˆ¤æ–­æ˜¯å¦å­˜åœ¨  
    long id = pictureEditRequest.getId();  
    Picture oldPicture = pictureService.getById(id);  
    ThrowUtils.throwIf(oldPicture == null, ErrorCode.NOT_FOUND_ERROR);  
    // ä»…æœ¬äººæˆ–ç®¡ç†å‘˜å¯ç¼–è¾‘  
    if (!oldPicture.getUserId().equals(loginUser.getId()) && !userService.isAdmin(loginUser)) {  
        throw new BusinessException(ErrorCode.NO_AUTH_ERROR);  
    }  
    // æ“ä½œæ•°æ®åº“  
    boolean result = pictureService.updateById(picture);  
    ThrowUtils.throwIf(!result, ErrorCode.OPERATION_ERROR);  
    return ResultUtils.success(true);  
}
```

æ³¨æ„ï¼Œä¿®æ”¹å’Œç¼–è¾‘æ¥å£ä¸­ï¼Œéœ€è¦å°†è¯·æ±‚åŒ…è£…å¯¹è±¡è½¬æ¢ä¸ºæ•°æ®åº“å®ä½“ç±»ï¼Œä¾¿äºæ“ä½œæ•°æ®åº“ã€‚è½¬æ¢çš„è¿‡ç¨‹ä¸­ï¼Œç”±äº tags çš„ç±»å‹ä¸åŒï¼Œéœ€è¦æ‰‹åŠ¨è½¬æ¢ï¼š

```java
// åœ¨æ­¤å¤„å°†å®ä½“ç±»å’Œ DTO è¿›è¡Œè½¬æ¢  
Picture picture = new Picture();  
BeanUtils.copyProperties(pictureEditRequest, picture);  
// æ³¨æ„å°† list è½¬ä¸º string  
picture.setTags(JSONUtil.toJsonStr(pictureEditRequest.getTags()));
```

ğŸ’¡ å¦‚æœè§‰å¾—æ‰‹åŠ¨è½¬æ¢æ¯”è¾ƒéº»çƒ¦ï¼Œä¹Ÿå¯ä»¥ç”¨ä¸€äº›å·¥å…·æä¾›çš„æ³¨è§£ï¼Œè®©ç±»åº“è‡ªåŠ¨å¸®ä½ è½¬æ¢ã€‚æ¯”å¦‚ JSON ç±»å‹çš„å­—æ®µ tags å¯ä»¥ä½¿ç”¨ MyBatis Plus çš„ `@TableField(typeHandler = JacksonTypeHandler.class)` æ ‡æ³¨ï¼Œ[å‚è€ƒæ–‡æ¡£](https://baomidou.com/guides/type-handler/)ã€‚

### è·å–é¢„ç½®æ ‡ç­¾å’Œåˆ†ç±»

æ ¹æ®éœ€æ±‚ï¼Œè¦æ”¯æŒç”¨æˆ·æ ¹æ®æ ‡ç­¾å’Œåˆ†ç±»æœç´¢å›¾ç‰‡ï¼Œæˆ‘ä»¬å¯ä»¥ç»™ç”¨æˆ·åˆ—ä¸¾ä¸€äº›å¸¸ç”¨çš„æ ‡ç­¾å’Œåˆ†ç±»ï¼Œä¾¿äºç­›é€‰ã€‚

åœ¨é¡¹ç›®å‰æœŸè§„æ¨¡ä¸å¤§çš„æ—¶å€™ï¼Œæˆ‘ä»¬æ²¡å¿…è¦å°†æ ‡ç­¾å’Œåˆ†ç±»å•ç‹¬ç”¨æ•°æ®è¡¨æ¥ç»´æŠ¤äº†ï¼Œç›´æ¥åœ¨ PictureController ä¸­å†™ä¸€ä¸ªæ¥å£ï¼Œè¿”å›é¢„è®¾çš„å›ºå®šæ•°æ®å³å¯ï¼š

```java
@GetMapping("/tag_category")  
public BaseResponse<PictureTagCategory> listPictureTagCategory() {  
    PictureTagCategory pictureTagCategory = new PictureTagCategory();  
    List<String> tagList = Arrays.asList("çƒ­é—¨", "æç¬‘", "ç”Ÿæ´»", "é«˜æ¸…", "è‰ºæœ¯", "æ ¡å›­", "èƒŒæ™¯", "ç®€å†", "åˆ›æ„");  
    List<String> categoryList = Arrays.asList("æ¨¡æ¿", "ç”µå•†", "è¡¨æƒ…åŒ…", "ç´ æ", "æµ·æŠ¥");  
    pictureTagCategory.setTagList(tagList);  
    pictureTagCategory.setCategoryList(categoryList);  
    return ResultUtils.success(pictureTagCategory);  
}
```

éšç€ç³»ç»Ÿè§„æ¨¡å’Œæ•°æ®ä¸æ–­æ‰©å¤§ï¼Œå¯ä»¥å†æ”¹ä¸ºä½¿ç”¨é…ç½®ä¸­å¿ƒæˆ–æ•°æ®åº“åŠ¨æ€ç®¡ç†è¿™äº›æ•°æ®ï¼Œæˆ–è€…é€šè¿‡å®šæ—¶ä»»åŠ¡è®¡ç®—å‡ºçƒ­é—¨çš„å›¾ç‰‡åˆ†ç±»å’Œæ ‡ç­¾ã€‚

------

è‡³æ­¤ï¼Œå›¾ç‰‡ç›¸å…³çš„åç«¯æ¥å£å¼€å‘å®Œæ¯•ï¼Œå¤§å®¶å¯ä»¥æŒ‰éœ€å®Œå–„ä¸Šè¿°ä»£ç ã€‚

## å››ã€å‰ç«¯å¼€å‘

ğŸ’¡ è®°å¾—æ‰§è¡Œä¸€ä¸‹ openapi å‘½ä»¤ç”Ÿæˆæ¥å£å¯¹åº”çš„è¯·æ±‚ä»£ç ï¼Œæ¯æ¬¡åç«¯æ”¹åŠ¨æ—¶éƒ½éœ€è¦è¿™ä¹ˆåšã€‚

### å›¾ç‰‡ä¸Šä¼ å’Œåˆ›å»ºé¡µé¢

#### 1ã€æ–°å»ºè·¯ç”±å’Œèœå•

é¦–å…ˆæ–°å»º `AddPicturePage.vue` é¡µé¢æ–‡ä»¶ï¼Œåœ¨ `router/index.ts` ä¸­å®šä¹‰è·¯ç”±ï¼š

```typescript
{  
  path: '/add_picture',  
  name: 'åˆ›å»ºå›¾ç‰‡',  
  component: AddPicturePage,  
},
```

åœ¨ GlobalHeader ç»„ä»¶ä¸­è¡¥å……èœå•ï¼š

```typescript
{  
  key: '/add_picture',  
  label: 'åˆ›å»ºå›¾ç‰‡',  
  title: 'åˆ›å»ºå›¾ç‰‡',  
}
```

#### 2ã€å›¾ç‰‡ä¸Šä¼ ç»„ä»¶

åœ¨å¼€å‘é¡µé¢å‰ï¼Œå…ˆå¼€å‘é€šç”¨å›¾ç‰‡ä¸Šä¼ ç»„ä»¶ PictureUploadï¼ˆæ”¾åˆ° components ç›®å½•ä¸‹ï¼‰ï¼Œæ”¯æŒä¸Šä¼ å›¾ç‰‡å¹¶è¿”å›å›¾ç‰‡ä¿¡æ¯ã€‚

1ï¼‰ä½¿ç”¨ Ant Design Vue æä¾›çš„ [upload ç»„ä»¶](https://antdv.com/components/upload-cn#components-upload-demo-avatar) å¿«é€Ÿå¼€å‘ï¼Œå¼•å…¥ç¤ºä¾‹ä»£ç åå°±èƒ½ç«‹åˆ»æµ‹è¯•æ•ˆæœäº†ï¼š

2ï¼‰è¯¥ç»„ä»¶ä¸ºå—æ§ç»„ä»¶ï¼Œç”±çˆ¶ç»„ä»¶ï¼ˆå›¾ç‰‡åˆ›å»ºé¡µé¢ï¼‰æ¥ç®¡ç†ï¼Œéœ€è¦å®šä¹‰å±æ€§ï¼š

```typescript
interface Props {  
  picture?: API.PictureVO  
  onSuccess?: (newPicture: API.PictureVO) => void  
}  
  
const props = defineProps<Props>()
```

å…¶ä¸­ï¼Œpicture å°±æ˜¯å·²ä¸Šä¼ çš„å›¾ç‰‡ä¿¡æ¯ï¼Œä¼šå±•ç¤ºå‡ºæ¥ï¼›onSuccess æ˜¯ä¸Šä¼ æˆåŠŸåï¼Œéœ€è¦å°†å¾—åˆ°çš„æ–°å›¾ç‰‡ä¿¡æ¯è¿”å›ç»™çˆ¶ç»„ä»¶ï¼Œæ¥æ›´æ–° picture çš„å€¼ã€‚

çˆ¶ç»„ä»¶å¯ä»¥è¿™æ ·ä½¿ç”¨ç»„ä»¶ï¼š

```vue
<PictureUpload :picture="picture" :onSuccess="onSuccess" />
const picture = ref<API.PictureVO>()  
const onSuccess = (newPicture: API.PictureVO) => {  
  picture.value = newPicture  
}
```

3ï¼‰ä¿®æ”¹é¡µé¢ç»“æ„ä»£ç ï¼Œæ›´æ”¹å±•ç¤ºçš„å›¾ç‰‡åœ°å€ã€æ–‡æ¡ˆç­‰ï¼š

```vue
<div class="picture-upload">  
  <a-upload  
    list-type="picture-card"  
    :show-upload-list="false"  
    :custom-request="handleUpload"  
    :before-upload="beforeUpload"  
  >  
    <img v-if="picture?.url" :src="picture?.url" alt="avatar" />  
    <div v-else>  
      <loading-outlined v-if="loading"></loading-outlined>  
      <plus-outlined v-else></plus-outlined>  
      <div class="ant-upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ å›¾ç‰‡</div>  
    </div>  
  </a-upload>  
</div>
```

4ï¼‰Upload ç»„ä»¶æ”¯æŒä¸Šä¼ å‰æ ¡éªŒå’Œè‡ªå®šä¹‰è¯·æ±‚å¤„ç†é€»è¾‘ï¼Œæˆ‘ä»¬å¯ä»¥ç¼–å†™å¯¹åº”çš„å‡½æ•°å¹¶ä¼ é€’ç»™ç»„ä»¶ã€‚

ä¸Šä¼ å‰æ ¡éªŒå‡½æ•°ï¼š

```typescript
const beforeUpload = (file: UploadProps['fileList'][number]) => {  
  const isJpgOrPng = file.type === 'image/jpeg' || file.type === 'image/png'  
  if (!isJpgOrPng) {  
    message.error('ä¸æ”¯æŒä¸Šä¼ è¯¥æ ¼å¼çš„å›¾ç‰‡ï¼Œæ¨è jpg æˆ– png')  
  }  
  const isLt2M = file.size / 1024 / 1024 < 2  
  if (!isLt2M) {  
    message.error('ä¸èƒ½ä¸Šä¼ è¶…è¿‡ 2M çš„å›¾ç‰‡')  
  }  
  return isJpgOrPng && isLt2M  
}
```

ä¸Šä¼ å›¾ç‰‡è‡³åç«¯çš„å‡½æ•°ï¼š

```typescript
const loading = ref<boolean>(false)  
  
/**  
 * ä¸Šä¼   
 * @param file  
 */  
const handleUpload = async ({ file }: any) => {  
  loading.value = true  
  try {  
    const params = props.picture ? { id: props.picture.id } : {};  
    const res = await uploadPictureUsingPost(params, {}, file)  
    if (res.data.code === 0 && res.data.data) {  
      message.success('å›¾ç‰‡ä¸Šä¼ æˆåŠŸ')  
      // å°†ä¸Šä¼ æˆåŠŸçš„å›¾ç‰‡ä¿¡æ¯ä¼ é€’ç»™çˆ¶ç»„ä»¶  
      props.onSuccess?.(res.data.data)  
    } else {  
      message.error('å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼Œ' + res.data.message)  
    }  
  } catch (error) {  
    message.error('å›¾ç‰‡ä¸Šä¼ å¤±è´¥')  
  } finally {  
    loading.value = false  
  }  
}
```

æ³¨æ„ï¼Œè°ƒç”¨åç«¯ä¸Šä¼ å›¾ç‰‡æ¥å£æ—¶ï¼Œå¦‚æœå·²ç»æœ‰ pictureIdï¼Œè¡¨ç¤ºå¯¹å·²ä¸Šä¼ çš„å›¾ç‰‡è¿›è¡Œæ›´æ–°ï¼Œéœ€è¦å°†è¯¥å‚æ•°ä¹Ÿæ·»åŠ åˆ°è¯·æ±‚ä¸­ï¼Œå¦åˆ™æ¯æ¬¡éƒ½ä¼šæ–°å¢å›¾ç‰‡è®°å½•ã€‚

```typescript
const params = props.picture ? { id: props.picture.id } : {};
```

5ï¼‰æœ€åï¼Œå¯ä»¥å†æŒ‰éœ€ä¼˜åŒ–ä¸‹ç»„ä»¶çš„ CSS æ ·å¼ï¼Œæ¯”å¦‚è®©ç»„ä»¶çš„å®½é«˜ç­‰åŒäºçˆ¶ç»„ä»¶çš„å®½é«˜ï¼š

```css
.picture-upload :deep(.ant-upload) {  
  width: 100% !important;  
  height: 100% !important;  
  min-height: 152px;  
  min-width: 152px;  
}  
  
.picture-upload img {  
  max-width: 100%;  
  max-height: 480px;  
}  
  
.ant-upload-select-picture-card i {  
  font-size: 32px;  
  color: #999;  
}  
  
.ant-upload-select-picture-card .ant-upload-text {  
  margin-top: 8px;  
  color: #666;  
}
```

æ³¨æ„ä¸Šè¿°ä»£ç ä¸­ï¼Œéœ€è¦ä½¿ç”¨ `:deep` è¯­æ³•æ¥ä¿®æ”¹ Upload ç»„ä»¶å†…ç½®çš„æ ·å¼ã€‚

æœ€ç»ˆï¼Œç»„ä»¶çš„æ•ˆæœå¦‚å›¾ï¼š

![image](./assets/2TeabiS0wJuheJoI.webp)

#### 3ã€å¼€å‘åˆ›å»ºé¡µé¢

1ï¼‰å…ˆå¼€å‘é¡µé¢ç»“æ„ï¼Œä»ä¸Šåˆ°ä¸‹åˆ†åˆ«æ˜¯é¡µé¢æ ‡é¢˜ã€å›¾ç‰‡ä¸Šä¼ ç»„ä»¶å’Œè¡¨å•ã€‚è¡¨å•æ”¯æŒå¡«å†™åç§°ã€ç®€ä»‹ã€åˆ†ç±»å’Œæ ‡ç­¾ï¼š

```vue
<div id="addPicturePage">  
  <h2 style="margin-bottom: 16px">åˆ›å»ºå›¾ç‰‡</h2>  
  <PictureUpload :picture="picture" :onSuccess="onSuccess" />  
  <a-form layout="vertical" :model="pictureForm" @finish="handleSubmit">  
    <a-form-item label="åç§°" name="name">  
      <a-input v-model:value="pictureForm.name" placeholder="è¯·è¾“å…¥åç§°" />  
    </a-form-item>  
    <a-form-item label="ç®€ä»‹" name="introduction">  
      <a-textarea  
        v-model:value="pictureForm.introduction"  
        placeholder="è¯·è¾“å…¥ç®€ä»‹"  
        :rows="2"  
        autoSize  
        allowClear  
      />  
    </a-form-item>  
    <a-form-item label="åˆ†ç±»" name="category">  
      <a-auto-complete  
        v-model:value="pictureForm.category"  
        placeholder="è¯·è¾“å…¥åˆ†ç±»"  
        allowClear  
      />  
    </a-form-item>  
    <a-form-item label="æ ‡ç­¾" name="tags">  
      <a-select  
        v-model:value="pictureForm.tags"  
        mode="tags"  
        placeholder="è¯·è¾“å…¥æ ‡ç­¾"  
        allowClear  
      />  
    </a-form-item>  
    <a-form-item>  
      <a-button type="primary" html-type="submit" style="width: 100%">åˆ›å»º</a-button>  
    </a-form-item>  
  </a-form>  
</div>
```

æ³¨æ„ï¼Œæˆ‘ä»¬é’ˆå¯¹ä¸åŒçš„æ•°æ®ä½¿ç”¨äº†ä¸åŒçš„è¾“å…¥ç»„ä»¶ï¼š

- åç§°ï¼š[æ™®é€šè¾“å…¥æ¡†](https://antdv.com/components/input-cn#components-input-demo-basic)
- ç®€ä»‹ï¼š[TextArea å¤šè¡Œè¾“å…¥æ¡†](https://antdv.com/components/input-cn#components-input-demo-autosize-textarea)
- åˆ†ç±»ï¼š[AutoComplete è¾“å…¥æ¡†](https://antdv.com/components/auto-complete-cn)ï¼Œå¯ä»¥è‡ªç”±è¾“å…¥ï¼ŒåŒæ—¶ä¼šç»™å‡ºæœç´¢æç¤º
- æ ‡ç­¾ï¼š[Select é€‰æ‹©æ¡†](https://antdv.com/components/select-cn#components-select-demo-tags)ï¼Œä½¿ç”¨ mode="tags" æ”¯æŒè‡ªç”±è¾“å…¥å’Œå¤šé€‰

å®šä¹‰å˜é‡ï¼Œæ¥å—ä¸Šä¼ çš„å›¾ç‰‡å’Œå¡«å†™çš„è¡¨å•ä¿¡æ¯ï¼š

```typescript
const picture = ref<API.PictureVO>()  
const pictureForm = reactive<API.PictureEditRequest>({})
```

å¯ä»¥é™åˆ¶ä¸‹é¡µé¢æœ€å¤§å®½åº¦ï¼Œè®©ç”¨æˆ·è§†è§’æ›´é›†ä¸­ï¼š

```css
#addPicturePage {  
  max-width: 720px;  
  margin: 0 auto;  
}
```

æ•ˆæœå¦‚å›¾ï¼š

![image](./assets/JZfblP7uRazOLBoF.webp)

2ï¼‰ä¸Šä¼ å›¾ç‰‡åï¼Œå¯ä»¥å°†å¾—åˆ°çš„å›¾ç‰‡ä¿¡æ¯ï¼ˆæ¯”å¦‚åç§°ï¼‰å¡«å……åˆ°è¡¨å•ï¼Œç›´æ¥èµ‹å€¼å³å¯ï¼š

```typescript
const onSuccess = (newPicture: API.PictureVO) => {  
  picture.value = newPicture  
  pictureForm.name = newPicture.name  
}
```

3ï¼‰ç¼–å†™æäº¤è¡¨å•çš„å‡½æ•°ï¼Œéœ€è¦å¸¦ç€ä¸Šä¼ å›¾ç‰‡å¾—åˆ°çš„ pictureId æ¥è°ƒç”¨åç«¯ **ä¿®æ”¹å›¾ç‰‡æ¥å£**ï¼ˆè€Œä¸æ˜¯ä¸Šä¼ æ¥å£ï¼‰ï¼š

```typescript
const router = useRouter()  
  
/**  
 * æäº¤è¡¨å•  
 * @param values  
 */  
const handleSubmit = async (values: any) => {  
  const pictureId = picture.value.id  
  if (!pictureId) {  
    return  
  }  
  const res = await editPictureUsingPost({  
    id: pictureId,  
    ...values,  
  })  
  if (res.data.code === 0 && res.data.data) {  
    message.success('åˆ›å»ºæˆåŠŸ')  
    // è·³è½¬åˆ°å›¾ç‰‡è¯¦æƒ…é¡µ  
    router.push({  
      path: `/picture/${pictureId}`,  
    })  
  } else {  
    message.error('åˆ›å»ºå¤±è´¥ï¼Œ' + res.data.message)  
  }  
}
```

åˆ›å»ºæˆåŠŸåï¼Œéœ€è¦è·³è½¬åˆ°å›¾ç‰‡è¯¦æƒ…é¡µã€‚

4ï¼‰ç»™åˆ†ç±»å’Œæ ‡ç­¾é€‰æ‹©æ¡†è¡¥å……é€‰é¡¹æ•°æ®ï¼Œæ³¨æ„éœ€è¦è½¬æ¢ä¸ºè¾“å…¥ç»„ä»¶æ¥å—çš„æ ¼å¼ï¼š

```typescript
const categoryOptions = ref<string[]>([])  
const tagOptions = ref<string[]>([])  
  
// è·å–æ ‡ç­¾å’Œåˆ†ç±»é€‰é¡¹  
const getTagCategoryOptions = async () => {  
  const res = await listPictureTagCategoryUsingGet()  
  if (res.data.code === 0 && res.data.data) {  
    // è½¬æ¢æˆä¸‹æ‹‰é€‰é¡¹ç»„ä»¶æ¥å—çš„æ ¼å¼  
    tagOptions.value = (res.data.data.tagList ?? []).map((data: string) => {  
      return {  
        value: data,  
        label: data,  
      }  
    })  
    categoryOptions.value = (res.data.data.categoryList ?? []).map((data: string) => {  
      return {  
        value: data,  
        label: data,  
      }  
    })  
  } else {  
    message.error('åŠ è½½é€‰é¡¹å¤±è´¥ï¼Œ' + res.data.message)  
  }  
}  
  
onMounted(() => {  
  getTagCategoryOptions()  
})
```

ç»™ç»„ä»¶è¡¥å…… options é€‰é¡¹ï¼š

```vue
<a-form-item label="åˆ†ç±»" name="category">  
  <a-auto-complete  
    v-model:value="pictureForm.category"  
    :options="categoryOptions"  
    placeholder="è¯·è¾“å…¥åˆ†ç±»"  
    allowClear  
  />  
</a-form-item>  
<a-form-item label="æ ‡ç­¾" name="tags">  
  <a-select  
    v-model:value="pictureForm.tags"  
    :options="tagOptions"  
    mode="tags"  
    placeholder="è¯·è¾“å…¥æ ‡ç­¾"  
    allowClear  
  />  
</a-form-item>
```

æ•ˆæœå¦‚å›¾ï¼š

![image](./assets/1Nri1KHNQHhzvsy5.webp)

5ï¼‰æœ€åï¼Œå¯ä»¥å†åšä¸€äº›ä¼˜åŒ–ï¼Œæ¯”å¦‚åƒæŸè§†é¢‘ç½‘ç«™æŠ•ç¨¿ä¸€æ ·ï¼Œä¸Šä¼ å›¾ç‰‡åæ‰å±•ç¤ºæ›´å¤šè¡¨å•é¡¹ã€‚

ç›´æ¥ç”¨ v-if åˆ¤æ–­å³å¯ï¼Œpicture ä¸ºç©ºåˆ™è¡¨ç¤ºå›¾ç‰‡æœªä¸Šä¼ ï¼š

```vue
<a-form v-if="picture" layout="vertical" :model="pictureForm"@finish="handleSubmit">  
</a-form>
```

æ•ˆæœå¦‚å›¾ï¼š

![image](./assets/cVLGntKnMdovFeXu.webp)

### å›¾ç‰‡ä¿¡æ¯ä¿®æ”¹

å¯ä»¥ç›´æ¥å¤ç”¨åˆ›å»ºé¡µé¢ï¼Œåœ¨é¡µé¢åå¢åŠ  URL æŸ¥è¯¢å‚æ•° `?id=xx` è¡¨ç¤ºè¦ä¿®æ”¹å¯¹åº” id çš„å›¾ç‰‡ã€‚

æ²¡ä¼ è¿™ä¸ªå‚æ•°åˆ™è¡¨ç¤ºåˆ›å»ºæ–°å›¾ç‰‡ï¼Œæœ‰ id çš„è¯å°±ç›´æ¥æ ¹æ® id æŸ¥è¯¢åˆ° picture æ•°æ®ï¼Œå¹¶ä¸”å°†å€¼å¡«å……åˆ°è¡¨å•é¡¹ä¸­ï¼Œå…¶ä»–çš„é€»è¾‘å’Œåˆ›å»ºå›¾ç‰‡æ˜¯å…¼å®¹çš„ã€‚

1ï¼‰æ ¹æ® id æŸ¥è¯¢è¦ä¿®æ”¹çš„å›¾ç‰‡æ•°æ®ï¼Œå¹¶è®¾ç½®åˆ° picture å˜é‡ä¸­ï¼š

```typescript
const route = useRoute()  
  
// è·å–è€æ•°æ®  
const getOldPicture = async () => {  
  // è·å–æ•°æ®  
  const id = route.query?.id  
  if (id) {  
    const res = await getPictureVoByIdUsingGet({  
      id: id,  
    })  
    if (res.data.code === 0 && res.data.data) {  
      const data = res.data.data  
      picture.value = data  
      pictureForm.name = data.name  
      pictureForm.introduction = data.introduction  
      pictureForm.category = data.category  
      pictureForm.tags = data.tags  
    }  
  }  
}  
  
onMounted(() => {  
  getOldPicture()  
})
```

2ï¼‰ä¼˜åŒ–é¡µé¢ç»†èŠ‚ï¼Œæ¯”å¦‚è®¾ç½®åˆé€‚çš„æ ‡é¢˜ï¼š

```typescript
<h2 style="margin-bottom: 16px">  
  {{ route.query?.id ? 'ä¿®æ”¹å›¾ç‰‡' : 'åˆ›å»ºå›¾ç‰‡' }}  
</h2>
```

æ•ˆæœå¦‚å›¾ï¼š

![image](./assets/EaZBYLHsC57kXOHK.webp)

### å›¾ç‰‡ç®¡ç†

#### 1ã€æ–°å»ºè·¯ç”±å’Œèœå•

é¦–å…ˆæ–°å»º `admin/PictureManagePage.vue` é¡µé¢æ–‡ä»¶ï¼Œåœ¨ `router/index.ts` ä¸­å®šä¹‰è·¯ç”±ï¼š

```typescript
{  
  path: '/admin/pictureManage',  
  name: 'å›¾ç‰‡ç®¡ç†',  
  component: PictureManagePage,  
}
```

åœ¨ GlobalHeader ç»„ä»¶ä¸­è¡¥å……èœå•ï¼š

```typescript
{  
  key: '/admin/pictureManage',  
  label: 'å›¾ç‰‡ç®¡ç†',  
  title: 'å›¾ç‰‡ç®¡ç†',  
}
```

ç”±äºä¹‹å‰å·²ç»ç¼–å†™äº†æƒé™æ ¡éªŒé€»è¾‘ï¼Œåœ°å€ä»¥ /admin å¼€å¤´çš„é¡µé¢éƒ½ä¼šé™åˆ¶ä¸ºä»…ç®¡ç†å‘˜å¯è§å’Œå¯ç”¨ï¼Œæ‰€ä»¥æ— éœ€å†ç¼–å†™é¢å¤–çš„æƒé™æ ¡éªŒä»£ç ã€‚

#### 2ã€å¼€å‘ç®¡ç†é¡µé¢

è·Ÿç”¨æˆ·ç®¡ç†é¡µé¢ç±»ä¼¼ï¼Œé¡µé¢çš„ä¸Šæ–¹æ˜¯æœç´¢æ ï¼Œä¸‹æ–¹æ˜¯è¡¨æ ¼ï¼Œè¡¨æ ¼éœ€è¦æ”¯æŒåˆ†é¡µã€‚

å¤§å¤šæ•°çš„å†…å®¹å¯ä»¥ç›´æ¥å¤ç”¨ç”¨æˆ·ç®¡ç†é¡µé¢çš„ä»£ç ï¼Œå¯ä»¥å…ˆå¤åˆ¶è¿‡æ¥ï¼Œå†è¿›è¡Œä¿®æ”¹ã€‚

1ï¼‰ç»™è¡¨æ ¼å®šä¹‰å±•ç¤ºçš„åˆ—ï¼š

```typescript
const columns = [  
  {  
    title: 'id',  
    dataIndex: 'id',  
    width: 80,  
  },  
  {  
    title: 'å›¾ç‰‡',  
    dataIndex: 'url',  
  },  
  {  
    title: 'åç§°',  
    dataIndex: 'name',  
  },  
  {  
    title: 'ç®€ä»‹',  
    dataIndex: 'introduction',  
    ellipsis: true,  
  },  
  {  
    title: 'ç±»å‹',  
    dataIndex: 'category',  
  },  
  {  
    title: 'æ ‡ç­¾',  
    dataIndex: 'tags',  
  },  
  {  
    title: 'å›¾ç‰‡ä¿¡æ¯',  
    dataIndex: 'picInfo',  
  },  
  {  
    title: 'ç”¨æˆ· id',  
    dataIndex: 'userId',  
    width: 80,  
  },  
  {  
    title: 'åˆ›å»ºæ—¶é—´',  
    dataIndex: 'createTime',  
  },  
  {  
    title: 'ç¼–è¾‘æ—¶é—´',  
    dataIndex: 'editTime',  
  },  
  {  
    title: 'æ“ä½œ',  
    key: 'action',  
  },  
]
```

2ï¼‰ä»åç«¯è·å–æ•°æ®ï¼Œå¹¶æ”¯æŒæœç´¢å’Œåˆ†é¡µï¼š

```typescript
// æ•°æ®  
const dataList = ref([])  
const total = ref(0)  
  
// æœç´¢æ¡ä»¶  
const searchParams = reactive<API.PictureQueryRequest>({  
  current: 1,  
  pageSize: 10,  
  sortField: 'createTime',  
  sortOrder: 'descend',  
})  
  
// åˆ†é¡µå‚æ•°  
const pagination = computed(() => {  
  return {  
    current: searchParams.current ?? 1,  
    pageSize: searchParams.pageSize ?? 10,  
    total: total.value,  
    showSizeChanger: true,  
    showTotal: (total) => `å…± ${total} æ¡`,  
  }  
})  
  
// è·å–æ•°æ®  
const fetchData = async () => {  
  const res = await listPictureByPageUsingPost({  
    ...searchParams,  
  })  
  if (res.data.data) {  
    dataList.value = res.data.data.records ?? []  
    total.value = res.data.data.total ?? 0  
  } else {  
    message.error('è·å–æ•°æ®å¤±è´¥ï¼Œ' + res.data.message)  
  }  
}  
  
// é¡µé¢åŠ è½½æ—¶è¯·æ±‚ä¸€æ¬¡  
onMounted(() => {  
  fetchData()  
})  
  
// è·å–æ•°æ®  
const doSearch = () => {  
  // é‡ç½®æœç´¢æ¡ä»¶  
  searchParams.current = 1  
  fetchData()  
}  
  
// è¡¨æ ¼å˜åŒ–å¤„ç†  
const doTableChange = (page: any) => {  
  searchParams.current = page.current  
  searchParams.pageSize = page.pageSize  
  fetchData()  
}
```

æ³¨æ„ï¼š

1. è·Ÿç”¨æˆ·ç®¡ç†é¡µé¢ä¸åŒçš„æ˜¯ï¼Œé»˜è®¤æŒ‰ç…§åˆ›å»ºæ—¶é—´é™åºå±•ç¤ºå›¾ç‰‡ï¼Œæœ€æ–°çš„å›¾ç‰‡ä¼šè¢«ä¼˜å…ˆçœ‹åˆ°ã€‚
2. è·å–æ•°æ®æ—¶ï¼Œè°ƒç”¨çš„æ˜¯ä»…ç®¡ç†å‘˜å¯ç”¨çš„æŸ¥è¯¢æ¥å£ listPictureByPageUsingPostï¼ˆä¸æ˜¯ç»™ç”¨æˆ·ä½¿ç”¨çš„æŸ¥è¯¢åŒ…è£…ç±»æ¥å£ï¼‰

3ï¼‰è‡ªå®šä¹‰åˆ—çš„å±•ç¤ºï¼Œæ¯”å¦‚å›¾ç‰‡ã€æ ‡ç­¾ã€å›¾ç‰‡è§£æä¿¡æ¯ã€åˆ›å»ºæ—¶é—´ã€ç¼–è¾‘æ—¶é—´ç­‰ï¼š

```vue
<template #bodyCell="{ column, record }">  
  <template v-if="column.dataIndex === 'url'">  
    <a-image :src="record.url" :width="120" />  
  </template>  
  <!-- æ ‡ç­¾ -->  
  <template v-if="column.dataIndex === 'tags'">  
    <a-space wrap>  
      <a-tag v-for="tag in JSON.parse(record.tags || '[]')" :key="tag">{{ tag }}</a-tag>  
    </a-space>  
  </template>  
  <!-- å›¾ç‰‡ä¿¡æ¯ -->  
  <template v-if="column.dataIndex === 'picInfo'">  
    <div>æ ¼å¼ï¼š{{ record.picFormat }}</div>  
    <div>å®½åº¦ï¼š{{ record.picWidth }}</div>  
    <div>é«˜åº¦ï¼š{{ record.picHeight }}</div>  
    <div>å®½é«˜æ¯”ï¼š{{ record.picScale }}</div>  
    <div>å¤§å°ï¼š{{ (record.picSize / 1024).toFixed(2) }}KB</div>  
  </template>  
  <template v-else-if="column.dataIndex === 'createTime'">  
    {{ dayjs(record.createTime).format('YYYY-MM-DD HH:mm:ss') }}  
  </template>  
  <template v-else-if="column.dataIndex === 'editTime'">  
    {{ dayjs(record.editTime).format('YYYY-MM-DD HH:mm:ss') }}  
  </template>  
  <template v-else-if="column.key === 'action'">  
    <a-button type="link" danger @click="doDelete(record.id)">åˆ é™¤</a-button>  
  </template>  
</template>
```

æ³¨æ„ï¼Œç”±äºåç«¯è¿”å›çš„ tags ç±»å‹æ˜¯å­—ç¬¦ä¸²ï¼Œéœ€è¦ç”¨ `JSON.parse` è½¬ä¸º JS æ•°ç»„ã€‚

4ï¼‰å¼€å‘æœç´¢è¡¨å•ï¼Œæ”¯æŒæŒ‰ç…§å…³é”®è¯ã€ç±»å‹å’Œæ ‡ç­¾æœç´¢ï¼š

```vue
<a-form layout="inline" :model="searchParams" @finish="doSearch">  
  <a-form-item label="å…³é”®è¯" name="searchText">  
    <a-input  
      v-model:value="searchParams.searchText"  
      placeholder="ä»åç§°å’Œç®€ä»‹æœç´¢"  
      allow-clear  
    />  
  </a-form-item>  
  <a-form-item label="ç±»å‹" name="category">  
    <a-input v-model:value="searchParams.category" placeholder="è¯·è¾“å…¥ç±»å‹" allow-clear />  
  </a-form-item>  
  <a-form-item label="æ ‡ç­¾" name="tags">  
    <a-select  
      v-model:value="searchParams.tags"  
      mode="tags"  
      placeholder="è¯·è¾“å…¥æ ‡ç­¾"  
      style="min-width: 180px"  
      allow-clear  
    />  
  </a-form-item>  
  <a-form-item>  
    <a-button type="primary" html-type="submit">æœç´¢</a-button>  
  </a-form-item>  
</a-form>
```

5ï¼‰è¡¥å……æ“ä½œæŒ‰é’®ã€‚

å¯ä»¥åœ¨æœç´¢è¡¨å•ä¸Šæ–°å¢ä¸€è¡Œï¼Œå±•ç¤ºæ ‡é¢˜å’Œåˆ›å»ºå›¾ç‰‡æŒ‰é’®ï¼Œç‚¹å‡»æŒ‰é’®ä¼šæ‰“å¼€åˆ›å»ºå›¾ç‰‡é¡µé¢ï¼š

```vue
<a-flex justify="space-between">  
  <h2>å›¾ç‰‡ç®¡ç†</h2>  
  <a-button type="primary" href="/add_picture" target="_blank">+ åˆ›å»ºå›¾ç‰‡</a-button>  
</a-flex>
```

åœ¨è¡¨æ ¼æ“ä½œåˆ—ä¸­ï¼Œå¯ä»¥è¡¥å……ç¼–è¾‘æŒ‰é’®ï¼Œç‚¹å‡»åæ‰“å¼€ç¼–è¾‘å›¾ç‰‡é¡µé¢ï¼š

```vue
<a-space>  
  <a-button type="link" :href="`/add_picture?id=${record.id}`" target="_blank">ç¼–è¾‘</a-button>  
  <a-button type="link" danger @click="doDelete(record.id)">åˆ é™¤</a-button>  
</a-space>
```

æœ€ç»ˆé¡µé¢æ•ˆæœå¦‚å›¾ï¼š

![image](./assets/RPKnXlx2tFlP8Qaa.webp)

ğŸ’¡ å¦‚æœè§‰å¾—è¡¨æ ¼çš„åˆ—åœ¨çª„å±ä¸‹ä¼šå—åˆ°æŒ¤å‹ï¼Œå¯ä»¥ç»™ table ç»„ä»¶å¢åŠ å±æ€§ `:scroll="{ x: 'max-content' }"`ï¼Œä½¿è¡¨æ ¼æ”¯æŒæ¨ªå‘æ»šåŠ¨ã€‚

### å›¾ç‰‡åˆ—è¡¨é¡µï¼ˆä¸»é¡µï¼‰

æ•´ä¸ªé¡µé¢å¸ƒå±€ä»ä¸Šåˆ°ä¸‹ä¾æ¬¡ä¸ºï¼šæœç´¢æ¡†ã€åˆ†ç±»é€‰é¡¹ã€æ ‡ç­¾é€‰é¡¹ã€å›¾ç‰‡åˆ—è¡¨ã€åˆ†é¡µæ“ä½œæ ã€‚

#### 1ã€åˆ†é¡µåˆ—è¡¨å¼€å‘

1ï¼‰ä½¿ç”¨ [å“åº”å¼çš„ List ç»„ä»¶](https://antdv.com/components/list-cn#components-list-demo-resposive) ï¼Œä¼šæ ¹æ®å±å¹•å¤§å°è°ƒæ•´æ¯è¡Œå±•ç¤ºçš„å›¾ç‰‡æ•°ï¼š

```vue
<!-- å›¾ç‰‡åˆ—è¡¨ -->  
<a-list  
  :grid="{ gutter: 16, xs: 1, sm: 2, md: 3, lg: 4, xl: 5, xxl: 6 }"  
  :data-source="dataList"  
  :pagination="pagination"  
  :loading="loading"  
>  
  <template #renderItem="{ item: picture }">  
    <a-list-item>  
      <!-- å•å¼ å›¾ç‰‡ -->  
    </a-list-item>  
  </template>  
</a-list>
```

2ï¼‰å®šä¹‰æ•°æ®ã€æœç´¢æ¡ä»¶ã€åˆ†é¡µå‚æ•°ï¼Œä»¥åŠè·å–æ•°æ®çš„å‡½æ•°ï¼š

```typescript
// æ•°æ®  
const dataList = ref([])  
const total = ref(0)  
const loading = ref(true)  
  
// æœç´¢æ¡ä»¶  
const searchParams = reactive<API.PictureQueryRequest>({  
  current: 1,  
  pageSize: 12,  
  sortField: 'createTime',  
  sortOrder: 'descend',  
})  
  
// åˆ†é¡µå‚æ•°  
const pagination = computed(() => {  
  return {  
    current: searchParams.current ?? 1,  
    pageSize: searchParams.pageSize ?? 10,  
    total: total.value,  
    // åˆ‡æ¢é¡µå·æ—¶ï¼Œä¼šä¿®æ”¹æœç´¢å‚æ•°å¹¶è·å–æ•°æ®  
    onChange: (page, pageSize) => {  
      searchParams.current = page  
      searchParams.pageSize = pageSize  
      fetchData()  
    },  
  }  
})  
  
// è·å–æ•°æ®  
const fetchData = async () => {  
  loading.value = true  
  const res = await listPictureVoByPageUsingPost(searchParams)  
  if (res.data.data) {  
    dataList.value = res.data.data.records ?? []  
    total.value = res.data.data.total ?? 0  
  } else {  
    message.error('è·å–æ•°æ®å¤±è´¥ï¼Œ' + res.data.message)  
  }  
  loading.value = false  
}  
  
// é¡µé¢åŠ è½½æ—¶è¯·æ±‚ä¸€æ¬¡  
onMounted(() => {  
  fetchData()  
})
```

æ³¨æ„ï¼Œä¸Šè¿°ä»£ç ä¸­ï¼Œé±¼çš®æ•…æ„ç§»é™¤äº†æ•°æ®çš„æ€»æ•°å’Œåˆ‡æ¢æ¯é¡µæ•°é‡çš„é€‰æ‹©å™¨ï¼Œè¿™äº›ä¿¡æ¯æ²¡å¿…è¦å¯¹ç”¨æˆ·å±•ç¤ºï¼Œå¯ä»¥è®©é¡µé¢æ›´ç²¾ç®€ã€‚

3ï¼‰å±•ç¤ºå›¾ç‰‡ï¼Œå¯ä»¥ä½¿ç”¨ [Card ç»„ä»¶](https://antdv.com/components/card-cn#components-card-demo-flexible-content)ï¼š

```vue
<a-list-item style="padding: 0">  
  <!-- å•å¼ å›¾ç‰‡ -->  
  <a-card hoverable>  
    <template #cover>  
      <img  
        style="height: 180px; object-fit: cover"  
        :alt="picture.name"  
        :src="picture.url"  
      />  
    </template>  
    <a-card-meta :title="picture.name">  
      <template #description>  
        <a-flex>  
          <a-tag color="green">  
            {{ picture.category ?? 'é»˜è®¤' }}  
          </a-tag>  
          <a-tag v-for="tag in picture.tags" :key="tag">  
            {{ tag }}  
          </a-tag>  
        </a-flex>  
      </template>  
    </a-card-meta>  
  </a-card>  
</a-list-item>
```

æ³¨æ„ï¼Œç”±äºå›¾ç‰‡çš„å®½é«˜éƒ½æ˜¯ä¸åŒçš„ï¼Œä¸ºäº†é˜²æ­¢é¡µé¢ â€œå‚å·®ä¸é½â€ï¼Œç»™æ‰€æœ‰å›¾ç‰‡ç»Ÿä¸€è®¾ç½®ç›¸åŒçš„é«˜åº¦ã€å¹¶ä½¿ç”¨ `object-fit: cover` ä¼˜åŒ–å›¾ç‰‡çš„å±•ç¤ºæ•ˆæœï¼Œä¸ä¼šå—åˆ°æŒ¤å‹ã€‚

æ•ˆæœå¦‚å›¾ï¼š

![image](./assets/x74az2A5yAGdDM5E.webp)

#### 2ã€æœç´¢èƒ½åŠ›å¼€å‘

1ï¼‰å¼€å‘æœç´¢æ¡†ï¼Œä½¿ç”¨ [Input.Search ç»„ä»¶](https://antdv.com/components/input-cn#components-input-demo-search-input)ï¼Œå…ˆå®šä¹‰é¡µé¢ç»“æ„ï¼š

```vue
â–¼<!-- æœç´¢æ¡† -->  
<div class="search-bar">  
  <a-input-search  
    placeholder="ä»æµ·é‡å›¾ç‰‡ä¸­æœç´¢"  
    v-model:value="searchParams.searchText"  
    enter-button="æœç´¢"  
    size="large"  
    @search="doSearch"  
  />  
</div>
```

2ï¼‰ç‚¹å‡»æœç´¢æŒ‰é’®æ—¶ï¼Œè§¦å‘æœç´¢äº‹ä»¶ï¼š

```typescript
const doSearch = () => {  
  // é‡ç½®æœç´¢æ¡ä»¶  
  searchParams.current = 1  
  fetchData()  
}
```

3ï¼‰ä¼˜åŒ– CSS æ ·å¼ï¼š

```vue
#homePage .search-bar {  
  max-width: 480px;  
  margin: 0 auto 16px;  
}
```

#### 3ã€åˆ†ç±»å’Œæ ‡ç­¾ç­›é€‰èƒ½åŠ›

1ï¼‰å…ˆå¼€å‘é¡µé¢ç»“æ„ã€‚åˆ†ç±»ä»…æ”¯æŒå•é€‰ï¼Œå¯ä»¥ä½¿ç”¨ [Tabs ç»„ä»¶](https://antdv.com/components/tabs-cn#components-tabs-demo-slide)ï¼›æ ‡ç­¾æ”¯æŒå¤šé€‰ï¼Œå¯ä»¥ä½¿ç”¨ [æ ‡ç­¾é€‰æ‹©å™¨ç»„ä»¶](https://antdv.com/components/tag-cn#components-tag-demo-checkable)ã€‚

ä¸ºäº†æ”¯æŒå–æ¶ˆé€‰ä¸­çš„åˆ†ç±»ï¼Œå¯ä»¥æ–°å¢ä¸€ä¸ª â€œå…¨éƒ¨â€ åˆ†ç±»ï¼Œé¡µé¢ä»£ç å¦‚ä¸‹ï¼š

```vue
<!-- åˆ†ç±» + æ ‡ç­¾ -->  
<a-tabs v-model:activeKey="selectedCategory" @change="doSearch">  
  <a-tab-pane key="all" tab="å…¨éƒ¨" />  
  <a-tab-pane v-for="category in categoryList" :key="category" :tab="category" />  
</a-tabs>  
<div class="tag-bar">  
  <span style="margin-right: 8px">æ ‡ç­¾ï¼š</span>  
  <a-space :size="[0, 8]" wrap>  
    <a-checkable-tag  
      v-for="(tag, index) in tagList"  
      :key="tag"  
      v-model:checked="selectedTagList[index]"  
      @change="doSearch"  
    >  
      {{ tag }}  
    </a-checkable-tag>  
  </a-space>  
</div>
```

2ï¼‰å®šä¹‰å¯é€‰åˆ†ç±» / æ ‡ç­¾åˆ—è¡¨ã€é€‰ä¸­çš„åˆ†ç±» / æ ‡ç­¾ï¼Œå¹¶è·å–åˆ†ç±»å’Œæ ‡ç­¾é€‰é¡¹ï¼š

```typescript
const categoryList = ref<string[]>([])  
const selectedCategory = ref<string>('all')  
const tagList = ref<string[]>([])  
const selectedTagList = ref<string[]>([])  
  
// è·å–æ ‡ç­¾å’Œåˆ†ç±»é€‰é¡¹  
const getTagCategoryOptions = async () => {  
  const res = await listPictureTagCategoryUsingGet()  
  if (res.data.code === 0 && res.data.data) {  
    // è½¬æ¢æˆä¸‹æ‹‰é€‰é¡¹ç»„ä»¶æ¥å—çš„æ ¼å¼  
    categoryList.value = res.data.data.categoryList ?? []  
    tagList.value = res.data.data.tagList ?? []  
  } else {  
    message.error('åŠ è½½åˆ†ç±»æ ‡ç­¾å¤±è´¥ï¼Œ' + res.data.message)  
  }  
}  
  
onMounted(() => {  
  getTagCategoryOptions()  
})
```

3ï¼‰åœ¨æœç´¢æ—¶ï¼Œéœ€è¦å°†é€‰ä¸­çš„åˆ†ç±»å’Œæ ‡ç­¾è½¬æ¢ä¸ºå¯¹åº”çš„è¯·æ±‚å‚æ•°ï¼š

```typescript
const fetchData = async () => {  
  loading.value = true  
  // è½¬æ¢æœç´¢å‚æ•°  
  const params = {  
    ...searchParams,  
    tags: [],  
  }  
  if (selectedCategory.value !== 'all') {  
    params.category = selectedCategory.value  
  }  
  selectedTagList.value.forEach((useTag, index) => {  
    if (useTag) {  
      params.tags.push(tagList.value[index])  
    }  
  })  
  const res = await listPictureVoByPageUsingPost(params)  
  if (res.data.data) {  
    dataList.value = res.data.data.records ?? []  
    total.value = res.data.data.total ?? 0  
  } else {  
    message.error('è·å–æ•°æ®å¤±è´¥ï¼Œ' + res.data.message)  
  }  
  loading.value = false  
}
```

4ï¼‰ç»™å›¾ç‰‡å¡ç‰‡ç»‘å®šç‚¹å‡»æ—¶é—´ï¼Œç‚¹å‡»å›¾ç‰‡åä¼šè·³è½¬åˆ°å›¾ç‰‡è¯¦æƒ…é¡µã€‚

ä¿®æ”¹é¡µé¢ï¼š

```vue
<!-- å•å¼ å›¾ç‰‡ -->  
<a-card hoverable @click="doClickPicture(picture)">
```

è¡¥å……è·³è½¬äº‹ä»¶ï¼š

```typescript
const router = useRouter()  
// è·³è½¬è‡³å›¾ç‰‡è¯¦æƒ…  
const doClickPicture = (picture) => {  
  router.push({  
    path: `/picture/${picture.id}`,  
  })  
}
```

æœ€ç»ˆçš„é¡µé¢æ•ˆæœå¦‚å›¾ï¼Œæ˜¯ä¸æ˜¯æœ‰å†…å‘³å„¿äº†ï¼Ÿ

![image](./assets/eCGieuUqUwa4GTWK.webp)

#### 4ã€æ‰©å±•æ€è·¯

1ï¼‰å¦‚æœæƒ³ä¿ç•™å½“å‰ç”¨æˆ·ä¹‹å‰çš„æœç´¢å‚æ•°ï¼Œå¯ä»¥åœ¨ä¿®æ”¹æœç´¢å‚æ•°æ—¶ï¼ŒåŒæ­¥ä¿®æ”¹ URL æŸ¥è¯¢å‚æ•°ï¼›å¹¶ä¸”åœ¨é¡µé¢åˆ·æ–°æ—¶ï¼Œå°† URL æŸ¥è¯¢å‚æ•°è®¾ç½®åˆ°æœç´¢å‚æ•°ä¸­ã€‚

2ï¼‰ä¼˜åŒ–å›¾ç‰‡åˆ—è¡¨çš„å±•ç¤ºæ•ˆæœã€‚å¯ä»¥ç”¨è‡ªé€‚åº”ç€‘å¸ƒæµ + ä¸‹æ‹‰åŠ è½½çš„æ–¹å¼å®ç°ï¼Œç½‘ä¸Šæœ‰å¾ˆå¤šçš„æ’ä»¶ã€‚ä½†æ˜¯æ³¨æ„ï¼Œä¸ºäº†é˜²æ­¢ä¸‹æ‹‰åŠ è½½æ—¶è·å¾—é‡å¤çš„æ•°æ®ï¼Œåç«¯æœ€å¥½æ”¹ä¸ºä½¿ç”¨æ¸¸æ ‡æŸ¥è¯¢ã€‚

3ï¼‰ä¼˜åŒ–å›¾ç‰‡æœ¬èº«çš„å±•ç¤ºæ•ˆæœã€‚å¯ä»¥å°†å¡ç‰‡çš„é¢å¤–ä¿¡æ¯æŠ˜å åˆ°å›¾ç‰‡å†…éƒ¨ï¼Œå®ç°æ‚¬æµ®é®ç½©çš„æ•ˆæœï¼Œç”¨ CSS å°±èƒ½å®ç°äº†ï¼Œç±»ä¼¼ä¸‹å›¾ï¼š



### å›¾ç‰‡è¯¦æƒ…é¡µ

#### 1ã€æ–°å»ºè·¯ç”±

é¦–å…ˆæ–°å»º `PictureDetailPage.vue` é¡µé¢æ–‡ä»¶ï¼Œåœ¨ `router/index.ts` ä¸­å®šä¹‰è·¯ç”±ï¼š

```typescript
{  
  path: '/picture/:id',  
  name: 'å›¾ç‰‡è¯¦æƒ…',  
  component: PictureDetailPage,  
  props: true,  
}
```

ç”±äºå›¾ç‰‡è¯¦æƒ…é¡µè¦å±•ç¤ºçš„å›¾ç‰‡æ˜¯æ ¹æ® id è€Œå˜åŒ–çš„ï¼Œæ‰€ä»¥æ­¤å¤„ä½¿ç”¨åŠ¨æ€è·¯ç”±ã€‚åœ¨é¡µé¢ä¸­å¯ä»¥ä½¿ç”¨ props è·å–åˆ°åŠ¨æ€çš„å‚æ•°ï¼š

```typescript
const props = defineProps<{  
  id: string | number  
}>()
```

ç„¶åå°±å¯ä»¥åœ¨é¡µé¢åŠ è½½æ—¶ï¼Œé€šè¿‡ id è°ƒç”¨æ¥å£æ¥è·å–åˆ°å›¾ç‰‡ï¼š

```typescript
const picture = ref<API.PictureVO>({})  
  
// è·å–å›¾ç‰‡è¯¦æƒ…  
const fetchPictureDetail = async () => {  
  try {  
    const res = await getPictureVoByIdUsingGet({  
      id: props.id,  
    })  
    if (res.data.code === 0 && res.data.data) {  
      picture.value = res.data.data  
    } else {  
      message.error('è·å–å›¾ç‰‡è¯¦æƒ…å¤±è´¥ï¼Œ' + res.data.message)  
    }  
  } catch (e: any) {  
    message.error('è·å–å›¾ç‰‡è¯¦æƒ…å¤±è´¥ï¼š' + e.message)  
  }  
}  
  
onMounted(() => {  
  fetchPictureDetail()  
})
```

#### 2ã€é¡µé¢å¼€å‘

1ï¼‰é‡‡ç”¨ä¸€è¡Œä¸¤åˆ—çš„å“åº”å¼å¸ƒå±€ç»“æ„ï¼Œå·¦è¾¹ä½¿ç”¨ [å›¾ç‰‡æµè§ˆç»„ä»¶](https://antdv.com/components/image-cn) å±•ç¤ºå›¾ç‰‡ï¼Œå³è¾¹ä½¿ç”¨ [æè¿°åˆ—è¡¨ç»„ä»¶](https://antdv.com/components/descriptions-cn#components-descriptions-demo-vertical) å±•ç¤ºå›¾ç‰‡ä¿¡æ¯ã€‚

```vue
<a-row :gutter="[16, 16]">  
  <!-- å›¾ç‰‡å±•ç¤ºåŒº -->  
  <a-col :sm="24" :md="16" :xl="18">  
    <a-card title="å›¾ç‰‡é¢„è§ˆ">  
      <a-image  
        style="max-height: 600px; object-fit: contain"  
        :src="picture.url"  
      />  
    </a-card>  
  </a-col>  
  <!-- å›¾ç‰‡ä¿¡æ¯åŒº -->  
  <a-col :sm="24" :md="8" :xl="6">  
    <a-card title="å›¾ç‰‡ä¿¡æ¯">  
      <a-descriptions :column="1">  
        <a-descriptions-item label="ä½œè€…">  
          <a-space>  
            <a-avatar :size="24" :src="picture.user?.userAvatar" />  
            <div>{{ picture.user?.userName }}</div>  
          </a-space>  
        </a-descriptions-item>  
        <a-descriptions-item label="åç§°">  
          {{ picture.name ?? 'æœªå‘½å' }}  
        </a-descriptions-item>  
        <a-descriptions-item label="ç®€ä»‹">  
          {{ picture.introduction ?? '-' }}  
        </a-descriptions-item>  
        <a-descriptions-item label="åˆ†ç±»">  
          {{ picture.category ?? 'é»˜è®¤' }}  
        </a-descriptions-item>  
        <a-descriptions-item label="æ ‡ç­¾">  
          <a-tag v-for="tag in picture.tags" :key="tag">  
            {{ tag }}  
          </a-tag>  
        </a-descriptions-item>  
        <a-descriptions-item label="æ ¼å¼">  
          {{ picture.picFormat ?? '-' }}  
        </a-descriptions-item>  
        <a-descriptions-item label="å®½åº¦">  
          {{ picture.picWidth ?? '-' }}  
        </a-descriptions-item>  
        <a-descriptions-item label="é«˜åº¦">  
          {{ picture.picHeight ?? '-' }}  
        </a-descriptions-item>  
        <a-descriptions-item label="å®½é«˜æ¯”">  
          {{ picture.picScale ?? '-' }}  
        </a-descriptions-item>  
        <a-descriptions-item label="å¤§å°">  
          {{ formatSize(picture.picSize) }}  
        </a-descriptions-item>  
      </a-descriptions>  
    </a-card>  
  </a-col>  
</a-row>
```

æ³¨æ„ï¼Œä¸ºäº†é˜²æ­¢å›¾ç‰‡è¿‡é«˜ï¼Œç»™å›¾ç‰‡è®¾ç½®æœ€å¤§é«˜åº¦ï¼›å¹¶ä¸”è®¾ç½® `object-fit: contain` è®©å›¾ç‰‡èƒ½å¤Ÿå®Œæ•´å±•ç¤ºã€‚

å¯ä»¥å°†è®¡ç®—å›¾ç‰‡å°ºå¯¸çš„ä»£ç ç§»åŠ¨åˆ° `utils/index.ts` ä¸­ï¼Œä½œä¸ºå·¥å…·ç±»ï¼Œå¯åœ¨å…¶ä»–ä½ç½®å¤ç”¨ï¼š

```typescript
/**  
 * æ ¼å¼åŒ–æ–‡ä»¶å¤§å°  
 * @param size  
 */  
export const formatSize = (size?: number) => {  
  if (!size) return 'æœªçŸ¥'  
  if (size < 1024) return size + ' B'  
  if (size < 1024 * 1024) return (size / 1024).toFixed(2) + ' KB'  
  return (size / (1024 * 1024)).toFixed(2) + ' MB'  
}
```

2ï¼‰åœ¨æè¿°åˆ—è¡¨ä¸‹è¡¥å……æ“ä½œæŒ‰é’®ï¼Œå¯¹äºå›¾ç‰‡ä¸Šä¼ è€…æˆ–ç®¡ç†å‘˜ï¼Œå¯ä»¥ç¼–è¾‘å’Œåˆ é™¤å›¾ç‰‡ï¼š

```vue
<a-space wrap>  
  <a-button v-if="canEdit" type="default" @click="doEdit">  
    ç¼–è¾‘  
    <template #icon>  
      <EditOutlined />  
    </template>  
  </a-button>  
  <a-button v-if="canEdit" danger @click="doDelete">  
    åˆ é™¤  
    <template #icon>  
      <DeleteOutlined />  
    </template>  
  </a-button>  
</a-space>
```

ç¼–å†™æƒé™åˆ¤æ–­é€»è¾‘ï¼ŒcanEdit çš„å€¼ä¸º true è¡¨ç¤ºæœ‰ç¼–è¾‘å’Œåˆ é™¤æƒé™ï¼š

```typescript
const loginUserStore = useLoginUserStore()  
// æ˜¯å¦å…·æœ‰ç¼–è¾‘æƒé™  
const canEdit = computed(() => {  
  const loginUser = loginUserStore.loginUser;  
  // æœªç™»å½•ä¸å¯ç¼–è¾‘  
  if (!loginUser.id) {  
    return false  
  }  
  // ä»…æœ¬äººæˆ–ç®¡ç†å‘˜å¯ç¼–è¾‘  
  const user = picture.value.user || {}  
  return loginUser.id === user.id || loginUser.userRole === 'admin'  
})
```

ç¼–å†™å¯¹åº”çš„äº‹ä»¶ï¼š

```typescript
// ç¼–è¾‘  
const doEdit = () => {  
  router.push('/add_picture?id=' + picture.value.id)  
}  
// åˆ é™¤  
const doDelete = async () => {  
  const id = picture.value.id  
  if (!id) {  
    return  
  }  
  const res = await deletePictureUsingPost({ id })  
  if (res.data.code === 0) {  
    message.success('åˆ é™¤æˆåŠŸ')  
  } else {  
    message.error('åˆ é™¤å¤±è´¥')  
  }  
}
```

### å›¾ç‰‡ä¸‹è½½

æœ€åï¼Œæˆ‘ä»¬æ¥å¼€å‘å›¾ç‰‡ä¸‹è½½åŠŸèƒ½ã€‚ä¹‹å‰æ–¹æ¡ˆè®¾è®¡ä¸­æåˆ°ï¼Œä¸ºäº†å®ç°æ–¹ä¾¿ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä»å¯¹è±¡å­˜å‚¨çš„ URL ä¸‹è½½å›¾ç‰‡ï¼Œæ— éœ€ç»è¿‡åç«¯ã€‚

å‰ç«¯å¯ä»¥ä½¿ç”¨ `file-saver` åº“ï¼Œä¸‹è½½æŒ‡å®š URL æˆ–è€…åç«¯è¿”å›çš„ blob å†…å®¹ä¸ºæ–‡ä»¶ã€‚

1ï¼‰å…ˆå®‰è£… `file-saver` åº“ï¼š

```bash
npm install file-saver  
npm i --save-dev @types/file-saver
```

2ï¼‰åœ¨å›¾ç‰‡è¯¦æƒ…é¡µçš„æ“ä½œåŒºåŸŸè¡¥å……ä¸‹è½½æŒ‰é’®ï¼š

```vue
<a-button type="primary" @click="doDownload">  
  å…è´¹ä¸‹è½½  
  <template #icon>  
    <DownloadOutlined />  
  </template>  
</a-button>
```

3ï¼‰å®šä¹‰ä¸‹è½½äº‹ä»¶ï¼š

```typescript
// å¤„ç†ä¸‹è½½  
const doDownload = () => {  
  downloadImage(picture.value.url)  
}
```

4ï¼‰åœ¨ `utils/index.ts` ä¸­è¡¥å……ä¸‹è½½å›¾ç‰‡çš„å·¥å…·å‡½æ•°ï¼š

```typescript
/**  
 * ä¸‹è½½å›¾ç‰‡  
 * @param url å›¾ç‰‡ä¸‹è½½åœ°å€  
 * @param fileName è¦ä¿å­˜ä¸ºçš„æ–‡ä»¶å  
 */  
export function downloadImage(url?: string, fileName?: string) {  
  if (!url) {  
    return  
  }  
  saveAs(url, fileName)  
}
```

æœ€ç»ˆé¡µé¢æ•ˆæœå¦‚å›¾ï¼š

![image](./assets/iItZMgOx0idfaeQj.webp)

## äº”ã€æ‰©å±•æ€è·¯

1ï¼‰ä½¿ç”¨æ•°æ®åº“è¡¨åŠ¨æ€ç®¡ç†ç½‘ç«™çš„æ ‡ç­¾å’Œåˆ†ç±»ï¼Œå‰ç«¯ä¹Ÿå¯ä»¥æ·»åŠ å¯¹åº”çš„ç®¡ç†ç•Œé¢ï¼Œå³æ ‡ç­¾ç®¡ç†å’Œåˆ†ç±»ç®¡ç†ã€‚

2ï¼‰å¯ä»¥ä½¿ç”¨å®šæ—¶ä»»åŠ¡æˆ–è€…æ ‡ç­¾è¡¨å¢åŠ  â€œä½¿ç”¨æ•°â€ å­—æ®µçš„æ–¹å¼ç»Ÿè®¡æ ‡ç­¾çš„ä½¿ç”¨æ¬¡æ•°ï¼Œç»™ä¸»é¡µå±•ç¤ºå‡ºçƒ­é—¨æ ‡ç­¾ï¼Œå¸®åŠ©ç”¨æˆ·æ›´å¿«åœ°æ‰¾åˆ°éœ€è¦çš„å†…å®¹ã€‚ï¼ˆåˆ†ç±»åŒç†ï¼‰

3ï¼‰å¯ä»¥åœ¨å›¾ç‰‡ä¸Šä¼ æˆåŠŸåï¼Œåˆ©ç”¨ AI è‡ªåŠ¨è¡¥å……ç®€ä»‹ã€æ ‡ç­¾å’Œåˆ†ç±»ï¼ˆè¾ƒéš¾ï¼‰ã€‚





# 5 - ç”¨æˆ·ä¼ å›¾

## æœ¬èŠ‚é‡ç‚¹

ä¹‹å‰ä¸ºäº†æ–¹ä¾¿å’Œå®‰å…¨æ€§ï¼Œåªæ”¯æŒç®¡ç†å‘˜ä¸Šä¼ å›¾ç‰‡ï¼Œå¦‚æœæƒ³è®©å¹³å°ç´ ææ›´ä¸°å¯Œï¼Œä¹Ÿè¦å…è®¸ç”¨æˆ·è‡ªä¸»ä¸Šä¼ å›¾ç‰‡ã€‚

æœ¬èŠ‚æˆ‘ä»¬å°±é‡ç‚¹å¼€å‘ç”¨æˆ·ä¼ å›¾èƒ½åŠ›ï¼Œå¹¶æ”¯æŒæ›´å¤šä¼ å›¾çš„æ–¹å¼ï¼Œå¤§çº²ï¼š

- æ”¯æŒç”¨æˆ·ä¸Šä¼ å›¾ç‰‡å’Œå®¡æ ¸åŠŸèƒ½
- é€šè¿‡ URL å¯¼å…¥å›¾ç‰‡
- æ‰¹é‡æŠ“å–å’Œåˆ›å»ºå›¾ç‰‡

## ä¸€ã€ç”¨æˆ·ä¸Šä¼ å›¾ç‰‡åŠå®¡æ ¸

### éœ€æ±‚åˆ†æ

ä¹‹å‰æˆ‘ä»¬å·²ç»å¼€å‘äº†ç®¡ç†å‘˜ä¸Šä¼ å›¾ç‰‡åŠŸèƒ½ï¼Œæƒ³å®ç°ç”¨æˆ·ä¸Šä¼ å›¾ç‰‡å°±æ¯”è¾ƒç®€å•äº†ï¼Œä½†æ˜¯æˆ‘ä»¬è¦è€ƒè™‘åˆ°ä¸€ç‚¹ â€œç”¨æˆ·ä¸Šä¼ çš„å†…å®¹å¯èƒ½æ˜¯ä¸å®‰å…¨çš„â€ã€‚

ä¸€èˆ¬åªè¦æ¶‰åŠåˆ° â€œç”¨æˆ·ä¸Šä¼ å†…å®¹â€ï¼ˆä¿—ç§° UGCï¼‰çš„åœºæ™¯ï¼Œå°±è¦å¢åŠ å®¡æ ¸åŠŸèƒ½ã€‚

å…·ä½“åˆ†ææ¯ä¸ªéœ€æ±‚ï¼š

1ï¼‰ç”¨æˆ·ä¸Šä¼ åˆ›å»ºå›¾ç‰‡ï¼šéœ€è¦å¼€æ”¾æƒé™ï¼Œå…è®¸ç”¨æˆ·ä¸Šä¼ å›¾ç‰‡ï¼ŒåŠŸèƒ½å’Œæµç¨‹è·Ÿä¹‹å‰ç®¡ç†å‘˜ä¸Šä¼ å›¾ç‰‡ä¸€è‡´ï¼Œä¹Ÿè¦å¢åŠ æ–‡ä»¶æ ¡éªŒã€‚

2ï¼‰ç®¡ç†å‘˜å®¡æ ¸å›¾ç‰‡ï¼šç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹å’Œ **ç­›é€‰** æ‰€æœ‰å¾…å®¡æ ¸çš„å›¾ç‰‡ï¼Œå¹¶æ ‡è®°ä¸ºé€šè¿‡æˆ–æ‹’ç»ï¼Œå¯å¡«å†™é€šè¿‡æˆ–æ‹’ç»çš„å…·ä½“åŸå› ã€‚æ­¤å¤–ï¼Œéœ€è¦è®°å½•å®¡æ ¸äººå’Œå®¡æ ¸æ—¶é—´ä½œä¸ºæ—¥å¿—ï¼Œå¦‚æœå‘ç°è¯¯å®¡çš„æƒ…å†µä¹Ÿå¯ä»¥è¿½è´£ã€‚

### æ–¹æ¡ˆè®¾è®¡

æ–¹æ¡ˆè®¾è®¡é˜¶æ®µæˆ‘ä»¬éœ€è¦ç¡®è®¤ï¼š

- å®¡æ ¸çš„å…·ä½“é€»è¾‘
- åº“è¡¨è®¾è®¡

#### 1ã€å®¡æ ¸é€»è¾‘

1ï¼‰ç®¡ç†å‘˜å¯ä»¥æ“ä½œå®¡æ ¸çš„çŠ¶æ€æµè½¬ï¼š

- é»˜è®¤ä¸º â€œå¾…å®¡æ ¸â€ï¼Œå¯ä»¥è®¾ç½®ä¸º â€œå®¡æ ¸é€šè¿‡â€ æˆ– â€œå®¡æ ¸æ‹’ç»â€
- å·²æ‹’ç»çš„å›¾ç‰‡å¯ä»¥é‡æ–°å®¡æ ¸ä¸ºé€šè¿‡
- å·²é€šè¿‡çš„å›¾ç‰‡å¯ä»¥æ’¤é”€ä¸ºæ‹’ç»çŠ¶æ€

2ï¼‰ç®¡ç†å‘˜è‡ªåŠ¨å®¡æ ¸ï¼šç®¡ç†å‘˜ä¸Šä¼  / æ›´æ–°å›¾ç‰‡æ—¶ï¼Œå›¾ç‰‡è‡ªåŠ¨å®¡æ ¸é€šè¿‡ï¼Œå¹¶ä¸”è‡ªåŠ¨å¡«å……å®¡æ ¸å‚æ•° â€”â€” è®¾ç½®å®¡æ ¸äººä¸ºåˆ›å»ºäººã€å®¡æ ¸æ—¶é—´ä¸ºå½“å‰æ—¶é—´ã€å®¡æ ¸åŸå› ä¸º â€œç®¡ç†å‘˜è‡ªåŠ¨è¿‡å®¡â€ã€‚

3ï¼‰ç”¨æˆ·æ“ä½œéœ€è¦å®¡æ ¸ï¼šç”¨æˆ·ä¸Šä¼ æˆ–ç¼–è¾‘å›¾ç‰‡æ—¶ï¼Œå›¾ç‰‡çš„çŠ¶æ€ä¼šè¢«é‡ç½®ä¸ºâ€œå¾…å®¡æ ¸â€ã€‚

é‡å¤å®¡æ ¸æ—¶ï¼Œæ—¢å¯ä»¥é€‰æ‹©é‡ç½® **æ‰€æœ‰** å®¡æ ¸å‚æ•°ï¼Œä¹Ÿå¯ä»¥ä»…é‡ç½®å®¡æ ¸çŠ¶æ€ã€‚å…¶ä½™å‚æ•°åœ¨å‰ç«¯ä¸å±•ç¤ºï¼Œä½†æ˜¯åœ¨åç«¯ä¿ç•™ï¼Œä»¥ä¾¿ç®¡ç†å‘˜å‚è€ƒå†å²å®¡æ ¸ä¿¡æ¯ã€‚

4ï¼‰æ§åˆ¶å†…å®¹å¯è§æ€§ï¼šå¯¹äºç”¨æˆ·æ¥è¯´ï¼Œåº”è¯¥åªèƒ½çœ‹è§ â€œå®¡æ ¸é€šè¿‡â€ çŠ¶æ€çš„æ•°æ®ï¼›ç®¡ç†å‘˜å¯ä»¥åœ¨å›¾ç‰‡ç®¡ç†é¡µé¢çœ‹åˆ°æ‰€æœ‰æ•°æ®ï¼Œå¹¶ä¸”æ ¹æ®å®¡æ ¸çŠ¶æ€ç­›é€‰å›¾ç‰‡ã€‚

Qï¼šæ˜¯å¦è¦è€ƒè™‘å¹¶å‘é—®é¢˜å‘¢ï¼Ÿ

Aï¼šç”±äºå®¡æ ¸æ“ä½œä¸ºç®¡ç†å‘˜æ‰‹åŠ¨æ‰§è¡Œï¼Œä¸æ¶‰åŠå¤æ‚çš„å¥–åŠ±æœºåˆ¶æˆ–å¹¶å‘é«˜é¢‘è¯·æ±‚ï¼Œè¯¯å®¡æ ¸æˆ–é‡å¤å®¡æ ¸å¯¹ç³»ç»Ÿå½±å“ä¸å¤§ï¼Œå› æ­¤æ— éœ€è¿‡åº¦è€ƒè™‘å¹¶å‘é—®é¢˜ã€‚

#### 2ã€åº“è¡¨è®¾è®¡

ä¸ºäº†æ”¯æŒå®¡æ ¸åŠŸèƒ½ï¼Œæˆ‘ä»¬åœ¨ picture å›¾ç‰‡è¡¨ä¸­æ–°å¢å®¡æ ¸ç›¸å…³å­—æ®µï¼ŒåŒæ—¶ä¼˜åŒ–ç´¢å¼•è®¾è®¡ä»¥æå‡æŸ¥è¯¢æ€§èƒ½ã€‚

ä¿®æ”¹è¡¨çš„ SQL å¦‚ä¸‹ï¼š

```sql
ALTER TABLE picture  
    -- æ·»åŠ æ–°åˆ—  
    ADD COLUMN reviewStatus INT DEFAULT 0 NOT NULL COMMENT 'å®¡æ ¸çŠ¶æ€ï¼š0-å¾…å®¡æ ¸; 1-é€šè¿‡; 2-æ‹’ç»',  
    ADD COLUMN reviewMessage VARCHAR(512) NULL COMMENT 'å®¡æ ¸ä¿¡æ¯',  
    ADD COLUMN reviewerId BIGINT NULL COMMENT 'å®¡æ ¸äºº ID',  
    ADD COLUMN reviewTime DATETIME NULL COMMENT 'å®¡æ ¸æ—¶é—´';  
  
-- åˆ›å»ºåŸºäº reviewStatus åˆ—çš„ç´¢å¼•  
CREATE INDEX idx_reviewStatus ON picture (reviewStatus);
```

æ³¨æ„äº‹é¡¹ï¼š

1ï¼‰å®¡æ ¸çŠ¶æ€ï¼šreviewStatus ä½¿ç”¨æ•´æ•°ï¼ˆ0ã€1ã€2ï¼‰è¡¨ç¤ºä¸åŒçš„å®¡æ ¸çŠ¶æ€ï¼Œè€Œä¸æ˜¯ç”¨å­—ç¬¦ä¸²ï¼Œå¯ä»¥èŠ‚çº¦è¡¨çš„ç©ºé—´ã€æå‡æŸ¥æ‰¾æ•ˆç‡ã€‚

2ï¼‰ç´¢å¼•è®¾è®¡ï¼šç”±äºè¦æ ¹æ®å®¡æ ¸çŠ¶æ€ç­›é€‰å›¾ç‰‡ï¼Œæ‰€ä»¥ç»™è¯¥å­—æ®µæ·»åŠ ç´¢å¼•ï¼Œæå‡æŸ¥è¯¢æ€§èƒ½ã€‚sqWmWUk8kFL4uPey9+8ro5dv7g8fCeOwW9uL7T8/Q4k=

ä¸‹é¢æˆ‘ä»¬è¿›è¡Œå¼€å‘ï¼Œå…ˆåç«¯å†å‰ç«¯ã€‚

### åç«¯å¼€å‘

#### 1ã€æ•°æ®æ¨¡å‹å¼€å‘

ç”±äºæ–°å¢äº†ä¸€äº›å®¡æ ¸ç›¸å…³çš„å­—æ®µï¼Œè¦å¯¹åŸæœ‰çš„æ•°æ®æ¨¡å‹ï¼ˆå®ä½“ç±»ã€åŒ…è£…ç±»ç­‰ï¼‰è¿›è¡Œä¿®æ”¹ã€‚

1ï¼‰å®ä½“ç±» Picture æ–°å¢ï¼š

```java
/**  
 * çŠ¶æ€ï¼š0-å¾…å®¡æ ¸; 1-é€šè¿‡; 2-æ‹’ç»  
 */  
private Integer reviewStatus;  
  
/**  
 * å®¡æ ¸ä¿¡æ¯  
 */  
private String reviewMessage;  
  
/**  
 * å®¡æ ¸äºº id  
 */  
private Long reviewerId;  
  
/**  
 * å®¡æ ¸æ—¶é—´  
 */  
private Date reviewTime;
```

2ï¼‰å›¾ç‰‡æŸ¥è¯¢è¯·æ±‚ç±» PictureQueryRequest æ–°å¢ï¼š

```java
/**  
 * çŠ¶æ€ï¼š0-å¾…å®¡æ ¸; 1-é€šè¿‡; 2-æ‹’ç»  
 */  
private Integer reviewStatus;  
  
/**  
 * å®¡æ ¸ä¿¡æ¯  
 */  
private String reviewMessage;  
  
/**  
 * å®¡æ ¸äºº id  
 */  
private Long reviewerId;
```

3ï¼‰æ–°å»ºå®¡æ ¸çŠ¶æ€æšä¸¾ç±»ï¼š

```java
@Getter  
public enum PictureReviewStatusEnum {  
    REVIEWING("å¾…å®¡æ ¸", 0),  
    PASS("é€šè¿‡", 1),  
    REJECT("æ‹’ç»", 2);  
  
    private final String text;  
    private final int value;  
  
    PictureReviewStatusEnum(String text, int value) {  
        this.text = text;  
        this.value = value;  
    }  
  
    /**  
     * æ ¹æ® value è·å–æšä¸¾  
     */  
    public static PictureReviewStatusEnum getEnumByValue(Integer value) {  
        if (ObjUtil.isEmpty(value)) {  
            return null;  
        }  
        for (PictureReviewStatusEnum pictureReviewStatusEnum : PictureReviewStatusEnum.values()) {  
            if (pictureReviewStatusEnum.value == value) {  
                return pictureReviewStatusEnum;  
            }  
        }  
        return null;  
    }  
}
```

#### 2ã€ç®¡ç†å‘˜å®¡æ ¸åŠŸèƒ½

1ï¼‰å¼€å‘è¯·æ±‚åŒ…è£…ç±»ï¼Œæ³¨æ„ä¸éœ€è¦å¢åŠ  reviewerId å’Œ reviewTime å­—æ®µï¼Œè¿™ä¸¤ä¸ªæ˜¯ç”±ç³»ç»Ÿè‡ªåŠ¨å¡«å……çš„ï¼Œè€Œä¸æ˜¯ç”±å‰ç«¯ä¼ é€’ã€‚

```java
@Data  
public class PictureReviewRequest implements Serializable {  
  
    /**  
     * id  
     */  
    private Long id;  
  
    /**  
     * çŠ¶æ€ï¼š0-å¾…å®¡æ ¸, 1-é€šè¿‡, 2-æ‹’ç»  
     */  
    private Integer reviewStatus;  
  
    /**  
     * å®¡æ ¸ä¿¡æ¯  
     */  
    private String reviewMessage;  
  
  
    private static final long serialVersionUID = 1L;  
}
```

2ï¼‰å¼€å‘å®¡æ ¸æœåŠ¡

æ¥å£ï¼š

```java
/**  
 * å›¾ç‰‡å®¡æ ¸  
 *  
 * @param pictureReviewRequest  
 * @param loginUser  
 */  
void doPictureReview(PictureReviewRequest pictureReviewRequest, User loginUser);
```

å®ç°ç±»ï¼š

```java
@Override  
public void doPictureReview(PictureReviewRequest pictureReviewRequest, User loginUser) {  
    Long id = pictureReviewRequest.getId();  
    Integer reviewStatus = pictureReviewRequest.getReviewStatus();  
    PictureReviewStatusEnum reviewStatusEnum = PictureReviewStatusEnum.getEnumByValue(reviewStatus);  
    if (id == null || reviewStatusEnum == null || PictureReviewStatusEnum.REVIEWING.equals(reviewStatusEnum)) {  
        throw new BusinessException(ErrorCode.PARAMS_ERROR);  
    }  
    // åˆ¤æ–­æ˜¯å¦å­˜åœ¨  
    Picture oldPicture = this.getById(id);  
    ThrowUtils.throwIf(oldPicture == null, ErrorCode.NOT_FOUND_ERROR);  
    // å·²æ˜¯è¯¥çŠ¶æ€  
    if (oldPicture.getReviewStatus().equals(reviewStatus)) {  
        throw new BusinessException(ErrorCode.PARAMS_ERROR, "è¯·å‹¿é‡å¤å®¡æ ¸");  
    }  
    // æ›´æ–°å®¡æ ¸çŠ¶æ€  
    Picture updatePicture = new Picture();  
    BeanUtils.copyProperties(pictureReviewRequest, updatePicture);  
    updatePicture.setReviewerId(loginUser.getId());  
    updatePicture.setReviewTime(new Date());  
    boolean result = this.updateById(updatePicture);  
    ThrowUtils.throwIf(!result, ErrorCode.OPERATION_ERROR);  
}
```

3ï¼‰å¼€å‘å®¡æ ¸æ¥å£ï¼Œæ³¨æ„æƒé™è®¾ç½®ä¸ºä»…ç®¡ç†å‘˜å¯ç”¨ï¼š

```java
@PostMapping("/review")  
@AuthCheck(mustRole = UserConstant.ADMIN_ROLE)  
public BaseResponse<Boolean> doPictureReview(@RequestBody PictureReviewRequest pictureReviewRequest,  
                                             HttpServletRequest request) {  
    ThrowUtils.throwIf(pictureReviewRequest == null, ErrorCode.PARAMS_ERROR);  
    User loginUser = userService.getLoginUser(request);  
    pictureService.doPictureReview(pictureReviewRequest, loginUser);  
    return ResultUtils.success(true);  
}
```

#### 3ã€å®¡æ ¸çŠ¶æ€è®¾ç½®

1ï¼‰æƒé™æ§åˆ¶

é¦–å…ˆå–æ¶ˆä¸Šä¼ å›¾ç‰‡æ¥å£ï¼ˆuploadPictureï¼‰çš„æƒé™æ ¡éªŒæ³¨è§£ï¼Œä½†æ˜¯æ³¨æ„ï¼Œç”±äºå›¾ç‰‡ä¸Šä¼ åŠŸèƒ½æ˜¯æ”¯æŒå›¾ç‰‡ç¼–è¾‘çš„ï¼Œæ‰€ä»¥éœ€è¦åšå¥½ç¼–è¾‘æƒé™æ§åˆ¶ â€”â€” ä»…æœ¬äººæˆ–ç®¡ç†å‘˜å¯ç¼–è¾‘ã€‚

ä¿®æ”¹ PictureService çš„ uploadPicture æ–¹æ³•ï¼Œè¡¥å……æƒé™æ ¡éªŒé€»è¾‘ï¼š

```java
// å¦‚æœæ˜¯æ›´æ–°å›¾ç‰‡ï¼Œéœ€è¦æ ¡éªŒå›¾ç‰‡æ˜¯å¦å­˜åœ¨  
if (pictureId != null) {  
    Picture oldPicture = this.getById(pictureId);  
    ThrowUtils.throwIf(oldPicture == null, ErrorCode.NOT_FOUND_ERROR, "å›¾ç‰‡ä¸å­˜åœ¨");  
    // ä»…æœ¬äººæˆ–ç®¡ç†å‘˜å¯ç¼–è¾‘  
    if (!oldPicture.getUserId().equals(loginUser.getId()) && !userService.isAdmin(loginUser)) {  
        throw new BusinessException(ErrorCode.NO_AUTH_ERROR);  
    }  
}
```

2ï¼‰è®¾ç½®å®¡æ ¸çŠ¶æ€ï¼šç®¡ç†å‘˜è‡ªåŠ¨è¿‡å®¡å¹¶ä¸”å¡«å……å®¡æ ¸å‚æ•°ï¼›ç”¨æˆ·ä¸Šä¼ æˆ–ç¼–è¾‘å›¾ç‰‡æ—¶ï¼Œå›¾ç‰‡çš„çŠ¶æ€ä¼šè¢«é‡ç½®ä¸ºâ€œå¾…å®¡æ ¸â€ã€‚

ç”±äºå›¾ç‰‡ä¸Šä¼ ã€ç”¨æˆ·ç¼–è¾‘ã€ç®¡ç†å‘˜æ›´æ–°è¿™ 3 ä¸ªæ“ä½œéƒ½éœ€è¦è®¾ç½®å®¡æ ¸çŠ¶æ€ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å…ˆç¼–å†™ä¸€ä¸ªé€šç”¨çš„ â€œè¡¥å……å®¡æ ¸å‚æ•°â€ çš„æ–¹æ³•ï¼Œæ ¹æ®ç”¨æˆ·çš„è§’è‰²ç»™å›¾ç‰‡å¯¹è±¡å¡«å……å®¡æ ¸å­—æ®µçš„å€¼ã€‚

```java
@Override  
public void fillReviewParams(Picture picture, User loginUser) {  
    if (userService.isAdmin(loginUser)) {  
        // ç®¡ç†å‘˜è‡ªåŠ¨è¿‡å®¡  
        picture.setReviewStatus(PictureReviewStatusEnum.PASS.getValue());  
        picture.setReviewerId(loginUser.getId());  
        picture.setReviewMessage("ç®¡ç†å‘˜è‡ªåŠ¨è¿‡å®¡");  
        picture.setReviewTime(new Date());  
    } else {  
        // éç®¡ç†å‘˜ï¼Œåˆ›å»ºæˆ–ç¼–è¾‘éƒ½è¦æ”¹ä¸ºå¾…å®¡æ ¸  
        picture.setReviewStatus(PictureReviewStatusEnum.REVIEWING.getValue());  
    }  
}
```

åˆ†åˆ«ç»™ 3 ä¸ªæ“ä½œè¡¥å……å®¡æ ¸å‚æ•°ã€‚å›¾ç‰‡æ›´æ–°æ¥å£ï¼š

```java
public BaseResponse<Boolean> updatePicture(@RequestBody PictureUpdateRequest pictureUpdateRequest  
        , HttpServletRequest request) {  
    // ...  
    Picture oldPicture = pictureService.getById(id);  
    ThrowUtils.throwIf(oldPicture == null, ErrorCode.NOT_FOUND_ERROR);  
    // è¡¥å……å®¡æ ¸å‚æ•°  
    User loginUser = userService.getLoginUser(request);  
    pictureService.fillReviewParams(picture, loginUser);  
    // æ“ä½œæ•°æ®åº“  
    boolean result = pictureService.updateById(picture);  
    ThrowUtils.throwIf(!result, ErrorCode.OPERATION_ERROR);  
    return ResultUtils.success(true);  
}
```

å›¾ç‰‡ä¿®æ”¹æ¥å£ï¼š

```java
public BaseResponse<Boolean> editPicture(@RequestBody PictureEditRequest pictureEditRequest, HttpServletRequest request) {  
    // ...  
    if (!oldPicture.getUserId().equals(loginUser.getId()) && !userService.isAdmin(loginUser)) {  
        throw new BusinessException(ErrorCode.NO_AUTH_ERROR);  
    }  
    // è¡¥å……å®¡æ ¸å‚æ•°  
    pictureService.fillReviewParams(picture, loginUser);  
    // æ“ä½œæ•°æ®åº“  
    boolean result = pictureService.updateById(picture);  
    ThrowUtils.throwIf(!result, ErrorCode.OPERATION_ERROR);  
    return ResultUtils.success(true);  
}
```

ä¸Šä¼ å›¾ç‰‡æœåŠ¡ï¼š

```java
@Override  
public PictureVO uploadPicture(Object inputSource, PictureUploadRequest pictureUploadRequest, User loginUser) {  
    // ...  
    picture.setPicFormat(uploadPictureResult.getPicFormat());  
    picture.setUserId(loginUser.getId());  
    // è¡¥å……å®¡æ ¸å‚æ•°  
    fillReviewParams(picture, loginUser);  
    // å¦‚æœ pictureId ä¸ä¸ºç©ºï¼Œè¡¨ç¤ºæ›´æ–°ï¼Œå¦åˆ™æ˜¯æ–°å¢  
    if (pictureId != null) {  
        // å¦‚æœæ˜¯æ›´æ–°ï¼Œéœ€è¦è¡¥å…… id å’Œç¼–è¾‘æ—¶é—´  
        picture.setId(pictureId);  
        picture.setEditTime(new Date());  
    }  
    // ...  
}
```

#### 4ã€æ§åˆ¶å†…å®¹å¯è§æ€§

ç›®å‰æˆ‘ä»¬åªæœ‰ä¸»é¡µç»™ç”¨æˆ·æŸ¥çœ‹å›¾ç‰‡åˆ—è¡¨ï¼Œæ‰€ä»¥éœ€è¦ä¿®æ”¹ä¸»é¡µè°ƒç”¨çš„ listPictureVOByPage æ¥å£ï¼Œè¡¥å……æŸ¥è¯¢æ¡ä»¶å³å¯ï¼Œé»˜è®¤åªèƒ½æŸ¥çœ‹å·²è¿‡å®¡çš„æ•°æ®ï¼š

```java
// æ™®é€šç”¨æˆ·é»˜è®¤åªèƒ½æŸ¥çœ‹å·²è¿‡å®¡çš„æ•°æ®  
pictureQueryRequest.setReviewStatus(PictureReviewStatusEnum.PASS.getValue());  
// æŸ¥è¯¢æ•°æ®åº“  
Page<Picture> picturePage = pictureService.page(new Page<>(current, size),  
        pictureService.getQueryWrapper(pictureQueryRequest));
```

éœ€è¦åŒæ­¥æ›´æ”¹ PictureService çš„ getQueryWrapper æ–¹æ³•ï¼Œæ”¯æŒæ ¹æ®å®¡æ ¸å­—æ®µè¿›è¡ŒæŸ¥è¯¢ï¼š

```java
Integer reviewStatus = pictureQueryRequest.getReviewStatus();  
String reviewMessage = pictureQueryRequest.getReviewMessage();  
Long reviewerId = pictureQueryRequest.getReviewerId();  
queryWrapper.eq(ObjUtil.isNotEmpty(reviewStatus), "reviewStatus", reviewStatus);  
queryWrapper.like(StrUtil.isNotBlank(reviewMessage), "reviewMessage", reviewMessage);  
queryWrapper.eq(ObjUtil.isNotEmpty(reviewerId), "reviewerId", reviewerId);
```

è¿™æ ·ä¸€æ¥ï¼Œåç«¯å°±åŒæ—¶æ”¯æŒäº† â€œç®¡ç†å‘˜ç­›é€‰å®¡æ ¸çŠ¶æ€â€ çš„åŠŸèƒ½ã€‚

è‡³æ­¤ï¼Œç”¨æˆ·ä¸Šä¼ å›¾ç‰‡åŠå®¡æ ¸çš„åç«¯å°±å¼€å‘å®Œæˆäº†ã€‚

Qï¼šæ ¹æ® id æŸ¥è¯¢å›¾ç‰‡çš„æ¥å£éœ€è¦åšåŒæ ·çš„é™åˆ¶ä¹ˆï¼Ÿ

Aï¼šå¯¹ç›®å‰å’±ä»¬çš„ç³»ç»Ÿæ¥è¯´ï¼Œç”¨æˆ·æ­£å¸¸æƒ…å†µä¸‹ä¸ä¼šå¾—åˆ°æœªè¿‡å®¡å›¾ç‰‡çš„ idï¼Œå½±å“é¢è¾ƒå°ï¼Œå¯ä»¥æš‚æ—¶ä¸åšï¼Œæ„Ÿå…´è¶£çš„åŒå­¦æŒ‰éœ€ä¼˜åŒ–å³å¯ã€‚

### å‰ç«¯å¼€å‘

æ§åˆ¶é¦–é¡µæœªè¿‡å®¡çš„å›¾ç‰‡ä¸å¯è§å·²ç»é€šè¿‡åç«¯æ¥å£å®ç°ï¼Œæˆ‘ä»¬åªéœ€å¼€å‘ç®¡ç†å‘˜å®¡æ ¸å’ŒæŒ‰å®¡æ ¸çŠ¶æ€ç­›é€‰å›¾ç‰‡åŠŸèƒ½å³å¯ã€‚

#### 1ã€å®šä¹‰å®¡æ ¸å¸¸é‡

å’Œåç«¯ä¸€æ ·ï¼Œå‰ç«¯ä¹Ÿæœ‰å¾ˆå¤šåœ°æ–¹è¦ç”¨åˆ°å®¡æ ¸çŠ¶æ€ä¿¡æ¯ï¼Œå¯ä»¥å®šä¹‰ä¸ºä¸€ä¸ªå¸¸é‡ã€‚

åœ¨ `constants` ç›®å½•ä¸‹æ–°å»º picture.ts å¸¸é‡æ–‡ä»¶ï¼Œå®šä¹‰æšä¸¾ä¿¡æ¯ã€å¯¹åº”çš„ä¸­æ–‡æ˜ å°„ã€ä»¥åŠåç»­ç­›é€‰å®¡æ ¸çŠ¶æ€æ—¶è¦ç”¨åˆ°çš„é€‰é¡¹æ•°ç»„ï¼š

```typescript
export const PIC_REVIEW_STATUS_ENUM = {  
  REVIEWING: 0,  
  PASS: 1,  
  REJECT: 2,  
}  
  
export const PIC_REVIEW_STATUS_MAP = {  
  0: 'å¾…å®¡æ ¸',  
  1: 'é€šè¿‡',  
  2: 'æ‹’ç»',  
}  
  
export const PIC_REVIEW_STATUS_OPTIONS = Object.keys(PIC_REVIEW_STATUS_MAP).map((key) => {  
  return {  
    label: PIC_REVIEW_STATUS_MAP[key],  
    value: key,  
  }  
})
```

#### 2ã€ç®¡ç†å‘˜å®¡æ ¸åŠŸèƒ½

1ï¼‰è¡¨æ ¼åˆ—æ–°å¢å®¡æ ¸ä¿¡æ¯ï¼š

```typescript
const columns = [  
  // ...  
  {  
    title: 'å®¡æ ¸ä¿¡æ¯',  
    dataIndex: 'reviewMessage',  
  },  
  // ...  
]
```

2ï¼‰è‡ªå®šä¹‰å®¡æ ¸ä¿¡æ¯åˆ—è¦å±•ç¤ºçš„å†…å®¹ï¼š

```vue
<!-- å®¡æ ¸ä¿¡æ¯ -->  
<template v-if="column.dataIndex === 'reviewMessage'">  
  <div>å®¡æ ¸çŠ¶æ€ï¼š{{ PIC_REVIEW_STATUS_MAP[record.reviewStatus] }}</div>  
  <div>å®¡æ ¸ä¿¡æ¯ï¼š{{ record.reviewMessage }}</div>  
  <div>å®¡æ ¸äººï¼š{{ record.reviewerId }}</div>  
</template>
```

3ï¼‰æ–°å¢å®¡æ ¸é€šè¿‡å’Œæ‹’ç»çš„æ“ä½œæŒ‰é’®ï¼š

```vue
<template v-else-if="column.key === 'action'">  
  <a-space wrap>  
    <a-button  
      v-if="record.reviewStatus !== PIC_REVIEW_STATUS_ENUM.PASS"  
      type="link"  
      @click="handleReview(record, PIC_REVIEW_STATUS_ENUM.PASS)"  
    >  
      é€šè¿‡  
    </a-button>  
    <a-button  
      v-if="record.reviewStatus !== PIC_REVIEW_STATUS_ENUM.REJECT"  
      type="link"  
      danger  
      @click="handleReview(record, PIC_REVIEW_STATUS_ENUM.REJECT)"  
    >  
      æ‹’ç»  
    </a-button>  
    <a-button type="link" :href="`/add_picture?id=${record.id}`" target="_blank"  
      >ç¼–è¾‘  
    </a-button>  
    <a-button type="link" danger @click="doDelete(record.id)">åˆ é™¤</a-button>  
  </a-space>  
</template>
```

4ï¼‰ç¼–å†™å®¡æ ¸å‡½æ•°ï¼Œè°ƒç”¨åç«¯å®Œæˆæ“ä½œï¼š

```typescript
const handleReview = async (record: API.Picture, reviewStatus: number) => {  
  const reviewMessage = reviewStatus === PIC_REVIEW_STATUS_ENUM.PASS ? 'ç®¡ç†å‘˜æ“ä½œé€šè¿‡' : 'ç®¡ç†å‘˜æ“ä½œæ‹’ç»'  
  const res = await doPictureReviewUsingPost({  
    id: record.id,  
    reviewStatus,  
    reviewMessage,  
  })  
  if (res.data.code === 0) {  
    message.success('å®¡æ ¸æ“ä½œæˆåŠŸ')  
    // é‡æ–°è·å–åˆ—è¡¨  
    fetchData()  
  } else {  
    message.error('å®¡æ ¸æ“ä½œå¤±è´¥ï¼Œ' + res.data.message)  
  }  
}
```

#### 3ã€æŒ‰å®¡æ ¸çŠ¶æ€ç­›é€‰

åªéœ€è¦åœ¨åŸæ¥çš„æœç´¢è¡¨å•ä¸­è¡¥å……ä¸€ä¸ªè¡¨å•é¡¹å³å¯ï¼Œä½¿ç”¨ä¸‹æ‹‰æ¡†ç»„ä»¶ï¼Œä¼ å…¥å®šä¹‰å¥½çš„å®¡æ ¸çŠ¶æ€å¸¸é‡ä½œä¸ºé€‰é¡¹ï¼š

```vue
<a-form-item label="å®¡æ ¸çŠ¶æ€" name="reviewStatus">  
  <a-select  
    v-model:value="searchParams.reviewStatus"  
    :options="PIC_REVIEW_STATUS_OPTIONS"  
    placeholder="è¯·è¾“å…¥å®¡æ ¸çŠ¶æ€"  
    style="min-width: 180px"  
    allow-clear  
  />  
</a-form-item>
```

#### å‰ç«¯æ‰©å±•

1ï¼‰å®¡æ ¸é€šè¿‡æˆ–æ‹’ç»æ—¶å¯ä»¥å¡«å†™åŸå› ï¼Œå¯ä»¥åˆ©ç”¨ [æ¨¡æ€æ¡†ç»„ä»¶](https://antdv.com/components/modal-cn) å®ç°

2ï¼‰å¯ä»¥åœ¨è¯¦æƒ…é¡µæ·»åŠ å®¡æ ¸é€šè¿‡ã€å®¡æ ¸æ‹’ç»çš„å¿«æ·æ“ä½œæŒ‰é’®ï¼Œä»…ç®¡ç†å‘˜å¯è§

3ï¼‰åˆ é™¤å’Œæ‹’ç»å±äºå±é™©æ“ä½œï¼Œå¯ä»¥ç‚¹å‡»åæç¤ºç¡®è®¤æ¡†ï¼Œç¡®è®¤åæ‰æ‰§è¡Œæ“ä½œã€‚å¯ä»¥åˆ©ç”¨ [ç»„ä»¶](https://antdv.com/components/popconfirm-cn) å®ç°

### æµ‹è¯•

æµ‹è¯•æµç¨‹ï¼š

1. æ™®é€šç”¨æˆ·ä¸Šä¼ å›¾ç‰‡ï¼Œæ­¤æ—¶ä¸»é¡µçœ‹ä¸åˆ°è¿™å¼ å›¾ç‰‡
2. ç®¡ç†å‘˜æ“ä½œè¿‡å®¡ï¼Œä¸»é¡µå°±å¯ä»¥çœ‹åˆ°è¿™å¼ å›¾ç‰‡
3. ç®¡ç†å‘˜æ“ä½œæ‹’ç»ï¼Œä¸»é¡µå°†æ— æ³•çœ‹åˆ°è¿™å¼ å›¾ç‰‡

è¿è¡Œæ•ˆæœå¦‚å›¾ï¼š

![image](./assets/HZvrm6emGfos4ysl.webp)![img](./assets/7mHR2JVTaEZFAHMJ.webp)

Qï¼šæœ‰åŒå­¦è¯´ï¼Œç”¨æˆ·ç°åœ¨çœ‹ä¸åˆ°è‡ªå·±è¢«æ‹’ç»çš„å›¾ç‰‡å•Šï¼Ÿæ€ä¹ˆä¿®æ”¹ï¼Ÿ

Aï¼šæœ¬é¡¹ç›®åç»­ä¼šå¸¦å¤§å®¶å¼€å‘ç”¨æˆ·ä¸ªäººç©ºé—´ï¼Œåˆ°æ—¶å€™ä¼šå®Œæˆè¿™ä¸ªåŠŸèƒ½ã€‚

#### 1ã€æ›´å¤šå®¡æ ¸ç­–ç•¥

åœ¨å®é™…ä¼ä¸šä¸­ï¼Œä¸ºäº†æé«˜å®¡æ ¸æ•ˆç‡ã€å‡å°‘åƒåœ¾å†…å®¹ï¼ŒåŒæ—¶ä¿è¯ç”¨æˆ·ä½“éªŒå’Œå¹³å°çš„å®‰å…¨æ€§ï¼Œå¸¸å¸¸ä¼šç»“åˆæŠ€æœ¯æ‰‹æ®µå’Œä¸šåŠ¡ç­–ç•¥æ¥ä¼˜åŒ–å®¡æ ¸æµç¨‹ã€‚æ¯”å¦‚ä¸‹é¢å‡ ç‚¹ï¼Œå¤§å®¶å¯ä»¥æŒ‰éœ€æ‰©å±•ï¼š

1. å†…å®¹å®‰å…¨å®¡æ ¸æœåŠ¡ï¼šå€ŸåŠ©ä¸“ä¸šçš„ç¬¬ä¸‰æ–¹å¹³å°çš„å†…å®¹å®¡æ ¸æœåŠ¡æ¥å®ç°è‡ªåŠ¨å®¡æ ¸ï¼Œåƒè…¾è®¯äº‘ã€é˜¿é‡Œäº‘ç­‰åŸºæœ¬éƒ½æ”¯æŒå›¾ç‰‡ã€æ–‡æœ¬ã€éŸ³è§†é¢‘ç­‰å†…å®¹çš„å®¡æ ¸ã€‚
2. AI å®¡æ ¸ï¼šå¯ä»¥å°†æ–‡æœ¬å†…å®¹å’Œå®¡æ ¸è§„åˆ™è¾“å…¥ç»™ AIï¼Œè®© AI è¿”å›æ˜¯å¦åˆè§„ã€‚
3. åˆ†çº§å®¡æ ¸ç­–ç•¥ï¼šåŒºåˆ†æ™®é€šç”¨æˆ·ä¸é«˜ä¿¡èª‰ç”¨æˆ·ï¼Œé«˜ä¿¡èª‰ç”¨æˆ·å¯å‡å°‘æˆ–å…é™¤å®¡æ ¸æµç¨‹ï¼Œæ¯”å¦‚ VIP ç”¨æˆ·è‡ªåŠ¨è¿‡å®¡ï¼Œä¹Ÿå¯ä»¥æé«˜éƒ¨åˆ†æ•ˆç‡ã€‚
4. å®åä¿¡æ¯å’Œå†…å®¹æº¯æºï¼šé€šè¿‡ç”¨æˆ·å®åæˆ–è€…æ‰‹æœºå·æ³¨å†Œï¼Œæé«˜ç”¨æˆ·è¡Œä¸ºçš„è´£ä»»æ„Ÿï¼Œå‡å°‘åƒåœ¾å†…å®¹çš„äº§ç”Ÿã€‚
5. ä¸¾æŠ¥æœºåˆ¶ï¼šé€šè¿‡ç»™å¹³å°å¢åŠ ä¸¾æŠ¥æœºåˆ¶ï¼Œè¿˜å¯ä»¥ç»™ä¸¾æŠ¥è¡Œä¸ºä¸€äº›å¥–åŠ±ï¼Œè®©ç”¨æˆ·å¸®å¿™ç»´æŠ¤å¹³å°ã€‚

#### 2ã€å®¡æ ¸é€šçŸ¥

å½“ç®¡ç†å‘˜å®Œæˆå®¡æ ¸åï¼Œç³»ç»Ÿå¯ä»¥é€šè¿‡æ¶ˆæ¯ä¸­å¿ƒæˆ–é‚®ä»¶é€šçŸ¥ç”¨æˆ·å®¡æ ¸ç»“æœã€‚

## äºŒã€é€šè¿‡ URL å¯¼å…¥å›¾ç‰‡

### éœ€æ±‚åˆ†æ

ä¸ºäº†æé«˜ä¸Šä¼ å›¾ç‰‡çš„æ•ˆç‡ï¼Œé™¤äº†æ”¯æŒä¸Šä¼ æœ¬åœ°æ–‡ä»¶å¤–ï¼Œè¿˜å¯ä»¥æ”¯æŒè¾“å…¥ä¸€ä¸ªè¿œç¨‹ URLï¼Œç›´æ¥å°†ç½‘ä¸Šå·²æœ‰çš„å›¾ç‰‡å¯¼å…¥åˆ°æˆ‘ä»¬çš„ç³»ç»Ÿä¸­ã€‚

### æ–¹æ¡ˆè®¾è®¡

å®ç°åŸç†å¾ˆç®€å•ï¼Œä½†æ˜¯æœ‰ä¸€äº›ç»†èŠ‚éœ€è¦æ³¨æ„ï¼š

1ï¼‰ä¸‹è½½å›¾ç‰‡ï¼šåç«¯æœåŠ¡å™¨ä»æŒ‡å®šçš„è¿œç¨‹ URL ä¸‹è½½å›¾ç‰‡åˆ°æœ¬åœ°ä¸´æ—¶å­˜å‚¨ã€‚å¯¹äº Java é¡¹ç›®ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ Hutool çš„ `HttpUtil.downloadFile` æ–¹æ³•ä¸€è¡Œä»£ç å®Œæˆã€‚

2ï¼‰æ ¡éªŒå›¾ç‰‡ï¼šè·ŸéªŒè¯æœ¬åœ°æ–‡ä»¶ä¸€æ ·ï¼Œéœ€è¦æ ¡éªŒå›¾ç‰‡çš„æ ¼å¼ã€å¤§å°ç­‰ã€‚

ä¼ ç»Ÿçš„æ ¡éªŒæ€è·¯æ˜¯å…ˆæŠŠæ–‡ä»¶ä¸‹è½½åˆ°æœ¬åœ°ï¼Œå†å¯¹æœ¬åœ°æ–‡ä»¶è¿›è¡Œæ ¡éªŒï¼Œæœ‰æ²¡æœ‰æ›´èŠ‚çœèµ„æºçš„æ–¹æ³•å‘¢ï¼Ÿ

**å…¶å®å¯ä»¥å…ˆå¯¹ URL æœ¬èº«è¿›è¡Œæ ¡éªŒã€‚**é¦–å…ˆæ˜¯æ ¡éªŒ URL å­—ç¬¦ä¸²æœ¬èº«çš„åˆæ³•æ€§ï¼Œæ¯”å¦‚è¦æ˜¯ä¸€ä¸ªåˆç†çš„ URL åœ°å€ã€‚æ­¤å¤–ï¼Œå¯ä»¥å…ˆä½¿ç”¨ `HEAD` è¯·æ±‚æ¥è·å– URL å¯¹åº”æ–‡ä»¶çš„å…ƒä¿¡æ¯ï¼ˆå¦‚æ–‡ä»¶å¤§å°ã€æ ¼å¼ç­‰ï¼‰ã€‚HEAD è¯·æ±‚ä»…è¿”å› HTTP å“åº”å¤´ä¿¡æ¯ï¼Œè€Œä¸ä¼šä¸‹è½½æ–‡ä»¶çš„å†…å®¹ï¼Œå¤§å¤§é™ä½äº†ç½‘ç»œæµé‡çš„æ¶ˆè€—ã€‚/MBNmaRtUhzDE9b4tB/jsqs1ClvvhzK+S4KVLPihc/I=

> æ³¨æ„æ­¤å¤„ä¸èƒ½ä½¿ç”¨ GET è¯·æ±‚ï¼Œå®ƒä¼šè·å–å®Œæ•´æ–‡ä»¶ã€‚

3ï¼‰ä¸Šä¼ å›¾ç‰‡ï¼šå°†æ ¡éªŒé€šè¿‡çš„å›¾ç‰‡ä¸Šä¼ åˆ°å¯¹è±¡å­˜å‚¨æœåŠ¡ï¼Œç”Ÿæˆå­˜å‚¨ URLã€‚

ä¹‹åçš„æµç¨‹å°±éƒ½å¯ä»¥å¤ç”¨ä»æœ¬åœ°ä¸Šä¼ å›¾ç‰‡çš„æµç¨‹äº†ã€‚

### åç«¯å¼€å‘

#### 1ã€æœåŠ¡å¼€å‘

å…ˆç¼–å†™é€šè¿‡ URL ä¸Šä¼ æ–‡ä»¶çš„æ–¹æ³•ï¼Œä¸ºäº†ä¾¿äºå¼€å‘ï¼Œç›´æ¥åœ¨ FileManager ç±»ä¸­ç¼–å†™ï¼Œç»å¤§å¤šæ•°ä»£ç è·Ÿä¹‹å‰çš„ uploadPicture æ–¹æ³•ä¸€è‡´ï¼Œåªéœ€è¦æ”¹åŠ¨ä»¥ä¸‹ 4 å¤„ä½ç½®ï¼š

æ–¹æ³•æ¥å—çš„å‚æ•°ï¼šä¹‹å‰æ˜¯ MultipartFile æ–‡ä»¶ç±»å‹ï¼Œç°åœ¨æ˜¯ String å­—ç¬¦ä¸²ç±»å‹

1. æ ¡éªŒå›¾ç‰‡ï¼šä¹‹å‰æ˜¯æ ¡éªŒæ–‡ä»¶ï¼Œç°åœ¨æ˜¯æ ¡éªŒ URL
2. è·å–æ–‡ä»¶åç§°ï¼šä¹‹å‰æ˜¯æ ¹æ®æ–‡ä»¶è·å–ï¼Œç°åœ¨æ˜¯æ ¹æ® URL è·å–
3. ä¿å­˜ä¸´æ—¶æ–‡ä»¶ï¼šä¹‹å‰æ˜¯å°† MultipartFile å†™å…¥åˆ°ä¸´æ—¶æ–‡ä»¶ï¼Œç°åœ¨æ˜¯ä» URL ä¸‹è½½æ–‡ä»¶

ä»£ç å¦‚ä¸‹ï¼š

```java
public UploadPictureResult uploadPictureByUrl(String fileUrl, String uploadPathPrefix) {  
    // æ ¡éªŒå›¾ç‰‡  
    // validPicture(multipartFile);  
    validPicture(fileUrl);  
    // å›¾ç‰‡ä¸Šä¼ åœ°å€  
    String uuid = RandomUtil.randomString(16);  
    // String originFilename = multipartFile.getOriginalFilename();  
    String originFilename = FileUtil.mainName(fileUrl);  
    String uploadFilename = String.format("%s_%s.%s", DateUtil.formatDate(new Date()), uuid,  
            FileUtil.getSuffix(originFilename));  
    String uploadPath = String.format("/%s/%s", uploadPathPrefix, uploadFilename);  
    File file = null;  
    try {  
        // åˆ›å»ºä¸´æ—¶æ–‡ä»¶  
        file = File.createTempFile(uploadPath, null);  
        // multipartFile.transferTo(file);  
        HttpUtil.downloadFile(fileUrl, file);  
        // ä¸Šä¼ å›¾ç‰‡  
        // ... å…¶ä½™ä»£ç ä¿æŒä¸å˜  
    } catch (Exception e) {  
        log.error("å›¾ç‰‡ä¸Šä¼ åˆ°å¯¹è±¡å­˜å‚¨å¤±è´¥", e);  
        throw new BusinessException(ErrorCode.SYSTEM_ERROR, "ä¸Šä¼ å¤±è´¥");  
    } finally {  
        this.deleteTempFile(file);  
    }  
}
```

#### 2ã€æ ¡éªŒ URL å›¾ç‰‡

ç¼–å†™æ ¡éªŒ URL å›¾ç‰‡çš„æ–¹æ³•ï¼Œåˆ†åˆ«æ ¡éªŒ URL æ ¼å¼ã€åè®®ã€æ–‡ä»¶æ˜¯å¦å­˜åœ¨ã€æ–‡ä»¶æ ¼å¼ã€æ–‡ä»¶å¤§å°ã€‚

ä»£ç å¦‚ä¸‹ï¼š

```java
private void validPicture(String fileUrl) {  
    ThrowUtils.throwIf(StrUtil.isBlank(fileUrl), ErrorCode.PARAMS_ERROR, "æ–‡ä»¶åœ°å€ä¸èƒ½ä¸ºç©º");  
  
    try {  
        // 1. éªŒè¯ URL æ ¼å¼  
        new URL(fileUrl); // éªŒè¯æ˜¯å¦æ˜¯åˆæ³•çš„ URL  
    } catch (MalformedURLException e) {  
        throw new BusinessException(ErrorCode.PARAMS_ERROR, "æ–‡ä»¶åœ°å€æ ¼å¼ä¸æ­£ç¡®");  
    }  
  
    // 2. æ ¡éªŒ URL åè®®  
    ThrowUtils.throwIf(!(fileUrl.startsWith("http://") || fileUrl.startsWith("https://")),  
            ErrorCode.PARAMS_ERROR, "ä»…æ”¯æŒ HTTP æˆ– HTTPS åè®®çš„æ–‡ä»¶åœ°å€");  
  
    // 3. å‘é€ HEAD è¯·æ±‚ä»¥éªŒè¯æ–‡ä»¶æ˜¯å¦å­˜åœ¨  
    HttpResponse response = null;  
    try {  
        response = HttpUtil.createRequest(Method.HEAD, fileUrl).execute();  
        // æœªæ­£å¸¸è¿”å›ï¼Œæ— éœ€æ‰§è¡Œå…¶ä»–åˆ¤æ–­  
        if (response.getStatus() != HttpStatus.HTTP_OK) {  
            return;  
        }  
        // 4. æ ¡éªŒæ–‡ä»¶ç±»å‹  
        String contentType = response.header("Content-Type");  
        if (StrUtil.isNotBlank(contentType)) {  
            // å…è®¸çš„å›¾ç‰‡ç±»å‹  
            final List<String> ALLOW_CONTENT_TYPES = Arrays.asList("image/jpeg", "image/jpg", "image/png", "image/webp");  
            ThrowUtils.throwIf(!ALLOW_CONTENT_TYPES.contains(contentType.toLowerCase()),  
                    ErrorCode.PARAMS_ERROR, "æ–‡ä»¶ç±»å‹é”™è¯¯");  
        }  
        // 5. æ ¡éªŒæ–‡ä»¶å¤§å°  
        String contentLengthStr = response.header("Content-Length");  
        if (StrUtil.isNotBlank(contentLengthStr)) {  
            try {  
                long contentLength = Long.parseLong(contentLengthStr);  
                final long TWO_MB = 2 * 1024 * 1024L; // é™åˆ¶æ–‡ä»¶å¤§å°ä¸º 2MB  
                ThrowUtils.throwIf(contentLength > TWO_MB, ErrorCode.PARAMS_ERROR, "æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡ 2M");  
            } catch (NumberFormatException e) {  
                throw new BusinessException(ErrorCode.PARAMS_ERROR, "æ–‡ä»¶å¤§å°æ ¼å¼é”™è¯¯");  
            }  
        }  
    } finally {  
        if (response != null) {  
            response.close();  
        }  
    }  
}
```

ä¸Šè¿°ä»£ç ä¸­ï¼Œæ³¨æ„ 2 ç‚¹ï¼š

1. æ³¨æ„å‘é€ HTTP è¯·æ±‚åï¼Œéœ€è¦å³æ—¶é‡Šæ”¾èµ„æº
2. æœ‰äº› URL åœ°å€å¯èƒ½ä¸æ”¯æŒé€šè¿‡ HEAD è¯·æ±‚è®¿é—®ï¼Œä¸ºäº†æé«˜å¯¼å…¥æˆåŠŸç‡ï¼Œå³ä½¿ HEAD è¯·æ±‚è®¿é—®å¤±è´¥ï¼Œä¹Ÿä¸ä¼šæŠ¥é”™ï¼Œå¹¶ä¸”ä¸ç”¨æ‰§è¡Œåç»­çš„æ ¡éªŒã€‚**ä»…å¯¹èƒ½è·å–åˆ°çš„ä¿¡æ¯è¿›è¡Œæ ¡éªŒã€‚**

#### 3ã€ä¼˜åŒ–ä»£ç  - æ¨¡æ¿æ–¹æ³•æ¨¡å¼

ç›®å‰æˆ‘ä»¬çš„ FileManager æ–‡ä»¶å†…å†™äº†ä¸¤ç§ä¸åŒçš„ä¸Šä¼ æ–‡ä»¶çš„æ–¹æ³•ï¼Œä½†æ˜¯æˆ‘ä»¬ä¼šå‘ç°ï¼Œè¿™ä¸¤ç§æ–¹æ³•çš„ **æµç¨‹å®Œå…¨ä¸€è‡´**ã€è€Œä¸”å¤§å¤šæ•°ä»£ç éƒ½æ˜¯ç›¸åŒçš„ã€‚

è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å°±è¦æƒ³è¦è¿ç”¨è®¾è®¡æ¨¡å¼ â€”â€” **æ¨¡æ¿æ–¹æ³•æ¨¡å¼** å¯¹ä»£ç è¿›è¡Œä¼˜åŒ–ã€‚

æ¨¡æ¿æ–¹æ³•æ¨¡å¼æ˜¯è¡Œä¸ºå‹è®¾è®¡æ¨¡å¼ï¼Œé€‚ç”¨äºå…·æœ‰é€šç”¨å¤„ç†æµç¨‹ã€ä½†å¤„ç†ç»†èŠ‚ä¸åŒçš„æƒ…å†µã€‚é€šè¿‡å®šä¹‰ä¸€ä¸ªæŠ½è±¡æ¨¡æ¿ç±»ï¼Œæä¾›é€šç”¨çš„ä¸šåŠ¡æµç¨‹å¤„ç†é€»è¾‘ï¼Œå¹¶å°†ä¸åŒçš„éƒ¨åˆ†å®šä¹‰ä¸ºæŠ½è±¡æ–¹æ³•ï¼Œç”±å­ç±»å…·ä½“å®ç°ã€‚

åœ¨æˆ‘ä»¬çš„åœºæ™¯ä¸­ï¼Œä¸¤ç§æ–‡ä»¶ä¸Šä¼ æ–¹æ³•çš„æµç¨‹éƒ½æ˜¯ï¼š

1. æ ¡éªŒæ–‡ä»¶
2. è·å–ä¸Šä¼ åœ°å€
3. è·å–æœ¬åœ°ä¸´æ—¶æ–‡ä»¶
4. ä¸Šä¼ åˆ°å¯¹è±¡å­˜å‚¨
5. å°è£…è§£æå¾—åˆ°çš„å›¾ç‰‡ä¿¡æ¯
6. æ¸…ç†ä¸´æ—¶æ–‡ä»¶

å¯ä»¥å°†è¿™äº›æµç¨‹æŠ½è±¡ä¸ºä¸€å¥—æ¨¡æ¿ï¼ˆæŠ½è±¡ç±»ï¼‰ï¼Œå°†æ¯ä¸ªå®ç°ä¸ä¸€æ ·çš„æ­¥éª¤éƒ½å®šä¹‰ä¸ºä¸€ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œæ¯”å¦‚ï¼š

1. æ ¡éªŒå›¾ç‰‡
2. è·å–æ–‡ä»¶åç§°
3. ä¿å­˜ä¸´æ—¶æ–‡ä»¶

ä¸‹é¢å¼€å§‹å¼€å‘ï¼Œå…ˆåœ¨ `manager` åŒ…ä¸‹æ–°å»º `upload` åŒ…ï¼Œå°†æ¨¡æ¿æ–¹æ³•æœ‰å…³çš„ä»£ç å…¨éƒ¨æ”¾åœ¨è¯¥åŒ…ä¸‹ç»Ÿä¸€ç®¡ç†ã€‚

1ï¼‰æ–°å»ºå›¾ç‰‡ä¸Šä¼ æ¨¡æ¿ **æŠ½è±¡ç±»** PictureUploadTemplateï¼Œä»£ç å¦‚ä¸‹ï¼š

```java
@Slf4j  
public abstract class PictureUploadTemplate {  
  
    @Resource  
    protected CosManager cosManager;  
  
    @Resource  
    protected CosClientConfig cosClientConfig;  
  
    /**  
     * æ¨¡æ¿æ–¹æ³•ï¼Œå®šä¹‰ä¸Šä¼ æµç¨‹  
     */  
    public final UploadPictureResult uploadPicture(Object inputSource, String uploadPathPrefix) {  
        // 1. æ ¡éªŒå›¾ç‰‡  
        validPicture(inputSource);  
  
        // 2. å›¾ç‰‡ä¸Šä¼ åœ°å€  
        String uuid = RandomUtil.randomString(16);  
        String originFilename = getOriginFilename(inputSource);  
        String uploadFilename = String.format("%s_%s.%s", DateUtil.formatDate(new Date()), uuid,  
                FileUtil.getSuffix(originFilename));  
        String uploadPath = String.format("/%s/%s", uploadPathPrefix, uploadFilename);  
  
        File file = null;  
        try {  
            // 3. åˆ›å»ºä¸´æ—¶æ–‡ä»¶  
            file = File.createTempFile(uploadPath, null);  
            // å¤„ç†æ–‡ä»¶æ¥æºï¼ˆæœ¬åœ°æˆ– URLï¼‰  
            processFile(inputSource, file);  
  
            // 4. ä¸Šä¼ å›¾ç‰‡åˆ°å¯¹è±¡å­˜å‚¨  
            PutObjectResult putObjectResult = cosManager.putPictureObject(uploadPath, file);  
            ImageInfo imageInfo = putObjectResult.getCiUploadResult().getOriginalInfo().getImageInfo();  
  
            // 5. å°è£…è¿”å›ç»“æœ  
            return buildResult(originFilename, file, uploadPath, imageInfo);  
        } catch (Exception e) {  
            log.error("å›¾ç‰‡ä¸Šä¼ åˆ°å¯¹è±¡å­˜å‚¨å¤±è´¥", e);  
            throw new BusinessException(ErrorCode.SYSTEM_ERROR, "ä¸Šä¼ å¤±è´¥");  
        } finally {  
            // 6. æ¸…ç†ä¸´æ—¶æ–‡ä»¶  
            deleteTempFile(file);  
        }  
    }  
  
    /**  
     * æ ¡éªŒè¾“å…¥æºï¼ˆæœ¬åœ°æ–‡ä»¶æˆ– URLï¼‰  
     */  
    protected abstract void validPicture(Object inputSource);  
  
    /**  
     * è·å–è¾“å…¥æºçš„åŸå§‹æ–‡ä»¶å  
     */  
    protected abstract String getOriginFilename(Object inputSource);  
  
    /**  
     * å¤„ç†è¾“å…¥æºå¹¶ç”Ÿæˆæœ¬åœ°ä¸´æ—¶æ–‡ä»¶  
     */  
    protected abstract void processFile(Object inputSource, File file) throws Exception;  
  
    /**  
     * å°è£…è¿”å›ç»“æœ  
     */  
    private UploadPictureResult buildResult(String originFilename, File file, String uploadPath, ImageInfo imageInfo) {  
        UploadPictureResult uploadPictureResult = new UploadPictureResult();  
        int picWidth = imageInfo.getWidth();  
        int picHeight = imageInfo.getHeight();  
        double picScale = NumberUtil.round(picWidth * 1.0 / picHeight, 2).doubleValue();  
        uploadPictureResult.setPicName(FileUtil.mainName(originFilename));  
        uploadPictureResult.setPicWidth(picWidth);  
        uploadPictureResult.setPicHeight(picHeight);  
        uploadPictureResult.setPicScale(picScale);  
        uploadPictureResult.setPicFormat(imageInfo.getFormat());  
        uploadPictureResult.setPicSize(FileUtil.size(file));  
        uploadPictureResult.setUrl(cosClientConfig.getHost() + "/" + uploadPath);  
        return uploadPictureResult;  
    }  
  
    /**  
     * åˆ é™¤ä¸´æ—¶æ–‡ä»¶  
     */  
    public void deleteTempFile(File file) {  
        if (file == null) {  
            return;  
        }  
        boolean deleteResult = file.delete();  
        if (!deleteResult) {  
            log.error("file delete error, filepath = {}", file.getAbsolutePath());  
        }  
    }  
}
```

ä¸Šè¿°ä»£ç ä¸­ï¼Œæˆ‘ä»¬æŠŠæ¯ä¸ªæ­¥éª¤éƒ½å°è£…ä¸ºäº†ä¸€ä¸ªå•ç‹¬çš„æ–¹æ³•ï¼Œå…¬å…±çš„å®ç°ï¼ˆæ¯”å¦‚ `deleteTempFile`ï¼‰å¯ä»¥ç›´æ¥æ”¾åˆ°æ¨¡æ¿ä¸­ï¼Œè€Œä¸ç”¨æ”¾åˆ°å…·ä½“çš„å®ç°ç±»ä¸­ã€‚

**æ³¨æ„ï¼Œä¸ºäº†è®©æ¨¡æ¿åŒæ—¶å…¼å®¹ MultiPartFile å’Œ String ç±»å‹çš„æ–‡ä»¶å‚æ•°ï¼Œç›´æ¥å°†è¿™ä¸¤ç§æƒ…å†µç»Ÿä¸€ä¸º Object ç±»å‹çš„ inputSource è¾“å…¥æºã€‚**

2ï¼‰æ–°å»ºæœ¬åœ°å›¾ç‰‡ä¸Šä¼ å­ç±» FilePictureUploadï¼Œç»§æ‰¿æ¨¡æ¿ï¼Œå¹¶ä¸”æ‰“ä¸Š `@Service` æ³¨è§£ç”Ÿæˆ Bean å®ä¾‹ï¼š

```java
@Service  
public class FilePictureUpload extends PictureUploadTemplate {  
  
    @Override  
    protected void validPicture(Object inputSource) {  
        MultipartFile multipartFile = (MultipartFile) inputSource;  
        ThrowUtils.throwIf(multipartFile == null, ErrorCode.PARAMS_ERROR, "æ–‡ä»¶ä¸èƒ½ä¸ºç©º");  
        // 1. æ ¡éªŒæ–‡ä»¶å¤§å°  
        long fileSize = multipartFile.getSize();  
        final long ONE_M = 1024 * 1024L;  
        ThrowUtils.throwIf(fileSize > 2 * ONE_M, ErrorCode.PARAMS_ERROR, "æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡ 2M");  
        // 2. æ ¡éªŒæ–‡ä»¶åç¼€  
        String fileSuffix = FileUtil.getSuffix(multipartFile.getOriginalFilename());  
        // å…è®¸ä¸Šä¼ çš„æ–‡ä»¶åç¼€  
        final List<String> ALLOW_FORMAT_LIST = Arrays.asList("jpeg", "jpg", "png", "webp");  
        ThrowUtils.throwIf(!ALLOW_FORMAT_LIST.contains(fileSuffix), ErrorCode.PARAMS_ERROR, "æ–‡ä»¶ç±»å‹é”™è¯¯");  
    }  
  
    @Override  
    protected String getOriginFilename(Object inputSource) {  
        MultipartFile multipartFile = (MultipartFile) inputSource;  
        return multipartFile.getOriginalFilename();  
    }  
  
    @Override  
    protected void processFile(Object inputSource, File file) throws Exception {  
        MultipartFile multipartFile = (MultipartFile) inputSource;  
        multipartFile.transferTo(file);  
    }  
}
```

3ï¼‰æ–°å»º URL å›¾ç‰‡ä¸Šä¼ å­ç±» UrlPictureUploadï¼Œç»§æ‰¿æ¨¡æ¿ï¼Œå¹¶ä¸”æ‰“ä¸Š `@Service` æ³¨è§£ç”Ÿæˆ Bean å®ä¾‹ï¼š

```java
@Service  
public class UrlPictureUpload extends PictureUploadTemplate {  
    @Override  
    protected void validPicture(Object inputSource) {  
        String fileUrl = (String) inputSource;  
        ThrowUtils.throwIf(StrUtil.isBlank(fileUrl), ErrorCode.PARAMS_ERROR, "æ–‡ä»¶åœ°å€ä¸èƒ½ä¸ºç©º");  
        // ... è·Ÿä¹‹å‰çš„æ ¡éªŒé€»è¾‘ä¿æŒä¸€è‡´  
    }  
  
    @Override  
    protected String getOriginFilename(Object inputSource) {  
        String fileUrl = (String) inputSource;  
        // ä» URL ä¸­æå–æ–‡ä»¶å  
        return FileUtil.mainName(fileUrl);  
    }  
  
    @Override  
    protected void processFile(Object inputSource, File file) throws Exception {  
        String fileUrl = (String) inputSource;  
        // ä¸‹è½½æ–‡ä»¶åˆ°ä¸´æ—¶ç›®å½•  
        HttpUtil.downloadFile(fileUrl, file);  
    }  
}
```

ä¼˜åŒ–å®Œåï¼Œå¯ä»¥è¿˜åŸ FileManager æ–‡ä»¶ï¼Œå¹¶æ·»åŠ  `@Deprecated` æ³¨è§£è¡¨ç¤ºå·²åºŸå¼ƒï¼Œåç»­å°†ç›´æ¥ä½¿ç”¨æ–‡ä»¶ä¸Šä¼ æ¨¡æ¿ç±» PictureUploadTemplateã€‚

```java
/**  
 * æ–‡ä»¶æœåŠ¡  
 * @deprecated å·²åºŸå¼ƒï¼Œæ”¹ä¸ºä½¿ç”¨ upload åŒ…çš„æ¨¡æ¿æ–¹æ³•ä¼˜åŒ–  
 */  
@Deprecated
```

#### 4ã€å›¾ç‰‡ä¸Šä¼ æœåŠ¡æ”¯æŒ URL ä¸Šä¼ 

ç”±äºå›¾ç‰‡ä¸Šä¼ çš„é€»è¾‘è¿˜æ˜¯æ¯”è¾ƒå¤æ‚çš„ï¼Œå°½é‡è®© URL ä¸Šä¼ å¤ç”¨ä¹‹å‰çš„ä»£ç ã€‚

ä½†æ˜¯ä¹‹å‰å›¾ç‰‡ä¸Šä¼ æœåŠ¡çš„ uploadPicture æ–¹æ³•æ¥å—çš„æ˜¯æ–‡ä»¶ç±»å‹çš„å‚æ•°ï¼Œç°åœ¨è¦æ”¯æŒ URL ä¸Šä¼ ï¼Œæ€ä¹ˆåŠå‘¢ï¼Ÿ

å¯ä»¥å°†è¾“å…¥å‚æ•°è·Ÿä¸Šè¿°æ¨¡æ¿ä¸€æ ·ï¼Œæ”¹ä¸º Object ç±»å‹çš„ inputSourceï¼Œç„¶ååœ¨ä»£ç ä¸­å¯ä»¥æ ¹æ® inputSource çš„å®é™…ç±»å‹ï¼Œæ¥é€‰æ‹©å¯¹åº”çš„å›¾ç‰‡ä¸Šä¼ å­ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š

```java
@Resource  
private FilePictureUpload filePictureUpload;  
  
@Resource  
private UrlPictureUpload urlPictureUpload;  
  
// ä¸Šä¼ å›¾ç‰‡  
public PictureVO uploadPicture(Object inputSource, PictureUploadRequest pictureUploadRequest, User loginUser) {  
    if (inputSource == null) {  
        throw new BusinessException(ErrorCode.PARAMS_ERROR, "å›¾ç‰‡ä¸ºç©º");  
    }  
    // ...  
    // æŒ‰ç…§ç”¨æˆ· id åˆ’åˆ†ç›®å½•  
    String uploadPathPrefix = String.format("public/%s", loginUser.getId());  
    // æ ¹æ® inputSource ç±»å‹åŒºåˆ†ä¸Šä¼ æ–¹å¼  
    PictureUploadTemplate pictureUploadTemplate = filePictureUpload;  
    if (inputSource instanceof String) {  
        pictureUploadTemplate = urlPictureUpload;  
    }  
    UploadPictureResult uploadPictureResult = pictureUploadTemplate.uploadPicture(inputSource, uploadPathPrefix);  
    // æ„é€ è¦å…¥åº“çš„å›¾ç‰‡ä¿¡æ¯  
    // ...  
}
```

ğŸ’¡ é™¤äº†é€šè¿‡å¯¹è±¡ç±»å‹åˆ¤æ–­å¤–ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ä¼ ä¸€ä¸ªä¸šåŠ¡å‚æ•°ï¼ˆå¦‚ typeï¼‰æ¥åŒºåˆ†ä¸åŒçš„ä¸Šä¼ æ–¹å¼ã€‚

#### 5ã€æ¥å£å¼€å‘

1ï¼‰åœ¨è¯·æ±‚å°è£…ç±» PictureUploadRequest ä¸­æ–°å¢ fileUrl æ–‡ä»¶åœ°å€ï¼š

```java
@Data  
public class PictureUploadRequest implements Serializable {  
  
    /**  
     * å›¾ç‰‡ idï¼ˆç”¨äºä¿®æ”¹ï¼‰  
     */  
    private Long id;  
  
    /**  
     * æ–‡ä»¶åœ°å€  
     */  
    private String fileUrl;  
  
    private static final long serialVersionUID = 1L;  
}
```

2ï¼‰åœ¨ PictureContoller ä¸­æ–°å¢æ¥å£ï¼Œé€šè¿‡ URL ä¸Šä¼ å›¾ç‰‡ï¼š

```java
/**  
 * é€šè¿‡ URL ä¸Šä¼ å›¾ç‰‡ï¼ˆå¯é‡æ–°ä¸Šä¼ ï¼‰  
 */  
@PostMapping("/upload/url")  
public BaseResponse<PictureVO> uploadPictureByUrl(  
        @RequestBody PictureUploadRequest pictureUploadRequest,  
        HttpServletRequest request) {  
    User loginUser = userService.getLoginUser(request);  
    String fileUrl = pictureUploadRequest.getFileUrl();  
    PictureVO pictureVO = pictureService.uploadPicture(fileUrl, pictureUploadRequest, loginUser);  
    return ResultUtils.success(pictureVO);  
}
```

ç„¶åå¯ä»¥é€šè¿‡ Swagger æ¥å£æ–‡æ¡£æµ‹è¯•æœ¬åœ°æ–‡ä»¶å›¾ç‰‡å’Œ URL å›¾ç‰‡çš„ä¸Šä¼ ï¼Œç¤ºä¾‹å›¾ç‰‡ URLï¼šhttps://www.codefather.cn/logo.png

### å‰ç«¯å¼€å‘

å’Œæœ¬åœ°ä¸Šä¼ å›¾ç‰‡çš„å¼€å‘æµç¨‹ä¸€æ ·ï¼Œæˆ‘ä»¬å…ˆæ¥å¼€å‘ä¸€ä¸ª URL ä¸Šä¼ å›¾ç‰‡çš„ç»„ä»¶ï¼Œç»å¤§å¤šæ•°ä»£ç éƒ½å¯ä»¥å¤ç”¨æœ¬åœ°ä¸Šä¼ å›¾ç‰‡ç»„ä»¶ã€‚

#### 1ã€URL ä¸Šä¼ ç»„ä»¶

URL ä¸Šä¼ ç»„ä»¶ = æ–‡æœ¬è¾“å…¥æ¡† + æäº¤æŒ‰é’®

å¯ä»¥ä½¿ç”¨ç»„ä»¶åº“çš„ [å¤åˆè¾“å…¥æ¡†ç»„ä»¶](https://antdv.com/components/input-cn#components-input-demo-group)ï¼š

```vue
<div class="url-picture-upload">  
  <a-input-group compact style="margin-bottom: 16px">  
    <a-input v-model:value="fileUrl" style="width: calc(100% - 120px)" placeholder="è¯·è¾“å…¥å›¾ç‰‡ URL" />  
    <a-button type="primary" :loading="loading" @click="handleUpload" style="width: 120px">æäº¤</a-button>  
  </a-input-group>  
  <img v-if="picture?.url" :src="picture?.url" alt="avatar" />  
</div>
```

å¼€å‘ä¸Šä¼ æ“ä½œå‡½æ•°ï¼Œéœ€è¦å°†ç”¨æˆ·è¾“å…¥çš„ fileUrl æäº¤åˆ°åç«¯ï¼š

```typescript
const loading = ref<boolean>(false)  
const fileUrl = ref<string>()  
  
/**  
 * ä¸Šä¼   
 */  
const handleUpload = async () => {  
  loading.value = true  
  try {  
    const params: API.PictureUploadRequest = { fileUrl: fileUrl.value }  
    if (props.picture) {  
      params.id = props.picture.id  
    }  
    const res = await uploadPictureByUrlUsingPost(params)  
    if (res.data.code === 0 && res.data.data) {  
      message.success('å›¾ç‰‡ä¸Šä¼ æˆåŠŸ')  
      // å°†ä¸Šä¼ æˆåŠŸçš„å›¾ç‰‡ä¿¡æ¯ä¼ é€’ç»™çˆ¶ç»„ä»¶  
      props.onSuccess?.(res.data.data)  
    } else {  
      message.error('å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼Œ' + res.data.message)  
    }  
  } catch (error) {  
    message.error('å›¾ç‰‡ä¸Šä¼ å¤±è´¥')  
  } finally {  
    loading.value = false  
  }  
}
```

#### 2ã€å¼€å‘åˆ›å»ºé¡µé¢

ä¹‹å‰å·²ç»å¼€å‘äº†åˆ›å»ºå›¾ç‰‡é¡µé¢ï¼Œå¯ä»¥åœ¨ä¸Šä¼ å›¾ç‰‡æ—¶å¢åŠ ä¸€ä¸ª [Tabs é€‰é¡¹ç»„ä»¶](https://antdv.com/components/tabs-cn)ï¼Œè®©ç”¨æˆ·è‡ªå·±é€‰æ‹©ä¸Šä¼ æ–¹å¼ã€‚

```vue
<!-- é€‰æ‹©ä¸Šä¼ æ–¹å¼ -->  
<a-tabs v-model:activeKey="uploadType"  
  >>  
  <a-tab-pane key="file" tab="æ–‡ä»¶ä¸Šä¼ ">  
    <PictureUpload :picture="picture" :onSuccess="onSuccess" />  
  </a-tab-pane>  
  <a-tab-pane key="url" tab="URL ä¸Šä¼ " force-render>  
    <UrlPictureUpload :picture="picture" :onSuccess="onSuccess" />  
  </a-tab-pane>  
</a-tabs>
```

å®šä¹‰ä¸Šä¼ ç±»å‹å˜é‡ï¼š

```typescript
â–¼typescript

å¤åˆ¶ä»£ç const uploadType = ref<'file' | 'url'>('file')
```

å…¶ä»–ä»£ç éƒ½ä¸éœ€è¦è°ƒæ•´ã€‚ä½ ä¼šå‘ç°åªè¦å¼€å‘æ€è·¯æ¸…æ™°ã€ä»£ç ç»“æ„è‰¯å¥½ï¼Œæ–°åŠŸèƒ½çš„æ‰©å±•æ˜¯å¾ˆå¿«çš„

### æµ‹è¯•

æ²¡ä¸Šä¼ å›¾ç‰‡æ—¶ï¼Œæ•ˆæœå¦‚å›¾ï¼š

![image](./assets/43YAQGJVWeswOZQG.webp)

ä¸Šä¼ å›¾ç‰‡åï¼Œæ•ˆæœå¦‚å›¾ï¼š

![image](./assets/neyPbngNsSstry0S.webp)

é™¤äº†åˆ›å»ºå¤–ï¼Œæœ€å¥½ä¹Ÿæµ‹è¯•ä¸‹ä¿®æ”¹å›¾ç‰‡ï¼Œé˜²æ­¢ä¼˜åŒ–ä»£ç çš„è¿‡ç¨‹ä¸­å‡ºç°äº†ç–æ¼ã€‚6oQFIoMC2vFqWS6BDNDfWm34cANQaqyg4rGukImfAHk=

## æ‰¹é‡æŠ“å–å’Œåˆ›å»ºå›¾ç‰‡

### éœ€æ±‚åˆ†æ

ä¸ºäº†å¸®åŠ©ç®¡ç†å‘˜å¿«é€Ÿä¸°å¯Œå›¾ç‰‡åº“ï¼Œå†·å¯åŠ¨é¡¹ç›®ï¼Œéœ€è¦æä¾›æ‰¹é‡ä»ç½‘ç»œæŠ“å–å¹¶åˆ›å»ºå›¾ç‰‡çš„åŠŸèƒ½ã€‚

**ä½†æ˜¯è¦æ³¨æ„ï¼Œä¸å»ºè®®å°†è¯¥åŠŸèƒ½å¼€æ”¾ç»™æ™®é€šç”¨æˆ·ï¼**ä¸»è¦æ˜¯ä¸ºäº†é˜²æ­¢æ»¥ç”¨å¯¼è‡´çš„ç‰ˆæƒé—®é¢˜ã€ä½è´¨é‡å†…å®¹çš„ä¸Šä¼ ã€æœåŠ¡å™¨èµ„æºæ¶ˆè€—å’Œå®‰å…¨é—®é¢˜ã€‚å› ä¸ºæˆ‘ä»¬è¦ä»ç½‘ç»œæ‰¹é‡æŠ“å–å›¾ç‰‡ï¼ˆçˆ¬è™«ï¼‰ï¼Œå¦‚æœåŠŸèƒ½å¼€æ”¾ç»™ç”¨æˆ·ï¼Œç›¸å½“äºæ‰€æœ‰ç”¨æˆ·éƒ½åœ¨ä½¿ç”¨æˆ‘ä»¬çš„æœåŠ¡å™¨ä½œä¸ºçˆ¬è™«æºå¤´ï¼Œå®¹æ˜“å¯¼è‡´æˆ‘ä»¬çš„æœåŠ¡å™¨ IP è¢«å°ç¦ã€‚

### æ–¹æ¡ˆè®¾è®¡

æ–¹æ¡ˆè®¾è®¡çš„é‡ç‚¹åŒ…æ‹¬ï¼š

- å¦‚ä½•æŠ“å–å›¾ç‰‡
- æŠ“å–å’Œå¯¼å…¥è§„åˆ™

#### 1ã€å¦‚ä½•æŠ“å–å›¾ç‰‡ï¼Ÿ

æ€è€ƒ 2 ä¸ªé—®é¢˜ï¼šä»å“ªé‡ŒæŠ“å–å›¾ç‰‡ï¼Ÿæ€ä¹ˆæŠ“å–å›¾ç‰‡å‘¢ï¼Ÿ

ç»å¤§å¤šæ•°çš„å›¾ç‰‡ç´ æç½‘ç«™ï¼Œéƒ½æ˜¯æœ‰ç‰ˆæƒä¿æŠ¤çš„ï¼Œä¸å»ºè®®å¤§å®¶æ“ä½œï¼Œå®¹æ˜“è¢«å°ç¦ IP å’Œè´¦å·ã€‚æ¯”è¾ƒå®‰å…¨çš„æ–¹æ³•æ˜¯ä»æœç´¢å¼•æ“ä¸­æŠ“å–å›¾ç‰‡ï¼Œä»…å­¦ä¹ ä½¿ç”¨ã€ä¸å•†ç”¨çš„è¯åŸºæœ¬ä¸ä¼šæœ‰ä»€ä¹ˆé£é™©ã€‚

è¿™é‡Œæˆ‘ä»¬é€‰æ‹©ä» bing æœç´¢è·å–å›¾ç‰‡ï¼Œé¦–å…ˆè¿›å…¥ [bing å›¾ç‰‡ç½‘ç«™](https://cn.bing.com/images)ï¼Œå¯ä»¥çœ‹åˆ°å¾ˆå¤šå›¾ç‰‡ï¼Œä½†æ˜¯å¦‚ä½•è·å–è¿™äº›å›¾ç‰‡å‘¢ï¼Ÿ

![image](./assets/GcCUB2TWe8xZTPxm.webp)![img](./assets/bibULWXkn8YRera2.webp)qHT6Kxg12X1vklSWA3QVO0Z9aqth3Yj5Z1UQTagntCA=

æœ‰ 2 ç§å¸¸è§çš„åšæ³•ï¼Œç¬¬ä¸€ç§æ˜¯è¯·æ±‚åˆ°å®Œæ•´çš„é¡µé¢å†…å®¹åï¼Œå¯¹é¡µé¢çš„ HTML ç»“æ„è¿›è¡Œè§£æï¼Œæå–åˆ°å›¾ç‰‡çš„åœ°å€ï¼Œå†é€šè¿‡ URL ä¸‹è½½ï¼›è¿˜æœ‰ä¸€ç§æ˜¯ç›´æ¥è°ƒç”¨åç«¯è·å–å›¾ç‰‡åœ°å€çš„æ¥å£æ‹¿åˆ°å›¾ç‰‡æ•°æ®ã€‚

è¦ä½¿ç”¨å“ªç§æ–¹å¼ï¼Œè¿˜æ˜¯è¦å…·ä½“æƒ…å†µå…·ä½“åˆ†æï¼Œæ¯”å¦‚åœ¨è°ƒç ”è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¼šå‘ç°ç›´æ¥ä» bing å›¾ç‰‡çš„é¦–é¡µæŠ“å–æ•°æ®ï¼Œå¯èƒ½ä¼šå‡ºç°è·å–ä¸åˆ°å›¾ç‰‡çš„æƒ…å†µã€‚æ‰€ä»¥æˆ‘ä»¬æ¢ä¸€ç§ç­–ç•¥ï¼Œå°è¯•å»æ‰¾å›¾ç‰‡æ¥å£ã€‚

æŒ‰ F12 æ‰“å¼€ç½‘ç»œè¯·æ±‚æ§åˆ¶å°ï¼Œå‘ä¸‹æ»šåŠ¨å›¾ç‰‡æ—¶ä¼šè§¦å‘æ–°ä¸€æ³¢å›¾ç‰‡çš„åŠ è½½ï¼Œå°±èƒ½çœ‹åˆ°è·å–å›¾ç‰‡æ•°æ®çš„æ¥å£äº†ï¼šhttps://cn.bing.com/images/async?q=%s&mmasync=1

> æ³¨æ„ï¼ŒURL åœ°å€å¿…é¡»è¦æ·»åŠ  mmasync=1 å‚æ•°ï¼å¦åˆ™åŠ è½½æ¡æ•°ä¸å¯¹

![image](./assets/OjWxSydd2AUZFfzg.webp)![img](./assets/uiThuLEhEhDSF3jE.webp)

ä½†æ˜¯è¯¥æ¥å£è¿”å›çš„è¿˜æ˜¯ HTML æ–‡æ¡£ç»“æ„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä½¿ç”¨ä¸€ä¸ª HTML æ–‡æ¡£è§£æåº“æ¥æå–å›¾ç‰‡åœ°å€ï¼ŒJava ä¸­æ¯”è¾ƒæ¨è [jsoup](https://jsoup.org/)ï¼Œéå¸¸åœ°è½»é‡ã€‚

jsoup æ”¯æŒä½¿ç”¨è·Ÿå‰ç«¯ä¸€è‡´çš„é€‰æ‹©å™¨è¯­æ³•æ¥å®šä½ HTML çš„å…ƒç´ ï¼Œæ¯”å¦‚ç±»é€‰æ‹©å™¨ã€CSS é€‰æ‹©å™¨ã€‚æˆ‘ä»¬å¯ä»¥å…ˆé€šè¿‡ç±»é€‰æ‹©å™¨æ‰¾åˆ°æœ€å¤–å±‚çš„å…ƒç´  `dgControl`ï¼Œå†é€šè¿‡ CSS é€‰æ‹©å™¨ `img.mimg` æ‰¾åˆ°æ‰€æœ‰çš„å›¾ç‰‡å…ƒç´ ï¼š

![image](./assets/xwQsxcdEPhi6yL94.webp)![img](./assets/ssHWs3IRssTVxVGJ.webp)

æ³¨æ„ï¼Œå›¾ç‰‡çš„åœ°å€åé¢æœ‰å¾ˆå¤šé™„åŠ å‚æ•°ï¼Œæ¯”å¦‚ `?w=199&h=180`ï¼Œåœ¨å¯¼å…¥å›¾ç‰‡æ—¶ä¸€å®šè¦ç§»é™¤ï¼å¦åˆ™ä¼šå½±å“å›¾ç‰‡çš„è´¨é‡ï¼Œè¿˜æœ‰å¯èƒ½å¯¼è‡´ä¸Šä¼ åˆ°å¯¹è±¡å­˜å‚¨çš„æ–‡ä»¶åŒ…å«è¢«è½¬ä¹‰çš„ç‰¹æ®Šå­—ç¬¦ï¼Œå¼•å‘æ— æ³•è®¿é—®ç­‰é—®é¢˜ã€‚

![image](./assets/DkZq8vEvsbE8JhvF.webp)

#### 2ã€æŠ“å–å’Œå¯¼å…¥è§„åˆ™

å¯ä»¥åœ¨æŠ“å–æ—¶ï¼Œè®©ç®¡ç†å‘˜å¡«å†™ä»¥ä¸‹å‚æ•°ï¼š

- æœç´¢å…³é”®è¯ï¼šä¾¿äºæ‰¾åˆ°éœ€è¦çš„æ•°æ®
- æŠ“å–æ•°é‡ï¼šå•æ¬¡è¦æŠ“å–çš„æ¡æ•°ï¼Œä¸å»ºè®®è¶…è¿‡ 30 æ¡ï¼ˆæ¥å£å•æ¬¡è¿”å›çš„å›¾ç‰‡æœ‰é™ï¼‰

### åç«¯å¼€å‘

#### 1ã€å®šä¹‰è¯·æ±‚ä½“

åœ¨ `model.dto.picture` åŒ…ä¸‹æ–°å»º PictureUploadByBatchRequestï¼š

```java
@Data  
public class PictureUploadByBatchRequest {  
  
    /**  
     * æœç´¢è¯  
     */  
    private String searchText;  
  
    /**  
     * æŠ“å–æ•°é‡  
     */  
    private Integer count = 10;  
}
```

#### 2ã€å¼€å‘æœåŠ¡

1ï¼‰å¼•å…¥ [jsoup åº“](https://jsoup.org/)ï¼Œæ­¤å¤„é€‰ v1.15.3 ç‰ˆæœ¬ï¼Œä½¿ç”¨çš„äººè¾ƒå¤šï¼š

```xml
<!-- HTML è§£æï¼šhttps://jsoup.org/ -->  
<dependency>  
    <groupId>org.jsoup</groupId>  
    <artifactId>jsoup</artifactId>  
    <version>1.15.3</version>  
</dependency>
```

2ï¼‰ç¼–å†™æ‰¹é‡æŠ“å–å’Œåˆ›å»ºå›¾ç‰‡æ–¹æ³•

æ¥å£ï¼š

```java
/**  
 * æ‰¹é‡æŠ“å–å’Œåˆ›å»ºå›¾ç‰‡  
 *  
 * @param pictureUploadByBatchRequest  
 * @param loginUser  
 * @return æˆåŠŸåˆ›å»ºçš„å›¾ç‰‡æ•°  
 */  
Integer uploadPictureByBatch(  
    PictureUploadByBatchRequest pictureUploadByBatchRequest,  
    User loginUser  
);
```

å®ç°ç±»ï¼š

```java
@Override  
public int uploadPictureByBatch(PictureUploadByBatchRequest pictureUploadByBatchRequest, User loginUser) {  
    String searchText = pictureUploadByBatchRequest.getSearchText();  
    // æ ¼å¼åŒ–æ•°é‡  
    Integer count = pictureUploadByBatchRequest.getCount();  
    ThrowUtils.throwIf(count > 30, ErrorCode.PARAMS_ERROR, "æœ€å¤š 30 æ¡");  
    // è¦æŠ“å–çš„åœ°å€  
    String fetchUrl = String.format("https://cn.bing.com/images/async?q=%s&mmasync=1", searchText);  
    Document document;  
    try {  
        document = Jsoup.connect(fetchUrl).get();  
    } catch (IOException e) {  
        log.error("è·å–é¡µé¢å¤±è´¥", e);  
        throw new BusinessException(ErrorCode.OPERATION_ERROR, "è·å–é¡µé¢å¤±è´¥");  
    }  
    Element div = document.getElementsByClass("dgControl").first();  
    if (ObjUtil.isNull(div)) {  
        throw new BusinessException(ErrorCode.OPERATION_ERROR, "è·å–å…ƒç´ å¤±è´¥");  
    }  
    Elements imgElementList = div.select("img.mimg");  
    int uploadCount = 0;  
    for (Element imgElement : imgElementList) {  
        String fileUrl = imgElement.attr("src");  
        if (StrUtil.isBlank(fileUrl)) {  
            log.info("å½“å‰é“¾æ¥ä¸ºç©ºï¼Œå·²è·³è¿‡: {}", fileUrl);  
            continue;  
        }  
        // å¤„ç†å›¾ç‰‡ä¸Šä¼ åœ°å€ï¼Œé˜²æ­¢å‡ºç°è½¬ä¹‰é—®é¢˜  
        int questionMarkIndex = fileUrl.indexOf("?");  
        if (questionMarkIndex > -1) {  
            fileUrl = fileUrl.substring(0, questionMarkIndex);  
        }  
        // ä¸Šä¼ å›¾ç‰‡  
        PictureUploadRequest pictureUploadRequest = new PictureUploadRequest();  
        try {  
            PictureVO pictureVO = this.uploadPicture(fileUrl, pictureUploadRequest, loginUser);  
            log.info("å›¾ç‰‡ä¸Šä¼ æˆåŠŸ, id = {}", pictureVO.getId());  
            uploadCount++;  
        } catch (Exception e) {  
            log.error("å›¾ç‰‡ä¸Šä¼ å¤±è´¥", e);  
            continue;  
        }  
        if (uploadCount >= count) {  
            break;  
        }  
    }  
    return uploadCount;  
}
```

ä¸Šè¿°ä»£ç ä¸­ï¼Œæˆ‘ä»¬æ·»åŠ äº†å¾ˆå¤šæ—¥å¿—è®°å½•å’Œå¼‚å¸¸å¤„ç†é€»è¾‘ï¼Œä½¿å¾—å•å¼ å›¾ç‰‡æŠ“å–æˆ–å¯¼å…¥å¤±è´¥æ—¶ä»»åŠ¡è¿˜èƒ½å¤Ÿç»§ç»­æ‰§è¡Œï¼Œæœ€ç»ˆè¿”å›åˆ›å»ºæˆåŠŸçš„å›¾ç‰‡æ•°ã€‚

ğŸ’¡ å¦‚æœæŠ“å–çš„å†…å®¹æ•°é‡è¾ƒå¤šï¼Œå¯ä»¥é€‚å½“åœ° Thread.sleep é˜»å¡ç­‰å¾…ä¸€æ®µæ—¶é—´ï¼Œå‡å°‘æœåŠ¡å™¨è¢«å°ç¦çš„æ¦‚ç‡ã€‚

#### 3ã€å¼€å‘æ¥å£

åœ¨ Controller ä¸­æ–°å¢æ¥å£ï¼Œæ³¨æ„é™åˆ¶ä»…ç®¡ç†å‘˜å¯ç”¨ï¼š

```java
@PostMapping("/upload/batch")  
@AuthCheck(mustRole = UserConstant.ADMIN_ROLE)  
public BaseResponse<Integer> uploadPictureByBatch(  
        @RequestBody PictureUploadByBatchRequest pictureUploadByBatchRequest,  
        HttpServletRequest request  
) {  
    ThrowUtils.throwIf(pictureUploadByBatchRequest == null, ErrorCode.PARAMS_ERROR);  
    User loginUser = userService.getLoginUser(request);  
    int uploadCount = pictureService.uploadPictureByBatch(pictureUploadByBatchRequest, loginUser);  
    return ResultUtils.success(uploadCount);  
}
```

#### 4ã€æ‰©å±•åŠŸèƒ½ - æ‰¹é‡è®¾ç½®å±æ€§

ä¹‹å‰æˆ‘ä»¬å¯¼å…¥ç³»ç»Ÿçš„å›¾ç‰‡åç§°éƒ½æ˜¯ç”±å¯¹æ–¹çš„ URL å†³å®šçš„ï¼Œåç§°å¯èƒ½ä¹±ä¸ƒå…«ç³Ÿï¼Œè€Œä¸”ä¸åˆ©äºæˆ‘ä»¬å¾—çŸ¥æ•°æ®æ˜¯åœ¨é‚£ä¸€æ‰¹è¢«å¯¼å…¥çš„ã€‚

å› æ­¤æˆ‘ä»¬å¯ä»¥è®©ç®¡ç†å‘˜åœ¨æ‰§è¡Œä»»åŠ¡å‰æŒ‡å®š `åç§°å‰ç¼€`ï¼Œå³å¯¼å…¥åˆ°ç³»ç»Ÿä¸­çš„å›¾ç‰‡åç§°ã€‚æ¯”å¦‚å‰ç¼€ä¸º â€œé±¼çš®â€ï¼Œå¾—åˆ°çš„å›¾ç‰‡åç§°å°±æ˜¯ â€œé±¼çš®1â€ã€â€œé±¼çš®2â€ã€‚ã€‚ã€‚

ç›¸å½“äºæ”¯æŒæŠ“å–å’Œåˆ›å»ºå›¾ç‰‡æ—¶æ‰¹é‡å¯¹æŸæ‰¹å›¾ç‰‡å‘½åï¼Œåç§°å‰ç¼€é»˜è®¤ç­‰äºæœç´¢å…³é”®è¯ã€‚

ä¸‹é¢æ¥å¼€å‘å®ç°ï¼š

1ï¼‰ç»™ PictureUploadByBatchRequest è¯·æ±‚åŒ…è£…ç±»è¡¥å…… namePrefix å‚æ•°ï¼š

```java
/**  
 * åç§°å‰ç¼€  
 */  
private String namePrefix;
```

2ï¼‰ç”±äºå›¾ç‰‡åç§°æ˜¯åœ¨ uploadPicture æ–¹æ³•ä¸­ä¼ å…¥å¹¶è®¾ç½®ç»™ Picture å›¾ç‰‡å¯¹è±¡çš„ï¼Œæ‰€ä»¥éœ€è¦ç»™è¯¥æ–¹æ³•æ¥å—çš„å‚æ•° PictureUploadRequest ç±»ä¸­è¡¥å…… picName å‚æ•°ï¼š

```java
/**  
 * å›¾ç‰‡åç§°  
 */  
private String picName;
```

3ï¼‰ä¿®æ”¹ uploadPicture æœåŠ¡æ–¹æ³•ï¼Œåœ¨æ„é€ å…¥åº“å›¾ç‰‡ä¿¡æ¯æ—¶ï¼Œå¯ä»¥é€šè¿‡ pictureUploadRequest å¯¹è±¡è·å–åˆ°è¦æ‰‹åŠ¨è®¾ç½®çš„å›¾ç‰‡åç§°ï¼Œè€Œä¸æ˜¯å®Œå…¨ä¾èµ–äºè§£æçš„ç»“æœï¼š

```java
// æ„é€ è¦å…¥åº“çš„å›¾ç‰‡ä¿¡æ¯  
Picture picture = new Picture();  
picture.setUrl(uploadPictureResult.getUrl());  
String picName = uploadPictureResult.getPicName();  
if (pictureUploadRequest != null && StrUtil.isNotBlank(pictureUploadRequest.getPicName())) {  
    picName = pictureUploadRequest.getPicName();  
}  
picture.setName(picName);
```

4ï¼‰ä¿®æ”¹æ‰¹é‡æŠ“å–å’Œå¯¼å…¥å›¾ç‰‡çš„æœåŠ¡æ–¹æ³• uploadPictureByBatchï¼Œè¡¥å……å›¾ç‰‡åç§°ç”Ÿæˆé€»è¾‘ï¼š6oQFIoMC2vFqWS6BDNDfWm34cANQaqyg4rGukImfAHk=

```java
String namePrefix = pictureUploadByBatchRequest.getNamePrefix();  
if (StrUtil.isBlank(namePrefix)) {  
    namePrefix = searchText;  
}  
// ...  
// ä¸Šä¼ å›¾ç‰‡  
PictureUploadRequest pictureUploadRequest = new PictureUploadRequest();  
if (StrUtil.isNotBlank(namePrefix)) {  
    // è®¾ç½®å›¾ç‰‡åç§°ï¼Œåºå·è¿ç»­é€’å¢  
    pictureUploadRequest.setPicName(namePrefix + (uploadCount + 1));  
}
```

#### 5ã€æ¥å£æµ‹è¯•

å¯ä»¥é€šè¿‡ Swagger æµ‹è¯•æ‰¹é‡æŠ“å–å’Œåˆ›å»ºå›¾ç‰‡åŠŸèƒ½ï¼Œæ•ˆæœå¦‚å›¾ï¼š

![image](./assets/hagXj9xb8uPXppUw.webp)![img](./assets/ZS7iN6PBheEoFW1M.webp)

### å‰ç«¯å¼€å‘

å¯ä»¥æ–°å»ºä¸€ä¸ªæ‰¹é‡åˆ›å»ºå›¾ç‰‡é¡µé¢ï¼Œå¹¶ä¸”åœ¨å›¾ç‰‡ç®¡ç†é¡µé¢è¡¥å……è·³è½¬åˆ°è¯¥é¡µé¢çš„æŒ‰é’®ã€‚

#### 1ã€å›¾ç‰‡ç®¡ç†é¡µé¢è¡¥å……æŒ‰é’®

ç®¡ç†é¡µé¢è¡¥å…… â€œæ‰¹é‡åˆ›å»ºå›¾ç‰‡â€ æŒ‰é’®ï¼Œä»£ç å¦‚ä¸‹ï¼š

```vue
<a-space>  
  <a-button type="primary" href="/add_picture" target="_blank">+ åˆ›å»ºå›¾ç‰‡</a-button>  
  <a-button type="primary" href="/add_picture/batch" target="_blank" ghost>+ æ‰¹é‡åˆ›å»ºå›¾ç‰‡</a-button>  
</a-space>
```

æ•ˆæœå¦‚å›¾ï¼š

![image](./assets/1l3hlZR4xUxHhnBM.webp)![img](./assets/QyLXKRrhEznKr6aE.webp)

#### 2ã€æ‰¹é‡åˆ›å»ºå›¾ç‰‡é¡µé¢

1ï¼‰æ–°å»ºé¡µé¢æ–‡ä»¶ `AddPictureBatchPage.vue`ï¼ˆå¤åˆ¶åˆ›å»ºå›¾ç‰‡é¡µé¢ï¼‰ï¼Œå¹¶æ·»åŠ è·¯ç”±ï¼š

```typescript
{  
  path: '/add_picture/batch',  
  name: 'æ‰¹é‡åˆ›å»ºå›¾ç‰‡',  
  component: AddPictureBatchPage,  
}
```

æ­£å¸¸æƒ…å†µä¸‹ï¼Œæ™®é€šç”¨æˆ·æ˜¯çœ‹ä¸è§è¯¥é¡µé¢çš„ï¼Œå³ä½¿çœ‹è§äº†ï¼Œä¹Ÿä¼šå› ä¸ºåç«¯çš„é™åˆ¶æ— æ³•ä½¿ç”¨ã€‚

2ï¼‰è¯¥é¡µé¢ä¸»ä½“æ˜¯ä¸€ä¸ªè¡¨å•ï¼Œå’Œåˆ›å»ºå›¾ç‰‡é¡µé¢æä¸ºç›¸ä¼¼ï¼Œå…ˆä¿®æ”¹è¡¨å•é¡¹ï¼š

```vue
<div id="addPictureBatchPage">  
  <h2 style="margin-bottom: 16px">æ‰¹é‡åˆ›å»ºå›¾ç‰‡</h2>  
  <a-form layout="vertical" :model="formData" @finish="handleSubmit">  
    <a-form-item label="å…³é”®è¯" name="searchText">  
      <a-input v-model:value="formData.searchText" placeholder="è¯·è¾“å…¥å…³é”®è¯" />  
    </a-form-item>  
    <a-form-item label="æŠ“å–æ•°é‡" name="count">  
      <a-input-number  
        v-model:value="formData.count"  
        placeholder="è¯·è¾“å…¥æ•°é‡"  
        style="min-width: 180px"  
        :min="1"  
        :max="30"  
        allow-clear  
      />  
    </a-form-item>  
    <a-form-item label="åç§°å‰ç¼€" name="namePrefix">  
      <a-input v-model:value="formData.namePrefix" placeholder="è¯·è¾“å…¥åç§°å‰ç¼€ï¼Œä¼šè‡ªåŠ¨è¡¥å……åºå·" />  
    </a-form-item>  
    <a-form-item>  
      <a-button type="primary" html-type="submit" style="width: 100%" :loading="loading">  
        æ‰§è¡Œä»»åŠ¡  
      </a-button>  
    </a-form-item>  
  </a-form>  
</div>
```

æ³¨æ„ï¼Œç”±äºæ‰¹é‡æŠ“å–ä»»åŠ¡æ˜¯åŒæ­¥çš„ï¼Œå¯èƒ½æ¯”è¾ƒæ…¢ï¼Œæ‰€ä»¥éœ€è¦æ·»åŠ  loading æ•ˆæœï¼Œé˜²æ­¢ç‚¹å‡»è¿‡å¿«é‡å¤æ‰§è¡Œã€‚

å®šä¹‰è¡¨å•é¡¹ç»“æ„å’Œ loading å˜é‡ï¼š

```typescript
const formData = reactive<API.PictureUploadByBatchRequest>({  
  count: 10,  
})  
const loading = ref(false)
```

3ï¼‰ç¼–å†™æäº¤å‡½æ•°ï¼ŒæŠ“å–æˆåŠŸåä¼šè¾“å‡ºä¿¡æ¯å¹¶è·³è½¬åˆ°ä¸»é¡µï¼š

```typescript
const handleSubmit = async (values: any) => {  
  loading.value = true;  
  const res = await uploadPictureByBatchUsingPost({  
    ...formData,  
  })  
  if (res.data.code === 0 && res.data.data) {  
    message.success(`åˆ›å»ºæˆåŠŸï¼Œå…± ${res.data.data} æ¡`)  
    router.push({  
      path: '/',  
    })  
  } else {  
    message.error('åˆ›å»ºå¤±è´¥ï¼Œ' + res.data.message)  
  }  
  loading.value = false;  
}
```

### æµ‹è¯•

æ‰¹é‡åˆ›å»ºé¡µé¢æ•ˆæœå¦‚å›¾ï¼š

![image](./assets/tOSFJVF05eRTRrGG.webp)

å¯ä»¥éšæ„è¾“å…¥å…³é”®è¯è¿›è¡Œæµ‹è¯•ï¼Œè¿™ä¸‹çˆ½äº†ï¼Œæ— è®ºä½ æƒ³åšè¡¨æƒ…åŒ…ç½‘ç«™ã€è®¾è®¡ç´ æç½‘ç«™ã€æµ·æŠ¥ç½‘ç«™ã€Logo ç½‘ç«™ã€è¿˜æ˜¯å£çº¸ç½‘ç«™ï¼Œå…¨éƒ½å¯ä»¥è½»æ¾å®Œæˆï¼

![image](./assets/V0cfpwlqBqtSxMai.webp)![img](./assets/JcoR8S6uMPkjroeU.webp)

**å‹æƒ…æç¤ºï¼Œè™½ç„¶æœ¬é¡¹ç›®åœ¨åŠŸèƒ½ä¸Šçš„ç›®æ ‡æ˜¯å•†ä¸šçº§å¹³å°ï¼Œä½†ä¸€å®šè¦æ³¨æ„ç‰ˆæƒé—®é¢˜ï¼Œä¸èƒ½éšæ„æ‹¿åˆ«äººçš„ç´ ææ¥å•†ç”¨ã€‚**

### æ‰©å±•

1ï¼‰æ”¯æŒç®¡ç†å‘˜å¡«å†™æ¯æ‰¹æŠ“å–å›¾ç‰‡çš„åç§»é‡ï¼Œé˜²æ­¢é‡å¤æŠ“å–ã€‚

2ï¼‰ç³»ç»Ÿå†…éƒ¨è®°å½•åŸå§‹å›¾ç‰‡ URLï¼Œä¾¿äºå†…éƒ¨å¤ç›˜å½’æ¡£ï¼Œä½†æ˜¯æ³¨æ„ä¸éœ€è¦æš´éœ²ç»™ç”¨æˆ·ã€‚

3ï¼‰å’Œæ‰¹é‡è®¾ç½®åç§°ä¸€æ ·ï¼Œæ”¯æŒæ‰¹é‡è®¾ç½®æŠ“å–åˆ°çš„å›¾ç‰‡çš„åˆ†ç±»å’Œæ ‡ç­¾ç­‰ã€‚

4ï¼‰æˆ‘ä»¬ç›®å‰æŠ“å–åˆ°çš„å›¾ç‰‡æ¸…æ™°åº¦æœ‰é™ï¼Œå¯ä»¥å°è¯•èƒ½å¦è·å–åˆ°è´¨é‡æ›´é«˜çš„å›¾ç‰‡ã€‚

## æœ€å

è®²åˆ°è¿™é‡Œï¼Œå¥½åƒæˆ‘ä»¬çš„å…¬å¼€å›¾åº“å¹³å°åŠŸèƒ½å·²ç»æ¯”è¾ƒå®Œå–„äº†ï¼Œç°åœ¨å°±å¯ä»¥ä¸Šçº¿ç»™åˆ«äººç”¨äº†å˜›ï¼

å¦‚æœä½ ä¹Ÿæ˜¯è¿™ä¸ªæƒ³æ³•ï¼Œé‚£çœŸçš„æ˜¯ã€‚ã€‚ã€‚

**å¤ªæƒ¨å•¦ï¼**

ç°åœ¨ä¸Šçº¿ï¼Œå¾—äºæ­»å•Šï¼åœ¨ä¸‹ä¸€èŠ‚æ•™ç¨‹ä¸­ï¼Œé±¼çš®ä¼šå¸¦å¤§å®¶åšä¸€äº›é‡è¦çš„ä¼˜åŒ–ç‚¹ï¼ŒåŠ æ²¹å­¦ä¹ å§ï¼





# 6 - å›¾ç‰‡ä¼˜åŒ–

## æœ¬èŠ‚é‡ç‚¹

ä¹‹å‰è™½ç„¶æˆ‘ä»¬å·²ç»å®Œæˆäº†äº‘å›¾åº“é¡¹ç›®çš„åŠŸèƒ½å¼€å‘ï¼Œä½†åœ¨ä¸Šçº¿ä¹‹å‰ï¼Œè¿˜æœ‰å¾ˆå¤§çš„ä¼˜åŒ–ç©ºé—´ã€‚

æœ¬èŠ‚æ•™ç¨‹ä¸­ï¼Œé±¼çš®ä¼šåˆ†äº«è¿‘ 10 ç§ä¸»æµçš„å›¾ç‰‡ä¼˜åŒ–æŠ€æœ¯ï¼ŒåŒ…æ‹¬ï¼š

- å›¾ç‰‡æŸ¥è¯¢ä¼˜åŒ– - åˆ†å¸ƒå¼ç¼“å­˜ã€æœ¬åœ°ç¼“å­˜ã€å¤šçº§ç¼“å­˜
- å›¾ç‰‡ä¸Šä¼ ä¼˜åŒ– - å‹ç¼©ã€ç§’ä¼ ã€åˆ†ç‰‡ä¸Šä¼ ã€æ–­ç‚¹ç»­ä¼ 
- å›¾ç‰‡åŠ è½½ä¼˜åŒ– - æ‡’åŠ è½½ã€ç¼©ç•¥å›¾ã€CDN åŠ é€Ÿã€æµè§ˆå™¨ç¼“å­˜
- å›¾ç‰‡å­˜å‚¨ä¼˜åŒ– - é™é¢‘å­˜å‚¨ï¼ˆå†·çƒ­æ•°æ®åˆ†ç¦»ï¼‰ã€æ¸…ç†ç­–ç•¥

ğŸ’¡ é±¼çš®çš„ [ä»£ç ç”Ÿæˆå™¨å…±äº«å¹³å°é¡¹ç›®](https://www.codefather.cn/course/1790980795074654209) ä¸­ï¼Œä¹Ÿè¯¦ç»†è®²è§£è¿‡å­˜å‚¨ä¼˜åŒ–ç­–ç•¥ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥å»å­¦ä¹ ä¸‹ã€‚

## ä¸€ã€å›¾ç‰‡æŸ¥è¯¢ä¼˜åŒ–

### ç¼“å­˜

å¯¹äºç»å¸¸è®¿é—®çš„æ•°æ®ï¼Œæ¯æ¬¡éƒ½ä»æ•°æ®åº“ï¼ˆç¡¬ç›˜ï¼‰ä¸­è·å–æ˜¯æ¯”è¾ƒæ…¢ï¼Œå¯ä»¥åˆ©ç”¨æ€§èƒ½æ›´é«˜çš„å­˜å‚¨æ¥æé«˜ç³»ç»Ÿå“åº”é€Ÿåº¦ï¼Œä¿—ç§°ç¼“å­˜ã€‚

åˆç†ä½¿ç”¨ç¼“å­˜å¯ä»¥æ˜¾è‘—é™ä½æ•°æ®åº“çš„å‹åŠ›ã€æé«˜ç³»ç»Ÿæ€§èƒ½ã€‚

é‚£ä¹ˆï¼Œä»€ä¹ˆæ ·çš„æ•°æ®é€‚åˆç¼“å­˜å‘¢ï¼Ÿä¸€èˆ¬æƒ…å†µä¸‹å°± 4 ä¸ªå­— **â€œè¯»å¤šå†™å°‘â€**ï¼Œè¦é¢‘ç¹æŸ¥è¯¢çš„ã€ä¸æ€ä¹ˆä¿®æ”¹çš„ã€‚

å…·ä½“æ¥è¯´ï¼š

1. é«˜é¢‘è®¿é—®çš„æ•°æ®ï¼šå¦‚ç³»ç»Ÿé¦–é¡µã€çƒ­é—¨æ¨èå†…å®¹ç­‰ã€‚
2. è®¡ç®—æˆæœ¬è¾ƒé«˜çš„æ•°æ®ï¼šå¦‚å¤æ‚æŸ¥è¯¢ç»“æœã€å¤§é‡æ•°æ®çš„ç»Ÿè®¡ç»“æœã€‚
3. å…è®¸çŸ­æ—¶é—´å»¶è¿Ÿçš„æ•°æ®ï¼šå¦‚ä¸éœ€è¦å®æ—¶æ›´æ–°çš„æ’è¡Œæ¦œã€å›¾ç‰‡åˆ—è¡¨ç­‰ã€‚

åœ¨æˆ‘ä»¬çš„é¡¹ç›®ä¸­ï¼Œä¸»é¡µæ˜¯ç”¨æˆ·é«˜é¢‘è®¿é—®çš„å†…å®¹ï¼Œè°ƒç”¨çš„è·å–å›¾ç‰‡åˆ—è¡¨çš„æ¥å£ä¹Ÿæ˜¯é«˜é¢‘è®¿é—®çš„ã€‚è€Œä¸”å³ä½¿æ•°æ®æ›´æ–°å­˜åœ¨ä¸€å®šå»¶è¿Ÿï¼Œä¹Ÿä¸ä¼šå¯¹ç”¨æˆ·ä½“éªŒé€ æˆæ˜æ˜¾å½±å“ï¼Œå› æ­¤éå¸¸é€‚åˆç¼“å­˜ã€‚

### Redis åˆ†å¸ƒå¼ç¼“å­˜

åˆ†å¸ƒå¼ç¼“å­˜æ˜¯æŒ‡å°†ç¼“å­˜æ•°æ®åˆ†å¸ƒå­˜å‚¨åœ¨ **å¤šå°æœåŠ¡å™¨** ä¸Šï¼Œä»¥ä¾¿åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹æä¾›æ›´é«˜çš„ååé‡å’Œæ›´å¥½çš„å®¹é”™æ€§ã€‚

Redis æ˜¯å®ç°åˆ†å¸ƒå¼ç¼“å­˜çš„ä¸»æµæ–¹æ¡ˆï¼Œä¹Ÿæ˜¯åç«¯å¼€å‘å¿…å­¦çš„æŠ€èƒ½ã€‚ä¸»è¦æ˜¯ç”±äºå®ƒå…·æœ‰ä¸‹é¢å‡ ä¸ªä¼˜åŠ¿ï¼š

- é«˜æ€§èƒ½ï¼šåŸºäºå†…å­˜æ“ä½œï¼Œè®¿é—®é€Ÿåº¦æå¿«ã€‚**å•èŠ‚ç‚¹ Redis çš„è¯»å†™ QPS å¯è¾¾ 10w æ¬¡æ¯ç§’ï¼**
- ä¸°å¯Œçš„æ•°æ®ç»“æ„ï¼šæ”¯æŒå­—ç¬¦ä¸²ã€åˆ—è¡¨ã€é›†åˆã€å“ˆå¸Œã€ä½å›¾ç­‰ï¼Œé€‚ç”¨äºå„ç§æ•°æ®ç»“æ„å­˜å‚¨ã€‚
- åˆ†å¸ƒå¼æ”¯æŒï¼šå¯ä»¥é€šè¿‡ Redis Cluster æ„å»ºé«˜å¯ç”¨ã€é«˜æ€§èƒ½çš„åˆ†å¸ƒå¼ç¼“å­˜ï¼Œè¿˜æä¾›å“¨å…µé›†ç¾¤æœºåˆ¶æå‡å¯ç”¨æ€§ã€æä¾›åˆ†ç‰‡é›†ç¾¤æœºåˆ¶æé«˜å¯æ‰©å±•æ€§ã€‚

#### ç¼“å­˜è®¾è®¡

éœ€è¦ç¼“å­˜é¦–é¡µçš„å›¾ç‰‡åˆ—è¡¨æ•°æ®ï¼Œä¹Ÿå°±æ˜¯å¯¹ listPictureVOByPage æ¥å£è¿›è¡Œç¼“å­˜ã€‚é¦–å…ˆæŒ‰ç…§ç¼“å­˜ 3 è¦ç´  â€œkeyã€valueã€è¿‡æœŸæ—¶é—´â€ è¿›è¡Œè®¾è®¡ã€‚

1ï¼‰ç¼“å­˜ key è®¾è®¡

ç”±äºæ¥å£æ”¯æŒä¼ å…¥ä¸åŒçš„æŸ¥è¯¢æ¡ä»¶ï¼Œå¯¹åº”çš„æ•°æ®ä¸åŒï¼Œå› æ­¤éœ€è¦å°†æŸ¥è¯¢æ¡ä»¶ä½œä¸ºç¼“å­˜ key çš„ä¸€éƒ¨åˆ†ã€‚

å¯ä»¥å°†æŸ¥è¯¢æ¡ä»¶å¯¹è±¡è½¬æ¢ä¸º JSON å­—ç¬¦ä¸²ï¼Œä½†è¿™ä¸ª JSON ä¼šæ¯”è¾ƒé•¿ï¼Œå¯ä»¥åˆ©ç”¨å“ˆå¸Œç®—æ³•ï¼ˆmd5ï¼‰æ¥å‹ç¼© keyã€‚

æ­¤å¤–ï¼Œç”±äºä½¿ç”¨åˆ†å¸ƒå¼ç¼“å­˜ï¼Œå¯èƒ½ç”±å¤šä¸ªé¡¹ç›®å’Œä¸šåŠ¡å…±äº«ï¼Œå› æ­¤éœ€è¦åœ¨ key çš„å¼€å¤´æ‹¼æ¥å‰ç¼€è¿›è¡Œéš”ç¦»ã€‚è®¾è®¡å‡ºçš„ key å¦‚ä¸‹ï¼š

```plain
yupicture:listPictureVOByPage:${æŸ¥è¯¢æ¡ä»¶key}
```

2ï¼‰ç¼“å­˜ value è®¾è®¡

ç¼“å­˜ä»æ•°æ®åº“ä¸­æŸ¥åˆ°çš„ Page åˆ†é¡µå¯¹è±¡ï¼Œå­˜å‚¨ä¸ºä»€ä¹ˆæ ¼å¼å‘¢ï¼Ÿè¿™é‡Œæœ‰ 2 ç§é€‰æ‹©ï¼š

- ä¸ºäº†å¯è¯»æ€§ï¼Œå¯ä»¥è½¬æ¢ä¸º JSON ç»“æ„çš„å­—ç¬¦ä¸²
- ä¸ºäº†å‹ç¼©ç©ºé—´ï¼Œå¯ä»¥å­˜ä¸ºäºŒè¿›åˆ¶ç­‰å…¶ä»–ç»“æ„

ä½†æ˜¯å¯¹åº”çš„ Redis æ•°æ®ç»“æ„éƒ½æ˜¯ stringã€‚

3ï¼‰ç¼“å­˜è¿‡æœŸæ—¶é—´è®¾ç½®

**å¿…é¡»è®¾ç½®ç¼“å­˜è¿‡æœŸæ—¶é—´ï¼**æ ¹æ®å®é™…ä¸šåŠ¡åœºæ™¯å’Œç¼“å­˜ç©ºé—´çš„å¤§å°ã€æ•°æ®çš„ä¸€è‡´æ€§çš„è¦æ±‚è®¾ç½®ï¼Œåˆé€‚å³å¯ï¼Œæ­¤å¤„ç”±äºæŸ¥è¯¢æ¡ä»¶è¾ƒå¤šã€è€Œä¸”è€ƒè™‘åˆ°å›¾ç‰‡ä¼šæŒç»­æ›´æ–°ï¼Œè®¾ç½®ä¸º 5 ~ 60 åˆ†é’Ÿå³å¯ã€‚

#### å¦‚ä½•æ“ä½œ Redisï¼Ÿ

Java ä¸­æœ‰éå¸¸å¤šçš„ Redis æ“ä½œåº“ï¼Œæ¯”å¦‚ Jedisã€Lettuce ç­‰ã€‚ä¸ºäº†ä¾¿äºå’Œ Spring é¡¹ç›®é›†æˆï¼ŒSpring è¿˜æä¾›äº† Spring Data Redis ä½œä¸ºæ“ä½œ Redis çš„æ›´é«˜å±‚æŠ½è±¡ï¼ˆé»˜è®¤ä½¿ç”¨ Lettuce ä½œä¸ºåº•å±‚å®¢æˆ·ç«¯ï¼‰ã€‚ç”±äºæˆ‘ä»¬çš„é¡¹ç›®ä½¿ç”¨ Spring Bootï¼Œä¹Ÿæ¨èä½¿ç”¨ [Spring Data Redis](https://spring.io/projects/spring-data-redis/)ï¼Œå¼€å‘æˆæœ¬æ›´ä½ã€‚

å®ƒçš„ä½¿ç”¨ä¹Ÿéå¸¸ç®€å•ï¼Œæˆ‘ä»¬ç›´æ¥ä¸Šæ‰‹é¡¹ç›®å®æˆ˜ã€‚

#### åç«¯å¼€å‘

1ï¼‰å¼•å…¥ Maven ä¾èµ–ï¼Œä½¿ç”¨ Spring Boot Starter å¿«é€Ÿæ•´åˆ Redisï¼š

```xml
<!-- Redis -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-redis</artifactId>
</dependency>
```

2ï¼‰åœ¨ application.yml ä¸­æ·»åŠ  Redis é…ç½®ï¼š

```yaml
spring:
  # Redis é…ç½®
  redis:
    database: 0
    host: 127.0.0.1
    port: 6379
    timeout: 5000
```

3ï¼‰ç¼–å†™ JUnit å•å…ƒæµ‹è¯•æ–‡ä»¶ï¼Œæµ‹è¯•ä½¿ç”¨ `StringRedisTemplate` å®Œæˆå¯¹ Redis çš„åŸºç¡€æ“ä½œï¼ˆå¢åˆ æ”¹æŸ¥ï¼‰ï¼š

```java
@SpringBootTest
public class RedisStringTest {

    @Autowired
    private StringRedisTemplate stringRedisTemplate;

    @Test
    public void testRedisStringOperations() {
        // è·å–æ“ä½œå¯¹è±¡
        ValueOperations<String, String> valueOps = stringRedisTemplate.opsForValue();

        // Key å’Œ Value
        String key = "testKey";
        String value = "testValue";

        // 1. æµ‹è¯•æ–°å¢æˆ–æ›´æ–°æ“ä½œ
        valueOps.set(key, value);
        String storedValue = valueOps.get(key);
        assertEquals(value, storedValue, "å­˜å‚¨çš„å€¼ä¸é¢„æœŸä¸ä¸€è‡´");

        // 2. æµ‹è¯•ä¿®æ”¹æ“ä½œ
        String updatedValue = "updatedValue";
        valueOps.set(key, updatedValue);
        storedValue = valueOps.get(key);
        assertEquals(updatedValue, storedValue, "æ›´æ–°åçš„å€¼ä¸é¢„æœŸä¸ä¸€è‡´");

        // 3. æµ‹è¯•æŸ¥è¯¢æ“ä½œ
        storedValue = valueOps.get(key);
        assertNotNull(storedValue, "æŸ¥è¯¢çš„å€¼ä¸ºç©º");
        assertEquals(updatedValue, storedValue, "æŸ¥è¯¢çš„å€¼ä¸é¢„æœŸä¸ä¸€è‡´");

        // 4. æµ‹è¯•åˆ é™¤æ“ä½œ
        stringRedisTemplate.delete(key);
        storedValue = valueOps.get(key);
        assertNull(storedValue, "åˆ é™¤åçš„å€¼ä¸ä¸ºç©º");
    }
}
```

4ï¼‰æ–°å†™ä¸€ä¸ªä½¿ç”¨ç¼“å­˜çš„åˆ†é¡µæŸ¥è¯¢å›¾ç‰‡åˆ—è¡¨çš„æ¥å£ã€‚åœ¨æŸ¥è¯¢æ•°æ®åº“å‰å…ˆæŸ¥è¯¢ç¼“å­˜ï¼Œå¦‚æœå·²æœ‰æ•°æ®åˆ™ç›´æ¥è¿”å›ç¼“å­˜ï¼Œå¦‚æœæ²¡æœ‰æ•°æ®åˆ™æŸ¥è¯¢æ•°æ®åº“ï¼Œå¹¶ä¸”å°†ç»“æœè®¾ç½®åˆ°ç¼“å­˜ä¸­ã€‚

ä»£ç å¦‚ä¸‹ï¼š

```java
@PostMapping("/list/page/vo/cache")
public BaseResponse<Page<PictureVO>> listPictureVOByPageWithCache(@RequestBody PictureQueryRequest pictureQueryRequest,
                                                         HttpServletRequest request) {
    long current = pictureQueryRequest.getCurrent();
    long size = pictureQueryRequest.getPageSize();
    // é™åˆ¶çˆ¬è™«
    ThrowUtils.throwIf(size > 20, ErrorCode.PARAMS_ERROR);
    // æ™®é€šç”¨æˆ·é»˜è®¤åªèƒ½æŸ¥çœ‹å·²è¿‡å®¡çš„æ•°æ®
    pictureQueryRequest.setReviewStatus(PictureReviewStatusEnum.PASS.getValue());

    // æ„å»ºç¼“å­˜ key
    String queryCondition = JSONUtil.toJsonStr(pictureQueryRequest);
    String hashKey = DigestUtils.md5DigestAsHex(queryCondition.getBytes());
    String redisKey = "yupicture:listPictureVOByPage:" + hashKey;
    // ä» Redis ç¼“å­˜ä¸­æŸ¥è¯¢
    ValueOperations<String, String> valueOps = stringRedisTemplate.opsForValue();
    String cachedValue = valueOps.get(redisKey);
    if (cachedValue != null) {
        // å¦‚æœç¼“å­˜å‘½ä¸­ï¼Œè¿”å›ç»“æœ
        Page<PictureVO> cachedPage = JSONUtil.toBean(cachedValue, Page.class);
        return ResultUtils.success(cachedPage);
    }

    // æŸ¥è¯¢æ•°æ®åº“
    Page<Picture> picturePage = pictureService.page(new Page<>(current, size),
            pictureService.getQueryWrapper(pictureQueryRequest));
    // è·å–å°è£…ç±»
    Page<PictureVO> pictureVOPage = pictureService.getPictureVOPage(picturePage, request);

    // å­˜å…¥ Redis ç¼“å­˜
    String cacheValue = JSONUtil.toJsonStr(pictureVOPage);
    // 5 - 10 åˆ†é’Ÿéšæœºè¿‡æœŸï¼Œé˜²æ­¢é›ªå´©
    int cacheExpireTime = 300 +  RandomUtil.randomInt(0, 300);
    valueOps.set(redisKey, cacheValue, cacheExpireTime, TimeUnit.SECONDS);

    // è¿”å›ç»“æœ
    return ResultUtils.success(pictureVOPage);
}
```

#### æµ‹è¯•

å¯ä»¥é€šè¿‡ Swagger æµ‹è¯•ä¸€ä¸‹è¿”å›ç»“æœæ˜¯å¦æ­£å¸¸ï¼Œå¹¶ä¸”å¯¹æ¯”å’Œä¹‹å‰æŸ¥æ•°æ®åº“çš„æ€§èƒ½æå‡ã€‚

æ²¡ç¼“å­˜ï¼Œå¹³å‡ 50msï¼š

![img](./assets/eBmAsIFzG3OHQSF6.webp)

æœ‰ç¼“å­˜ï¼Œå¹³å‡ 20~30 msï¼Œæ€§èƒ½æ˜¾è‘—æå‡ï¼

![img](./assets/ABaTXddNrNGK51Hs.webp)

ç»†å¿ƒçš„åŒå­¦ä¼šå‘ç°ï¼Œä¸ºä»€ä¹ˆæ¥å£è¿”å›çš„å¤§å°ä¸ä¸€æ ·å‘¢ï¼Ÿå› ä¸ºç¼“å­˜çš„è¿‡ç¨‹ä¸­æˆ‘ä»¬å°† JSON å­—ç¬¦ä¸²å’Œ Java å¯¹è±¡è¿›è¡Œäº†è½¬æ¢ï¼Œä½¿å¾—ä¸€äº›ä¸º null çš„å­—æ®µè¢«è¿‡æ»¤æ‰äº†ã€‚

### Caffeine æœ¬åœ°ç¼“å­˜

å½“åº”ç”¨éœ€è¦é¢‘ç¹è®¿é—®æŸäº›æ•°æ®æ—¶ï¼Œå¯ä»¥å°†è¿™äº›æ•°æ®ç¼“å­˜åˆ°åº”ç”¨çš„å†…å­˜ä¸­ï¼ˆæ¯”å¦‚ JVM ä¸­ï¼‰ï¼›ä¸‹æ¬¡è®¿é—®æ—¶ï¼Œç›´æ¥ä»å†…å­˜è¯»å–ï¼Œè€Œä¸éœ€è¦ç»è¿‡ç½‘ç»œæˆ–å…¶ä»–å­˜å‚¨ç³»ç»Ÿã€‚

ç›¸æ¯”äºåˆ†å¸ƒå¼ç¼“å­˜ï¼Œæœ¬åœ°ç¼“å­˜çš„é€Ÿåº¦æ›´å¿«ï¼Œä½†æ˜¯æ— æ³•åœ¨å¤šä¸ªæœåŠ¡å™¨é—´å…±äº«æ•°æ®ã€è€Œä¸”ä¸æ–¹ä¾¿æ‰©å®¹ã€‚

æ‰€ä»¥æœ¬åœ°ç¼“å­˜çš„åº”ç”¨åœºæ™¯ä¸€èˆ¬æ˜¯ï¼š

- æ•°æ®è®¿é—®é‡æœ‰é™çš„å°å‹æ•°æ®é›†
- ä¸éœ€è¦æœåŠ¡å™¨é—´å…±äº«æ•°æ®çš„å•æœºåº”ç”¨
- é«˜é¢‘ã€ä½å»¶è¿Ÿçš„è®¿é—®åœºæ™¯ï¼ˆå¦‚ç”¨æˆ·ä¸´æ—¶ä¼šè¯ä¿¡æ¯ã€çŸ­æœŸçƒ­ç‚¹æ•°æ®ï¼‰ã€‚

å¯¹äº Java é¡¹ç›®ï¼Œ[Caffeine](https://github.com/ben-manes/caffeine) æ˜¯ä¸»æµçš„æœ¬åœ°ç¼“å­˜æŠ€æœ¯ï¼Œæ‹¥æœ‰æé«˜çš„æ€§èƒ½å’Œä¸°å¯Œçš„åŠŸèƒ½ã€‚æ¯”å¦‚å¯ä»¥ç²¾ç¡®æ§åˆ¶ç¼“å­˜æ•°é‡å’Œå¤§å°ã€æ”¯æŒç¼“å­˜è¿‡æœŸã€æ”¯æŒå¤šç§ç¼“å­˜æ·˜æ±°ç­–ç•¥ã€æ”¯æŒå¼‚æ­¥æ“ä½œã€çº¿ç¨‹å®‰å…¨ç­‰ã€‚

ğŸ’¡ é±¼çš®å»ºè®®ï¼Œç”±äºæœ¬åœ°ç¼“å­˜ä¸éœ€è¦å¼•å…¥é¢å¤–çš„ä¸­é—´ä»¶ï¼Œæˆæœ¬æ›´ä½ã€‚å› æ­¤å¦‚æœåªæ˜¯è¦æå‡æ•°æ®è®¿é—®æ€§èƒ½ï¼Œä¼˜å…ˆè€ƒè™‘æœ¬åœ°ç¼“å­˜è€Œä¸æ˜¯åˆ†å¸ƒå¼ç¼“å­˜ã€‚

#### ç¼“å­˜è®¾è®¡

æœ¬åœ°ç¼“å­˜çš„è®¾è®¡å’Œåˆ†å¸ƒå¼ç¼“å­˜åŸºæœ¬ä¸€è‡´ï¼Œä¸å†èµ˜è¿°ã€‚ä½†æœ‰ 2 ä¸ªåŒºåˆ«ï¼š

1. æœ¬åœ°ç¼“å­˜éœ€è¦è‡ªå·±åˆ›å»ºåˆå§‹åŒ–ç¼“å­˜ç»“æ„ï¼ˆå¯ä»¥ç®€å•ç†è§£ä¸ºè¦è‡ªå·± new ä¸€ä¸ª HashMapï¼‰ã€‚
2. ç”±äºæœ¬åœ°ç¼“å­˜æœ¬èº«å°±æ˜¯æœåŠ¡å™¨éš”ç¦»çš„ï¼Œè€Œä¸”å ç”¨æœåŠ¡å™¨çš„å†…å­˜ï¼Œkey å¯ä»¥æ›´ç²¾ç®€ä¸€äº›ï¼Œä¸ç”¨å†æ·»åŠ é¡¹ç›®å‰ç¼€ã€‚

#### åç«¯å¼€å‘

1ï¼‰[å‚è€ƒå®˜æ–¹æ–‡æ¡£](https://github.com/ben-manes/caffeine) å¼•å…¥ Caffeine çš„ Maven ä¾èµ–ï¼Œæ³¨æ„å¦‚æœè¦å¼•å…¥ 3.x ç‰ˆæœ¬çš„ Caffeineï¼ŒJava ç‰ˆæœ¬å¿…é¡» >= 11ï¼å¦‚æœä¸æƒ³å‡çº§ JDKï¼Œä¹Ÿå¯ä»¥æ”¹ä¸ºå¼•å…¥ 2.x ç‰ˆæœ¬ã€‚

```xml
<!-- æœ¬åœ°ç¼“å­˜ Caffeine -->
<dependency>
  <groupId>com.github.ben-manes.caffeine</groupId>
  <artifactId>caffeine</artifactId>
  <version>3.1.8</version>
</dependency>
```

2ï¼‰æ„é€ æœ¬åœ°ç¼“å­˜ï¼Œè®¾ç½®ç¼“å­˜å®¹é‡å’Œè¿‡æœŸæ—¶é—´ï¼š

```java
private final Cache<String, String> LOCAL_CACHE =
        Caffeine.newBuilder().initialCapacity(1024)
                .maximumSize(10000L)
                // ç¼“å­˜ 5 åˆ†é’Ÿç§»é™¤
                .expireAfterWrite(5L, TimeUnit.MINUTES)
                .build();
```

3ï¼‰å‚è€ƒä¹‹å‰ä½¿ç”¨åˆ†å¸ƒå¼ç¼“å­˜çš„ä»£ç ï¼Œä¿®æ”¹ä¸ºä½¿ç”¨æœ¬åœ°ç¼“å­˜ã€‚åœ¨æŸ¥è¯¢æ•°æ®åº“å‰å…ˆæŸ¥è¯¢æœ¬åœ°ç¼“å­˜ï¼Œå¦‚æœå·²æœ‰æ•°æ®åˆ™ç›´æ¥è¿”å›ç¼“å­˜ï¼š

```java
// æ„å»ºç¼“å­˜ key
String queryCondition = JSONUtil.toJsonStr(pictureQueryRequest);
String hashKey = DigestUtils.md5DigestAsHex(queryCondition.getBytes());
String cacheKey = "listPictureVOByPage:" + hashKey;
// ä»æœ¬åœ°ç¼“å­˜ä¸­æŸ¥è¯¢
String cachedValue = LOCAL_CACHE.getIfPresent(cacheKey);
if (cachedValue != null) {
    // å¦‚æœç¼“å­˜å‘½ä¸­ï¼Œè¿”å›ç»“æœ
    Page<PictureVO> cachedPage = JSONUtil.toBean(cachedValue, Page.class);
    return ResultUtils.success(cachedPage);
}
```

å¦‚æœæ²¡æœ‰æ•°æ®åˆ™æŸ¥è¯¢æ•°æ®åº“ï¼Œå¹¶ä¸”å°†ç»“æœè®¾ç½®åˆ°æœ¬åœ°ç¼“å­˜ä¸­ï¼š

```java
// æŸ¥è¯¢æ•°æ®åº“
Page<Picture> picturePage = pictureService.page(new Page<>(current, size),
        pictureService.getQueryWrapper(pictureQueryRequest));
// è·å–å°è£…ç±»
Page<PictureVO> pictureVOPage = pictureService.getPictureVOPage(picturePage, request);

// å­˜å…¥æœ¬åœ°ç¼“å­˜
String cacheValue = JSONUtil.toJsonStr(pictureVOPage);
LOCAL_CACHE.put(cacheKey, cacheValue);
```

4ï¼‰å¯ä»¥é€šè¿‡ Swagger æµ‹è¯•ä¸€ä¸‹è¿”å›ç»“æœæ˜¯å¦æ­£å¸¸ï¼Œå¹¶ä¸”å¯¹æ¯”å’Œä¹‹å‰æŸ¥æ•°æ®åº“ã€æŸ¥ Redis çš„æ€§èƒ½æå‡ã€‚

æœ‰ç¼“å­˜ï¼Œæœ€å¿«å¯è¾¾ 12msï¼Œæ€§èƒ½åˆè¿›ä¸€æ­¥æå‡äº† 1 å€å·¦å³ï¼Œç›¸æ¯”æ•°æ®åº“æå‡äº†å¥½å‡ å€ï¼

![img](./assets/oNsfapMBymRgsnE4.webp)

è€Œä¸”ç›®å‰æˆ‘ä»¬æ•°æ®åº“å’Œ Redis éƒ½æ˜¯åœ¨æœ¬åœ°çš„ï¼Œæœ¬æ¥è®¿é—®å°±æ¯”è¾ƒå¿«ï¼Œå¦‚æœä½¿ç”¨è¿œç¨‹æ•°æ®åº“æˆ– Redisï¼Œæ€§èƒ½çš„æå‡ä¼šæ›´ä¸ºæ˜æ˜¾ã€‚

#### æ‰©å±•

æˆ‘ä»¬å‘ç°ï¼Œä½¿ç”¨æœ¬åœ°ç¼“å­˜å’Œåˆ†å¸ƒå¼ç¼“å­˜çš„æµç¨‹åŸºæœ¬æ˜¯ä¸€è‡´çš„ã€‚é‚£ä¹ˆæ€è€ƒä¸€ä¸‹ï¼Œå¦‚æœä½ æƒ³çµæ´»åœ°åˆ‡æ¢ä½¿ç”¨æœ¬åœ°ç¼“å­˜æˆ–åˆ†å¸ƒå¼ç¼“å­˜ï¼Œåº”è¯¥æ€ä¹ˆå®ç°å‘¢ï¼Ÿ

ç­”æ¡ˆï¼šç­–ç•¥æ¨¡å¼æˆ–è€…æ¨¡æ¿æ–¹æ³•æ¨¡å¼ã€‚

### å¤šçº§ç¼“å­˜

å¤šçº§ç¼“å­˜æ˜¯æŒ‡ç»“åˆæœ¬åœ°ç¼“å­˜å’Œåˆ†å¸ƒå¼ç¼“å­˜çš„ä¼˜ç‚¹ï¼Œåœ¨åŒä¸€ä¸šåŠ¡åœºæ™¯ä¸‹æ„å»ºä¸¤çº§ç¼“å­˜ç³»ç»Ÿï¼Œè¿™æ ·å¯ä»¥å…¼é¡¾æœ¬åœ°ç¼“å­˜çš„é«˜æ€§èƒ½ã€ä»¥åŠåˆ†å¸ƒå¼ç¼“å­˜çš„æ•°æ®ä¸€è‡´æ€§å’Œå¯é æ€§ã€‚

å¤šçº§ç¼“å­˜çš„å·¥ä½œæµç¨‹ï¼š

1. ç¬¬ä¸€çº§ï¼ˆCaffeine æœ¬åœ°ç¼“å­˜ï¼‰ï¼šä¼˜å…ˆä»æœ¬åœ°ç¼“å­˜ä¸­è¯»å–æ•°æ®ã€‚å¦‚æœå‘½ä¸­ï¼Œåˆ™ç›´æ¥è¿”å›ã€‚
2. ç¬¬äºŒçº§ï¼ˆRedis åˆ†å¸ƒå¼ç¼“å­˜ï¼‰ï¼šå¦‚æœæœ¬åœ°ç¼“å­˜æœªå‘½ä¸­ï¼Œåˆ™æŸ¥è¯¢ Redis åˆ†å¸ƒå¼ç¼“å­˜ã€‚å¦‚æœ Redis å‘½ä¸­ï¼Œåˆ™è¿”å›æ•°æ®å¹¶æ›´æ–°æœ¬åœ°ç¼“å­˜ã€‚
3. æ•°æ®åº“æŸ¥è¯¢ï¼šå¦‚æœ Redis ä¹Ÿæœªå‘½ä¸­ï¼Œåˆ™æŸ¥è¯¢æ•°æ®åº“ï¼Œå¹¶å°†ç»“æœå†™å…¥ Redis å’Œæœ¬åœ°ç¼“å­˜ã€‚

æµç¨‹å›¾ï¼š

![image.png](./assets/3WLaI8VdRHNyoTW7.webp)

å¤šçº§ç¼“å­˜è¿˜æœ‰ä¸€ä¸ªä¼˜åŠ¿ï¼Œå°±æ˜¯æå‡äº†ç³»ç»Ÿçš„å®¹é”™æ€§ã€‚å³ä½¿ Redis å‡ºç°æ•…éšœï¼Œæœ¬åœ°ç¼“å­˜ä»å¯æä¾›æœåŠ¡ï¼Œå‡å°‘å¯¹æ•°æ®åº“çš„ç›´æ¥ä¾èµ–ã€‚

#### åç«¯å¼€å‘

1ï¼‰ä¼˜å…ˆä»æœ¬åœ°ç¼“å­˜ä¸­è¯»å–æ•°æ®ã€‚å¦‚æœå‘½ä¸­ï¼Œåˆ™ç›´æ¥è¿”å›ã€‚

```java
// æ„å»ºç¼“å­˜ key
String queryCondition = JSONUtil.toJsonStr(pictureQueryRequest);
String hashKey = DigestUtils.md5DigestAsHex(queryCondition.getBytes());
String cacheKey = "yupicture:listPictureVOByPage:" + hashKey;

// 1. æŸ¥è¯¢æœ¬åœ°ç¼“å­˜ï¼ˆCaffeineï¼‰
String cachedValue = LOCAL_CACHE.getIfPresent(cacheKey);
if (cachedValue != null) {
    Page<PictureVO> cachedPage = JSONUtil.toBean(cachedValue, Page.class);
    return ResultUtils.success(cachedPage);
}
```

2ï¼‰å¦‚æœæœ¬åœ°ç¼“å­˜æœªå‘½ä¸­ï¼Œåˆ™æŸ¥è¯¢ Redis åˆ†å¸ƒå¼ç¼“å­˜ã€‚å¦‚æœ Redis å‘½ä¸­ï¼Œåˆ™è¿”å›æ•°æ®å¹¶æ›´æ–°æœ¬åœ°ç¼“å­˜ã€‚

```java
// 2. æŸ¥è¯¢åˆ†å¸ƒå¼ç¼“å­˜ï¼ˆRedisï¼‰
ValueOperations<String, String> valueOps = stringRedisTemplate.opsForValue();
cachedValue = valueOps.get(cacheKey);
if (cachedValue != null) {
    // å¦‚æœå‘½ä¸­ Redisï¼Œå­˜å…¥æœ¬åœ°ç¼“å­˜å¹¶è¿”å›
    LOCAL_CACHE.put(cacheKey, cachedValue);
    Page<PictureVO> cachedPage = JSONUtil.toBean(cachedValue, Page.class);
    return ResultUtils.success(cachedPage);
}
```

3ï¼‰å¦‚æœ Redis ä¹Ÿæœªå‘½ä¸­ï¼Œåˆ™æŸ¥è¯¢æ•°æ®åº“ï¼Œå¹¶å°†ç»“æœå†™å…¥ Redis å’Œæœ¬åœ°ç¼“å­˜ã€‚

```java
// 3. æŸ¥è¯¢æ•°æ®åº“
Page<Picture> picturePage = pictureService.page(new Page<>(current, size),
        pictureService.getQueryWrapper(pictureQueryRequest));
Page<PictureVO> pictureVOPage = pictureService.getPictureVOPage(picturePage, request);

// 4. æ›´æ–°ç¼“å­˜
String cacheValue = JSONUtil.toJsonStr(pictureVOPage);
// æ›´æ–°æœ¬åœ°ç¼“å­˜
LOCAL_CACHE.put(cacheKey, cacheValue);
// æ›´æ–° Redis ç¼“å­˜ï¼Œè®¾ç½®è¿‡æœŸæ—¶é—´ä¸º 5 åˆ†é’Ÿ
valueOps.set(cacheKey, cacheValue, 5, TimeUnit.MINUTES);
```

### æ‰©å±•

#### 1ã€æ‰‹åŠ¨åˆ·æ–°ç¼“å­˜

åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæ•°æ®æ›´æ–°è¾ƒä¸ºé¢‘ç¹ï¼Œä½†è‡ªåŠ¨åˆ·æ–°ç¼“å­˜æœºåˆ¶å¯èƒ½å­˜åœ¨å»¶è¿Ÿï¼Œå¯ä»¥é€šè¿‡æ‰‹åŠ¨åˆ·æ–°æ¥è§£å†³ã€‚

æ¯”å¦‚ï¼š

- æä¾›ä¸€ä¸ªåˆ·æ–°ç¼“å­˜çš„æ¥å£ï¼Œä»…ç®¡ç†å‘˜å¯è°ƒç”¨ã€‚
- æä¾›ç®¡ç†åå°ï¼Œæ”¯æŒç®¡ç†å‘˜æ‰‹åŠ¨åˆ·æ–°æŒ‡å®šç¼“å­˜ã€‚

#### 2ã€è§£å†³ç¼“å­˜å¸¸è§é—®é¢˜

ä½¿ç”¨ç¼“å­˜æ—¶ï¼Œä¸€èˆ¬è¦æ³¨æ„ä¸‹é¢å‡ ä¸ªé—®é¢˜ï¼š

1ï¼‰ç¼“å­˜å‡»ç©¿ï¼šæŸäº› **çƒ­ç‚¹æ•°æ®** åœ¨ç¼“å­˜è¿‡æœŸåï¼Œå¤§é‡è¯·æ±‚ç›´æ¥æ‰“åˆ°æ•°æ®åº“ã€‚

è§£å†³æ–¹æ¡ˆï¼šè®¾ç½®çƒ­ç‚¹æ•°æ®çš„è¶…é•¿è¿‡æœŸæ—¶é—´ï¼Œæˆ–ä½¿ç”¨äº’æ–¥é”ï¼ˆå¦‚ Redissonï¼‰æ§åˆ¶ç¼“å­˜åˆ·æ–°ã€‚

2ï¼‰ç¼“å­˜ç©¿é€ï¼šç”¨æˆ·é¢‘ç¹è¯·æ±‚ä¸å­˜åœ¨çš„æ•°æ®ï¼Œå¯¼è‡´å¤§é‡çš„è¯·æ±‚ç›´æ¥è§¦å‘æ•°æ®åº“æŸ¥è¯¢ã€‚

è§£å†³æ–¹æ¡ˆï¼šå¯¹æ— æ•ˆæŸ¥è¯¢ç»“æœä¹Ÿè¿›è¡Œç¼“å­˜ï¼ˆå¦‚è®¾ç½®ç©ºå€¼ç¼“å­˜ï¼‰ï¼Œæˆ–è€…ä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨ã€‚

3ï¼‰ç¼“å­˜é›ªå´©ï¼šå¤§é‡ç¼“å­˜åŒæ—¶è¿‡æœŸï¼Œå¯¼è‡´è¯·æ±‚æ‰“åˆ°æ•°æ®åº“ï¼Œç³»ç»Ÿå´©æºƒã€‚

è§£å†³æ–¹æ¡ˆï¼šè®¾ç½®ä¸åŒç¼“å­˜çš„è¿‡æœŸæ—¶é—´ï¼Œé¿å…åŒæ—¶è¿‡æœŸï¼›æˆ–è€…ä½¿ç”¨å¤šçº§ç¼“å­˜ï¼Œå‡å°‘å¯¹æ•°æ®åº“çš„ä¾èµ–ã€‚

ğŸ’¡ã€Šå¦‚ä½•è§£å†³ç¼“å­˜ä¸­çš„å¸¸è§é—®é¢˜ã€‹æ˜¯ä¸€é“ç»å…¸çš„å…«è‚¡æ–‡ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥ [åœ¨é¢è¯•é¸­ä¸Šé˜…è¯»å­¦ä¹ ](https://www.mianshiya.com/question/1780933295672946690)ã€‚

#### 3ã€è‡ªåŠ¨è¯†åˆ«çƒ­ç‚¹å›¾ç‰‡ç¼“å­˜

å¯ä»¥é‡‡ç”¨çƒ­ key æ¢æµ‹æŠ€æœ¯ï¼Œå®æ—¶å¯¹å›¾ç‰‡çš„è®¿é—®é‡è¿›è¡Œç»Ÿè®¡ï¼Œå¹¶è‡ªåŠ¨å°†çƒ­ç‚¹å›¾ç‰‡æ·»åŠ åˆ°å†…å­˜ç¼“å­˜ï¼Œä»¥åº”å¯¹å¤§é‡é«˜é¢‘çš„è®¿é—®ã€‚

[é±¼çš®çš„é¢è¯•åˆ·é¢˜å¹³å°é¡¹ç›®](https://www.codefather.cn/course/1826803928691945473) ä¸­å¯¹è¯¥æŠ€æœ¯æœ‰è¯¦ç»†çš„è®²è§£ï¼Œæœ‰æ—¶é—´å¯ä»¥å­¦ä¹ ä¸‹ã€‚

#### 4ã€æŸ¥è¯¢ä¼˜åŒ–

å¯ä»¥å‚è€ƒ [æ•°æ®åº“ä¼˜åŒ–æŠ€å·§](https://www.mianshiya.com/question/1816438385021997058)ï¼Œæ¯”å¦‚è·å–å›¾ç‰‡åˆ—è¡¨æ—¶åªæŸ¥è¯¢ï¼ˆselectï¼‰å¿…è¦çš„å­—æ®µï¼Œè¿”å›ç»™å‰ç«¯æ—¶ä¹Ÿåªè¿”å›å¿…è¦çš„å­—æ®µç­‰ã€‚

#### 5ã€ä»£ç ä¼˜åŒ–

å¦‚æœæ“ä½œç¼“å­˜çš„é€»è¾‘æ›´å¤æ‚ï¼Œå¯ä»¥å•ç‹¬æŠ½è±¡ CacheManager ç»Ÿä¸€ç®¡ç†ç¼“å­˜ç›¸å…³æ“ä½œã€‚

## äºŒã€å›¾ç‰‡ä¸Šä¼ ä¼˜åŒ–

### å›¾ç‰‡å‹ç¼©

å¯¹äºå›¾åº“ç½‘ç«™æ¥è¯´ï¼Œå›¾ç‰‡å‹ç¼©æ˜¯å›¾ç‰‡ä¼˜åŒ–ä¸­æœ€åŸºæœ¬ä¸”æœ€é‡è¦çš„æ“ä½œï¼Œèƒ½å¤Ÿæ˜¾è‘—å‡å°‘å›¾ç‰‡æ–‡ä»¶çš„å¤§å°ï¼Œä»è€Œé™ä½å¸¦å®½ä½¿ç”¨å’Œæµé‡æ¶ˆè€—ï¼Œå¤§å¹…é™ä½æˆæœ¬çš„åŒæ—¶ï¼Œæé«˜å›¾ç‰‡åŠ è½½é€Ÿåº¦ã€‚

æœ‰å“ªäº›å‹ç¼©å›¾ç‰‡çš„æ–¹æ³•å‘¢ï¼Ÿ

1. å°†å›¾ç‰‡æ ¼å¼è½¬æ¢ä¸ºä½“ç§¯æ›´å°çš„æ ¼å¼ï¼Œæ¯”å¦‚ WebP æˆ–å…¶ä»–ç°ä»£æ ¼å¼
2. å¯¹å›¾ç‰‡è´¨é‡è¿›è¡Œå‹ç¼©
3. ç¼©å°å›¾ç‰‡å°ºå¯¸

å½“ç„¶å¯¹äºå›¾ç‰‡ç½‘ç«™æ¥è¯´ï¼Œæˆ‘ä»¬å¸Œæœ›å°½å¯èƒ½ä¸è¦å½±å“å›¾ç‰‡çš„è´¨é‡ï¼Œå› æ­¤æ›´æ¨èç¬¬ 1 ç§æ–¹æ³•ã€‚

é‚£ä¹ˆå°†å›¾ç‰‡å‹ç¼©æˆä»€ä¹ˆæ ¼å¼ï¼Ÿå¦‚ä½•å¯¹å›¾ç‰‡è¿›è¡Œå‹ç¼©å‘¢ï¼Ÿ

#### 1ã€å›¾ç‰‡å‹ç¼©æ ¼å¼

æ ¼å¼ä¸Šï¼Œæœ‰ 2 ç§é€‰æ‹©ï¼š

1ï¼‰WebPï¼šç”± Google å¼€å‘çš„ç°ä»£å›¾ç‰‡æ ¼å¼ï¼Œæ”¯æŒæœ‰æŸå’Œæ— æŸå‹ç¼©ã€‚ç›¸æ¯”ä¼ ç»Ÿæ ¼å¼ï¼š

- æ¯” PNG æ–‡ä»¶å°çº¦ 26%ã€‚
- æ¯” JPEG æ–‡ä»¶å°çº¦ 25%-34%ã€‚
- æ”¯æŒé€æ˜èƒŒæ™¯ï¼ˆAlpha é€šé“ï¼‰ã€‚
- å…¼å®¹æ€§ï¼šå¤§éƒ¨åˆ†ä¸»æµæµè§ˆå™¨ï¼ˆå¦‚ Chromeã€Edgeã€Firefox ç­‰ï¼‰å‡å·²æ”¯æŒ WebPã€‚

2ï¼‰AVIFï¼šåŸºäº AV1 è§†é¢‘ç¼–ç æŠ€æœ¯çš„å›¾ç‰‡æ ¼å¼ï¼Œå‹ç¼©ç‡æ›´é«˜ã€‚

- æ¯” WebP çš„æ–‡ä»¶å¤§å°æ›´å°ï¼Œç”»è´¨æ›´ä¼˜ã€‚
- æ”¯æŒé€æ˜èƒŒæ™¯å’Œé«˜åŠ¨æ€èŒƒå›´ï¼ˆHDRï¼‰ã€‚

è™½ç„¶ AVIF çœ‹èµ·æ¥æ›´ç‰›ï¼Œä½†ç›®å‰å…¶å…¼å®¹æ€§æ²¡æœ‰ WebP è¦å¥½ï¼Œä¸ºäº†ä¿è¯å›¾ç‰‡åœ¨ä¸åŒæµè§ˆå™¨éƒ½èƒ½æ­£å¸¸åŠ è½½ï¼Œ**å»ºè®®é€‰æ‹© WebP æ ¼å¼**ã€‚

#### 2ã€å›¾ç‰‡å‹ç¼©æ–¹æ¡ˆ

è·Ÿè§£æå›¾ç‰‡çš„æ“ä½œä¸€æ ·ï¼Œå¯ä»¥ä½¿ç”¨æœ¬åœ°çš„å›¾åƒå¤„ç†ç±»åº“è‡ªè¡Œæ“ä½œï¼Œä¹Ÿå¯ä»¥åˆ©ç”¨ç¬¬ä¸‰æ–¹äº‘æœåŠ¡å®Œæˆã€‚

å› ä¸ºæˆ‘ä»¬å›¾ç‰‡å·²ç»ä¸Šä¼ åˆ°äº†è…¾è®¯äº‘ COS å¯¹è±¡å­˜å‚¨æœåŠ¡ï¼Œå¯ä»¥ç›´æ¥åˆ©ç”¨æ•°æ®ä¸‡è±¡æœåŠ¡ã€‚é€šè¿‡é…ç½®å›¾ç‰‡å¤„ç†è§„åˆ™ï¼Œåœ¨å›¾ç‰‡ä¸Šä¼ çš„åŒæ—¶è‡ªåŠ¨è¿›è¡Œå‹ç¼©å¤„ç†ï¼Œå‡å°‘å¼€å‘æˆæœ¬ã€‚

å¦‚ä½•åˆ©ç”¨æ•°æ®ä¸‡è±¡å¯¹å›¾ç‰‡è¿›è¡Œå‹ç¼©å‘¢ï¼Ÿå®˜æ–¹æä¾›äº† [æœ€ä½³å®è·µæ–‡æ¡£](https://cloud.tencent.com/document/product/460/72229) ï¼Œä¸»è¦æœ‰ 2 ç§å‹ç¼©æ–¹å¼ï¼š

1. è®¿é—®å›¾ç‰‡æ—¶å®æ—¶å‹ç¼©
2. ä¸Šä¼ å›¾ç‰‡æ—¶å®æ—¶å‹ç¼©ï¼Œ[å‚è€ƒæ–‡æ¡£](https://cloud.tencent.com/document/product/436/54050#.E4.B8.8A.E4.BC.A0.E6.97.B6.E5.A4.84.E7.90.86)

å…¶å®è¿˜æœ‰ç¬¬ä¸‰ç§æ–¹å¼ï¼Œä¹Ÿå¯ä»¥å¯¹å·²ä¸Šä¼ çš„å›¾ç‰‡è¿›è¡Œå‹ç¼©å¤„ç†ï¼Œ[å‚è€ƒæ–‡æ¡£](https://cloud.tencent.com/document/product/436/54050#.E4.BA.91.E4.B8.8A.E6.95.B0.E6.8D.AE.E5.A4.84.E7.90.86)ã€‚

å¯¹äºæˆ‘ä»¬çš„éœ€æ±‚ï¼Œè¦å°†å›¾ç‰‡æ ¼å¼è½¬åŒ–ä¸º WebPï¼Œå¯ä»¥ [å‚è€ƒå®˜æ–¹æ–‡æ¡£](https://cloud.tencent.com/document/product/436/44883)ï¼Œåœ¨ä¸Šä¼ æ–‡ä»¶æ—¶ï¼Œä¼ å…¥ Rules è§„åˆ™ã€‚ä½¿ç”¨ HTTP API è°ƒç”¨æ—¶ï¼Œä¼ å…¥å¤„ç†è§„åˆ™å‚æ•°ï¼š

![img](./assets/cSt4qMZgpWH3B7O1.webp)

å¦‚æœä½¿ç”¨ SDKï¼Œå°±éœ€è¦æ„é€ å›¾ç‰‡å¤„ç†è§„åˆ™å¯¹è±¡ï¼Œ[å‚è€ƒæ–‡æ¡£](https://cloud.tencent.com/document/product/436/55377#.E4.B8.8A.E4.BC.A0.E6.97.B6.E5.9B.BE.E7.89.87.E6.8C.81.E4.B9.85.E5.8C.96.E5.A4.84.E7.90.86)ï¼š

![img](./assets/DuLnjQeduxZofIuS.webp)

#### 3ã€åç«¯å¼€å‘

ä¸ºäº†å®ç°æ–¹ä¾¿ï¼Œæˆ‘ä»¬æ­¤å¤„ä»…å¯¹æ–‡ä»¶æ ¼å¼è¿›è¡Œè½¬åŒ–ï¼Œä¸è¿›è¡Œè´¨é‡å˜æ¢ä¹‹ç±»çš„å…¶ä»–å¤„ç†ã€‚

1ï¼‰ä¿®æ”¹ CosManager ä¸Šä¼ å›¾ç‰‡çš„æ–¹æ³•ï¼Œå°†å›¾ç‰‡åç¼€è½¬ä¸º webpï¼Œå¹¶ä¸”ä½¿ç”¨æ•°æ®ä¸‡è±¡å°†å›¾ç‰‡æ ¼å¼è½¬ä¸º webpï¼š

```java
public PutObjectResult putPictureObject(String key, File file) {
    PutObjectRequest putObjectRequest = new PutObjectRequest(cosClientConfig.getBucket(), key,
            file);
    // å¯¹å›¾ç‰‡è¿›è¡Œå¤„ç†ï¼ˆè·å–åŸºæœ¬ä¿¡æ¯ä¹Ÿè¢«è§†ä½œä¸ºä¸€ç§å¤„ç†ï¼‰
    PicOperations picOperations = new PicOperations();
    // 1 è¡¨ç¤ºè¿”å›åŸå›¾ä¿¡æ¯
    picOperations.setIsPicInfo(1);
    List<PicOperations.Rule> rules = new ArrayList<>();
    // å›¾ç‰‡å‹ç¼©ï¼ˆè½¬æˆ webp æ ¼å¼ï¼‰
    String webpKey = FileUtil.mainName(key) + ".webp";
    PicOperations.Rule compressRule = new PicOperations.Rule();
    compressRule.setRule("imageMogr2/format/webp");
    compressRule.setBucket(cosClientConfig.getBucket());
    compressRule.setFileId(webpKey);
    rules.add(compressRule);
    // æ„é€ å¤„ç†å‚æ•°
    picOperations.setRules(rules);
    putObjectRequest.setPicOperations(picOperations);
    return cosClient.putObject(putObjectRequest);
}
```

2ï¼‰ä¿®æ”¹ PictureUploadTemplate ä¸Šä¼ å›¾ç‰‡çš„æ–¹æ³•ï¼Œä»å›¾ç‰‡å¤„ç†ç»“æœä¸­è·å–åˆ°ç¼©ç•¥å›¾ï¼Œå¹¶è®¾ç½®åˆ°è¿”å›ç»“æœä¸­ï¼š

```java
try {
    // åˆ›å»ºä¸´æ—¶æ–‡ä»¶
    file = File.createTempFile(uploadPath, null);
    // å¤„ç†æ–‡ä»¶æ¥æºï¼ˆæœ¬åœ°æˆ– URLï¼‰
    processFile(inputSource, file);
    // ä¸Šä¼ å›¾ç‰‡åˆ°å¯¹è±¡å­˜å‚¨
    PutObjectResult putObjectResult = cosManager.putPictureObject(uploadPath, file);
    ImageInfo imageInfo = putObjectResult.getCiUploadResult().getOriginalInfo().getImageInfo();
    ProcessResults processResults = putObjectResult.getCiUploadResult().getProcessResults();
    List<CIObject> objectList = processResults.getObjectList();
    if (CollUtil.isNotEmpty(objectList)) {
        CIObject compressedCiObject = objectList.get(0);
        // å°è£…å‹ç¼©å›¾è¿”å›ç»“æœ
        return buildResult(originFilename, compressedCiObject);
    }
    // å°è£…åŸå›¾è¿”å›ç»“æœ
    return buildResult(originFilename, file, uploadPath, imageInfo);
} catch (Exception e) {
    log.error("å›¾ç‰‡ä¸Šä¼ åˆ°å¯¹è±¡å­˜å‚¨å¤±è´¥", e);
    throw new BusinessException(ErrorCode.SYSTEM_ERROR, "ä¸Šä¼ å¤±è´¥");
}
```

3ï¼‰ç¼–å†™æ–°çš„å°è£…è¿”å›ç»“æœæ–¹æ³•ï¼Œä»å‹ç¼©å›¾ä¸­è·å–å›¾ç‰‡ä¿¡æ¯ï¼š

```java
private UploadPictureResult buildResult(String originFilename, CIObject compressedCiObject) {
    UploadPictureResult uploadPictureResult = new UploadPictureResult();
    int picWidth = compressedCiObject.getWidth();
    int picHeight = compressedCiObject.getHeight();
    double picScale = NumberUtil.round(picWidth * 1.0 / picHeight, 2).doubleValue();
    uploadPictureResult.setPicName(FileUtil.mainName(originFilename));
    uploadPictureResult.setPicWidth(picWidth);
    uploadPictureResult.setPicHeight(picHeight);
    uploadPictureResult.setPicScale(picScale);
    uploadPictureResult.setPicFormat(compressedCiObject.getFormat());
    uploadPictureResult.setPicSize(compressedCiObject.getSize().longValue());
    // è®¾ç½®å›¾ç‰‡ä¸ºå‹ç¼©åçš„åœ°å€
    uploadPictureResult.setUrl(cosClientConfig.getHost() + "/" + compressedCiObject.getKey());
    return uploadPictureResult;
}
```

#### 4ã€æµ‹è¯•

ä¸Šä¼ å›¾ç‰‡å¹¶æŸ¥çœ‹å¯¹è±¡å­˜å‚¨ä¸­çš„èµ„æºå¤§å°ï¼Œå‘ç°å‹ç¼©æ•ˆæœæ˜¾è‘—ã€‚è€Œä¸”å‹ç¼©å›¾å’ŒåŸå›¾åŒåï¼Œä¾¿äºæŸ¥æ‰¾åŸå›¾ï¼š

![img](./assets/O88LmOWLaEKTHPib.webp)

å‰ç«¯ä¹Ÿèƒ½æ­£å¸¸è·å–åˆ°å‹ç¼©åçš„å›¾ç‰‡ä¿¡æ¯ï¼š

![img](./assets/iHeRrdiMyNmmRGwi.webp)

#### æ‰©å±•

1ï¼‰å¢åŠ å¯¹åŸå›¾çš„å¤„ç†

ç›®å‰æ¯æ¬¡ä¸Šä¼ å›¾ç‰‡å®é™…ä¸Šä¼šä¿å­˜åŸå›¾å’Œå‹ç¼©å›¾ 2 ä¸ªå›¾ç‰‡ï¼ŒåŸå›¾å ç”¨çš„ç©ºé—´è¿˜æ˜¯æ¯”è¾ƒå¤§çš„ã€‚å¦‚æœæƒ³è¿›ä¸€æ­¥ä¼˜åŒ–ï¼Œå¯ä»¥åˆ é™¤åŸå›¾ï¼Œåªä¿ç•™ç¼©ç•¥å›¾ï¼›æˆ–è€…åœ¨æ•°æ®åº“ä¸­ä¿å­˜åŸå›¾çš„åœ°å€ï¼Œç”¨ä½œå¤‡ä»½ã€‚

2ï¼‰å°è¯•æ›´å¤§æ¯”ä¾‹çš„å‹ç¼©ï¼Œæ¯”å¦‚ä½¿ç”¨ [è´¨é‡å˜æ¢](https://cloud.tencent.com/document/product/436/44884) æ¥å¤„ç†å›¾ç‰‡ã€‚

### æ‰©å±•çŸ¥è¯† - æ–‡ä»¶ç§’ä¼ 

ç”±äºæ–‡ä»¶ç§’ä¼ å¯¹äºå›¾ç‰‡ä¸Šä¼ åœºæ™¯çš„ä½œç”¨æœ‰é™ï¼Œä»…ä½œä¸ºæ‰©å±•çŸ¥è¯†å­¦ä¹ å³å¯ï¼Œä¸å¿…åœ¨æœ¬é¡¹ç›®ä¸­å®ç°ã€‚

æ–‡ä»¶ç§’ä¼ æ˜¯ä¸€ç§åŸºäºæ–‡ä»¶çš„å”¯ä¸€æ ‡è¯†ï¼ˆå¦‚ MD5ã€SHA-256ï¼‰å¯¹æ–‡ä»¶å†…å®¹è¿›è¡Œå¿«é€Ÿæ ¡éªŒï¼Œé¿å…é‡å¤ä¸Šä¼ çš„æ–¹æ³•ï¼Œåœ¨å¤§å‹æ–‡ä»¶ä¼ è¾“åœºæ™¯ä¸‹éå¸¸é‡è¦ã€‚å¯ä»¥æé«˜æ€§èƒ½ã€èŠ‚çº¦å¸¦å®½å’Œå­˜å‚¨èµ„æºã€‚

å¤§å®¶å¯èƒ½ç”¨è¿‡ XX ç½‘ç›˜è½¯ä»¶ï¼Œå¦‚æœé‡å¤ä¸Šä¼ ç›¸åŒçš„æ–‡ä»¶ 2 æ¬¡ï¼Œä½ ä¼šå‘ç°ç¬¬äºŒæ¬¡çš„ä¸Šä¼ é€Ÿåº¦è´¼å¿«ï¼

#### **æ–‡ä»¶ç§’ä¼ çš„å®ç°æ–¹æ¡ˆ**

æ–‡ä»¶ç§’ä¼ çš„å®ç°å¹¶ä¸å¤æ‚ï¼Œæµç¨‹å¦‚ä¸‹ï¼š

1ï¼‰å®¢æˆ·ç«¯ç”Ÿæˆæ–‡ä»¶å”¯ä¸€æ ‡è¯†ï¼šä¸Šä¼ å‰ï¼Œé€šè¿‡å®¢æˆ·ç«¯è®¡ç®—æ–‡ä»¶çš„å“ˆå¸Œå€¼ï¼ˆå¦‚ MD5ã€SHA-256ï¼‰ï¼Œç”Ÿæˆæ–‡ä»¶çš„å”¯ä¸€æŒ‡çº¹ã€‚

2ï¼‰æœåŠ¡ç«¯æ ¡éªŒæ–‡ä»¶æŒ‡çº¹ï¼šåç«¯æ¥æ”¶åˆ°æ–‡ä»¶æŒ‡çº¹åï¼Œåœ¨å­˜å‚¨ä¸­æŸ¥è¯¢æ˜¯å¦å·²å­˜åœ¨ç›¸åŒæ–‡ä»¶ã€‚

- è‹¥å­˜åœ¨ç›¸åŒæ–‡ä»¶ï¼Œåˆ™ç›´æ¥è¿”å›æ–‡ä»¶çš„å­˜å‚¨è·¯å¾„ã€‚
- è‹¥ä¸å­˜åœ¨ç›¸åŒæ–‡ä»¶ï¼Œåˆ™æ¥æ”¶å¹¶å­˜å‚¨æ–°æ–‡ä»¶ï¼ŒåŒæ—¶è®°å½•å…¶æŒ‡çº¹ä¿¡æ¯ã€‚

æ³¨æ„ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯æ˜¯ç›¸å¯¹çš„æ¦‚å¿µã€‚å› ä¸ºç°åœ¨æˆ‘ä»¬è¦æŠŠæ–‡ä»¶ä¸Šä¼ åˆ°å¯¹è±¡å­˜å‚¨æœåŠ¡å™¨ï¼Œæˆ‘ä»¬çš„åç«¯æ­¤æ—¶å°±æ˜¯â€œå®¢æˆ·ç«¯â€ï¼Œå¯¹è±¡å­˜å‚¨æœåŠ¡å™¨æ‰æ˜¯ â€œæœåŠ¡ç«¯â€ã€‚

å¯¹äºæˆ‘ä»¬çš„é¡¹ç›®ï¼Œç»™å›¾ç‰‡è¡¨å¢åŠ  md5 å­—æ®µç”¨äºå­˜å‚¨æ–‡ä»¶æŒ‡çº¹ï¼Œä¸Šä¼ å›¾ç‰‡å‰å¢åŠ ç±»ä¼¼çš„é€»è¾‘åˆ¤æ–­å³å¯ï¼š

```java
// è®¡ç®—æ–‡ä»¶æŒ‡çº¹
String md5 = SecureUtil.md5(file);
// ä»æ•°æ®åº“ä¸­æŸ¥è¯¢å·²æœ‰çš„æ–‡ä»¶
List<Picture> pictureList = pictureService.lambdaQuery()
        .eq(Picture::getMd5, md5)
        .list();
// æ–‡ä»¶å·²å­˜åœ¨ï¼Œç§’ä¼ 
if (CollUtil.isNotEmpty(pictureList)) {
    // ç›´æ¥å¤ç”¨å·²æœ‰æ–‡ä»¶çš„ä¿¡æ¯ï¼Œä¸å¿…é‡å¤ä¸Šä¼ æ–‡ä»¶
    Picture existPicture = pictureList.get(0);
} else {
    // æ–‡ä»¶ä¸å­˜åœ¨ï¼Œå®é™…ä¸Šä¼ é€»è¾‘
}
```

#### **å®é™…ä½¿ç”¨ä¸­çš„é™åˆ¶**

æˆ‘ä»¬ç›®å‰çš„é¡¹ç›®å…¶å®ä¸é€‚åˆä½¿ç”¨æ–‡ä»¶ç§’ä¼ ã€‚ä¸€æ–¹é¢æ˜¯å¯¹äºå›¾ç‰‡åœºæ™¯ï¼Œæ–‡ä»¶æ¯”è¾ƒå°ã€é‡å¤æ–‡ä»¶ä¹Ÿç›¸å¯¹è¾ƒå°‘ï¼Œç§’ä¼ çš„ä¼˜åŒ–æ•ˆæœæœ‰é™ï¼›å¦å¤–ä¸€æ–¹é¢æ˜¯æœ¬é¡¹ç›®ä½¿ç”¨è…¾è®¯äº‘ COS çš„å¯¹è±¡å­˜å‚¨ï¼Œåªèƒ½é€šè¿‡å”¯ä¸€åœ°å€å»å–æ–‡ä»¶ï¼Œæ— æ³•å®Œå…¨è‡ªå®šä¹‰æ–‡ä»¶çš„å­˜å‚¨ç»“æ„ã€ä¹Ÿä¸æ”¯æŒæ–‡ä»¶å¿«æ·æ–¹å¼çš„æ¦‚å¿µï¼Œå› æ­¤ç§’ä¼ çš„æ–‡ä»¶åœ°å€å¿…é¡»ä½¿ç”¨å’ŒåŸæ–‡ä»¶ç›¸åŒçš„å¯¹è±¡è·¯å¾„ï¼Œå¯èƒ½å¯¼è‡´å…¶ä»–çš„é—®é¢˜ï¼ˆæ¯”å¦‚ç”¨æˆ· A ä¸Šä¼ çš„å›¾ç‰‡åœ°å€ç­‰åŒäºç”¨æˆ· B ä¸Šä¼ çš„åœ°å€ï¼‰ã€‚

### æ‰©å±•çŸ¥è¯† - åˆ†ç‰‡ä¸Šä¼ å’Œæ–­ç‚¹ç»­ä¼ 

å¯¹äºå¤§æ–‡ä»¶ï¼Œè¿˜å¯ä»¥å¼€å¯åˆ†ç‰‡ä¸Šä¼ å’Œæ–­ç‚¹ç»­ä¼ ï¼Œä¸éœ€è¦è‡ªå·±å¼€å‘ï¼Œç›´æ¥ä½¿ç”¨ [å¯¹è±¡å­˜å‚¨çš„ SDK](https://cloud.tencent.com/document/product/436/65935) å°±èƒ½å®Œæˆã€‚

![img](./assets/ppE70rHmeBpnjbDY.webp)

## ä¸‰ã€å›¾ç‰‡åŠ è½½ä¼˜åŒ–

å›¾ç‰‡åŠ è½½ä¼˜åŒ–çš„ç›®çš„æ˜¯æå‡é¡µé¢åŠ è½½é€Ÿåº¦ã€å‡å°‘å¸¦å®½æ¶ˆè€—ï¼Œå¹¶æ”¹å–„ç”¨æˆ·ä½“éªŒã€‚

æœ¬èŠ‚é±¼çš®å°†ä»ç¼©ç•¥å›¾ã€æ‡’åŠ è½½ã€CDN åŠ é€Ÿã€æµè§ˆå™¨ç¼“å­˜è¿™ 4 ä¸ªæ–¹é¢è¿›è¡Œå…¨é¢ä¼˜åŒ–ã€‚

### ç¼©ç•¥å›¾

ç³»ç»Ÿç›®å‰çš„é—®é¢˜ï¼šé¦–é¡µç›´æ¥åŠ è½½åŸå›¾ï¼ŒåŸå›¾æ–‡ä»¶é€šå¸¸æ¯”ç¼©ç•¥å›¾å¤§æ•°å€ç”šè‡³æ•°åå€ï¼Œä¸ä»…å¯¼è‡´åŠ è½½æ—¶é—´é•¿ï¼Œè¿˜ä¼šé€ æˆå¤§é‡æµé‡æµªè´¹ã€‚

è§£å†³æ–¹æ¡ˆï¼šä¸Šä¼ å›¾ç‰‡æ—¶ï¼ŒåŒæ—¶ç”Ÿæˆä¸€ä»½è¾ƒå°å°ºå¯¸çš„ç¼©ç•¥å›¾ã€‚ç”¨æˆ·æµè§ˆå›¾ç‰‡åˆ—è¡¨æ—¶åŠ è½½ç¼©ç•¥å›¾ï¼Œåªæœ‰åœ¨è¿›å…¥è¯¦æƒ…é¡µæˆ–ä¸‹è½½æ—¶æ‰åŠ è½½åŸå›¾ã€‚

#### 1ã€å®ç°æ–¹æ¡ˆ

ç”Ÿæˆç¼©ç•¥å›¾çš„æ–¹æ³•å’Œå‰é¢è®²çš„ â€œå›¾ç‰‡å‹ç¼©â€ ä¸€è‡´ï¼Œå¯ä»¥ä½¿ç”¨æœ¬åœ°å›¾åƒå¤„ç†ç±»åº“ï¼Œä¹Ÿå¯ä»¥åˆ©ç”¨ç¬¬ä¸‰æ–¹äº‘æœåŠ¡å®Œæˆã€‚

æ­¤å¤„æˆ‘ä»¬ä¾ç„¶é€‰æ‹©æ•°æ®ä¸‡è±¡æœåŠ¡ï¼Œ[å‚è€ƒ Java SDK æ–‡æ¡£](https://cloud.tencent.com/document/product/436/55377#.E4.B8.8A.E4.BC.A0.E6.97.B6.E5.9B.BE.E7.89.87.E6.8C.81.E4.B9.85.E5.8C.96.E5.A4.84.E7.90.86) ä½¿ç”¨ SDK æ¥æ„é€ å›¾ç‰‡å¤„ç†è§„åˆ™å¯¹è±¡ï¼Œå…·ä½“çš„å›¾ç‰‡ç¼©æ”¾å‚æ•°å¯ [å‚è€ƒæ–‡æ¡£](https://cloud.tencent.com/document/product/436/44880)ï¼š

![img](./assets/Wa3mO0pH4xLB52WQ.webp)

#### 2ã€åç«¯å¼€å‘

1ï¼‰æ•°æ®è¡¨ picture æ–°å¢ç¼©ç•¥å›¾å­—æ®µï¼š

```sql
ALTER TABLE picture
    -- æ·»åŠ æ–°åˆ—
    ADD COLUMN thumbnailUrl varchar(512) NULL COMMENT 'ç¼©ç•¥å›¾ url';
```

2ï¼‰PictureMapper.xml æ–°å¢ç¼©ç•¥å›¾å­—æ®µï¼š

```xml
<result property="thumbnailUrl" column="thumbnailUrl" jdbcType="VARCHAR"/>
<!-- ... -->
<sql id="Base_Column_List">
    id,url,thumbnailUrl,name,
    introduction,category,tags,
    picSize,picWidth,picHeight,
    picScale,picFormat,userId,
    createTime,editTime,updateTime,
    isDelete
</sql>
```

3ï¼‰æ•°æ®æ¨¡å‹æ–°å¢ç¼©ç•¥å›¾å­—æ®µï¼ŒåŒ…æ‹¬ Picture ç±»ã€PictureVO ç±»ã€UploadPictureResult ç±»ï¼š

```java
/**
 * ç¼©ç•¥å›¾ url
 */
private String thumbnailUrl;
```

4ï¼‰ç¼©ç•¥å›¾å¤„ç†

é¦–å…ˆæ˜ç¡®æˆ‘ä»¬ä½¿ç”¨çš„ç¼©æ”¾è§„åˆ™ï¼Œè®¾ç½®æœ€å¤§å®½é«˜åï¼Œå¯¹å›¾ç‰‡è¿›è¡Œç­‰æ¯”ç¼©å°ã€‚ä¸”å¦‚æœç¼©ç•¥å›¾çš„å®½é«˜å¤§äºåŸå›¾ï¼Œåˆ™ä¸ä¼šå¤„ç†ã€‚

![img](./assets/p2zSPB1YnAXjLzgq.webp)

ä¿®æ”¹ CosManager çš„ä¸Šä¼ å›¾ç‰‡æ–¹æ³•ï¼Œè¡¥å……å¯¹ç¼©ç•¥å›¾çš„å¤„ç†ï¼š

```java
public PutObjectResult putPictureObject(String key, File file) {
    PutObjectRequest putObjectRequest = new PutObjectRequest(cosClientConfig.getBucket(), key,
            file);
    // å¯¹å›¾ç‰‡è¿›è¡Œå¤„ç†ï¼ˆè·å–åŸºæœ¬ä¿¡æ¯ä¹Ÿè¢«è§†ä½œä¸ºä¸€ç§å¤„ç†ï¼‰
    PicOperations picOperations = new PicOperations();
    // 1 è¡¨ç¤ºè¿”å›åŸå›¾ä¿¡æ¯
    picOperations.setIsPicInfo(1);
    List<PicOperations.Rule> rules = new ArrayList<>();
    // å›¾ç‰‡å‹ç¼©ï¼ˆè½¬æˆ webp æ ¼å¼ï¼‰
    String webpKey = FileUtil.mainName(key) + ".webp";
    PicOperations.Rule compressRule = new PicOperations.Rule();
    compressRule.setRule("imageMogr2/format/webp");
    compressRule.setBucket(cosClientConfig.getBucket());
    compressRule.setFileId(webpKey);
    rules.add(compressRule);
    // ç¼©ç•¥å›¾å¤„ç†
    PicOperations.Rule thumbnailRule = new PicOperations.Rule();
    thumbnailRule.setBucket(cosClientConfig.getBucket());
    String thumbnailKey = FileUtil.mainName(key) + "_thumbnail." + FileUtil.getSuffix(key);
    thumbnailRule.setFileId(thumbnailKey);
    // ç¼©æ”¾è§„åˆ™ /thumbnail/<Width>x<Height>>ï¼ˆå¦‚æœå¤§äºåŸå›¾å®½é«˜ï¼Œåˆ™ä¸å¤„ç†ï¼‰
    thumbnailRule.setRule(String.format("imageMogr2/thumbnail/%sx%s>", 128, 128));
    rules.add(thumbnailRule);
    // æ„é€ å¤„ç†å‚æ•°
    picOperations.setRules(rules);
    putObjectRequest.setPicOperations(picOperations);
    return cosClient.putObject(putObjectRequest);
}
```

ä¿®æ”¹ PictureUploadTemplate çš„ä¸Šä¼ å›¾ç‰‡æ–¹æ³•ï¼Œè·å–åˆ°ç¼©ç•¥å›¾ï¼š

```java
ProcessResults processResults = putObjectResult.getCiUploadResult().getProcessResults();
List<CIObject> objectList = processResults.getObjectList();
if (CollUtil.isNotEmpty(objectList)) {
    CIObject compressedCiObject = objectList.get(0);
    CIObject thumbnailCiObject = objectList.get(1);
    // å°è£…å‹ç¼©å›¾è¿”å›ç»“æœ
    return buildResult(originFilename, compressedCiObject, thumbnailCiObject);
}
```

ä¿®æ”¹ PictureUploadTemplate å°è£…è¿”å›ç»“æœçš„æ–¹æ³•ï¼Œå°†ç¼©ç•¥å›¾è·¯å¾„ä¹Ÿè®¾ç½®åˆ°è¿”å›ç»“æœä¸­ï¼š

```java
private UploadPictureResult buildResult(String originFilename, CIObject compressedCiObject, CIObject thumbnailCiObject) {
    UploadPictureResult uploadPictureResult = new UploadPictureResult();
    // ...
    // è®¾ç½®ç¼©ç•¥å›¾
    uploadPictureResult.setThumbnailUrl(cosClientConfig.getHost() + "/" + thumbnailCiObject.getKey());
    return uploadPictureResult;
}
```

éœ€è¦åŒæ­¥ä¿®æ”¹ PictureService çš„ä¸Šä¼ å›¾ç‰‡æ–¹æ³•ï¼Œè¡¥å……è®¾ç½®ç¼©ç•¥å›¾å­—æ®µï¼š

```java
// æ„é€ è¦å…¥åº“çš„å›¾ç‰‡ä¿¡æ¯
Picture picture = new Picture();
picture.setUrl(uploadPictureResult.getUrl());
picture.setThumbnailUrl(uploadPictureResult.getThumbnailUrl());
String picName = uploadPictureResult.getPicName();
```

5ï¼‰æµ‹è¯•æ•ˆæœ

ä¸Šä¼ å¤§å›¾ç‰‡æ—¶ï¼Œç¼©ç•¥å›¾çš„æ•ˆæœæ˜¾è‘—ï¼Œä½“ç§¯ç›´æ¥å‡å°ç™¾å€ï¼

![img](./assets/T2u90XsMuw66s3Qx.webp)

ä½†æœ‰ä¸ªæ¯”è¾ƒå‘çš„æƒ…å†µï¼Œå¦‚æœä¸Šä¼ çš„å›¾ç‰‡æœ¬èº«å°±æ¯”è¾ƒå°ï¼Œç¼©ç•¥å›¾åè€Œæ¯”å‹ç¼©å›¾æ›´å¤§ï¼Œè¿˜ä¸å¦‚ä¸ç¼©ç•¥ï¼

![img](./assets/qX6kfuD8w9vcsgNI.webp)

æˆ‘ä»¬å¯ä»¥ä¼˜åŒ– CosManager å›¾ç‰‡ä¸Šä¼ çš„é€»è¾‘ï¼Œä»…å¯¹ > 20 KB çš„å›¾ç‰‡ç”Ÿæˆç¼©ç•¥å›¾ï¼š

```java
// ç¼©ç•¥å›¾å¤„ç†ï¼Œä»…å¯¹ > 20 KB çš„å›¾ç‰‡ç”Ÿæˆç¼©ç•¥å›¾
if (file.length() > 2 * 1024) {
    PicOperations.Rule thumbnailRule = new PicOperations.Rule();
    thumbnailRule.setBucket(cosClientConfig.getBucket());
    String thumbnailKey = FileUtil.mainName(key) + "_thumbnail." + FileUtil.getSuffix(key);
    thumbnailRule.setFileId(thumbnailKey);
    // ç¼©æ”¾è§„åˆ™ /thumbnail/<Width>x<Height>>ï¼ˆå¦‚æœå¤§äºåŸå›¾å®½é«˜ï¼Œåˆ™ä¸å¤„ç†ï¼‰
    thumbnailRule.setRule(String.format("imageMogr2/thumbnail/%sx%s>", 128, 128));
    rules.add(thumbnailRule);
}
```

ä¿®æ”¹ PictureUploadTemplate çš„é€»è¾‘ï¼Œå¦‚æœæ²¡æœ‰ç”Ÿæˆç¼©ç•¥å›¾ï¼Œåˆ™ç¼©ç•¥å›¾ç­‰äºå‹ç¼©å›¾ï¼š

```java
if (CollUtil.isNotEmpty(objectList)) {
    CIObject compressedCiObject = objectList.get(0);
    // ç¼©ç•¥å›¾é»˜è®¤ç­‰äºå‹ç¼©å›¾
    CIObject thumbnailCiObject = compressedCiObject;
    // æœ‰ç”Ÿæˆç¼©ç•¥å›¾ï¼Œæ‰å¾—åˆ°ç¼©ç•¥å›¾
    if (objectList.size() > 1) {
        thumbnailCiObject = objectList.get(1);
    }
    // å°è£…å‹ç¼©å›¾è¿”å›ç»“æœ
    return buildResult(originFilename, compressedCiObject, thumbnailCiObject);
}
```

#### 3ã€å‰ç«¯å¼€å‘

åªéœ€è¦å°†é¦–é¡µå±•ç¤ºçš„å›¾ç‰‡æ”¹ä¸ºä¼˜å…ˆè¯»å–ç¼©ç•¥å›¾å³å¯ï¼š

```vue
<img
  style="height: 180px; object-fit: cover"
  :alt="picture.name"
  :src="picture.thumbnailUrl ?? picture.url"
  loading="lazy"
/>
```

æ•ˆæœå¦‚å›¾ï¼š

![img](./assets/w5ybXF4ycUeSLUvV.webp)

å¦‚æœè§‰å¾—å¤ªæ¨¡ç³Šäº†ï¼Œè¿˜å¯ä»¥å¢å¤§ç¼©ç•¥å›¾çš„å®½é«˜ã€è°ƒé«˜éœ€è¦ç”Ÿæˆç¼©ç•¥å›¾çš„æ–‡ä»¶å¤§å°é˜ˆå€¼ï¼Œè¿™æ˜¯ä¸€ä¸ªæˆæœ¬å’Œç”¨æˆ·ä½“éªŒä¸Šçš„æƒè¡¡~

#### æ‰©å±•

1ï¼‰é™¤äº†ç¼©ç•¥å›¾ä¹‹å¤–ï¼Œè¿˜å¯ä»¥æä¾›ç›¸å¯¹æ›´æ¸…æ™°çš„ **é¢„è§ˆå›¾**ï¼Œç”¨äºåœ¨å›¾ç‰‡è¯¦æƒ…é¡µå±•ç¤ºï¼Œä»…åœ¨ä¸‹è½½æ—¶æ‰ä½¿ç”¨æ— æŸåŸå›¾ã€‚

2ï¼‰å¯ä»¥å¯¹æ–‡ä»¶åç§°è¿›è¡Œæ›´å®Œæ•´åœ°æ ¡éªŒå¤„ç†ï¼Œé˜²æ­¢å› ä¸ºå›¾ç‰‡æœ¬èº«åç§°ä¸è§„èŒƒå¯¼è‡´çš„åç¼€ä¸¢å¤±ã€‚

### æ‡’åŠ è½½

æ‡’åŠ è½½ï¼ˆLazy Loadingï¼‰å¯ä»¥é¿å…ä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰å›¾ç‰‡ï¼Œ**åªæœ‰å½“èµ„æºéœ€è¦æ˜¾ç¤ºæ—¶æ‰è¿›è¡ŒåŠ è½½**ã€‚æ¯”å¦‚å¯¹äºå›¾ç‰‡åˆ—è¡¨æ¥è¯´ï¼Œä»…åœ¨ç”¨æˆ·æ»šåŠ¨åˆ°å›¾ç‰‡æ‰€åœ¨åŒºåŸŸæ—¶æ‰åŠ è½½è¯¥å›¾ç‰‡èµ„æºã€‚

#### å®ç°æ–¹æ¡ˆ

è™½ç„¶æ‡’åŠ è½½çš„å®ç°æ›´å¤šçš„æ˜¯ä¾èµ–å‰ç«¯ï¼Œä½†åç«¯ä¹Ÿæœ‰ä¸€å®šçš„ä¼˜åŒ–ç­–ç•¥ï¼Œæ¯”å¦‚å¯¹å›¾ç‰‡åˆ—è¡¨è¿›è¡Œåˆ†é¡µï¼Œæ¯é¡µä¸éœ€è¦å±•ç¤ºè¿‡å¤šçš„å†…å®¹ã€‚

å‰ç«¯å¦‚ä½•å®ç°æ‡’åŠ è½½å‘¢ï¼Ÿ

1ï¼‰ä½¿ç”¨ HTML5 åŸç”Ÿçš„ `loading="lazy"` å±æ€§ã€‚ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š

```java
<img src="image.jpg" alt="ç¤ºä¾‹å›¾ç‰‡" loading="lazy" />
```

è¿™ç§æ–¹æ³•æœ€ç®€å•ï¼Œä½†æ˜¯å¯¹æ—§ç‰ˆæµè§ˆå™¨ï¼ˆå¦‚ IEï¼‰ä¸å…¼å®¹ï¼Œè€Œä¸”ä¸æ”¯æŒæ›´å¤æ‚çš„æ‡’åŠ è½½éœ€æ±‚ï¼ˆå¦‚åŠ¨ç”»æˆ–ç‰¹æ®Šäº‹ä»¶è§¦å‘ï¼‰ã€‚

2ï¼‰ä½¿ç”¨ JS çš„ Intersection Observerï¼Œè¿™ä¸ª API èƒ½å¤Ÿæ£€æµ‹å…ƒç´ æ˜¯å¦è¿›å…¥è§†å£ï¼Œå‚è€ƒå®ç°å¦‚ä¸‹ï¼š

1. å°†å›¾ç‰‡çš„çœŸå® src æ›¿æ¢ä¸ºä¸€ä¸ªå ä½å±æ€§ï¼ˆå¦‚ data-srcï¼‰ã€‚
2. ä½¿ç”¨ Intersection Observer ç›‘å¬å›¾ç‰‡æ˜¯å¦è¿›å…¥è§†å£ã€‚
3. å½“å›¾ç‰‡è¿›å…¥è§†å£æ—¶ï¼Œå°† data-src çš„å€¼èµ‹ç»™ srcï¼Œè§¦å‘åŠ è½½ã€‚

```html
<img data-src="image.jpg" alt="ç¤ºä¾‹å›¾ç‰‡" class="lazy" />
<img data-src="image2.jpg" alt="ç¤ºä¾‹å›¾ç‰‡" class="lazy" />

<script>
  // è·å–æ‰€æœ‰éœ€è¦æ‡’åŠ è½½çš„å›¾ç‰‡
  const lazyImages = document.querySelectorAll('img.lazy');

  // åˆ›å»º Intersection Observer
  const observer = new IntersectionObserver((entries, observer) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        const img = entry.target;
        // å°† data-src çš„å€¼èµ‹ç»™ src å±æ€§
        img.src = img.dataset.src;
        img.classList.remove('lazy');
        observer.unobserve(img); // åœæ­¢è§‚å¯Ÿå·²åŠ è½½çš„å›¾ç‰‡
      }
    });
  });

  // è§‚å¯Ÿæ¯ä¸ªå›¾ç‰‡
  lazyImages.forEach(image => observer.observe(image));
</script>
```

3ï¼‰ä½¿ç”¨ JS ç›‘å¬é¡µé¢æ»šåŠ¨äº‹ä»¶å®ç°ã€‚æ¯æ¬¡é¡µé¢æ»šåŠ¨æ—¶ï¼Œåˆ¤æ–­å›¾ç‰‡æ˜¯å¦è¿›å…¥å¯è§†åŒºåŸŸï¼›å¦‚æœæ˜¯ï¼Œåˆ™ç»™å›¾ç‰‡å¢åŠ  src å±æ€§ï¼Œè§¦å‘å›¾ç‰‡åŠ è½½ã€‚

4ï¼‰ä½¿ç”¨ç°æˆçš„ç»„ä»¶åº“æˆ–ç±»åº“å®ç°ï¼Œæ¯”å¦‚ [lazysizes åº“](https://github.com/aFarkas/lazysizes)ã€‚

ç”±äºæˆ‘ä»¬çš„é¡¹ç›®å·²ç»ä½¿ç”¨äº†ç¼©ç•¥å›¾ï¼ŒåŠ è½½çš„èµ„æºæœ¬æ¥ä¹Ÿä¸å¤šï¼Œæ‰€ä»¥æš‚æ—¶æ²¡å¿…è¦ä½¿ç”¨æ‡’åŠ è½½äº†ã€‚

#### æ‰©å±•çŸ¥è¯† - æ¸è¿›å¼åŠ è½½

æ¸è¿›å¼åŠ è½½å’Œæ‡’åŠ è½½æŠ€æœ¯ç±»ä¼¼ï¼Œå…ˆåŠ è½½ä½åˆ†è¾¨ç‡æˆ–ä½è´¨é‡çš„å ä½èµ„æºï¼ˆå¦‚æ¨¡ç³Šçš„å›¾ç‰‡ç¼©ç•¥å›¾ï¼‰ï¼Œåœ¨ç”¨æˆ·è®¿é—®æˆ–ç­‰å¾…æœŸé—´é€æ­¥åŠ è½½é«˜åˆ†è¾¨ç‡çš„å®Œæ•´èµ„æºï¼ŒåŠ è½½å®Œæˆåå†æ›¿æ¢æ‰å ä½èµ„æºã€‚

é€‚ç”¨äºè¶…æ¸…å›¾ç‰‡åŠ è½½ã€ç”¨æˆ·ä½“éªŒè¦æ±‚è¾ƒé«˜çš„é¡µé¢ï¼Œåœ¨ç½‘ç»œç¯å¢ƒè¾ƒå·®æ—¶ï¼Œæ•ˆæœä¼šæ›´æ˜æ˜¾ã€‚

Ant Design Vue çš„ [Image å›¾ç‰‡ç»„ä»¶](https://antdv.com/components/image-cn) æ”¯æŒæ¸è¿›åŠ è½½åŠŸèƒ½ï¼š

![img](./assets/UnFTysP1LCGWQ02F.webp)

### CDN åŠ é€Ÿ

#### 1ã€ä»€ä¹ˆæ˜¯ CDNï¼Ÿ

CDNï¼ˆå†…å®¹åˆ†å‘ç½‘ç»œï¼‰æ˜¯é€šè¿‡å°†å›¾ç‰‡æ–‡ä»¶åˆ†å‘åˆ°å…¨çƒå„åœ°çš„èŠ‚ç‚¹ï¼Œç”¨æˆ·è®¿é—®æ—¶ä»ç¦»è‡ªå·±æœ€è¿‘çš„èŠ‚ç‚¹è·å–èµ„æºçš„æŠ€æœ¯ï¼Œå¸¸ç”¨äºæ–‡ä»¶èµ„æºæˆ–åç«¯åŠ¨æ€è¯·æ±‚çš„ç½‘ç»œåŠ é€Ÿï¼Œä¹Ÿèƒ½å¤§å¹…åˆ†æ‘Šæºç«™çš„å‹åŠ›ã€æ”¯æŒæ›´å¤šè¯·æ±‚åŒæ—¶è®¿é—®ï¼Œæ˜¯æ€§èƒ½æå‡çš„åˆ©å™¨ã€‚

![img](./assets/FDEIm91Zexcw5MhQ.webp)

è…¾è®¯äº‘ CDN äº§å“æ–‡æ¡£ä¸­æä¾›çš„ CDN åŸç†å›¾ï¼š

![img](./assets/OhMqUi79fp4zO8wo.webp)

ğŸ’¡ å¦‚æœä½ æƒ³äº†è§£ä¸€äº›äº‘æœåŠ¡çš„ä»‹ç»ã€æ¶æ„å’Œæœ€ä½³å®è·µï¼Œå¤šå»çœ‹å¤§å…¬å¸äº‘æœåŠ¡çš„äº§å“æ–‡æ¡£ï¼Œå°±èƒ½å­¦åˆ°å¾ˆå¤šçŸ¥è¯†ã€‚

CDN è¯·æ±‚çš„æ ¸å¿ƒè¿‡ç¨‹å¦‚ä¸‹ï¼š

1. å›¾ç‰‡æ–‡ä»¶ç”± **æºç«™**ï¼ˆå¦‚ COS å¯¹è±¡å­˜å‚¨ã€æˆ–è€…æœåŠ¡å™¨ï¼‰ä¸Šä¼ è‡³ CDN æœåŠ¡è¿›è¡Œç¼“å­˜ã€‚
2. å½“ç”¨æˆ·è¯·æ±‚å›¾ç‰‡æ—¶ï¼ŒCDN ä¼šæ ¹æ®ç”¨æˆ·çš„åœ°ç†ä½ç½®ï¼Œè¿”å›ç¦»ç”¨æˆ· **æœ€è¿‘çš„** CDN èŠ‚ç‚¹ç¼“å­˜çš„å›¾ç‰‡èµ„æºã€‚
3. æœªå‘½ä¸­ç¼“å­˜çš„å›¾ç‰‡å°†ä»æºç«™è·å–ï¼Œå¹¶ç¼“å­˜åœ¨ CDN èŠ‚ç‚¹ï¼Œä¾›åç»­ç”¨æˆ·è®¿é—®ï¼Œä¿—ç§° **å›æº**ã€‚

ğŸ’¡ å›æºçš„å…·ä½“è§£é‡Šï¼šåœ¨å†…å®¹åˆ†å‘ç½‘ç»œä¸­ï¼Œå›æºæ˜¯æŒ‡ç”¨æˆ·é€šè¿‡æµè§ˆå™¨å‘é€è¯·æ±‚æ—¶ï¼Œå“åº”è¯¥è¯·æ±‚çš„æ˜¯æºç«™ç‚¹çš„æœåŠ¡å™¨ï¼Œè€Œä¸æ˜¯å„èŠ‚ç‚¹ä¸Šçš„ç¼“å­˜æœåŠ¡å™¨ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå½“ CDN èŠ‚ç‚¹ä¸Šçš„ç¼“å­˜æœåŠ¡å™¨æ²¡æœ‰ç¼“å­˜å“åº”çš„å†…å®¹ï¼Œæˆ–è€…å“åº”çš„å†…å®¹åœ¨æºç«™ç‚¹æœåŠ¡å™¨ä¸Šè¢«ä¿®æ”¹ï¼Œå°±ä¼šå›æºç«™å»è·å–ã€‚

#### 2ã€CDN çš„ä¼˜åŠ¿

æœ‰åŒå­¦ä¼šé—®äº†ï¼šCOS å¯¹è±¡å­˜å‚¨ä¸ä¹Ÿæ˜¯å­˜å‚¨å›¾ç‰‡çš„æœåŠ¡ä¹ˆï¼ŸCDN å†…å®¹åˆ†å‘ç½‘ç»œæœ‰å•¥ç‹¬ç‰¹çš„ä¼˜åŠ¿å•Šï¼Ÿ

ä»è¿™ä¸¤ä¸ªæœåŠ¡çš„åç§°ä¸­ï¼Œæˆ‘ä»¬å°±èƒ½æ˜æ˜¾æ„Ÿå—åˆ°åŒºåˆ«äº†ï¼ŒCOS æ›´å€¾å‘äº â€œå­˜å‚¨â€ï¼ŒCDN æ›´å€¾å‘äº â€œç½‘ç»œè¯·æ±‚â€ã€‚

æ‰€ä»¥å¦‚æœæ–‡ä»¶å­˜å‚¨å®¹é‡è¾ƒå¤§ã€ä½†æ˜¯è®¿é—®é¢‘ç‡è¾ƒä½ï¼Œç”¨å¯¹è±¡å­˜å‚¨æ€§ä»·æ¯”æ›´é«˜ï¼›ä½†å¦‚æœèµ„æºè®¿é—®é¢‘ç‡é«˜ã€æµé‡æ¶ˆè€—å¤§ï¼Œè¿˜éœ€è¦å¯¹è®¿é—®è¿›è¡ŒåŠ é€Ÿã€å‡å°‘æºç«™å‹åŠ›ï¼Œå°±è¦ä½¿ç”¨ CDN äº†ã€‚CDN çš„æµé‡å’Œè¯·æ±‚å•ä»·é€šå¸¸ä½äºå¯¹è±¡å­˜å‚¨ï¼Œè€Œä¸”æ›´åŠ å®‰å…¨ï¼Œå¯ä»¥ä¿æŠ¤æºç«™åœ°å€ä¸è¢«æ³„éœ²ã€‚

#### 3ã€å¦‚ä½•ä½¿ç”¨ CDNï¼Ÿ

ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå¦‚æœä½ è¦å¯¹å¤–æä¾›æ–‡ä»¶ï¼ˆå›¾ç‰‡ï¼‰è®¿é—® / ä¸‹è½½æœåŠ¡ï¼Œå»ºè®®ç»“åˆ COS å’Œ CDNã€‚æ¯”å¦‚å¯¹äºæœ¬é¡¹ç›®ï¼ŒCOS ä½œä¸ºæºç«™ï¼Œè´Ÿè´£å­˜å‚¨å›¾ç‰‡æ–‡ä»¶ï¼›CDN è´Ÿè´£æä¾›æ–‡ä»¶è®¿é—®æœåŠ¡ï¼Œä»¥åŠç¼“å­˜ã€å®‰å…¨æ€§çš„è®¾ç½®ã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼Œä½¿ç”¨ CDN ä¹‹åï¼Œæˆ‘ä»¬æ•°æ®åº“ä¸­å­˜å‚¨çš„å›¾ç‰‡åœ°å€å°±ä¸å†æ˜¯ COS çš„åœ°å€ï¼Œè€Œæ˜¯ CDN çš„ URLã€‚

å¦‚ä½•å¼€é€šå’Œä½¿ç”¨ CDN æœåŠ¡ï¼Ÿå»ºè®®é˜…è¯» [å®˜æ–¹çš„äº§å“æ–‡æ¡£](https://cloud.tencent.com/document/product/228/3149)ã€è¿˜æœ‰ [CDN ç»“åˆ COS çš„æ–‡æ¡£](https://cloud.tencent.com/document/product/228/38088)ï¼Œå†™å¾—å¾ˆè´´å¿ƒã€‚

ğŸ’¡ CDN è¿˜æä¾›è‡ªåŠ¨å›¾ç‰‡ä¼˜åŒ–åŠŸèƒ½ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥ [çœ‹æ–‡æ¡£](https://cloud.tencent.com/document/product/228/43121) äº†è§£ä¸‹ã€‚

ä½†æ˜¯ï¼Œæ³¨æ„ CDN æ˜¯ä¸ªä»˜è´¹äº§å“ï¼ŒæŒ‰é‡è®¡è´¹ï¼Œæ‰€ä»¥ä½¿ç”¨æ—¶æœ‰ä¸€äº›æ³¨æ„äº‹é¡¹ã€‚ä¿—è¯è¯´å¾—å¥½ï¼ˆé±¼çš®è¯´çš„ï¼‰ï¼šâ€œä¹±ç”¨ CDNï¼Œé’±åŒ…ä¸¤è¡Œæ³ªï¼â€

å¤§å®¶ä¸€å®šè¦è®¤çœŸçœ‹ï¼š

1ï¼‰ç¼“å­˜ç­–ç•¥ï¼šä¸ºé™æ€èµ„æºï¼ˆå¦‚å›¾ç‰‡ã€CSSã€JSï¼‰è®¾ç½®é•¿æœŸç¼“å­˜æ—¶é—´ï¼Œå¯ä»¥å‡å°‘å›æºçš„æ¬¡æ•°å’Œæ¶ˆè€—ã€‚

2ï¼‰é˜²ç›—é“¾ï¼šé…ç½® Referer é˜²ç›—é“¾ä¿æŠ¤èµ„æºï¼Œæ¯”å¦‚ä»…å…è®¸è‡ªå·±çš„åŸŸåå¯ä»¥åŠ è½½å›¾ç‰‡

![img](./assets/O3wZcjuCXbJKMKvm.webp)

3ï¼‰IP é™åˆ¶ï¼šæ ¹æ®éœ€è¦é…ç½® IP é»‘ç™½åå•ï¼Œé™åˆ¶ä¸å¿…è¦çš„è®¿é—®ã€‚

![img](./assets/Wv6G8WLu4OgPz392.webp)

4ï¼‰HTTPS é…ç½®ï¼šé…ç½®æœ‰æ•ˆçš„ SSL è¯ä¹¦ï¼Œå¯ç”¨ HTTPS ä¼ è¾“ï¼Œæé«˜è¯·æ±‚çš„å®‰å…¨æ€§ã€‚

5ï¼‰**ç›‘æ§å‘Šè­¦ï¼šè¿™ç‚¹å°¤ä¸ºé‡è¦ï¼**ä¸€å®šè¦ç»™ CDN é…ç½®ç›‘æ§å‘Šè­¦ï¼Œæ¯”å¦‚è®¾ç½®ä¸€æ®µæ—¶é—´å†…æœ€å¤šæ¶ˆè€—çš„æµé‡ï¼Œè¶…å‡ºæ—¶ä¼šè‡ªåŠ¨å‘çŸ­ä¿¡å‘Šè­¦ï¼Œé¿å…è´¹ç”¨è¶…é¢ï¼›æˆ–è€…é™åˆ¶å•ä¸ª IP çš„è¯·æ±‚é¢‘ç‡ï¼Œé˜²æ­¢çªå‘æµé‡å½±å“æœåŠ¡ã€‚

![img](./assets/F6lRayECEMdsFdsd.webp)

6ï¼‰CDN èŠ‚ç‚¹é€‰æ‹©ï¼šå›½å†…ä¸šåŠ¡é€‰æ‹©è¦†ç›–ä¸­å›½å¤§é™†çš„èŠ‚ç‚¹å°±è¶³å¤Ÿäº†ï¼Œéå¿…è¦çš„è¯ï¼Œä¸è¦å¼€é€šå…¨çƒ CDN èŠ‚ç‚¹ï¼Œå®¹æ˜“é­å—æµ·å¤–æ”»å‡»ã€‚

7ï¼‰è®¿é—®æ—¥å¿—ï¼šå¼€å¯è®¿é—®æ—¥å¿—ï¼Œåˆ†æç”¨æˆ·è¡Œä¸ºå’Œæµé‡æ¥æºï¼Œè¿™ä¸ªèƒ½åŠ›æ›´é€‚åˆä¸šåŠ¡è®¿é—®é‡è¾ƒå¤§çš„åœºæ™¯ã€‚

### æµè§ˆå™¨ç¼“å­˜

é€šè¿‡è®¾ç½® HTTP å¤´ä¿¡æ¯ï¼ˆå¦‚ Cache-Controlï¼‰ï¼Œå¯ä»¥è®©ç”¨æˆ·çš„æµè§ˆå™¨å°†èµ„æºç¼“å­˜åœ¨æœ¬åœ°ã€‚åœ¨ç”¨æˆ·å†æ¬¡è®¿é—®åŒæ ·çš„èµ„æºæ—¶ï¼Œç›´æ¥ä»æœ¬åœ°ç¼“å­˜åŠ è½½èµ„æºï¼Œè€Œæ— éœ€å†æ¬¡è¯·æ±‚æœåŠ¡å™¨ã€‚

æ‰€æœ‰ç¼“å­˜åœ¨ä½¿ç”¨æ—¶çš„æ³¨æ„äº‹é¡¹åŸºæœ¬éƒ½æ˜¯ç±»ä¼¼çš„ï¼š

1ï¼‰è®¾ç½®åˆç†çš„ç¼“å­˜æ—¶é—´ã€‚å¸¸ç”¨çš„å‡ ç§è®¾ç½®å‚æ•°æ˜¯ï¼š

- é™æ€èµ„æºä½¿ç”¨é•¿æœŸç¼“å­˜ï¼Œæ¯”å¦‚ï¼š`Cache-Control: public, max-age=31536000` è¡¨ç¤ºç¼“å­˜ä¸€å¹´ï¼Œé€‚åˆå­˜å‚¨å›¾ç‰‡ç­‰é™æ€èµ„æºã€‚
- åŠ¨æ€å†…å®¹ä½¿ç”¨éªŒè¯ç¼“å­˜ï¼Œæ¯”å¦‚ï¼š`Cache-Control: private, no-cache` è¡¨ç¤ºç¼“å­˜å¯è¢«å®¢æˆ·ç«¯å­˜å‚¨ï¼Œä½†æ¯æ¬¡ä½¿ç”¨å‰éœ€è¦ä¸æœåŠ¡å™¨éªŒè¯æœ‰æ•ˆæ€§ã€‚é€‚åˆä¼šåŠ¨æ€å˜åŒ–å†…å®¹çš„é¡µé¢ï¼Œæ¯”å¦‚ç”¨æˆ·ä¸ªäººä¸­å¿ƒã€‚
- æ•æ„Ÿå†…å®¹ç¦ç”¨ç¼“å­˜ï¼Œæ¯”å¦‚ï¼š`Cache-Control: no-store` è¡¨ç¤ºä¸å…è®¸ä»»ä½•å½¢å¼çš„ç¼“å­˜ï¼Œé€‚åˆå®‰å…¨æ€§è¾ƒé«˜çš„åœºæ™¯ï¼Œæ¯”å¦‚ç™»å½•é¡µé¢ã€æ”¯ä»˜é¡µé¢ã€‚

2ï¼‰è¦èƒ½å¤ŸåŠæ—¶æ›´æ–°ç¼“å­˜ã€‚å¯ä»¥ç»™å›¾ç‰‡çš„åç§°æ·»åŠ  â€œç‰ˆæœ¬å·â€ï¼ˆå¦‚æ–‡ä»¶åä¸­åŒ…å« hash å€¼ï¼‰ï¼Œè¿™æ ·å“ªæ€•ä¸Šä¼ ç›¸åŒçš„å›¾ç‰‡ï¼Œç”±äºç‰ˆæœ¬å·ä¸åŒï¼Œå¾—åˆ°çš„å›¾ç‰‡åœ°å€ä¹Ÿä¸åŒï¼Œä¸‹æ¬¡è®¿é—®æ—¶å°±ä¼šé‡æ–°åŠ è½½ã€‚

å¯¹äºæˆ‘ä»¬çš„é¡¹ç›®ï¼Œå›¾ç‰‡èµ„æºæ˜¯éå¸¸é€‚åˆé•¿æœŸç¼“å­˜åœ¨æµè§ˆå™¨æœ¬åœ°çš„ï¼Œä¹Ÿå·²ç»é€šè¿‡ç»™æ–‡ä»¶åæ·»åŠ æ—¥æœŸå’Œéšæœºæ•°é˜²æ­¢äº†é‡å¤ã€‚ç”±äºå›¾ç‰‡æ˜¯ä»å¯¹è±¡å­˜å‚¨äº‘æœåŠ¡åŠ è½½çš„ï¼Œå¦‚æœéœ€è¦ä½¿ç”¨ç¼“å­˜ï¼Œå¯ä»¥æ¥å…¥ CDN æœåŠ¡ï¼Œç›´æ¥åœ¨äº‘æœåŠ¡çš„æ§åˆ¶å°é…ç½®ç¼“å­˜ï¼Œ[å‚è€ƒæ–‡æ¡£](https://cloud.tencent.com/document/product/228/50114)ã€‚

![img](./assets/4HnCuNdpEhyn1IOV.webp)

å¦‚æœè§¦å‘äº†æµè§ˆå™¨æœ¬åœ°ç¼“å­˜ï¼Œåœ¨ F12 æ§åˆ¶å°ä¸­èƒ½å¤Ÿçœ‹åˆ°å›¾ç‰‡ç¬é—´åŠ è½½æˆåŠŸï¼š

![img](./assets/ljGci9GSV4qHP4rR.webp)

## å››ã€å›¾ç‰‡å­˜å‚¨ä¼˜åŒ–

### æ•°æ®æ²‰é™

å¤§éƒ¨åˆ†æ•°æ®çš„è®¿é—®çƒ­åº¦ä¼šéšç€å­˜å‚¨æ—¶é—´å»¶é•¿é€æ¸é™ä½ï¼Œä¸ºäº†ä¸¥æ ¼æ§åˆ¶å­˜å‚¨æˆæœ¬ï¼Œéœ€è¦å®šæœŸåˆ†æä¸šåŠ¡æ•°æ®çš„è®¿é—®æƒ…å†µï¼Œå¹¶åŠ¨æ€è°ƒæ•´å­˜å‚¨ç±»å‹ã€‚

è¿™å°±æ¶‰åŠåˆ° **æ•°æ®æ²‰é™** æŠ€æœ¯ï¼Œå°†é•¿æ—¶é—´æœªè®¿é—®çš„æ•°æ®è‡ªåŠ¨è¿ç§»åˆ°ä½é¢‘è®¿é—®å­˜å‚¨ï¼Œä»è€Œé™ä½å­˜å‚¨æˆæœ¬ã€‚å°±è·Ÿæˆ‘ä»¬å¹³æ—¶ä½¿ç”¨ç”µè„‘ä¸€æ ·ï¼ŒSSD ç¡¬ç›˜å¾ˆè´µï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼˜å…ˆå°†å¸¸ç”¨è½¯ä»¶æ”¾åœ¨ SSD ç›®å½•ä¸­ï¼Œè‡³äºä¸€äº›ä»¥å‰å†™è¿‡çš„èµ„æ–™ä»€ä¹ˆçš„ï¼Œå¯ä»¥æ”¾åœ¨æœºæ¢°ç¡¬ç›˜æˆ–å¤–æ¥ç¡¬ç›˜ä¸­ã€‚

ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæ•°æ®æ²‰é™åˆ†ä¸º 2 ä¸ªé˜¶æ®µï¼šå…ˆåˆ†æå†æ²‰é™ã€‚

1ï¼‰å…ˆåˆ†æï¼šé€šè¿‡å¯¹è±¡å­˜å‚¨æä¾›çš„æ¸…å• / è®¿é—®æ—¥å¿—åˆ†æï¼Œæˆ–è€…ä¸šåŠ¡ä»£ç ä¸­è‡ªè¡Œç»Ÿè®¡åˆ†æã€‚

2ï¼‰å†æ²‰é™ï¼šå¯ä»¥ç›´æ¥é€šè¿‡å¯¹è±¡å­˜å‚¨æä¾›çš„ **ç”Ÿå‘½å‘¨æœŸ** åŠŸèƒ½è‡ªåŠ¨æ²‰é™æ•°æ®ï¼Œåªéœ€ç¼–å†™æ²‰é™è§„åˆ™å³å¯ã€‚å¦‚ä¸‹å›¾ï¼Œå°† 30 å¤©æœªä¿®æ”¹çš„æ–‡ä»¶æ²‰é™è‡³ä½é¢‘å­˜å‚¨ï¼š

![img](./assets/3xmJpnBWOdJp29zP.webp)

ä½é¢‘å­˜å‚¨çš„ä»·æ ¼æ¯”æ ‡å‡†å­˜å‚¨ä½äº†ä¸€äº›ï¼Œè¿˜å¯ä»¥å°† **å‡ ä¹ä¸éœ€è¦ä¿®æ”¹å’Œè®¿é—®** çš„æ–‡ä»¶ï¼ˆæ¯”å¦‚æ—¥å¿—æ–‡ä»¶ï¼‰ç§»åŠ¨åˆ°å½’æ¡£å­˜å‚¨ä¸­ï¼Œå­˜å‚¨ä»·æ ¼æ›´ä½ï¼Œå¯èŠ‚çº¦å‡ å€çš„æˆæœ¬ï¼

![img](./assets/JhJmyZB6YqpTTKgU.webp)

ä¸è¿‡è¦æ³¨æ„ï¼Œè™½ç„¶ä½é¢‘å­˜å‚¨çš„å­˜å‚¨è´¹ç”¨æ›´ä½ï¼Œä½†æ˜¯å½“ä½ è¦è®¿é—®ä½é¢‘å­˜å‚¨çš„èµ„æºæ—¶ï¼Œä¼šäº§ç”Ÿæ•°æ®å–å›è´¹ç”¨ï¼Œæ‰€ä»¥ä¸€èˆ¬åªå¯¹å‡ ä¹ä¸è®¿é—®çš„èµ„æºè¿›è¡Œæ²‰é™ï¼Œå°½é‡å‡å°‘å–å›è´¹ç”¨ã€‚

æ•°æ®æ²‰é™å’Œ **å†·çƒ­æ•°æ®åˆ†ç¦»** çš„æ¦‚å¿µæ˜¯æ¯”è¾ƒæ¥è¿‘çš„ï¼Œå†·çƒ­æ•°æ®åˆ†ç¦»æ˜¯æ ¹æ®æ•°æ®çš„è®¿é—®çƒ­åº¦ï¼Œå°†è®¿é—®é¢‘ç¹çš„æ•°æ®ï¼ˆçƒ­æ•°æ®ï¼‰å’Œè®¿é—®è¾ƒå°‘çš„æ•°æ®ï¼ˆå†·æ•°æ®ï¼‰å­˜å‚¨åœ¨ä¸åŒçš„å­˜å‚¨å±‚ä¸­ã€‚

å¯¹äºæˆ‘ä»¬çš„é¡¹ç›®ï¼Œå¾ˆä¹…æ— äººé—®æ´¥çš„å†å²å›¾ç‰‡å°±å¯ä»¥ç§°ä¸º â€œå†·æ•°æ®â€ï¼Œå¯ä»¥åˆ©ç”¨ COS çš„ç”Ÿå‘½å‘¨æœŸåŠŸèƒ½åœ¨ 30 å¤©åè‡ªåŠ¨æ²‰é™ä¸ºä½é¢‘å­˜å‚¨ã€‚å½“ç„¶ä¹Ÿå¯ä»¥é€šè¿‡æ•°æ®åº“è®°å½•å›¾ç‰‡çš„è®¿é—®å’Œä¸‹è½½æ—¶é—´ï¼Œè‡ªè¡Œè°ƒç”¨ API æ‰¹é‡æ²‰é™æ•°æ®æˆ–è€…è½¬å‚¨åˆ°å…¶ä»–å­˜å‚¨æœåŠ¡ã€‚

ğŸ’¡ æ•°æ®æ²‰é™å’Œå†·çƒ­æ•°æ®åˆ†ç¦»çš„æ¦‚å¿µåˆæœ‰ä¸€äº›ç»†å¾®çš„å·®åˆ«ï¼Œä¸ªäººçš„ç†è§£æ˜¯æ•°æ®æ²‰é™æ›´å€¾å‘äºå…³æ³¨ä¸€ä¸ªå¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸï¼ˆä¸€ä¸ªèµ„æºä»çƒ­åˆ°å†·ï¼‰ï¼Œç›®æ ‡æ›´å¤šçš„æ˜¯é™ä½å­˜å‚¨æˆæœ¬ï¼Œé…ç½®æ²‰é™è§„åˆ™åä¹Ÿä¸€èˆ¬ä¸ä¼šè°ƒæ•´ã€‚å†·çƒ­æ•°æ®åˆ†ç¦»æ›´å…³æ³¨æ•´ä¸ªç³»ç»Ÿçš„èµ„æºåˆ†å¸ƒï¼ˆæ¯”å¦‚çƒ­é—¨å›¾ç‰‡æ”¾åˆ°æ€§èƒ½æ›´é«˜çš„ç¡¬ç›˜ä¸­ï¼Œå†·é—¨å›¾ç‰‡è¿›è¡Œå½’æ¡£å­˜å‚¨ï¼‰ï¼Œç›®æ ‡æ˜¯åŒæ—¶ä¼˜åŒ–æ€§èƒ½å’ŒèŠ‚çº¦æˆæœ¬ï¼Œæ•°æ®çš„çƒ­åº¦å¯ä»¥å®æ—¶è°ƒæ•´ã€‚

### æ¸…ç†ç­–ç•¥

å¯¹äº â€œé‡å­˜å‚¨â€ çš„ç³»ç»Ÿï¼Œæ•°æ®æ¸…ç†æ˜¯å¿…è¦çš„ï¼é€šè¿‡è®¾ç½®åˆç†çš„æ¸…ç†ç­–ç•¥ï¼Œå¯ä»¥é¿å…å†—ä½™æ•°æ®å ç”¨å­˜å‚¨ç©ºé—´ï¼Œé™ä½æˆæœ¬ã€‚

è¿™é‡Œé±¼çš®åˆ†äº« 4 ç§å…¸å‹çš„æ¸…ç†ç­–ç•¥ï¼š

1ï¼‰ç«‹å³æ¸…ç†ï¼šåœ¨åˆ é™¤å›¾ç‰‡è®°å½•æ—¶ï¼Œç«‹å³å…³è”åˆ é™¤å¯¹è±¡å­˜å‚¨ä¸­å·²ä¸Šä¼ çš„å›¾ç‰‡æ–‡ä»¶ï¼Œç¡®ä¿æ•°æ®åº“è®°å½•ä¸å­˜å‚¨æ–‡ä»¶ä¿æŒä¸€è‡´ã€‚

è¿™é‡Œè¿˜æœ‰ä¸ªå°æŠ€å·§ï¼Œå¯ä»¥ä½¿ç”¨å¼‚æ­¥æ¸…ç†é™ä½å¯¹åˆ é™¤æ“ä½œæ€§èƒ½çš„å½±å“ï¼Œå¹¶ä¸”è®°å½•ä¸€äº›æ—¥å¿—ï¼Œé¿å…åˆ é™¤å¤±è´¥çš„æƒ…å†µã€‚

2ï¼‰æ‰‹åŠ¨æ¸…ç†ï¼šç”±ç®¡ç†å‘˜æ‰‹åŠ¨è§¦å‘æ¸…ç†ä»»åŠ¡ï¼Œå¯ä»¥ç­›é€‰è¦æ¸…ç†çš„æ•°æ®ï¼ŒæŒ‰éœ€é€‰æ‹©éœ€è¦æ¸…ç†çš„æ–‡ä»¶èŒƒå›´ã€‚

3ï¼‰å®šæœŸæ¸…ç†ï¼šé€šè¿‡å®šæ—¶ä»»åŠ¡è‡ªåŠ¨è§¦å‘æ¸…ç†æ“ä½œã€‚ç³»ç»Ÿé¢„å…ˆè®¾ç½®è§„åˆ™ï¼ˆå¦‚æ–‡ä»¶æœªè®¿é—®æ—¶é—´è¶…è¿‡ä¸€å®šæœŸé™ï¼‰è‡ªåŠ¨æ¸…ç†ä¸éœ€è¦çš„æ•°æ®ã€‚

4ï¼‰æƒ°æ€§æ¸…ç†ï¼šæ¸…ç†ä»»åŠ¡ä¸ä¼šä¸»åŠ¨æ‰§è¡Œï¼Œè€Œæ˜¯ç­‰åˆ°èµ„æºéœ€æ±‚å¢åŠ ï¼ˆå­˜å‚¨ç©ºé—´ä¸è¶³ï¼‰æˆ–è§¦å‘ç‰¹å®šæ“ä½œæ—¶æ‰æ¸…ç†ï¼Œé€‚åˆå­˜å‚¨ç©ºé—´ç´§å¼ ä½†æ¸…ç†ä»»åŠ¡ä¼˜å…ˆçº§è¾ƒä½çš„åœºæ™¯ã€‚

å®é™…å¼€å‘ä¸­ï¼Œä»¥ä¸Šå‡ ç§æ¸…ç†ç­–ç•¥å¯ä»¥ç»“åˆä½¿ç”¨ã€‚**æ¯”å¦‚ Redis çš„å†…å­˜ç®¡ç†æœºåˆ¶ç»“åˆäº†å®šæœŸæ¸…ç†å’Œæƒ°æ€§æ¸…ç†ç­–ç•¥ã€‚** å®šæœŸæ¸…ç†é€šè¿‡åå°å®šæœŸæ‰«æä¸€éƒ¨åˆ†é”®ï¼Œéšæœºæ£€æŸ¥å¹¶åˆ é™¤å·²è¿‡æœŸçš„é”®ï¼Œä»è€Œä¸»åŠ¨é‡Šæ”¾å†…å­˜ï¼Œå‡å°‘è¿‡æœŸé”®çš„å †ç§¯ã€‚æƒ°æ€§æ¸…ç†åˆ™æ˜¯åœ¨è®¿é—®æŸä¸ªé”®æ—¶ï¼Œæ£€æŸ¥å…¶æ˜¯å¦å·²è¿‡æœŸï¼Œå¦‚æœå·²è¿‡æœŸåˆ™ç«‹å³åˆ é™¤ã€‚è¿™ä¸¤ç§ç­–ç•¥äº’ä¸ºè¡¥å……ï¼šå®šæœŸæ¸…ç†é™ä½äº†è¿‡æœŸé”®çš„å ç”¨ç§¯ç´¯ï¼Œè€Œæƒ°æ€§æ¸…ç†ç¡®ä¿äº†è®¿é—®æ—¶é”®çš„å‡†ç¡®æ€§å’ŒåŠæ—¶æ¸…ç†ï¼Œä»è€Œåœ¨æ€§èƒ½å’Œå†…å­˜ä½¿ç”¨ä¹‹é—´å–å¾—å¹³è¡¡ã€‚

#### å®ç°æ–¹æ¡ˆ

å¯¹äºæˆ‘ä»¬çš„é¡¹ç›®ï¼Œç”±äºä¸åƒ Redis ä¸€æ ·å¯¹ç©ºé—´çš„é™åˆ¶é‚£ä¹ˆä¸¥æ ¼ï¼Œæ›´å¤šçš„æ˜¯ä¸ºäº†èŠ‚çº¦æˆæœ¬ï¼Œæ‰€ä»¥ä¸éœ€è¦æƒ°æ€§æ¸…ç†ç­–ç•¥ï¼ŒæŒ‰éœ€è¿ç”¨ â€œç«‹å³æ¸…ç† + æ‰‹åŠ¨æ¸…ç† + å®šæœŸæ¸…ç†â€ å³å¯ã€‚

#### åç«¯å¼€å‘

1ï¼‰CosManager è¡¥å……åˆ é™¤å¯¹è±¡çš„æ–¹æ³•ï¼š

```java
/**
 * åˆ é™¤å¯¹è±¡
 *
 * @param key æ–‡ä»¶ key
 */
public void deleteObject(String key) throws CosClientException {
    cosClient.deleteObject(cosClientConfig.getBucket(), key);
}
```

2ï¼‰åœ¨ PictureService ä¸­å¼€å‘å›¾ç‰‡æ¸…ç†æ–¹æ³•ã€‚

æ³¨æ„ï¼Œåˆ é™¤å›¾ç‰‡æ—¶ï¼Œéœ€è¦å…ˆåˆ¤æ–­è¯¥å›¾ç‰‡åœ°å€æ˜¯å¦è¿˜å­˜åœ¨äºå…¶ä»–è®°å½•é‡Œï¼Œç¡®è®¤æ²¡æœ‰æ‰èƒ½åˆ é™¤ã€‚æ¯”å¦‚ç§’ä¼ çš„åœºæ™¯ï¼Œå°±æœ‰å¯èƒ½å¤šä¸ªå›¾ç‰‡åœ°å€æŒ‡å‘åŒä¸€ä¸ªæ–‡ä»¶ã€‚

æ­¤å¤–ï¼Œè¿˜è¦æ³¨æ„åˆ é™¤å¯¹è±¡å­˜å‚¨ä¸­çš„æ–‡ä»¶æ—¶ä¼ å…¥çš„æ˜¯ keyï¼ˆä¸åŒ…å«åŸŸåçš„ç›¸å¯¹è·¯å¾„ï¼‰ï¼Œè€Œæ•°æ®åº“ä¸­å–åˆ°çš„å›¾ç‰‡åœ°å€æ˜¯åŒ…å«åŸŸåçš„ï¼Œæ‰€ä»¥åˆ é™¤å‰è¦ç§»é™¤åŸŸåï¼Œä»è€Œå¾—åˆ° keyã€‚è¿™æ®µé±¼çš®çš„è§†é¢‘æ•™ç¨‹ä¸­æ²¡æœ‰è®²ï¼Œå¤§å®¶å¯ä»¥è‡ªè¡Œå®ç°ã€‚

```java
@Async
@Override
public void clearPictureFile(Picture oldPicture) {
    // åˆ¤æ–­è¯¥å›¾ç‰‡æ˜¯å¦è¢«å¤šæ¡è®°å½•ä½¿ç”¨
    String pictureUrl = oldPicture.getUrl();
    long count = this.lambdaQuery()
            .eq(Picture::getUrl, pictureUrl)
            .count();
    // æœ‰ä¸æ­¢ä¸€æ¡è®°å½•ç”¨åˆ°äº†è¯¥å›¾ç‰‡ï¼Œä¸æ¸…ç†
    if (count > 1) {
        return;
    }
    // FIXME æ³¨æ„ï¼Œè¿™é‡Œçš„ url åŒ…å«äº†åŸŸåï¼Œå®é™…ä¸Šåªè¦ä¼  key å€¼ï¼ˆå­˜å‚¨è·¯å¾„ï¼‰å°±å¤Ÿäº†
    cosManager.deleteObject(oldPicture.getUrl());
    // æ¸…ç†ç¼©ç•¥å›¾
    String thumbnailUrl = oldPicture.getThumbnailUrl();
    if (StrUtil.isNotBlank(thumbnailUrl)) {
        cosManager.deleteObject(thumbnailUrl);
    }
}
```

ä¸Šè¿°ä»£ç ä¸­ï¼Œä½¿ç”¨äº† Spring çš„ `@Async` æ³¨è§£ï¼Œå¯ä»¥ä½¿å¾—æ–¹æ³•è¢«å¼‚æ­¥è°ƒç”¨ï¼Œè®°å¾—è¦åœ¨å¯åŠ¨ç±»ä¸Šæ·»åŠ  `@EnableAsync` æ³¨è§£æ‰ä¼šç”Ÿæ•ˆã€‚

```java
@SpringBootApplication
@EnableAsync
@MapperScan("com.yupi.yupicturebackend.mapper")
@EnableAspectJAutoProxy(exposeProxy = true)
public class YuPictureBackendApplication {
    public static void main(String[] args) {
        SpringApplication.run(YuPictureBackendApplication.class, args);
    }
}
```

ç„¶åä½ å¯ä»¥å°† clearPictureFile æ–¹æ³•è¿ç”¨åˆ°å›¾ç‰‡åˆ é™¤æ¥å£ç­‰åœºæ™¯ã€‚è¿™é‡Œé±¼çš®ç»™å¤§å®¶æŠ›ç –å¼•ç‰ï¼Œæ›´å¤šçš„æ¸…ç†ç­–ç•¥å¤§å®¶å¯ä»¥è‡ªè¡Œå®ç°ã€‚

#### æ‰©å±•

1ï¼‰è¡¥å……æ›´å¤šæ¸…ç†æ—¶æœºï¼šåœ¨é‡æ–°ä¸Šä¼ å›¾ç‰‡æ—¶ï¼Œè™½ç„¶é‚£æ¡å›¾ç‰‡è®°å½•ä¸ä¼šåˆ é™¤ï¼Œä½†å…¶å®ä¹‹å‰çš„å›¾ç‰‡æ–‡ä»¶å·²ç»ä½œåºŸäº†ï¼Œä¹Ÿå¯ä»¥è§¦å‘æ¸…ç†é€»è¾‘ã€‚

2ï¼‰å®ç°æ›´å¤šæ¸…ç†ç­–ç•¥ï¼šæ¯”å¦‚ç”¨ Spring Scheduler å®šæ—¶ä»»åŠ¡å®ç°å®šæ—¶æ¸…ç†ã€ç¼–å†™ä¸€ä¸ªæ¥å£ä¾›ç®¡ç†å‘˜æ‰‹åŠ¨æ¸…ç†ï¼Œä½œä¸ºä¸€ç§å…œåº•ç­–ç•¥ã€‚

3ï¼‰ä¼˜åŒ–æ¸…ç†æ–‡ä»¶çš„ä»£ç ï¼Œæ¯”å¦‚è¦åˆ é™¤å¤šä¸ªæ–‡ä»¶æ—¶ï¼Œä½¿ç”¨ [å¯¹è±¡å­˜å‚¨çš„æ‰¹é‡åˆ é™¤æ¥å£](https://cloud.tencent.com/document/product/436/65939#841fe310-bdf8-4789-9bc0-26ea844e316d) ä»£æ›¿ for å¾ªç¯è°ƒç”¨ã€‚

4ï¼‰ä¸ºäº†æ¸…ç†åŸå›¾ï¼Œå¯ä»¥åœ¨æ•°æ®åº“ä¸­ä¿å­˜åŸå›¾çš„åœ°å€ã€‚

------

è‡³æ­¤ï¼Œé±¼çš®æ™ºèƒ½ååŒäº‘å›¾åº“é¡¹ç›®çš„ç¬¬ä¸€é˜¶æ®µå·²ç»å¼€å‘ä¼˜åŒ–å®Œæˆï¼Œå¤§å®¶å·²ç»å¯ä»¥å°†è¿™ä¸ªé¡¹ç›®éƒ¨ç½²ä¸Šçº¿å¹¶å†™åˆ°ç®€å†ä¸Šå•¦~ ä»ä¸‹ä¸€æœŸæ•™ç¨‹å¼€å§‹ï¼Œæˆ‘ä»¬å°†ç»§ç»­å‡çº§å¹³å°çš„èƒ½åŠ›ï¼Œè®©å®ƒèƒ½å¤Ÿæ»¡è¶³æ›´å¤šä½¿ç”¨éœ€æ±‚ã€‚

## äº”ã€å…¶ä»–

åœ¨è¿›å…¥ä¸‹æœŸæ•™ç¨‹å‰ï¼Œå¤§å®¶å¯ä»¥è¿ç”¨è‡ªå·±å­¦è¿‡çš„çŸ¥è¯†ï¼Œå¯¹é¡¹ç›®è‡ªè¡Œåšä¸€æ³¢ä¼˜åŒ–ã€‚

æ¯”å¦‚ä¹‹å‰æˆ‘ä»¬æ¯æ¬¡é‡å¯æœåŠ¡å™¨éƒ½è¦é‡æ–°ç™»é™†ï¼Œæ—¢ç„¶å·²ç»æ•´åˆäº† Redisï¼Œä¸å¦¨ä½¿ç”¨ Redis ç®¡ç† Sessionï¼Œæ›´å¥½åœ°ç»´æŠ¤ç™»å½•æ€ã€‚

### Redis åˆ†å¸ƒå¼ Session

æ“ä½œæ–¹å¼ä¹Ÿå¾ˆç®€å•ï¼Œ1 åˆ†é’Ÿå°±èƒ½å®Œæˆã€‚

1ï¼‰å…ˆåœ¨ Maven ä¸­å¼•å…¥ spring-session-data-redis åº“ï¼š

```xml
<!-- Spring Session + Redis -->
<dependency>
    <groupId>org.springframework.session</groupId>
    <artifactId>spring-session-data-redis</artifactId>
</dependency>
```

2ï¼‰ä¿®æ”¹ application.yml é…ç½®æ–‡ä»¶ï¼Œæ›´æ”¹ Session çš„å­˜å‚¨æ–¹å¼å’Œè¿‡æœŸæ—¶é—´ï¼š

```yaml
spring: 
  # session é…ç½®
  session:
    store-type: redis
    # session 30 å¤©è¿‡æœŸ
    timeout: 2592000
server:
  port: 8123
  servlet:
    context-path: /api
    # cookie 30 å¤©è¿‡æœŸ
    session:
      cookie:
        max-age: 2592000
```

è¿™å°±æå®šäº†ï¼Œå¯ä»¥æµ‹è¯•ä¸‹é‡å¯æœåŠ¡å™¨åæ˜¯å¦è¿˜éœ€è¦é‡æ–°ç™»é™†ï¼Œå¹¶ä¸”æŸ¥çœ‹ Redis ä¸­æ˜¯å¦æœ‰ç™»å½•ç›¸å…³çš„ keyã€‚

![img](./assets/KhXOrZbydXn6Zfwu.webp)







# 7 - ç©ºé—´æ¨¡å—

## æœ¬èŠ‚é‡ç‚¹

ä¹‹å‰æˆ‘ä»¬å·²ç»å®Œæˆäº†å…¬å…±å›¾åº“çš„å¼€å‘ï¼Œä¸ºäº†è¿›ä¸€æ­¥å¢åŠ ç³»ç»Ÿçš„åº”ç”¨ä»·å€¼ï¼Œå¯ä»¥è®©æ¯ä¸ªç”¨æˆ·éƒ½èƒ½åˆ›å»ºè‡ªå·±çš„ç§æœ‰ç©ºé—´ï¼Œæ‰“é€ è‡ªå·±çš„å›¾ç‰‡äº‘ç›˜ã€ä¸ªäººç›¸å†Œã€‚

å¤§çº²ï¼š

- ç©ºé—´æ¨¡å—éœ€æ±‚åˆ†æ
- ç©ºé—´æ¨¡å—æ–¹æ¡ˆè®¾è®¡
- ç©ºé—´æ¨¡å—åç«¯å¼€å‘
- ç©ºé—´æ¨¡å—å‰ç«¯å¼€å‘

æœ¬èŠ‚æ•™ç¨‹ä¸æ¶‰åŠæ–°æŠ€æœ¯ï¼Œé‡ç‚¹å­¦ä¹ ä¸šåŠ¡ç»éªŒå’Œæ‰©å±•ç³»ç»Ÿçš„å¼€å‘æŠ€å·§ï¼Œèƒ½å¤Ÿè®©å¤§å®¶å­¦ä¼šæ›´å¿«æ›´ç¨³åœ°ç»™ç³»ç»Ÿå¢åŠ æ–°çš„åŠŸèƒ½ã€‚

## ä¸€ã€éœ€æ±‚åˆ†æ

å¯¹äºç©ºé—´æ¨¡å—ï¼Œé€šå¸¸è¦æœ‰è¿™äº›åŠŸèƒ½ï¼š

- ã€ç®¡ç†å‘˜ã€‘ç®¡ç†ç©ºé—´
- ç”¨æˆ·åˆ›å»ºç§æœ‰ç©ºé—´
- ç§æœ‰ç©ºé—´æƒé™æ§åˆ¶
- ç©ºé—´çº§åˆ«å’Œé™é¢æ§åˆ¶

çœ‹èµ·æ¥ç®€å•ï¼Œä½†å…¶å®æ¯ä¸ªéœ€æ±‚çš„ç»†èŠ‚éƒ½éå¸¸å¤šï¼Œå…·ä½“åˆ†ææ¯ä¸ªéœ€æ±‚ï¼š

1ï¼‰ç®¡ç†ç©ºé—´ï¼šä»…ç®¡ç†å‘˜å¯ç”¨ï¼Œå¯ä»¥å¯¹æ•´ä¸ªç³»ç»Ÿä¸­çš„ç©ºé—´è¿›è¡Œç®¡ç†ï¼Œæ¯”å¦‚æœç´¢ç©ºé—´ã€ç¼–è¾‘ç©ºé—´ã€åˆ é™¤ç©ºé—´ã€‚

2ï¼‰ç”¨æˆ·åˆ›å»ºç§æœ‰ç©ºé—´ï¼šç”¨æˆ·å¯ä»¥åˆ›å»º **æœ€å¤šä¸€ä¸ª** ç§æœ‰ç©ºé—´ï¼Œå¹¶ä¸”åœ¨ç§æœ‰ç©ºé—´å†…è‡ªç”±ä¸Šä¼ å’Œç®¡ç†å›¾ç‰‡ã€‚

3ï¼‰ç§æœ‰ç©ºé—´æƒé™æ§åˆ¶ï¼šç”¨æˆ·ä»…èƒ½è®¿é—®å’Œç®¡ç†è‡ªå·±çš„ç§æœ‰ç©ºé—´å’Œå…¶ä¸­çš„å›¾ç‰‡ï¼Œç§æœ‰ç©ºé—´çš„å›¾ç‰‡ä¸ä¼šå±•ç¤ºåœ¨å…¬å…±å›¾åº“ï¼Œä¹Ÿä¸éœ€è¦ç®¡ç†å‘˜å®¡æ ¸ã€‚

4ï¼‰ç©ºé—´çº§åˆ«å’Œé™é¢æ§åˆ¶ï¼šæ¯ä¸ªç©ºé—´æœ‰ä¸åŒçš„çº§åˆ«ï¼ˆå¦‚æ™®é€šç‰ˆå’Œä¸“ä¸šç‰ˆï¼‰ï¼Œå¯¹åº”äº†ä¸åŒçš„å®¹é‡å’Œå›¾ç‰‡æ•°é‡é™åˆ¶ï¼Œå¦‚æœè¶…å‡ºé™åˆ¶åˆ™æ— æ³•ç»§ç»­ä¸Šä¼ å›¾ç‰‡ã€‚

## äºŒã€æ–¹æ¡ˆè®¾è®¡

ä»éœ€æ±‚åˆ†æä¸­ï¼Œæˆ‘ä»¬ä¹Ÿèƒ½æ„Ÿå—åˆ°ï¼Œç»†èŠ‚æ¯”è¾ƒå¤šï¼Œä¸ºäº†æ›´å¥½åœ°æŠŠæ§è¿™äº›ç»†èŠ‚ï¼Œéœ€è¦å…ˆå¯¹ç³»ç»Ÿè¿›è¡Œä¸€ä¸ªæ•´ä½“çš„æ–¹æ¡ˆè®¾è®¡ã€‚

æ€è€ƒä¸‹é¢çš„é—®é¢˜ï¼š

1. ä¸ºä»€ä¹ˆè¦æœ‰ â€œç©ºé—´â€ çš„æ¦‚å¿µï¼Ÿ
2. å¦‚ä½•å¯¹ç©ºé—´è¿›è¡Œåº“è¡¨è®¾è®¡ï¼Ÿ
3. å…¬å…±å›¾åº“å’Œç©ºé—´çš„å…³ç³»ï¼Ÿ

### ç©ºé—´çš„å¿…è¦æ€§

å¦‚æœæ²¡æœ‰ â€œç©ºé—´â€ çš„æ¦‚å¿µï¼Œæ€ä¹ˆå®ç°è®©ç”¨æˆ·è‡ªç”±ç®¡ç†è‡ªå·±çš„ç§æœ‰å›¾ç‰‡å‘¢ï¼Ÿ

Qï¼šè¿™ä¸å°±ç›¸å½“äº â€œæŸ¥çœ‹æˆ‘çš„å›¾ç‰‡â€ åŠŸèƒ½å˜›ï¼Œç›´æ¥æ”¯æŒç”¨æˆ·æŸ¥è¯¢è‡ªå·±åˆ›å»ºè¿‡çš„å›¾ç‰‡ä¸å°±å¯ä»¥äº†ï¼Ÿ

Aï¼šå¦‚æœè¿™æ ·åšï¼Œä¼šå­˜åœ¨ä¸€ä¸ªå¾ˆå¤§çš„é—®é¢˜ï¼šç”¨æˆ·ç§æœ‰å›¾ç‰‡æ˜¯ **éœ€è¦éšç§** çš„ï¼Œä¸éœ€è¦è¢«ç®¡ç†å‘˜å®¡æ ¸ï¼Œä¹Ÿä¸èƒ½è¢«å…¶ä»–äººå…¬å¼€æŸ¥çœ‹ã€‚è¿™å’Œç°åœ¨çš„å…¬å…±å›¾åº“å¹³å°çš„é€»è¾‘ä¸ä¸€è‡´ã€‚

æƒ³è±¡ä¸€ä¸‹ï¼Œå›¾ç‰‡è¡¨ä¸­åªæœ‰ userId å­—æ®µï¼Œæ— æ³•åŒºåˆ†å›¾ç‰‡åˆ°åº•æ˜¯ç§æœ‰çš„è¿˜æ˜¯å…¬å¼€çš„ã€‚

Qï¼šé‚£å¦‚æœå…è®¸ç”¨æˆ·ä¸Šä¼ ç§æœ‰å›¾ç‰‡å‘¢ï¼Ÿæ¯”å¦‚è®¾ç½®å›¾ç‰‡å¯è§èŒƒå›´ä¸º â€œä»…è‡ªå·±å¯è§â€ï¼Ÿ

Aï¼šè¿™çš„ç¡®æ˜¯å¯è¡Œçš„ï¼Œå¯¹äºå†…å®¹å ç”¨å­˜å‚¨ç©ºé—´ä¸å¤§çš„å¹³å°ï¼Œå¾ˆé€‚åˆé‡‡ç”¨è¿™ç§æ–¹æ¡ˆï¼Œåƒæˆ‘ä»¬çš„ [ä»£ç å°æŠ„](https://www.codecopy.cn/) å°±æ”¯æŒä¸Šä¼ ä»…è‡ªå·±å¯è§çš„ä»£ç ã€‚ä½†æ˜¯ï¼Œå¯¹äºå›¾åº“å¹³å°ï¼Œå›¾ç‰‡å ç”¨çš„å­˜å‚¨ç©ºé—´ä¼šç›´æ¥äº§ç”Ÿå­˜å‚¨è´¹ç”¨ï¼Œå› æ­¤éœ€è¦å¯¹ç”¨æˆ·ä¸Šä¼ çš„å›¾ç‰‡å¤§å°å’Œæ•°é‡è¿›è¡Œé™åˆ¶ã€‚ç±»ä¼¼äºç»™ä½ åˆ†é…äº†ä¸€ä¸ªç”µè„‘ç¡¬ç›˜ï¼Œå®ƒå°±æ˜¯ä½ çš„ï¼Œç”¨æ»¡äº†å°±ä¸èƒ½å†ä¼ å›¾äº†ã€‚æ‰€ä»¥ä½¿ç”¨ â€œç©ºé—´â€ çš„æ¦‚å¿µä¼šæ›´ç¬¦åˆè¿™ç§åº”ç”¨åœºæ™¯ï¼Œå¯ä»¥é’ˆå¯¹ç©ºé—´è¿›è¡Œé™åˆ¶å’Œåˆ†æï¼Œä¹Ÿæ›´ä¾¿äºç®¡ç†ã€‚

æ­¤å¤–ï¼Œä»é¡¹ç›®å¯æ‰©å±•æ€§çš„è§’åº¦æ¥è®²ï¼ŒæŠ½è±¡ â€œç©ºé—´â€ çš„æ¦‚å¿µè¿˜æœ‰ 2 ä¸ªä¼˜åŠ¿ï¼š

1. å’Œä¹‹å‰çš„å…¬å…±å›¾åº“å®Œå…¨åˆ†å¼€ï¼Œå°½é‡åªé¢å¤–å¢åŠ ç©ºé—´ç›¸å…³çš„é€»è¾‘å’Œä»£ç ï¼Œå‡å°‘å¯¹ä»£ç çš„ä¿®æ”¹ã€‚
2. ä»¥åæˆ‘ä»¬è¦å¼€å‘å›¢é˜Ÿå…±äº«ç©ºé—´ï¼Œéœ€è¦å¯¹ç©ºé—´è¿›è¡Œæˆå‘˜ç®¡ç†ï¼Œä¹Ÿæ˜¯éœ€è¦ â€œç©ºé—´â€ æ¦‚å¿µçš„ã€‚æ‰€ä»¥ç›®å‰è®¾è®¡çš„ç©ºé—´è¡¨ï¼Œè¦èƒ½å¤Ÿå…¼å®¹ä¹‹åçš„å…±äº«ç©ºé—´ï¼Œä¾¿äºåç»­æ‰©å±•ã€‚

ğŸ’¡ è¿™å°±æ˜¯ä¸€ç§å¯æ‰©å±•æ€§çš„è®¾è®¡ï¼Œå½“ä½ å‘ç°ç³»ç»Ÿé€»è¾‘è¾ƒä¸ºå¤æ‚æˆ–äº§ç”Ÿå†²çªæ—¶ï¼Œå°±æŠ½è±¡ä¸€ä¸ªä¸­é—´å±‚ï¼ˆä¹Ÿå°±æ˜¯ â€œç©ºé—´â€ï¼‰ï¼Œä½¿å¾—æ–°è€é€»è¾‘åˆ†ç¦»ï¼Œè®©é¡¹ç›®æ›´æ˜“äºç»´æŠ¤å’Œæ‰©å±•ã€‚

### ç©ºé—´åº“è¡¨è®¾è®¡

#### 1ã€ç©ºé—´è¡¨

è¡¨åï¼šspaceï¼ˆç©ºé—´è¡¨ï¼‰

æ ¹æ®éœ€æ±‚å¯ä»¥åšå‡ºå¦‚ä¸‹ SQL è®¾è®¡ï¼š

```sql
-- ç©ºé—´è¡¨
create table if not exists space
(
    id         bigint auto_increment comment 'id' primary key,
    spaceName  varchar(128)                       null comment 'ç©ºé—´åç§°',
    spaceLevel int      default 0                 null comment 'ç©ºé—´çº§åˆ«ï¼š0-æ™®é€šç‰ˆ 1-ä¸“ä¸šç‰ˆ 2-æ——èˆ°ç‰ˆ',
    maxSize    bigint   default 0                 null comment 'ç©ºé—´å›¾ç‰‡çš„æœ€å¤§æ€»å¤§å°',
    maxCount   bigint   default 0                 null comment 'ç©ºé—´å›¾ç‰‡çš„æœ€å¤§æ•°é‡',
    totalSize  bigint   default 0                 null comment 'å½“å‰ç©ºé—´ä¸‹å›¾ç‰‡çš„æ€»å¤§å°',
    totalCount bigint   default 0                 null comment 'å½“å‰ç©ºé—´ä¸‹çš„å›¾ç‰‡æ•°é‡',
    userId     bigint                             not null comment 'åˆ›å»ºç”¨æˆ· id',
    createTime datetime default CURRENT_TIMESTAMP not null comment 'åˆ›å»ºæ—¶é—´',
    editTime   datetime default CURRENT_TIMESTAMP not null comment 'ç¼–è¾‘æ—¶é—´',
    updateTime datetime default CURRENT_TIMESTAMP not null on update CURRENT_TIMESTAMP comment 'æ›´æ–°æ—¶é—´',
    isDelete   tinyint  default 0                 not null comment 'æ˜¯å¦åˆ é™¤',
    -- ç´¢å¼•è®¾è®¡
    index idx_userId (userId),        -- æå‡åŸºäºç”¨æˆ·çš„æŸ¥è¯¢æ•ˆç‡
    index idx_spaceName (spaceName),  -- æå‡åŸºäºç©ºé—´åç§°çš„æŸ¥è¯¢æ•ˆç‡
    index idx_spaceLevel (spaceLevel) -- æå‡æŒ‰ç©ºé—´çº§åˆ«æŸ¥è¯¢çš„æ•ˆç‡
) comment 'ç©ºé—´' collate = utf8mb4_unicode_ci;
```

å‡ ä¸ªè®¾è®¡è¦ç‚¹ï¼š

1. ç©ºé—´çº§åˆ«å­—æ®µï¼šç©ºé—´çº§åˆ«åŒ…æ‹¬æ™®é€šç‰ˆã€ä¸“ä¸šç‰ˆå’Œæ——èˆ°ç‰ˆï¼Œæ˜¯å¯æšä¸¾çš„ï¼Œå› æ­¤ä½¿ç”¨æ•´å‹æ¥èŠ‚çº¦ç©ºé—´ã€æé«˜æŸ¥è¯¢æ•ˆç‡ã€‚
2. ç©ºé—´é™é¢å­—æ®µï¼šé™¤äº†çº§åˆ«å­—æ®µå¤–ï¼Œå¢åŠ  `maxSize` å’Œ `maxCount` å­—æ®µç”¨äºé™åˆ¶ç©ºé—´çš„å›¾ç‰‡æ€»å¤§å°ä¸æ•°é‡ï¼Œè€Œä¸æ˜¯åœ¨ä»£ç ä¸­æ ¹æ®çº§åˆ«è¯»å–é™é¢ã€‚è¿™æ ·ç®¡ç†å‘˜å¯ä»¥å•ç‹¬è®¾ç½®é™é¢ï¼Œä¸ç”¨å®Œå…¨å’Œçº§åˆ«ç»‘å®šï¼Œåˆ©äºæ‰©å±•ï¼›è€Œä¸”æŸ¥è¯¢é™é¢æ—¶ä¹Ÿæ›´æ–¹ä¾¿ã€‚
3. ç´¢å¼•è®¾è®¡ï¼šä¸ºé«˜é¢‘æŸ¥è¯¢çš„å­—æ®µï¼ˆå¦‚ç©ºé—´åç§°ã€ç©ºé—´çº§åˆ«ã€ç”¨æˆ· idï¼‰æ·»åŠ ç´¢å¼•ï¼Œæé«˜æŸ¥è¯¢æ•ˆç‡ã€‚

#### 2ã€å›¾ç‰‡è¡¨

ç”±äºä¸€å¼ å›¾ç‰‡åªèƒ½å±äºä¸€ä¸ªç©ºé—´ï¼Œå¯ä»¥åœ¨å›¾ç‰‡è¡¨ picture ä¸­æ–°å¢å­—æ®µ spaceIdï¼Œå®ç°å›¾ç‰‡ä¸ç©ºé—´çš„å…³è”ï¼ŒåŒæ—¶å¢åŠ ç´¢å¼•ä»¥æé«˜æŸ¥è¯¢æ€§èƒ½ã€‚

SQL å¦‚ä¸‹ï¼š

```sql
-- æ·»åŠ æ–°åˆ—
ALTER TABLE picture
    ADD COLUMN spaceId  bigint  null comment 'ç©ºé—´ idï¼ˆä¸ºç©ºè¡¨ç¤ºå…¬å…±ç©ºé—´ï¼‰';

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_spaceId ON picture (spaceId);
```

é»˜è®¤æƒ…å†µä¸‹ï¼ŒspaceId ä¸ºç©ºï¼Œè¡¨ç¤ºå›¾ç‰‡ä¸Šä¼ åˆ°äº†å…¬å…±å›¾åº“ã€‚

### å…¬å…±å›¾åº“å’Œç©ºé—´çš„å…³ç³»

æœ‰åŒå­¦å¯èƒ½ä¼šè¿™ä¹ˆæƒ³ï¼šå…¬å…±å›¾åº“ä¸å°±æ˜¯ç³»ç»Ÿç®¡ç†å‘˜åˆ›å»ºçš„ä¸€ä¸ªç©ºé—´ä¹ˆï¼Ÿæ—¢ç„¶æœ‰äº†ç©ºé—´è¡¨ï¼Œè¦ä¸è¦æŠŠå…¬å…±å›¾åº“ä¹Ÿå½“åšä¸€ä¸ªé»˜è®¤çš„ç©ºé—´æ¥è®¾è®¡å‘¢ï¼Ÿæˆ–è€…åœ¨ç©ºé—´è¡¨åˆ›å»ºä¸€æ¡å…¬å…±å›¾åº“çš„è®°å½•ï¼Ÿ

æœ‰è¿™ä¸ªæƒ³æ³•æ˜¯å¥½çš„ï¼Œä½†æ­¤å¤„ä¸ºäº†ç¡®ä¿å…¬å…±å›¾åº“ä¸ç§æœ‰ç©ºé—´çš„ç‹¬ç«‹æ€§ï¼Œå¿…é¡»è¿›è¡Œå•ç‹¬çš„è®¾è®¡ï¼Œå¹¶é¿å…å°†ä¸¤è€…æ··åˆã€‚åŸå› å¦‚ä¸‹ï¼š

1ï¼‰å…¬å…±å›¾åº“çš„è®¿é—®æƒé™ä¸ç§æœ‰ç©ºé—´ä¸åŒ

- å…¬å…±å›¾åº“ä¸­çš„å›¾ç‰‡æ— éœ€ç™»å½•å°±èƒ½æŸ¥çœ‹ï¼Œä»»ä½•äººéƒ½å¯ä»¥è®¿é—®ï¼Œä¸éœ€è¦è¿›è¡Œç”¨æˆ·è®¤è¯æˆ–æˆå‘˜ç®¡ç†ã€‚
- ç§æœ‰ç©ºé—´åˆ™è¦æ±‚ç”¨æˆ·ç™»å½•ï¼Œä¸”è®¿é—®æƒé™ä¸¥æ ¼æ§åˆ¶ï¼Œé€šå¸¸åªæœ‰ç©ºé—´ç®¡ç†å‘˜ï¼ˆæˆ–å›¢é˜Ÿæˆå‘˜ï¼‰æ‰èƒ½æŸ¥çœ‹æˆ–ä¿®æ”¹ç©ºé—´å†…å®¹ã€‚

2ï¼‰å…¬å…±å›¾åº“æ²¡æœ‰é¢åº¦é™åˆ¶ï¼šç§æœ‰ç©ºé—´ä¼šæœ‰å›¾ç‰‡å¤§å°ã€æ•°é‡ç­‰æ–¹é¢çš„é™åˆ¶ï¼Œä»è€Œç®¡ç†ç”¨æˆ·çš„å­˜å‚¨èµ„æºå’Œç©ºé—´é…é¢ï¼›è€Œå…¬å…±å›¾åº“å®Œå…¨ä¸å—è¿™äº›é™åˆ¶ã€‚

å…¬å…±å›¾åº“å’Œç§æœ‰ç©ºé—´åœ¨æ•°æ®ç»“æ„ã€å›¾ç‰‡å­˜å‚¨ã€æƒé™æ§åˆ¶ã€é¢åº¦ç®¡ç†ç­‰æ–¹é¢å­˜åœ¨æœ¬è´¨åŒºåˆ«ï¼Œå¦‚æœæ··åˆè®¾è®¡ï¼Œä¼šå¢åŠ ç³»ç»Ÿçš„å¤æ‚åº¦å¹¶å½±å“ç»´æŠ¤ä¸æ‰©å±•æ€§ã€‚ä¸¾ä¸ªä¾‹å­ï¼šå…¬å…±å›¾åº“åº”è¯¥ä¸Šä¼ åˆ°å¯¹è±¡å­˜å‚¨çš„ public ç›®å½•ï¼Œè¯¥ç›®å½•é‡Œçš„æ–‡ä»¶å¯ä»¥å…¬å¼€è®¿é—®ï¼›ä½†ç§æœ‰å›¾ç‰‡åº”è¯¥ä¸Šä¼ åˆ°å•ç‹¬çš„ space ç›®å½•ï¼Œè¯¥ç›®å½•é‡Œçš„æ–‡ä»¶å¯ä»¥è¿›ä¸€æ­¥è®¾ç½®è®¿é—®æƒé™ã€‚

å› æ­¤é±¼çš®ä¼šä½¿ç”¨ â€œå…¬å…±å›¾åº“â€ è€Œä¸æ˜¯ â€œå…¬å…±ç©ºé—´â€ æ¥è¡¨è¿°ï¼Œä¹Ÿèƒ½è®©æˆ‘ä»¬æ•´ä¸ªé¡¹ç›®å„ä¸ªé˜¶æ®µçš„è®¾è®¡æ›´åŠ ç‹¬ç«‹ã€‚

------

ç”±äºç»†èŠ‚è¾ƒå¤šï¼Œå…³äºå…·ä½“åŠŸèƒ½çš„å®ç°æ–¹æ¡ˆä¼šåœ¨å¼€å‘å…·ä½“åŠŸèƒ½å‰è¿›è¡Œè®²è§£ï¼Œä¾¿äºå¯¹ç…§æ–¹æ¡ˆè¿›è¡Œå¼€å‘ã€‚

## ä¸‰ã€åç«¯å¼€å‘

### ç©ºé—´ç®¡ç†

å…ˆä»ç›¸å¯¹ç®€å•çš„ç®¡ç†èƒ½åŠ›ï¼ˆå¢åˆ æ”¹æŸ¥ï¼‰å¼€å§‹å¼€å‘ã€‚

#### 1ã€æ•°æ®æ¨¡å‹

1ï¼‰é¦–å…ˆåˆ©ç”¨ MyBatisX æ’ä»¶ç”Ÿæˆç©ºé—´è¡¨ç›¸å…³çš„åŸºç¡€ä»£ç ï¼ŒåŒ…æ‹¬å®ä½“ç±»ã€Mapperã€Serviceã€‚

ç”¨æˆ·æ¨¡å—ä¸­æœ‰è®²è§£è¯¦ç»†æµç¨‹ï¼Œæ­¤å¤„ä¸å†èµ˜è¿°ã€‚

ä¿®æ”¹å®ä½“ç±»çš„ä¸»é”®ç”Ÿæˆç­–ç•¥å¹¶æŒ‡å®šé€»è¾‘åˆ é™¤å­—æ®µï¼ŒSpace ç±»çš„ä»£ç å¦‚ä¸‹ï¼š

```java
@TableName(value ="space")
@Data
public class Space implements Serializable {
    /**
     * id
     */
    @TableId(type = IdType.ASSIGN_ID)
    private Long id;

    /**
     * ç©ºé—´åç§°
     */
    private String spaceName;

    /**
     * ç©ºé—´çº§åˆ«ï¼š0-æ™®é€šç‰ˆ 1-ä¸“ä¸šç‰ˆ 2-æ——èˆ°ç‰ˆ
     */
    private Integer spaceLevel;

    /**
     * ç©ºé—´å›¾ç‰‡çš„æœ€å¤§æ€»å¤§å°
     */
    private Long maxSize;

    /**
     * ç©ºé—´å›¾ç‰‡çš„æœ€å¤§æ•°é‡
     */
    private Long maxCount;

    /**
     * å½“å‰ç©ºé—´ä¸‹å›¾ç‰‡çš„æ€»å¤§å°
     */
    private Long totalSize;

    /**
     * å½“å‰ç©ºé—´ä¸‹çš„å›¾ç‰‡æ•°é‡
     */
    private Long totalCount;

    /**
     * åˆ›å»ºç”¨æˆ· id
     */
    private Long userId;

    /**
     * åˆ›å»ºæ—¶é—´
     */
    private Date createTime;

    /**
     * ç¼–è¾‘æ—¶é—´
     */
    private Date editTime;

    /**
     * æ›´æ–°æ—¶é—´
     */
    private Date updateTime;

    /**
     * æ˜¯å¦åˆ é™¤
     */
    @TableLogic
    private Integer isDelete;

    @TableField(exist = false)
    private static final long serialVersionUID = 1L;
}
```

2ï¼‰æ¯ä¸ªæ“ä½œéƒ½éœ€è¦æä¾›ä¸€ä¸ªè¯·æ±‚ç±»ï¼Œéƒ½æ”¾åœ¨ `model.dto.space` åŒ…ä¸‹ã€‚

![img](./assets/wQvlh2bl5kw3RoCo.webp)

ç©ºé—´åˆ›å»ºè¯·æ±‚ï¼š

```java
@Data
public class SpaceAddRequest implements Serializable {

    /**
     * ç©ºé—´åç§°
     */
    private String spaceName;

    /**
     * ç©ºé—´çº§åˆ«ï¼š0-æ™®é€šç‰ˆ 1-ä¸“ä¸šç‰ˆ 2-æ——èˆ°ç‰ˆ
     */
    private Integer spaceLevel;

    private static final long serialVersionUID = 1L;
}
```

ç©ºé—´ç¼–è¾‘è¯·æ±‚ï¼Œç»™ç”¨æˆ·ä½¿ç”¨ï¼Œç›®å‰ä»…å…è®¸ç¼–è¾‘ç©ºé—´åç§°ï¼š

```java
@Data
public class SpaceEditRequest implements Serializable {

    /**
     * ç©ºé—´ id
     */
    private Long id;

    /**
     * ç©ºé—´åç§°
     */
    private String spaceName;

    private static final long serialVersionUID = 1L;
}
```

ç©ºé—´æ›´æ–°è¯·æ±‚ï¼Œç»™ç®¡ç†å‘˜ä½¿ç”¨ï¼Œå¯ä»¥ä¿®æ”¹ç©ºé—´çº§åˆ«å’Œé™é¢ï¼š

```java
@Data
public class SpaceUpdateRequest implements Serializable {

    /**
     * id
     */
    private Long id;

    /**
     * ç©ºé—´åç§°
     */
    private String spaceName;

    /**
     * ç©ºé—´çº§åˆ«ï¼š0-æ™®é€šç‰ˆ 1-ä¸“ä¸šç‰ˆ 2-æ——èˆ°ç‰ˆ
     */
    private Integer spaceLevel;

    /**
     * ç©ºé—´å›¾ç‰‡çš„æœ€å¤§æ€»å¤§å°
     */
    private Long maxSize;

    /**
     * ç©ºé—´å›¾ç‰‡çš„æœ€å¤§æ•°é‡
     */
    private Long maxCount;

    private static final long serialVersionUID = 1L;
}
```

ç©ºé—´æŸ¥è¯¢è¯·æ±‚ï¼š

```java
@EqualsAndHashCode(callSuper = true)
@Data
public class SpaceQueryRequest extends PageRequest implements Serializable {

    /**
     * id
     */
    private Long id;

    /**
     * ç”¨æˆ· id
     */
    private Long userId;

    /**
     * ç©ºé—´åç§°
     */
    private String spaceName;

    /**
     * ç©ºé—´çº§åˆ«ï¼š0-æ™®é€šç‰ˆ 1-ä¸“ä¸šç‰ˆ 2-æ——èˆ°ç‰ˆ
     */
    private Integer spaceLevel;

    private static final long serialVersionUID = 1L;
}
```

3ï¼‰åœ¨ `model.dto.vo` ä¸‹æ–°å»ºç©ºé—´çš„è§†å›¾åŒ…è£…ç±»ï¼Œå¯ä»¥é¢å¤–å…³è”åˆ›å»ºç©ºé—´çš„ç”¨æˆ·ä¿¡æ¯ã€‚è¿˜å¯ä»¥ç¼–å†™ Space å®ä½“ç±»å’Œè¯¥ VO ç±»çš„è½¬æ¢æ–¹æ³•ï¼Œä¾¿äºåç»­å¿«é€Ÿä¼ å€¼ã€‚

```java
@Data
public class SpaceVO implements Serializable {
    /**
     * id
     */
    private Long id;

    /**
     * ç©ºé—´åç§°
     */
    private String spaceName;

    /**
     * ç©ºé—´çº§åˆ«ï¼š0-æ™®é€šç‰ˆ 1-ä¸“ä¸šç‰ˆ 2-æ——èˆ°ç‰ˆ
     */
    private Integer spaceLevel;

    /**
     * ç©ºé—´å›¾ç‰‡çš„æœ€å¤§æ€»å¤§å°
     */
    private Long maxSize;

    /**
     * ç©ºé—´å›¾ç‰‡çš„æœ€å¤§æ•°é‡
     */
    private Long maxCount;

    /**
     * å½“å‰ç©ºé—´ä¸‹å›¾ç‰‡çš„æ€»å¤§å°
     */
    private Long totalSize;

    /**
     * å½“å‰ç©ºé—´ä¸‹çš„å›¾ç‰‡æ•°é‡
     */
    private Long totalCount;

    /**
     * åˆ›å»ºç”¨æˆ· id
     */
    private Long userId;

    /**
     * åˆ›å»ºæ—¶é—´
     */
    private Date createTime;

    /**
     * ç¼–è¾‘æ—¶é—´
     */
    private Date editTime;

    /**
     * æ›´æ–°æ—¶é—´
     */
    private Date updateTime;

    /**
     * åˆ›å»ºç”¨æˆ·ä¿¡æ¯
     */
    private UserVO user;

    private static final long serialVersionUID = 1L;

    /**
     * å°è£…ç±»è½¬å¯¹è±¡
     *
     * @param spaceVO
     * @return
     */
    public static Space voToObj(SpaceVO spaceVO) {
        if (spaceVO == null) {
            return null;
        }
        Space space = new Space();
        BeanUtils.copyProperties(spaceVO, space);
        return space;
    }

    /**
     * å¯¹è±¡è½¬å°è£…ç±»
     *
     * @param space
     * @return
     */
    public static SpaceVO objToVo(Space space) {
        if (space == null) {
            return null;
        }
        SpaceVO spaceVO = new SpaceVO();
        BeanUtils.copyProperties(space, spaceVO);
        return spaceVO;
    }
}
```

4ï¼‰åœ¨ `model.enums` åŒ…ä¸‹æ–°å»ºç©ºé—´çº§åˆ«æšä¸¾ï¼Œå®šä¹‰æ¯ä¸ªçº§åˆ«çš„ç©ºé—´å¯¹åº”çš„é™é¢ï¼š

```java
@Getter
public enum SpaceLevelEnum {

    COMMON("æ™®é€šç‰ˆ", 0, 100, 100L * 1024 * 1024),
    PROFESSIONAL("ä¸“ä¸šç‰ˆ", 1, 1000, 1000L * 1024 * 1024),
    FLAGSHIP("æ——èˆ°ç‰ˆ", 2, 10000, 10000L * 1024 * 1024);

    private final String text;

    private final int value;

    private final long maxCount;

    private final long maxSize;


    /**
     * @param text æ–‡æœ¬
     * @param value å€¼
     * @param maxSize æœ€å¤§å›¾ç‰‡æ€»å¤§å°
     * @param maxCount æœ€å¤§å›¾ç‰‡æ€»æ•°é‡
     */
    SpaceLevelEnum(String text, int value, long maxCount, long maxSize) {
        this.text = text;
        this.value = value;
        this.maxCount = maxCount;
        this.maxSize = maxSize;
    }

    /**
     * æ ¹æ® value è·å–æšä¸¾
     */
    public static SpaceLevelEnum getEnumByValue(Integer value) {
        if (ObjUtil.isEmpty(value)) {
            return null;
        }
        for (SpaceLevelEnum spaceLevelEnum : SpaceLevelEnum.values()) {
            if (spaceLevelEnum.value == value) {
                return spaceLevelEnum;
            }
        }
        return null;
    }
}
```

ğŸ’¡ è¿˜æœ‰å¦å¤–ä¸€ç§å®šä¹‰ç©ºé—´çº§åˆ«é™é¢çš„æ–¹å¼ï¼Œæ¯”å¦‚å°†ç©ºé—´é™é¢é…ç½®å­˜å‚¨åœ¨å¤–éƒ¨æ–‡ä»¶ï¼ˆå¦‚ JSON æ–‡ä»¶æˆ– properties æ–‡ä»¶ï¼‰ï¼Œå¹¶åˆ›å»ºä¸€ä¸ªå•ç‹¬çš„ç±»æ¥æ¥æ”¶å‚æ•°ã€‚è¿™æ ·åæœŸå¦‚æœæœ‰å˜åŠ¨ï¼Œä¿®æ”¹é…ç½®æ–‡ä»¶å³å¯ï¼Œè€Œä¸å¿…ä¿®æ”¹ä»£ç ã€‚

#### 2ã€åŸºç¡€æœåŠ¡å¼€å‘

å¯ä»¥å‚è€ƒå›¾ç‰‡æœåŠ¡çš„å¼€å‘æ–¹æ³•ï¼Œå®Œæˆ SpaceService å’Œå®ç°ç±»ï¼Œå¤§å¤šæ•°ä»£ç å¯ä»¥ç›´æ¥å¤ç”¨ã€‚

ç”±äºåˆ›å»ºç©ºé—´çš„é€»è¾‘æ¯”è¾ƒå¤æ‚ï¼Œå¯ä»¥å…ˆå®šä¹‰ä¸ªæ¥å£å å‘ã€‚æˆ‘ä»¬ä¸»è¦å¼€å‘ä¸‹åˆ—æ–¹æ³•ï¼š

1ï¼‰éœ€è¦å¼€å‘æ ¡éªŒç©ºé—´æ•°æ®çš„æ–¹æ³•ï¼Œå¢åŠ  add å‚æ•°ç”¨æ¥åŒºåˆ†æ˜¯åˆ›å»ºæ•°æ®æ—¶æ ¡éªŒè¿˜æ˜¯ç¼–è¾‘æ—¶æ ¡éªŒï¼Œåˆ¤æ–­æ¡ä»¶æ˜¯ä¸ä¸€æ ·çš„ï¼š

```java
@Override
public void validSpace(Space space, boolean add) {
    ThrowUtils.throwIf(space == null, ErrorCode.PARAMS_ERROR);
    // ä»å¯¹è±¡ä¸­å–å€¼
    String spaceName = space.getSpaceName();
    Integer spaceLevel = space.getSpaceLevel();
    SpaceLevelEnum spaceLevelEnum = SpaceLevelEnum.getEnumByValue(spaceLevel);
    // è¦åˆ›å»º
    if (add) {
        if (StrUtil.isBlank(spaceName)) {
            throw new BusinessException(ErrorCode.PARAMS_ERROR, "ç©ºé—´åç§°ä¸èƒ½ä¸ºç©º");
        }
        if (spaceLevel == null) {
            throw new BusinessException(ErrorCode.PARAMS_ERROR, "ç©ºé—´çº§åˆ«ä¸èƒ½ä¸ºç©º");
        }
    }
    // ä¿®æ”¹æ•°æ®æ—¶ï¼Œå¦‚æœè¦æ”¹ç©ºé—´çº§åˆ«
    if (spaceLevel != null && spaceLevelEnum == null) {
        throw new BusinessException(ErrorCode.PARAMS_ERROR, "ç©ºé—´çº§åˆ«ä¸å­˜åœ¨");
    }
    if (StrUtil.isNotBlank(spaceName) && spaceName.length() > 30) {
        throw new BusinessException(ErrorCode.PARAMS_ERROR, "ç©ºé—´åç§°è¿‡é•¿");
    }
}
```

2ï¼‰åœ¨åˆ›å»ºæˆ–æ›´æ–°ç©ºé—´æ—¶ï¼Œéœ€è¦æ ¹æ®ç©ºé—´çº§åˆ«è‡ªåŠ¨å¡«å……é™é¢æ•°æ®ï¼Œå¯ä»¥åœ¨æœåŠ¡ä¸­ç¼–å†™æ–¹æ³•ä¾¿äºå¤ç”¨ï¼š

```java
@Override
public void fillSpaceBySpaceLevel(Space space) {
    // æ ¹æ®ç©ºé—´çº§åˆ«ï¼Œè‡ªåŠ¨å¡«å……é™é¢
    SpaceLevelEnum spaceLevelEnum = SpaceLevelEnum.getEnumByValue(space.getSpaceLevel());
    if (spaceLevelEnum != null) {
        long maxSize = spaceLevelEnum.getMaxSize();
        if (space.getMaxSize() == null) {
            space.setMaxSize(maxSize);
        }
        long maxCount = spaceLevelEnum.getMaxCount();
        if (space.getMaxCount() == null) {
            space.setMaxCount(maxCount);
        }
    }
}
```

å¦‚æœç©ºé—´æœ¬èº«æ²¡æœ‰è®¾ç½®é™é¢ï¼Œæ‰ä¼šè‡ªåŠ¨å¡«å……ï¼Œä¿è¯äº†çµæ´»æ€§ã€‚

#### 3ã€æ¥å£å¼€å‘

å‚è€ƒå›¾ç‰‡æ¥å£çš„å¼€å‘æ–¹æ³•ï¼Œå®Œæˆ SpaceController ç±»ï¼Œå¤§å¤šæ•°ä»£ç å¯ä»¥ç›´æ¥å¤ç”¨ã€‚

éœ€è¦é‡ç‚¹å…³æ³¨æ¥å£çš„æƒé™ï¼š

- åˆ›å»ºç©ºé—´ï¼šæ‰€æœ‰ç”¨æˆ·éƒ½å¯ä»¥ä½¿ç”¨
- åˆ é™¤ç©ºé—´ï¼šä»…å…è®¸ç©ºé—´åˆ›å»ºäººæˆ–ç®¡ç†å‘˜åˆ é™¤
- æ›´æ–°ç©ºé—´ï¼šä»…ç®¡ç†å‘˜å¯ç”¨ï¼Œå…è®¸æ›´æ–°ç©ºé—´çº§åˆ«
- ç¼–è¾‘ç©ºé—´ï¼šå…è®¸ç©ºé—´åˆ›å»ºäººä½¿ç”¨ï¼Œä½†æ³¨æ„å¯ç¼–è¾‘çš„å­—æ®µï¼ˆä¸èƒ½ç¼–è¾‘ç©ºé—´çº§åˆ«ï¼‰

å¼€å‘æ›´æ–°æ¥å£æ—¶ï¼Œéœ€è¦è°ƒç”¨å¡«å……ç©ºé—´é™é¢æ•°æ®çš„æ–¹æ³•ï¼š

```java
@PostMapping("/update")
@AuthCheck(mustRole = UserConstant.ADMIN_ROLE)
public BaseResponse<Boolean> updateSpace(@RequestBody SpaceUpdateRequest spaceUpdateRequest) {
    if (spaceUpdateRequest == null || spaceUpdateRequest.getId() <= 0) {
        throw new BusinessException(ErrorCode.PARAMS_ERROR);
    }
    // å°†å®ä½“ç±»å’Œ DTO è¿›è¡Œè½¬æ¢
    Space space = new Space();
    BeanUtils.copyProperties(spaceUpdateRequest, space);
    // è‡ªåŠ¨å¡«å……æ•°æ®
    spaceService.fillSpaceBySpaceLevel(space);
    // æ•°æ®æ ¡éªŒ
    spaceService.validSpace(space, false);
    // åˆ¤æ–­æ˜¯å¦å­˜åœ¨
    long id = spaceUpdateRequest.getId();
    Space oldSpace = spaceService.getById(id);
    ThrowUtils.throwIf(oldSpace == null, ErrorCode.NOT_FOUND_ERROR);
    // æ“ä½œæ•°æ®åº“
    boolean result = spaceService.updateById(space);
    ThrowUtils.throwIf(!result, ErrorCode.OPERATION_ERROR);
    return ResultUtils.success(true);
}
```

### ç”¨æˆ·åˆ›å»ºç§æœ‰ç©ºé—´

ç”¨æˆ·å¯ä»¥è‡ªä¸»åˆ›å»ºç§æœ‰ç©ºé—´ï¼Œä½†æ˜¯å¿…é¡»è¦åŠ é™åˆ¶ï¼Œ**æœ€å¤šåªèƒ½åˆ›å»ºä¸€ä¸ª**ã€‚

éœ€è¦å¼€å‘åˆ›å»ºç©ºé—´æœåŠ¡ï¼Œè¯¥æœåŠ¡è¾ƒä¸ºå¤æ‚ï¼Œæˆ‘ä»¬è¦å…ˆæ•´ç†ä¸‹æµç¨‹ã€‚

#### 1ã€åˆ›å»ºç©ºé—´æµç¨‹

æµç¨‹å¦‚ä¸‹ï¼š

1. å¡«å……å‚æ•°é»˜è®¤å€¼
2. æ ¡éªŒå‚æ•°
3. æ ¡éªŒæƒé™ï¼Œéç®¡ç†å‘˜åªèƒ½åˆ›å»ºæ™®é€šçº§åˆ«çš„ç©ºé—´
4. æ§åˆ¶åŒä¸€ç”¨æˆ·åªèƒ½åˆ›å»ºä¸€ä¸ªç§æœ‰ç©ºé—´

å¦‚ä½•ä¿è¯åŒä¸€ç”¨æˆ·åªèƒ½åˆ›å»ºä¸€ä¸ªç§æœ‰ç©ºé—´å‘¢ï¼Ÿ

æœ€ç²—æš´çš„æ–¹å¼æ˜¯ç»™ç©ºé—´è¡¨çš„ userId åŠ ä¸Šå”¯ä¸€ç´¢å¼•ï¼Œä½†ç”±äºåç»­ç”¨æˆ·è¿˜å¯ä»¥åˆ›å»ºå›¢é˜Ÿç©ºé—´ï¼Œè¿™ç§æ–¹å¼ä¸åˆ©äºæ‰©å±•ã€‚æ‰€ä»¥æˆ‘ä»¬é‡‡ç”¨ **åŠ é” + äº‹åŠ¡** çš„æ–¹å¼å®ç°ã€‚

#### 2ã€åˆ›å»ºç©ºé—´æœåŠ¡

æŒ‰ç…§ä¸Šè¿°æµç¨‹ç¼–å†™ä»£ç ï¼š

```java
@Resource
private TransactionTemplate transactionTemplate;

@Override
public long addSpace(SpaceAddRequest spaceAddRequest, User loginUser) {
    // åœ¨æ­¤å¤„å°†å®ä½“ç±»å’Œ DTO è¿›è¡Œè½¬æ¢
    Space space = new Space();
    BeanUtils.copyProperties(spaceAddRequest, space);
    // é»˜è®¤å€¼
    if (StrUtil.isBlank(spaceAddRequest.getSpaceName())) {
        space.setSpaceName("é»˜è®¤ç©ºé—´");
    }
    if (spaceAddRequest.getSpaceLevel() == null) {
        spaceAddRequest.setSpaceLevel(SpaceLevelEnum.COMMON.getValue());
    }
    // å¡«å……æ•°æ®
    this.fillSpaceBySpaceLevel(space);
    // æ•°æ®æ ¡éªŒ
    this.validSpace(space, true);
    Long userId = loginUser.getId();
    space.setUserId(userId);
    // æƒé™æ ¡éªŒ
    if (SpaceLevelEnum.COMMON.getValue() != spaceAddRequest.getSpaceLevel() && !userService.isAdmin(loginUser)) {
        throw new BusinessException(ErrorCode.NO_AUTH_ERROR, "æ— æƒé™åˆ›å»ºæŒ‡å®šçº§åˆ«çš„ç©ºé—´");
    }
    // é’ˆå¯¹ç”¨æˆ·è¿›è¡ŒåŠ é”
    String lock = String.valueOf(userId).intern();
    synchronized (lock) {
        Long newSpaceId = transactionTemplate.execute(status -> {
            boolean exists = this.lambdaQuery().eq(Space::getUserId, userId).exists();
            ThrowUtils.throwIf(exists, ErrorCode.OPERATION_ERROR, "æ¯ä¸ªç”¨æˆ·ä»…èƒ½æœ‰ä¸€ä¸ªç§æœ‰ç©ºé—´");
            // å†™å…¥æ•°æ®åº“
            boolean result = this.save(space);
            ThrowUtils.throwIf(!result, ErrorCode.OPERATION_ERROR);
            // è¿”å›æ–°å†™å…¥çš„æ•°æ® id
            return space.getId();
        });
        // è¿”å›ç»“æœæ˜¯åŒ…è£…ç±»ï¼Œå¯ä»¥åšä¸€äº›å¤„ç†
        return Optional.ofNullable(newSpaceId).orElse(-1L);
    }
}
```

æ³¨æ„ï¼Œä¸Šè¿°ä»£ç ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨æœ¬åœ° synchronized é”å¯¹ userId è¿›è¡ŒåŠ é”ï¼Œè¿™æ ·ä¸åŒçš„ç”¨æˆ·å¯ä»¥æ‹¿åˆ°ä¸åŒçš„é”ï¼Œå¯¹æ€§èƒ½çš„å½±å“è¾ƒä½ã€‚åœ¨åŠ é”çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ Spring çš„ **ç¼–ç¨‹å¼äº‹åŠ¡ç®¡ç†å™¨** transactionTemplate å°è£…è·Ÿæ•°æ®åº“æœ‰å…³çš„æŸ¥è¯¢å’Œæ’å…¥æ“ä½œï¼Œè€Œä¸æ˜¯ä½¿ç”¨ @Transactional æ³¨è§£æ¥æ§åˆ¶äº‹åŠ¡ï¼Œè¿™æ ·å¯ä»¥ä¿è¯äº‹åŠ¡çš„æäº¤åœ¨åŠ é”çš„èŒƒå›´å†…ã€‚

ğŸ’¡ åªè¦æ¶‰åŠåˆ°äº‹åŠ¡æ“ä½œï¼Œå»ºè®®å¤§å®¶æµ‹è¯•æ—¶è‡ªå·± new ä¸ªè¿è¡Œæ—¶å¼‚å¸¸æ¥éªŒè¯æ˜¯å¦ä¼šå›æ»šã€‚

#### æ‰©å±•çŸ¥è¯† - æœ¬åœ°é”ä¼˜åŒ–

ä¸Šè¿°ä»£ç ä¸­ï¼Œæˆ‘ä»¬æ˜¯å¯¹å­—ç¬¦ä¸²å¸¸é‡æ± ï¼ˆinternï¼‰è¿›è¡ŒåŠ é”çš„ï¼Œæ•°æ®å¹¶ä¸ä¼šåŠæ—¶é‡Šæ”¾ã€‚å¦‚æœè¿˜è¦ä½¿ç”¨æœ¬åœ°é”ï¼Œå¯ä»¥æŒ‰éœ€é€‰ç”¨å¦ä¸€ç§æ–¹å¼ â€”â€” é‡‡ç”¨ `ConcurrentHashMap` æ¥å­˜å‚¨é”å¯¹è±¡ã€‚

ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š

```java
Map<Long, Object> lockMap = new ConcurrentHashMap<>();

public long addSpace(SpaceAddRequest spaceAddRequest, User user) {
    Long userId = user.getId();
    Object lock = lockMap.computeIfAbsent(userId, key -> new Object());
    synchronized (lock) {
        try {
            // æ•°æ®åº“æ“ä½œ
        } finally {
            // é˜²æ­¢å†…å­˜æ³„æ¼
            lockMap.remove(userId);
        }
    }
}
```

#### æ‰©å±•

1ï¼‰ç”¨æˆ·æ³¨å†ŒæˆåŠŸæ—¶ï¼Œå¯ä»¥è‡ªåŠ¨åˆ›å»ºç©ºé—´ã€‚å³ä½¿åˆ›å»ºå¤±è´¥äº†ï¼Œä¹Ÿå¯ä»¥æ‰‹åŠ¨åˆ›å»ºä½œä¸ºå…œåº•ã€‚

2ï¼‰ç®¡ç†å‘˜å¯ä»¥ä¸ºæŸä¸ªç”¨æˆ·åˆ›å»ºç©ºé—´ï¼ˆç›®å‰æ²¡å•¥å¿…è¦ï¼‰

3ï¼‰æœ¬åœ°é”æ”¹ä¸ºåˆ†å¸ƒå¼é”ï¼Œå¯ä»¥åŸºäº Redisson å®ç°ã€‚é±¼çš®ç¼–ç¨‹å¯¼èˆªçš„ [AI ç­”é¢˜åº”ç”¨å¹³å°é¡¹ç›®](https://www.code-nav.cn/course/1790274408835506178/) ä¸­æœ‰è®²è§£ã€‚

### ç§æœ‰ç©ºé—´æƒé™æ§åˆ¶

ç§æœ‰ç©ºé—´çš„æƒé™å’Œå…¬å…±å›¾åº“æ˜¯ä¸åŒçš„ï¼Œæˆ‘ä»¬éœ€è¦å¯¹ä¹‹å‰ **æ‰€æœ‰çš„å›¾ç‰‡æ“ä½œ** éƒ½æ·»åŠ å’Œç©ºé—´æœ‰å…³çš„æƒé™æ ¡éªŒé€»è¾‘ã€‚

#### 1ã€å›¾ç‰‡è¡¨æ–°å¢å­—æ®µ

å›¾ç‰‡è¡¨å¢åŠ  spaceId å­—æ®µï¼Œé»˜è®¤ä¸º null è¡¨ç¤ºå…¬å…±å›¾åº“ã€‚

åŒæ­¥ä¿®æ”¹ PictureMapper.xmlã€Picture å®ä½“ç±»ã€PictureVO å“åº”è§†å›¾ï¼Œè¡¥å……ç©ºé—´ id å­—æ®µï¼š

```java
/**
 * ç©ºé—´ id
 */
private Long spaceId;
```

ä¸‹é¢æˆ‘ä»¬ä¾æ¬¡ç»™ â€œå¢åˆ æ”¹æŸ¥â€ å›¾ç‰‡æ“ä½œå¢åŠ æƒé™æ ¡éªŒé€»è¾‘ã€‚

#### 2ã€ä¸Šä¼ å’Œæ›´æ–°å›¾ç‰‡

1ï¼‰ä¸Šä¼ å›¾ç‰‡æ—¶æ”¯æŒæŒ‡å®šç©ºé—´ idï¼Œè¡¨ç¤ºè¦å°†å›¾ç‰‡ä¸Šä¼ åˆ°å“ªä¸ªç©ºé—´ã€‚

ç»™ PictureUploadRequest è¯·æ±‚å°è£…ç±»è¡¥å…… spaceId å­—æ®µã€‚

2ï¼‰ä¿®æ”¹ä¸Šä¼ å›¾ç‰‡æ–¹æ³• uploadPictureï¼Œæ ¡éªŒç©ºé—´æ˜¯å¦å­˜åœ¨ï¼›å¦‚æœå­˜åœ¨ï¼Œè¿˜è¦æ ¡éªŒæ˜¯å¦æœ‰ç©ºé—´æƒé™ï¼Œä»…ç©ºé—´çš„ç®¡ç†å‘˜æ‰èƒ½ä¸Šä¼ ã€‚

ç°é˜¶æ®µç©ºé—´çš„ç®¡ç†å‘˜å°±æ˜¯ç©ºé—´çš„åˆ›å»ºäºº

```java
ThrowUtils.throwIf(loginUser == null, ErrorCode.NO_AUTH_ERROR);
// æ ¡éªŒç©ºé—´æ˜¯å¦å­˜åœ¨
Long spaceId = pictureUploadRequest.getSpaceId();
if (spaceId != null) {
    Space space = spaceService.getById(spaceId);
    ThrowUtils.throwIf(space == null, ErrorCode.NOT_FOUND_ERROR, "ç©ºé—´ä¸å­˜åœ¨");
    // å¿…é¡»ç©ºé—´åˆ›å»ºäººï¼ˆç®¡ç†å‘˜ï¼‰æ‰èƒ½ä¸Šä¼ 
    if (!loginUser.getId().equals(space.getUserId())) {
        throw new BusinessException(ErrorCode.NO_AUTH_ERROR, "æ²¡æœ‰ç©ºé—´æƒé™");
    }
}
```

3ï¼‰å¦‚æœæ˜¯æ›´æ–°å›¾ç‰‡ï¼Œéœ€è¦æ ¡éªŒæ›´æ–°æ—¶ä¼ é€’çš„ spaceId å’Œå·²æœ‰å›¾ç‰‡çš„ spaceId æ˜¯å¦ä¸€è‡´ã€‚å¦‚æœæ›´æ–°æ—¶æœªä¼ é€’ spaceIdï¼Œåˆ™å¤ç”¨åŸæœ‰å›¾ç‰‡çš„ spaceIdã€‚ä»£ç å¦‚ä¸‹ï¼š

```java
// å¦‚æœæ˜¯æ›´æ–°å›¾ç‰‡ï¼Œéœ€è¦æ ¡éªŒå›¾ç‰‡æ˜¯å¦å­˜åœ¨
if (pictureId != null) {
    Picture oldPicture = this.getById(pictureId);
    ThrowUtils.throwIf(oldPicture == null, ErrorCode.NOT_FOUND_ERROR, "å›¾ç‰‡ä¸å­˜åœ¨");
    // ä»…æœ¬äººæˆ–ç®¡ç†å‘˜å¯ç¼–è¾‘
    if (!oldPicture.getUserId().equals(loginUser.getId()) && !userService.isAdmin(loginUser)) {
        throw new BusinessException(ErrorCode.NO_AUTH_ERROR);
    }
    // æ ¡éªŒç©ºé—´æ˜¯å¦ä¸€è‡´
    // æ²¡ä¼  spaceIdï¼Œåˆ™å¤ç”¨åŸæœ‰å›¾ç‰‡çš„ spaceId
    if (spaceId == null) {
        if (oldPicture.getSpaceId() != null) {
            spaceId = oldPicture.getSpaceId();
        }
    } else {
        // ä¼ äº† spaceIdï¼Œå¿…é¡»å’ŒåŸæœ‰å›¾ç‰‡ä¸€è‡´
        if (ObjUtil.notEqual(spaceId, oldPicture.getSpaceId())) {
            throw new BusinessException(ErrorCode.PARAMS_ERROR, "ç©ºé—´ id ä¸ä¸€è‡´");
        }
    }
}
```

4ï¼‰ä¹‹å‰æ˜¯æŒ‰ç”¨æˆ·åˆ’åˆ†å›¾ç‰‡ä¸Šä¼ ç›®å½•çš„ï¼Œç°åœ¨å¦‚æœæœ‰ spaceIdï¼Œå¯ä»¥æŒ‰ç…§ç©ºé—´æ¥åˆ’åˆ†å›¾ç‰‡ä¸Šä¼ ç›®å½•ã€‚

```java
// æŒ‰ç…§ç”¨æˆ· id åˆ’åˆ†ç›®å½• => æŒ‰ç…§ç©ºé—´åˆ’åˆ†ç›®å½•
String uploadPathPrefix;
if (spaceId == null) {
    uploadPathPrefix = String.format("public/%s", loginUser.getId());
} else {
    uploadPathPrefix = String.format("space/%s", spaceId);
}
```

5ï¼‰æ’å…¥ / æ›´æ–°æ•°æ®æ—¶ï¼Œå°† spaceId è®¾ç½®åˆ° Picture å¯¹è±¡ä¸­ï¼š

```java
// æ„é€ è¦å…¥åº“çš„å›¾ç‰‡ä¿¡æ¯
Picture picture = new Picture();
// è¡¥å……è®¾ç½® spaceId
picture.setSpaceId(spaceId);
```

#### 2ã€åˆ é™¤å›¾ç‰‡

å¦‚æœè¦åˆ é™¤çš„å›¾ç‰‡æœ‰ç©ºé—´ idï¼Œè¡¨ç¤ºæ˜¯ç”¨æˆ·ä¸Šä¼ åˆ°ç§æœ‰ç©ºé—´ä¸­çš„å›¾ç‰‡ï¼Œé‚£ä¹ˆç™»å½•ç”¨æˆ·å¿…é¡»æ˜¯ç©ºé—´çš„ç®¡ç†å‘˜ï¼ˆä¹Ÿå°±æ˜¯åˆ›å»ºè€…ï¼‰ï¼Œç³»ç»Ÿç®¡ç†å‘˜ä¹Ÿä¸èƒ½éšæ„åˆ é™¤ç§æœ‰ç©ºé—´çš„å›¾ç‰‡ã€‚

1ï¼‰å› ä¸ºåˆ é™¤å›¾ç‰‡å’Œç¼–è¾‘å›¾ç‰‡çš„æƒé™æ§åˆ¶æ˜¯ä¸€æ ·çš„ï¼ˆæœ‰åˆ é™¤æƒé™å°±æœ‰ç¼–è¾‘æƒé™ï¼‰ï¼Œå¯ä»¥å°†è¿™æ®µæƒé™æ ¡éªŒé€»è¾‘å°è£…ä¸ºä¸€ä¸ªæ–¹æ³•ï¼š

```java
@Override
public void checkPictureAuth(User loginUser, Picture picture) {
    Long spaceId = picture.getSpaceId();
    if (spaceId == null) {
        // å…¬å…±å›¾åº“ï¼Œä»…æœ¬äººæˆ–ç®¡ç†å‘˜å¯æ“ä½œ
        if (!picture.getUserId().equals(loginUser.getId()) && !userService.isAdmin(loginUser)) {
            throw new BusinessException(ErrorCode.NO_AUTH_ERROR);
        }
    } else {
        // ç§æœ‰ç©ºé—´ï¼Œä»…ç©ºé—´ç®¡ç†å‘˜å¯æ“ä½œ
        if (!picture.getUserId().equals(loginUser.getId())) {
            throw new BusinessException(ErrorCode.NO_AUTH_ERROR);
        }
    }
}
```

2ï¼‰åŸæœ¬åˆ é™¤å›¾ç‰‡ deletePicture é€»è¾‘å¾ˆç®€å•ï¼Œç›´æ¥å†™åˆ°äº† Controller ä¸­ï¼Œç°åœ¨æœ‰äº†æ›´å¤šé€»è¾‘ï¼Œå»ºè®®å°è£…ä¸º serviceï¼Œå¹¶åŒæ­¥ä¿®æ”¹ Controller æ¥è°ƒç”¨ Serviceã€‚

åˆ é™¤å›¾ç‰‡æ–¹æ³•ä»£ç å¦‚ä¸‹ï¼š

```java
@Override
public void deletePicture(long pictureId, User loginUser) {
    ThrowUtils.throwIf(pictureId <= 0, ErrorCode.PARAMS_ERROR);
    ThrowUtils.throwIf(loginUser == null, ErrorCode.NO_AUTH_ERROR);
    // åˆ¤æ–­æ˜¯å¦å­˜åœ¨
    Picture oldPicture = this.getById(pictureId);
    ThrowUtils.throwIf(oldPicture == null, ErrorCode.NOT_FOUND_ERROR);
    // æ ¡éªŒæƒé™
    checkPictureAuth(loginUser, oldPicture);
    // æ“ä½œæ•°æ®åº“
    boolean result = this.removeById(pictureId);
    ThrowUtils.throwIf(!result, ErrorCode.OPERATION_ERROR);
    // å¼‚æ­¥æ¸…ç†æ–‡ä»¶
    this.clearPictureFile(oldPicture);
}
```

#### 3ã€ç¼–è¾‘å›¾ç‰‡

è·Ÿåˆ é™¤å›¾ç‰‡çš„æƒé™æ ¡éªŒé€»è¾‘ä¸€æ ·ï¼Œå¦‚æœè¦ç¼–è¾‘çš„å›¾ç‰‡æœ‰ç©ºé—´ idï¼Œè¡¨ç¤ºæ˜¯ç”¨æˆ·ä¸Šä¼ åˆ°ç§æœ‰ç©ºé—´ä¸­çš„å›¾ç‰‡ï¼Œé‚£ä¹ˆç™»å½•ç”¨æˆ·å¿…é¡»æ˜¯ç©ºé—´çš„ç®¡ç†å‘˜ï¼ˆä¹Ÿå°±æ˜¯åˆ›å»ºè€…ï¼‰ï¼Œç³»ç»Ÿç®¡ç†å‘˜ä¹Ÿä¸èƒ½éšæ„ç¼–è¾‘ç§æœ‰ç©ºé—´çš„å›¾ç‰‡ã€‚

å°† editPicture æ–¹æ³•æŠ½è±¡åˆ° Service ä¸­ï¼Œå¹¶åŒæ­¥ä¿®æ”¹ Controller æ¥è°ƒç”¨ Serviceã€‚ä»£ç å¦‚ä¸‹ï¼š

```java
@Override
public void editPicture(PictureEditRequest pictureEditRequest, User loginUser) {
    // åœ¨æ­¤å¤„å°†å®ä½“ç±»å’Œ DTO è¿›è¡Œè½¬æ¢
    Picture picture = new Picture();
    BeanUtils.copyProperties(pictureEditRequest, picture);
    // æ³¨æ„å°† list è½¬ä¸º string
    picture.setTags(JSONUtil.toJsonStr(pictureEditRequest.getTags()));
    // è®¾ç½®ç¼–è¾‘æ—¶é—´
    picture.setEditTime(new Date());
    // æ•°æ®æ ¡éªŒ
    this.validPicture(picture);
    // åˆ¤æ–­æ˜¯å¦å­˜åœ¨
    long id = pictureEditRequest.getId();
    Picture oldPicture = this.getById(id);
    ThrowUtils.throwIf(oldPicture == null, ErrorCode.NOT_FOUND_ERROR);
    // æ ¡éªŒæƒé™
    checkPictureAuth(loginUser, oldPicture);
    // è¡¥å……å®¡æ ¸å‚æ•°
    this.fillReviewParams(picture, loginUser);
    // æ“ä½œæ•°æ®åº“
    boolean result = this.updateById(picture);
    ThrowUtils.throwIf(!result, ErrorCode.OPERATION_ERROR);
}
```

ç”±äºæ›´æ–°å›¾ç‰‡æ˜¯ç»™ç®¡ç†å‘˜ä½¿ç”¨çš„æ¥å£ï¼Œå¯ä»¥æš‚æ—¶ä¸ä¿®æ”¹ã€‚

#### 4ã€æŸ¥è¯¢å›¾ç‰‡

ç”¨æˆ·æ— æ³•æŸ¥è¯¢åˆ°ç§æœ‰ç©ºé—´çš„å›¾ç‰‡ï¼Œåªèƒ½æŸ¥è¯¢å…¬å…±å›¾åº“ï¼Œå•æ¡æŸ¥è¯¢å’Œåˆ†é¡µæŸ¥è¯¢éƒ½è¦æ·»åŠ è¿™ä¸ªé€»è¾‘ã€‚

1ï¼‰æ ¹æ® id æŸ¥è¯¢æ¥å£ getPictureVOById

å¦‚æœæŸ¥è¯¢å‡ºçš„å›¾ç‰‡æœ‰ spaceIdï¼Œåˆ™è¿ç”¨è·Ÿåˆ é™¤å›¾ç‰‡ä¸€æ ·çš„æ ¡éªŒé€»è¾‘ï¼Œä»…ç©ºé—´ç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹ï¼š

```java
// æŸ¥è¯¢æ•°æ®åº“
Picture picture = pictureService.getById(id);
ThrowUtils.throwIf(picture == null, ErrorCode.NOT_FOUND_ERROR);
// ç©ºé—´æƒé™æ ¡éªŒ
Long spaceId = picture.getSpaceId();
if (spaceId != null) {
    User loginUser = userService.getLoginUser(request);
    pictureService.checkPictureAuth(loginUser, picture);
}
```

2ï¼‰åˆ†é¡µæŸ¥è¯¢æ¥å£ listPictureVOByPage

æŸ¥è¯¢è¯·æ±‚å¢åŠ  spaceId å‚æ•°ï¼Œä¸ä¼ åˆ™è¡¨ç¤ºæŸ¥å…¬å…±å›¾åº“ï¼›ä¼ å‚åˆ™è¡¨ç¤ºæŸ¥è¯¢ç‰¹å®šç©ºé—´ id ä¸‹çš„å›¾ç‰‡ï¼Œæ­¤æ—¶ç™»å½•ç”¨æˆ·å¿…é¡»æ˜¯ç©ºé—´çš„ç®¡ç†å‘˜ï¼ˆå…¶ä»–ç”¨æˆ·æ— æ³•æŸ¥çœ‹åˆ«äººç©ºé—´çš„å›¾ç‰‡ï¼‰ï¼Œå¹¶ä¸”ä¸éœ€è¦æŒ‡å®šå®¡æ ¸æ¡ä»¶ï¼ˆç§æœ‰ç©ºé—´æ²¡æœ‰å®¡æ ¸æœºåˆ¶ï¼‰ã€‚

å…ˆç»™è¯·æ±‚å°è£…ç±» PictureQueryRequest å’Œ QueryWrapper è¡¥å……ç©ºé—´ id çš„æŸ¥è¯¢æ¡ä»¶ã€‚

PictureQueryRequest æ–°å¢ä»£ç ï¼š

```java
/**
 * ç©ºé—´ id
 */
private Long spaceId;

/**
 * æ˜¯å¦åªæŸ¥è¯¢ spaceId ä¸º null çš„æ•°æ®
 */
private boolean nullSpaceId;
```

QueryWrapper æ–°å¢ä»£ç ï¼š

```java
queryWrapper.eq(ObjUtil.isNotEmpty(spaceId), "spaceId", spaceId);
queryWrapper.isNull(nullSpaceId, "spaceId");
```

ç„¶åç»™æ¥å£å¢åŠ æƒé™æ ¡éªŒï¼Œé’ˆå¯¹å…¬å¼€å›¾åº“å’Œç§æœ‰ç©ºé—´è®¾ç½®ä¸åŒçš„æŸ¥è¯¢æ¡ä»¶ï¼š

```java
// ç©ºé—´æƒé™æ ¡éªŒ
Long spaceId = pictureQueryRequest.getSpaceId();
// å…¬å¼€å›¾åº“
if (spaceId == null) {
    // æ™®é€šç”¨æˆ·é»˜è®¤åªèƒ½æŸ¥çœ‹å·²è¿‡å®¡çš„å…¬å¼€æ•°æ®
    pictureQueryRequest.setReviewStatus(PictureReviewStatusEnum.PASS.getValue());
    pictureQueryRequest.setNullSpaceId(true);
} else {
    // ç§æœ‰ç©ºé—´
    User loginUser = userService.getLoginUser(request);
    Space space = spaceService.getById(spaceId);
    ThrowUtils.throwIf(space == null, ErrorCode.NOT_FOUND_ERROR, "ç©ºé—´ä¸å­˜åœ¨");
    if (!loginUser.getId().equals(space.getUserId())) {
        throw new BusinessException(ErrorCode.NO_AUTH_ERROR, "æ²¡æœ‰ç©ºé—´æƒé™");
    }
}
```

è€ƒè™‘åˆ°ç§æœ‰ç©ºé—´çš„å›¾ç‰‡æ›´æ–°é¢‘ç‡ä¸å¥½æŠŠæ¡ï¼Œä¹‹å‰ç¼–å†™çš„ç¼“å­˜åˆ†é¡µæŸ¥è¯¢å›¾ç‰‡æ¥å£å¯ä»¥æš‚ä¸ä½¿ç”¨å’Œä¿®æ”¹ï¼Œå¯ä»¥å°†è¯¥æ¥å£æ ‡è®°ä¸º @Deprecated è¡¨ç¤ºå·²åºŸå¼ƒã€‚

### ç©ºé—´çº§åˆ«å’Œé™é¢æ§åˆ¶

éœ€æ±‚ï¼šæ¯æ¬¡ä¸Šä¼ å›¾ç‰‡å‰ï¼Œéƒ½è¦æ ¡éªŒç©ºé—´å‰©ä½™é¢åº¦æ˜¯å¦è¶³å¤Ÿï¼›æ¯æ¬¡ä¸Šä¼ å’Œåˆ é™¤å›¾ç‰‡æ—¶ï¼Œéƒ½è¦æ›´æ–°å·²ä½¿ç”¨çš„é¢åº¦ã€‚

#### 1ã€ä¸Šä¼ å›¾ç‰‡æ—¶æ ¡éªŒå’Œæ›´æ–°é¢åº¦

æˆ‘ä»¬å‘ç°ï¼Œç›®å‰ä¸Šä¼ å›¾ç‰‡çš„ä»£ç å·²ç»æ¯”è¾ƒå¤æ‚äº†ï¼Œå¦‚æœæƒ³è¦å†å¢åŠ éå¸¸ä¸¥æ ¼ç²¾ç¡®çš„æ ¡éªŒé€»è¾‘ï¼Œéœ€è¦åœ¨ä¸Šä¼ å›¾ç‰‡åˆ°å¯¹è±¡å­˜å‚¨å‰è‡ªå·±è§£ææ–‡ä»¶çš„å¤§å°ã€å†è®¡ç®—æ˜¯å¦è¶…é¢ï¼Œå¯èƒ½è¿˜è¦åŠ é”ï¼Œæƒ³æƒ³éƒ½å¤´ç–¼ï¼

**è¿™æ—¶ä½ ä¼šæ€ä¹ˆåšå‘¢ï¼Ÿ**

å½“æŠ€æœ¯å®ç°æ¯”è¾ƒå¤æ‚æ—¶ï¼Œæˆ‘ä»¬ä¸å¦¨æ€è€ƒä¸€ä¸‹èƒ½å¦å¯¹ä¸šåŠ¡è¿›è¡Œä¼˜åŒ–ã€‚

æ¯”å¦‚ï¼š

- å•å¼ å›¾ç‰‡æœ€å¤§æ‰ 2Mï¼Œé‚£ä¹ˆå³ä½¿ç©ºé—´æ»¡äº†å†å…è®¸ä¸Šä¼ ä¸€å¼ å›¾ç‰‡ï¼Œå½±å“ä¹Ÿä¸å¤§
- å³ä½¿æœ‰ç”¨æˆ·åœ¨è¶…é¢å‰çš„ç¬é—´å¤§é‡ä¸Šä¼ å›¾ç‰‡ï¼Œå¯¹ç³»ç»Ÿçš„å½±å“ä¹Ÿå¹¶ä¸å¤§ã€‚åç»­å¯ä»¥é€šè¿‡é™æµ + å®šæ—¶ä»»åŠ¡æ£€æµ‹ç©ºé—´ç­‰ç­–ç•¥ï¼Œå°½æ—©å‘ç°è¿™äº›ç‰¹æ®Šæƒ…å†µå†è¿›è¡Œå®šåˆ¶å¤„ç†ã€‚

è¿™æ ·ä¸€æ¥ï¼Œå°±åˆ©ç”¨ä¸šåŠ¡è®¾è®¡å·§å¦™èŠ‚çº¦äº†å¼€å‘æˆæœ¬ã€‚

1ï¼‰ä¿®æ”¹ uploadPicture æ–¹æ³•ï¼Œç¼–å†™æ ¡éªŒä»£ç ï¼Œåªéœ€è¦å¢åŠ  2 ä¸ªåˆ¤æ–­æ¡ä»¶ï¼š

```java
// ç©ºé—´æƒé™æ ¡éªŒ
Long spaceId = pictureUploadRequest.getSpaceId();
if (spaceId != null) {
    Space space = spaceService.getById(spaceId);
    ThrowUtils.throwIf(space == null, ErrorCode.NOT_FOUND_ERROR, "ç©ºé—´ä¸å­˜åœ¨");
    // å¿…é¡»ç©ºé—´åˆ›å»ºäººï¼ˆç®¡ç†å‘˜ï¼‰æ‰èƒ½ä¸Šä¼ 
    if (!loginUser.getId().equals(space.getUserId())) {
        throw new BusinessException(ErrorCode.NO_AUTH_ERROR, "æ²¡æœ‰ç©ºé—´æƒé™");
    }
    // æ ¡éªŒé¢åº¦
    if (space.getTotalCount() >= space.getMaxCount()) {
        throw new BusinessException(ErrorCode.OPERATION_ERROR, "ç©ºé—´æ¡æ•°ä¸è¶³");
    }
    if (space.getTotalSize() >= space.getMaxSize()) {
        throw new BusinessException(ErrorCode.OPERATION_ERROR, "ç©ºé—´å¤§å°ä¸è¶³");
    }
}
```

2ï¼‰ä¿å­˜å›¾ç‰‡è®°å½•æ—¶ï¼Œéœ€è¦ä½¿ç”¨äº‹åŠ¡æ›´æ–°é¢åº¦ï¼Œå¦‚æœé¢åº¦æ›´æ–°å¤±è´¥ï¼Œä¹Ÿä¸ç”¨å°†å›¾ç‰‡è®°å½•ä¿å­˜ã€‚

ä¾ç„¶æ˜¯ä½¿ç”¨ transactionTemplate äº‹åŠ¡ç®¡ç†å™¨ï¼Œå°†æ‰€æœ‰æ•°æ®åº“æ“ä½œåˆ°ä¸€èµ·å³å¯ï¼š

```java
// å¼€å¯äº‹åŠ¡
Long finalSpaceId = spaceId;
transactionTemplate.execute(status -> {
    boolean result = this.saveOrUpdate(picture);
    ThrowUtils.throwIf(!result, ErrorCode.OPERATION_ERROR, "å›¾ç‰‡ä¸Šä¼ å¤±è´¥");
    if (finalSpaceId != null) {
        boolean update = spaceService.lambdaUpdate()
                .eq(Space::getId, finalSpaceId)
                .setSql("totalSize = totalSize + " + picture.getPicSize())
                .setSql("totalCount = totalCount + 1")
                .update();
        ThrowUtils.throwIf(!update, ErrorCode.OPERATION_ERROR, "é¢åº¦æ›´æ–°å¤±è´¥");
    }
    return picture;
});
```

#### 2ã€åˆ é™¤å›¾ç‰‡åæ›´æ–°é¢åº¦

åˆ é™¤å›¾ç‰‡æ—¶ï¼Œè¦é‡Šæ”¾é¢åº¦ã€‚åŒæ ·ä½¿ç”¨ transactionTemplate äº‹åŠ¡ç®¡ç†å™¨ï¼Œå°†åˆ é™¤å›¾ç‰‡å’Œæ›´æ–°é¢åº¦çš„æ•°æ®åº“æ“ä½œè§†ä¸ºä¸€ä¸ªæ•´ä½“ï¼Œé¿å…åˆ é™¤å›¾ç‰‡åæ²¡é‡Šæ”¾é¢åº¦çš„æƒ…å†µã€‚

```java
// æ ¡éªŒæƒé™
checkPictureAuth(loginUser, oldPicture);
// å¼€å¯äº‹åŠ¡
transactionTemplate.execute(status -> {
    // æ“ä½œæ•°æ®åº“
    boolean result = this.removeById(pictureId);
    ThrowUtils.throwIf(!result, ErrorCode.OPERATION_ERROR);
    // é‡Šæ”¾é¢åº¦
    Long spaceId = oldPicture.getSpaceId();
    if (spaceId != null) {
        boolean update = spaceService.lambdaUpdate()
                .eq(Space::getId, spaceId)
                .setSql("totalSize = totalSize - " + oldPicture.getPicSize())
                .setSql("totalCount = totalCount - 1")
                .update();
        ThrowUtils.throwIf(!update, ErrorCode.OPERATION_ERROR, "é¢åº¦æ›´æ–°å¤±è´¥");
    }
    return true;
});
// å¼‚æ­¥æ¸…ç†æ–‡ä»¶
this.clearPictureFile(oldPicture);
```

æ³¨æ„ï¼Œè¿™é‡Œæœ‰å¯èƒ½å‡ºç°å¯¹è±¡å­˜å‚¨ä¸Šçš„å›¾ç‰‡æ–‡ä»¶å®é™…æ²¡è¢«æ¸…ç†çš„æƒ…å†µã€‚ä½†æ˜¯å¯¹äºç”¨æˆ·æ¥è¯´ï¼Œä¸åº”è¯¥æ„Ÿå—åˆ° â€œåˆ äº†å›¾ç‰‡ç©ºé—´å´æ²¡æœ‰å¢åŠ â€ï¼Œæ‰€ä»¥æ²¡æœ‰å°†è¿™ä¸€æ­¥æ·»åŠ åˆ°äº‹åŠ¡ä¸­ã€‚å¯ä»¥é€šè¿‡å®šæ—¶ä»»åŠ¡æ£€æµ‹ä½œä¸ºè¡¥å¿æªæ–½ã€‚

#### 3ã€æŸ¥è¯¢ç©ºé—´çº§åˆ«åˆ—è¡¨

æœ€åï¼Œæˆ‘ä»¬å†ç¼–å†™ä¸€ä¸ªæ¥å£ï¼Œç”¨äºç»™å‰ç«¯å±•ç¤ºæ‰€æœ‰çš„ç©ºé—´çº§åˆ«ä¿¡æ¯ã€‚

1ï¼‰æ–°å»º SpaceLevel å°è£…ç±»ï¼š

```java
@Data
@AllArgsConstructor
public class SpaceLevel {

    private int value;

    private String text;

    private long maxCount;

    private long maxSize;
}
```

2ï¼‰åœ¨ SpaceController ä¸­ç¼–å†™æ¥å£ï¼Œå°†æšä¸¾è½¬æ¢ä¸ºç©ºé—´çº§åˆ«å¯¹è±¡åˆ—è¡¨ï¼š

```java
@GetMapping("/list/level")
public BaseResponse<List<SpaceLevel>> listSpaceLevel() {
    List<SpaceLevel> spaceLevelList = Arrays.stream(SpaceLevelEnum.values()) // è·å–æ‰€æœ‰æšä¸¾
            .map(spaceLevelEnum -> new SpaceLevel(
                    spaceLevelEnum.getValue(),
                    spaceLevelEnum.getText(),
                    spaceLevelEnum.getMaxCount(),
                    spaceLevelEnum.getMaxSize()))
            .collect(Collectors.toList());
    return ResultUtils.success(spaceLevelList);
}
```

### æ‰©å±•

1ï¼‰åˆ é™¤ç©ºé—´æ—¶ï¼Œå…³è”åˆ é™¤ç©ºé—´å†…çš„å›¾ç‰‡

2ï¼‰ç®¡ç†å‘˜åˆ›å»ºç©ºé—´ï¼šç®¡ç†å‘˜å¯ä»¥ä¸ºæŒ‡å®šç”¨æˆ·åˆ›å»ºç©ºé—´ã€‚å¯ä»¥åœ¨åˆ›å»ºç©ºé—´æ—¶å¤šä¼ ä¸€ä¸ª userId å‚æ•°ï¼Œä½†æ˜¯è¦æ³¨æ„åšå¥½æƒé™æ§åˆ¶ï¼Œä»…ç®¡ç†å‘˜å¯ä»¥ä¸ºåˆ«äººåˆ›å»ºç©ºé—´ã€‚

3ï¼‰ç›®å‰æ›´æ–°ä¸Šä¼ å›¾ç‰‡çš„é€»è¾‘è¿˜æ˜¯å­˜åœ¨ä¸€äº›é—®é¢˜çš„ã€‚æ¯”å¦‚æ›´æ–°å›¾ç‰‡æ—¶ï¼Œå¹¶æ²¡æœ‰åˆ é™¤åŸæœ‰å›¾ç‰‡ã€ä¹Ÿæ²¡æœ‰å‡å°‘åŸæœ‰å›¾ç‰‡å ç”¨çš„ç©ºé—´å’Œé¢åº¦ï¼Œå¯ä»¥é€šè¿‡äº‹åŠ¡ä¸­è¡¥å……é€»è¾‘æˆ–è€…é€šè¿‡å®šæ—¶ä»»åŠ¡æ‰«æåˆ é™¤ã€‚

## å››ã€å‰ç«¯å¼€å‘

### ç©ºé—´ç®¡ç†é¡µé¢

é¦–å…ˆä»æœ€å¥½å¼€å‘çš„ç®¡ç†é¡µé¢åšèµ·ï¼Œæµç¨‹å’Œå…¶ä»–çš„ç®¡ç†é¡µé¢å®Œå…¨ä¸€è‡´ã€‚

#### 1ã€æ–°å»ºè·¯ç”±å’Œèœå•

é¦–å…ˆæ–°å»º `admin/SpaceManagePage.vue` é¡µé¢æ–‡ä»¶ï¼Œåœ¨ `router/index.ts` ä¸­å®šä¹‰è·¯ç”±ï¼š

```typescript
{
  path: '/admin/spaceManage',
  name: 'ç©ºé—´ç®¡ç†',
  component: SpaceManagePage,
},
```

åœ¨ GlobalHeader ç»„ä»¶ä¸­è¡¥å……èœå•ï¼š

```typescript
{
  key: '/admin/spaceManage',
  label: 'ç©ºé—´ç®¡ç†',
  title: 'ç©ºé—´ç®¡ç†',
},
```

ç”±äºä¹‹å‰å·²ç»ç¼–å†™äº†æƒé™æ ¡éªŒé€»è¾‘ï¼Œåœ°å€ä»¥ /admin å¼€å¤´çš„é¡µé¢éƒ½ä¼šé™åˆ¶ä¸ºä»…ç®¡ç†å‘˜å¯è§å’Œå¯ç”¨ï¼Œæ‰€ä»¥æ— éœ€å†ç¼–å†™é¢å¤–çš„æƒé™æ ¡éªŒä»£ç ã€‚

#### 2ã€å®šä¹‰ç©ºé—´å¸¸é‡

å’Œåç«¯ä¸€æ ·ï¼Œå‰ç«¯ä¹Ÿæœ‰å¾ˆå¤šåœ°æ–¹è¦ç”¨åˆ°ç©ºé—´çº§åˆ«ä¿¡æ¯ï¼Œå¯ä»¥å®šä¹‰ä¸ºä¸€ä¸ªå¸¸é‡ã€‚

åœ¨ `constants` ç›®å½•ä¸‹æ–°å»º space.ts å¸¸é‡æ–‡ä»¶ï¼Œå®šä¹‰æšä¸¾ä¿¡æ¯ã€å¯¹åº”çš„ä¸­æ–‡æ˜ å°„ã€ä»¥åŠåç»­ç­›é€‰ç©ºé—´çº§åˆ«æ—¶è¦ç”¨åˆ°çš„é€‰é¡¹æ•°ç»„ï¼š

```typescript
// ç©ºé—´çº§åˆ«æšä¸¾
export const SPACE_LEVEL_ENUM = {
  COMMON: 0,
  PROFESSIONAL: 1,
  FLAGSHIP: 2,
} as const;

// ç©ºé—´çº§åˆ«æ–‡æœ¬æ˜ å°„
export const SPACE_LEVEL_MAP: Record<number, string> = {
  0: 'æ™®é€šç‰ˆ',
  1: 'ä¸“ä¸šç‰ˆ',
  2: 'æ——èˆ°ç‰ˆ',
};

// ç©ºé—´çº§åˆ«é€‰é¡¹æ˜ å°„
export const SPACE_LEVEL_OPTIONS = Object.keys(SPACE_LEVEL_MAP).map((key) => {
  const value = Number(key); // Convert string key to number
  return {
    label: SPACE_LEVEL_MAP[value],
    value,
  };
});
```

ğŸ’¡ è¿™ç§ä»£ç å®Œå…¨å¯ä»¥åˆ©ç”¨ AI ç”Ÿæˆã€‚

#### 3ã€å¼€å‘ç®¡ç†é¡µé¢

è·Ÿç”¨æˆ·ç®¡ç†é¡µé¢ç±»ä¼¼ï¼Œé¡µé¢çš„ä¸Šæ–¹æ˜¯æœç´¢æ ï¼Œä¸‹æ–¹æ˜¯è¡¨æ ¼ï¼Œè¡¨æ ¼éœ€è¦æ”¯æŒåˆ†é¡µã€‚

å¤§å¤šæ•°çš„å†…å®¹å¯ä»¥ç›´æ¥å¤ç”¨å…¶ä»–ç®¡ç†é¡µé¢çš„ä»£ç ï¼Œå¯ä»¥å…ˆå¤åˆ¶è¿‡æ¥ï¼Œå†è¿›è¡Œä¿®æ”¹ã€‚

1ï¼‰ç»™è¡¨æ ¼å®šä¹‰å±•ç¤ºçš„åˆ—ï¼š

```typescript
const columns = [
  {
    title: 'id',
    dataIndex: 'id',
    width: 80,
  },
  {
    title: 'ç©ºé—´åç§°',
    dataIndex: 'spaceName',
  },
  {
    title: 'ç©ºé—´çº§åˆ«',
    dataIndex: 'spaceLevel',
  },
  {
    title: 'ä½¿ç”¨æƒ…å†µ',
    dataIndex: 'spaceUseInfo',
  },
  {
    title: 'ç”¨æˆ· id',
    dataIndex: 'userId',
    width: 80,
  },
  {
    title: 'åˆ›å»ºæ—¶é—´',
    dataIndex: 'createTime',
  },
  {
    title: 'ç¼–è¾‘æ—¶é—´',
    dataIndex: 'editTime',
  },
  {
    title: 'æ“ä½œ',
    key: 'action',
  },
]
```

2ï¼‰ä»åç«¯è·å–æ•°æ®ï¼Œå¹¶æ”¯æŒæœç´¢å’Œåˆ†é¡µï¼š

```typescript
// æ•°æ®
const dataList = ref([])
const total = ref(0)

// æœç´¢æ¡ä»¶
const searchParams = reactive<API.SpaceQueryRequest>({
  current: 1,
  pageSize: 10,
  sortField: 'createTime',
  sortOrder: 'descend',
})

// åˆ†é¡µå‚æ•°
const pagination = computed(() => {
  return {
    current: searchParams.current ?? 1,
    pageSize: searchParams.pageSize ?? 10,
    total: total.value,
    showSizeChanger: true,
    showTotal: (total) => `å…± ${total} æ¡`,
  }
})

// è·å–æ•°æ®
const fetchData = async () => {
  const res = await listSpaceByPageUsingPost({
    ...searchParams,
  })
  if (res.data.data) {
    dataList.value = res.data.data.records ?? []
    total.value = res.data.data.total ?? 0
  } else {
    message.error('è·å–æ•°æ®å¤±è´¥ï¼Œ' + res.data.message)
  }
}

// é¡µé¢åŠ è½½æ—¶è¯·æ±‚ä¸€æ¬¡
onMounted(() => {
  fetchData()
})

// è·å–æ•°æ®
const doSearch = () => {
  // é‡ç½®æœç´¢æ¡ä»¶
  searchParams.current = 1
  fetchData()
}

// è¡¨æ ¼å˜åŒ–å¤„ç†
const doTableChange = (page: any) => {
  searchParams.current = page.current
  searchParams.pageSize = page.pageSize
  fetchData()
}
```

æ³¨æ„ï¼šè·å–æ•°æ®æ—¶ï¼Œè°ƒç”¨çš„æ˜¯ä»…ç®¡ç†å‘˜å¯ç”¨çš„æŸ¥è¯¢æ¥å£ listSpaceByPageUsingPostï¼Œä¸æ˜¯ç»™ç”¨æˆ·ä½¿ç”¨çš„æŸ¥è¯¢åŒ…è£…ç±»æ¥å£ã€‚

3ï¼‰è‡ªå®šä¹‰åˆ—çš„å±•ç¤ºï¼Œæ¯”å¦‚ç©ºé—´çº§åˆ«ã€ä½¿ç”¨æƒ…å†µã€åˆ›å»ºæ—¶é—´ã€ç¼–è¾‘æ—¶é—´ç­‰ï¼š

```vue
<template #bodyCell="{ column, record }">
  <!-- ç©ºé—´çº§åˆ« -->
  <template v-if="column.dataIndex === 'spaceLevel'">
    <a-tag>{{ SPACE_LEVEL_MAP[record.spaceLevel] }}</a-tag>
  </template>
  <!-- ä½¿ç”¨æƒ…å†µ -->
  <template v-if="column.dataIndex === 'spaceUseInfo'">
    <div>å¤§å°ï¼š{{ formatSize(record.totalSize) }} / {{ formatSize(record.maxSize) }}</div>
    <div>æ•°é‡ï¼š{{ record.totalCount }} / {{ record.maxCount }}</div>
  </template>
  <template v-else-if="column.dataIndex === 'createTime'">
    {{ dayjs(record.createTime).format('YYYY-MM-DD HH:mm:ss') }}
  </template>
  <template v-else-if="column.dataIndex === 'editTime'">
    {{ dayjs(record.editTime).format('YYYY-MM-DD HH:mm:ss') }}
  </template>
  <template v-else-if="column.key === 'action'">
    <a-space wrap>
      <a-button type="link" :href="`/add_space?id=${record.id}`" target="_blank">
        ç¼–è¾‘
      </a-button>
      <a-button type="link" danger @click="doDelete(record.id)">åˆ é™¤</a-button>
    </a-space>
  </template>
</template>
```

4ï¼‰å¼€å‘æœç´¢è¡¨å•ï¼Œæ”¯æŒæŒ‰ç…§ç©ºé—´åç§°ã€ç©ºé—´çº§åˆ«ã€ç”¨æˆ· id æœç´¢ï¼š

```vue
<a-form layout="inline" :model="searchParams" @finish="doSearch">
  <a-form-item label="ç©ºé—´åç§°" name="spaceName">
    <a-input v-model:value="searchParams.spaceName" placeholder="è¯·è¾“å…¥ç©ºé—´åç§°" allow-clear />
  </a-form-item>
  <a-form-item label="ç©ºé—´çº§åˆ«" name="spaceLevel">
    <a-select
      v-model:value="searchParams.spaceLevel"
      :options="SPACE_LEVEL_OPTIONS"
      placeholder="è¯·è¾“å…¥ç©ºé—´çº§åˆ«"
      style="min-width: 180px"
      allow-clear
    />
  </a-form-item>
  <a-form-item label="ç”¨æˆ· id" name="userId">
    <a-input v-model:value="searchParams.userId" placeholder="è¯·è¾“å…¥ç”¨æˆ· id" allow-clear />
  </a-form-item>
  <a-form-item>
    <a-button type="primary" html-type="submit">æœç´¢</a-button>
  </a-form-item>
</a-form>
```

5ï¼‰è¡¥å……æ“ä½œæŒ‰é’®ã€‚

å¯ä»¥åœ¨æœç´¢è¡¨å•ä¸Šæ–°å¢ä¸€è¡Œï¼Œå±•ç¤ºæ ‡é¢˜å’Œåˆ›å»ºç©ºé—´æŒ‰é’®ï¼Œç‚¹å‡»æŒ‰é’®ä¼šæ‰“å¼€åˆ›å»ºç©ºé—´é¡µé¢ï¼š

```vue
<a-flex justify="space-between">
  <h2>ç©ºé—´ç®¡ç†</h2>
  <a-space>
    <a-button type="primary" href="/add_space" target="_blank">+ åˆ›å»ºç©ºé—´</a-button>
  </a-space>
</a-flex>
```

åœ¨è¡¨æ ¼æ“ä½œåˆ—ä¸­ï¼Œä¹Ÿè¦è¡¥å……ç¼–è¾‘æŒ‰é’®ï¼Œç‚¹å‡»åæ‰“å¼€ç¼–è¾‘ç©ºé—´é¡µé¢ï¼š

```vue
<a-space wrap>
  <a-button type="link" :href="`/add_space?id=${record.id}`" target="_blank">
    ç¼–è¾‘
  </a-button>
  <a-button type="link" danger @click="doDelete(record.id)">åˆ é™¤</a-button>
</a-space>
```

æœ€ç»ˆé¡µé¢æ•ˆæœå¦‚å›¾ï¼š

![img](./assets/PEwuV8ABsyMKKnbY.webp)

### åˆ›å»ºç©ºé—´é¡µé¢

#### 1ã€æ–°å»ºè·¯ç”±

é¦–å…ˆæ–°å»º `AddSpacePage.vue` é¡µé¢æ–‡ä»¶ï¼Œåœ¨ `router/index.ts` ä¸­å®šä¹‰è·¯ç”±ï¼š

```typescript
{
  path: '/add_space',
  name: 'åˆ›å»ºç©ºé—´',
  component: AddSpacePage,
},
```

#### 2ã€å¼€å‘è¡¨å•

è¯¥é¡µé¢çš„ä¸»ä½“æ˜¯è¡¨å•ï¼Œå¯ä»¥ç›´æ¥å¤åˆ¶æ‰¹é‡åˆ›å»ºå›¾ç‰‡é¡µé¢ï¼Œç•¥ä½œä¿®æ”¹å³å¯ã€‚

1ï¼‰å…ˆä¿®æ”¹è¡¨å•é¡¹ï¼Œå…è®¸å¡«å†™ç©ºé—´åç§°ã€ç©ºé—´çº§åˆ«ï¼š

```vue
<a-form layout="vertical" :model="formData" @finish="handleSubmit">
  <a-form-item label="ç©ºé—´åç§°" name="spaceName">
    <a-input v-model:value="formData.spaceName" placeholder="è¯·è¾“å…¥ç©ºé—´åç§°" allow-clear />
  </a-form-item>
  <a-form-item label="ç©ºé—´çº§åˆ«" name="spaceLevel">
    <a-select
      v-model:value="formData.spaceLevel"
      :options="SPACE_LEVEL_OPTIONS"
      placeholder="è¯·è¾“å…¥ç©ºé—´çº§åˆ«"
      style="min-width: 180px"
      allow-clear
    />
  </a-form-item>
  <a-form-item>
    <a-button type="primary" html-type="submit" style="width: 100%" :loading="loading">
      æäº¤
    </a-button>
  </a-form-item>
</a-form>
```

2ï¼‰å®šä¹‰è¡¨å•é¡¹ç»“æ„å’Œ loading å˜é‡ï¼š

```typescript
const formData = reactive<API.SpaceAddRequest | API.SpaceUpdateRequest>({
  spaceName: '',
  spaceLevel: SPACE_LEVEL_ENUM.COMMON,
})
const loading = ref(false)
```

3ï¼‰ç¼–å†™æäº¤å‡½æ•°ï¼Œåˆ›å»ºæˆåŠŸåä¼šè¾“å‡ºä¿¡æ¯å¹¶è·³è½¬åˆ°æ–°åˆ›å»ºçš„ç©ºé—´è¯¦æƒ…é¡µï¼š

```typescript
const handleSubmit = async (values: any) => {
  loading.value = true;
  const res = await addSpaceUsingPost({
    ...formData,
  })
  if (res.data.code === 0 && res.data.data) {
    message.success("åˆ›å»ºæˆåŠŸ")
    router.push({
      path: `/space/${res.data.data}`,
    })
  } else {
    message.error('åˆ›å»ºå¤±è´¥ï¼Œ' + res.data.message)
  }
  loading.value = false;
}
```

#### 3ã€å±•ç¤ºç©ºé—´çº§åˆ«ä¿¡æ¯

æ— è®ºæ˜¯ç”¨æˆ·å’Œç®¡ç†å‘˜ï¼Œéƒ½éœ€è¦äº†è§£ç©ºé—´çº§åˆ«ä¿¡æ¯ï¼›è€Œä¸”ç›®å‰ç”¨æˆ·åªèƒ½å¼€é€šæ™®é€šç‰ˆç©ºé—´ï¼Œè¿™ä¸ªä¿¡æ¯ä¹Ÿè¦åŒæ­¥ç»™ç”¨æˆ·ã€‚ç”±äºç³»ç»Ÿä¸æ”¯æŒæ”¯ä»˜ï¼Œå¯ä»¥å…ˆè®©æœ‰éœ€æ±‚çš„ç”¨æˆ·ä¸»åŠ¨è”ç³»ç®¡ç†å‘˜ï¼Œè¿™æ˜¯æœ€å¿«çš„ç›ˆåˆ©æ–¹å¼ã€‚

æ‰€ä»¥å¯ä»¥åœ¨è¡¨å•ä¸‹æ–°å¢å±•ç¤ºè¿™äº›ä¿¡æ¯çš„å¡ç‰‡ã€‚

1ï¼‰å…ˆåˆ©ç”¨ç»„ä»¶åº“çš„ [å¡ç‰‡ç»„ä»¶](https://antdv.com/components/card-cn) å¼€å‘é¡µé¢å†…å®¹ï¼š

```vue
<a-card title="ç©ºé—´çº§åˆ«ä»‹ç»">
  <a-typography-paragraph>
    * ç›®å‰ä»…æ”¯æŒå¼€é€šæ™®é€šç‰ˆï¼Œå¦‚éœ€å‡çº§ç©ºé—´ï¼Œè¯·è”ç³»
    <a href="https://codefather.cn" target="_blank">ç¨‹åºå‘˜é±¼çš®</a>ã€‚
  </a-typography-paragraph>
  <a-typography-paragraph v-for="spaceLevel in spaceLevelList">
    {{ spaceLevel.text }}ï¼š å¤§å° {{ formatSize(spaceLevel.maxSize) }}ï¼Œ æ•°é‡
    {{ spaceLevel.maxCount }}
  </a-typography-paragraph>
</a-card>
```

2ï¼‰è¯·æ±‚åç«¯è·å–ç©ºé—´çº§åˆ«åˆ—è¡¨ï¼š

```typescript
const spaceLevelList = ref<API.SpaceLevel[]>([])

// è·å–ç©ºé—´çº§åˆ«
const fetchSpaceLevelList = async () => {
  const res = await listSpaceLevelUsingGet()
  if (res.data.code === 0 && res.data.data) {
    spaceLevelList.value = res.data.data
  } else {
    message.error('åŠ è½½ç©ºé—´çº§åˆ«å¤±è´¥ï¼Œ' + res.data.message)
  }
}

onMounted(() => {
  fetchSpaceLevelList()
})
```

æ•ˆæœå¦‚å›¾ï¼š

![img](./assets/IHSfC3ITxeaM1I04.webp)

#### 4ã€æ›´æ–°ç©ºé—´é¡µé¢

ä»…ç®¡ç†å‘˜å¯ä»¥æ›´æ–°ç©ºé—´ï¼Œä»ç©ºé—´ç®¡ç†é¡µé¢å¯ä»¥è·³è½¬åˆ°ç¼–è¾‘ç©ºé—´é¡µé¢ã€‚ç”±äºç¼–è¾‘é¡µé¢å’Œåˆ›å»ºé¡µé¢éƒ½æ˜¯è¡¨å•é¡¹ï¼Œç»“æ„ä¸€è‡´ï¼Œå¯ä»¥å¤ç”¨åˆ›å»ºé¡µé¢ã€‚

1ï¼‰è·Ÿä¹‹å‰å¼€å‘çš„ä¸Šä¼ å›¾ç‰‡é¡µé¢ç±»ä¼¼ï¼Œå¯ä»¥åˆ©ç”¨ url çš„ querystring ä¼ é€’è¦ä¿®æ”¹çš„ spaceId å‚æ•°ï¼Œåœ¨é¡µé¢ä¸­è·å–åˆ°å·²æœ‰ç©ºé—´æ•°æ®å¹¶å¡«å……è¡¨å•é¡¹ã€‚

```typescript
const route = useRoute()
const oldSpace = ref<API.SpaceVO>()

// è·å–è€æ•°æ®
const getOldSpace = async () => {
  // è·å–æ•°æ®
  const id = route.query?.id
  if (id) {
    const res = await getSpaceVoByIdUsingGet({
      id: id,
    })
    if (res.data.code === 0 && res.data.data) {
      const data = res.data.data
      oldSpace.value = data
      formData.spaceName = data.spaceName
      formData.spaceLevel = data.spaceLevel
    }
  }
}

// é¡µé¢åŠ è½½æ—¶ï¼Œè¯·æ±‚è€æ•°æ®
onMounted(() => {
  getOldSpace()
})
```

2ï¼‰ä¿®æ”¹æäº¤å‡½æ•°ï¼Œæ ¹æ®æ˜¯å¦æœ‰ spaceId å†³å®šæ˜¯è°ƒç”¨æ›´æ–°æ¥å£è¿˜æ˜¯åˆ›å»ºæ¥å£ï¼š

```typescript
const handleSubmit = async (values: any) => {
  const spaceId = oldSpace.value?.id
  loading.value = true
  let res
  // æ›´æ–°
  if (spaceId) {
    res = await updateSpaceUsingPost({
      id: spaceId,
      ...formData,
    })
  } else {
    // åˆ›å»º
    res = await addSpaceUsingPost({
      ...formData,
    })
  }
  if (res.data.code === 0 && res.data.data) {
    message.success('æ“ä½œæˆåŠŸ')
    let path = `/space/${spaceId ?? res.data.data}`
    router.push({
      path,
    })
  } else {
    message.error('æ“ä½œå¤±è´¥ï¼Œ' + res.data.message)
  }
  loading.value = false
}
```

#### æ‰©å±•

1ï¼‰æ”¯æŒç®¡ç†å‘˜å¡«å†™ç©ºé—´å¤§å°ã€ç©ºé—´æ¡æ•°ï¼Œä»è€Œå®ç°ç±»ä¼¼ â€œèµ„æºæ‰©å®¹åŒ…â€ çš„åŠŸèƒ½ã€‚

2ï¼‰é€‰æ‹©ç©ºé—´çº§åˆ«æ—¶è‡ªåŠ¨å¡«å……ç©ºé—´å¤§å°ã€ç©ºé—´æ¡æ•°è¿™ä¸¤ä¸ªè¡¨å•é¡¹ã€‚

### ç”¨æˆ·åˆ›å»ºç§æœ‰ç©ºé—´

ç°åœ¨å·²ç»æœ‰äº†åˆ›å»ºç©ºé—´çš„é¡µé¢ï¼Œåªéœ€è¦è¡¥å……è¿›å…¥åˆ°è¯¥é¡µé¢çš„å…¥å£å³å¯ã€‚

#### 1ã€å±•ç¤ºç§æœ‰ç©ºé—´å…¥å£

é¢„æœŸæ•ˆæœæ˜¯ï¼šå·¦ä¾§æ–°å¢ç›®å½•æ ï¼Œå±•ç¤º â€œå…¬å…±å›¾åº“â€ å’Œ â€œæˆ‘çš„ç©ºé—´â€ èœå•é¡¹ï¼Œç‚¹å‡» â€œæˆ‘çš„ç©ºé—´â€ åï¼Œå¦‚æœæ²¡æœ‰åˆ›å»ºè¿‡ç©ºé—´ï¼Œåˆ™è‡ªåŠ¨è·³è½¬åˆ°åˆ›å»ºç©ºé—´é¡µé¢ã€‚

1ï¼‰å¯ä»¥åŸºäºç»„ä»¶åº“çš„ [Layout Sider ç»„ä»¶](https://antdv.com/components/layout-cn#components-layout-demo-top-side-2) å®ç° â€œé¡¶éƒ¨ - ä¾§è¾¹å¸ƒå±€â€ï¼š

![img](./assets/5pm36bIIoxUC1SBu.webp)

è·Ÿ GlobalHeader å…¨å±€é¡¶éƒ¨æ ç»„ä»¶ä¸€æ ·ï¼Œæˆ‘ä»¬å•ç‹¬å°è£…ä¸€ä¸ª GlobalSider å…¨å±€ä¾§è¾¹æ ç»„ä»¶ï¼Œåœ¨ Sider ç»„ä»¶å†…ä½¿ç”¨ [å†…åµŒèœå•ç»„ä»¶](https://antdv.com/components/menu-cn#components-menu-demo-inline)ï¼Œå…ˆåˆ©ç”¨ Demo æŠŠé¡µé¢ç»“æ„æ’‘èµ·æ¥ï¼š

```vue
<div id="globalSider">
  <a-layout-sider class="sider" width="200">
    <a-menu
      mode="inline"
      v-model:selectedKeys="current"
      :items="menuItems"
      @click="doMenuClick"
    />
  </a-layout-sider>
</div>
```

åœ¨ BasicLayout å…¨å±€å¸ƒå±€ä¸­å¼•å…¥ä¾§è¾¹æ ç»„ä»¶ï¼š

```vue
<a-layout>
  <GlobalSider class="sider" />
  <a-layout-content class="content">
    <router-view />
  </a-layout-content>
</a-layout>
```

ä¼˜åŒ–ä¸€ä¸‹æ ·å¼ï¼Œéšè—å¤šä½™çš„è¾¹æ¡†ï¼Œä¸‹åˆ—ä»£ç ä»…å±•ç¤ºäº†æ–°å¢æˆ–ä¿®æ”¹çš„æ ·å¼ï¼š

```css
#basicLayout .header {
  margin-bottom: 1px;
}

#basicLayout .content {
  padding: 28px;
}

#basicLayout .sider {
  background: #fff;
  padding-top: 20px;
  border-right: 0.5px solid #eee;
}

#basicLayout :deep(.ant-menu-root) {
  border-bottom: none !important;
  border-inline-end: none !important;
}
```

2ï¼‰å¼€å‘ GlobalSider ç»„ä»¶ã€‚è·Ÿ GlobalHeader ç»„ä»¶ä¸€æ ·ï¼Œéœ€è¦å®šä¹‰èœå•é¡¹ã€å®ç°ç‚¹å‡»è·³è½¬ã€æ ¹æ®è·¯ç”±è‡ªåŠ¨é«˜äº®ã€‚

```typescript
// èœå•åˆ—è¡¨
const menuItems = [
  {
    key: '/',
    label: 'å…¬å…±å›¾åº“',
    icon: () => h(PictureOutlined),
  },
  {
    key: '/my_space',
    label: 'æˆ‘çš„ç©ºé—´',
    icon: () => h(UserOutlined),
  },
]

const router = useRouter()

// å½“å‰é€‰ä¸­èœå•
const current = ref<string[]>([])
// ç›‘å¬è·¯ç”±å˜åŒ–ï¼Œæ›´æ–°å½“å‰é€‰ä¸­èœå•
router.afterEach((to, from, failure) => {
  current.value = [to.path]
})

// è·¯ç”±è·³è½¬äº‹ä»¶
const doMenuClick = ({ key }: { key: string }) => {
  router.push({
    path: key,
  })
}
```

3ï¼‰ä¼˜åŒ–ä¾§è¾¹æ çš„å±•ç¤º

å¯ä»¥ç»™ç»„ä»¶å¢åŠ æ¡ä»¶åˆ¤æ–­ï¼Œå¦‚æœç”¨æˆ·æœªç™»å½•ï¼Œåˆ™ä¸ç”¨æ˜¾ç¤ºä¾§è¾¹æ ï¼š

```vue
<a-layout-sider v-if="loginUserStore.loginUser.id" class="sider" width="200">
</a-layout-sider>
const loginUserStore = useLoginUserStore()
```

è¿˜å¯ä»¥ä½¿ç”¨ [å“åº”å¼å¸ƒå±€](https://antdv.com/components/layout-cn#components-layout-demo-responsive)ï¼Œå±å¹•å°ºå¯¸å°äº `lg` æ—¶ï¼Œè‡ªåŠ¨æŠ˜å ä¾§è¾¹æ ï¼š

```vue
<a-layout-sider v-if="loginUserStore.loginUser.id" 
  class="sider"
  width="200" 
  breakpoint="lg"
  collapsed-width="0"
>
</a-layout-sider>
```

æ•ˆæœå¦‚å›¾ï¼š

![img](./assets/9jpjNzqRNQOTPC8y.webp)

![img](./assets/iR6y96RCggpH49gS.webp)

4ï¼‰å¯ä»¥åœ¨ GlobalHeader å³è¾¹å¤´åƒçš„ä¸‹æ‹‰èœå•ä¸­ä¹Ÿæ·»åŠ  â€œæˆ‘çš„ç©ºé—´â€ è·³è½¬ï¼š

```vue
<a-menu-item>
  <router-link to="/my_space">
    <UserOutlined />
    æˆ‘çš„ç©ºé—´
  </router-link>
</a-menu-item>
```

#### 2ã€æˆ‘çš„ç©ºé—´é¡µé¢

æˆ‘çš„ç©ºé—´é¡µé¢æ˜¯ä¸€ä¸ª â€œä¸­é—´é¡µâ€ï¼Œä½œç”¨æ˜¯æ ¹æ®ç”¨æˆ·æ˜¯å¦å·²æœ‰ç©ºé—´ï¼Œ**é‡å®šå‘** åˆ°å¯¹åº”çš„é¡µé¢ã€‚

å…ˆæ¢³ç†ä¸šåŠ¡æµç¨‹ï¼Œè·³è½¬åˆ°è¯¥é¡µé¢æ—¶ï¼š

- ç”¨æˆ·æœªç™»å½•ï¼Œåˆ™ç›´æ¥è·³è½¬åˆ°ç™»å½•é¡µé¢
- å¦‚æœç”¨æˆ·å·²ç™»å½•ï¼Œä¼šè·å–è¯¥ç”¨æˆ·å·²åˆ›å»ºçš„ç©ºé—´
- å¦‚æœæœ‰ï¼Œåˆ™è¿›å…¥ç¬¬ä¸€ä¸ªç©ºé—´
- å¦‚æœæ²¡æœ‰ï¼Œåˆ™è·³è½¬åˆ°åˆ›å»ºç©ºé—´é¡µé¢

1ï¼‰æ–°å»ºæ–‡ä»¶å’Œè·¯ç”±ï¼š

```typescript
{
  path: '/my_space',
  name: 'æˆ‘çš„ç©ºé—´',
  component: MySpacePage,
},
```

2ï¼‰ç¼–å†™é¡µé¢ï¼š

```vue
<template>
  <div id="mySpace">
    <p>æ­£åœ¨è·³è½¬ï¼Œè¯·ç¨å€™...</p>
  </div>
</template>

<script setup lang="ts">
import { onMounted } from 'vue'
import { useRouter } from 'vue-router'
import { listSpaceVoByPageUsingPost } from '@/api/spaceController'
import { message } from 'ant-design-vue'
import { useLoginUserStore } from '@/stores/useLoginUserStore'

const router = useRouter()
const loginUserStore = useLoginUserStore()

// æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰ä¸ªäººç©ºé—´
const checkUserSpace = async () => {
  const loginUser = loginUserStore.loginUser
  if (!loginUser?.id) {
    router.replace('/user/login')
    return
  }
  // è·å–ç”¨æˆ·ç©ºé—´ä¿¡æ¯
  const res = await listSpaceVoByPageUsingPost({
    userId: loginUser.id,
    current: 1,
    pageSize: 1,
  })
  if (res.data.code === 0) {
    if (res.data.data?.records?.length > 0) {
      const space = res.data.data.records[0]
      router.replace(`/space/${space.id}`)
    } else {
      router.replace('/add_space')
      message.warn('è¯·å…ˆåˆ›å»ºç©ºé—´')
    }
  } else {
    message.error('åŠ è½½æˆ‘çš„ç©ºé—´å¤±è´¥ï¼Œ' + res.data.message)
  }
}

// åœ¨é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç”¨æˆ·ç©ºé—´
onMounted(() => {
  checkUserSpace()
})
</script>
```

ä¸Šè¿°ä»£ç çš„æ ¸å¿ƒæ˜¯ checkUserSpace å‡½æ•°ï¼Œåœ¨é¡µé¢åŠ è½½æ—¶ä¼šæ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç™»å½•ã€æ˜¯å¦å·²æœ‰ç©ºé—´ï¼Œå¹¶ä½¿ç”¨ `router.replace` é‡å®šå‘é¡µé¢ï¼Œè¿™æ ·ç‚¹å‡»æµè§ˆå™¨çš„åé€€æŒ‰é’®æ—¶ï¼Œä¸ä¼šå›åˆ°ä¸­é—´é¡µã€‚

#### æ‰©å±•

å‚è€ƒ [ç»„ä»¶åº“çš„ Demo](https://antdv.com/components/layout-cn#components-layout-demo-fixed-sider)ï¼Œå›ºå®šå…¨å±€ä¾§è¾¹æ å’Œå…¨å±€é¡¶éƒ¨æ ï¼š

![img](./assets/LI8PRdAF7lGreerP.webp)

### ç”¨æˆ·ä½¿ç”¨ç§æœ‰ç©ºé—´ï¼ˆç©ºé—´è¯¦æƒ…é¡µï¼‰

ç©ºé—´è¯¦æƒ…é¡µä¸»è¦æ˜¯å±•ç¤ºç©ºé—´ä¿¡æ¯ã€å¹¶å±•ç¤ºç©ºé—´å†…çš„å›¾ç‰‡åˆ—è¡¨ï¼Œå…¶ç»“æ„å’Œå…¬å¼€å›¾åº“çš„ä¸»é¡µéå¸¸ç›¸ä¼¼ï¼Œå¯ä»¥å¤ç”¨ç»„ä»¶ã€‚

#### 1ã€å°è£…å›¾ç‰‡åˆ—è¡¨ç»„ä»¶

å…ˆå°è£…å›¾ç‰‡åˆ—è¡¨ç»„ä»¶ PictureListï¼Œè¯¥ç»„ä»¶åªè´Ÿè´£æ•°æ®çš„å±•ç¤ºã€ä¸è´Ÿè´£æ•°æ®çš„æŸ¥è¯¢ï¼Œå› æ­¤è¦æŠŠåˆ†é¡µç»„ä»¶å•ç‹¬æ‹‰å‡ºæ¥ã€‚

1ï¼‰å¼€å‘å›¾ç‰‡åˆ—è¡¨ç»„ä»¶ï¼Œå¤§å¤šæ•°çš„ä»£ç éƒ½æ˜¯ä»ä¸»é¡µå¤åˆ¶æ¥çš„ï¼Œå…³é”®æ˜¯å®šä¹‰å±æ€§ï¼Œæ¥å— dataList æ•°æ®åˆ—è¡¨å’Œ loading åŠ è½½çŠ¶æ€ï¼š

```vue
<template>
  <div class="picture-list">
    <!-- å›¾ç‰‡åˆ—è¡¨ -->
    <a-list
      :grid="{ gutter: 16, xs: 1, sm: 2, md: 3, lg: 4, xl: 5, xxl: 6 }"
      :data-source="dataList"
      :loading="loading"
    >
      <template #renderItem="{ item: picture }">
        <a-list-item style="padding: 0">
          <!-- å•å¼ å›¾ç‰‡ -->
          <a-card hoverable @click="doClickPicture(picture)">
            <template #cover>
              <img
                style="height: 180px; object-fit: cover"
                :alt="picture.name"
                :src="picture.thumbnailUrl ?? picture.url"
                loading="lazy"
              />
            </template>
            <a-card-meta :title="picture.name">
              <template #description>
                <a-flex>
                  <a-tag color="green">
                    {{ picture.category ?? 'é»˜è®¤' }}
                  </a-tag>
                  <a-tag v-for="tag in picture.tags" :key="tag">
                    {{ tag }}
                  </a-tag>
                </a-flex>
              </template>
            </a-card-meta>
          </a-card>
        </a-list-item>
      </template>
    </a-list>
  </div>
</template>

<script setup lang="ts">
import { useRouter } from 'vue-router'

interface Props {
  dataList?: API.PictureVO[]
  loading?: boolean
}

const props = withDefaults(defineProps<Props>(), {
  dataList: () => [],
  loading: false,
})

// è·³è½¬è‡³å›¾ç‰‡è¯¦æƒ…
const router = useRouter()
const doClickPicture = (picture) => {
  router.push({
    path: `/picture/${picture.id}`,
  })
}
</script>

<style scoped></style>
```

2ï¼‰ä¿®æ”¹ä¸»é¡µçš„å›¾ç‰‡åˆ—è¡¨ä»£ç ï¼Œä½¿ç”¨å›¾ç‰‡åˆ—è¡¨ç»„ä»¶ï¼Œå¹¶è¡¥å…… [åˆ†é¡µç»„ä»¶](https://antdv.com/components/pagination-cn)ï¼š

```vue
<!-- å›¾ç‰‡åˆ—è¡¨ -->
<PictureList :dataList="dataList" :loading="loading" />
<a-pagination
  style="text-align: right"
  v-model:current="searchParams.current"
  v-model:pageSize="searchParams.pageSize"
  :total="total"
  @change="onPageChange"
/>
```

#### 2ã€å¼€å‘ç©ºé—´è¯¦æƒ…é¡µ

è¯¥é¡µé¢çš„ç»“æ„æ˜¯ï¼šç©ºé—´ä¿¡æ¯ + å±•ç¤ºç©ºé—´ä¸‹çš„å›¾ç‰‡åˆ—è¡¨

1ï¼‰æ–°å»º `SpaceDetailPage.vue` å’Œè·¯ç”±ï¼Œè·Ÿå›¾ç‰‡è¯¦æƒ…é¡µç±»ä¼¼ï¼Œè·¯ç”±è¦èƒ½æ¥å—åŠ¨æ€å‚æ•°ï¼Œè¡¨ç¤ºè¦åŠ è½½çš„ç©ºé—´ idï¼š

```typescript
{
  path: '/space/:id',
  name: 'ç©ºé—´è¯¦æƒ…',
  component: SpaceDetailPage,
  props: true,
},
```

2ï¼‰ç¼–å†™é¡µé¢è„šæœ¬ï¼Œä¸»è¦æ˜¯è·å–ç©ºé—´è¯¦æƒ…æ•°æ®å’Œè·å–ç©ºé—´ä¸‹çš„å›¾ç‰‡åˆ—è¡¨æ•°æ®ï¼š

```typescript
const props = defineProps<{
  id: string | number
}>()
const space = ref<API.SpaceVO>({})

// è·å–ç©ºé—´è¯¦æƒ…
const fetchSpaceDetail = async () => {
  try {
    const res = await getSpaceVoByIdUsingGet({
      id: props.id,
    })
    if (res.data.code === 0 && res.data.data) {
      space.value = res.data.data
    } else {
      message.error('è·å–ç©ºé—´è¯¦æƒ…å¤±è´¥ï¼Œ' + res.data.message)
    }
  } catch (e: any) {
    message.error('è·å–ç©ºé—´è¯¦æƒ…å¤±è´¥ï¼š' + e.message)
  }
}

onMounted(() => {
  fetchSpaceDetail()
})

// æ•°æ®
const dataList = ref([])
const total = ref(0)
const loading = ref(true)

// æœç´¢æ¡ä»¶
const searchParams = reactive<API.PictureQueryRequest>({
  current: 1,
  pageSize: 12,
  sortField: 'createTime',
  sortOrder: 'descend',
})

// åˆ†é¡µå‚æ•°
const onPageChange = (page, pageSize) => {
  searchParams.current = page
  searchParams.pageSize = pageSize
  fetchData()
}

// è·å–æ•°æ®
const fetchData = async () => {
  loading.value = true
  // è½¬æ¢æœç´¢å‚æ•°
  const params = {
    spaceId: props.id,
    ...searchParams,
  }
  const res = await listPictureVoByPageUsingPost(params)
  if (res.data.data) {
    dataList.value = res.data.data.records ?? []
    total.value = res.data.data.total ?? 0
  } else {
    message.error('è·å–æ•°æ®å¤±è´¥ï¼Œ' + res.data.message)
  }
  loading.value = false
}

// é¡µé¢åŠ è½½æ—¶è¯·æ±‚ä¸€æ¬¡
onMounted(() => {
  fetchData()
})
```

3ï¼‰å¼€å‘ç©ºé—´ä¿¡æ¯å±•ç¤ºæ ï¼Œå±•ç¤ºç©ºé—´åç§°ï¼Œå¹¶ä½¿ç”¨ [è¿›åº¦æ¡ç»„ä»¶](https://antdv.com/components/progress-cn/#components-progress-demo-circle-mini) å±•ç¤ºç©ºé—´é™é¢ï¼š

```vue
<!-- ç©ºé—´ä¿¡æ¯ -->
<a-flex justify="space-between">
  <h2>{{ space.spaceName }}ï¼ˆç§æœ‰ç©ºé—´ï¼‰</h2>
  <a-space size="middle">
    <a-button type="primary" :href="`/add_picture?spaceId=${id}`" target="_blank">
      + åˆ›å»ºå›¾ç‰‡
    </a-button>
    <a-tooltip
      :title="`å ç”¨ç©ºé—´ ${formatSize(space.totalSize)} / ${formatSize(space.maxSize)}`"
    >
      <a-progress
        type="circle"
        :percent="((space.totalSize * 100) / space.maxSize).toFixed(1)"
        :size="42"
      />
    </a-tooltip>
  </a-space>
</a-flex>
```

4ï¼‰å¼€å‘å›¾ç‰‡åˆ—è¡¨å’Œåˆ†é¡µï¼Œç›´æ¥ä½¿ç”¨å·²å°è£…çš„ç»„ä»¶ï¼š

```vue
<!-- å›¾ç‰‡åˆ—è¡¨ -->
<PictureList :dataList="dataList" :loading="loading" />
<a-pagination
  style="text-align: right"
  v-model:current="searchParams.current"
  v-model:pageSize="searchParams.pageSize"
  :total="total"
  :show-total="() => `å›¾ç‰‡æ€»æ•° ${total} / ${space.maxCount}`"
  @change="onPageChange"
/>
```

åœ¨åˆ†é¡µç»„ä»¶ä¸­ï¼Œæˆ‘ä»¬è¦å±•ç¤ºå›¾ç‰‡æ€»æ•°å’Œæœ€å¤§æ•°é‡ï¼Œè®©ç”¨æˆ·çŸ¥æ™“ã€‚

æ•ˆæœå¦‚å›¾ï¼š

![img](./assets/p8h1m2PrBhfdMLHc.webp)

å·²ç»èƒ½å¤ŸæŸ¥çœ‹ç§æœ‰ç©ºé—´è¯¦æƒ…äº†ï¼Œæˆ‘ä»¬å†ä¾æ¬¡å¼€å‘å¯¹ç©ºé—´å†…å›¾ç‰‡çš„ â€œå¢åˆ æ”¹æŸ¥â€ æ“ä½œã€‚

#### 3ã€ä¸Šä¼ å›¾ç‰‡åˆ°ç§æœ‰ç©ºé—´

1ï¼‰ä¿®æ”¹åˆ›å»ºå›¾ç‰‡é¡µé¢ï¼Œæ”¯æŒé€šè¿‡ url æŸ¥è¯¢å‚æ•°ä¸­çš„ spaceId ä¼ å‚ï¼Œåœ¨é¡µé¢ä¸­å¯ä»¥è·å–åˆ° spaceIdï¼š

```typescript
// ç©ºé—´ id
const spaceId = computed(() => {
  return route.query?.spaceId
})
```

2ï¼‰æäº¤æ—¶ï¼Œè¡¥å…… spaceId å‚æ•°ï¼š

```typescript
const res = await editPictureUsingPost({
  id: pictureId,
  spaceId: spaceId.value,
  ...values,
})
```

3ï¼‰åœ¨é¡µé¢ä¸­å±•ç¤ºå½“å‰çš„ spaceIdï¼š

```vue
<a-typography-paragraph v-if="spaceId" type="secondary">
  ä¿å­˜è‡³ç©ºé—´ï¼š<a :href="`/space/${spaceId}`" target="_blank">{{ spaceId }}</a>
</a-typography-paragraph>
```

4ï¼‰ä¿®æ”¹å›¾ç‰‡ä¸Šä¼ ç»„ä»¶**ï¼ˆåŒ…æ‹¬æœ¬åœ°æ–‡ä»¶ä¸Šä¼ å’Œ URL ä¸Šä¼ ï¼‰**ï¼Œæ”¯æŒä¸Šä¼ æ—¶ä¼ é€’ spaceIdï¼š

```typescript
interface Props {
  picture?: API.PictureVO
  spaceId?: number
  onSuccess?: (newPicture: API.PictureVO) => void
}

// ä¸Šä¼ æ—¶ä¼ é€’ spaceId
const params: API.PictureUploadRequest = props.picture ? { id: props.picture.id } : {}
params.spaceId = props.spaceId;
const res = await uploadPictureUsingPost(params, {}, file)
```

æ•ˆæœå¦‚å›¾ï¼š

![img](./assets/yeIRmacxMsM8KsH1.webp)

#### 4ã€å›¾ç‰‡ç»„ä»¶å¢åŠ å¿«æ·æ“ä½œ

å¯ä»¥ç»™ç©ºé—´è¯¦æƒ…é¡µçš„å›¾ç‰‡å¡ç‰‡çš„ä¸‹æ–¹å¢åŠ å¿«æ·æ“ä½œæ ï¼Œæé«˜ç®¡ç†æ•ˆç‡ï¼Œå‚è€ƒ [å¡ç‰‡ç»„ä»¶ç¤ºä¾‹](https://antdv.com/components/card-cn#components-card-demo-meta)ã€‚

1ï¼‰ä¿®æ”¹å›¾ç‰‡åˆ—è¡¨ç»„ä»¶ï¼Œè¡¥å……æ“ä½œæ ã€‚

```vue
<template #actions>
  <a-space @click="e => doEdit(picture, e)">
    <edit-outlined />
    ç¼–è¾‘
  </a-space>
  <a-space @click="e => doDelete(picture, e)">
    <delete-outlined />
    åˆ é™¤
  </a-space>
</template>
```

2ï¼‰ç”±äºè¯¥ç»„ä»¶æ˜¯ä¸»é¡µå’Œç©ºé—´è¯¦æƒ…é¡µå…¬ç”¨çš„ï¼Œä¸»é¡µä¸éœ€è¦å±•ç¤ºæ“ä½œæ ã€ç§æœ‰ç©ºé—´æ‰å±•ç¤ºï¼Œæ‰€ä»¥éœ€è¦ä½¿ç”¨ showOp å±æ€§æ¥æ§åˆ¶ï¼š

```typescript
interface Props {
  dataList?: API.PictureVO[]
  loading?: boolean
  showOp?: boolean
}

const props = withDefaults(defineProps<Props>(), {
  dataList: () => [],
  loading: false,
  showOp: false,
})
```

é¡µé¢ç»“æ„å¢åŠ æ¡ä»¶ï¼š

```vue
<template v-if="showOp" #actions>
</template>
```

3ï¼‰è¡¥å……ç¼–è¾‘å’Œåˆ é™¤å‡½æ•°ï¼ŒdoEditã€doDelete çš„ä»£ç å¯ä»¥ç›´æ¥ä»å›¾ç‰‡è¯¦æƒ…é¡µå¤åˆ¶è¿‡æ¥ï¼Œä½†æ˜¯éœ€è¦ç”¨ `e.stopPropagation` é˜»æ­¢äº‹ä»¶ä¼ æ’­ï¼Œå¦åˆ™ä¼šåŒæ—¶è§¦å‘å¡ç‰‡ç‚¹å‡»äº‹ä»¶ï¼Œè·³è½¬åˆ°å›¾ç‰‡è¯¦æƒ…é¡µã€‚

```typescript
// ç¼–è¾‘
const doEdit = (picture, e) => {
  e.stopPropagation()
  router.push({
    path: '/add_picture',
    query: {
      id: picture.id,
      spaceId: picture.spaceId,
    },
  })
}

// åˆ é™¤
const doDelete = async (picture, e) => {
  e.stopPropagation()
  const id = picture.id
  if (!id) {
    return
  }
  const res = await deletePictureUsingPost({ id })
  if (res.data.code === 0) {
    message.success('åˆ é™¤æˆåŠŸ')
    // è®©å¤–å±‚åˆ·æ–°
    props?.onReload()
  } else {
    message.error('åˆ é™¤å¤±è´¥')
  }
}
```

4ï¼‰æ³¨æ„ï¼Œåˆ é™¤å›¾ç‰‡ä¹‹åï¼Œå¯ä»¥ reload é‡æ–°è§¦å‘æ•°æ®çš„åŠ è½½ã€‚ç»™å›¾ç‰‡åˆ—è¡¨ç»„ä»¶å¢åŠ  onReload å±æ€§ï¼š

```typescript
interface Props {
  dataList?: API.PictureVO[]
  loading?: boolean
  showOp?: boolean
  onReload?: () => void
}
```

ç©ºé—´è¯¦æƒ…é¡µä¼ é€’å±æ€§ï¼š

```vue
<!-- å›¾ç‰‡åˆ—è¡¨ -->
<PictureList :dataList="dataList"
  :loading="loading"
  showOp 
  :onReload="fetchData"
/>
```

æ•ˆæœå¦‚å›¾ï¼š

![img](./assets/2mI78lVaCkQSlwhv.webp)

#### 5ã€æŸ¥çœ‹ç§æœ‰ç©ºé—´çš„å›¾ç‰‡

ç›´æ¥å¤ç”¨å›¾ç‰‡è¯¦æƒ…é¡µ + åç«¯æ¥å£çš„æƒé™æ ¡éªŒï¼Œå°±å·²ç»å®ç°äº†ï¼Œæ— éœ€å¼€å‘ã€‚

#### 6ã€ç¼–è¾‘ç§æœ‰ç©ºé—´çš„å›¾ç‰‡

ä¹‹å‰æˆ‘ä»¬å·²ç»å®Œæˆäº†æ›´æ–°å›¾ç‰‡é¡µé¢çš„å¼€å‘ï¼ˆå…¶å®æ˜¯å¤ç”¨äº†å›¾ç‰‡åˆ›å»ºé¡µï¼‰ã€‚ä»ç©ºé—´è¯¦æƒ…é¡µæˆ–å›¾ç‰‡è¯¦æƒ…é¡µè¿›å…¥å›¾ç‰‡åˆ›å»ºé¡µæ—¶ï¼Œåªè¦ç»™ url æŸ¥è¯¢å‚æ•°æºå¸¦ spaceIdï¼Œå›¾ç‰‡åˆ›å»ºé¡µå°±èƒ½è‡ªåŠ¨è¯†åˆ«å‡º spaceId å¹¶å°†å›¾ç‰‡ä¿å­˜åˆ°ç©ºé—´ã€‚

ä¿®æ”¹å›¾ç‰‡è¯¦æƒ…é¡µçš„ç¼–è¾‘å›¾ç‰‡å‡½æ•°ï¼Œè·³è½¬é¡µé¢æ—¶æºå¸¦ spaceIdï¼š

```typescript
// ç¼–è¾‘
const doEdit = () => {
  router.push({
    path: '/add_picture',
    query: {
      id: picture.value.id,
      spaceId: picture.value.spaceId
    }
  })
}
```

æ•ˆæœå¦‚å›¾ï¼š

![img](./assets/pK9b8o14JNN2Yfkg.webp)

#### 7ã€åˆ é™¤ç§æœ‰ç©ºé—´çš„å›¾ç‰‡

é€šè¿‡åç«¯æ¥å£å·²ç»å®ç°äº†æƒé™æ ¡éªŒé€»è¾‘ï¼Œæ— éœ€å‰ç«¯å¼€å‘ã€‚

#### 8ã€ç§æœ‰å›¾ç‰‡çš„æƒé™æ§åˆ¶

å¤§å¤šæ•°æƒé™æ ¡éªŒå·²ç»é€šè¿‡åç«¯å®ç°ï¼Œæ¯”å¦‚ä¸»é¡µä¸ä¼  spaceId é»˜è®¤å°±æŸ¥çš„æ˜¯å…¬å…±å›¾åº“ï¼Œæ— éœ€ä¿®æ”¹å‰ç«¯ä»£ç ï¼›è®¿é—®å›¾ç‰‡è¯¦æƒ…é¡µæ—¶ï¼Œä¹Ÿä¼šé€šè¿‡åç«¯è¿›è¡Œæƒé™æ ¡éªŒã€‚

ä½†å›¾ç‰‡ç®¡ç†é¡µé¢ç”±äºè°ƒç”¨çš„æ˜¯ä»…ç®¡ç†å‘˜å¯ç”¨çš„è·å–å›¾ç‰‡åˆ—è¡¨æ¥å£ï¼ˆlistPictureByPageï¼‰ï¼Œçœ‹åˆ°çš„æ˜¯å…¨éƒ¨çš„å›¾ç‰‡ï¼Œå…¶å®åªéœ€è¦çœ‹å…¬å…±ç©ºé—´çš„è¿›è¡Œå®¡æ ¸ï¼Œå¯ä»¥ç»™æŸ¥è¯¢æ¡ä»¶å¢åŠ å‚æ•° `nullSpaceId: true`ï¼š

```typescript
const res = await listPictureByPageUsingPost({
  ...searchParams,
  nullSpaceId: true,
})
```

æµ‹è¯•ç©ºé—´è¯¦æƒ…é¡µã€å›¾ç‰‡è¯¦æƒ…é¡µæ²¡æœ‰æƒé™çš„æƒ…å†µï¼Œæ•ˆæœå¦‚å›¾ï¼š

![img](./assets/kO5rQFA2YwY57uPp.webp)

![img](./assets/73hkvPsMp8VrsIGR.webp)

#### æ‰©å±•

1ï¼‰ç©ºé—´è¯¦æƒ…é¡µå¢åŠ ç©ºé—´æ ‡å¿—çš„å±•ç¤ºï¼Œæ¯”å¦‚å°Šè´µçš„æ——èˆ°ç‰ˆå±•ç¤ºä¸ªé’»çŸ³ ğŸ’ã€‚

2ï¼‰åœ¨ç©ºé—´å†…ä¸Šä¼ å›¾ç‰‡æ—¶å¯ä»¥ä½¿ç”¨å¼¹çª—ç»„ä»¶ï¼Œè€Œä¸æ˜¯æ‰“å¼€æ–°é¡µé¢ï¼Œæ›´è½»é‡ã€‚

3ï¼‰ä¸Šä¼ å›¾ç‰‡åˆ°ç©ºé—´æ—¶ï¼Œä¸Šä¼ é¡µé¢å¯ä»¥å±•ç¤ºå‡ºç©ºé—´åç§°ã€å®¹é‡ç­‰ä¿¡æ¯ï¼Œå¹¶ä¸”å‰ç«¯ä¹Ÿå¯ä»¥åˆ¤æ–­æ˜¯å¦å…·æœ‰æƒé™ï¼Œä¼˜åŒ–ç”¨æˆ·ä½“éªŒã€‚

4ï¼‰é™¤äº†å›¾ç‰‡åˆ—è¡¨ç»„ä»¶å¤–ï¼Œè¿˜å¯ä»¥å°è£…å•ä¸ªå›¾ç‰‡çš„ç»„ä»¶ï¼Œå¤ç”¨æ›´çµæ´»ã€‚

5ï¼‰å›¾ç‰‡è¯¦æƒ…é¡µã€ç©ºé—´è¯¦æƒ…é¡µå‰ç«¯å¢åŠ æƒé™åˆ¤æ–­é€»è¾‘ï¼Œç›¸æ¯”å•çº¯é åç«¯è¿›è¡Œæƒé™æ ¡éªŒï¼Œå¯ä»¥ç»™ç”¨æˆ·æ›´å¥½çš„ä½“éªŒã€‚







# 8 - å›¾ç‰‡åŠŸèƒ½æ‰©å±•

## æœ¬èŠ‚é‡ç‚¹

ä¸ºäº†å¸å¼•ç”¨æˆ·ä½¿ç”¨æˆ‘ä»¬å¹³å°çš„ç§æœ‰ç©ºé—´ä½œä¸ºä¸ªäººç›¸å†Œï¼Œéœ€è¦æä¾›æ›´å¤šåŠŸèƒ½ã€‚

æœ¬èŠ‚æˆ‘ä»¬é‡ç‚¹å¯¹å›¾ç‰‡åŠŸèƒ½è¿›è¡Œæ‰©å±•ï¼ŒåŒ…æ‹¬ï¼š

- å›¾ç‰‡æœç´¢
- åŸºç¡€å±æ€§æœç´¢
- ä»¥å›¾æœå›¾
- é¢œè‰²æœç´¢
- å›¾ç‰‡åˆ†äº«
- é“¾æ¥åˆ†äº«
- æ‰«ç åˆ†äº«
- å›¾ç‰‡æ‰¹é‡ç®¡ç†
- æ‰¹é‡ä¿®æ”¹ä¿¡æ¯
- æ‰¹é‡é‡å‘½å

æœ‰äº†è¿™äº›åŠŸèƒ½ï¼Œç”¨æˆ·èƒ½å¤Ÿæ›´é«˜æ•ˆåœ°ç®¡ç†å’Œåˆ†äº«å¹³å°ä¸Šçš„å›¾ç‰‡èµ„æºï¼Œè¿›ä¸€æ­¥æå‡ä½¿ç”¨ä½“éªŒã€‚

## ä¸€ã€å›¾ç‰‡æœç´¢ - åŸºç¡€å±æ€§æœç´¢

### éœ€æ±‚åˆ†æ

æˆ‘ä»¬å¯ä»¥æä¾›å¤šç§æœç´¢ç»´åº¦ï¼Œå¸®ç”¨æˆ·æ›´å¿«åœ°æ‰¾åˆ°è‡ªå·±ç©ºé—´çš„å›¾ç‰‡ã€‚

å°†æœç´¢ç»´åº¦æŒ‰ä¼˜å…ˆçº§è¿›è¡Œæ’åºï¼Œä¼˜å…ˆçº§é«˜çš„ä¼šå±•ç¤ºåœ¨é å‰çš„ä½ç½®ï¼š

- å…³é”®è¯ï¼šåŒæ—¶æœç´¢åç§°å’Œç®€ä»‹
- æ ‡ç­¾
- åˆ†ç±»
- ç¼–è¾‘æ—¶é—´ï¼ˆå¼€å§‹æ—¶é—´ä¸ç»“æŸæ—¶é—´ï¼‰
- å›¾ç‰‡åç§°
- å›¾ç‰‡ç®€ä»‹
- å›¾ç‰‡å®½åº¦
- å›¾ç‰‡é«˜åº¦
- å›¾ç‰‡æ ¼å¼

### æ–¹æ¡ˆè®¾è®¡

åç«¯å¯ä»¥ç›´æ¥å¤ç”¨åŸæœ‰çš„åˆ†é¡µè·å–å›¾ç‰‡åˆ—è¡¨æ¥å£ï¼Œå¹¶åœ¨æ­¤åŸºç¡€ä¸Šå¢åŠ ç›¸åº”çš„æœç´¢æ¡ä»¶ï¼Œä»¥æ”¯æŒæ›´çµæ´»çš„ç­›é€‰ã€‚

å‰ç«¯å¯ä»¥é’ˆå¯¹ä¸åŒç±»å‹çš„æœç´¢ç»´åº¦é€‰ç”¨ç‰¹å®šçš„è¡¨å•é¡¹ç»„ä»¶ï¼Œæ¥æé«˜æœç´¢çš„ä½“éªŒã€‚

- å…³é”®è¯ï¼šæ–‡æœ¬è¾“å…¥æ¡†
- æ ‡ç­¾ï¼šä¸‹æ‹‰é€‰æ‹©æ¡†
- åˆ†ç±»ï¼šä¸‹æ‹‰é€‰æ‹©æ¡†
- ç¼–è¾‘æ—¶é—´ï¼šæ—¥æœŸé€‰æ‹©å™¨
- å›¾ç‰‡åç§°ï¼šæ–‡æœ¬è¾“å…¥æ¡†
- å›¾ç‰‡ç®€ä»‹ï¼šæ–‡æœ¬è¾“å…¥æ¡†
- å›¾ç‰‡å®½åº¦ï¼šæ•°å­—è¾“å…¥æ¡†
- å›¾ç‰‡é«˜åº¦ï¼šæ•°å­—è¾“å…¥æ¡†
- å›¾ç‰‡æ ¼å¼ï¼šæ–‡æœ¬è¾“å…¥æ¡† / ä¸‹æ‹‰é€‰æ‹©æ¡†

å‚è€ƒå…¶ä»–ç½‘ç«™ï¼Œæ—¥æœŸçš„é€‰æ‹©æœ€å¥½èƒ½å¤Ÿæä¾›é¢„è®¾çš„æ—¶é—´èŒƒå›´ï¼š

![img](https://pic.code-nav.cn/course_picture/1608440217629360130/q1IzIFEP0igyGbMT.webp)

### åç«¯å¼€å‘

å…¶ä»–çš„æœç´¢æ¡ä»¶åŸºæœ¬éƒ½å·²ç»æœ‰äº†ï¼Œè¿˜éœ€è¦æ”¯æŒæŒ‰ç…§ç¼–è¾‘æ—¶é—´æœç´¢ã€‚

1ï¼‰ä¸ºäº†æ”¯æŒæŒ‰ç¼–è¾‘æ—¶é—´è¿›è¡Œæœç´¢ï¼Œéœ€è¦åœ¨è¯·æ±‚ç±» PictureQueryRequest ä¸­æ·»åŠ å¼€å§‹å’Œç»“æŸç¼–è¾‘æ—¶é—´å­—æ®µï¼š

```java
/**
 * å¼€å§‹ç¼–è¾‘æ—¶é—´
 */
private Date startEditTime;

/**
 * ç»“æŸç¼–è¾‘æ—¶é—´
 */
private Date endEditTime;
```

2ï¼‰æ›´æ–°å›¾ç‰‡æœåŠ¡çš„ getQueryWrapper æ–¹æ³•

åœ¨å¤„ç†æŸ¥è¯¢æ—¶ï¼Œè¡¥å……æŒ‰ç¼–è¾‘æ—¶é—´ç­›é€‰çš„é€»è¾‘ï¼š

```java
Date startEditTime = pictureQueryRequest.getStartEditTime();
Date endEditTime = pictureQueryRequest.getEndEditTime();
queryWrapper.ge(ObjUtil.isNotEmpty(startEditTime), "editTime", startEditTime);
queryWrapper.lt(ObjUtil.isNotEmpty(endEditTime), "editTime", endEditTime);
```

### å‰ç«¯å¼€å‘

#### 1ã€å›¾ç‰‡æœç´¢è¡¨å•ç»„ä»¶

ç”±äºç©ºé—´è¯¦æƒ…é¡µçš„ä»£ç é‡è¾ƒå¤§ï¼Œæˆ‘ä»¬å¯ä»¥å°†æ‰€æœ‰å›¾ç‰‡æœç´¢é€»è¾‘å•ç‹¬å°è£…ä¸ºå›¾ç‰‡æœç´¢è¡¨å•ç»„ä»¶ `PictureSearchForm.vue`ã€‚ä¸ºæé«˜æ•ˆç‡ï¼Œè¯¥ç»„ä»¶å¯ä»¥ä»å›¾ç‰‡ç®¡ç†é¡µé¢çš„æœç´¢è¡¨å•å¤åˆ¶è€Œæ¥ã€‚

æ³¨æ„ï¼Œè¯¥ç»„ä»¶ä»…è´Ÿè´£ä¿®æ”¹æœç´¢æ¡ä»¶ï¼Œä¸è´Ÿè´£æ•°æ®è·å–ä¸å­˜å‚¨ã€‚

1ï¼‰å®šä¹‰ç»„ä»¶å±æ€§ï¼š

```typescript
interface Props {
  onSearch?: (searchParams: PictureQueryRequest) => void
}

const props = defineProps<Props>()
```

2ï¼‰ç¼–å†™æœç´¢æ¡ä»¶å’Œæœç´¢å‡½æ•°ï¼šä½¿ç”¨ `reactive` å˜é‡å­˜å‚¨æœç´¢æ¡ä»¶ï¼Œå¹¶è§¦å‘çˆ¶ç»„ä»¶çš„ `onSearch` æ–¹æ³•ã€‚

```typescript
// æœç´¢æ¡ä»¶
const searchParams = reactive<API.PictureQueryRequest>({})

// è·å–æ•°æ®
const doSearch = () => {
  props.onSearch?.(searchParams)
}
```

3ï¼‰å¼€å‘é¡µé¢ç»“æ„

å…¶ä¸­ï¼š

- æ—¥æœŸè¡¨å•é¡¹ä½¿ç”¨ Ant Design çš„ [æ—¥æœŸé€‰æ‹©å™¨ç»„ä»¶](https://antdv.com/components/date-picker-cn#components-date-picker-demo-presetted-ranges)ï¼Œæ”¯æŒé¢„è®¾çš„æ—¥æœŸèŒƒå›´é€‰é¡¹ï¼ˆæ¯”å¦‚è¿‡å»ä¸€å‘¨ï¼‰
- å®½åº¦ / é«˜åº¦è¡¨å•é¡¹ä½¿ç”¨ [æ•°å­—è¾“å…¥æ¡†ç»„ä»¶](https://antdv.com/components/input-number-cn)

ä»£ç å¦‚ä¸‹ï¼š

```vue
<div class="picture-search-form">
  <!-- æœç´¢è¡¨å• -->
  <a-form layout="inline" :model="searchParams" @finish="doSearch">
    <a-form-item label="å…³é”®è¯" name="searchText">
      <a-input
        v-model:value="searchParams.searchText"
        placeholder="ä»åç§°å’Œç®€ä»‹æœç´¢"
        allow-clear
      />
    </a-form-item>
    <a-form-item label="åˆ†ç±»" name="category">
      <a-auto-complete
        v-model:value="searchParams.category"
        style="min-width: 180px"
        :options="categoryOptions"
        placeholder="è¯·è¾“å…¥åˆ†ç±»"
        allowClear
      />
    </a-form-item>
    <a-form-item label="æ ‡ç­¾" name="tags">
      <a-select
        v-model:value="searchParams.tags"
        style="min-width: 180px"
        :options="tagOptions"
        mode="tags"
        placeholder="è¯·è¾“å…¥æ ‡ç­¾"
        allowClear
      />
    </a-form-item>
    <a-form-item label="æ—¥æœŸ" name="">
      <a-range-picker
        style="width: 400px"
        show-time
        v-model:value="dateRange"
        :placeholder="['ç¼–è¾‘å¼€å§‹æ—¥æœŸ', 'ç¼–è¾‘ç»“æŸæ—¶é—´']"
        format="YYYY/MM/DD HH:mm:ss"
        :presets="rangePresets"
        @change="onRangeChange"
      />
    </a-form-item>
    <a-form-item label="åç§°" name="name">
      <a-input v-model:value="searchParams.name" placeholder="è¯·è¾“å…¥åç§°" allow-clear />
    </a-form-item>
    <a-form-item label="ç®€ä»‹" name="introduction">
      <a-input v-model:value="searchParams.introduction" placeholder="è¯·è¾“å…¥ç®€ä»‹" allow-clear />
    </a-form-item>
    <a-form-item label="å®½åº¦" name="picWidth">
      <a-input-number v-model:value="searchParams.picWidth" />
    </a-form-item>
    <a-form-item label="é«˜åº¦" name="picHeight">
      <a-input-number v-model:value="searchParams.picHeight" />
    </a-form-item>
    <a-form-item label="æ ¼å¼" name="picFormat">
      <a-input v-model:value="searchParams.picFormat" placeholder="è¯·è¾“å…¥æ ¼å¼" allow-clear />
    </a-form-item>
    <a-form-item>
      <a-button type="primary" html-type="submit" style="width: 96px">æœç´¢</a-button>
    </a-form-item>
  </a-form>
</div>
```

æ—¥æœŸè¡¨å•é¡¹æ‰€éœ€çš„å˜é‡ï¼š

```typescript
const dateRange = ref<[]>([])

/**
 * æ—¥æœŸèŒƒå›´æ›´æ”¹æ—¶è§¦å‘
 * @param dates
 * @param dateStrings
 */
const onRangeChange = (dates: any[], dateStrings: string[]) => {
  if (dates.length < 2) {
    searchParams.startEditTime = undefined
    searchParams.endEditTime = undefined
  } else {
    searchParams.startEditTime = dates[0].toDate()
    searchParams.endEditTime = dates[1].toDate()
  }
}

const rangePresets = ref([
  { label: 'è¿‡å» 7 å¤©', value: [dayjs().add(-7, 'd'), dayjs()] },
  { label: 'è¿‡å» 14 å¤©', value: [dayjs().add(-14, 'd'), dayjs()] },
  { label: 'è¿‡å» 30 å¤©', value: [dayjs().add(-30, 'd'), dayjs()] },
  { label: 'è¿‡å» 90 å¤©', value: [dayjs().add(-90, 'd'), dayjs()] },
])
```

4ï¼‰è·å–åˆ†ç±»å’Œæ ‡ç­¾è¡¨å•é¡¹çš„é»˜è®¤é€‰é¡¹åˆ—è¡¨ï¼Œè¿™æ®µä»£ç å¯ä»¥ç›´æ¥å¤ç”¨åˆ›å»ºå›¾ç‰‡é¡µé¢çš„ï¼š

```typescript
const categoryOptions = ref<string[]>([])
const tagOptions = ref<string[]>([])

// è·å–æ ‡ç­¾å’Œåˆ†ç±»é€‰é¡¹
const getTagCategoryOptions = async () => {
  const res = await listPictureTagCategoryUsingGet()
  if (res.data.code === 0 && res.data.data) {
    // è½¬æ¢æˆä¸‹æ‹‰é€‰é¡¹ç»„ä»¶æ¥å—çš„æ ¼å¼
    tagOptions.value = (res.data.data.tagList ?? []).map((data: string) => {
      return {
        value: data,
        label: data,
      }
    })
    categoryOptions.value = (res.data.data.categoryList ?? []).map((data: string) => {
      return {
        value: data,
        label: data,
      }
    })
  } else {
    message.error('åŠ è½½é€‰é¡¹å¤±è´¥ï¼Œ' + res.data.message)
  }
}

onMounted(() => {
  getTagCategoryOptions()
})
```

5ï¼‰ç©ºé—´è¯¦æƒ…é¡µä½¿ç”¨ç»„ä»¶ï¼š

```vue
<!-- æœç´¢è¡¨å• -->
<PictureSearchForm />
```

æµè§ˆæ•ˆæœï¼Œç›®å‰è¡¨å•é¡¹éƒ½æŒ¤åœ¨ä¸€èµ·ï¼Œä¸å¤ªå¥½çœ‹ï¼š

![img](https://pic.code-nav.cn/course_picture/1608440217629360130/4BIFwjSMprduXQO5.webp)

å¯ä»¥æ·»åŠ  CSS æ ·å¼ï¼Œå¢åŠ ä¸Šè¾¹è·ï¼š

```css
.picture-search-form .ant-form-item {
  margin-top: 16px;
}
```

6ï¼‰ç”±äºæ•°å­—è¾“å…¥æ¡†çš„å€¼æ— æ³•ç›´æ¥é€šè¿‡ allow-clear æ¸…ç†ï¼Œæ‰€ä»¥ç»™è¡¨å•å¢åŠ ä¸€ä¸ªé‡ç½®æŒ‰é’®ã€‚

é¡µé¢ä»£ç ï¼š

```vue
<a-form-item>
  <a-space>
    <a-button type="primary" html-type="submit" style="width: 96px">æœç´¢</a-button>
    <a-button html-type="reset" @click="doClear">é‡ç½®</a-button>
  </a-space>
</a-form-item>
```

éœ€è¦ç¼–å†™ä¸€ä¸ªé‡ç½®å‡½æ•°ï¼Œå°†æ‰€æœ‰æœç´¢æ¡ä»¶çš„å€¼æ¸…ç©ºã€‚ç”±äºæˆ‘ä»¬ä½¿ç”¨äº† `reactive` å“åº”å¼å˜é‡ï¼Œæ— æ³•ç›´æ¥æ•´ä½“èµ‹å€¼ä¸ºä¸€ä¸ªç©ºå¯¹è±¡ï¼Œè€Œæ˜¯éœ€è¦å°†å…¶ä¸­çš„å­—æ®µå…¨éƒ¨è®¾ç½®ä¸ºç©ºã€‚æ­¤å¤–ï¼Œä¸è¦å¿˜äº†æ—¥æœŸç»„ä»¶çš„å€¼ä¹Ÿéœ€è¦é‡ç½®ä¸ºç©ºæ•°ç»„ã€‚

```typescript
// æ¸…ç†
const doClear = () => {
  // å–æ¶ˆæ‰€æœ‰å¯¹è±¡çš„å€¼
  Object.keys(searchParams).forEach((key) => {
    searchParams[key] = undefined
  })
  dateRange.value = []
  props.onSearch?.(searchParams)
}
```

ğŸ’¡ å­¦å‰ç«¯çš„åŒå­¦å¯ä»¥å»äº†è§£ä¸‹ [lodash å·¥å…·åº“](https://lodash.com/)ï¼Œç±»ä¼¼åç«¯çš„ HuToolï¼Œæä¾›äº†å¾ˆå¤šå¿«æ·æ“ä½œå¯¹è±¡çš„å‡½æ•°ã€‚

æ•ˆæœå¦‚å›¾:

![img](https://pic.code-nav.cn/course_picture/1608440217629360130/4CaJYLWfREBAhDbH.webp) #### 2ã€æ‰§è¡Œæœç´¢

1ï¼‰ç»™ç»„ä»¶ä¼ é€’ onSearch æœç´¢å‡½æ•°ï¼š

```vue
<!-- æœç´¢è¡¨å• -->
<PictureSearchForm :onSearch="onSearch" />
```

2ï¼‰ç¼–å†™æœç´¢å‡½æ•°

ç”±äºæœç´¢å‚æ•°å¯èƒ½è¢«é‡ç½®ï¼Œä¸ºäº†æ–¹ä¾¿ï¼Œå°† searchParams ä» reactive å˜é‡æ”¹ä¸º ref å˜é‡ï¼Œè¿™æ ·å¯ä»¥æ•´ä½“ç»™ searchParams èµ‹å€¼ä¸ºç©ºçš„å¯¹è±¡ã€‚

è¦ä¿®æ”¹çš„ä»£ç å¦‚ä¸‹ï¼š

```typescript
// æœç´¢æ¡ä»¶
const searchParams = ref<API.PictureQueryRequest>({
  current: 1,
  pageSize: 12,
  sortField: 'createTime',
  sortOrder: 'descend',
})

// åˆ†é¡µå‚æ•°
const onPageChange = (page, pageSize) => {
  searchParams.value.current = page
  searchParams.value.pageSize = pageSize
  fetchData()
}

// æœç´¢
const onSearch = (newSearchParams: API.PictureQueryRequest) => {
  searchParams.value = {
    ...searchParams.value,
    ...newSearchParams,
    current: 1,
  }
  fetchData()
}

// è·å–æ•°æ®
const fetchData = async () => {
  loading.value = true
  // è½¬æ¢æœç´¢å‚æ•°
  const params = {
    spaceId: props.id,
    ...searchParams.value,
  }
  const res = await listPictureVoByPageUsingPost(params)
  if (res.data.data) {
    dataList.value = res.data.data.records ?? []
    total.value = res.data.data.total ?? 0
  } else {
    message.error('è·å–æ•°æ®å¤±è´¥ï¼Œ' + res.data.message)
  }
  loading.value = false
}
```

### æ‰©å±•

1ã€å›¾ç‰‡å°ºå¯¸æœç´¢ä¼˜åŒ–

æŒ‰ç…§å›¾ç‰‡çš„å°ºå¯¸æä¾›å‡ ä¸ªé¢„è®¾é€‰é¡¹ï¼Œå¦‚â€œå°â€ã€â€œä¸­â€ã€â€œå¤§â€å’Œâ€œç‰¹å¤§â€ã€‚æ¯ä¸ªé€‰é¡¹å¯¹åº”ä¸€ä¸ªæœ€å¤§å®½åº¦å’Œæœ€å¤§é«˜åº¦ï¼Œç”¨æˆ·åªéœ€é€‰æ‹©å¯¹åº”çš„å°ºå¯¸ï¼Œç³»ç»Ÿå³å¯è‡ªåŠ¨è¿›è¡ŒåŒ¹é…å’Œè¿‡æ»¤ã€‚

![img](https://pic.code-nav.cn/course_picture/1608440217629360130/qnt1xCgpml9VfOEV.webp)

2ã€å›¾ç‰‡æ ¼å¼é€‰æ‹©

ä¸ºäº†æ–¹ä¾¿ç”¨æˆ·ç­›é€‰ä¸åŒæ ¼å¼çš„å›¾ç‰‡ï¼Œå‰ç«¯å¯ä»¥æä¾›å¸¸è§çš„å›¾ç‰‡æ ¼å¼ä¸‹æ‹‰é€‰é¡¹ï¼Œå¦‚ JPGã€PNGã€GIF ç­‰ã€‚

3ã€åŸºç¡€æœç´¢ä¸è¯¦ç»†æœç´¢çš„åˆ‡æ¢

å‰ç«¯å¯ä»¥æ”¯æŒåŸºç¡€æœç´¢å’Œè¯¦ç»†æœç´¢çš„åŠŸèƒ½ã€‚é€šè¿‡ä½¿ç”¨ [æŠ˜å ç»„ä»¶](https://antdv.com/components/collapse-cn#components-collapse-demo-borderless)ï¼Œç”¨æˆ·å¯ä»¥åœ¨åŸºç¡€æœç´¢æ¡†ä¸­å¿«é€Ÿè¾“å…¥å¸¸è§çš„æœç´¢æ¡ä»¶ï¼ˆå¦‚å…³é”®è¯ã€åˆ†ç±»å’Œæ ‡ç­¾ï¼‰ï¼›ç‚¹å‡»å±•å¼€åå¯ä»¥æ˜¾ç¤ºæ›´å¤šè¯¦ç»†çš„æœç´¢æ¡ä»¶ï¼ˆæ¯”å¦‚å›¾ç‰‡å®½åº¦å’Œæ ¼å¼ï¼‰ã€‚è¿™æ ·æ—¢ä¿ç•™äº†ç®€å•å¿«æ·çš„æœç´¢ä½“éªŒï¼Œåˆä¸å¤±çµæ´»æ€§ã€‚

## äºŒã€å›¾ç‰‡æœç´¢ - ä»¥å›¾æœå›¾

### éœ€æ±‚åˆ†æ

ç”¨æˆ·å¯ä»¥ä½¿ç”¨ä¸€å¼ å›¾ç‰‡æ¥æœç´¢ç›¸ä¼¼çš„å›¾ç‰‡ï¼Œç›¸æ¯”ä¼ ç»Ÿçš„å…³é”®è¯æœç´¢ï¼Œèƒ½å¤Ÿæ›´ç²¾ç¡®åœ°æ‰¾åˆ°ä¸ä¸Šä¼ å›¾ç‰‡å†…å®¹ç›¸ä¼¼çš„å›¾ç‰‡ã€‚

ä¸ºäº†è·å¾—æ›´å¤šçš„æœç´¢ç»“æœï¼Œæˆ‘ä»¬çš„éœ€æ±‚æ˜¯ä» **å…¨ç½‘æœç´¢å›¾ç‰‡**ï¼Œè€Œä¸æ˜¯åªåœ¨è‡ªå·±çš„å›¾åº“ä¸­æœç´¢ã€‚

æ³¨æ„ï¼Œè¯¥åŠŸèƒ½ä¸ç”¨å±€é™äºç§æœ‰ç©ºé—´ï¼Œå…¬å…±å›¾åº“ä¹Ÿå¯ä»¥ä½¿ç”¨ã€‚

### æ–¹æ¡ˆè®¾è®¡

ä¸»è¦æœ‰ 2 ç§æ–¹æ¡ˆï¼šç¬¬ä¸‰æ–¹ API ä»¥åŠæ•°æ®æŠ“å–ï¼ˆçˆ¬è™«ï¼‰

#### 1ã€ç¬¬ä¸‰æ–¹ API

å¦‚æœæƒ³ä»è‡ªå»ºçš„å›¾åº“ä¸­æœç´¢ï¼šå¯ä»¥ä½¿ç”¨ç™¾åº¦ AI æä¾›çš„å›¾ç‰‡æœç´¢ APIï¼Œ[å‚è€ƒå®˜æ–¹æ–‡æ¡£](https://ai.baidu.com/tech/imagesearch/)

Bing ä»¥å›¾æœå›¾ APIï¼š åˆ©ç”¨å¿…åº”çš„å›¾åº“ï¼Œå¯ä»¥ä»å…¨ç½‘è¿›è¡Œæœç´¢ï¼Œè€Œä¸”å¯ä»¥å…è´¹ä½¿ç”¨ï¼Œ[å‚è€ƒå®˜æ–¹æ–‡æ¡£](https://learn.microsoft.com/en-us/bing/search-apis/bing-image-search/quickstarts/rest/java)

#### 2ã€æ•°æ®æŠ“å–

åˆ©ç”¨å·²æœ‰çš„ä»¥å›¾æœå›¾ç½‘ç«™ï¼Œé€šè¿‡æ•°æ®æŠ“å–çš„æ–¹å¼å®æ—¶æŸ¥è¯¢æœå›¾ç½‘ç«™çš„è¿”å›ç»“æœã€‚

ä¸ºäº†è®©å¤§å®¶å­¦ä¹ åˆ°æ›´å¤šçŸ¥è¯†ï¼Œæ­¤å¤„æˆ‘ä»¬é€‰æ‹©è¿™ç§æ–¹æ¡ˆã€‚

ä»¥ç™¾åº¦æœå›¾ç½‘ç«™ä¸ºä¾‹ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆä½“éªŒä¸€éæµç¨‹ï¼Œå¹¶ä¸”å¯¹æ¥å£è¿›è¡Œåˆ†æï¼š

1ï¼‰è¿›åˆ°ç™¾åº¦å›¾ç‰‡æœç´¢ï¼Œé€šè¿‡ url ä¸Šä¼ å›¾ç‰‡ï¼Œå‘ç°æ¥å£ï¼šhttps://graph.baidu.com/upload?uptime= ï¼Œè¯¥æ¥å£çš„è¿”å›å€¼ä¸º â€œä»¥å›¾æœå›¾çš„é¡µé¢åœ°å€â€

2ï¼‰è®¿é—®ä¸Šä¸€æ­¥å¾—åˆ°çš„ [é¡µé¢åœ°å€](https://graph.baidu.com/s?card_key=&entrance=GENERAL&extUiData[isLogoShow]=1&f=all&isLogoShow=1&session_id=16250747570487381669&sign=1265ce97cd54acd88139901733452612&tpl_from=pc)ï¼Œå¯ä»¥åœ¨è¿”å›å€¼ä¸­æ‰¾åˆ° firstUrlï¼š

![img](https://pic.code-nav.cn/course_picture/1608440217629360130/9MdeOV7BFoiy61hH.webp)

3ï¼‰è®¿é—® [firstUrl](https://graph.baidu.com/ajax/pcsimi?carousel=503&entrance=GENERAL&extUiData[isLogoShow]=1&inspire=general_pc&limit=30&next=2&render_type=card&session_id=16250747570487381669&sign=1265ce97cd54acd88139901733452612&tk=4caaa&tpl_from=pc)ï¼Œå°±èƒ½å¾—åˆ° JSON æ ¼å¼çš„ç›¸ä¼¼å›¾ç‰‡åˆ—è¡¨ï¼Œé‡Œé¢åŒ…å«äº†å›¾ç‰‡çš„ç¼©ç•¥å›¾å’ŒåŸå›¾åœ°å€ï¼š

![img](https://pic.code-nav.cn/course_picture/1608440217629360130/Uze1Q0loCj5uL27O.webp)

ğŸ’¡ å‹æƒ…æç¤ºï¼Œè¿™ç§æ–¹å¼åªé€‚åˆå­¦ä¹ ä½¿ç”¨ï¼æ³¨æ„ä¸è¦ç»™ç›®æ ‡ç½‘ç«™å¸¦æ¥å‹åŠ›ï¼ï¼å¦åˆ™åæœè‡ªè´Ÿï¼ï¼ï¼

### åç«¯å¼€å‘

æ–°å»º `api` åŒ…ï¼Œç”±äºé¡¹ç›®å¯èƒ½ä¼šç”¨åˆ°å¤šä¸ª apiï¼Œå¯ä»¥å°†æ¯ä¸ª api éƒ½æ”¾åœ¨ api ç›®å½•ä¸‹çš„ä¸€ä¸ªåŒ…ä¸­ã€‚æ¯”å¦‚å›¾ç‰‡æœç´¢ api çš„ç›¸å…³ä»£ç ï¼Œå…¨éƒ¨æ”¾åœ¨ `api.imagesearch` åŒ…ä¸‹ã€‚

#### 1ã€æ•°æ®æ¨¡å‹å¼€å‘

åœ¨ `imagesearch.model` åŒ…ä¸­ï¼Œæ–°å»ºä¸€ä¸ªå›¾ç‰‡æœç´¢ç»“æœç±»ï¼Œç”¨äºæ¥å— API çš„è¿”å›å€¼ï¼š

```java
@Data
public class ImageSearchResult {

    /**
     * ç¼©ç•¥å›¾åœ°å€
     */
    private String thumbUrl;

    /**
     * æ¥æºåœ°å€
     */
    private String fromUrl;
}
```

#### 2ã€API å¼€å‘

æ ¹æ®æ–¹æ¡ˆï¼Œæˆ‘ä»¬è¦è°ƒç”¨å¤šä¸ª APIï¼Œæ¯ä¸ªå­ API å¯ä»¥ä½œä¸ºä¸€ä¸ªé™æ€ç±»æ¥å®ç°ï¼Œç»Ÿä¸€æ”¾åœ¨ `imagesearch.sub` åŒ…ä¸­ï¼Œå¹¶ä¸”æ¯ä¸ªç±»éƒ½åŒ…å«ä¸€ä¸ª `main` æ–¹æ³•ï¼Œç”¨äºè¿›è¡Œæœ¬åœ°æµ‹è¯•ã€‚

1ï¼‰è·å–ä»¥å›¾æœå›¾çš„é¡µé¢åœ°å€

é€šè¿‡å‘ç™¾åº¦å‘é€ POST è¯·æ±‚ï¼Œè·å–ç»™å®šå›¾ç‰‡ URL çš„ç›¸ä¼¼å›¾ç‰‡é¡µé¢åœ°å€ã€‚

```java
@Slf4j
public class GetImagePageUrlApi {

    /**
     * è·å–å›¾ç‰‡é¡µé¢åœ°å€
     *
     * @param imageUrl
     * @return
     */
    public static String getImagePageUrl(String imageUrl) {
        // 1. å‡†å¤‡è¯·æ±‚å‚æ•°
        Map<String, Object> formData = new HashMap<>();
        formData.put("image", imageUrl);
        formData.put("tn", "pc");
        formData.put("from", "pc");
        formData.put("image_source", "PC_UPLOAD_URL");
        // è·å–å½“å‰æ—¶é—´æˆ³
        long uptime = System.currentTimeMillis();
        // è¯·æ±‚åœ°å€
        String url = "https://graph.baidu.com/upload?uptime=" + uptime;

        try {
            // 2. å‘é€ POST è¯·æ±‚åˆ°ç™¾åº¦æ¥å£
            HttpResponse response = HttpRequest.post(url)
                    .form(formData)
                    .timeout(5000)
                    .execute();
            // åˆ¤æ–­å“åº”çŠ¶æ€
            if (HttpStatus.HTTP_OK != response.getStatus()) {
                throw new BusinessException(ErrorCode.OPERATION_ERROR, "æ¥å£è°ƒç”¨å¤±è´¥");
            }
            // è§£æå“åº”
            String responseBody = response.body();
            Map<String, Object> result = JSONUtil.toBean(responseBody, Map.class);

            // 3. å¤„ç†å“åº”ç»“æœ
            if (result == null || !Integer.valueOf(0).equals(result.get("status"))) {
                throw new BusinessException(ErrorCode.OPERATION_ERROR, "æ¥å£è°ƒç”¨å¤±è´¥");
            }
            Map<String, Object> data = (Map<String, Object>) result.get("data");
            String rawUrl = (String) data.get("url");
            // å¯¹ URL è¿›è¡Œè§£ç 
            String searchResultUrl = URLUtil.decode(rawUrl, StandardCharsets.UTF_8);
            // å¦‚æœ URL ä¸ºç©º
            if (searchResultUrl == null) {
                throw new BusinessException(ErrorCode.OPERATION_ERROR, "æœªè¿”å›æœ‰æ•ˆç»“æœ");
            }
            return searchResultUrl;
        } catch (Exception e) {
            log.error("æœç´¢å¤±è´¥", e);
            throw new BusinessException(ErrorCode.OPERATION_ERROR, "æœç´¢å¤±è´¥");
        }
    }

    public static void main(String[] args) {
        // æµ‹è¯•ä»¥å›¾æœå›¾åŠŸèƒ½
        String imageUrl = "https://www.codefather.cn/logo.png";
        String result = getImagePageUrl(imageUrl);
        System.out.println("æœç´¢æˆåŠŸï¼Œç»“æœ URLï¼š" + result);
    }
}
```

2ï¼‰è·å–å›¾ç‰‡åˆ—è¡¨é¡µé¢åœ°å€

é€šè¿‡ jsoup çˆ¬å– HTML é¡µé¢ï¼Œæå–å…¶ä¸­åŒ…å« `firstUrl` çš„ JavaScript è„šæœ¬ï¼Œå¹¶è¿”å›å›¾ç‰‡åˆ—è¡¨çš„é¡µé¢åœ°å€ã€‚

```java
@Slf4j
public class GetImageFirstUrlApi {

    /**
     * è·å–å›¾ç‰‡åˆ—è¡¨é¡µé¢åœ°å€
     *
     * @param url
     * @return
     */
    public static String getImageFirstUrl(String url) {
        try {
            // ä½¿ç”¨ Jsoup è·å– HTML å†…å®¹
            Document document = Jsoup.connect(url)
                    .timeout(5000)
                    .get();

            // è·å–æ‰€æœ‰ <script> æ ‡ç­¾
            Elements scriptElements = document.getElementsByTag("script");

            // éå†æ‰¾åˆ°åŒ…å« `firstUrl` çš„è„šæœ¬å†…å®¹
            for (Element script : scriptElements) {
                String scriptContent = script.html();
                if (scriptContent.contains("\"firstUrl\"")) {
                    // æ­£åˆ™è¡¨è¾¾å¼æå– firstUrl çš„å€¼
                    Pattern pattern = Pattern.compile("\"firstUrl\"\\s*:\\s*\"(.*?)\"");
                    Matcher matcher = pattern.matcher(scriptContent);
                    if (matcher.find()) {
                        String firstUrl = matcher.group(1);
                        // å¤„ç†è½¬ä¹‰å­—ç¬¦
                        firstUrl = firstUrl.replace("\\/", "/");
                        return firstUrl;
                    }
                }
            }

            throw new BusinessException(ErrorCode.OPERATION_ERROR, "æœªæ‰¾åˆ° url");
        } catch (Exception e) {
            log.error("æœç´¢å¤±è´¥", e);
            throw new BusinessException(ErrorCode.OPERATION_ERROR, "æœç´¢å¤±è´¥");
        }
    }

    public static void main(String[] args) {
        // è¯·æ±‚ç›®æ ‡ URL
        String url = "https://graph.baidu.com/s?card_key=&entrance=GENERAL&extUiData[isLogoShow]=1&f=all&isLogoShow=1&session_id=16250747570487381669&sign=1265ce97cd54acd88139901733452612&tpl_from=pc";
        String imageFirstUrl = getImageFirstUrl(url);
        System.out.println("æœç´¢æˆåŠŸï¼Œç»“æœ URLï¼š" + imageFirstUrl);
    }
}
```

3ï¼‰è·å–å›¾ç‰‡åˆ—è¡¨

é€šè¿‡è°ƒç”¨ç™¾åº¦æ¥å£è¿”å›çš„ JSON æ•°æ®ï¼Œæå–å‡ºå…¶ä¸­çš„å›¾ç‰‡åˆ—è¡¨å¹¶è¿”å›ã€‚

```java
@Slf4j
public class GetImageListApi {

    /**
     * è·å–å›¾ç‰‡åˆ—è¡¨
     *
     * @param url
     * @return
     */
    public static List<ImageSearchResult> getImageList(String url) {
        try {
            // å‘èµ·GETè¯·æ±‚
            HttpResponse response = HttpUtil.createGet(url).execute();

            // è·å–å“åº”å†…å®¹
            int statusCode = response.getStatus();
            String body = response.body();

            // å¤„ç†å“åº”
            if (statusCode == 200) {
                // è§£æ JSON æ•°æ®å¹¶å¤„ç†
                return processResponse(body);
            } else {
                throw new BusinessException(ErrorCode.OPERATION_ERROR, "æ¥å£è°ƒç”¨å¤±è´¥");
            }
        } catch (Exception e) {
            log.error("è·å–å›¾ç‰‡åˆ—è¡¨å¤±è´¥", e);
            throw new BusinessException(ErrorCode.OPERATION_ERROR, "è·å–å›¾ç‰‡åˆ—è¡¨å¤±è´¥");
        }
    }

    /**
     * å¤„ç†æ¥å£å“åº”å†…å®¹
     *
     * @param responseBody æ¥å£è¿”å›çš„JSONå­—ç¬¦ä¸²
     */
    private static List<ImageSearchResult> processResponse(String responseBody) {
        // è§£æå“åº”å¯¹è±¡
        JSONObject jsonObject = new JSONObject(responseBody);
        if (!jsonObject.containsKey("data")) {
            throw new BusinessException(ErrorCode.OPERATION_ERROR, "æœªè·å–åˆ°å›¾ç‰‡åˆ—è¡¨");
        }
        JSONObject data = jsonObject.getJSONObject("data");
        if (!data.containsKey("list")) {
            throw new BusinessException(ErrorCode.OPERATION_ERROR, "æœªè·å–åˆ°å›¾ç‰‡åˆ—è¡¨");
        }
        JSONArray list = data.getJSONArray("list");
        return JSONUtil.toList(list, ImageSearchResult.class);
    }

    public static void main(String[] args) {
        String url = "https://graph.baidu.com/ajax/pcsimi?carousel=503&entrance=GENERAL&extUiData%5BisLogoShow%5D=1&inspire=general_pc&limit=30&next=2&render_type=card&session_id=16250747570487381669&sign=1265ce97cd54acd88139901733452612&tk=4caaa&tpl_from=pc";
        List<ImageSearchResult> imageList = getImageList(url);
        System.out.println("æœç´¢æˆåŠŸ" + imageList);
    }
}
```

#### 3ã€å›¾ç‰‡æœç´¢æœåŠ¡ï¼ˆé—¨é¢æ¨¡å¼ï¼‰

è¿™é‡Œæˆ‘ä»¬è¿ç”¨ä¸€ç§è®¾è®¡æ¨¡å¼æ¥æä¾›å›¾ç‰‡æœç´¢æœåŠ¡ã€‚é—¨é¢æ¨¡å¼é€šè¿‡æä¾›ä¸€ä¸ªç»Ÿä¸€çš„æ¥å£æ¥ç®€åŒ–å¤šä¸ªæ¥å£çš„è°ƒç”¨ï¼Œä½¿å¾—å®¢æˆ·ç«¯ä¸éœ€è¦å…³æ³¨å†…éƒ¨çš„å…·ä½“å®ç°ã€‚

æˆ‘ä»¬å¯ä»¥å°†å¤šä¸ª API æ•´åˆåˆ°ä¸€ä¸ªé—¨é¢ç±»ä¸­ï¼Œç®€åŒ–è°ƒç”¨è¿‡ç¨‹ã€‚åœ¨ `imagesearch` åŒ…ä¸‹æ–°å»ºé—¨é¢ç±»ï¼Œæ•´åˆå‡ ä¸ªæ¥å£çš„è°ƒç”¨ï¼š

```java
@Slf4j
public class ImageSearchApiFacade {

    /**
     * æœç´¢å›¾ç‰‡
     *
     * @param imageUrl
     * @return
     */
    public static List<ImageSearchResult> searchImage(String imageUrl) {
        String imagePageUrl = GetImagePageUrlApi.getImagePageUrl(imageUrl);
        String imageFirstUrl = GetImageFirstUrlApi.getImageFirstUrl(imagePageUrl);
        List<ImageSearchResult> imageList = GetImageListApi.getImageList(imageFirstUrl);
        return imageList;
    }

    public static void main(String[] args) {
        // æµ‹è¯•ä»¥å›¾æœå›¾åŠŸèƒ½
        String imageUrl = "https://www.codefather.cn/logo.png";
        List<ImageSearchResult> resultList = searchImage(imageUrl);
        System.out.println("ç»“æœåˆ—è¡¨" + resultList);
    }
}
```

#### 4ã€æ¥å£å¼€å‘

å¼€å‘è¯·æ±‚ç±»ï¼š

```java
@Data
public class SearchPictureByPictureRequest implements Serializable {

    /**
     * å›¾ç‰‡ id
     */
    private Long pictureId;

    private static final long serialVersionUID = 1L;
}
```

å¼€å‘æ¥å£ï¼š

```java
/**
 * ä»¥å›¾æœå›¾
 */
@PostMapping("/search/picture")
public BaseResponse<List<ImageSearchResult>> searchPictureByPicture(@RequestBody SearchPictureByPictureRequest searchPictureByPictureRequest) {
    ThrowUtils.throwIf(searchPictureByPictureRequest == null, ErrorCode.PARAMS_ERROR);
    Long pictureId = searchPictureByPictureRequest.getPictureId();
    ThrowUtils.throwIf(pictureId == null || pictureId <= 0, ErrorCode.PARAMS_ERROR);
    Picture oldPicture = pictureService.getById(pictureId);
    ThrowUtils.throwIf(oldPicture == null, ErrorCode.NOT_FOUND_ERROR);
    List<ImageSearchResult> resultList = ImageSearchApiFacade.searchImage(oldPicture.getUrl());
    return ResultUtils.success(resultList);
}
```

### å‰ç«¯å¼€å‘

#### 1ã€æœç´¢å…¥å£

1ï¼‰ä¿®æ”¹å›¾ç‰‡åˆ—è¡¨é¡µé¢çš„ä»£ç ï¼Œç»™å›¾ç‰‡æ“ä½œæ å¢åŠ ä¸€ä¸ªæœç´¢æŒ‰é’®ï¼š

```vue
<template v-if="showOp" #actions>
  <a-space @click="(e) => doSearch(picture, e)">
    <search-outlined />
    æœç´¢
  </a-space>
  <a-space @click="(e) => doEdit(picture, e)">
    <edit-outlined />
    ç¼–è¾‘
  </a-space>
  <a-space @click="(e) => doDelete(picture, e)">
    <delete-outlined />
    åˆ é™¤
  </a-space>
</template>
```

æ•ˆæœå¦‚å›¾ï¼š

![img](https://pic.code-nav.cn/course_picture/1608440217629360130/rAlCJ1mqhebh5qhW.webp)

2ï¼‰ç‚¹å‡»æœç´¢åæ‰“å¼€æ–°é¡µé¢ï¼Œè¿›å…¥åˆ°ä»¥å›¾æœå›¾ç»“æœé¡µï¼š

```typescript
// æœç´¢
const doSearch = (picture, e) => {
  e.stopPropagation()
  window.open(`/search_picture?pictureId=${picture.id}`)
}
```

#### 2ã€ä»¥å›¾æœå›¾ç»“æœé¡µé¢

1ï¼‰æ–°å»ºå›¾ç‰‡æœç´¢é¡µé¢æ–‡ä»¶ `SearchPicturePage.vue`ã€‚å¯ä»¥å¤åˆ¶åˆ›å»ºå›¾ç‰‡é¡µé¢ï¼Œè¿™æ ·å¯ä»¥å¤ç”¨è·å– url æŸ¥è¯¢å‚æ•°å¹¶æŸ¥è¯¢è€æ•°æ®çš„é€»è¾‘ã€‚

æ·»åŠ è·¯ç”±ï¼š

```typescript
{
  path: '/search_picture',
  name: 'å›¾ç‰‡æœç´¢',
  component: SearchPicturePage,
}
```

2ï¼‰å¼€å‘é¡µé¢ï¼Œä¸Šæ–¹å±•ç¤ºé¡µé¢æ ‡é¢˜å’ŒåŸå§‹å›¾ç‰‡ï¼Œä¸‹æ–¹å±•ç¤ºæœç´¢ç»“æœå›¾ç‰‡åˆ—è¡¨ã€‚å¯ä»¥å‚è€ƒå›¾ç‰‡åˆ—è¡¨ç»„ä»¶æ¥å±•ç¤ºå›¾ç‰‡åˆ—è¡¨ï¼š

```vue
<template>
  <div id="searchPicturePage">
    <h2 style="margin-bottom: 16px">ä»¥å›¾æœå›¾</h2>
    <h3 style="margin: 16px 0">åŸå›¾</h3>
    <a-card style="width: 240px">
      <template #cover>
        <img
          style="height: 180px; object-fit: cover"
          :alt="picture.name"
          :src="picture.thumbnailUrl ?? picture.url"
        />
      </template>
    </a-card>
    <h3 style="margin: 16px 0">è¯†å›¾ç»“æœ</h3>
    <!-- å›¾ç‰‡åˆ—è¡¨ -->
    <a-list
      :grid="{ gutter: 16, xs: 1, sm: 2, md: 3, lg: 4, xl: 5, xxl: 6 }"
      :data-source="dataList"
    >
      <template #renderItem="{ item }">
        <a-list-item style="padding: 0">
          <a :href="item.fromUrl" target="_blank">
            <a-card>
              <template #cover>
                <img style="height: 180px; object-fit: cover" :src="item.thumbUrl" />
              </template>
            </a-card>
          </a>
        </a-list-item>
      </template>
    </a-list>
  </div>
</template>

<script setup lang="ts">
import { computed, onMounted, ref } from 'vue'
import { useRoute } from 'vue-router'
import { getPictureVoByIdUsingGet, searchPictureByPictureUsingPost } from '@/api/pictureController'
import { message } from 'ant-design-vue'

const route = useRoute()

// å›¾ç‰‡ id
const pictureId = computed(() => {
  return route.query?.pictureId
})

const picture = ref<API.PictureVO>({})

// è·å–è€æ•°æ®
const getOldPicture = async () => {
  // è·å–æ•°æ®
  const id = route.query?.pictureId
  if (id) {
    const res = await getPictureVoByIdUsingGet({
      id: id,
    })
    if (res.data.code === 0 && res.data.data) {
      const data = res.data.data
      picture.value = data
    }
  }
}

onMounted(() => {
  getOldPicture()
})
</script>
```

3ï¼‰è·å–å›¾ç‰‡æœç´¢ç»“æœï¼š

```typescript
const dataList = ref<API.ImageSearchResult[]>([])
// è·å–æœå›¾ç»“æœ
const fetchData = async () => {
  const res = await searchPictureByPictureUsingPost({
    pictureId: pictureId.value,
  })
  if (res.data.code === 0 && res.data.data) {
    dataList.value = res.data.data ?? []
  } else {
    message.error('è·å–æ•°æ®å¤±è´¥ï¼Œ' + res.data.message)
  }
}

// é¡µé¢åŠ è½½æ—¶è¯·æ±‚ä¸€æ¬¡
onMounted(() => {
  fetchData()
})
```

### æµ‹è¯•

ç»è¿‡æµ‹è¯•å‘ç°ï¼Œç™¾åº¦æœç´¢å¯¹äº webp æ ¼å¼å›¾ç‰‡çš„æ”¯æŒåº¦å¹¶ä¸å¥½ï¼ˆæ”¹æ–‡ä»¶çš„åç¼€ä¹Ÿæ²¡æœ‰ç”¨ï¼‰ï¼Œä¼°è®¡æ˜¯å¹³å°ä¸æ”¯æŒè¯¥æ ¼å¼çš„ç®—æ³•ã€‚

![img](https://pic.code-nav.cn/course_picture/1608440217629360130/w55VrnK9mSnubDMo.webp)

ä½†æ˜¯ä½¿ç”¨ png å›¾ç‰‡å»æµ‹è¯•ï¼Œå°±èƒ½æ­£å¸¸çœ‹åˆ°ç»“æœäº†ï¼š

![img](https://pic.code-nav.cn/course_picture/1608440217629360130/cB2N3TsPCsH3iKSQ.webp)

### æ‰©å±•

**è§£å†³ webp æ ¼å¼å›¾ç‰‡æ— æ³•æœç´¢çš„é—®é¢˜**

å¦‚æœæƒ³è§£å†³ä¸Šè¿°é—®é¢˜ï¼Œæœ‰å‡ ç§æ–¹æ¡ˆï¼š

1. ç›´æ¥åœ¨å‰ç«¯æ‹¿åˆ°è¯†å›¾ç»“æœ URL åï¼Œç›´æ¥æ–°é¡µé¢æ‰“å¼€ï¼Œè€Œä¸æ˜¯æŠŠè¯†å›¾ç»“æœæ”¾åˆ°è‡ªå·±çš„ç½‘ç«™é¡µé¢ä¸­
2. åˆ‡æ¢ä¸ºå…¶ä»–è¯†å›¾æ¥å£ï¼Œæ¯”å¦‚ [Bing ä»¥å›¾æœå›¾ API](https://learn.microsoft.com/en-us/bing/search-apis/bing-image-search/quickstarts/rest/java)
3. å°†æœ¬é¡¹ç›®çš„å›¾ç‰‡ä»¥ PNG æ ¼å¼è¿›è¡Œå‹ç¼©

## ä¸‰ã€å›¾ç‰‡æœç´¢ - é¢œè‰²æœç´¢

### éœ€æ±‚åˆ†æ

èƒ½å¤ŸæŒ‰ç…§é¢œè‰²æœç´¢ç©ºé—´å†… **ä¸»è‰²è°ƒ** æœ€ç›¸ä¼¼çš„å›¾ç‰‡ï¼Œåœ¨è®¾è®¡ã€åˆ›æ„å’Œç”µå•†é¢†åŸŸæœ‰å¹¿æ³›åº”ç”¨ã€‚

å‚è€ƒå…¶ä»–ç½‘ç«™çš„é¢œè‰²æœå›¾æ•ˆæœï¼š

![img](https://pic.code-nav.cn/course_picture/1608440217629360130/VGfTgY1fCfb49Wjm.webp)![img](https://pic.code-nav.cn/course_picture/1608440217629360130/Z4UQMfHrQw21H8vL.webp)

æ­¤å¤„æˆ‘ä»¬å°†è¯¥åŠŸèƒ½é™å®šåœ¨ç©ºé—´å†…ä½¿ç”¨ï¼Œä¸»è¦æ˜¯è€ƒè™‘åˆ°å…¬å…±å›¾åº“çš„å›¾ç‰‡æ•°é‡å¯èƒ½éå¸¸åºå¤§ï¼Œç›´æ¥è¿›è¡Œé¢œè‰²åŒ¹é…ä¼šå¯¼è‡´æœç´¢é€Ÿåº¦è¾ƒæ…¢ï¼Œå½±å“ç”¨æˆ·ä½“éªŒã€‚

### æ–¹æ¡ˆè®¾è®¡

éœ€è¦æ€è€ƒå‡ ä¸ªé—®é¢˜ï¼š

1. æ•´ä½“ä¸šåŠ¡æµç¨‹
2. æ€ä¹ˆè·å–å›¾ç‰‡ä¸»è‰²è°ƒï¼Ÿ
3. æ€ä¹ˆè®¾è®¡æœç´¢ç®—æ³•ï¼Ÿ

#### 1ã€æ•´ä½“æµç¨‹

ä¸ºäº†æå‡æ€§èƒ½ï¼Œé¿å…æ¯æ¬¡æœç´¢éƒ½å®æ—¶è®¡ç®—å›¾ç‰‡ä¸»è‰²è°ƒï¼Œå»ºè®®åœ¨å›¾ç‰‡ä¸Šä¼ æˆåŠŸåç«‹å³æå–ä¸»è‰²è°ƒå¹¶å­˜å‚¨åˆ°æ•°æ®åº“çš„ç‹¬ç«‹å­—æ®µä¸­ã€‚

å®Œæ•´æµç¨‹å¦‚ä¸‹ï¼š

1. æå–å›¾ç‰‡é¢œè‰²ï¼šé€šè¿‡å›¾åƒå¤„ç†æŠ€æœ¯ï¼ˆäº‘æœåŠ¡ API æˆ–è€… OpenCV å›¾åƒå¤„ç†åº“ï¼‰æå–å›¾ç‰‡çš„é¢œè‰²ç‰¹å¾ï¼Œå¯ä»¥é‡‡ç”¨ä¸»è‰²è°ƒã€é¢œè‰²ç›´æ–¹å›¾ç­‰æ–¹æ³•è¡¨ç¤ºå›¾ç‰‡çš„é¢œè‰²ç‰¹å¾ã€‚æ­¤å¤„æˆ‘ä»¬é‡‡ç”¨ä¸»è‰²è°ƒï¼Œä¾¿äºç†è§£ã€‚
2. å­˜å‚¨é¢œè‰²ç‰¹å¾ï¼šå°†æå–çš„é¢œè‰²æ•°æ®å­˜å‚¨åˆ°æ•°æ®åº“ä¸­ï¼Œä»¥ä¾¿åç»­å¿«é€Ÿæ£€ç´¢ã€‚
3. ç”¨æˆ·æŸ¥è¯¢è¾“å…¥ï¼šç”¨æˆ·é€šè¿‡é¢œè‰²é€‰æ‹©å™¨ã€RGB å€¼è¾“å…¥ã€æˆ–é¢„å®šä¹‰é¢œè‰²åç§°æŒ‡å®šé¢œè‰²æŸ¥è¯¢æ¡ä»¶ã€‚
4. è®¡ç®—ç›¸ä¼¼åº¦ï¼šæ ¹æ®ç”¨æˆ·æŒ‡å®šçš„é¢œè‰²ï¼Œä¸æ•°æ®åº“ä¸­çš„é¢œè‰²ç‰¹å¾è¿›è¡Œç›¸ä¼¼åº¦è®¡ç®—ï¼ˆå¦‚æ¬§æ°è·ç¦»ã€ä½™å¼¦ç›¸ä¼¼åº¦ç­‰æ–¹æ³•ï¼‰ã€‚
5. è¿”å›ç»“æœï¼šç”±äºç©ºé—´å†…çš„å›¾ç‰‡æ•°é‡ç›¸å¯¹è¾ƒå°‘ï¼Œå¯ä»¥æŒ‰ç…§å›¾ç‰‡ä¸ç›®æ ‡é¢œè‰²çš„ç›¸ä¼¼åº¦è¿›è¡Œæ’åºï¼Œä¼˜å…ˆè¿”å›æœ€ç¬¦åˆç”¨æˆ·è¦æ±‚çš„å›¾ç‰‡ï¼Œè€Œä¸æ˜¯ä»…è¿”å›å®Œå…¨ç¬¦åˆæŒ‡å®šè‰²è°ƒçš„å›¾ç‰‡ã€‚

![image.png](https://pic.code-nav.cn/course_picture/1608440217629360130/6SJQ9UYzUmx8LWVm.webp)

#### 2ã€æ€ä¹ˆè·å–å›¾ç‰‡ä¸»è‰²è°ƒï¼Ÿ

æˆ‘ä»¬å­˜å‚¨å›¾ç‰‡ä½¿ç”¨çš„ COS å¯¹è±¡å­˜å‚¨æœåŠ¡å·²ç»å¸®æˆ‘ä»¬æ•´åˆäº†æ•°æ®ä¸‡è±¡ï¼Œè‡ªå¸¦è·å–å›¾ç‰‡ä¸»è‰²è°ƒçš„åŠŸèƒ½ï¼Œ[å‚è€ƒæ–‡æ¡£](https://cloud.tencent.com/document/product/460/6928)ã€‚

ğŸ’¡ åœ¨ä½¿ç”¨äº‘æœåŠ¡åŠŸèƒ½å‰ï¼Œæˆ‘ä»¬å¯ä»¥è¯¦ç»†äº†è§£ä¸‹æœåŠ¡çš„ç›¸å…³é™åˆ¶ï¼Œæ¯”å¦‚ [æ•°æ®ä¸‡è±¡çš„é™åˆ¶](https://cloud.tencent.com/document/product/460/36620)ï¼Œä¸€èˆ¬æƒ…å†µä¸‹è¾¾ä¸åˆ°é™åˆ¶ã€‚

é™¤äº†æ–¹ä¾¿ä¹‹å¤–ï¼Œè¿™ä¸ªåŠŸèƒ½å±äºåŸºç¡€å›¾ç‰‡å¤„ç†ï¼Œå®˜æ–¹æä¾›çš„å…è´¹é¢åº¦è¾ƒé«˜ï¼Œé€‚åˆå­¦ä¹ æµ‹è¯•ï¼š

![img](https://pic.code-nav.cn/course_picture/1608440217629360130/eeaT4MwALmp14BC0.webp)![img](https://pic.code-nav.cn/course_picture/1608440217629360130/ht1whTerIFNgwx9D.webp)

ğŸ’¡ ä¸€èˆ¬æˆ‘ä»¬åšé¡¹ç›®æ—¶ï¼Œå°½å¯èƒ½å‡å°‘æ–°ä¾èµ–æˆ–æœåŠ¡çš„å¼•å…¥ï¼Œä¼šè®©æˆæœ¬æ›´å¯æ§ã€‚æ¯”å¦‚çœ‹åˆ°è…¾è®¯äº‘ COS æœ‰ç°æˆçš„æ”¯æŒå’Œå…è´¹é¢åº¦ï¼Œå°±å·²ç»æ˜¯æˆ‘ä»¬çš„é¦–é€‰è§£å†³æ–¹æ¡ˆï¼Œæ— éœ€è€ƒè™‘ç¬¬ä¸‰æ–¹ APIï¼Œå¯èƒ½ä¼šå¸¦æ¥çš„é¢å¤–é™åˆ¶å’Œå…¼å®¹æ€§é—®é¢˜ï¼ˆæ¯”å¦‚æˆ‘ä»¬çš„å›¾ç‰‡å¼€å¯é˜²ç›—é“¾ï¼Œå¯èƒ½å°±è§£æä¸åˆ°ï¼‰ã€‚

#### 3ã€å¦‚ä½•è®¡ç®—é¢œè‰²ç›¸ä¼¼åº¦ï¼Ÿ

æ•°æ®åº“ä¸æ”¯æŒç›´æ¥æŒ‰ç…§é¢œè‰²æ£€ç´¢ï¼Œç”¨ like æ£€ç´¢åˆä¸ç¬¦åˆé¢œè‰²çš„ç‰¹æ€§ã€‚æ‰€ä»¥å¯ä»¥ä½¿ç”¨ä¸€äº›ç®—æ³•æ¥è§£å†³ã€‚

æ­¤å¤„ä½¿ç”¨ **æ¬§å‡ é‡Œå¾—è·ç¦»** ç®—æ³•ï¼šé¢œè‰²å¯ä»¥ç”¨ RGB å€¼è¡¨ç¤ºï¼Œå¯ä»¥é€šè¿‡è®¡ç®—ä¸¤ç§é¢œè‰² RGB å€¼ä¹‹é—´çš„æ¬§å‡ é‡Œå¾—è·ç¦»æ¥åˆ¤æ–­å®ƒä»¬çš„ç›¸ä¼¼åº¦ã€‚

å…¬å¼ï¼š

![img](https://pic.code-nav.cn/course_picture/1608440217629360130/nWynsl5jOf7pL7VA.png)

è§£é‡Šï¼š

- R1, G1, B1ï¼šç¬¬ä¸€ä¸ªé¢œè‰²çš„ RGB åˆ†é‡ï¼ˆçº¢è‰²ã€ç»¿è‰²ã€è“è‰²ï¼‰ã€‚
- R2, G2, B2ï¼šç¬¬äºŒä¸ªé¢œè‰²çš„ RGB åˆ†é‡ã€‚
- dï¼šä¸¤ä¸ªé¢œè‰²ä¹‹é—´çš„æ¬§å‡ é‡Œå¾—è·ç¦»ã€‚

è·ç¦»è¶Šå°ï¼Œè¡¨ç¤ºé¢œè‰²è¶Šç›¸ä¼¼ï¼›è·ç¦»è¶Šå¤§ï¼Œè¡¨ç¤ºé¢œè‰²è¶Šä¸åŒã€‚

è¿˜æœ‰ä¸€äº›å…¶ä»–çš„æ–¹æ³•ï¼Œéœ€è¦ç”¨åˆ°æ—¶è‡ªå·±åœ¨ç½‘ä¸Šè°ƒç ”å³å¯ï¼š

- ä½™å¼¦ç›¸ä¼¼åº¦ (Cosine Similarity)ï¼Œé±¼çš®åœ¨ç¼–ç¨‹å¯¼èˆªçš„ [ä¼™ä¼´åŒ¹é…ç³»ç»Ÿé¡¹ç›®](https://www.codefather.cn/course/1790950013153095682) ä¸­æœ‰è®²è¿‡
- æ›¼å“ˆé¡¿è·ç¦» (Manhattan Distance)
- Jaccard ç›¸ä¼¼åº¦ (Jaccard Similarity)
- å¹³å‡é¢œè‰²å·®å¼‚ (Mean Color Difference)
- å“ˆå¸Œç®—æ³• (Color Hashing)
- è‰²è°ƒã€é¥±å’Œåº¦å’Œäº®åº¦ (HSL) å·®å¼‚

### åç«¯å¼€å‘

#### 1ã€è¡¥å……é¢œè‰²å­—æ®µ

1ï¼‰å›¾ç‰‡è¡¨æ–°å¢å­—æ®µï¼Œæ‰§è¡Œ SQLï¼š

```sql
ALTER TABLE picture
    ADD COLUMN picColor varchar(16) null comment 'å›¾ç‰‡ä¸»è‰²è°ƒ';
```

2ï¼‰æ¯æ¬¡æ–°å¢å­—æ®µæ—¶ï¼Œéƒ½è¦ä¿®æ”¹ PictureMapper.xml ä»¥æ”¯æŒæ–°å­—æ®µçš„æŸ¥è¯¢ã€‚

Picture å®ä½“ç±»ã€PictureVO åŒ…è£…ç±»ã€UploadPictureResult ä¸Šä¼ å›¾ç‰‡ç»“æœç±»ä¹Ÿéœ€è¦è¡¥å……æ–°å­—æ®µï¼š

```java
/**
 * å›¾ç‰‡ä¸»è‰²è°ƒ
 */
private String picColor;
```

#### 2ã€å­˜å‚¨é¢œè‰²

1ï¼‰ä¿®æ”¹ PictureUploadTemplate çš„ buildResult æ–¹æ³•ï¼Œç›´æ¥ä» ImageInfo å¯¹è±¡ä¸­å°±èƒ½è·å¾—ä¸»è‰²è°ƒï¼š

```java
uploadPictureResult.setPicColor(imageInfo.getAve());
```

æ³¨æ„ä¸¤ä¸ª buildResult æ–¹æ³•éƒ½è¦ä¿®æ”¹ï¼Œå…¶ä¸­ä¸€ä¸ª buildResult æ–¹æ³•è¦è¡¥å…… imageInfo å‚æ•°ï¼Œä¿®æ”¹çš„ä»£ç å¦‚ä¸‹ï¼š

```java
private UploadPictureResult buildResult(String originFilename, CIObject compressedCiObject, CIObject thumbnailCiObject, ImageInfo imageInfo) {
    UploadPictureResult uploadPictureResult = new UploadPictureResult();
    int picWidth = compressedCiObject.getWidth();
    int picHeight = compressedCiObject.getHeight();
    double picScale = NumberUtil.round(picWidth * 1.0 / picHeight, 2).doubleValue();
    uploadPictureResult.setPicName(FileUtil.mainName(originFilename));
    uploadPictureResult.setPicWidth(picWidth);
    uploadPictureResult.setPicHeight(picHeight);
    uploadPictureResult.setPicScale(picScale);
    uploadPictureResult.setPicFormat(compressedCiObject.getFormat());
    uploadPictureResult.setPicColor(imageInfo.getAve());
    uploadPictureResult.setPicSize(compressedCiObject.getSize().longValue());
    // è®¾ç½®å›¾ç‰‡ä¸ºå‹ç¼©åçš„åœ°å€
    uploadPictureResult.setUrl(cosClientConfig.getHost() + "/" + compressedCiObject.getKey());
    // è®¾ç½®ç¼©ç•¥å›¾
    uploadPictureResult.setThumbnailUrl(cosClientConfig.getHost() + "/" + thumbnailCiObject.getKey());
    return uploadPictureResult;
}
```

è·å–åˆ°çš„å€¼æ ¼å¼ä¸ºåå…­è¿›åˆ¶ï¼Œå¦‚å›¾ï¼š

![img](https://pic.code-nav.cn/course_picture/1608440217629360130/uw1PSYlaT3uRYN0h.webp)

2ï¼‰å›¾ç‰‡æœåŠ¡çš„ uploadPicture ä¸­è¡¥å……è®¾ç½® picColorï¼Œä»è€Œå°†è¯¥å­—æ®µä¿å­˜åˆ°æ•°æ®åº“ä¸­ï¼š

```java
picture.setPicColor(uploadPictureResult.getPicColor());
```

#### 3ã€é¢œè‰²ç›¸ä¼¼åº¦è®¡ç®—

æ–°å»º `utils` åŒ…ï¼Œç›´æ¥åˆ©ç”¨ AI æ¥ç¼–å†™å·¥å…·ç±»ï¼š

```java
/**
 * å·¥å…·ç±»ï¼šè®¡ç®—é¢œè‰²ç›¸ä¼¼åº¦
 */
public class ColorSimilarUtils {

    private ColorSimilarUtils() {
        // å·¥å…·ç±»ä¸éœ€è¦å®ä¾‹åŒ–
    }

    /**
     * è®¡ç®—ä¸¤ä¸ªé¢œè‰²çš„ç›¸ä¼¼åº¦
     *
     * @param color1 ç¬¬ä¸€ä¸ªé¢œè‰²
     * @param color2 ç¬¬äºŒä¸ªé¢œè‰²
     * @return ç›¸ä¼¼åº¦ï¼ˆ0åˆ°1ä¹‹é—´ï¼Œ1ä¸ºå®Œå…¨ç›¸åŒï¼‰
     */
    public static double calculateSimilarity(Color color1, Color color2) {
        int r1 = color1.getRed();
        int g1 = color1.getGreen();
        int b1 = color1.getBlue();

        int r2 = color2.getRed();
        int g2 = color2.getGreen();
        int b2 = color2.getBlue();

        // è®¡ç®—æ¬§æ°è·ç¦»
        double distance = Math.sqrt(Math.pow(r1 - r2, 2) + Math.pow(g1 - g2, 2) + Math.pow(b1 - b2, 2));

        // è®¡ç®—ç›¸ä¼¼åº¦
        return 1 - distance / Math.sqrt(3 * Math.pow(255, 2));
    }

    /**
     * æ ¹æ®åå…­è¿›åˆ¶é¢œè‰²ä»£ç è®¡ç®—ç›¸ä¼¼åº¦
     *
     * @param hexColor1 ç¬¬ä¸€ä¸ªé¢œè‰²çš„åå…­è¿›åˆ¶ä»£ç ï¼ˆå¦‚ 0xFF0000ï¼‰
     * @param hexColor2 ç¬¬äºŒä¸ªé¢œè‰²çš„åå…­è¿›åˆ¶ä»£ç ï¼ˆå¦‚ 0xFE0101ï¼‰
     * @return ç›¸ä¼¼åº¦ï¼ˆ0åˆ°1ä¹‹é—´ï¼Œ1ä¸ºå®Œå…¨ç›¸åŒï¼‰
     */
    public static double calculateSimilarity(String hexColor1, String hexColor2) {
        Color color1 = Color.decode(hexColor1);
        Color color2 = Color.decode(hexColor2);
        return calculateSimilarity(color1, color2);
    }

    // ç¤ºä¾‹ä»£ç 
    public static void main(String[] args) {
        // æµ‹è¯•é¢œè‰²
        Color color1 = Color.decode("0xFF0000");
        Color color2 = Color.decode("0xFE0101");
        double similarity = calculateSimilarity(color1, color2);

        System.out.println("é¢œè‰²ç›¸ä¼¼åº¦ä¸ºï¼š" + similarity);

        // æµ‹è¯•åå…­è¿›åˆ¶æ–¹æ³•
        double hexSimilarity = calculateSimilarity("0xFF0000", "0xFE0101");
        System.out.println("åå…­è¿›åˆ¶é¢œè‰²ç›¸ä¼¼åº¦ä¸ºï¼š" + hexSimilarity);
    }
}
```

#### 4ã€é¢œè‰²æŸ¥è¯¢æœåŠ¡

ä¸ºäº†è®©å¤§å®¶å­¦ä¹ æ›´æ¸…æ™°ï¼Œåœ¨å›¾ç‰‡æœåŠ¡ä¸­æ–°ç¼–å†™æŒ‰é¢œè‰²æŸ¥è¯¢å›¾ç‰‡çš„æ–¹æ³• searchPictureByColorï¼Œä¸å’Œå…¶ä»–çš„æœç´¢æ¡ä»¶æ”¾åœ¨ä¸€èµ·ã€‚

æŒ‰ç…§æ–¹æ¡ˆè®¾è®¡ä¸­çš„æµç¨‹å¼€å‘ï¼Œä»£ç å¦‚ä¸‹ï¼š

```java
@Override
public List<PictureVO> searchPictureByColor(Long spaceId, String picColor, User loginUser) {
    // 1. æ ¡éªŒå‚æ•°
    ThrowUtils.throwIf(spaceId == null || StrUtil.isBlank(picColor), ErrorCode.PARAMS_ERROR);
    ThrowUtils.throwIf(loginUser == null, ErrorCode.NO_AUTH_ERROR);
    // 2. æ ¡éªŒç©ºé—´æƒé™
    Space space = spaceService.getById(spaceId);
    ThrowUtils.throwIf(space == null, ErrorCode.NOT_FOUND_ERROR, "ç©ºé—´ä¸å­˜åœ¨");
    if (!loginUser.getId().equals(space.getUserId())) {
        throw new BusinessException(ErrorCode.NO_AUTH_ERROR, "æ²¡æœ‰ç©ºé—´è®¿é—®æƒé™");
    }
    // 3. æŸ¥è¯¢è¯¥ç©ºé—´ä¸‹æ‰€æœ‰å›¾ç‰‡ï¼ˆå¿…é¡»æœ‰ä¸»è‰²è°ƒï¼‰
    List<Picture> pictureList = this.lambdaQuery()
            .eq(Picture::getSpaceId, spaceId)
            .isNotNull(Picture::getPicColor)
            .list();
    // å¦‚æœæ²¡æœ‰å›¾ç‰‡ï¼Œç›´æ¥è¿”å›ç©ºåˆ—è¡¨
    if (CollUtil.isEmpty(pictureList)) {
        return Collections.emptyList();
    }
    // å°†ç›®æ ‡é¢œè‰²è½¬ä¸º Color å¯¹è±¡
    Color targetColor = Color.decode(picColor);
    // 4. è®¡ç®—ç›¸ä¼¼åº¦å¹¶æ’åº
    List<Picture> sortedPictures = pictureList.stream()
            .sorted(Comparator.comparingDouble(picture -> {
                // æå–å›¾ç‰‡ä¸»è‰²è°ƒ
                String hexColor = picture.getPicColor();
                // æ²¡æœ‰ä¸»è‰²è°ƒçš„å›¾ç‰‡æ”¾åˆ°æœ€å
                if (StrUtil.isBlank(hexColor)) {
                    return Double.MAX_VALUE;
                }
                Color pictureColor = Color.decode(hexColor);
                // è¶Šå¤§è¶Šç›¸ä¼¼
                return -ColorSimilarUtils.calculateSimilarity(targetColor, pictureColor);
            }))
            // å–å‰ 12 ä¸ª
            .limit(12)
            .collect(Collectors.toList());

    // è½¬æ¢ä¸º PictureVO
    return sortedPictures.stream()
            .map(PictureVO::objToVo)
            .collect(Collectors.toList());
}
```

ä¸Šè¿°ä»£ç æœ‰ 2 ä¸ªå°ç»†èŠ‚ï¼š

1. æˆ‘ä»¬æå‰æŠŠç›®æ ‡é¢œè‰²ä»å­—ç¬¦ä¸²è½¬ä¸º color å¯¹è±¡ï¼Œè€Œä¸æ˜¯æ¯è®¡ç®—ä¸€å¼ å›¾éƒ½é‡æ–°è½¬æ¢ä¸€æ¬¡å¯¹è±¡ã€‚
2. æœ€åå°† Picture è½¬ä¸º PictureVO æ—¶ï¼Œä¸è¦è°ƒç”¨ service ä¸­çš„è½¬æ¢æ–¹æ³•ï¼Œä¼šé¢å¤–æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼Œè¿™æ˜¯æ²¡å¿…è¦çš„ã€‚

#### 5ã€æ¥å£å¼€å‘

1ï¼‰è¯·æ±‚å°è£…ç±» SearchPictureByColorRequestï¼Œéœ€è¦ä¼ å…¥ç©ºé—´ id å’Œä¸»è‰²è°ƒï¼š

```java
@Data
public class SearchPictureByColorRequest implements Serializable {

    /**
     * å›¾ç‰‡ä¸»è‰²è°ƒ
     */
    private String picColor;

    /**
     * ç©ºé—´ id
     */
    private Long spaceId;

    private static final long serialVersionUID = 1L;
}
```

2ï¼‰å¼€å‘æ¥å£ï¼š

```java
@PostMapping("/search/color")
public BaseResponse<List<PictureVO>> searchPictureByColor(@RequestBody SearchPictureByColorRequest searchPictureByColorRequest, HttpServletRequest request) {
    ThrowUtils.throwIf(searchPictureByColorRequest == null, ErrorCode.PARAMS_ERROR);
    String picColor = searchPictureByColorRequest.getPicColor();
    Long spaceId = searchPictureByColorRequest.getSpaceId();
    User loginUser = userService.getLoginUser(request);
    List<PictureVO> result = pictureService.searchPictureByColor(spaceId, picColor, loginUser);
    return ResultUtils.success(result);
}
```

### å‰ç«¯å¼€å‘

#### 1ã€é¢œè‰²æœç´¢

1ï¼‰é€‰æ‹©é¢œè‰²é€‰æ‹©å™¨ç»„ä»¶ [vue3-colorpicker](https://github.com/aesoper101/vue3-colorpicker?tab=readme-ov-file)ï¼Œ[å‚è€ƒæ–‡æ¡£](https://aesoper101.github.io/vue3-colorpicker/?path=/docs/example-colorpicker--docs) æ¥äº†è§£ä½¿ç”¨æ–¹æ³•å’Œå‚æ•°ã€‚

å®‰è£…ç»„ä»¶ï¼š

```shell
npm install vue3-colorpicker
```

2ï¼‰åœ¨ç©ºé—´è¯¦æƒ…é¡µæ–°å¢é¢œè‰²æœç´¢ã€‚å› ä¸ºè·Ÿå…¶ä»–æœç´¢ä¸æ˜¯è”åŠ¨çš„ï¼Œæ‰€ä»¥ç‹¬ç«‹å‡ºæ¥ï¼Œæ”¾åˆ°æœç´¢æ¡†ä¸‹é¢ã€‚

```vue
<!-- æŒ‰é¢œè‰²æœç´¢ -->
<a-form-item label="æŒ‰é¢œè‰²æœç´¢" style="margin-top: 16px">
  <color-picker format="hex" @pureColorChange="onColorChange" />
</a-form-item>
```

æ³¨æ„ï¼Œformat è¦è®¾ç½®ä¸º hexï¼Œå¾—åˆ°åå…­è¿›åˆ¶çš„é¢œè‰²å€¼ã€‚

3ï¼‰ç¼–å†™åˆ‡æ¢é¢œè‰²äº‹ä»¶å‡½æ•°ï¼Œåˆ‡æ¢é¢œè‰²æ—¶ä¼šè§¦å‘æœç´¢ï¼š

```typescript
const onColorChange = async (color: string) => {
  const res = await searchPictureByColorUsingPost({
    picColor: color,
    spaceId: props.id,
  })
  if (res.data.code === 0 && res.data.data) {
    const data = res.data.data ?? [];
    dataList.value = data;
    total.value = data.length;
  } else {
    message.error('è·å–æ•°æ®å¤±è´¥ï¼Œ' + res.data.message)
  }
}
```

æ•ˆæœå¦‚å›¾ï¼š

![img](https://pic.code-nav.cn/course_picture/1608440217629360130/Ti2739V0NdBKTezf.webp)

#### 2ã€å±•ç¤ºå›¾ç‰‡ä¸»è‰²è°ƒ

å›¾ç‰‡è¯¦æƒ…é¡µè¡¥å……é¢œè‰²ä¸»è‰²è°ƒçš„å±•ç¤ºï¼Œå¯ä»¥ä½¿ç”¨ä¸€ä¸ªå°è‰²å—è®©é¢œè‰²å±•ç¤ºæ•ˆæœæ›´æ˜æ˜¾ï¼š

```vue
<a-descriptions-item label="ä¸»è‰²è°ƒ">
  <a-space>
    {{ picture.picColor ?? '-' }}
    <div
      v-if="picture.picColor"
      :style="{
        backgroundColor: toHexColor(picture.picColor),
        width: '16px',
        height: '16px',
      }"
    />
  </a-space>
</a-descriptions-item>
```

ç”±äºåç«¯æ•°æ®ä¸‡è±¡è®¡ç®—å‡ºçš„è‰²å€¼æ ¼å¼ä¸æ˜¯æ ‡å‡†çš„ï¼Œå­˜åœ¨ç±»ä¼¼ `0x080e0` çš„è‰²å€¼ï¼Œéœ€è¦è½¬æ¢ä¸ºæ ‡å‡† 16 è¿›åˆ¶è‰²å€¼ï¼š

```typescript
export function toHexColor(input) {
  // å»æ‰ 0x å‰ç¼€
  const colorValue = input.startsWith('0x') ? input.slice(2) : input

  // å°†å‰©ä½™éƒ¨åˆ†è§£æä¸ºåå…­è¿›åˆ¶æ•°ï¼Œå†è½¬æˆ 6 ä½åå…­è¿›åˆ¶å­—ç¬¦ä¸²
  const hexColor = parseInt(colorValue, 16).toString(16).padStart(6, '0')

  // è¿”å›æ ‡å‡† #RRGGBB æ ¼å¼
  return `#${hexColor}`
}
```

æ•ˆæœå¦‚å›¾ï¼š

![img](https://pic.code-nav.cn/course_picture/1608440217629360130/hDF5iHa0uXf7I8z7.webp)

### æ‰©å±•

1ã€åˆ·æ–°å†å²æ•°æ®ï¼Œè®©æ‰€æœ‰çš„å›¾ç‰‡éƒ½æœ‰ä¸»è‰²è°ƒã€‚

2ã€å°†é¢œè‰²æœç´¢å’Œå…¶ä»–çš„æœç´¢ç›¸ç»“åˆï¼Œæ¯”å¦‚å…ˆç”¨å…¶ä»–çš„æœç´¢æ¡ä»¶è¿‡æ»¤æ•°æ®ï¼Œå†è¿ç”¨ç›¸ä¼¼åº¦ç®—æ³•æ’åºã€‚

3ã€å°†é¢œè‰²æœç´¢åº”ç”¨åˆ°ä¸»é¡µå…¬å…±å›¾åº“ã€å›¾ç‰‡ç®¡ç†é¡µé¢ç­‰ã€‚

4ã€ä½¿ç”¨ ES åˆ†è¯æœç´¢å›¾ç‰‡çš„åç§°å’Œç®€ä»‹ï¼Œ[é±¼çš®ç¼–ç¨‹å¯¼èˆªçš„èšåˆæœç´¢é¡¹ç›®](https://www.codefather.cn/course/1790979621621641217)ã€[é¢è¯•åˆ·é¢˜å¹³å°é¡¹ç›®](https://www.codefather.cn/course/1826803928691945473/) éƒ½æœ‰ä» 0 å¼€å§‹çš„ ES è®²è§£ã€‚

5ã€å¤šæ¨¡æ€æœç´¢ï¼šå¯ä»¥ç”¨æ–‡å­—æœç´¢å›¾ç‰‡å†…å®¹ï¼Œä¸€èˆ¬ä½¿ç”¨ç¬¬ä¸‰æ–¹äº‘æœåŠ¡å®ç°ã€‚æ¯”å¦‚ [æ™ºèƒ½æ£€ç´¢ MetaInsight](https://cloud.tencent.com/document/product/460/105859)ï¼Œå¯ä»¥é€šè¿‡è‡ªç„¶è¯­è¨€æˆ–ç»“æ„åŒ–çš„æ£€ç´¢æ¡ä»¶ï¼Œåˆ†æå­˜å‚¨åœ¨å¯¹è±¡å­˜å‚¨ COS ä¸­çš„æ–‡ä»¶ï¼Œæ»¡è¶³å¯¹å­˜å‚¨æ•°æ®çš„ç®¡ç†ã€åˆ†æã€æ£€ç´¢éœ€æ±‚ã€‚

æ™ºèƒ½æ£€ç´¢åˆ©ç”¨æ•°æ®ä¸‡è±¡å·²æœ‰çš„å›¾ç‰‡ã€è§†é¢‘ã€è¯­éŸ³ã€æ–‡æ¡£ç­‰æ•°æ®å¤„ç†èƒ½åŠ›ï¼Œæå–æ–‡ä»¶çš„ç‰¹å¾æˆ–å…ƒæ•°æ®å¹¶ç´¢å¼•åˆ°æ•°æ®é›†ä¸­ï¼Œæä¾›æ–‡ä»¶çš„èšåˆç»Ÿè®¡æŸ¥è¯¢ã€äººè„¸å›¾åƒæ£€ç´¢ã€å›¾ç‰‡å†…å®¹æ£€ç´¢ç­‰èƒ½åŠ›ã€‚

ä½¿ç”¨å®ƒèƒ½å®ç°æ›´æ™ºèƒ½çš„æœç´¢ï¼Œæ¯”å¦‚ï¼š

- å›¾ç‰‡è‡ªåŠ¨æ‰“æ ‡ç­¾
- è‡ªåŠ¨è¯†åˆ«å‡ºç›¸åŒçš„äººç‰©è¿›è¡Œåˆ†ç±»ï¼ˆæ‰‹æœºæ™ºèƒ½ç›¸å†Œï¼‰

6ã€è‡ªåŠ¨æŒ‰æ—¥æœŸå°†å›¾ç‰‡åˆ†ç±»åˆ°ä¸åŒçš„æ–‡ä»¶å¤¹ä¸­

7ã€é¢œè‰²æ£€ç´¢æ—¶ï¼Œå®šä¹‰ä¸€ä¸ªé˜ˆå€¼èŒƒå›´ï¼Œè¿‡æ»¤æ‰ä¸ç›¸ä¼¼é¢œè‰²ã€‚

## å››ã€å›¾ç‰‡åˆ†äº«

### éœ€æ±‚åˆ†æ

ä¸ºäº†æå‡ç½‘ç«™çš„ç”¨æˆ·æ•°é‡ï¼Œæˆ‘ä»¬éœ€è¦æ·»åŠ å¤šä¸ªå¼•å¯¼ç”¨æˆ·åˆ†äº«ç½‘ç«™çš„æŒ‰é’®ï¼Œå¹¶ä¸”ç¡®ä¿ä¸ªäººç”¨æˆ·èƒ½å¤Ÿæ›´æ–¹ä¾¿åœ°é€šè¿‡æ‰‹æœºè®¿é—®å’Œåˆ†äº«ç½‘ç«™å†…å®¹ã€‚

æ”¯æŒä¸¤ç§åˆ†äº«å½¢å¼ï¼šç§»åŠ¨ç«¯æ‰«ç åˆ†äº«å’Œå¤åˆ¶é“¾æ¥åˆ†äº«ï¼ŒåŒæ—¶å…¼å®¹ç§»åŠ¨ç«¯å’Œ PC ç«¯ã€‚

### æ–¹æ¡ˆè®¾è®¡

è¯¥åŠŸèƒ½çš„å®ç°ä»¥å‰ç«¯ä¸ºä¸»ï¼Œä¸æ¶‰åŠåç«¯å¼€å‘ã€‚

#### 1ã€é€šç”¨åˆ†äº«ç»„ä»¶

ç”±äºç½‘ç«™å¤šä¸ªä½ç½®éƒ½å¯ä»¥è§¦å‘åˆ†äº«ã€‚å¯ä»¥å¼€å‘ä¸€ä¸ªé€šç”¨çš„å¼¹çª—åˆ†äº«ç»„ä»¶ï¼Œå¹¶åœ¨ç½‘ç«™çš„å„ä¸ªé¡µé¢ï¼ˆæˆ–ç»„ä»¶ï¼‰ä¸­å¼•å…¥ã€‚

ç”¨æˆ·ç‚¹å‡»åˆ†äº«æŒ‰é’®æ—¶ï¼Œåˆ†äº«å¼¹çª—ä¼šå¼¹å‡ºï¼Œå¹¶å±•ç¤ºå¤šç§ä¸åŒçš„åˆ†äº«æ–¹å¼ï¼Œå¼•å¯¼ç”¨æˆ·é¡ºåˆ©å®Œæˆåˆ†äº«ã€‚

#### 2ã€åˆ†äº«å…¥å£

å¯ä»¥åœ¨å›¾ç‰‡è¯¦æƒ…é¡µã€ä¸ªäººç©ºé—´çš„å›¾ç‰‡å¡ç‰‡æ“ä½œæ ä¸­å¢åŠ åˆ†äº«å…¥å£ã€‚å½“ç„¶ä¹Ÿå¯ä»¥åœ¨ä¸»é¡µç­‰å…¶ä»–åˆé€‚çš„ä½ç½®åˆ†äº«~

#### 3ã€å¤åˆ¶é“¾æ¥åˆ†äº«

æˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨ Ant Design çš„ [å¯å¤åˆ¶æ–‡æœ¬ç»„ä»¶](https://antdv.com/components/typography-cn#components-typography-demo-interactive)ï¼Œä¹Ÿå¯ä»¥é‡‡ç”¨ç¬¬ä¸‰æ–¹åº“å¦‚ [copy-text-to-clipboard](https://www.npmjs.com/package/copy-text-to-clipboard) æ¥å®ç°å¤åˆ¶é“¾æ¥åŠŸèƒ½ã€‚

#### 4ã€ç§»åŠ¨ç«¯æ‰«ç åˆ†äº«

ç§»åŠ¨ç«¯æ‰«ç åˆ†äº«å¯ä»¥ä½¿ç”¨ [ç»„ä»¶åº“çš„ qrcode ç»„ä»¶](https://antdv.com/components/qrcode-cn)ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ç¬¬ä¸‰æ–¹çš„ [qrcode ç»„ä»¶](https://www.npmjs.com/package/qrcode)ã€‚å…¶åŸç†æ˜¯å°†åˆ†äº«é“¾æ¥è½¬åŒ–ä¸ºäºŒç»´ç å›¾ç‰‡ï¼Œç”¨æˆ·æ‰«æäºŒç»´ç åå³å¯è®¿é—®é“¾æ¥ã€‚

#### æ‰©å±•çŸ¥è¯† - å¾®ä¿¡å¡ç‰‡åˆ†äº«

å¯ä»¥ç»™ç½‘ç«™æ¥å…¥å¾®ä¿¡ js-sdk å®ç°å¾®ä¿¡å¡ç‰‡åˆ†äº«èƒ½åŠ›ã€‚ç”¨æˆ·åœ¨ç½‘é¡µå†…åˆ†äº«åˆ°å¾®ä¿¡æ—¶ï¼Œç”¨æˆ·çœ‹åˆ°çš„ä¸å†æ˜¯ä¸€ä¸ªå¹²å·´å·´çš„é“¾æ¥ï¼Œè€Œæ˜¯å¯ä»¥è‡ªå®šä¹‰å±•ç¤ºçš„æ ‡é¢˜å’Œå›¾ç‰‡ã€‚[å‚è€ƒæ–‡æ¡£](https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/JS-SDK.html#10)

æ¯”å¦‚æˆ‘ä»¬çš„è€é±¼ç®€å†ï¼Œå°±æ˜¯è¿™ä¹ˆåšçš„ï¼Œåˆ†äº«æ•ˆæœå¦‚å›¾ï¼š

![img](https://pic.code-nav.cn/course_picture/1608440217629360130/lFxBeagvOk5vJXKh.webp)

### å‰ç«¯å¼€å‘

#### 1ã€é€šç”¨å¼¹çª—åˆ†äº«ç»„ä»¶

1ï¼‰æ–°å¢ ShareModal ç»„ä»¶ï¼Œä½¿ç”¨ [Modal å¼¹çª—ç»„ä»¶](https://antdv.com/components/modal-cn)ï¼Œæ”¯æŒä¼ å…¥ title æ ‡é¢˜å’Œ link åˆ†äº«é“¾æ¥å±æ€§ï¼Œå¯ä»¥ç”±çˆ¶ç»„ä»¶å†³å®šè¦åˆ†äº«çš„ä¿¡æ¯ã€‚

ä»£ç å¦‚ä¸‹ï¼š

```vue
<template>
  <a-modal v-model:visible="visible" title="åˆ†äº«å›¾ç‰‡" :footer="false" @cancel="closeModal">
    <h4>å¤åˆ¶åˆ†äº«é“¾æ¥</h4>
    <a-typography-link copyable>
      {{ link }}
    </a-typography-link>
    <div style="margin-bottom: 16px" />
    <h4>æ‰‹æœºæ‰«ç æŸ¥çœ‹</h4>
    <a-qrcode :value="link" />
  </a-modal>
</template>

<script setup lang="ts">
import { defineProps, ref, withDefaults, defineExpose } from 'vue'

/**
 * å®šä¹‰ç»„ä»¶å±æ€§ç±»å‹
 */
interface Props {
  title: string
  link: string
}

/**
 * ç»™ç»„ä»¶æŒ‡å®šåˆå§‹å€¼
 */
const props = withDefaults(defineProps<Props>(), {
  title: () => 'åˆ†äº«',
  link: () => 'https://laoyujianli.com/share/yupi',
})
</script>
```

2ï¼‰å®šä¹‰ visible å˜é‡å’Œå¼¹çª—æ‰“å¼€å…³é—­çš„å‡½æ•°ï¼Œç”¨äºæ§åˆ¶å¼¹çª—æ˜¯å¦å¯è§ï¼šbgMhj83Bt96lFcj29lBZCF0o0+YPCGWOWUw0OPyFB/Q=

```typescript
// æ˜¯å¦å¯è§
const visible = ref(false)

// æ‰“å¼€å¼¹çª—
const openModal = () => {
  visible.value = true
}

// å…³é—­å¼¹çª—
const closeModal = () => {
  visible.value = false
}
```

3ï¼‰ä¸ºäº†æ–¹ä¾¿å…¶ä»–é¡µé¢ä½¿ç”¨ç»„ä»¶ï¼Œéœ€è¦æš´éœ²å‡º openModal å‡½æ•°ï¼š

```javascript
import { defineExpose } from "vue";

// æš´éœ²å‡½æ•°ç»™çˆ¶ç»„ä»¶
defineExpose({
  openModal,
});
```

#### 2ã€å›¾ç‰‡åˆ—è¡¨ä½¿ç”¨ç»„ä»¶

1ï¼‰å›¾ç‰‡åˆ—è¡¨ç»„ä»¶ä¸­å¼•å…¥å¼¹çª—åˆ†äº«ç»„ä»¶ï¼Œæ³¨æ„è¦åœ¨ for å¾ªç¯å¤–å¼•å…¥ï¼š

```vue
â–¼vue

å¤åˆ¶ä»£ç <ShareModal ref="shareModalRef" :link="shareLink" />
```

2ï¼‰ç¼–å†™è§¦å‘åˆ†äº«çš„å…¥å£ï¼Œç‚¹å‡»åˆ†äº«å›¾æ ‡åæ‰“å¼€å¼¹çª—ã€‚å¯ä»¥ç§»é™¤æ“ä½œæ çš„æ–‡å­—ï¼Œè®©å›¾ç‰‡å¡ç‰‡çœ‹èµ·æ¥æ›´ç²¾ç®€ï¼š

```vue
<template v-if="showOp" #actions>
  <search-outlined @click="(e) => doSearch(picture, e)" />
  <share-alt-outlined @click="(e) => doShare(picture, e)" />
  <edit-outlined @click="(e) => doEdit(picture, e)" />
  <delete-outlined @click="(e) => doDelete(picture, e)" />
</template>
```

3ï¼‰ç¼–å†™åˆ†äº«å‡½æ•°ï¼Œæ‰“å¼€åˆ†äº«å¼¹çª—ã€‚æ³¨æ„ä¸è¦ç¡¬ç¼–ç åˆ†äº«é“¾æ¥çš„è·¯å¾„ï¼Œè€Œæ˜¯å¯ä»¥è·å–å½“å‰çš„ç½‘å€ï¼Œä»£ç å¦‚ä¸‹ï¼š

```javascript
// åˆ†äº«å¼¹çª—å¼•ç”¨
const shareModalRef = ref()
// åˆ†äº«é“¾æ¥
const shareLink = ref<string>()

// åˆ†äº«
const doShare = (picture: API.PictureVO, e: Event) => {
  e.stopPropagation()
  shareLink.value = `${window.location.protocol}//${window.location.host}/picture/${picture.id}`
  if (shareModalRef.value) {
    shareModalRef.value.openModal()
  }
}
```

æ•ˆæœå¦‚å›¾ï¼š

![img](https://pic.code-nav.cn/course_picture/1608440217629360130/KceFGSFMFq4WZlo0.webp)

#### 3ã€å›¾ç‰‡è¯¦æƒ…é¡µä½¿ç”¨ç»„ä»¶

1ï¼‰åœ¨å…è´¹ä¸‹è½½æŒ‰é’®çš„å³è¾¹å¢åŠ åˆ†äº«æŒ‰é’®ï¼š

```vue
<a-button type="primary" ghost @click="doShare">
  åˆ†äº«
  <template #icon>
    <share-alt-outlined />
  </template>
</a-button>
```

2ï¼‰åˆ†äº«å‡½æ•°å°±å¾ˆç®€å•äº†ï¼Œå¤åˆ¶å›¾ç‰‡åˆ—è¡¨ç»„ä»¶çš„åˆ†äº«å‡½æ•°ä»£ç åï¼Œç•¥ä½œä¿®æ”¹å³å¯ã€‚

æ•ˆæœå¦‚å›¾ï¼š

![img](https://pic.code-nav.cn/course_picture/1608440217629360130/kQQRmbqf4F8o9KFM.webp)

### æ‰©å±•

1ã€åç«¯è®°å½•åˆ†äº«æ¬¡æ•°

åç«¯å¯ä»¥è®°å½•ç‚¹å‡»åˆ†äº«æŒ‰é’®çš„æ¬¡æ•°ã€ä»¥åŠåˆ†äº«é“¾æ¥çš„ç‚¹å‡»æ¬¡æ•°ï¼Œä»¥ä¾¿è¿›è¡Œæ•°æ®åˆ†æå’Œä¼˜åŒ–ã€‚

2ã€ç”Ÿæˆè‡ªå®šä¹‰é‚€è¯·ç 

å¯ä»¥ä¸ºæ¯ä¸ªç”¨æˆ·ç”Ÿæˆè‡ªå·±çš„é‚€è¯·ç ï¼Œè¿˜å¯ä»¥æ”¯æŒè‡ªåŠ©ä¿®æ”¹ï¼Œå‚è€ƒé±¼çš®çš„ [é¢è¯•åˆ·é¢˜å¹³å°é¢è¯•é¸­](https://mianshiya.com/)ï¼Œæé«˜ç”¨æˆ·çš„åˆ†äº«æ„æ„¿ã€‚

3ã€å¾®ä¿¡å¡ç‰‡åˆ†äº«åŠŸèƒ½

[æ¥å…¥å¾®ä¿¡ JS-SDK](https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/JS-SDK.html#10)ï¼Œå®ç°å¾®ä¿¡å¡ç‰‡åˆ†äº«åŠŸèƒ½ã€‚é€šè¿‡è¯¥åŠŸèƒ½ï¼Œç”¨æˆ·åˆ†äº«æ—¶å¯ä»¥å±•ç¤ºè‡ªå®šä¹‰çš„æ ‡é¢˜ã€å›¾ç‰‡ç­‰å†…å®¹ï¼Œè€Œéç®€å•çš„é“¾æ¥ï¼Œæé«˜ç‚¹å‡»ç‡ã€‚

## äº”ã€å›¾ç‰‡æ‰¹é‡ç®¡ç†

### éœ€æ±‚åˆ†æ

ç”¨æˆ·å¯ä»¥å¯¹ç§æœ‰ç©ºé—´å†…çš„å›¾ç‰‡è¿›è¡Œæ‰¹é‡ä¿®æ”¹ï¼ŒåŒ…æ‹¬ï¼š

- æ‰¹é‡ä¿®æ”¹ä¿¡æ¯ï¼šä¿®æ”¹å›¾ç‰‡çš„æ ‡ç­¾å’Œåˆ†ç±»
- æ‰¹é‡é‡å‘½åï¼šæ‰¹é‡ä¿®æ”¹å›¾ç‰‡åç§°

### æ–¹æ¡ˆè®¾è®¡

#### 1ã€æ‰¹å¤„ç†æ“ä½œä¼˜åŒ–

æ‰¹é‡æ“ä½œçš„å®ç°å¹¶ä¸éš¾ï¼Œé¦–å…ˆæŸ¥è¯¢å‡ºç©ºé—´å†…æ‰€æœ‰çš„å›¾ç‰‡ï¼Œç„¶åæœ€ç®€å•çš„æ–¹å¼å°±æ˜¯ for å¾ªç¯éå†ä¸€ä¸‹å˜›ï¼

ä½†å¦‚æœæƒ³è®©æ‰¹é‡æ“ä½œæ›´å¿«ã€æ›´ç¨³å®šåœ°å®Œæˆï¼Œæˆ‘ä»¬éœ€è¦æ³¨æ„å‡ ç‚¹ï¼š

1. æ•°æ®æ ¡éªŒï¼šæ ¡éªŒå‚æ•°çš„åˆæ³•æ€§ï¼Œå¹¶ä¸”æ ¡éªŒç”¨æˆ·æ˜¯å¦å…·æœ‰ç©ºé—´çš„è®¿é—®æƒé™ï¼Œç¡®ä¿æ“ä½œå®‰å…¨ã€‚
2. æŸ¥è¯¢ä¼˜åŒ–ï¼šæŸ¥è¯¢å›¾ç‰‡æ—¶ï¼Œä»…é€‰æ‹©æ‰€éœ€çš„å­—æ®µï¼ˆå¦‚ id å’Œ spaceIdï¼‰ï¼Œå‡å°‘æ•°æ®åº“å¼€é”€ã€‚
3. äº‹åŠ¡ï¼šç¡®ä¿æ‰¹é‡æ“ä½œå…·æœ‰åŸå­æ€§ï¼Œå¦‚æœæœ‰ä¸€æ¡æ›´æ–°å¤±è´¥ï¼Œé‚£ä¹ˆéœ€è¦å¯¹è¿™ä¸€æ‰¹æ“ä½œè¿›è¡Œå›æ»šï¼Œé¿å…æ•°æ®ä¸ä¸€è‡´
4. æ‰¹é‡æ›´æ–°ï¼šåˆ©ç”¨ MyBatis-Plus æä¾›çš„ `updateBatchById` æ–¹æ³•è¿›è¡Œæ‰¹é‡æ›´æ–°ï¼Œè€Œä¸æ˜¯ for å¾ªç¯å¤šæ¬¡æ“ä½œæ•°æ®åº“ï¼Œä»è€Œæé«˜æ€§èƒ½å¹¶é™ä½æ“ä½œæ—¶é—´ã€‚

æ­¤å¤–ï¼Œå¦‚æœè¦å¤„ç†çš„æ•°æ®é‡éå¸¸å¤§ï¼ˆä¸Šåƒæ¡ï¼‰ï¼Œä¸ºäº†è¿›ä¸€æ­¥ä¼˜åŒ–æ€§èƒ½ï¼Œè¿˜å¯ä»¥ç»“åˆä½¿ç”¨çº¿ç¨‹æ± ã€åˆ†æ‰¹å¤„ç†å’Œå¹¶å‘ç¼–ç¨‹ï¼Œæå‡å¤§è§„æ¨¡æ“ä½œçš„æ•ˆç‡ã€‚è¿˜å¯ä»¥é€šè¿‡æ·»åŠ æ—¥å¿—æ¥è®°å½•æ‰¹å¤„ç†æ“ä½œçš„æ‰§è¡Œæƒ…å†µï¼Œæé«˜å¯è§‚æµ‹æ€§ã€‚

#### 2ã€æ‰¹é‡é‡å‘½å

æœ€ç®€å•çš„å®ç°æ˜¯å°†æ‰€æœ‰å›¾ç‰‡éƒ½ä¿®æ”¹ä¸ºåŒä¸€ä¸ªåç§°ï¼Œä½†è¿™æ ·ä¸å¤Ÿæœ‰åŒºåˆ†åº¦ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€ä¸ªåŠ¨æ€ç”Ÿæˆè§„åˆ™ï¼Œå…è®¸ç”¨æˆ·åœ¨é‡å‘½åæ—¶å¡«å†™åŠ¨æ€å˜é‡ï¼ˆå ä½ç¬¦ï¼‰ã€‚æ¯”å¦‚ç”¨æˆ·è¾“å…¥`å›¾ç‰‡_{åºå·}`ï¼Œå…¶ä¸­`{åºå·}`å°±æ˜¯åŠ¨æ€å˜é‡ï¼Œæ¯ä¸ªå›¾ç‰‡çš„åºå·éƒ½ä¸åŒï¼Œä¼šä» 1 å¼€å§‹æŒç»­é€’å¢ã€‚

åç«¯å¯ä»¥ä½¿ç”¨å­—ç¬¦ä¸²æ›¿æ¢æ–¹æ³•æ¥å¤„ç† `{åºå·}` å ä½ç¬¦ï¼Œé€‚ç”¨äºæ¯”è¾ƒç®€å•çš„åœºæ™¯ï¼Œå¦‚æœåŠ¨æ€ç”Ÿæˆè§„åˆ™å¾ˆå¤æ‚ï¼Œå¯ä»¥ä½¿ç”¨æ¨¡æ¿å¼•æ“æŠ€æœ¯ï¼Œé±¼çš®åœ¨ [ç¼–ç¨‹å¯¼èˆªçš„ä»£ç ç”Ÿæˆå™¨å¹³å°é¡¹ç›®](https://www.codefather.cn/course/1790980795074654209) ä¸­è®²è§£è¿‡ã€‚

#### æ‰©å±•çŸ¥è¯† - Spring è¡¨è¾¾å¼

æåˆ°åŠ¨æ€æ›¿æ¢å†…å®¹ï¼Œè¿™é‡Œé¡ºä¾¿åˆ†äº«ä¸€ä¸‹ Spring è¡¨è¾¾å¼æŠ€æœ¯ã€‚

Spring è¡¨è¾¾å¼è¯­è¨€ï¼ˆSpring Expression Languageï¼Œç®€ç§° SpELï¼‰ç”¨äºåœ¨ Spring é…ç½®æ–‡ä»¶æˆ– Java ä»£ç ä¸­åŠ¨æ€åœ°æŸ¥è¯¢å’Œæ“ä½œå¯¹è±¡ã€‚SpEL å¯ä»¥åœ¨è¿è¡Œæ—¶è§£æè¡¨è¾¾å¼ï¼Œå¹¶æ‰§è¡Œå¯¹ Java å¯¹è±¡çš„è®¿é—®ã€æ“ä½œå’Œè®¡ç®—ï¼Œæ”¯æŒä¸°å¯Œçš„åŠŸèƒ½ï¼Œå¦‚æ¡ä»¶åˆ¤æ–­ã€æ–¹æ³•è°ƒç”¨ã€å±æ€§è®¿é—®ã€é›†åˆå¤„ç†ã€æ­£åˆ™è¡¨è¾¾å¼ç­‰ã€‚

ä¸¾ä¸€äº›è¯­æ³•ç¤ºä¾‹ï¼š

```java
#{user.name}   // è®¿é—® user å¯¹è±¡çš„ name å±æ€§
#{person.address.city}  // è®¿é—®åµŒå¥—å¯¹è±¡åœ°å€ä¸­çš„ city å±æ€§
#{user.getFullName()}   // è°ƒç”¨ user å¯¹è±¡çš„ getFullName() æ–¹æ³•
#{user.age > 18 ? 'Adult' : 'Child'}  // æ ¹æ® age åˆ¤æ–­æ˜¯å¦ä¸ºæˆå¹´äºº
```

ä¸¾ä¾‹ä¸€ä¸ªåº”ç”¨åœºæ™¯ï¼Œæ¯”å¦‚ç¼“å­˜æ³¨è§£ä¸­ï¼Œä½¿ç”¨è¡¨è¾¾å¼æ ¹æ®æ–¹æ³•å‚æ•°åŠ¨æ€ç”Ÿæˆç¼“å­˜çš„ keyï¼š

```java
/**
 * æ ¹æ®ç”¨æˆ· ID è·å–ç”¨æˆ·ä¿¡æ¯ï¼Œå¹¶å°†ç»“æœç¼“å­˜ã€‚
 * ä½¿ç”¨ SpEL åŠ¨æ€ç”Ÿæˆç¼“å­˜çš„ keyï¼ŒåŠ å…¥ç”¨æˆ· ID å’Œè¯·æ±‚çš„è¯­è¨€ï¼ˆlocaleï¼‰ã€‚
 *
 * @param userId ç”¨æˆ· ID
 * @param locale å½“å‰è¯­è¨€ç¯å¢ƒï¼ˆå¦‚ en, zhï¼‰
 * @return ç”¨æˆ·ä¿¡æ¯
 */
@Cacheable(value = "users", key = "#userId + ':' + #locale")
public String getUserInfo(Long userId, String locale) {
    // æ¨¡æ‹Ÿæ•°æ®åº“æŸ¥è¯¢
    System.out.println("Fetching user info from DB...");
    return "User " + userId + " info in " + locale + " language";
}
```

å®ƒçš„å®ç°æ–¹å¼å¯å°±ä¸æ˜¯å­—ç¬¦ä¸²æ›¿æ¢è¿™ä¹ˆç®€å•äº†ï¼Œè€Œæ˜¯ç”¨åˆ°äº† AST æŠ½è±¡è¯­æ³•æ ‘æ¥å¯¹å­—ç¬¦ä¸²è¿›è¡Œè§£æï¼Œå¤§å®¶è¦å¯¹è¿™ç§æ€è·¯æœ‰ä¸ªå°è±¡ã€‚

### åç«¯å¼€å‘

#### 1ã€æ‰¹é‡ä¿®æ”¹ä¿¡æ¯

1ï¼‰å¼€å‘è¯·æ±‚ç±»ï¼Œæ¥å—å›¾ç‰‡ id åˆ—è¡¨ç­‰å­—æ®µï¼š

```java
@Data
public class PictureEditByBatchRequest implements Serializable {

    /**
     * å›¾ç‰‡ id åˆ—è¡¨
     */
    private List<Long> pictureIdList;

    /**
     * ç©ºé—´ id
     */
    private Long spaceId;

    /**
     * åˆ†ç±»
     */
    private String category;

    /**
     * æ ‡ç­¾
     */
    private List<String> tags;

    private static final long serialVersionUID = 1L;
}
```

2ï¼‰å¼€å‘æ‰¹é‡ä¿®æ”¹å›¾ç‰‡æœåŠ¡ï¼Œä¾æ¬¡å®Œæˆå‚æ•°æ ¡éªŒã€ç©ºé—´æƒé™æ ¡éªŒã€å›¾ç‰‡æŸ¥è¯¢ã€æ‰¹é‡æ›´æ–°æ“ä½œï¼š

```java
@Override
@Transactional(rollbackFor = Exception.class)
public void editPictureByBatch(PictureEditByBatchRequest pictureEditByBatchRequest, User loginUser) {
    List<Long> pictureIdList = pictureEditByBatchRequest.getPictureIdList();
    Long spaceId = pictureEditByBatchRequest.getSpaceId();
    String category = pictureEditByBatchRequest.getCategory();
    List<String> tags = pictureEditByBatchRequest.getTags();

    // 1. æ ¡éªŒå‚æ•°
    ThrowUtils.throwIf(spaceId == null || CollUtil.isEmpty(pictureIdList), ErrorCode.PARAMS_ERROR);
    ThrowUtils.throwIf(loginUser == null, ErrorCode.NO_AUTH_ERROR);
    // 2. æ ¡éªŒç©ºé—´æƒé™
    Space space = spaceService.getById(spaceId);
    ThrowUtils.throwIf(space == null, ErrorCode.NOT_FOUND_ERROR, "ç©ºé—´ä¸å­˜åœ¨");
    if (!loginUser.getId().equals(space.getUserId())) {
        throw new BusinessException(ErrorCode.NO_AUTH_ERROR, "æ²¡æœ‰ç©ºé—´è®¿é—®æƒé™");
    }

    // 3. æŸ¥è¯¢æŒ‡å®šå›¾ç‰‡ï¼Œä»…é€‰æ‹©éœ€è¦çš„å­—æ®µ
    List<Picture> pictureList = this.lambdaQuery()
            .select(Picture::getId, Picture::getSpaceId)
            .eq(Picture::getSpaceId, spaceId)
            .in(Picture::getId, pictureIdList)
            .list();

    if (pictureList.isEmpty()) {
        return;
    }
    // 4. æ›´æ–°åˆ†ç±»å’Œæ ‡ç­¾
    pictureList.forEach(picture -> {
        if (StrUtil.isNotBlank(category)) {
            picture.setCategory(category);
        }
        if (CollUtil.isNotEmpty(tags)) {
            picture.setTags(JSONUtil.toJsonStr(tags));
        }
    });

    // 5. æ‰¹é‡æ›´æ–°
    boolean result = this.updateBatchById(pictureList);
    ThrowUtils.throwIf(!result, ErrorCode.OPERATION_ERROR);
}
```

ğŸ’¡ å¯¹äºæˆ‘ä»¬çš„é¡¹ç›®æ¥è¯´ï¼Œç”±äºç”¨æˆ·è¦å¤„ç†çš„æ•°æ®é‡ä¸å¤§ï¼Œä¸Šè¿°ä»£ç å·²ç»èƒ½å¤Ÿæ»¡è¶³éœ€æ±‚ã€‚ä½†å¦‚æœè¦å¤„ç†å¤§é‡æ•°æ®ï¼Œå¯ä»¥ä½¿ç”¨çº¿ç¨‹æ±  + åˆ†æ‰¹ + å¹¶å‘è¿›è¡Œä¼˜åŒ–ï¼Œå‚è€ƒä»£ç å¦‚ä¸‹ï¼š

```java
@Resource
private ThreadPoolExecutor customExecutor;

/**
 * æ‰¹é‡ç¼–è¾‘å›¾ç‰‡åˆ†ç±»å’Œæ ‡ç­¾
 */
@Override
@Transactional(rollbackFor = Exception.class)
public void batchEditPictureMetadata(PictureBatchEditRequest request, Long spaceId, Long loginUserId) {
    // å‚æ•°æ ¡éªŒ
    validateBatchEditRequest(request, spaceId, loginUserId);

    // æŸ¥è¯¢ç©ºé—´ä¸‹çš„å›¾ç‰‡
    List<Picture> pictureList = this.lambdaQuery()
            .eq(Picture::getSpaceId, spaceId)
            .in(Picture::getId, request.getPictureIds())
            .list();

    if (pictureList.isEmpty()) {
        throw new BusinessException(ErrorCode.NOT_FOUND_ERROR, "æŒ‡å®šçš„å›¾ç‰‡ä¸å­˜åœ¨æˆ–ä¸å±äºè¯¥ç©ºé—´");
    }

    // åˆ†æ‰¹å¤„ç†é¿å…é•¿äº‹åŠ¡
    int batchSize = 100;
    List<CompletableFuture<Void>> futures = new ArrayList<>();
    for (int i = 0; i < pictureList.size(); i += batchSize) {
        List<Picture> batch = pictureList.subList(i, Math.min(i + batchSize, pictureList.size()));

        // å¼‚æ­¥å¤„ç†æ¯æ‰¹æ•°æ®
        CompletableFuture<Void> future = CompletableFuture.runAsync(() -> {
            batch.forEach(picture -> {
                // ç¼–è¾‘åˆ†ç±»å’Œæ ‡ç­¾
                if (request.getCategory() != null) {
                    picture.setCategory(request.getCategory());
                }
                if (request.getTags() != null) {
                    picture.setTags(String.join(",", request.getTags()));
                }
            });
            boolean result = this.updateBatchById(batch);
            if (!result) {
                throw new BusinessException(ErrorCode.OPERATION_ERROR, "æ‰¹é‡æ›´æ–°å›¾ç‰‡å¤±è´¥");
            }
        }, customExecutor);

        futures.add(future);
    }

    // ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ
    CompletableFuture.allOf(futures.toArray(new CompletableFuture[0])).join();
}
```

æ­¤å¤–ï¼Œè¿˜å¯ä»¥å¤šè®°å½•æ—¥å¿—ï¼Œæˆ–è€…è®©è¿”å›ç»“æœæ›´åŠ è¯¦ç»†ï¼Œæ¯”å¦‚æ›´æ–°æˆåŠŸäº†å¤šå°‘æ¡æ•°æ®ä¹‹ç±»çš„ã€‚

3ï¼‰å¼€å‘æ¥å£

```java
@PostMapping("/edit/batch")
public BaseResponse<Boolean> editPictureByBatch(@RequestBody PictureEditByBatchRequest pictureEditByBatchRequest, HttpServletRequest request) {
    ThrowUtils.throwIf(pictureEditByBatchRequest == null, ErrorCode.PARAMS_ERROR);
    User loginUser = userService.getLoginUser(request);
    pictureService.editPictureByBatch(pictureEditByBatchRequest, loginUser);
    return ResultUtils.success(true);
}
```

#### 2ã€æ‰¹é‡é‡å‘½å

ç›´æ¥å¤ç”¨æ‰¹é‡ä¿®æ”¹ä¿¡æ¯çš„æ–¹æ³•ï¼Œåœ¨è¿™åŸºç¡€ä¸Šåšå¢å¼ºï¼Œè¡¥å……å¯¹å›¾ç‰‡åç§°çš„ä¿®æ”¹ã€‚

1ï¼‰æ‰¹é‡ç¼–è¾‘è¯·æ±‚ç±» PictureEditByBatchRequest è¡¥å……å­—æ®µï¼š

```java
/**
 * å‘½åè§„åˆ™
 */
private String nameRule;
```

2ï¼‰æ‰¹é‡ä¿®æ”¹æ–¹æ³•è¡¥å……å›¾ç‰‡åç§°ï¼š

```java
// æ‰¹é‡é‡å‘½å
String nameRule = pictureEditByBatchRequest.getNameRule();
fillPictureWithNameRule(pictureList, nameRule);
```

ç¼–å†™å¡«å……å›¾ç‰‡åç§°çš„æ–¹æ³•ï¼Œä½¿ç”¨å­—ç¬¦ä¸²çš„ `replaceAll` æ–¹æ³•æ›¿æ¢åŠ¨æ€å˜é‡ï¼š

```java
/**
 * nameRule æ ¼å¼ï¼šå›¾ç‰‡{åºå·}
 *
 * @param pictureList
 * @param nameRule
 */
private void fillPictureWithNameRule(List<Picture> pictureList, String nameRule) {
    if (CollUtil.isEmpty(pictureList) || StrUtil.isBlank(nameRule)) {
        return;
    }
    long count = 1;
    try {
        for (Picture picture : pictureList) {
            String pictureName = nameRule.replaceAll("\\{åºå·}", String.valueOf(count++));
            picture.setName(pictureName);
        }
    } catch (Exception e) {
        log.error("åç§°è§£æé”™è¯¯", e);
        throw new BusinessException(ErrorCode.OPERATION_ERROR, "åç§°è§£æé”™è¯¯");
    }
}
```

### å‰ç«¯å¼€å‘

ä¸ºäº†å®ç°æ–¹ä¾¿ï¼Œä»…å¯¹ç©ºé—´è¯¦æƒ…é¡µå½“å‰é¡µå·æŸ¥è¯¢å‡ºçš„å›¾ç‰‡è¿›è¡Œæ‰¹é‡ç®¡ç†ã€‚

#### 1ã€æ‰¹é‡ç¼–è¾‘å¼¹çª—è¡¨å•

1ï¼‰ç›´æ¥å¤ç”¨ä¹‹å‰çš„å¼¹çª—åˆ†äº«ç»„ä»¶ + æœç´¢å›¾ç‰‡è¡¨å•ç»„ä»¶ï¼Œå°±èƒ½å¿«é€Ÿå®Œæˆå¼€å‘ã€‚/MBNmaRtUhzDE9b4tB/jsqs1ClvvhzK+S4KVLPihc/I=

- è¡¨å•é¡¹åŒ…æ‹¬åˆ†ç±»ã€æ ‡ç­¾ã€å‘½åè§„åˆ™ï¼Œè¿˜å¯ä»¥åŠ ä¸€è¡Œæç¤ºè¯­ â€œåªå¯¹å½“å‰é¡µé¢çš„å›¾ç‰‡ç”Ÿæ•ˆâ€ã€‚
- ç»„ä»¶å±æ€§åŒ…æ‹¬ spaceId å’Œ pictureListï¼Œç”±ç©ºé—´è¯¦æƒ…é¡µä¼ å…¥ã€‚

ä»£ç å¦‚ä¸‹ï¼š

```vue
<template>
  <a-modal v-model:visible="visible" title="æ‰¹é‡ç¼–è¾‘å›¾ç‰‡" :footer="false" @cancel="closeModal">
    <a-typography-paragraph type="secondary">* åªå¯¹å½“å‰é¡µé¢çš„å›¾ç‰‡ç”Ÿæ•ˆ</a-typography-paragraph>
    <!-- è¡¨å•é¡¹ -->
    <a-form layout="vertical" :model="formData" @finish="handleSubmit">
      <a-form-item label="åˆ†ç±»" name="category">
        <a-auto-complete
          v-model:value="formData.category"
          :options="categoryOptions"
          placeholder="è¯·è¾“å…¥åˆ†ç±»"
          allowClear
        />
      </a-form-item>
      <a-form-item label="æ ‡ç­¾" name="tags">
        <a-select
          v-model:value="formData.tags"
          :options="tagOptions"
          mode="tags"
          placeholder="è¯·è¾“å…¥æ ‡ç­¾"
          allowClear
        />
      </a-form-item>
      <a-form-item label="å‘½åè§„åˆ™" name="nameRule">
        <a-input v-model:value="formData.nameRule" placeholder="è¯·è¾“å…¥å‘½åè§„åˆ™ï¼Œè¾“å…¥ {åºå·} å¯åŠ¨æ€ç”Ÿæˆ" />
      </a-form-item>
      <a-form-item>
        <a-button type="primary" html-type="submit">æäº¤</a-button>
      </a-form-item>
    </a-form>
  </a-modal>
</template>

<script setup lang="ts">
import { defineProps, ref, withDefaults, defineExpose, reactive, onMounted } from 'vue'
import {
  editPictureByBatchUsingPost,
  listPictureTagCategoryUsingGet,
} from '@/api/pictureController'
import { message } from 'ant-design-vue'

// å®šä¹‰ç»„ä»¶å±æ€§ç±»å‹
interface Props {
  pictureList: API.PictureVO[]
  spaceId: number
  onSuccess: () => void
}

// ç»™ç»„ä»¶æŒ‡å®šåˆå§‹å€¼
const props = withDefaults(defineProps<Props>(), {})

// æ§åˆ¶å¼¹çª—å¯è§æ€§
const visible = ref(false)

// æ‰“å¼€å¼¹çª—
const openModal = () => {
  visible.value = true
}

// å…³é—­å¼¹çª—
const closeModal = () => {
  visible.value = false
}

// æš´éœ²å‡½æ•°ç»™çˆ¶ç»„ä»¶
defineExpose({
  openModal,
})

// åˆå§‹åŒ–è¡¨å•æ•°æ®
const formData = reactive({
  category: '', // åˆ†ç±»
  tags: [], // æ ‡ç­¾
  nameRule: '', // å‘½åè§„åˆ™
})

const categoryOptions = ref<string[]>([])
const tagOptions = ref<string[]>([])

// è·å–æ ‡ç­¾å’Œåˆ†ç±»é€‰é¡¹
const getTagCategoryOptions = async () => {
  const res = await listPictureTagCategoryUsingGet()
  if (res.data.code === 0 && res.data.data) {
    // è½¬æ¢æˆä¸‹æ‹‰é€‰é¡¹ç»„ä»¶æ¥å—çš„æ ¼å¼
    tagOptions.value = (res.data.data.tagList ?? []).map((data: string) => {
      return {
        value: data,
        label: data,
      }
    })
    categoryOptions.value = (res.data.data.categoryList ?? []).map((data: string) => {
      return {
        value: data,
        label: data,
      }
    })
  } else {
    message.error('åŠ è½½é€‰é¡¹å¤±è´¥ï¼Œ' + res.data.message)
  }
}

onMounted(() => {
  getTagCategoryOptions()
})
</script>
```

2ï¼‰ç¼–å†™æäº¤è¡¨å•çš„å‡½æ•°ï¼Œè°ƒç”¨åç«¯æ‰¹é‡ç¼–è¾‘æ¥å£ï¼š

```typescript
// æäº¤è¡¨å•æ—¶å¤„ç†
const handleSubmit = async (values: any) => {
  if (!props.pictureList) {
    return
  }
  const res = await editPictureByBatchUsingPost({
    pictureIdList: props.pictureList.map((picture) => picture.id),
    spaceId: props.spaceId,
    ...values,
  })
  if (res.data.code === 0 && res.data.data) {
    message.success('æ“ä½œæˆåŠŸ')
    closeModal()
    props.onSuccess?.()
  } else {
    message.error('æ“ä½œå¤±è´¥ï¼Œ' + res.data.message)
  }
}
```

#### 2ã€ä½¿ç”¨å¼¹çª—ç»„ä»¶

1ï¼‰ç©ºé—´è¯¦æƒ…é¡µå¼•å…¥å¼¹çª—ç»„ä»¶ï¼š

```vue
<BatchEditPictureModal
  ref="batchEditPictureModalRef"
  :spaceId="id"
  :pictureList="dataList"
  :onSuccess="onBatchEditPictureSuccess"
/>
```

2ï¼‰é€šè¿‡ ref è·å–åˆ°å¼¹çª—çš„å¼•ç”¨ï¼Œåœ¨æ‰¹é‡ç¼–è¾‘æˆåŠŸåè¦åˆ·æ–°å›¾ç‰‡åˆ—è¡¨æ•°æ®ï¼šbgMhj83Bt96lFcj29lBZCF0o0+YPCGWOWUw0OPyFB/Q=

```typescript
// åˆ†äº«å¼¹çª—å¼•ç”¨
const batchEditPictureModalRef = ref()

// æ‰¹é‡ç¼–è¾‘æˆåŠŸåï¼Œåˆ·æ–°æ•°æ®
const onBatchEditPictureSuccess = () => {
  fetchData()
}
```

#### 3ã€æ‰“å¼€å¼¹çª—ç»„ä»¶

åœ¨åˆ›å»ºå›¾ç‰‡æŒ‰é’®çš„å³ä¾§è¡¥å…… â€œæ‰¹é‡ç¼–è¾‘â€ æŒ‰é’®ï¼Œç‚¹å‡»åæ‰“å¼€å¼¹çª—è¡¨å•ï¼š

```vue
<a-button :icon="h(EditOutlined)" @click="doBatchEdit"> æ‰¹é‡ç¼–è¾‘</a-button>
```

æŒ‰é’®ç‚¹å‡»å‡½æ•°ï¼š

```typescript
// æ‰“å¼€æ‰¹é‡ç¼–è¾‘å¼¹çª—
const doBatchEdit = () => {
  if (batchEditPictureModalRef.value) {
    batchEditPictureModalRef.value.openModal()
  }
}
```

æ•ˆæœå¦‚å›¾ï¼š

![img](https://pic.code-nav.cn/course_picture/1608440217629360130/3sFM7Asc26kNRuYG.webp)

### æ‰©å±•

1ã€ç®¡ç†å‘˜å¯ä»¥å¯¹å…¬å…±å›¾åº“è¿›è¡Œæ‰¹é‡ç¼–è¾‘

å®ç°æ€è·¯ï¼šæ¥å£éœ€è¦å…¼å®¹ä¸ä¼ ç©ºé—´ id çš„æƒ…å†µï¼ˆä¹Ÿå°±å¯¹åº”äº†å…¬å…±å›¾åº“ï¼‰ï¼Œå‰ç«¯å›¾ç‰‡ç®¡ç†é¡µé¢å¯ä»¥ä½¿ç”¨ [è¡¨æ ¼ç»„ä»¶](https://antdv.com/components/table-cn#components-table-demo-row-selection-custom) æä¾›çš„å¤šé€‰åŠŸèƒ½ï¼Œè‡ªç”±é€‰æ‹©å›¾ç‰‡è¿›è¡Œæ‰¹é‡æ“ä½œã€‚

2ã€ç©ºé—´è¯¦æƒ…é¡µé¢æ”¯æŒå¯¹å›¾ç‰‡è¿›è¡Œè‡ªç”±å¤šé€‰

å®ç°æ€è·¯ï¼šå»ºè®®å¢åŠ ä¸€ç§å±•ç¤ºå›¾ç‰‡åˆ—è¡¨çš„æ–¹å¼ï¼Œæ”¹ä¸ºè¡¨æ ¼ï¼Œè¿™æ ·å°±å¯ä»¥ä½¿ç”¨ [è¡¨æ ¼ç»„ä»¶](https://antdv.com/components/table-cn#components-table-demo-row-selection-custom) æä¾›çš„å¤šé€‰åŠŸèƒ½ï¼Œè‡ªç”±é€‰æ‹©å›¾ç‰‡è¿›è¡Œæ‰¹é‡æ“ä½œã€‚

3ã€é‡å‘½åè§„åˆ™å¯ä»¥å¢åŠ æ›´å¤šçš„åŠ¨æ€å˜é‡ï¼Œå‰ç«¯å¯ä»¥é€šè¿‡ç‚¹å‡»å¿«é€Ÿå¡«å……è¡¨è¾¾å¼å­—ç¬¦ä¸²ï¼Œè€Œä¸ç”¨è®©ç”¨æˆ·è‡ªå·±ç¼–å†™ `{xxx}` çš„è¯­æ³•ã€‚

4ã€å¯¹äºå‰ç«¯åŒå­¦ï¼Œå¯ä»¥å°è¯•å°†å¼¹çª—ç»„ä»¶æ”¹ä¸ºå—æ§ç»„ä»¶ã€‚

å—æ§ç»„ä»¶æ˜¯æŒ‡å…¶çŠ¶æ€ç”±å¤–éƒ¨ï¼ˆé€šå¸¸æ˜¯çˆ¶ç»„ä»¶æˆ–çŠ¶æ€ç®¡ç†ç³»ç»Ÿï¼‰æ§åˆ¶çš„ç»„ä»¶ã€‚åœ¨å—æ§ç»„ä»¶ä¸­ï¼Œç»„ä»¶çš„å€¼å§‹ç»ˆç”±çˆ¶ç»„ä»¶æˆ–çŠ¶æ€æ§åˆ¶ï¼Œç”¨æˆ·å¯¹ç»„ä»¶çš„è¾“å…¥ä¼šé€šè¿‡äº‹ä»¶é€šçŸ¥çˆ¶ç»„ä»¶æˆ–çŠ¶æ€ç®¡ç†ï¼Œå¹¶æ›´æ–°ç›¸åº”çš„å€¼ï¼Œçˆ¶ç»„ä»¶å†é€šè¿‡æ›´æ–°ä¼ é€’ç»™å­ç»„ä»¶ï¼Œä»è€Œåæ˜ æ–°çš„çŠ¶æ€ã€‚

æˆ‘ä»¬ä¹‹å‰ä½¿ç”¨ Ant Design çš„åˆ†é¡µç»„ä»¶æ—¶ï¼Œå°±æ˜¯æŠŠå®ƒå½“åšå—æ§ç»„ä»¶ä½¿ç”¨çš„ï¼š

```typescript
<a-pagination
  style="text-align: right"
  v-model:current="searchParams.current"
  v-model:pageSize="searchParams.pageSize"
  :total="total"
  :show-total="() => `å›¾ç‰‡æ€»æ•° ${total} / ${space.maxCount}`"
  @change="onPageChange"
/>

// æœç´¢æ¡ä»¶
const searchParams = ref<API.PictureQueryRequest>({
  current: 1,
  pageSize: 12,
})

// æ”¹å˜çŠ¶æ€
const onPageChange = (page, pageSize) => {
  searchParams.value.current = page
  searchParams.value.pageSize = pageSize
  fetchData()
}
```







# 9 - AI å›¾ç‰‡ç¼–è¾‘

## æœ¬èŠ‚é‡ç‚¹

ä¸ºè¿›ä¸€æ­¥æå‡ç”¨æˆ·ä½¿ç”¨ç§æœ‰ç©ºé—´çš„ä½“éªŒï¼Œæˆ‘ä»¬æœ¬èŠ‚å°†é‡ç‚¹æ‰©å±•å›¾ç‰‡ç¼–è¾‘åŠŸèƒ½ï¼ŒåŒ…æ‹¬ï¼š

- åŸºç¡€å›¾ç‰‡ç¼–è¾‘
- AI å›¾ç‰‡ç¼–è¾‘

é€šè¿‡è¿™äº›åŠŸèƒ½æ‰©å±•ï¼Œç”¨æˆ·å¯ä»¥åœ¨å¹³å°ä¸Šè½»æ¾å®Œæˆä»åŸºç¡€ç¼–è¾‘åˆ°é«˜çº§å¤„ç†çš„å¤šæ ·åŒ–æ“ä½œï¼Œè€Œä¸éœ€è¦ä½¿ç”¨å…¶ä»– PS è½¯ä»¶ã€‚

## ä¸€ã€åŸºç¡€å›¾ç‰‡ç¼–è¾‘

### éœ€æ±‚åˆ†æ

åœ¨æ—¥å¸¸çš„å›¾ç‰‡ç®¡ç†ä¸­ï¼Œç”¨æˆ·ç»å¸¸éœ€è¦å¯¹å›¾ç‰‡è¿›è¡Œç®€å•å¤„ç†ï¼Œæ¯”å¦‚è£å‰ªå¤šä½™éƒ¨åˆ†ã€æ—‹è½¬å›¾ç‰‡ã€æ”¾å¤§ç¼©å°å°ºå¯¸ç­‰ã€‚

å› æ­¤ï¼Œæˆ‘ä»¬é¦–å…ˆè¦å¼•å…¥åŸºç¡€å›¾ç‰‡ç¼–è¾‘åŠŸèƒ½ï¼Œå¸®åŠ©ç”¨æˆ·å¿«é€Ÿå®Œæˆä»¥ä¸‹æ“ä½œï¼š

- è£å‰ªï¼šæ”¯æŒæŒ‰å›ºå®šæ¯”ä¾‹æˆ–è‡ªç”±è£å‰ª
- æ—‹è½¬ï¼šæä¾›é¡ºæ—¶é’ˆã€é€†æ—¶é’ˆæ—‹è½¬åŠŸèƒ½

è¿™ä¸ªåŠŸèƒ½éå¸¸é€‚åˆä¸Šä¼ è¯ä»¶ç…§ä¹‹ç±»çš„åœºæ™¯ã€‚

æ³¨æ„ï¼Œè¯¥åŠŸèƒ½ä¸éœ€è¦é™åˆ¶ä»…åœ¨ç©ºé—´å†…æ‰èƒ½ä½¿ç”¨ï¼Œå…¬å…±å›¾åº“ä¹Ÿå¯ä»¥æ”¯æŒã€‚

### æ–¹æ¡ˆè®¾è®¡

å›¾ç‰‡ç¼–è¾‘åŠŸèƒ½çš„å®ç°ä»¥å‰ç«¯ä¸ºä¸»ï¼Œç¼–è¾‘å®Œæˆåé€šè¿‡è°ƒç”¨ç°æœ‰çš„å›¾ç‰‡ä¸Šä¼ æ¥å£ï¼Œå°†ç¼–è¾‘åçš„å›¾ç‰‡ä¿å­˜è‡³å¹³å°ã€‚

å…·ä½“ä¸šåŠ¡æµç¨‹ï¼š

1. åœ¨å›¾ç‰‡ä¸Šä¼ é¡µé¢ï¼Œå¦‚æœç”¨æˆ·å·²ä¸Šä¼ å›¾ç‰‡ï¼Œé¡µé¢ä¼šå±•ç¤ºâ€œç¼–è¾‘å›¾ç‰‡â€æŒ‰é’®ã€‚
2. ç”¨æˆ·ç‚¹å‡»â€œç¼–è¾‘å›¾ç‰‡â€åï¼Œå°†æ‰“å¼€å›¾ç‰‡ç¼–è¾‘çš„å¼¹çª—ç»„ä»¶ï¼Œæ”¯æŒè£å‰ªã€æ—‹è½¬ç­‰æ“ä½œã€‚
3. ç”¨æˆ·ç¡®è®¤ç¼–è¾‘åï¼Œä¼šè°ƒç”¨å›¾ç‰‡ä¸Šä¼ æ¥å£ï¼Œå°†ç¼–è¾‘åçš„æ–°å›¾ç‰‡ä¿å­˜è‡³å¹³å°ï¼ŒåŒæ—¶æ›´æ–°å›¾ç‰‡ä¿¡æ¯ã€‚

å…¶å®è¿˜æœ‰å¦ä¸€ç§è®¾è®¡ï¼Œåœ¨ç”¨æˆ·æ¯æ¬¡é€‰æ‹©æœ¬åœ°æˆ– URL å›¾ç‰‡æ—¶ï¼Œå…ˆä¸è°ƒç”¨åç«¯çš„å›¾ç‰‡ä¸Šä¼ æ¥å£ï¼Œè€Œæ˜¯è‡ªåŠ¨å¼¹å‡ºå›¾ç‰‡ç¼–è¾‘å¼¹çª—ç»„ä»¶ï¼Œç¼–è¾‘å®Œåå†ä¿å­˜ã€‚ä½†è¿™æ ·åšå°±ä¸æ˜¯ â€œæ‰©å±•åŠŸèƒ½â€ è€Œæ˜¯ â€œä¿®æ”¹å·²æœ‰åŠŸèƒ½â€ï¼Œæ¶‰åŠåˆ°çš„ä»£ç æ”¹åŠ¨ä¼šæ›´å¤šï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥å°è¯•å®ç°ã€‚

ğŸ’¡ è¿™ä¸ªåœ°æ–¹ä¹Ÿèƒ½ä½“ç°å‡ºæ–¹æ¡ˆè®¾è®¡çš„é‡è¦æ€§ï¼Œå¯ä»¥é€šè¿‡åˆé€‚åœ°æ”¹å˜ä¸šåŠ¡æµç¨‹ï¼Œé™ä½å¼€å‘æˆæœ¬ï¼Œå¹¶è®©é¡¹ç›®æ›´åˆ©äºç»´æŠ¤æ‰©å±•ã€‚

### å‰ç«¯å¼€å‘

#### 1ã€å›¾ç‰‡ç¼–è¾‘ç»„ä»¶

å›¾ç‰‡ç¼–è¾‘æ˜¯ä¸ªæ¯”è¾ƒå¸¸è§çš„åŠŸèƒ½ï¼Œä¸€èˆ¬ä¼šæœ‰ç°æˆçš„åº“å¯ä»¥ç›´æ¥ç”¨ã€‚ç»è¿‡è°ƒç ”ï¼Œé€‰ç”¨å¼€æºçš„ [vue-cropper ç»„ä»¶](https://github.com/xyxiao001/vue-cropper?tab=readme-ov-file#2-å¼•å…¥-vue-cropper)ã€‚

1ï¼‰å¼•å…¥ç»„ä»¶

å‚è€ƒå®˜æ–¹æ–‡æ¡£å¼•å…¥ï¼Œæ³¨æ„è¦å¼•å…¥ Vue3 ç‰ˆæœ¬çš„ï¼š

![img](.\assets\MvLCMAYcSu9FjuC2.webp)

å®‰è£…ä¾èµ–ï¼š

```java
npm install vue-cropper@next
```

é±¼çš®ç¼–å†™æœ¬æ•™ç¨‹æ—¶ï¼Œä½¿ç”¨çš„ vue-cropper ç‰ˆæœ¬æ˜¯ 1.1.4ï¼Œæœ€å¥½è·Ÿæ•™ç¨‹ä¿æŒä¸€è‡´ã€‚

åœ¨ `main.ts` ä¸­å¼•å…¥ä¾èµ–ï¼š

```typescript
import VueCropper from 'vue-cropper';
import 'vue-cropper/dist/index.css'

app.use(VueCropper)
```

2ï¼‰æ–°å»ºå›¾ç‰‡ç¼–è¾‘ç»„ä»¶ ImageCropperã€‚æˆ‘ä»¬è¦å¼€å‘çš„ç»„ä»¶ç»“æ„åŒ…æ‹¬ä¸¤éƒ¨åˆ†ï¼šä¸Šæ–¹ä¸ºå›¾ç‰‡é¢„è§ˆåŒºï¼Œä¸‹æ–¹ä¸ºæ“ä½œæ ã€‚

åœ¨å“ªé‡Œä½¿ç”¨å›¾ç‰‡ç¼–è¾‘ç»„ä»¶å‘¢ï¼Ÿ

æ ¹æ®æˆ‘ä»¬çš„æ–¹æ¡ˆè®¾è®¡ï¼Œå›¾ç‰‡ç¼–è¾‘ä¸åº”è¯¥å’Œä»»ä½•ä¸€ç§ä¸Šä¼ å›¾ç‰‡çš„æ–¹å¼ï¼ˆæœ¬åœ°å›¾ç‰‡ / URL ä¸Šä¼ ï¼‰è¿›è¡Œç»‘å®šï¼Œæ˜¯åœ¨ä¸Šä¼ å®Œæˆåæ‰èƒ½ç¼–è¾‘ï¼Œæ‰€ä»¥åº”è¯¥åœ¨å›¾ç‰‡ä¸Šä¼ é¡µé¢å¼•å…¥ã€‚

å…ˆç¡¬ç¼–ç è¦ç¼–è¾‘çš„å›¾ç‰‡ urlï¼š

```vue
<ImageCropper imageUrl="https://avatars2.githubusercontent.com/u/15681693?s=460&v=4" />
```

å¯ä»¥å‚è€ƒ [å®˜æ–¹ Demo](https://codepen.io/xyxiao001/pen/yLooYKg) å®ç°ç»„ä»¶ï¼Œä¾æ¬¡å®Œæˆæ”¾å¤§ã€ç¼©å°ã€å·¦æ—‹ã€å³æ—‹æ“ä½œï¼š

```vue
<template>
  <div class="image-cropper">
    <vue-cropper
      ref="cropperRef"
      :img="imageUrl"
      :autoCrop="true"
      :fixedBox="false"
      :centerBox="true"
      :canMoveBox="true"
      :info="true"
      outputType="png"
    />
    <div style="margin-bottom: 16px" />
    <!-- å›¾ç‰‡æ“ä½œ -->
    <div class="image-cropper-actions">
      <a-space>
        <a-button @click="rotateLeft">å‘å·¦æ—‹è½¬</a-button>
        <a-button @click="rotateRight">å‘å³æ—‹è½¬</a-button>
        <a-button @click="changeScale(1)">æ”¾å¤§</a-button>
        <a-button @click="changeScale(-1)">ç¼©å°</a-button>
      </a-space>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref } from 'vue'

interface Props {
  imageUrl?: string
}

const props = defineProps<Props>()

// ç¼–è¾‘å™¨ç»„ä»¶çš„å¼•ç”¨
const cropperRef = ref()

// å‘å·¦æ—‹è½¬
const rotateLeft = () => {
  cropperRef.value.rotateLeft()
}

// å‘å³æ—‹è½¬
const rotateRight = () => {
  cropperRef.value.rotateRight()
}

// ç¼©æ”¾
const changeScale = (num: number) => {
  cropperRef.value.changeScale(num)
}
</script>

<style scoped>
.image-cropper {
  text-align: center;
}
  
.image-cropper .vue-cropper {
  height: 400px;
}
</style>
```

3ï¼‰ç¼–å†™ â€œç¡®è®¤æŒ‰é’®â€ï¼š

```vue
<a-space>
  <a-button @click="rotateLeft">å‘å·¦æ—‹è½¬</a-button>
  <a-button @click="rotateRight">å‘å³æ—‹è½¬</a-button>
  <a-button @click="changeScale(1)">æ”¾å¤§</a-button>
  <a-button @click="changeScale(-1)">ç¼©å°</a-button>
  <a-button type="primary" :loading="loading" @click="handleConfirm">ç¡®è®¤</a-button>
</a-space>
```

ç‚¹å‡»åï¼Œè°ƒç”¨ cropper çš„ getCropBlob å‡½æ•°ï¼Œå¯ä»¥è·å¾—è£åˆ‡åçš„æ–‡ä»¶ï¼š

```typescript
// ç¡®è®¤è£å‰ª
const handleConfirm = () => {
  cropperRef.value.getCropBlob((blob: Blob) => {
    // blob ä¸ºå·²è£åˆ‡çš„æ–‡ä»¶
  })
}
```

æ•ˆæœå¦‚å›¾ï¼š

![img](.\assets\usSOIIMmvbfRwjWM.webp)

ğŸ’¡ å¦‚æœæƒ³è¦ç‚¹å‡»ç¡®è®¤åä¸‹è½½å›¾ç‰‡ï¼Œå¯ä»¥å‚è€ƒ demo çš„ä»£ç å®ç°ï¼š

![img](.\assets\zZqNI1NVfgenfywq.webp)

#### 2ã€å›¾ç‰‡ç¼–è¾‘å¼¹çª—

å°†ä¸Šä¸€æ­¥å¼€å‘çš„å›¾ç‰‡ç¼–è¾‘ç»„ä»¶å¥—åˆ° [Ant Design çš„å¼¹æ¡†ç»„ä»¶](https://antdv.com/components/modal-cn) å†…ã€‚

1ï¼‰æŠŠæœ€å¤–å±‚ä» `div` æ”¹ä¸º `a-modal`ï¼Œæ³¨æ„ä¸€å®šè¦å°† class ç±»ååŠ åœ¨ modal ä¸Šï¼Œå¦åˆ™æ ·å¼æ— æ³•æ­£ç¡®æ·»åŠ ï¼š

```vue
<a-modal class="image-cropper" v-model:visible="visible" title="ç¼–è¾‘å›¾ç‰‡" :footer="false" @cancel="closeModal">
  ... åŸæœ‰ä»£ç 
</a-modal>
```

2ï¼‰å‚è€ƒå›¾ç‰‡åˆ†äº«å¼¹çª—ç»„ä»¶ï¼Œè¡¥å……æ§åˆ¶å¼¹çª—æ˜¾ç¤ºéšè—çš„ç›¸å…³ä»£ç ï¼Œå¹¶å¯¹å¤–æš´éœ²æ‰“å¼€å¼¹çª—çš„ openModal å‡½æ•°ï¼š

```typescript
// æ˜¯å¦å¯è§
const visible = ref(false)

// æ‰“å¼€å¼¹çª—
const openModal = () => {
  visible.value = true
}

// å…³é—­å¼¹çª—
const closeModal = () => {
  visible.value = false
}

// æš´éœ²å‡½æ•°ç»™çˆ¶ç»„ä»¶
defineExpose({
  openModal,
})
```

#### 3ã€ä¸Šä¼ ç¼–è¾‘åçš„å›¾ç‰‡

ç‚¹å‡»ç¡®è®¤åï¼Œéœ€è¦ä¸Šä¼ ç¼–è¾‘åçš„å›¾ç‰‡ã€‚æˆ‘ä»¬å¯ä»¥æŠŠå›¾ç‰‡ç¼–è¾‘ç»„ä»¶å½“åšæ˜¯å›¾ç‰‡ä¸Šä¼ ç»„ä»¶çš„ä¸€ç§ï¼Œè€Œä¸å’Œä»»ä½•ä¸€ç§ä¸Šä¼ å›¾ç‰‡çš„æ–¹å¼ï¼ˆæœ¬åœ°å›¾ç‰‡ / URL ä¸Šä¼ ï¼‰è¿›è¡Œç»‘å®šã€‚

1ï¼‰å‚è€ƒå›¾ç‰‡ä¸Šä¼ ç»„ä»¶çš„å±æ€§ï¼Œç»™ç»„ä»¶è¡¥å…… picture å’Œ spaceIdã€onSuccess å±æ€§ï¼š

```typescript
interface Props {
  imageUrl?: string
  picture?: API.PictureVO
  spaceId?: number
  onSuccess?: (newPicture: API.PictureVO) => void
}
```

2ï¼‰ç¼–å†™ä¸Šä¼ å‡½æ•°ã€‚ç‚¹å‡»ç¡®è®¤åå°† blob æ•°æ®è½¬æ¢ä¸º file å¯¹è±¡ï¼Œç„¶åå°±å¯ä»¥å¤ç”¨å›¾ç‰‡ä¸Šä¼ ç»„ä»¶çš„æäº¤å‡½æ•°äº†ï¼Œä¸Šä¼ æˆåŠŸåä¼šä¼ é€’æ–°å›¾ç‰‡ä¿¡æ¯ç»™çˆ¶ç»„ä»¶ã€å¹¶å…³é—­å¼¹çª—ã€‚ä»£ç å¦‚ä¸‹ï¼š

```typescript
const loading = ref<boolean>(false)

// ç¡®è®¤è£å‰ª
const handleConfirm = () => {
  cropperRef.value.getCropBlob((blob: Blob) => {
    const fileName = (props.picture?.name || 'image') + '.png'
    const file = new File([blob], fileName, { type: blob.type })
    // ä¸Šä¼ å›¾ç‰‡
    handleUpload({ file })
  })
}

/**
 * ä¸Šä¼ 
 * @param file
 */
const handleUpload = async ({ file }: any) => {
  loading.value = true
  try {
    const params: API.PictureUploadRequest = props.picture ? { id: props.picture.id } : {}
    params.spaceId = props.spaceId
    const res = await uploadPictureUsingPost(params, {}, file)
    if (res.data.code === 0 && res.data.data) {
      message.success('å›¾ç‰‡ä¸Šä¼ æˆåŠŸ')
      // å°†ä¸Šä¼ æˆåŠŸçš„å›¾ç‰‡ä¿¡æ¯ä¼ é€’ç»™çˆ¶ç»„ä»¶
      props.onSuccess?.(res.data.data)
      closeModal();
    } else {
      message.error('å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼Œ' + res.data.message)
    }
  } catch (error) {
    message.error('å›¾ç‰‡ä¸Šä¼ å¤±è´¥')
  } finally {
    loading.value = false
  }
}
```

#### 4ã€ä½¿ç”¨å›¾ç‰‡ç¼–è¾‘å¼¹çª—ç»„ä»¶

åœ¨åˆ›å»ºå›¾ç‰‡é¡µé¢ä½¿ç”¨ç»„ä»¶ï¼Œå¯ä»¥åœ¨å›¾ç‰‡ä¸‹æ–¹è¡¥å……ä¸€ä¸ªç¼–è¾‘æŒ‰é’®ï¼Œç‚¹å‡»ç¼–è¾‘æŒ‰é’®åæ‰“å¼€å¼¹çª—ï¼š

```vue
<div v-if="picture" class="edit-bar">
  <a-button :icon="h(EditOutlined)" @click="doEditPicture">ç¼–è¾‘å›¾ç‰‡</a-button>
  <ImageCropper
    ref="imageCropperRef"
    imageUrl="https://avatars2.githubusercontent.com/u/15681693?s=460&v=4"
    :picture="picture"
    :spaceId="spaceId"
    :onSuccess="onCropSuccess"
  />
</div>
```

ç¼–è¾‘å›¾ç‰‡äº‹ä»¶å‡½æ•°ï¼š

```typescript
// å›¾ç‰‡ç¼–è¾‘å¼¹çª—å¼•ç”¨
const imageCropperRef = ref()

// ç¼–è¾‘å›¾ç‰‡
const doEditPicture = () => {
  if (imageCropperRef.value) {
    imageCropperRef.value.openModal()
  }
}

// ç¼–è¾‘æˆåŠŸäº‹ä»¶
const onCropSuccess = (newPicture: API.PictureVO) => {
  picture.value = newPicture
}
```

é€‚å½“ä¼˜åŒ–ä¸€ä¸‹ CSS æ ·å¼ï¼Œå¢åŠ ä¸Šä¸‹è¾¹è·å’Œå±…ä¸­ï¼š

```css
#addPicturePage .edit-bar {
  text-align: center;
  margin: 16px 0;
}
```

æ•ˆæœå¦‚å›¾ï¼š

![img](.\assets\2MO6rk1UPtZsL3f4.webp)

å¼€å‘å®Œæˆåï¼ŒæŠŠ imageUrl çš„å€¼æ”¹ä¸ºè¦ç¼–è¾‘çš„å›¾ç‰‡åœ°å€ï¼š

```vue
<ImageCropper
  ref="imageCropperRef"
  :imageUrl="picture?.url"
  :picture="picture"
  :spaceId="spaceId"
  :onSuccess="onSuccess"
/>
```

ç»“æœï¼Œå‘ç°å›¾ç‰‡æ— æ³•æ­£å¸¸æ˜¾ç¤ºï¼Œä¼šå‡ºç°è·¨åŸŸé—®é¢˜ï¼

![img](.\assets\bPalFuMzoA9LSOXH.webp)

#### 5ã€å›¾ç‰‡è·¨åŸŸé—®é¢˜è§£å†³

è·¨åŸŸé—®é¢˜ä¹‹å‰æˆ‘ä»¬å·²ç»ç»å†è¿‡äº†ï¼Œæ˜¯å› ä¸ºå‰ç«¯åŸŸåå’ŒæœåŠ¡å™¨ï¼ˆå¯¹è±¡å­˜å‚¨ï¼‰çš„åŸŸåä¸ä¸€æ ·å¯¼è‡´çš„ã€‚

è§£å†³è·¨åŸŸé—®é¢˜çš„æ–¹å¼æœ‰å¾ˆå¤šï¼Œå› ä¸ºæˆ‘ä»¬çš„å›¾ç‰‡åœ°å€å…¨éƒ¨éƒ½æ˜¯åŒä¸€ä¸ªå¯¹è±¡å­˜å‚¨ URLï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥ç™»å½•äº‘å¹³å°æ¥ä¿®æ”¹å¯¹è±¡å­˜å‚¨çš„è·¨åŸŸè®¿é—® CORS è®¾ç½®ï¼Œç›´æ¥ç»™ç‰¹å®šçš„æºç«™ï¼ˆåŸŸå + ç«¯å£ï¼‰å¼€æ”¾è·¨åŸŸã€‚å¦‚å›¾ï¼š

![img](.\assets\fLXLefJh8It2oIei.webp)

ç„¶åå†æ¬¡æµ‹è¯•ç¼–è¾‘å›¾ç‰‡åŠŸèƒ½ï¼Œå›¾ç‰‡å°±æ­£å¸¸åŠ è½½äº†ï¼š

![img](.\assets\LD6U0s0WrmzSzobC.webp)

#### æ‰©å±•çŸ¥è¯† - é€šè¿‡ä»£ç†è§£å†³è·¨åŸŸ

å¯ä»¥é€šè¿‡ Vite è‡ªå¸¦çš„æœ¬åœ°ä»£ç†æœåŠ¡å™¨ï¼Œå…ˆæ›¿æ¢å›¾ç‰‡çš„è®¿é—®åœ°å€ä¸ºå‰ç«¯åœ°å€ï¼Œç„¶åé€šè¿‡ä»£ç†æœåŠ¡å™¨è½¬å‘åˆ°å¯¹è±¡å­˜å‚¨è·¯å¾„ï¼Œå®ç°è®¿é—®ã€‚

è·å–å›¾ç‰‡çš„å‚è€ƒä»£ç ï¼š

```typescript
/**
 * è·å–å›¾ç‰‡ blob å¯¹è±¡å’Œ base64
 * @param url å›¾ç‰‡ url
 * @param cb å›è°ƒå‡½æ•°,è¿”å› blob url å’Œ base64
 */
export const fetchImageAsBlob = async (
  url?: string,
  cb?: (blobUrl: string, base64: string) => void,
) => {
  if (!url) return
  const formatUrl = url.replace('https://pic.code-nav.cn', window.location.origin)
  try {
    const response = await fetch(formatUrl)
    if (!response.ok) {
      throw new Error('å›¾ç‰‡åŠ è½½å¤±è´¥')
    }
    const imageBlob = await response.blob()
    const objectUrl = URL.createObjectURL(imageBlob)

    // è½¬æ¢ä¸º base64
    const reader = new FileReader()
    reader.readAsDataURL(imageBlob)
    reader.onloadend = () => {
      const base64 = reader.result as string
      cb?.(objectUrl, base64)
    }
  } catch (error: any) {
    console.log(error)
  }
}
```

å‚è€ƒ vite é…ç½®ï¼š

```typescript
server: {
  host: 'localhost',
  // ä»£ç†
  proxy: {
    // æ”¹ä¸ºä½ çš„å›¾ç‰‡å­˜å‚¨ url å‰ç¼€
    '/yu_picture': {
      // æ”¹ä¸ºä½ çš„å¯¹è±¡å­˜å‚¨åŸŸå
      target: 'https://codefather.cn',
      changeOrigin: true,
    }
  },
},
```

### æ‰©å±•

1ï¼‰ä¼˜åŒ–ä¸šåŠ¡æµç¨‹ï¼šåœ¨å›¾ç‰‡ä¸Šä¼ å‰ï¼Œå…ˆè§¦å‘ç¼–è¾‘å¼¹çª—ï¼Œå®Œæˆå›¾ç‰‡è£å‰ªåå†ä¸Šä¼ åˆ°åç«¯ã€‚è¿™æ ·éœ€è¦å°†ç¼–è¾‘å›¾ç‰‡æ•´åˆåˆ°å›¾ç‰‡ä¸Šä¼ ç»„ä»¶å†…éƒ¨ï¼Œè€Œä¸æ˜¯å¹³çº§çš„å…³ç³»ã€‚

2ï¼‰æ”¯æŒè°ƒæ•´è£å‰ªåŒºåŸŸçš„å›ºå®šæ¯”ä¾‹ï¼ˆæ¯”å¦‚ 16:9ï¼‰ï¼Œå®ç°æ€è·¯æ˜¯åˆ©ç”¨ vue-cropper ç»„ä»¶çš„ fixedNumber å±æ€§ï¼Œå‚è€ƒä»£ç ï¼š

```vue
<!-- æ¯”ä¾‹é€‰æ‹© -->
<div class="aspect-ratio-selector">
  <a-radio-group v-model:value="aspectRatio" button-style="solid">
    <a-radio-button value="free">è‡ªç”±æ¯”ä¾‹</a-radio-button>
    <a-radio-button value="1:1">1:1</a-radio-button>
    <a-radio-button value="4:3">4:3</a-radio-button>
    <a-radio-button value="16:9">16:9</a-radio-button>
    <a-radio-button value="3:4">3:4</a-radio-button>
    <a-radio-button value="9:16">9:16</a-radio-button>
  </a-radio-group>
</div>

<vue-cropper
  ref="cropperRef"
  :img="imageUrl"
  :autoCrop="true"
  :fixedBox="false"
  :centerBox="true"
  :canMoveBox="true"
  :info="true"
  outputType="png"
  :fixed="aspectRatio !== 'free'"
  :fixedNumber="currentAspectRatio"
/>

const aspectRatio = ref('free')

// è®¡ç®—å½“å‰å®½é«˜æ¯”
const currentAspectRatio = computed(() => {
  if (aspectRatio.value === 'free') return [0, 0]
  const [width, height] = aspectRatio.value.split(':').map(Number)
  return [width, height]
})
```

3ï¼‰æ”¯æŒå›¾ç‰‡çš„ä»»æ„è§’åº¦æ—‹è½¬æ“ä½œ

4ï¼‰æ”¯æŒå¯¹å›¾ç‰‡å°ºå¯¸è¿›è¡Œç­‰æ¯”ä¾‹æ”¾å¤§çš„æ“ä½œ

## äºŒã€AI å›¾ç‰‡ç¼–è¾‘

### éœ€æ±‚åˆ†æ

éšç€ AI çš„é«˜é€Ÿå‘å±•ï¼ŒAI å‡ ä¹å¯ä»¥åº”ç”¨åˆ°ä»»ä½•ä¼ ç»Ÿä¸šåŠ¡ä¸­ï¼Œå¢å¼ºåº”ç”¨çš„åŠŸèƒ½ï¼Œå¸¦ç»™ç”¨æˆ·æ›´å¥½çš„ä½“éªŒã€‚

å¯¹äºå›¾åº“ç½‘ç«™æ¥è¯´ï¼ŒAI ä¹Ÿæœ‰éå¸¸å¤šçš„åº”ç”¨ç©ºé—´ï¼Œæ¯”å¦‚å¯ä»¥åˆ©ç”¨ AI ç»˜å›¾å¤§æ¨¡å‹æ¥ç¼–è¾‘å›¾ç‰‡ï¼Œå®ç°æ‰©å›¾ã€æ“¦é™¤è¡¥å…¨ã€å›¾é…æ–‡ã€å»æ°´å°ç­‰åŠŸèƒ½ã€‚

![img](.\assets\nDRGFE9awVJJnFOG.webp)

ä»¥ AI æ‰©å›¾åŠŸèƒ½ä¸ºä¾‹ï¼Œè®©æˆ‘ä»¬æ¥å­¦ä¹ å¦‚ä½•åœ¨é¡¹ç›®ä¸­å¿«é€Ÿæ¥å…¥ AI ç»˜å›¾å¤§æ¨¡å‹ã€‚ç”¨æˆ·å¯ä»¥é€‰æ‹©ä¸€å¼ å·²ä¸Šä¼ çš„å›¾ç‰‡ï¼Œé€šè¿‡ AI ç¼–è¾‘å¾—åˆ°æ–°çš„å›¾ç‰‡ï¼Œå¹¶æ ¹æ®æƒ…å†µè‡ªè¡Œé€‰æ‹©æ˜¯å¦ä¿å­˜ã€‚

æ³¨æ„ï¼Œè¯¥åŠŸèƒ½ä¸ç”¨é™åˆ¶ä»…åœ¨ç©ºé—´å†…æ‰èƒ½ä½¿ç”¨ï¼Œå…¬å…±å›¾åº“ä¹Ÿå¯ä»¥æ”¯æŒã€‚

### æ–¹æ¡ˆè®¾è®¡

#### 1ã€AI ç»˜å›¾å¤§æ¨¡å‹é€‰æ‹©

AI ç»˜å›¾å¤§æ¨¡å‹æˆ‘ä»¬è‡ªå·±æ˜¯æä¸æ¥çš„ï¼Œå¯ä»¥é€‰æ‹©ä¸€ä¸ªå¸‚é¢ä¸Šæ”¯æŒ AI ç»˜å›¾çš„å¤§æ¨¡å‹ã€‚

é€‰æ‹© AI å¤§æ¨¡å‹æ—¶ï¼Œæˆ‘ä»¬æœ€å…³æ³¨çš„åº”è¯¥æ˜¯ç”Ÿæˆæ•ˆæœã€ç”Ÿæˆé€Ÿåº¦è¿˜æœ‰ä»·æ ¼äº†å§ï¼Ÿå½“ç„¶ï¼Œå¯¹æˆ‘ä»¬å­¦ä¹ æ¥è¯´ï¼Œæœ€å…³æ³¨çš„è¿˜æ˜¯ä»·æ ¼ï¼Œæ¯•ç«Ÿç»˜ç”»å¤§æ¨¡å‹çš„è´¹ç”¨ä¸ä½ã€‚

å›½å¤–æ¯”è¾ƒçŸ¥åçš„å°±æ˜¯ Midjourneyï¼Œé±¼çš®ä»¥å‰ç”¨çš„å°±æ˜¯è¿™ä¸ªï¼Œä¸è¿‡ä¸ä»…å¼€å‘å¯¹æ¥éº»çƒ¦ï¼Œä»·æ ¼ä¹Ÿæ¯”è¾ƒè´µã€‚å›½å†…çš„ AI ç»˜å›¾å¤§æ¨¡å‹æ¯”è¾ƒæ¨è [é˜¿é‡Œäº‘ç™¾ç‚¼](https://click.aliyun.com/m/1000400273/) ï¼Œå®ƒæ˜¯ä¸€ç«™å¼çš„å¤§æ¨¡å‹å¼€å‘åŠåº”ç”¨æ„å»ºå¹³å°ï¼Œå¯ä»¥é€šè¿‡ç®€å•çš„ç•Œé¢æ“ä½œï¼Œåœ¨ 5 åˆ†é’Ÿå†…å¼€å‘å‡ºä¸€æ¬¾å¤§æ¨¡å‹åº”ç”¨ï¼Œå¹¶åœ¨çº¿ä½“éªŒæ•ˆæœã€‚

![img](.\assets\mVpWB21lwIqWrY0G.webp)

åˆ›å»ºå¥½åº”ç”¨åï¼Œåˆ©ç”¨å®˜æ–¹æä¾›çš„ API æˆ– SDKï¼Œç›´æ¥é€šè¿‡å‡ è¡Œä»£ç ï¼Œå°±èƒ½åœ¨é¡¹ç›®ä¸­ä½¿ç”¨å¤§æ¨¡å‹åº”ç”¨ï¼š

![img](.\assets\8L0nyQz0qULPoXYx.webp)

é€šè¿‡é˜…è¯» [å®˜æ–¹æ–‡æ¡£](https://click.aliyun.com/m/1000400274/)ï¼Œå‘ç°å®ƒæ˜¯æ”¯æŒ AI å›¾åƒç¼–è¾‘ä¸ç”ŸæˆåŠŸèƒ½çš„ï¼ŒåŒ…æ‹¬ AI æ‰©å›¾ï¼Œæ”¯æŒ HTTP è°ƒç”¨ï¼Œç¬¦åˆæˆ‘ä»¬çš„éœ€æ±‚ã€‚

![img](https://pic.code-nav.cn/course_picture/1608440217629360130/JpRIhV43ygLuIwgb.webp)

åœ¨ [æ§åˆ¶å°](https://click.aliyun.com/m/1000400275/) ä¹Ÿèƒ½çœ‹åˆ°å¯¹åº”çš„å›¾åƒç”»é¢æ‰©å±•æ¨¡å‹ï¼š

![img](https://pic.code-nav.cn/course_picture/1608440217629360130/2wRdelt4bIbgFBLH.webp)

ç™¾ç‚¼çš„å¤§æ¨¡å‹æä¾›äº† [æ–°äººå…è´¹é¢åº¦](https://click.aliyun.com/m/1000400407/)ï¼Œå¯ä»¥é€šè¿‡æ–‡æ¡£æˆ–è€…ç‚¹è¿›å¤§æ¨¡å‹äº†è§£ï¼Œå¯¹äºå­¦ä¹ ç”¨æ¥è¯´è¶³å¤Ÿäº†ï¼š

![img](.\assets\tgUWlvtTZ1Q4rR7v.webp)

ç»è¿‡é±¼çš®çš„æµ‹è¯•ï¼Œå›¾ç‰‡ç”Ÿæˆæ•ˆæœã€ç”Ÿæˆé€Ÿåº¦éƒ½æ˜¯ä¸é”™çš„ï¼Œå› æ­¤ï¼Œæœ¬é¡¹ç›®å°†é€‰ç”¨é˜¿é‡Œäº‘ç™¾ç‚¼å®ç° AI æ‰©å›¾åŠŸèƒ½ã€‚

![img](.\assets\1Ogcqwlcxef1Xcqb.webp)

ğŸ’¡ å»ºè®®ä¹‹å‰æ²¡æ¥è§¦è¿‡ç±»ä¼¼ AI å¤§æ¨¡å‹å¹³å°çš„åŒå­¦ï¼Œå…ˆå¤šåˆ©ç”¨ç½‘é¡µæ§åˆ¶å°ç†Ÿæ‚‰ AI å¤§æ¨¡å‹çš„ Promptã€äº†è§£ä¸åŒå¤§æ¨¡å‹çš„åŒºåˆ«ã€‚æ¨èä¸€ä¸ª [AI å­¦ä¹ ç½‘ç«™](https://www.waytoagi.com/)

#### 2ã€è°ƒç”¨æ–¹å¼

é€šè¿‡é˜…è¯» [AI å›¾åƒæ‰©å±•çš„å®˜æ–¹æ–‡æ¡£](https://click.aliyun.com/m/1000400274/)ï¼Œæˆ‘ä»¬å‘ç°ï¼ŒAPI åªæ”¯æŒå¼‚æ­¥æ–¹å¼è°ƒç”¨ã€‚

![img](https://pic.code-nav.cn/course_picture/1608440217629360130/NH9Uw8gmaV2ozTNt.webp)

è¿™æ˜¯å› ä¸º AI ç»˜ç”»ä»»åŠ¡è®¡ç®—é‡å¤§ä¸”è€—æ—¶é•¿ï¼ŒåŒæ­¥è°ƒç”¨ä¼šå¯¼è‡´æœåŠ¡å™¨çº¿ç¨‹é•¿æ—¶é—´è¢«å•ä¸ªä»»åŠ¡å ç”¨ï¼Œé™åˆ¶äº†å¹¶å‘å¤„ç†èƒ½åŠ›ï¼Œå¢åŠ äº†è¶…æ—¶å’Œç³»ç»Ÿå´©æºƒçš„é£é™©ã€‚é€šè¿‡å¼‚æ­¥è°ƒç”¨ï¼ŒæœåŠ¡å™¨å¯ä»¥å°†ä»»åŠ¡æ”¾å…¥é˜Ÿåˆ—ä¸­ï¼Œåˆç†è°ƒåº¦èµ„æºï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹ï¼Œä»è€Œæ›´é«˜æ•ˆåœ°æœåŠ¡å¤šä¸ªç”¨æˆ·è¯·æ±‚ï¼Œæå‡æ•´ä½“ç³»ç»Ÿçš„ç¨³å®šæ€§å’Œå¯æ‰©å±•æ€§ã€‚

åŒæ­¥è°ƒç”¨æµç¨‹å¦‚ä¸‹ï¼Œå¥½å¤„æ˜¯å®¢æˆ·ç«¯å¯ä»¥ç›´æ¥è·å–åˆ°ç»“æœï¼Œè°ƒç”¨æ›´æ–¹ä¾¿ï¼š

![img](.\assets\g7ApZyigm6gAVZiJ.webp)

å¼‚æ­¥è°ƒç”¨æµç¨‹å¦‚ä¸‹ï¼Œå®¢æˆ·ç«¯éœ€è¦åœ¨æäº¤ä»»åŠ¡åï¼Œä¸æ–­è½®è¯¢è¯·æ±‚ï¼Œæ¥æ£€æŸ¥ä»»åŠ¡æ˜¯å¦æ‰§è¡Œå®Œæˆï¼š

![img](.\assets\N4VFEZYIz6XWXZEn.webp)

ç”±äº AI æ¥å£å·²ç»é€‰æ‹©äº†å¼‚æ­¥è°ƒç”¨ï¼Œæ‰€ä»¥æˆ‘ä»¬ä½œä¸ºè¦è°ƒç”¨ AI æ¥å£çš„å®¢æˆ·ç«¯ï¼Œè¦ä½¿ç”¨è½®è¯¢çš„æ–¹å¼æ¥æ£€æŸ¥ä»»åŠ¡çŠ¶æ€æ˜¯å¦ä¸º â€œå·²å®Œæˆâ€ï¼Œå¦‚æœå®Œæˆäº†ï¼Œæ‰å¯ä»¥è·å–åˆ°ç”Ÿæˆçš„å›¾ç‰‡ã€‚

**é‚£ä¹ˆæ˜¯å‰ç«¯è½®è¯¢è¿˜æ˜¯åç«¯è½®è¯¢å‘¢ï¼Ÿ**

1ï¼‰å‰ç«¯è½®è¯¢

å‰ç«¯è°ƒç”¨åç«¯æäº¤ä»»åŠ¡åå¾—åˆ°ä»»åŠ¡ IDï¼Œç„¶åé€šè¿‡å®šæ—¶å™¨è½®è¯¢è¯·æ±‚æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€æ¥å£ï¼Œç›´åˆ°ä»»åŠ¡å®Œæˆæˆ–å¤±è´¥ã€‚ç¤ºä¾‹ä»£ç ï¼š

```typescript
// æäº¤ä»»åŠ¡
async function submitTask() {
  const response = await fetch('/api/createTask', { method: 'POST' });
  const { taskId } = await response.json();
  checkTaskStatus(taskId);
}

// è°ƒç”¨
submitTask();

// æ£€æŸ¥ä»»åŠ¡çŠ¶æ€
async function checkTaskStatus(taskId) {
  const intervalId = setInterval(async () => {
    const response = await fetch(`/api/taskStatus?taskId=${taskId}`);
    const { status, result } = await response.json();

    if (status === 'success') {
      console.log('Task completed:', result);
      clearInterval(intervalId); // åœæ­¢è½®è¯¢
    } else if (status === 'failed') {
      console.error('Task failed');
      clearInterval(intervalId); // åœæ­¢è½®è¯¢
    }
  }, 2000); // æ¯éš” 2 ç§’è½®è¯¢
}
```

2ï¼‰åç«¯è½®è¯¢

åç«¯é€šè¿‡å¾ªç¯æˆ–å®šæ—¶ä»»åŠ¡æ£€æµ‹ä»»åŠ¡çŠ¶æ€ï¼Œæ¥å£ä¿æŒé˜»å¡ï¼Œç›´åˆ°ä»»åŠ¡å®Œæˆæˆ–å¤±è´¥ï¼Œç›´æ¥è¿”å›ç»“æœç»™å‰ç«¯ã€‚ç¤ºä¾‹ä»£ç ï¼š

```java
@RestController
public class TaskController {

    @PostMapping("/createTask")
    public String createTask() {
        String taskId = taskService.submitTask();
        return taskId;
    }

    @GetMapping("/waitForTask")
    public ResponseEntity<String> waitForTask(@RequestParam String taskId) {
        while (true) {
            String status = taskService.checkTaskStatus(taskId);

            if ("success".equals(status)) {
                return ResponseEntity.ok("Task completed");
            } else if ("failed".equals(status)) {
                return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body("Task failed");
            }

            try {
                Thread.sleep(2000); // ç­‰å¾… 2 ç§’åé‡è¯•
            } catch (InterruptedException e) {
                return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body("Error occurred");
            }
        }
    }
}
```

æ˜¾ç„¶ï¼Œåç«¯è½®è¯¢å®¹æ˜“å› ä¸ºä»»åŠ¡é˜»å¡å¯¼è‡´èµ„æºè€—å°½ï¼Œæ‰€ä»¥é€šå¸¸æ¨è **å‰ç«¯è½®è¯¢**ã€‚é™¤éæœ‰æ˜ç¡®çš„éœ€æ±‚è¦æ±‚æ—¶ï¼Œæ‰è€ƒè™‘åç«¯è½®è¯¢ï¼Œæ¯”å¦‚ä»»åŠ¡ç»“æœéœ€å®æ—¶è¿”å›ä¸”å¯¹ç½‘ç»œè¯·æ±‚æ•°æ•æ„Ÿã€‚ï¼ˆæˆ–è€…å­¦ä¹ æ—¶ä¸æƒ³å†™å‰ç«¯çš„åŒå­¦å“ˆå“ˆï¼‰

æ­¤å¤„æˆ‘ä»¬ä¹Ÿé€‰æ‹©å‰ç«¯è½®è¯¢æ–¹æ¡ˆå®ç°ã€‚

ğŸ’¡ ä»è¿™ä¸ªæ–¹æ¡ˆè®¾è®¡ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿèƒ½æ„Ÿå—åˆ°ï¼Œå¦‚æœä½ åŒæ—¶äº†è§£å‰ç«¯å’Œåç«¯ï¼Œå¯ä»¥ç»“åˆäºŒè€…è®¾è®¡å‡ºæ›´åˆç†çš„æ–¹æ¡ˆï¼Œè€Œä¸æ˜¯æŠŠæ‰€æœ‰çš„ â€œé‡æ‹…â€ éƒ½äº¤ç»™å‰ç«¯æˆ–è€…åç«¯ä¸€æ–¹ã€‚æ‰€ä»¥ä¼ä¸šä¸­å¼€éœ€æ±‚è¯„å®¡ä¼šæˆ–è€…è®¨è®ºæ–¹æ¡ˆæ—¶ï¼Œå‰åç«¯éœ€è¦ç´§å¯†åä½œã€‚

ä¸‹é¢è¿›å…¥å¼€å‘ã€‚

### åç«¯å¼€å‘

#### 1ã€AI æ‰©å›¾ API

é¦–å…ˆå¼€å‘ä¸šåŠ¡ä¾èµ–çš„åŸºç¡€èƒ½åŠ›ï¼Œä¹Ÿå°±æ˜¯ AI æ‰©å›¾ APIã€‚

1ï¼‰éœ€è¦å…ˆè¿›å…¥ [é˜¿é‡Œäº‘ç™¾ç‚¼æ§åˆ¶å°](https://click.aliyun.com/m/1000400275/) å¼€é€šæœåŠ¡ï¼š

![img](.\assets\pfSDoFF6mXUhvgf1.webp)

å¼€é€šæ¨ç†èƒ½åŠ›ï¼š

![img](.\assets\9N7E8haCahi8Uh8V.webp)

2ï¼‰å¼€é€šä¹‹åï¼Œæˆ‘ä»¬è¦åœ¨æ§åˆ¶å°è·å– API Keyï¼Œå¯ [å‚è€ƒæ–‡æ¡£](https://click.aliyun.com/m/1000400408/)ï¼š

![img](.\assets\DwHlWvi3c6uRZcR2.webp)

èƒ½å¤Ÿåœ¨æ§åˆ¶å°æŸ¥çœ‹åˆ° API Keyï¼Œæ³¨æ„ï¼ŒAPI Key ä¸€å®šä¸è¦å¯¹å¤–æ³„éœ²ï¼

é€šè¿‡é˜…è¯»æ–‡æ¡£å‘ç°ï¼Œç™¾ç‚¼æ”¯æŒé€šè¿‡ SDK æˆ– HTTP è°ƒç”¨ã€‚è™½ç„¶å®˜æ–¹å†™çš„æ”¯æŒ Java SDKï¼Œä½† AI æ‰©å›¾åŠŸèƒ½ä¸­å¯¹ SDK çš„ä»‹ç»éå¸¸å°‘ï¼Œæ­¤å¤„è€ƒè™‘åˆ°å…¼å®¹æ€§ï¼Œæˆ‘ä»¬è¿˜æ˜¯ **ä½¿ç”¨ HTTP è°ƒç”¨**ã€‚

![img](.\assets\AkFtPYzza9PWJeam.webp)

ç”±äºä½¿ç”¨å¼‚æ­¥çš„æ–¹å¼ï¼Œéœ€è¦å¼€å‘åˆ›å»ºä»»åŠ¡å’ŒæŸ¥è¯¢ç»“æœ 2 ä¸ª APIï¼š

![img](.\assets\qDX2R3azuS8v6CzS.webp)

3ï¼‰åœ¨é…ç½®æ–‡ä»¶ä¸­å¡«å†™è·å–åˆ°çš„ apiKeyï¼š

```yaml
# é˜¿é‡Œäº‘ AI é…ç½®
aliYunAi:
  apiKey: xxxx
```

4ï¼‰æ–°å»ºæ•°æ®æ¨¡å‹ç±»

åœ¨ `api` åŒ…ä¸‹æ–°å»º `aliyunai` åŒ…ï¼Œå­˜æ”¾é˜¿é‡Œäº‘ AI ç›¸å…³ä»£ç ã€‚

åœ¨ `aliyunai.model` åŒ…ä¸‹æ–°å»ºæ•°æ®æ¨¡å‹ç±»ï¼Œå¯ä»¥è®© AI æ ¹æ®å®˜æ–¹æ–‡æ¡£ä¸­çš„è¯·æ±‚å“åº”ä¿¡æ¯è‡ªåŠ¨ç”Ÿæˆï¼Œæ— éœ€è‡ªå·±æ‰‹åŠ¨ç¼–å†™ã€‚

ç”±äºæ¯ä¸ª AI å›¾ç‰‡å¤„ç†æ“ä½œçš„è¯·æ±‚å“åº”éƒ½æœ‰ä¸€äº›åŒºåˆ«ï¼Œæ‰€ä»¥å•ç‹¬ç»™ AI æ‰©å›¾åŠŸèƒ½ç¼–å†™å…·ä½“çš„è¯·æ±‚å“åº”ç±»ã€‚

åˆ›å»ºæ‰©å›¾ä»»åŠ¡è¯·æ±‚ç±»ï¼š

```java
@Data
public class CreateOutPaintingTaskRequest implements Serializable {

    /**
     * æ¨¡å‹ï¼Œä¾‹å¦‚ "image-out-painting"
     */
    private String model = "image-out-painting";

    /**
     * è¾“å…¥å›¾åƒä¿¡æ¯
     */
    private Input input;

    /**
     * å›¾åƒå¤„ç†å‚æ•°
     */
    private Parameters parameters;

    @Data
    public static class Input {
        /**
         * å¿…é€‰ï¼Œå›¾åƒ URL
         */
        @Alias("image_url")
        private String imageUrl;
    }

    @Data
    public static class Parameters implements Serializable {
        /**
         * å¯é€‰ï¼Œé€†æ—¶é’ˆæ—‹è½¬è§’åº¦ï¼Œé»˜è®¤å€¼ 0ï¼Œå–å€¼èŒƒå›´ [0, 359]
         */
        private Integer angle;

        /**
         * å¯é€‰ï¼Œè¾“å‡ºå›¾åƒçš„å®½é«˜æ¯”ï¼Œé»˜è®¤ç©ºå­—ç¬¦ä¸²ï¼Œä¸è®¾ç½®å®½é«˜æ¯”
         * å¯é€‰å€¼ï¼š["", "1:1", "3:4", "4:3", "9:16", "16:9"]
         */
        @Alias("output_ratio")
        private String outputRatio;

        /**
         * å¯é€‰ï¼Œå›¾åƒå±…ä¸­ï¼Œåœ¨æ°´å¹³æ–¹å‘ä¸ŠæŒ‰æ¯”ä¾‹æ‰©å±•ï¼Œé»˜è®¤å€¼ 1.0ï¼ŒèŒƒå›´ [1.0, 3.0]
         */
        @Alias("x_scale")
        @JsonProperty("xScale")
        private Float xScale;

        /**
         * å¯é€‰ï¼Œå›¾åƒå±…ä¸­ï¼Œåœ¨å‚ç›´æ–¹å‘ä¸ŠæŒ‰æ¯”ä¾‹æ‰©å±•ï¼Œé»˜è®¤å€¼ 1.0ï¼ŒèŒƒå›´ [1.0, 3.0]
         */
        @Alias("y_scale")
        @JsonProperty("yScale")
        private Float yScale;

        /**
         * å¯é€‰ï¼Œåœ¨å›¾åƒä¸Šæ–¹æ·»åŠ åƒç´ ï¼Œé»˜è®¤å€¼ 0
         */
        @Alias("top_offset")
        private Integer topOffset;

        /**
         * å¯é€‰ï¼Œåœ¨å›¾åƒä¸‹æ–¹æ·»åŠ åƒç´ ï¼Œé»˜è®¤å€¼ 0
         */
        @Alias("bottom_offset")
        private Integer bottomOffset;

        /**
         * å¯é€‰ï¼Œåœ¨å›¾åƒå·¦ä¾§æ·»åŠ åƒç´ ï¼Œé»˜è®¤å€¼ 0
         */
        @Alias("left_offset")
        private Integer leftOffset;

        /**
         * å¯é€‰ï¼Œåœ¨å›¾åƒå³ä¾§æ·»åŠ åƒç´ ï¼Œé»˜è®¤å€¼ 0
         */
        @Alias("right_offset")
        private Integer rightOffset;

        /**
         * å¯é€‰ï¼Œå¼€å¯å›¾åƒæœ€ä½³è´¨é‡æ¨¡å¼ï¼Œé»˜è®¤å€¼ false
         * è‹¥ä¸º trueï¼Œè€—æ—¶ä¼šæˆå€å¢åŠ 
         */
        @Alias("best_quality")
        private Boolean bestQuality;

        /**
         * å¯é€‰ï¼Œé™åˆ¶æ¨¡å‹ç”Ÿæˆçš„å›¾åƒæ–‡ä»¶å¤§å°ï¼Œé»˜è®¤å€¼ true
         * - å•è¾¹é•¿åº¦ <= 10000ï¼šè¾“å‡ºå›¾åƒæ–‡ä»¶å¤§å°é™åˆ¶ä¸º 5MB ä»¥ä¸‹
         * - å•è¾¹é•¿åº¦ > 10000ï¼šè¾“å‡ºå›¾åƒæ–‡ä»¶å¤§å°é™åˆ¶ä¸º 10MB ä»¥ä¸‹
         */
        @Alias("limit_image_size")
        private Boolean limitImageSize;

        /**
         * å¯é€‰ï¼Œæ·»åŠ  "Generated by AI" æ°´å°ï¼Œé»˜è®¤å€¼ true
         */
        @Alias("add_watermark")
        private Boolean addWatermark = false;
    }
}
```

æ³¨æ„ï¼Œä¸Šè¿°ä»£ç ä¸­ï¼ŒæŸäº›å­—æ®µæ‰“ä¸Šäº† Hutool å·¥å…·ç±»çš„ `@Alias` æ³¨è§£ï¼Œè¿™ä¸ªæ³¨è§£ä»…å¯¹ Hutool çš„ JSON è½¬æ¢ç”Ÿæ•ˆï¼Œå¯¹ SpringMVC çš„ JSON è½¬æ¢æ²¡æœ‰ä»»ä½•å½±å“ã€‚

ğŸ’¡ è¿™é‡Œæœ‰ä¸€ä¸ªå·¨å‘çš„åœ°æ–¹ï¼ç»è¿‡æµ‹è¯•å‘ç°ï¼Œå‰ç«¯å¦‚æœä¼ é€’å‚æ•°å xScaleï¼Œæ˜¯æ— æ³•èµ‹å€¼ç»™ xScale å­—æ®µçš„ï¼›ä½†æ˜¯ä¼ é€’å‚æ•°å xscaleï¼Œå°±å¯ä»¥èµ‹å€¼ã€‚è¿™æ˜¯å› ä¸º SpringMVC å¯¹äºç¬¬äºŒä¸ªå­—æ¯æ˜¯å¤§å†™çš„å‚æ•°æ— æ³•æ˜ å°„ï¼ˆå’Œå‚æ•°ç±»åˆ«æ— å…³ï¼‰ï¼Œ[å‚è€ƒåšå®¢](https://blog.csdn.net/JokerHH/article/details/88729590)ã€‚

è§£å†³æ–¹æ¡ˆæ˜¯ï¼Œç»™è¿™äº›å­—æ®µå¢åŠ  `@JsonProperty` æ³¨è§£ï¼š

```java
/**
 * å¯é€‰ï¼Œå›¾åƒå±…ä¸­ï¼Œåœ¨æ°´å¹³æ–¹å‘ä¸ŠæŒ‰æ¯”ä¾‹æ‰©å±•ï¼Œé»˜è®¤å€¼ 1.0ï¼ŒèŒƒå›´ [1.0, 3.0]
 */
@Alias("x_scale")
@JsonProperty("xScale")
private Float xScale;

/**
 * å¯é€‰ï¼Œå›¾åƒå±…ä¸­ï¼Œåœ¨å‚ç›´æ–¹å‘ä¸ŠæŒ‰æ¯”ä¾‹æ‰©å±•ï¼Œé»˜è®¤å€¼ 1.0ï¼ŒèŒƒå›´ [1.0, 3.0]
 */
@Alias("y_scale")
@JsonProperty("yScale")
private Float yScale;
```

ä¸ºä»€ä¹ˆ SpringMVC è¦è¿™æ ·è®¾è®¡å‘¢ï¼Ÿé±¼çš®é€šè¿‡æŸ¥é˜…äº†è§£åˆ°ï¼Œè¿™æ˜¯å› ä¸º Jackson åœ¨å¤„ç†å­—æ®µåä¸ JSON å±æ€§åæ˜ å°„æ—¶ï¼Œä¼šä¾èµ– Java çš„ **æ ‡å‡†å‘½åè§„èŒƒ** å’Œ **åå°„ API**ã€‚

ä¸¾ä¸ªä¾‹å­ï¼Œæ ¹æ® JavaBean çš„è§„èŒƒï¼Œå±æ€§åç§°ä¸å…¶è®¿é—®å™¨æ–¹æ³•ï¼ˆgetter å’Œ setterï¼‰ä¹‹é—´çš„æ˜ å°„è§„åˆ™æ˜¯ï¼šå¦‚æœå±æ€§åä»¥å°å†™å­—æ¯å¼€å¤´ï¼Œç¬¬äºŒä¸ªå­—æ¯æ˜¯å¤§å†™ï¼ˆå¦‚ `eMail`ï¼‰ï¼Œè§„èŒƒä»è®¤ä¸ºå±æ€§åç§°æ˜¯ `eMail`ï¼Œè€Œè®¿é—®å™¨æ–¹æ³•åº”ä¸º `geteMail()` å’Œ `seteMail()`ã€‚ä½† Jackson ä¼šå°è¯•æ¨æ–­å±æ€§åä¸º `email`ï¼ˆå› ä¸º `eMail` ä¸å¸¸è§ï¼‰ï¼Œä»è€Œå¯¼è‡´ JSON ä¸­ `eMail` æˆ– `email` å¯èƒ½æ— æ³•æ­£ç¡®æ˜ å°„ã€‚

åˆ›å»ºæ‰©å›¾ä»»åŠ¡å“åº”ç±»ï¼š

```java
@Data
@NoArgsConstructor
@AllArgsConstructor
public class CreateOutPaintingTaskResponse {

    private Output output;

    /**
     * è¡¨ç¤ºä»»åŠ¡çš„è¾“å‡ºä¿¡æ¯
     */
    @Data
    public static class Output {

        /**
         * ä»»åŠ¡ ID
         */
        private String taskId;

        /**
         * ä»»åŠ¡çŠ¶æ€
         * <ul>
         *     <li>PENDINGï¼šæ’é˜Ÿä¸­</li>
         *     <li>RUNNINGï¼šå¤„ç†ä¸­</li>
         *     <li>SUSPENDEDï¼šæŒ‚èµ·</li>
         *     <li>SUCCEEDEDï¼šæ‰§è¡ŒæˆåŠŸ</li>
         *     <li>FAILEDï¼šæ‰§è¡Œå¤±è´¥</li>
         *     <li>UNKNOWNï¼šä»»åŠ¡ä¸å­˜åœ¨æˆ–çŠ¶æ€æœªçŸ¥</li>
         * </ul>
         */
        private String taskStatus;
    }

    /**
     * æ¥å£é”™è¯¯ç ã€‚
     * <p>æ¥å£æˆåŠŸè¯·æ±‚ä¸ä¼šè¿”å›è¯¥å‚æ•°ã€‚</p>
     */
    private String code;

    /**
     * æ¥å£é”™è¯¯ä¿¡æ¯ã€‚
     * <p>æ¥å£æˆåŠŸè¯·æ±‚ä¸ä¼šè¿”å›è¯¥å‚æ•°ã€‚</p>
     */
    private String message;

    /**
     * è¯·æ±‚å”¯ä¸€æ ‡è¯†ã€‚
     * <p>å¯ç”¨äºè¯·æ±‚æ˜ç»†æº¯æºå’Œé—®é¢˜æ’æŸ¥ã€‚</p>
     */
    private String requestId;

}
```

æŸ¥è¯¢ä»»åŠ¡å“åº”ç±»ï¼š

```java
@Data
@NoArgsConstructor
@AllArgsConstructor
public class GetOutPaintingTaskResponse {

    /**
     * è¯·æ±‚å”¯ä¸€æ ‡è¯†
     */
    private String requestId;

    /**
     * è¾“å‡ºä¿¡æ¯
     */
    private Output output;

    /**
     * è¡¨ç¤ºä»»åŠ¡çš„è¾“å‡ºä¿¡æ¯
     */
    @Data
    public static class Output {

        /**
         * ä»»åŠ¡ ID
         */
        private String taskId;

        /**
         * ä»»åŠ¡çŠ¶æ€
         * <ul>
         *     <li>PENDINGï¼šæ’é˜Ÿä¸­</li>
         *     <li>RUNNINGï¼šå¤„ç†ä¸­</li>
         *     <li>SUSPENDEDï¼šæŒ‚èµ·</li>
         *     <li>SUCCEEDEDï¼šæ‰§è¡ŒæˆåŠŸ</li>
         *     <li>FAILEDï¼šæ‰§è¡Œå¤±è´¥</li>
         *     <li>UNKNOWNï¼šä»»åŠ¡ä¸å­˜åœ¨æˆ–çŠ¶æ€æœªçŸ¥</li>
         * </ul>
         */
        private String taskStatus;

        /**
         * æäº¤æ—¶é—´
         * æ ¼å¼ï¼šYYYY-MM-DD HH:mm:ss.SSS
         */
        private String submitTime;

        /**
         * è°ƒåº¦æ—¶é—´
         * æ ¼å¼ï¼šYYYY-MM-DD HH:mm:ss.SSS
         */
        private String scheduledTime;

        /**
         * ç»“æŸæ—¶é—´
         * æ ¼å¼ï¼šYYYY-MM-DD HH:mm:ss.SSS
         */
        private String endTime;

        /**
         * è¾“å‡ºå›¾åƒçš„ URL
         */
        private String outputImageUrl;

        /**
         * æ¥å£é”™è¯¯ç 
         * <p>æ¥å£æˆåŠŸè¯·æ±‚ä¸ä¼šè¿”å›è¯¥å‚æ•°</p>
         */
        private String code;

        /**
         * æ¥å£é”™è¯¯ä¿¡æ¯
         * <p>æ¥å£æˆåŠŸè¯·æ±‚ä¸ä¼šè¿”å›è¯¥å‚æ•°</p>
         */
        private String message;

        /**
         * ä»»åŠ¡æŒ‡æ ‡ä¿¡æ¯
         */
        private TaskMetrics taskMetrics;
    }

    /**
     * è¡¨ç¤ºä»»åŠ¡çš„ç»Ÿè®¡ä¿¡æ¯
     */
    @Data
    public static class TaskMetrics {

        /**
         * æ€»ä»»åŠ¡æ•°
         */
        private Integer total;

        /**
         * æˆåŠŸä»»åŠ¡æ•°
         */
        private Integer succeeded;

        /**
         * å¤±è´¥ä»»åŠ¡æ•°
         */
        private Integer failed;
    }
}
```

5ï¼‰å¼€å‘ API è°ƒç”¨ç±»ï¼Œé€šè¿‡ Hutool çš„ HTTP è¯·æ±‚å·¥å…·ç±»æ¥è°ƒç”¨é˜¿é‡Œäº‘ç™¾ç‚¼çš„ APIï¼š

```java
@Slf4j
@Component
public class AliYunAiApi {
    // è¯»å–é…ç½®æ–‡ä»¶
    @Value("${aliYunAi.apiKey}")
    private String apiKey;

    // åˆ›å»ºä»»åŠ¡åœ°å€
    public static final String CREATE_OUT_PAINTING_TASK_URL = "https://dashscope.aliyuncs.com/api/v1/services/aigc/image2image/out-painting";

    // æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€
    public static final String GET_OUT_PAINTING_TASK_URL = "https://dashscope.aliyuncs.com/api/v1/tasks/%s";

    /**
     * åˆ›å»ºä»»åŠ¡
     *
     * @param createOutPaintingTaskRequest
     * @return
     */
    public CreateOutPaintingTaskResponse createOutPaintingTask(CreateOutPaintingTaskRequest createOutPaintingTaskRequest) {
        if (createOutPaintingTaskRequest == null) {
            throw new BusinessException(ErrorCode.OPERATION_ERROR, "æ‰©å›¾å‚æ•°ä¸ºç©º");
        }
        // å‘é€è¯·æ±‚
        HttpRequest httpRequest = HttpRequest.post(CREATE_OUT_PAINTING_TASK_URL)
                .header(Header.AUTHORIZATION, "Bearer " + apiKey)
                // å¿…é¡»å¼€å¯å¼‚æ­¥å¤„ç†ï¼Œè®¾ç½®ä¸ºenableã€‚
                .header("X-DashScope-Async", "enable")
                .header(Header.CONTENT_TYPE, ContentType.JSON.getValue())
                .body(JSONUtil.toJsonStr(createOutPaintingTaskRequest));
        try (HttpResponse httpResponse = httpRequest.execute()) {
            if (!httpResponse.isOk()) {
                log.error("è¯·æ±‚å¼‚å¸¸ï¼š{}", httpResponse.body());
                throw new BusinessException(ErrorCode.OPERATION_ERROR, "AI æ‰©å›¾å¤±è´¥");
            }
            CreateOutPaintingTaskResponse response = JSONUtil.toBean(httpResponse.body(), CreateOutPaintingTaskResponse.class);
            String errorCode = response.getCode();
            if (StrUtil.isNotBlank(errorCode)) {
                String errorMessage = response.getMessage();
                log.error("AI æ‰©å›¾å¤±è´¥ï¼ŒerrorCode:{}, errorMessage:{}", errorCode, errorMessage);
                throw new BusinessException(ErrorCode.OPERATION_ERROR, "AI æ‰©å›¾æ¥å£å“åº”å¼‚å¸¸");
            }
            return response;
        }
    }

    /**
     * æŸ¥è¯¢åˆ›å»ºçš„ä»»åŠ¡
     *
     * @param taskId
     * @return
     */
    public GetOutPaintingTaskResponse getOutPaintingTask(String taskId) {
        if (StrUtil.isBlank(taskId)) {
            throw new BusinessException(ErrorCode.OPERATION_ERROR, "ä»»åŠ¡ id ä¸èƒ½ä¸ºç©º");
        }
        try (HttpResponse httpResponse = HttpRequest.get(String.format(GET_OUT_PAINTING_TASK_URL, taskId))
                .header(Header.AUTHORIZATION, "Bearer " + apiKey)
                .execute()) {
            if (!httpResponse.isOk()) {
                throw new BusinessException(ErrorCode.OPERATION_ERROR, "è·å–ä»»åŠ¡å¤±è´¥");
            }
            return JSONUtil.toBean(httpResponse.body(), GetOutPaintingTaskResponse.class);
        }
    }
}
```

æ³¨æ„ï¼Œè¦æŒ‰ç…§å®˜æ–¹æ–‡æ¡£çš„è¦æ±‚ç»™è¯·æ±‚å¤´å¢åŠ é‰´æƒä¿¡æ¯ï¼Œæ‹¼æ¥é…ç½®ä¸­å†™å¥½çš„ apiKeyï¼š

![img](.\assets\76qoXb7aKBdj7bBv.webp)

#### 2ã€æ‰©å›¾æœåŠ¡

åœ¨ `model.dto.picture` åŒ…ä¸‹æ–°å»º AI æ‰©å›¾è¯·æ±‚ç±»ï¼Œç”¨äºæ¥å—å‰ç«¯ä¼ æ¥çš„å‚æ•°å¹¶ä¼ é€’ç»™ Service æœåŠ¡å±‚ã€‚å­—æ®µåŒ…æ‹¬å›¾ç‰‡ id å’Œæ‰©å›¾å‚æ•°ï¼š

```java
@Data
public class CreatePictureOutPaintingTaskRequest implements Serializable {

    /**
     * å›¾ç‰‡ id
     */
    private Long pictureId;

    /**
     * æ‰©å›¾å‚æ•°
     */
    private CreateOutPaintingTaskRequest.Parameters parameters;

    private static final long serialVersionUID = 1L;
}
```

åœ¨å›¾ç‰‡æœåŠ¡ä¸­ç¼–å†™åˆ›å»ºæ‰©å›¾ä»»åŠ¡æ–¹æ³•ï¼Œä»æ•°æ®åº“ä¸­è·å–å›¾ç‰‡ä¿¡æ¯å’Œ url åœ°å€ï¼Œæ„é€ è¯·æ±‚å‚æ•°åè°ƒç”¨ api åˆ›å»ºæ‰©å›¾ä»»åŠ¡ã€‚æ³¨æ„ï¼Œå¦‚æœå›¾ç‰‡æœ‰ç©ºé—´ idï¼Œåˆ™éœ€è¦æ ¡éªŒæƒé™ï¼Œç›´æ¥å¤ç”¨ä»¥å‰çš„æƒé™æ ¡éªŒæ–¹æ³•ã€‚

```java
@Override
public CreateOutPaintingTaskResponse createPictureOutPaintingTask(CreatePictureOutPaintingTaskRequest createPictureOutPaintingTaskRequest, User loginUser) {
    // è·å–å›¾ç‰‡ä¿¡æ¯
    Long pictureId = createPictureOutPaintingTaskRequest.getPictureId();
    Picture picture = Optional.ofNullable(this.getById(pictureId))
            .orElseThrow(() -> new BusinessException(ErrorCode.NOT_FOUND_ERROR));
    // æƒé™æ ¡éªŒ
    checkPictureAuth(loginUser, picture);
    // æ„é€ è¯·æ±‚å‚æ•°
    CreateOutPaintingTaskRequest taskRequest = new CreateOutPaintingTaskRequest();
    CreateOutPaintingTaskRequest.Input input = new CreateOutPaintingTaskRequest.Input();
    input.setImageUrl(picture.getUrl());
    taskRequest.setInput(input);
    BeanUtil.copyProperties(createPictureOutPaintingTaskRequest, taskRequest);
    // åˆ›å»ºä»»åŠ¡
    return aliYunAiApi.createOutPaintingTask(taskRequest);
}
```

#### 3ã€æ‰©å›¾æ¥å£

åœ¨ PictureController æ·»åŠ  AI æ‰©å›¾æ¥å£ï¼ŒåŒ…æ‹¬åˆ›å»ºä»»åŠ¡å’ŒæŸ¥è¯¢ä»»åŠ¡çŠ¶æ€æ¥å£ï¼š

```java
/**
 * åˆ›å»º AI æ‰©å›¾ä»»åŠ¡
 */
@PostMapping("/out_painting/create_task")
public BaseResponse<CreateOutPaintingTaskResponse> createPictureOutPaintingTask(
        @RequestBody CreatePictureOutPaintingTaskRequest createPictureOutPaintingTaskRequest,
        HttpServletRequest request) {
    if (createPictureOutPaintingTaskRequest == null || createPictureOutPaintingTaskRequest.getPictureId() == null) {
        throw new BusinessException(ErrorCode.PARAMS_ERROR);
    }
    User loginUser = userService.getLoginUser(request);
    CreateOutPaintingTaskResponse response = pictureService.createPictureOutPaintingTask(createPictureOutPaintingTaskRequest, loginUser);
    return ResultUtils.success(response);
}

/**
 * æŸ¥è¯¢ AI æ‰©å›¾ä»»åŠ¡
 */
@GetMapping("/out_painting/get_task")
public BaseResponse<GetOutPaintingTaskResponse> getPictureOutPaintingTask(String taskId) {
    ThrowUtils.throwIf(StrUtil.isBlank(taskId), ErrorCode.PARAMS_ERROR);
    GetOutPaintingTaskResponse task = aliYunAiApi.getOutPaintingTask(taskId);
    return ResultUtils.success(task);
}
```

### å‰ç«¯å¼€å‘

å¯ä»¥å‚è€ƒåŸºç¡€ç¼–è¾‘å›¾ç‰‡çš„äº¤äº’æµç¨‹ï¼Œåœ¨ç¼–è¾‘å›¾ç‰‡æŒ‰é’®æ—è¾¹æ·»åŠ  AI æ‰©å›¾æŒ‰é’®ï¼Œç‚¹å‡»ä¹‹åæ˜¾ç¤ºå¼¹çª—è¿›è¡Œ AI æ‰©å›¾æ“ä½œã€‚

è¿™æ ·å¯ä»¥å°† AI æ“ä½œçš„é€»è¾‘å°è£…åˆ°å•ç‹¬çš„ç»„ä»¶ä¸­ï¼Œè®©åˆ›å»ºå›¾ç‰‡é¡µé¢çš„ä»£ç æ›´ç²¾ç®€ã€‚

#### 1ã€AI æ‰©å›¾å¼¹çª—

1ï¼‰å…ˆå¤åˆ¶ä¹‹å‰å¼€å‘å¥½çš„è£å‰ªå›¾ç‰‡å¼¹çª—ï¼Œä¿ç•™æ§åˆ¶å¼¹çª—æ˜¾ç¤ºéšè—çš„é€»è¾‘ï¼Œä¿®æ”¹å¼¹çª—çš„æ ‡é¢˜ï¼š

```vue
<template>
  <a-modal
    class="image-out-painting"
    v-model:visible="visible"
    title="AI æ‰©å›¾"
    :footer="false"
    @cancel="closeModal"
  >

  </a-modal>
</template>

<script setup lang="ts">
import { ref } from 'vue'
import { uploadPictureUsingPost } from '@/api/pictureController'
import { message } from 'ant-design-vue'

interface Props {
  picture?: API.PictureVO
  spaceId?: number
  onSuccess?: (newPicture: API.PictureVO) => void
}

const props = defineProps<Props>()

// æ˜¯å¦å¯è§
const visible = ref(false)

// æ‰“å¼€å¼¹çª—
const openModal = () => {
  visible.value = true
}

// å…³é—­å¼¹çª—
const closeModal = () => {
  visible.value = false
}

// æš´éœ²å‡½æ•°ç»™çˆ¶ç»„ä»¶
defineExpose({
  openModal,
})
</script>

<style scoped>
.image-out-painting {
  text-align: center;
}
</style>
```

ç”±äº AI æ‰©å›¾ä¸€å®šæ˜¯å¯¹å·²æœ‰å›¾ç‰‡è¿›è¡Œç¼–è¾‘ï¼Œæ‰€ä»¥å¼¹çª—çš„å±æ€§å¯ä»¥ä¸éœ€è¦ spaceIdã€‚

2ï¼‰å¼€å‘å¼¹çª—çš„å†…å®¹ï¼Œé‡‡ç”¨ä¸€è¡Œä¸¤åˆ—æ …æ ¼å¸ƒå±€ï¼Œå·¦è¾¹æ˜¾ç¤ºåŸå§‹å›¾ç‰‡ã€å³è¾¹æ˜¾ç¤ºæ‰©å›¾ç»“æœï¼Œä¸‹æ–¹å±•ç¤ºæ‰©å›¾æ“ä½œæŒ‰é’®ã€‚

```vue
<a-row gutter="16">
  <a-col span="12">
    <h4>åŸå§‹å›¾ç‰‡</h4>
    <img :src="picture?.url" :alt="picture?.name" style="max-width: 100%" />
  </a-col>
  <a-col span="12">
    <h4>æ‰©å›¾ç»“æœ</h4>
    <img
      v-if="resultImageUrl"
      :src="resultImageUrl"
      :alt="picture?.name"
      style="max-width: 100%"
    />
  </a-col>
</a-row>
<div style="margin-bottom: 16px" />
<a-flex gap="16" justify="center">
  <a-button type="primary" ghost @click="createTask">ç”Ÿæˆå›¾ç‰‡</a-button>
  <a-button type="primary" @click="handleUpload">åº”ç”¨ç»“æœ</a-button>
</a-flex>
```

å®šä¹‰å˜é‡ï¼Œç”¨äºå­˜å‚¨å›¾ç‰‡ç»“æœï¼š

```typescript
const resultImageUrl = ref<string>()
```

3ï¼‰ç¼–å†™åˆ›å»ºä»»åŠ¡å‡½æ•°ï¼š

```typescript
// ä»»åŠ¡ id
let taskId = ref<string>()

/**
 * åˆ›å»ºä»»åŠ¡
 */
const createTask = async () => {
  if (!props.picture?.id) {
    return
  }
  const res = await createPictureOutPaintingTaskUsingPost({
    pictureId: props.picture.id,
    // å¯ä»¥æ ¹æ®éœ€è¦è®¾ç½®æ‰©å›¾å‚æ•°
    parameters: {
      xScale: 2,
      yScale: 2,
    },
  })
  if (res.data.code === 0 && res.data.data) {
    message.success('åˆ›å»ºä»»åŠ¡æˆåŠŸï¼Œè¯·è€å¿ƒç­‰å¾…ï¼Œä¸è¦é€€å‡ºç•Œé¢')
    console.log(res.data.data.output.taskId)
    taskId.value = res.data.data.output.taskId
    // å¼€å¯è½®è¯¢
    startPolling()
  } else {
    message.error('åˆ›å»ºä»»åŠ¡å¤±è´¥ï¼Œ' + res.data.message)
  }
}
```

ä»»åŠ¡åˆ›å»ºæˆåŠŸåï¼Œè¦å¼€å¯è½®è¯¢ã€‚

4ï¼‰ç¼–å†™è½®è¯¢é€»è¾‘ã€‚æ³¨æ„æ— è®ºä»»åŠ¡æ‰§è¡ŒæˆåŠŸæˆ–å¤±è´¥ã€è¿˜æ˜¯é€€å‡ºå½“å‰é¡µé¢æ—¶ï¼Œéƒ½éœ€è¦æ‰§è¡Œæ¸…ç†é€»è¾‘ï¼ŒåŒ…æ‹¬ï¼š

- æ¸…ç†å®šæ—¶å™¨
- å°†å®šæ—¶å™¨å˜é‡è®¾ç½®ä¸º null
- å°†ä»»åŠ¡ id è®¾ç½®ä¸º nullï¼Œè¿™æ ·å…è®¸å‰ç«¯å¤šæ¬¡æ‰§è¡Œä»»åŠ¡

ä»£ç å¦‚ä¸‹ï¼š

```typescript
// è½®è¯¢å®šæ—¶å™¨
let pollingTimer: NodeJS.Timeout = null

// æ¸…ç†è½®è¯¢å®šæ—¶å™¨
const clearPolling = () => {
  if (pollingTimer) {
    clearInterval(pollingTimer)
    pollingTimer = null
    taskId.value = null
  }
}

// å¼€å§‹è½®è¯¢
const startPolling = () => {
  if (!taskId.value) return

  pollingTimer = setInterval(async () => {
    try {
      const res = await getPictureOutPaintingTaskUsingGet({
        taskId: taskId.value,
      })
      if (res.data.code === 0 && res.data.data) {
        const taskResult = res.data.data.output
        if (taskResult.taskStatus === 'SUCCEEDED') {
          message.success('æ‰©å›¾ä»»åŠ¡æˆåŠŸ')
          resultImageUrl.value = taskResult.outputImageUrl
          clearPolling()
        } else if (taskResult.taskStatus === 'FAILED') {
          message.error('æ‰©å›¾ä»»åŠ¡å¤±è´¥')
          clearPolling()
        }
      }
    } catch (error) {
      console.error('è½®è¯¢ä»»åŠ¡çŠ¶æ€å¤±è´¥', error)
      message.error('æ£€æµ‹ä»»åŠ¡çŠ¶æ€å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•')
      clearPolling()
    }
  }, 3000) // æ¯éš” 3 ç§’è½®è¯¢ä¸€æ¬¡
}

// æ¸…ç†å®šæ—¶å™¨ï¼Œé¿å…å†…å­˜æ³„æ¼
onUnmounted(() => {
  clearPolling()
})
```

5ï¼‰å½“ä»»åŠ¡æ‰§è¡ŒæˆåŠŸåï¼Œå¯ä»¥å¾—åˆ°å›¾ç‰‡ç»“æœï¼Œæ­¤æ—¶å°±å¯ä»¥ç‚¹å‡» â€œåº”ç”¨ç»“æœâ€ æŒ‰é’®ï¼Œè°ƒç”¨å›¾ç‰‡ URL ä¸Šä¼ æ¥å£ã€‚è¿™æ®µä»£ç å¯ä»¥ç›´æ¥å¤åˆ¶å·²å¼€å‘çš„ URL å›¾ç‰‡ä¸Šä¼ ç»„ä»¶ï¼Œè¡¥å…… loading æ•ˆæœï¼š

```typescript
const uploadLoading = ref<boolean>(false)

const handleUpload = async () => {
  uploadLoading.value = true
  try {
    const params: API.PictureUploadRequest = {
      fileUrl: resultImageUrl.value,
      spaceId: props.spaceId,
    }
    if (props.picture) {
      params.id = props.picture.id
    }
    const res = await uploadPictureByUrlUsingPost(params)
    if (res.data.code === 0 && res.data.data) {
      message.success('å›¾ç‰‡ä¸Šä¼ æˆåŠŸ')
      // å°†ä¸Šä¼ æˆåŠŸçš„å›¾ç‰‡ä¿¡æ¯ä¼ é€’ç»™çˆ¶ç»„ä»¶
      props.onSuccess?.(res.data.data)
      // å…³é—­å¼¹çª—
      closeModal()
    } else {
      message.error('å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼Œ' + res.data.message)
    }
  } catch (error) {
    message.error('å›¾ç‰‡ä¸Šä¼ å¤±è´¥')
  } finally {
    uploadLoading.value = false
  }
}
```

6ï¼‰é€‚å½“å¯¹é¡µé¢åšä¸€äº›ä¼˜åŒ–ã€‚

ç»™ç”Ÿæˆå›¾ç‰‡æŒ‰é’®æ·»åŠ ä»»åŠ¡æ‰§è¡Œçš„ loading æ•ˆæœï¼Œæœ‰ä»»åŠ¡ id æ—¶ï¼Œç¦æ­¢æŒ‰é’®ç‚¹å‡»ï¼Œå¯ä»¥é˜²æ­¢é‡å¤æäº¤ä»»åŠ¡ã€‚æ‰©å›¾ç»“æŸåï¼Œä¼šæ¸…ç† taskIdï¼Œå°±å¯ä»¥å†æ¬¡æ‰§è¡Œã€‚

```vue
<a-button type="primary" :loading="!!taskId" ghost 
  @click="createTask">
  ç”Ÿæˆå›¾ç‰‡
</a-button>
```

2ï¼‰æ·»åŠ åº”ç”¨ç»“æœï¼ˆä¸Šä¼ å›¾ç‰‡æ—¶ï¼‰çš„ loading æ•ˆæœï¼š

```vue
<a-button type="primary" :loading="uploadLoading" 
  @click="handleUpload">
  åº”ç”¨ç»“æœ
</a-button>
```

3ï¼‰æœ‰å›¾ç‰‡ç»“æœæ—¶æ‰æ˜¾ç¤º â€œåº”ç”¨ç»“æœâ€ æŒ‰é’®ï¼š

```vue
<a-button type="primary" v-if="resultImageUrl" 
  :loading="uploadLoading" 
  @click="handleUpload">
  åº”ç”¨ç»“æœ
</a-button>
```

#### 2ã€åˆ›å»ºå›¾ç‰‡é¡µé¢å¼•å…¥å¼¹çª—

åœ¨åˆ›å»ºå›¾ç‰‡é¡µé¢ä½¿ç”¨ç»„ä»¶ï¼Œå¯ä»¥åœ¨ç¼–è¾‘å›¾ç‰‡æŒ‰é’®å³ä¾§å¢åŠ  â€œAI æ‰©å›¾â€ï¼Œç‚¹å‡»æŒ‰é’®åæ‰“å¼€å¼¹çª—ï¼š

```vue
<a-space size="middle">
  <a-button :icon="h(EditOutlined)" @click="doEditPicture">ç¼–è¾‘å›¾ç‰‡</a-button>
  <a-button type="primary" ghost :icon="h(FullscreenOutlined)" @click="doImagePainting">
    AI æ‰©å›¾
  </a-button>
</a-space>
<ImageOutPainting
  ref="imageOutPaintingRef"
  :picture="picture"
  :spaceId="spaceId"
  :onSuccess="onImageOutPaintingSuccess"
/>
```

ç¼–è¾‘ç‚¹å‡»æŒ‰é’®åè§¦å‘çš„å‡½æ•°ï¼Œæ‰“å¼€å¼¹çª—ï¼š

```typescript
// AI æ‰©å›¾å¼¹çª—å¼•ç”¨
const imageOutPaintingRef = ref()

// AI æ‰©å›¾
const doImagePainting = () => {
  if (imageOutPaintingRef.value) {
    imageOutPaintingRef.value.openModal()
  }
}

// ç¼–è¾‘æˆåŠŸäº‹ä»¶
const onImageOutPaintingSuccess = (newPicture: API.PictureVO) => {
  picture.value = newPicture
}
```

è¿è¡Œæ•ˆæœå¦‚å›¾ï¼Œæ„Ÿè§‰è¿˜æ˜¯ä¸é”™çš„å§~

![img](.\assets\eEoc7fSoNi21yVXa.webp)

### æ‰©å±•çŸ¥è¯† - å¼‚æ­¥ä»»åŠ¡ä¼˜åŒ–

å¼‚æ­¥ä»»åŠ¡ç®¡ç†å…¶å®ç®—æ˜¯ä¸€ç±»ç»å…¸ä¸šåŠ¡åœºæ™¯ï¼Œæœ‰è®¸å¤šé€šç”¨çš„ä¼˜åŒ–æ–¹æ³•å¯ä»¥æé«˜ç³»ç»Ÿæ•ˆç‡å’Œç”¨æˆ·ä½“éªŒã€‚

1ï¼‰ä»»åŠ¡é˜Ÿåˆ—å’Œä¼˜å…ˆçº§

ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—ç³»ç»Ÿï¼ˆæ¯”å¦‚ RabbitMQã€Kafkaï¼‰å¯¹å¼‚æ­¥ä»»åŠ¡è¿›è¡Œç®¡ç†ï¼Œå¯ä»¥æ ¹æ®ä¼˜å…ˆçº§çµæ´»è°ƒåº¦ä»»åŠ¡ã€‚é€šè¿‡é˜Ÿåˆ—è¿˜å¯ä»¥é™åˆ¶åŒæ—¶å¤„ç†çš„ä»»åŠ¡æ•°é‡ã€å‰Šå³°å¡«è°·ï¼Œé˜²æ­¢èµ„æºè¿‡è½½ï¼Œæé«˜ç³»ç»Ÿç¨³å®šæ€§ã€‚

2ï¼‰ä»»åŠ¡è®°å½•å’ŒçŠ¶æ€ç®¡ç†

ç°åœ¨ç”¨æˆ·æ˜¯æ— æ³•æ‰¾åˆ°å¾€æœŸæ‰§è¡Œçš„ä»»åŠ¡å’Œç”Ÿæˆçš„å›¾ç‰‡çš„ã€‚å¯ä»¥è®¾è®¡ä»»åŠ¡è®°å½•è¡¨ï¼Œå­˜å‚¨æ¯ä¸ªä»»åŠ¡çš„çŠ¶æ€ã€ç»“æœå’Œç›¸å…³ä¿¡æ¯ï¼Œå¹¶æä¾›æ¥å£ä¾›ç”¨æˆ·æŸ¥è¯¢å†å²ä»»åŠ¡ã€‚

å‰ç«¯å¯ä»¥ç»™ç”¨æˆ·æä¾›å¾€æœŸä»»åŠ¡æŸ¥è¯¢é¡µé¢ï¼Œèƒ½å¤ŸæŸ¥çœ‹ä»»åŠ¡ç»“æœã€é‡è¯•æŸä¸€æ¬¡ä»»åŠ¡ç­‰ã€‚è¿˜å¯ä»¥ç»™ç®¡ç†å‘˜æä¾›ç›‘æ§ç³»ç»Ÿæ‰€æœ‰ä»»åŠ¡çš„é¡µé¢ï¼Œæ¯”å¦‚ä»»åŠ¡æ•°ã€æˆåŠŸç‡å’Œå¤±è´¥ç‡ï¼Œå…¨é¢æŒæ¡ä»»åŠ¡æ‰§è¡Œæƒ…å†µã€‚

å®ç°èµ·æ¥å¹¶ä¸éš¾ï¼Œå…¶å®å°±æ˜¯å¯¹ä»»åŠ¡è®°å½•è¡¨çš„å¢åˆ æ”¹æŸ¥ã€‚

3ï¼‰ä»»åŠ¡é”™è¯¯ä¿¡æ¯ä¼˜åŒ–

å®Œå–„ä»»åŠ¡å¤±è´¥çš„å…·ä½“åŸå› ï¼Œå¸®åŠ©ç”¨æˆ·å¿«é€Ÿç†è§£å’Œè§£å†³é—®é¢˜ã€‚æ¯”å¦‚å‚æ•°é”™è¯¯ã€å›¾ç‰‡æ ¼å¼ä¸æ”¯æŒç­‰ã€‚å¦‚æœè°ƒç”¨äº†ç¬¬ä¸‰æ–¹æ¥å£ï¼Œéœ€è¦è®¤çœŸé˜…è¯»æ¥å£æ‰€æœ‰å¯èƒ½çš„é”™è¯¯æƒ…å†µã€‚

4ï¼‰è®¡è´¹ä¸é¢åº¦æ§åˆ¶

AI æ‰©å›¾ä¸€èˆ¬æ˜¯è®¡è´¹ä¸šåŠ¡ï¼Œéœ€è¦åšå¥½é¢åº¦æ§åˆ¶ï¼Œå¹¶ä¸”ä»…ç™»å½•ç”¨æˆ·æ‰å¯ä»¥ä½¿ç”¨ã€‚

åˆ†äº«å‡ ä¸ªå®ç°æ€è·¯ï¼š

1. åœ¨ç”¨æˆ·è¡¨ä¸­æ·»åŠ â€œæ‰©å›¾é¢åº¦â€ï¼ˆæ¯”å¦‚ä½¿ç”¨æ¬¡æ•°æˆ–ä½™é¢ï¼‰ï¼Œæ¯æ¬¡æäº¤ä»»åŠ¡å‰å…ˆæ£€æŸ¥é¢åº¦æ˜¯å¦è¶³å¤Ÿï¼Œé¢åº¦ä¸è¶³åˆ™æç¤ºç”¨æˆ·å……å€¼ã€‚
2. æ¯æ¬¡ä»»åŠ¡æäº¤æ—¶ï¼Œå¯é‡‡ç”¨é¢„æ‰£è´¹é€»è¾‘ï¼Œä»»åŠ¡å®Œæˆæ‰£è´¹ï¼Œä»»åŠ¡å¤±è´¥åˆ™è‡ªåŠ¨é€€è¿˜é¢åº¦ã€‚
3. æä¾›æŸ¥è¯¢ç”¨æˆ·å½“å‰å‰©ä½™é¢åº¦çš„æ¥å£ï¼Œç”¨æˆ·å¯ä»¥åœ¨å‰ç«¯çœ‹åˆ°è‡ªå·±å‰©ä½™çš„é¢åº¦ã€‚
4. æ”¯æŒå……å€¼é¢åº¦æˆ–ä¼šå‘˜è®¢é˜…åˆ¶æ”¶è´¹ï¼Œè¿˜å¯ä»¥æ ¹æ®æ‰©å›¾æ¨¡å¼æŒ‰æ¯”ä¾‹æ‰£è´¹ã€‚æ¯”å¦‚æ™®é€šæ¨¡å¼æ‰£ 1 ç‚¹ï¼Œé«˜æ¸…æ¨¡å¼æ‰£ 2 ç‚¹ã€‚

ğŸ’¡ ä¸€èˆ¬å¯¹äºåä»˜è´¹èµ„æºï¼ˆéšç”¨éšä»˜è´¹ï¼‰ï¼Œå³ä½¿ä½™é¢ < 0ï¼Œå°é¢æ¬ è´¹ä¹Ÿæ˜¯å¯ä»¥æ¥å—çš„ã€‚å°¤å…¶æ˜¯å¯¹äºå¤§å‚äº‘æœåŠ¡æ¥è¯´ï¼Œç”±äºè°ƒç”¨é‡å·¨å¤§ï¼Œå¾ˆéš¾åšåˆ°å®æ—¶è®¡è´¹ã€‚

5ï¼‰å®‰å…¨æ€§ä¸ç¨³å®šæ€§

ç”±äºä»»åŠ¡è¦æ¶ˆè€—ç³»ç»Ÿèµ„æºæˆ–æˆæœ¬ï¼Œæ‰€ä»¥ä¸€å®šè¦è®¾ç½®åˆç†çš„é™æµè§„åˆ™ï¼Œé˜²æ­¢æ¶æ„åˆ·ä»»åŠ¡ã€‚æ¯”å¦‚é™åˆ¶å•ç”¨æˆ·çš„ä»»åŠ¡æäº¤é¢‘ç‡ï¼Œæ¯åˆ†é’Ÿæœ€å¤šå…è®¸æäº¤ 3 æ¬¡ä»»åŠ¡ï¼Œè¶…è¿‡é™åˆ¶åè¿”å›æç¤ºä¿¡æ¯ã€‚

å¯¹äºé•¿è€—æ—¶ä»»åŠ¡ï¼Œè¿˜è¦è®¾ç½®ä»»åŠ¡çš„æœ€å¤§æ‰§è¡Œæ—¶é—´ï¼ˆæ¯”å¦‚ 10 åˆ†é’Ÿï¼‰ï¼Œè¶…æ—¶åˆ™è‡ªåŠ¨æ ‡è®°ä»»åŠ¡å¤±è´¥ã€‚

é±¼çš®ç¼–ç¨‹å¯¼èˆªçš„ [æ™ºèƒ½ BI é¡¹ç›®](https://www.codefather.cn/course/1790980531403927553) å’Œ [é¢è¯•é¸­åˆ·é¢˜å¹³å°é¡¹ç›®](https://www.codefather.cn/course/1826803928691945473) ä¸­éƒ½æœ‰è®²è§£åˆ†å¸ƒå¼é™æµç›¸å…³çš„çŸ¥è¯†ï¼Œå¯ä»¥æŒ‰éœ€å­¦ä¹ ã€‚

æ­¤å¤–ï¼Œå¯ä»¥åœ¨ä»»åŠ¡æ‰§è¡Œå‰å¢åŠ åŸºç¡€çš„æ ¡éªŒï¼Œåªå¯¹ç¬¦åˆè¦æ±‚çš„å›¾ç‰‡åˆ›å»ºä»»åŠ¡ï¼Œæ¯”å¦‚å›¾ç‰‡ä¸èƒ½è¿‡å¤§æˆ–è¿‡å°ï¼š

![img](.\assets\FeyVtS5agGJTmKeo.webp)

### æ‰©å±•

1ã€å°è¯•æ›´å¤š AI å›¾ç‰‡å¤„ç†èƒ½åŠ›ï¼Œæ¯”å¦‚ [å‚è€ƒæ–‡æ¡£å®ç°å›¾é…æ–‡](https://help.aliyun.com/zh/model-studio/developer-reference/image-text-composition-api-reference)

2ã€å¦‚æœ AI ç»˜ç”» API æ”¯æŒè¿”å›å½“å‰è¿›åº¦ï¼ˆæ¯”å¦‚ MidJourney çš„ APIï¼‰ï¼Œå¯ä»¥é€šè¿‡ SSE çš„æ–¹å¼å°†è¿›åº¦è¿”å›ç»™å‰ç«¯ï¼Œé±¼çš®ç¼–ç¨‹å¯¼èˆªçš„ [AI ç­”é¢˜åº”ç”¨å¹³å°é¡¹ç›®](https://www.codefather.cn/course/1790274408835506178) ä¸­æœ‰å…³äº SSE çš„å®æˆ˜ã€‚

3ã€ä¼˜åŒ– AI æ‰©å›¾å‚æ•°ã€‚å¯ä»¥ [å‚è€ƒå®˜æ–¹æ–‡æ¡£](https://help.aliyun.com/zh/model-studio/developer-reference/image-scaling-api)ï¼Œè¡¥å……æ›´å¤šæ‰©å›¾å‚æ•°ï¼Œå¹¶å…è®¸ç”¨æˆ·è‡ªä¸»é€‰æ‹©æ‰©å›¾å‚æ•°ï¼š

![img](.\assets\ygEsq3ZOmlw2lBfa.webp)









# 10 - å›¾åº“åˆ†æ

## æœ¬èŠ‚é‡ç‚¹

ä¸ºè¿›ä¸€æ­¥æå‡ç”¨æˆ· / ç®¡ç†å‘˜åœ¨å¹³å°ä¸Šå¯¹ç©ºé—´å›¾åº“çš„ç®¡ç†ä¸åˆ†æèƒ½åŠ›ï¼Œæˆ‘ä»¬æœ¬èŠ‚å°†é‡ç‚¹æ‰©å±•ç©ºé—´å›¾åº“åˆ†æåŠŸèƒ½ï¼ŒåŒ…æ‹¬ï¼š

- ç”¨æˆ·ç©ºé—´å›¾åº“åˆ†æ
- ç®¡ç†å‘˜å…¨ç©ºé—´åˆ†æ

é€šè¿‡è¿™äº›åˆ†æåŠŸèƒ½ï¼Œç”¨æˆ·å’Œç®¡ç†å‘˜èƒ½å¤Ÿå¿«é€ŸæŒæ¡ç©ºé—´çš„ä½¿ç”¨æƒ…å†µï¼Œæå‡ç®¡ç†æ•ˆç‡ã€‚

## ä¸€ã€éœ€æ±‚åˆ†æ

æ ¹æ®æˆ‘ä»¬ç©ºé—´è¡¨å’Œå›¾ç‰‡è¡¨çš„å·²æœ‰å­—æ®µï¼Œå¯ä»¥æŒ–æ˜å‡ºå¾ˆå¤šåˆ†æéœ€æ±‚ï¼Œæ•´ä½“åˆ†ä¸ºç”¨æˆ·ç©ºé—´å›¾åº“åˆ†æå’Œç®¡ç†å‘˜å…¨ç©ºé—´åˆ†æä¸¤ç±»ã€‚

### ç”¨æˆ·ç©ºé—´å›¾åº“åˆ†æ

ç”¨æˆ·å¯ä»¥å¯¹è‡ªå·±çš„ç©ºé—´å›¾åº“è¿›è¡Œåˆ†æï¼ŒåŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªé‡ç‚¹åŠŸèƒ½ï¼š

1ï¼‰ç©ºé—´èµ„æºä½¿ç”¨åˆ†æï¼šé€šè¿‡ç»Ÿè®¡å½“å‰ç©ºé—´å·²ä½¿ç”¨å¤§å°ä¸æ€»é…é¢çš„æ¯”ä¾‹ï¼Œä»¥åŠå›¾ç‰‡æ•°é‡ä¸æœ€å¤§å…è®¸æ•°é‡çš„å æ¯”ï¼Œå¸®åŠ©ç”¨æˆ·ç›´è§‚äº†è§£ç©ºé—´ä½¿ç”¨çŠ¶æ€ï¼ŒåŠæ—¶æ¸…ç†æˆ–å‡çº§ç©ºé—´ã€‚å›¾è¡¨å½¢å¼æ¨èä½¿ç”¨ **ä»ªè¡¨ç›˜**ï¼Œç±»ä¼¼è¿›åº¦æ¡ï¼Œå¯ä»¥æ›´ç›´è§‚åœ°äº†è§£æ¯”ä¾‹ã€‚

2ï¼‰ç©ºé—´å›¾ç‰‡åˆ†ç±»åˆ†æï¼šç»Ÿè®¡ä¸åŒåˆ†ç±»ä¸‹å›¾ç‰‡çš„æ•°é‡å’Œæ€»å¤§å°å æ¯”ï¼Œå¸®åŠ©ç”¨æˆ·æ¸…æ™°äº†è§£å„åˆ†ç±»çš„èµ„æºåˆ†å¸ƒï¼Œä¼˜åŒ–å­˜å‚¨ç­–ç•¥ã€‚ç”±äºåŒä¸€ä¸ªåˆ†ç±»è¦å±•ç¤ºå¤šä¸ªä¿¡æ¯ï¼Œå¯ä»¥é€‰æ‹© **åˆ†ç»„æ¡å½¢å›¾** æ¥å±•ç¤ºã€‚

3ï¼‰ç©ºé—´å›¾ç‰‡æ ‡ç­¾åˆ†æï¼šè§£æç”¨æˆ·å›¾åº“ä¸­çš„æ ‡ç­¾ï¼Œç»Ÿè®¡æ¯ä¸ªæ ‡ç­¾çš„å…³è”å›¾ç‰‡æ•°é‡ã€‚ç”±äºæ ‡ç­¾æ¯”è¾ƒå¤šï¼Œå¯ä»¥ç”¨ **è¯äº‘å›¾** å±•ç¤ºæ‰€æœ‰çš„æ ‡ç­¾ï¼Œå¹¶çªå‡ºå¸¸ç”¨æ ‡ç­¾ï¼Œä¾¿äºä¼˜åŒ–ç®¡ç†å’Œå›¾ç‰‡æœç´¢ã€‚

4ï¼‰ç©ºé—´å›¾ç‰‡å¤§å°åˆ†æï¼šæŒ‰å›¾ç‰‡å¤§å°ï¼ˆå¦‚ <100 KBã€100 KB-1 MBã€>1 MBï¼‰åˆ†æ®µç»Ÿè®¡å›¾ç‰‡æ•°é‡ï¼Œå¸®åŠ©ç”¨æˆ·è¯†åˆ«å¤§ä½“ç§¯å›¾ç‰‡ï¼Œåˆç†åˆ†é…å­˜å‚¨èµ„æºã€‚ç”±äºæŒ‰å›¾ç‰‡å¤§å°åˆ†ç±»çš„æ•°é‡ä¸å¤šï¼Œå¯ä»¥ä½¿ç”¨ **é¥¼å›¾** å±•ç¤ºï¼Œèƒ½å¤Ÿä½“ç°æ¯ç±»å¤§å°å›¾ç‰‡çš„æ•°é‡å æ¯”ã€‚

5ï¼‰ç”¨æˆ·ä¸Šä¼ è¡Œä¸ºåˆ†æï¼šç»Ÿè®¡ç”¨æˆ·æ¯æœˆã€æ¯å‘¨ã€æ¯æ—¥ä¸Šä¼ å›¾ç‰‡çš„æ•°é‡è¶‹åŠ¿ï¼Œå¸®åŠ©ç”¨æˆ·è¯†åˆ«ä¸Šä¼ é«˜å³°æœŸå¹¶ä¼˜åŒ–ç®¡ç†ç­–ç•¥ï¼ˆè™½ç„¶å¯¹ç›®å‰è¿™ä¸ªé˜¶æ®µæ²¡æœ‰ç”¨ï¼Œä½†ä¹‹åæˆ‘ä»¬è¦å¼€å‘å›¢é˜Ÿç©ºé—´ï¼Œå¯ä»¥ç»™å›¢é˜Ÿç®¡ç†å‘˜ä½¿ç”¨ï¼‰ã€‚æ¨èä½¿ç”¨ **æŠ˜çº¿å›¾** å‘ˆç°æ—¶é—´åºåˆ—è¶‹åŠ¿ã€‚

### ç®¡ç†å‘˜å…¨ç©ºé—´åˆ†æ

ç®¡ç†å‘˜å…¨ç©ºé—´åˆ†æçš„æ ¸å¿ƒæ˜¯é¢å‘å…¬å…±å›¾åº“ã€ä»¥åŠæ‰€æœ‰ç”¨æˆ·ç©ºé—´çš„ç»Ÿè®¡å’Œç®¡ç†ï¼š

1ï¼‰å…¨ç©ºé—´èµ„æºä½¿ç”¨åˆ†æï¼šç»Ÿè®¡å…¬å…±å›¾åº“ã€ä»¥åŠç³»ç»Ÿå†…æ‰€æœ‰ç©ºé—´çš„æ€»å­˜å‚¨é‡å’Œæ€»å›¾ç‰‡æ•°ï¼Œå¹¶ä¸”ä¹Ÿæ”¯æŒä»»æ„ç©ºé—´çš„å›¾ç‰‡åˆ†ç±»ã€å›¾ç‰‡æ ‡ç­¾ã€å›¾ç‰‡å¤§å°ã€ç”¨æˆ·ä¸Šä¼ è¡Œä¸ºçš„åˆ†æï¼Œä¾¿äºç®¡ç†å‘˜äº†è§£ç³»ç»Ÿèµ„æºåˆ†é…å’Œåˆ©ç”¨æƒ…å†µã€‚

**å…¶å®è·Ÿç”¨æˆ·åˆ†æè‡ªå·±ç©ºé—´çš„éœ€æ±‚ä¸€è‡´ï¼Œåªä¸è¿‡åˆ†æçš„èŒƒå›´æ›´å¤§ç½¢äº†ã€‚**

2ï¼‰ç©ºé—´ä½¿ç”¨æ’è¡Œåˆ†æï¼šæŒ‰å­˜å‚¨ä½¿ç”¨é‡æ’åºï¼Œç»Ÿè®¡å ç”¨å­˜å‚¨æœ€å¤šçš„å‰ N ä¸ªç©ºé—´ï¼Œå¸®åŠ©ç®¡ç†å‘˜å¿«é€Ÿå®šä½é«˜å ç”¨ç©ºé—´ï¼Œå¹¶è¯†åˆ«æ½œåœ¨çš„èµ„æºæ»¥ç”¨æˆ–å¼‚å¸¸æƒ…å†µã€‚å¯ä»¥é€‰ç”¨ **æŸ±çŠ¶å›¾**ï¼Œç›´è§‚åœ°å±•ç¤ºæ’åå’Œå­˜å‚¨ä½¿ç”¨é‡ã€‚

## äºŒã€æ–¹æ¡ˆè®¾è®¡

### 1ã€åˆ†æç±»éœ€æ±‚çš„å®ç°æµç¨‹

å¯¹äºåˆ†æç±»éœ€æ±‚ï¼Œå®ç°æµç¨‹å‡ ä¹éƒ½æ˜¯ä¸€è‡´çš„ï¼ŒåŒ…æ‹¬ï¼š

1ï¼‰æ•°æ®é‡‡é›†ï¼šä»æ•°æ®æºï¼ˆæ¯”å¦‚ MySQL æ•°æ®åº“æˆ–è€…å¤§æ•°æ®ä»“åº“ï¼‰è·å–åŸå§‹æ•°æ®ã€‚è¦æå‰æ˜ç¡®æ¶‰åŠçš„è¡¨å’Œå­—æ®µï¼Œå¿…è¦æ—¶é‡‡ç”¨åˆ†é¡µæŸ¥è¯¢å¤„ç†å¤§æ•°æ®é‡ã€‚

2ï¼‰æ•°æ®é¢„å¤„ç†ï¼šå¯¹æ•°æ®è¿›è¡Œæ¸…æ´—ã€åŠ å·¥å’Œæ ¼å¼åŒ–ï¼ŒåŒ…æ‹¬è¿‡æ»¤æ— æ•ˆæ•°æ®ï¼ˆæ¯”å¦‚é€»è¾‘åˆ é™¤æˆ–å®¡æ ¸æœªé€šè¿‡ï¼‰ã€è§£æå¤æ‚å­—æ®µï¼ˆæ¯”å¦‚ JSON æ ¼å¼çš„ tagsï¼‰ï¼Œä»¥åŠé€šè¿‡å­—æ®µå…³è”è¡¥å……ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚

3ï¼‰æ•°æ®è®¡ç®—ï¼šæ ¹æ®éœ€æ±‚è¿›è¡Œåˆ†ç»„ã€èšåˆã€æ’åºç­‰ï¼Œä»è€Œè®¡ç®—å…³é”®æŒ‡æ ‡ï¼Œæ¯”å¦‚è®¡ç®—ç©ºé—´å„åˆ†ç±»å›¾ç‰‡çš„å ç”¨æ¯”ä¾‹ã€ç”¨æˆ·ä¸Šä¼ å›¾ç‰‡çš„æ—¶é—´è¶‹åŠ¿ã€‚å¯ä»¥æ ¹æ®åœºæ™¯è°ƒæ•´è®¡ç®—æ–¹æ¡ˆï¼Œæ¯”å¦‚å¯¹äºå¤§æ•°æ®é‡çš„è®¡ç®—ï¼Œå¯ä»¥é‡‡ç”¨ Spark ä¹‹ç±»çš„å¤§æ•°æ®è®¡ç®—ç»„ä»¶åšç¦»çº¿è®¡ç®—ï¼›å¯¹äºæ•°æ®å®æ—¶æ€§è¦æ±‚è¾ƒé«˜çš„å®æ—¶åˆ†æåœºæ™¯ï¼Œå¯ä»¥ç”¨ Flink åšæµå¼å¤„ç†ã€‚

4ï¼‰æ•°æ®å­˜å‚¨ï¼ˆå¯é€‰ï¼‰ï¼šé’ˆå¯¹é¢‘ç¹æŸ¥è¯¢çš„åˆ†æç»“æœï¼Œå¯å°†ç»“æœæ•°æ®å­˜å‚¨ä¸ºå•ç‹¬çš„è¡¨æˆ–ç¼“å­˜ï¼Œå‡å°‘é‡å¤è®¡ç®—ï¼Œæé«˜æŸ¥è¯¢æ•ˆç‡ã€‚

5ï¼‰æ•°æ®æ¥å£è®¾è®¡ï¼šä¸ºå‰ç«¯æä¾›ç»Ÿä¸€æ¥å£ï¼Œä»è€Œæ”¯æŒæŸ¥è¯¢å’Œå±•ç¤ºã€‚éœ€è¦è€ƒè™‘åˆ°æ•°æ®é‡è¾ƒå¤§å¯¼è‡´å‰ç«¯æ¸²æŸ“å¡é¡¿çš„æƒ…å†µï¼Œå¯ä»¥æŒ‰éœ€ç²¾ç®€è¿”å›çš„å­—ç¬¦ä¸²ã€åˆ†é¡µæŸ¥è¯¢ç­‰ã€‚

6ï¼‰æ•°æ®å¯è§†åŒ–ï¼šé€šè¿‡å›¾è¡¨ç›´è§‚å±•ç¤ºåˆ†æç»“æœï¼Œå‰ç«¯å¯ä»¥ä½¿ç”¨ [Apache ECharts](https://echarts.apache.org/) ç­‰å¯è§†åŒ–åº“æ¸²æŸ“ã€‚å½“ç„¶ä¹Ÿå¯ä»¥è®©åç«¯ç”Ÿæˆå›¾è¡¨å›¾ç‰‡å¹¶è¿”å›ï¼Œä½†è¿™ç§å®ç°æ–¹æ³•çš„çµæ´»åº¦æœ‰é™ã€‚

åç»­è¿˜å¯ä»¥æ ¹æ®ç”¨æˆ·çš„åé¦ˆæŒç»­ä¼˜åŒ–åˆ†æé€»è¾‘ã€å¢åŠ æŒ‡æ ‡æˆ–æ”¹è¿›æ€§èƒ½ã€‚

### 2ã€æœ¬é¡¹ç›®å®ç°æ–¹æ¡ˆ

é€šè¿‡éœ€æ±‚åˆ†æï¼Œæˆ‘ä»¬å‘ç°ï¼Œç®¡ç†å‘˜å¯¹å…¬å…±å›¾åº“åŠå…¨ç©ºé—´çš„åˆ†æéœ€æ±‚ï¼Œä¸ç”¨æˆ·å¯¹è‡ªå·±ç©ºé—´çš„åˆ†æéœ€æ±‚åœ¨æœ¬è´¨ä¸Šæ˜¯ç›¸åŒçš„ï¼Œ**å”¯ä¸€çš„åŒºåˆ«åœ¨äºå›¾ç‰‡èŒƒå›´çš„é€‰æ‹©**ã€‚

ä¸‹é¢ä»¥ â€œç©ºé—´å›¾ç‰‡åˆ†ç±»åˆ†æâ€ ä¸ºä¾‹ã€‚

1ï¼‰ç”¨æˆ·åˆ†æè‡ªå·±çš„ç©ºé—´ï¼ŒSQL ç¤ºä¾‹ï¼š

```sql
SELECT category, SUM(picSize) AS totalSize
FROM picture 
WHERE spaceId = xxx
GROUP BY category;
```

2ï¼‰ç®¡ç†å‘˜åˆ†æå…¬å…±å›¾åº“ï¼ŒSQL ç¤ºä¾‹ï¼š

```sql
SELECT category, SUM(picSize) AS totalSize
FROM picture 
WHERE spaceId IS NULL
GROUP BY category;
```

3ï¼‰ç®¡ç†å‘˜åˆ†æå…¨éƒ¨ç©ºé—´ï¼ŒSQL ç¤ºä¾‹ï¼š

```sql
SELECT category, SUM(picSize) AS totalSize
FROM picture 
GROUP BY category;
```

ä½ ä¼šå‘ç°ï¼Œé™¤äº† where æŸ¥è¯¢æ¡ä»¶ä¸åŒä¹‹å¤–ï¼Œå…¶ä»–çš„è®¡ç®—æ–¹å¼éƒ½æ˜¯ä¸€è‡´çš„ã€‚

æ‰€ä»¥æˆ‘ä»¬å¯ä»¥è®¾è®¡ç»Ÿä¸€çš„æ¥å£ï¼Œé€šè¿‡ä¼ é€’ä¸åŒçš„è¯·æ±‚å‚æ•°ï¼ŒåŒæ—¶æ»¡è¶³ä¸Šè¿°éœ€æ±‚ã€‚å‚æ•°å«ä¹‰å’Œä¼˜å…ˆçº§å¦‚ä¸‹ï¼ˆä¼˜å…ˆçº§ä»é«˜åˆ°ä½ï¼‰ï¼š

1. queryAll å­—æ®µï¼šä¸º true æ—¶è¡¨ç¤ºæŸ¥è¯¢å…¨ç©ºé—´ï¼Œä»…ç®¡ç†å‘˜å¯ä½¿ç”¨ã€‚
2. queryPublic å­—æ®µï¼šä¸º true æ—¶è¡¨ç¤ºæŸ¥è¯¢å…¬å…±å›¾åº“ï¼Œä»…ç®¡ç†å‘˜å¯ä½¿ç”¨ã€‚
3. spaceId å­—æ®µï¼šä»…åœ¨ queryAll å’Œ queryPublic å‡ä¸º false æ—¶ç”Ÿæ•ˆï¼Œè¡¨ç¤ºå¯¹ç‰¹å®šç©ºé—´è¿›è¡Œåˆ†æï¼Œä»…ç©ºé—´åˆ›å»ºè€…å’Œç®¡ç†å‘˜å¯ä½¿ç”¨ã€‚

å¯¹åº”çš„åç«¯ä¼ªä»£ç å¦‚ä¸‹ï¼Œå¯ä»¥å°†è¿™æ®µé€»è¾‘å°è£…ä¸ºå•ç‹¬çš„æ–¹æ³•ï¼š

```java
// å…ˆæƒé™æ ¡éªŒ
// å°è£…æŸ¥è¯¢æ¡ä»¶
QueryWrapper<Picture> queryWrapper = new QueryWrapper<>();
if (queryAll) {
    // ç®¡ç†å‘˜æŸ¥è¯¢å…¨ç©ºé—´ï¼Œä¸æ·»åŠ è¿‡æ»¤æ¡ä»¶
} else if (queryPublic) {
    // ç®¡ç†å‘˜æŸ¥è¯¢å…¬å…±å›¾åº“
    queryWrapper.isNull("spaceId");
} else if (spaceId != null) {
    // ç”¨æˆ·æˆ–ç®¡ç†å‘˜æŸ¥è¯¢ç‰¹å®šç©ºé—´
    queryWrapper.eq("spaceId", spaceId);
} else {
    throw new BusinessException(ErrorCode.PARAMS_ERROR, "æœªæŒ‡å®šæŸ¥è¯¢èŒƒå›´");
}
```

é€šè¿‡è¿™ç§æ–¹å¼ï¼Œå°±ä¸ç”¨å¤šé’ˆå¯¹ä¸åŒçš„æŸ¥è¯¢èŒƒå›´ç¼–å†™ä¸€å¥—æ¥å£äº†ï¼Œå¯ä»¥å¤§å¹…å‡å°‘é‡å¤ä»£ç ã€‚

## ä¸‰ã€åç«¯å¼€å‘

ä¸‹é¢æˆ‘ä»¬ä¾æ¬¡å¼€å‘æ¯ä¸ªå…·ä½“çš„åˆ†æéœ€æ±‚ï¼Œç”±äºåˆ†æç±»éœ€æ±‚è¾ƒå¤šï¼Œæˆ‘ä»¬å¯ä»¥ç¼–å†™å•ç‹¬çš„ç©ºé—´åˆ†ææœåŠ¡ç±»ï¼ˆServiceï¼‰ã€å•ç‹¬çš„ç©ºé—´åˆ†ææ¥å£ï¼ˆController)ï¼Œå¹¶ä¸”ç»Ÿä¸€å°†åˆ†æéœ€æ±‚ç›¸å…³çš„ DTO å’Œ VO æ•°æ®æ¨¡å‹æ”¾åˆ° `analyze` åŒ…ä¸‹ï¼Œå¦‚å›¾ï¼š

![img](assets/UjUFPXQT1GZxsNzJ.webp)

### é€šç”¨åˆ†æè¯·æ±‚

1ï¼‰ç”±äºæˆ‘ä»¬çš„å¾ˆå¤šåˆ†æéœ€æ±‚éƒ½éœ€è¦ä¼ é€’ç©ºé—´æŸ¥è¯¢èŒƒå›´ï¼Œå¯ä»¥å…ˆå†™ä¸€ä¸ªå…¬å…±çš„å›¾ç‰‡åˆ†æè¯·æ±‚å°è£…ç±»ï¼š

```java
@Data
public class SpaceAnalyzeRequest implements Serializable {

    /**
     * ç©ºé—´ ID
     */
    private Long spaceId;

    /**
     * æ˜¯å¦æŸ¥è¯¢å…¬å…±å›¾åº“
     */
    private boolean queryPublic;

    /**
     * å…¨ç©ºé—´åˆ†æ
     */
    private boolean queryAll;

    private static final long serialVersionUID = 1L;
}
```

ç„¶åå„ä¸ªå…·ä½“çš„åˆ†æè¯·æ±‚å°è£…ç±»å°±èƒ½ç›´æ¥ç»§æ‰¿äº†ï¼Œè¿™æ ·ä¹Ÿä¾¿äºåç»­ç¼–å†™é€šç”¨çš„åˆ†æè¯·æ±‚å¤„ç†æ–¹æ³•ã€‚

2ï¼‰æˆ‘ä»¬å¯ä»¥æ–°å»º SpaceAnalyzeService å’Œå¯¹åº”å®ç°ç±»ï¼Œå¼€å‘æ ¡éªŒç©ºé—´åˆ†ææƒé™ã€æ ¹æ®åˆ†æèŒƒå›´å¡«å……æŸ¥è¯¢å¯¹è±¡è¿™ä¸¤ä¸ªæ–¹æ³•ï¼Œåç»­çš„éœ€æ±‚ä¹Ÿéƒ½ä¼šç”¨åˆ°ã€‚

æ ¡éªŒç©ºé—´åˆ†ææƒé™ï¼š

```java
private void checkSpaceAnalyzeAuth(SpaceAnalyzeRequest spaceAnalyzeRequest, User loginUser) {
    // æ£€æŸ¥æƒé™
    if (spaceAnalyzeRequest.isQueryAll() || spaceAnalyzeRequest.isQueryPublic()) {
        // å…¨ç©ºé—´åˆ†ææˆ–è€…å…¬å…±å›¾åº“æƒé™æ ¡éªŒï¼šä»…ç®¡ç†å‘˜å¯è®¿é—®
        ThrowUtils.throwIf(!userService.isAdmin(loginUser), ErrorCode.NO_AUTH_ERROR, "æ— æƒè®¿é—®å…¬å…±å›¾åº“");
    } else {
        // ç§æœ‰ç©ºé—´æƒé™æ ¡éªŒ
        Long spaceId = spaceAnalyzeRequest.getSpaceId();
        ThrowUtils.throwIf(spaceId == null || spaceId <= 0, ErrorCode.PARAMS_ERROR);
        Space space = spaceService.getById(spaceId);
        ThrowUtils.throwIf(space == null, ErrorCode.NOT_FOUND_ERROR, "ç©ºé—´ä¸å­˜åœ¨");
        spaceService.checkSpaceAuth(loginUser, space);
    }
}
```

æ ¹æ®åˆ†æèŒƒå›´å¡«å……æŸ¥è¯¢å¯¹è±¡ï¼š

```java
private static void fillAnalyzeQueryWrapper(SpaceAnalyzeRequest spaceAnalyzeRequest, QueryWrapper<Picture> queryWrapper) {
    if (spaceAnalyzeRequest.isQueryAll()) {
        return;
    }
    if (spaceAnalyzeRequest.isQueryPublic()) {
        queryWrapper.isNull("spaceId");
        return;
    }
    Long spaceId = spaceAnalyzeRequest.getSpaceId();
    if (spaceId != null) {
        queryWrapper.eq("spaceId", spaceId);
        return;
    }
    throw new BusinessException(ErrorCode.PARAMS_ERROR, "æœªæŒ‡å®šæŸ¥è¯¢èŒƒå›´");
}
```

### éœ€æ±‚å¼€å‘

#### 1ã€ç©ºé—´èµ„æºä½¿ç”¨åˆ†æ

1ï¼‰å¼€å‘è¯·æ±‚å°è£…ç±»ï¼Œç”¨äºæ¥æ”¶å‰ç«¯è¯·æ±‚çš„æ•°æ®ã€‚æ­¤å¤„ç›´æ¥ç»§æ‰¿é€šç”¨çš„å›¾ç‰‡åˆ†æè¯·æ±‚å°è£…ç±»å³å¯ï¼Œä¸éœ€è¦ä¼ é€’å…¶ä»–å­—æ®µï¼š

```java
@EqualsAndHashCode(callSuper = true)
@Data
public class SpaceUsageAnalyzeRequest extends SpaceAnalyzeRequest {

}
```

2ï¼‰å¼€å‘å“åº”è§†å›¾ç±»ï¼Œç”¨äºå°†åˆ†æç»“æœè¿”å›ç»™å‰ç«¯ï¼š

```java
@Data
public class SpaceUsageAnalyzeResponse implements Serializable {

    /**
     * å·²ä½¿ç”¨å¤§å°
     */
    private Long usedSize;

    /**
     * æ€»å¤§å°
     */
    private Long maxSize;

    /**
     * ç©ºé—´ä½¿ç”¨æ¯”ä¾‹
     */
    private Double sizeUsageRatio;

    /**
     * å½“å‰å›¾ç‰‡æ•°é‡
     */
    private Long usedCount;

    /**
     * æœ€å¤§å›¾ç‰‡æ•°é‡
     */
    private Long maxCount;

    /**
     * å›¾ç‰‡æ•°é‡å æ¯”
     */
    private Double countUsageRatio;

    private static final long serialVersionUID = 1L;
}
```

3ï¼‰å¼€å‘ SpaceAnalyzeService ä¸šåŠ¡é€»è¾‘å±‚ï¼Œç¼–å†™åˆ†æä¸šåŠ¡çš„å®ç°é€»è¾‘ã€‚

æ³¨æ„ï¼Œå¦‚æœæ˜¯åˆ†æå…¨ç©ºé—´æˆ–å…¬å…±å›¾åº“çš„ä½¿ç”¨æƒ…å†µï¼Œéœ€è¦ç¼–å†™ â€œä»…ç®¡ç†å‘˜å¯è®¿é—®â€ çš„æƒé™æ ¡éªŒé€»è¾‘ï¼Œå¹¶ä¸”æ›´æ”¹æŸ¥è¯¢å›¾ç‰‡è¡¨çš„èŒƒå›´ï¼›å¦‚æœåªæ˜¯åˆ†æå•ä¸ªç©ºé—´çš„ä½¿ç”¨æƒ…å†µï¼Œç›´æ¥ä»ç©ºé—´è¡¨æŸ¥è¯¢å‡ºå•ä¸ªç©ºé—´çš„æ•°æ®å³å¯ã€‚

ä»£ç å¦‚ä¸‹ï¼š

```java
/**
 * è·å–ç©ºé—´ä½¿ç”¨åˆ†ææ•°æ®
 *
 * @param spaceUsageAnalyzeRequest SpaceUsageAnalyzeRequest è¯·æ±‚å‚æ•°
 * @param loginUser                å½“å‰ç™»å½•ç”¨æˆ·
 * @return SpaceUsageAnalyzeResponse åˆ†æç»“æœ
 */
@Override
public SpaceUsageAnalyzeResponse getSpaceUsageAnalyze(SpaceUsageAnalyzeRequest spaceUsageAnalyzeRequest, User loginUser) {
    ThrowUtils.throwIf(spaceUsageAnalyzeRequest == null, ErrorCode.PARAMS_ERROR);
    if (spaceUsageAnalyzeRequest.isQueryAll() || spaceUsageAnalyzeRequest.isQueryPublic()) {
        // æŸ¥è¯¢å…¨éƒ¨æˆ–å…¬å…±å›¾åº“é€»è¾‘
        // ä»…ç®¡ç†å‘˜å¯ä»¥è®¿é—®
        boolean isAdmin = userService.isAdmin(loginUser);
        ThrowUtils.throwIf(!isAdmin, ErrorCode.NO_AUTH_ERROR, "æ— æƒè®¿é—®ç©ºé—´");
        // ç»Ÿè®¡å…¬å…±å›¾åº“çš„èµ„æºä½¿ç”¨
        QueryWrapper<Picture> queryWrapper = new QueryWrapper<>();
        queryWrapper.select("picSize");
        if (!spaceUsageAnalyzeRequest.isQueryAll()) {
            queryWrapper.isNull("spaceId");
        }
        List<Object> pictureObjList = pictureService.getBaseMapper().selectObjs(queryWrapper);
        long usedSize = pictureObjList.stream().mapToLong(result -> result instanceof Long ? (Long) result : 0).sum();
        long usedCount = pictureObjList.size();
        // å°è£…è¿”å›ç»“æœ
        SpaceUsageAnalyzeResponse spaceUsageAnalyzeResponse = new SpaceUsageAnalyzeResponse();
        spaceUsageAnalyzeResponse.setUsedSize(usedSize);
        spaceUsageAnalyzeResponse.setUsedCount(usedCount);
        // å…¬å…±å›¾åº“æ— ä¸Šé™ã€æ— æ¯”ä¾‹
        spaceUsageAnalyzeResponse.setMaxSize(null);
        spaceUsageAnalyzeResponse.setSizeUsageRatio(null);
        spaceUsageAnalyzeResponse.setMaxCount(null);
        spaceUsageAnalyzeResponse.setCountUsageRatio(null);
        return spaceUsageAnalyzeResponse;
    } else {
        // æŸ¥è¯¢æŒ‡å®šç©ºé—´
        Long spaceId = spaceUsageAnalyzeRequest.getSpaceId();
        ThrowUtils.throwIf(spaceId == null || spaceId <= 0, ErrorCode.PARAMS_ERROR);
        // è·å–ç©ºé—´ä¿¡æ¯
        Space space = spaceService.getById(spaceId);
        ThrowUtils.throwIf(space == null, ErrorCode.NOT_FOUND_ERROR, "ç©ºé—´ä¸å­˜åœ¨");

        // æƒé™æ ¡éªŒï¼šä»…ç©ºé—´æ‰€æœ‰è€…æˆ–ç®¡ç†å‘˜å¯è®¿é—®
        spaceService.checkSpaceAuth(loginUser, space);

        // æ„é€ è¿”å›ç»“æœ
        SpaceUsageAnalyzeResponse response = new SpaceUsageAnalyzeResponse();
        response.setUsedSize(space.getTotalSize());
        response.setMaxSize(space.getMaxSize());
        // åç«¯ç›´æ¥ç®—å¥½ç™¾åˆ†æ¯”ï¼Œè¿™æ ·å‰ç«¯å¯ä»¥ç›´æ¥å±•ç¤º
        double sizeUsageRatio = NumberUtil.round(space.getTotalSize() * 100.0 / space.getMaxSize(), 2).doubleValue();
        response.setSizeUsageRatio(sizeUsageRatio);
        response.setUsedCount(space.getTotalCount());
        response.setMaxCount(space.getMaxCount());
        double countUsageRatio = NumberUtil.round(space.getTotalCount() * 100.0 / space.getMaxCount(), 2).doubleValue();
        response.setCountUsageRatio(countUsageRatio);
        return response;
    }
}
```

ä¸Šè¿°ä»£ç ä¸­ï¼Œæœ‰ä¸€ä¸ªå¾ˆé‡è¦çš„ä¼˜åŒ–ç»†èŠ‚ï¼Œç”±äºæˆ‘ä»¬åªéœ€è¦è·å–å›¾ç‰‡å­˜å‚¨å¤§å°ï¼Œä»æ•°æ®åº“ä¸­æŸ¥è¯¢æ—¶è¦æŒ‡å®š **åªæŸ¥è¯¢éœ€è¦çš„åˆ—**ï¼Œå¹¶ä¸”ä½¿ç”¨ mapper çš„ `selectObjs` æ–¹æ³•ç›´æ¥è¿”å› Object å¯¹è±¡ï¼Œè€Œä¸ç”¨å°è£…ä¸º Picture å¯¹è±¡ï¼Œå¯ä»¥æé«˜æ€§èƒ½å¹¶èŠ‚çº¦å­˜å‚¨ç©ºé—´ã€‚

```java
QueryWrapper<Picture> queryWrapper = new QueryWrapper<>();
queryWrapper.select("picSize");
if (!spaceUsageAnalyzeRequest.isQueryAll()) {
    queryWrapper.isNull("spaceId");
}
List<Object> pictureObjList = pictureService.getBaseMapper().selectObjs(queryWrapper);
long usedSize = pictureObjList.stream().mapToLong(result -> result instanceof Long ? (Long) result : 0).sum();
```

å¯ä»¥åœ¨ SpaceService ä¸­å°è£…ç©ºé—´æƒé™æ ¡éªŒæ–¹æ³•ï¼Œå…¶ä»–çš„åˆ†æéœ€æ±‚ä¹Ÿä¼šç”¨åˆ°ï¼š

```java
/**
 * ç©ºé—´æƒé™æ ¡éªŒ
 *
 * @param loginUser
 * @param space
 */
@Override
public void checkSpaceAuth(User loginUser, Space space) {
    // ä»…æœ¬äººæˆ–ç®¡ç†å‘˜å¯è®¿é—®
    if (!space.getUserId().equals(loginUser.getId()) && !userService.isAdmin(loginUser)) {
        throw new BusinessException(ErrorCode.NO_AUTH_ERROR);
    }
}
```

ç„¶åå¯ä»¥å°† SpaceController ä¸­ç¼–è¾‘å’Œåˆ é™¤æ“ä½œçš„æƒé™æ ¡éªŒä»£ç æ›¿æ¢ä¸º checkSpaceAuth æ–¹æ³•ï¼Œç»Ÿä¸€ç©ºé—´æ ¡éªŒé€»è¾‘ã€‚

4ï¼‰å¼€å‘ SpaceAnalyzeController æ¥å£ï¼š

```java
@RestController
@RequestMapping("/space/analyze")
public class SpaceAnalyzeController {

    @Resource
    private SpaceAnalyzeService spaceAnalyzeService;

    @Resource
    private UserService userService;

    /**
     * è·å–ç©ºé—´ä½¿ç”¨çŠ¶æ€
     */
    @PostMapping("/usage")
    public BaseResponse<SpaceUsageAnalyzeResponse> getSpaceUsageAnalyze(
            @RequestBody SpaceUsageAnalyzeRequest spaceUsageAnalyzeRequest,
            HttpServletRequest request
    ) {
        ThrowUtils.throwIf(spaceUsageAnalyzeRequest == null, ErrorCode.PARAMS_ERROR);
        User loginUser = userService.getLoginUser(request);
        SpaceUsageAnalyzeResponse spaceUsageAnalyze = spaceAnalyzeService.getSpaceUsageAnalyze(spaceUsageAnalyzeRequest, loginUser);
        return ResultUtils.success(spaceUsageAnalyze);
    }
}
```

#### 2ã€ç©ºé—´å›¾ç‰‡åˆ†ç±»åˆ†æ

1ï¼‰å¼€å‘è¯·æ±‚å°è£…ç±»ã€‚åˆ†ç±»åˆ†æåªéœ€è¦ä¼ é€’ç©ºé—´èŒƒå›´ç›¸å…³å‚æ•°ï¼Œå› æ­¤å¯ä»¥ç›´æ¥ç»§æ‰¿å…¬å…±çš„ `SpaceAnalyzeRequest`ï¼š

```java
@EqualsAndHashCode(callSuper = true)
@Data
public class SpaceCategoryAnalyzeRequest extends SpaceAnalyzeRequest {

}
```

2ï¼‰å¼€å‘å“åº”è§†å›¾ç±»ã€‚åˆ†ç±»åˆ†æçš„ç»“æœéœ€è¦è¿”å›å›¾ç‰‡åˆ†ç±»ã€åˆ†ç±»å›¾ç‰‡æ•°é‡å’Œåˆ†ç±»å›¾ç‰‡æ€»å¤§å°ï¼š

```java
@Data
@AllArgsConstructor
@NoArgsConstructor
public class SpaceCategoryAnalyzeResponse implements Serializable {

    /**
     * å›¾ç‰‡åˆ†ç±»
     */
    private String category;

    /**
     * å›¾ç‰‡æ•°é‡
     */
    private Long count;

    /**
     * åˆ†ç±»å›¾ç‰‡æ€»å¤§å°
     */
    private Long totalSize;

    private static final long serialVersionUID = 1L;
}
```

3ï¼‰å¼€å‘ Service æœåŠ¡ã€‚æŒ‰ç…§åˆ†ç±»åˆ†ç»„æŸ¥è¯¢å›¾ç‰‡è¡¨çš„æ•°æ®ï¼Œæ³¨æ„æŸ¥è¯¢æ•°æ®åº“æ—¶åªè·å–éœ€è¦çš„å­—æ®µå³å¯ï¼š

```java
@Override
public List<SpaceCategoryAnalyzeResponse> getSpaceCategoryAnalyze(SpaceCategoryAnalyzeRequest spaceCategoryAnalyzeRequest, User loginUser) {
    ThrowUtils.throwIf(spaceCategoryAnalyzeRequest == null, ErrorCode.PARAMS_ERROR);

    // æ£€æŸ¥æƒé™
    checkSpaceAnalyzeAuth(spaceCategoryAnalyzeRequest, loginUser);

    // æ„é€ æŸ¥è¯¢æ¡ä»¶
    QueryWrapper<Picture> queryWrapper = new QueryWrapper<>();
    // æ ¹æ®åˆ†æèŒƒå›´è¡¥å……æŸ¥è¯¢æ¡ä»¶
    fillAnalyzeQueryWrapper(spaceCategoryAnalyzeRequest, queryWrapper);

    // ä½¿ç”¨ MyBatis-Plus åˆ†ç»„æŸ¥è¯¢
    queryWrapper.select("category AS category",
                    "COUNT(*) AS count",
                    "SUM(picSize) AS totalSize")
            .groupBy("category");

    // æŸ¥è¯¢å¹¶è½¬æ¢ç»“æœ
    return pictureService.getBaseMapper().selectMaps(queryWrapper)
            .stream()
            .map(result -> {
                String category = result.get("category") != null ? result.get("category").toString() : "æœªåˆ†ç±»";
                Long count = ((Number) result.get("count")).longValue();
                Long totalSize = ((Number) result.get("totalSize")).longValue();
                return new SpaceCategoryAnalyzeResponse(category, count, totalSize);
            })
            .collect(Collectors.toList());
}
```

ğŸ’¡ å»ºè®®åœ¨ç¼–å†™å…·ä½“çš„ä»£ç å‰ï¼Œå…ˆç¼–å†™ç¤ºä¾‹ SQL è¯­å¥ï¼Œå¹¶é€šè¿‡æ•°æ®åº“æŸ¥è¯¢å®¢æˆ·ç«¯æ¥éªŒè¯ã€‚

4ï¼‰å¼€å‘æ¥å£ï¼š

```java
@PostMapping("/category")
public BaseResponse<List<SpaceCategoryAnalyzeResponse>> getSpaceCategoryAnalyze(@RequestBody SpaceCategoryAnalyzeRequest spaceCategoryAnalyzeRequest, HttpServletRequest request) {
    ThrowUtils.throwIf(spaceCategoryAnalyzeRequest == null, ErrorCode.PARAMS_ERROR);
    User loginUser = userService.getLoginUser(request);
    List<SpaceCategoryAnalyzeResponse> resultList = spaceAnalyzeService.getSpaceCategoryAnalyze(spaceCategoryAnalyzeRequest, loginUser);
    return ResultUtils.success(resultList);
}
```

#### 3ã€ç©ºé—´å›¾ç‰‡æ ‡ç­¾åˆ†æ

1ï¼‰å¼€å‘è¯·æ±‚å°è£…ç±»ï¼Œæ ‡ç­¾åˆ†æåŒæ ·éœ€è¦ç»§æ‰¿ `SpaceAnalyzeRequest`ï¼š

```java
@EqualsAndHashCode(callSuper = true)
@Data
public class SpaceTagAnalyzeRequest extends SpaceAnalyzeRequest {

}
```

2ï¼‰å¼€å‘å“åº”è§†å›¾ç±»ã€‚æ ‡ç­¾åˆ†æçš„ç»“æœéœ€è¦è¿”å›æ ‡ç­¾åç§°å’Œå…³è”çš„å›¾ç‰‡æ•°é‡ï¼š

```java
@Data
@AllArgsConstructor
@NoArgsConstructor
public class SpaceTagAnalyzeResponse implements Serializable {

    /**
     * æ ‡ç­¾åç§°
     */
    private String tag;

    /**
     * ä½¿ç”¨æ¬¡æ•°
     */
    private Long count;

    private static final long serialVersionUID = 1L;
}
```

3ï¼‰å¼€å‘ Service æœåŠ¡ã€‚ä»æ•°æ®åº“è·å–æ ‡ç­¾æ•°æ®ï¼Œç»Ÿè®¡æ¯ä¸ªæ ‡ç­¾çš„å›¾ç‰‡æ•°é‡ï¼Œå¹¶æŒ‰ä½¿ç”¨æ¬¡æ•°é™åºæ’åºï¼š

```java
@Override
public List<SpaceTagAnalyzeResponse> getSpaceTagAnalyze(SpaceTagAnalyzeRequest spaceTagAnalyzeRequest, User loginUser) {
    ThrowUtils.throwIf(spaceTagAnalyzeRequest == null, ErrorCode.PARAMS_ERROR);

    // æ£€æŸ¥æƒé™
    checkSpaceAnalyzeAuth(spaceTagAnalyzeRequest, loginUser);

    // æ„é€ æŸ¥è¯¢æ¡ä»¶
    QueryWrapper<Picture> queryWrapper = new QueryWrapper<>();
    fillAnalyzeQueryWrapper(spaceTagAnalyzeRequest, queryWrapper);

    // æŸ¥è¯¢æ‰€æœ‰ç¬¦åˆæ¡ä»¶çš„æ ‡ç­¾
    queryWrapper.select("tags");
    List<String> tagsJsonList = pictureService.getBaseMapper().selectObjs(queryWrapper)
            .stream()
            .filter(ObjUtil::isNotNull)
            .map(Object::toString)
            .collect(Collectors.toList());

    // åˆå¹¶æ‰€æœ‰æ ‡ç­¾å¹¶ç»Ÿè®¡ä½¿ç”¨æ¬¡æ•°
    Map<String, Long> tagCountMap = tagsJsonList.stream()
            .flatMap(tagsJson -> JSONUtil.toList(tagsJson, String.class).stream())
            .collect(Collectors.groupingBy(tag -> tag, Collectors.counting()));

    // è½¬æ¢ä¸ºå“åº”å¯¹è±¡ï¼ŒæŒ‰ä½¿ç”¨æ¬¡æ•°é™åºæ’åº
    return tagCountMap.entrySet().stream()
            .sorted((e1, e2) -> Long.compare(e2.getValue(), e1.getValue())) // é™åºæ’åˆ—
            .map(entry -> new SpaceTagAnalyzeResponse(entry.getKey(), entry.getValue()))
            .collect(Collectors.toList());
}
```

4ï¼‰å¼€å‘æ¥å£ï¼š

```java
@PostMapping("/tag")
public BaseResponse<List<SpaceTagAnalyzeResponse>> getSpaceTagAnalyze(@RequestBody SpaceTagAnalyzeRequest spaceTagAnalyzeRequest, HttpServletRequest request) {
    ThrowUtils.throwIf(spaceTagAnalyzeRequest == null, ErrorCode.PARAMS_ERROR);
    User loginUser = userService.getLoginUser(request);
    List<SpaceTagAnalyzeResponse> resultList = spaceAnalyzeService.getSpaceTagAnalyze(spaceTagAnalyzeRequest, loginUser);
    return ResultUtils.success(resultList);
}
```

#### 4ã€ç©ºé—´å›¾ç‰‡å¤§å°åˆ†æ

1ï¼‰å¼€å‘è¯·æ±‚å°è£…ç±»ã€‚å›¾ç‰‡å¤§å°åˆ†æä¹Ÿç»§æ‰¿ `SpaceAnalyzeRequest`ï¼š

```java
@EqualsAndHashCode(callSuper = true)
@Data
public class SpaceSizeAnalyzeRequest extends SpaceAnalyzeRequest {

}
```

2ï¼‰å¼€å‘å“åº”è§†å›¾ç±»ã€‚å¤§å°åˆ†æç»“æœéœ€è¦è¿”å›å›¾ç‰‡å¤§å°èŒƒå›´å’Œå¯¹åº”çš„å›¾ç‰‡æ•°é‡ï¼š

```java
@Data
@AllArgsConstructor
@NoArgsConstructor
public class SpaceSizeAnalyzeResponse implements Serializable {

    /**
     * å›¾ç‰‡å¤§å°èŒƒå›´
     */
    private String sizeRange;

    /**
     * å›¾ç‰‡æ•°é‡
     */
    private Long count;

    private static final long serialVersionUID = 1L;
}
```

3ï¼‰å¼€å‘ Service æœåŠ¡ï¼Œåˆ†æ®µç»Ÿè®¡å›¾ç‰‡å¤§å°ï¼š

```java
@Override
public List<SpaceSizeAnalyzeResponse> getSpaceSizeAnalyze(SpaceSizeAnalyzeRequest spaceSizeAnalyzeRequest, User loginUser) {
    ThrowUtils.throwIf(spaceSizeAnalyzeRequest == null, ErrorCode.PARAMS_ERROR);

    // æ£€æŸ¥æƒé™
    checkSpaceAnalyzeAuth(spaceSizeAnalyzeRequest, loginUser);

    // æ„é€ æŸ¥è¯¢æ¡ä»¶
    QueryWrapper<Picture> queryWrapper = new QueryWrapper<>();
    fillAnalyzeQueryWrapper(spaceSizeAnalyzeRequest, queryWrapper);

    // æŸ¥è¯¢æ‰€æœ‰ç¬¦åˆæ¡ä»¶çš„å›¾ç‰‡å¤§å°
    queryWrapper.select("picSize");
    List<Long> picSizes = pictureService.getBaseMapper().selectObjs(queryWrapper)
            .stream()
            .map(size -> ((Number) size).longValue())
            .collect(Collectors.toList());

    // å®šä¹‰åˆ†æ®µèŒƒå›´ï¼Œæ³¨æ„ä½¿ç”¨æœ‰åº Map
    Map<String, Long> sizeRanges = new LinkedHashMap<>();
    sizeRanges.put("<100KB", picSizes.stream().filter(size -> size < 100 * 1024).count());
    sizeRanges.put("100KB-500KB", picSizes.stream().filter(size -> size >= 100 * 1024 && size < 500 * 1024).count());
    sizeRanges.put("500KB-1MB", picSizes.stream().filter(size -> size >= 500 * 1024 && size < 1 * 1024 * 1024).count());
    sizeRanges.put(">1MB", picSizes.stream().filter(size -> size >= 1 * 1024 * 1024).count());

    // è½¬æ¢ä¸ºå“åº”å¯¹è±¡
    return sizeRanges.entrySet().stream()
            .map(entry -> new SpaceSizeAnalyzeResponse(entry.getKey(), entry.getValue()))
            .collect(Collectors.toList());
}
```

ä¸Šè¿°ä»£ç å…¶å®è¿˜å¯ä»¥è¿›ä¸€æ­¥ä¼˜åŒ–ï¼Œåªéœ€è¦éå†ä¸€æ¬¡ picSizes åˆ—è¡¨å°±å¯ä»¥æŒ‰å¤§å°åˆ†åˆ«ç»Ÿè®¡äº†ã€‚

4ï¼‰å¼€å‘æ¥å£ï¼š

```java
@PostMapping("/size")
public BaseResponse<List<SpaceSizeAnalyzeResponse>> getSpaceSizeAnalyze(@RequestBody SpaceSizeAnalyzeRequest spaceSizeAnalyzeRequest, HttpServletRequest request) {
    ThrowUtils.throwIf(spaceSizeAnalyzeRequest == null, ErrorCode.PARAMS_ERROR);
    User loginUser = userService.getLoginUser(request);
    List<SpaceSizeAnalyzeResponse> resultList = spaceAnalyzeService.getSpaceSizeAnalyze(spaceSizeAnalyzeRequest, loginUser);
    return ResultUtils.success(resultList);
}
```

#### 5ã€ç”¨æˆ·ä¸Šä¼ è¡Œä¸ºåˆ†æ

1ï¼‰å¼€å‘è¯·æ±‚å°è£…ç±»ã€‚ç”¨æˆ·ä¸Šä¼ è¡Œä¸ºåˆ†æéœ€è¦å¢åŠ æ—¶é—´ç»´åº¦ï¼ˆæ—¥ã€å‘¨ã€æœˆï¼‰å’Œç”¨æˆ· ID å‚æ•°ï¼Œæ”¯æŒåªåˆ†ææŸä¸ªç”¨æˆ·ä¸Šä¼ å›¾ç‰‡çš„æƒ…å†µã€‚

```java
@EqualsAndHashCode(callSuper = true)
@Data
public class SpaceUserAnalyzeRequest extends SpaceAnalyzeRequest {

    /**
     * ç”¨æˆ· ID
     */
    private Long userId;

    /**
     * æ—¶é—´ç»´åº¦ï¼šday / week / month
     */
    private String timeDimension;
}
```

2ï¼‰å¼€å‘å“åº”è§†å›¾ç±»ã€‚ç”¨æˆ·è¡Œä¸ºåˆ†æç»“æœéœ€è¦è¿”å›æ—¶é—´åŒºé—´å’Œå¯¹åº”çš„å›¾ç‰‡æ•°é‡ï¼š

```java
@Data
@AllArgsConstructor
@NoArgsConstructor
public class SpaceUserAnalyzeResponse implements Serializable {

    /**
     * æ—¶é—´åŒºé—´
     */
    private String period;

    /**
     * ä¸Šä¼ æ•°é‡
     */
    private Long count;

    private static final long serialVersionUID = 1L;
}
```

3ï¼‰å¼€å‘ Service æœåŠ¡ï¼ŒåŸºäºå›¾ç‰‡çš„åˆ›å»ºæ—¶é—´ç»´åº¦ç»Ÿè®¡ç”¨æˆ·çš„ä¸Šä¼ è¡Œä¸ºï¼Œå¹¶æŒ‰ç…§æ—¶é—´å‡åºæ’åºï¼š

```java
@Override
public List<SpaceUserAnalyzeResponse> getSpaceUserAnalyze(SpaceUserAnalyzeRequest spaceUserAnalyzeRequest, User loginUser) {
    ThrowUtils.throwIf(spaceUserAnalyzeRequest == null, ErrorCode.PARAMS_ERROR);
    // æ£€æŸ¥æƒé™
    checkSpaceAnalyzeAuth(spaceUserAnalyzeRequest, loginUser);

    // æ„é€ æŸ¥è¯¢æ¡ä»¶
    QueryWrapper<Picture> queryWrapper = new QueryWrapper<>();
    Long userId = spaceUserAnalyzeRequest.getUserId();
    queryWrapper.eq(ObjUtil.isNotNull(userId), "userId", userId);
    fillAnalyzeQueryWrapper(spaceUserAnalyzeRequest, queryWrapper);

    // åˆ†æç»´åº¦ï¼šæ¯æ—¥ã€æ¯å‘¨ã€æ¯æœˆ
    String timeDimension = spaceUserAnalyzeRequest.getTimeDimension();
    switch (timeDimension) {
        case "day":
            queryWrapper.select("DATE_FORMAT(createTime, '%Y-%m-%d') AS period", "COUNT(*) AS count");
            break;
        case "week":
            queryWrapper.select("YEARWEEK(createTime) AS period", "COUNT(*) AS count");
            break;
        case "month":
            queryWrapper.select("DATE_FORMAT(createTime, '%Y-%m') AS period", "COUNT(*) AS count");
            break;
        default:
            throw new BusinessException(ErrorCode.PARAMS_ERROR, "ä¸æ”¯æŒçš„æ—¶é—´ç»´åº¦");
    }

    // åˆ†ç»„å’Œæ’åº
    queryWrapper.groupBy("period").orderByAsc("period");

    // æŸ¥è¯¢ç»“æœå¹¶è½¬æ¢
    List<Map<String, Object>> queryResult = pictureService.getBaseMapper().selectMaps(queryWrapper);
    return queryResult.stream()
            .map(result -> {
                String period = result.get("period").toString();
                Long count = ((Number) result.get("count")).longValue();
                return new SpaceUserAnalyzeResponse(period, count);
            })
            .collect(Collectors.toList());
}
```

ä¸Šè¿°ä»£ç ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ MySQL çš„æ—¥æœŸæ—¶é—´å‡½æ•°å¯¹å›¾ç‰‡çš„åˆ›å»ºæ—¶é—´è¿›è¡Œäº†æ ¼å¼åŒ–ï¼Œä½¿å¾—åŒä¸€å¤©ï¼ˆå‘¨ / æœˆï¼‰çš„å€¼ç›¸åŒï¼Œå°±èƒ½å¤Ÿç»Ÿä¸€æŒ‰ç…§ä¸€ä¸ªå­—æ®µï¼ˆperiodï¼‰è¿›è¡Œåˆ†ç»„å’Œæ’åºäº†ã€‚

4ï¼‰å¼€å‘æ¥å£ï¼š

```java
@PostMapping("/user")
public BaseResponse<List<SpaceUserAnalyzeResponse>> getSpaceUserAnalyze(@RequestBody SpaceUserAnalyzeRequest spaceUserAnalyzeRequest, HttpServletRequest request) {
    ThrowUtils.throwIf(spaceUserAnalyzeRequest == null, ErrorCode.PARAMS_ERROR);
    User loginUser = userService.getLoginUser(request);
    List<SpaceUserAnalyzeResponse> resultList = spaceAnalyzeService.getSpaceUserAnalyze(spaceUserAnalyzeRequest, loginUser);
    return ResultUtils.success(resultList);
}
```

ä¸Šè¿°çš„è¿™äº›éœ€æ±‚ï¼Œå¯ä»¥åŒæ—¶ç»™ç”¨æˆ·å’Œç®¡ç†å‘˜ä½¿ç”¨ï¼Œå·²ç»æ»¡è¶³äº†ç®¡ç†å‘˜ â€œå…¨ç©ºé—´èµ„æºä½¿ç”¨åˆ†æâ€ çš„éœ€æ±‚ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬åªéœ€è¦å•ç‹¬å¼€å‘ä¸€ä¸ª **ä»…ç®¡ç†å‘˜å¯ä½¿ç”¨çš„åŠŸèƒ½** â€”â€” ç©ºé—´ä½¿ç”¨æ’è¡Œåˆ†æã€‚

#### 6ã€ç©ºé—´ä½¿ç”¨æ’è¡Œåˆ†æ

è¯¥åŠŸèƒ½ä»…ç®¡ç†å‘˜å¯ä½¿ç”¨ï¼Œè¿”å›å€¼å°±æ˜¯å‰ N ä¸ªç©ºé—´çš„ä¿¡æ¯ã€‚ç”±äºå·²ç»æœ‰ç°æˆçš„ Space ç©ºé—´å¯¹è±¡ï¼Œå°±ä¸ç”¨ç¼–å†™å“åº”è§†å›¾ç±»äº†ã€‚

1ï¼‰å¼€å‘è¯·æ±‚å°è£…ç±»ã€‚ç©ºé—´ä½¿ç”¨æ’è¡Œéœ€è¦æ¥æ”¶ä¸€ä¸ªå‚æ•° `topN`ï¼ŒæŒ‡å®šè¦è¿”å›çš„å‰ N åç©ºé—´ä¿¡æ¯ï¼Œé»˜è®¤å€¼ä¸º 10ï¼š

```java
@Data
public class SpaceRankAnalyzeRequest implements Serializable {

    /**
     * æ’åå‰ N çš„ç©ºé—´
     */
    private Integer topN = 10;

    private static final long serialVersionUID = 1L;
}
```

2ï¼‰å¼€å‘ Service æœåŠ¡ï¼ŒæŒ‰å­˜å‚¨ä½¿ç”¨é‡æ’åºæŸ¥è¯¢å‰ N ä¸ªç©ºé—´ã€‚æ³¨æ„ï¼Œåªæœ‰ç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹ç©ºé—´æ’è¡Œï¼š

```java
@Override
public List<Space> getSpaceRankAnalyze(SpaceRankAnalyzeRequest spaceRankAnalyzeRequest, User loginUser) {
ThrowUtils.throwIf(spaceRankAnalyzeRequest == null, ErrorCode.PARAMS_ERROR);

// ä»…ç®¡ç†å‘˜å¯æŸ¥çœ‹ç©ºé—´æ’è¡Œ
ThrowUtils.throwIf(!userService.isAdmin(loginUser), ErrorCode.NO_AUTH_ERROR, "æ— æƒæŸ¥çœ‹ç©ºé—´æ’è¡Œ");

// æ„é€ æŸ¥è¯¢æ¡ä»¶
QueryWrapper<Space> queryWrapper = new QueryWrapper<>();
queryWrapper.select("id", "spaceName", "userId", "totalSize")
        .orderByDesc("totalSize")
        .last("LIMIT " + spaceRankAnalyzeRequest.getTopN()); // å–å‰ N å

// æŸ¥è¯¢ç»“æœ
return spaceService.list(queryWrapper);
}
```

3ï¼‰å¼€å‘æ¥å£ï¼š

```java
@PostMapping("/rank")
public BaseResponse<List<Space>> getSpaceRankAnalyze(@RequestBody SpaceRankAnalyzeRequest spaceRankAnalyzeRequest, HttpServletRequest request) {
    ThrowUtils.throwIf(spaceRankAnalyzeRequest == null, ErrorCode.PARAMS_ERROR);
    User loginUser = userService.getLoginUser(request);
    List<Space> resultList = spaceAnalyzeService.getSpaceRankAnalyze(spaceRankAnalyzeRequest, loginUser);
    return ResultUtils.success(resultList);
}
```

è‡³æ­¤ï¼Œåˆ†æéœ€æ±‚çš„åç«¯æ¥å£å°±å¼€å‘å®Œæˆäº†ï¼Œå¯ä»¥é€šè¿‡ Swagger æ¥å£æ–‡æ¡£æµ‹è¯•ä¸€æ³¢~ å°¤å…¶æ³¨æ„éªŒè¯æŸ¥è¯¢èŒƒå›´çš„å‡†ç¡®æ€§ï¼š

![img](assets/fRoTwZWjYQOGitfP.webp)

### æ‰©å±•çŸ¥è¯† - è‡ªå®šä¹‰ SQL

ä¸Šè¿°çš„éœ€æ±‚æˆ‘ä»¬æ˜¯é€šè¿‡ MyBatis Plus æä¾›çš„æ–¹æ³•å®ç°æ•°æ®åº“çš„åˆ†ç»„æ’åºæŸ¥è¯¢ï¼Œå¯¹äºæ›´å¤æ‚å¤šæ ·çš„åˆ†æéœ€æ±‚ï¼Œå…¶å®æˆ‘ä»¬è¿˜å¯ä»¥è‡ªå·±åœ¨ä»£ç ä¸­ç¼–å†™ SQL è¯­å¥ã€‚

å¯èƒ½æœ‰éƒ¨åˆ†åŒå­¦ä¼šå¥½å¥‡ï¼ŒMyBatis è¿˜èƒ½è‡ªå®šä¹‰ SQLï¼Ÿä¸éƒ½æ˜¯ç›´æ¥è°ƒç”¨ `xxx.select` ä¹‹ç±»çš„æ–¹æ³•ä¹ˆï¼Ÿ

è¿™å°±æ˜¯å…¸å‹çš„â€œç”¨æ¡†æ¶ä¹ æƒ¯äº†â€ï¼Œå…¶å®ä¸ºäº†æé«˜å¼€å‘æ•ˆç‡ã€é¿å…è‡ªå·±å†™ SQLï¼Œæˆ‘ä»¬ä¹‹å‰ä¸€ç›´ä½¿ç”¨çš„æ˜¯ MyBatis Plus æ¡†æ¶ã€‚ä½†åˆ«å¿˜äº†ï¼ŒMyBatis Plus æ˜¯ MyBatis çš„å¢å¼ºç‰ˆï¼Œæœ¬è´¨è¿˜æ˜¯åŸºäº MyBatis çš„ä¸€äº›èƒ½åŠ›è¿›è¡Œçš„ä¸€äº›å°è£…ç®€åŒ–ï¼Œè‡ªå®šä¹‰ SQL å¯æ˜¯ MyBatis æœ€æœ€æœ€åŸºç¡€çš„èƒ½åŠ›ä¹‹ä¸€ã€‚

åœ¨ MyBatis ä¸€èˆ¬ä¼šä»¥ä¸¤ç§æ–¹å¼æ¥å®ç°è‡ªå®šä¹‰ SQL ï¼š

#### 1ã€Java æ³¨è§£å®ç°

åŸºäº Java æ³¨è§£å†™åœ¨ xxxMapper.java ä¸­ã€‚

æ³¨è§£ä½¿ç”¨å¾ˆç®€å•ï¼Œ åœ¨ mapper å±‚çš„æ¥å£ç±»æ–¹æ³•åˆ©ç”¨ `@Selectã€@Updateã€@Insertã€@Delete` ç­‰æ³¨è§£ï¼Œåœ¨æ³¨è§£å†…å¡«å†™è‡ªå®šä¹‰ SQL è¯­å¥ï¼Œå³å¯å®ç°æŸ¥è¯¢ã€æ›´æ–°ã€å­˜å‚¨ã€åˆ é™¤ã€‚

ä¾‹å¦‚ä¸‹é¢ä¸¤ä¸ªæ–¹æ³•ï¼š

```java
public interface SpaceMapper extends BaseMapper<Space> {

    /**
     * è·å–å­˜å‚¨ä½¿ç”¨é‡æ’åå‰ N çš„ç©ºé—´
     * @param topN æ’åå‰ N
     * @return List<Space>
     */
    @Select("SELECT id, spaceName, userId, totalSize " +
            "FROM space " +
            "ORDER BY totalSize DESC " +
            "LIMIT #{topN}")
    List<Space> getTopNSpaceUsage(int topN);

    /**
     * åˆ é™¤æŸç”¨æˆ·çš„æ‰€æœ‰ç©ºé—´
     *
     * @param userId ç”¨æˆ· ID
     * @return åˆ é™¤çš„è®°å½•æ•°
     */
    @Delete("DELETE FROM space WHERE userId = #{userId}")
    int deleteByUserId(Long userId);
}
```

å®Œæ•´è¯­å¥ = SQL è¯­å¥æ¨¡æ¿ + è®¾ç½®åŠ¨æ€å‚æ•°ã€‚æ–¹æ³•çš„å‚æ•°å¯ä»¥ä½œä¸ºåŠ¨æ€å‚æ•°è‡ªåŠ¨å¡«å……åˆ° SQL æ¨¡æ¿ä¸­ï¼Œå¾—åˆ°æœ€ç»ˆçš„ SQL è¯­å¥ï¼Œç»“æœä¹Ÿä¼šè‡ªåŠ¨è½¬æˆæ–¹æ³•è¿”å›å€¼çš„ Java ç±»å‹ã€‚

ğŸ’¡ é€šè¿‡ #{} å’Œ ${} éƒ½å¯ä»¥å®ç° SQL å‚æ•°ç»‘å®šï¼Œä½†æ˜¯ä¸¤è€…æ˜¯æœ‰åŒºåˆ«çš„ã€‚#{} æ˜¯é¢„ç¼–è¯‘å‚æ•°ï¼Œå¯ä»¥é˜²æ­¢ SQL æ³¨å…¥ï¼Œè€Œ ${} æ˜¯ç›´æ¥æ›¿æ¢ï¼Œä¼šå¯¼è‡´ SQL æ³¨å…¥ã€‚

#### 2ã€XML é…ç½®å®ç°

åŸºäº XML é…ç½®æ–‡ä»¶å†™åœ¨ xxxMapper.xml ä¸­ã€‚

ä¹‹å‰é€šè¿‡ä»£ç ç”Ÿæˆå™¨ï¼Œé¡¹ç›®é‡Œé¢å·²ç»æœ‰å¾ˆå¤š xxxMapper.xml é…ç½®æ–‡ä»¶äº†ã€‚æ¯”å¦‚ SpaceMapper.xmlï¼Œé‡Œé¢å®šä¹‰äº†è¡¨å’Œ Java ç±»çš„å­—æ®µæ˜ å°„ã€SQL å­—æ®µåˆ—è¡¨ç‰‡æ®µã€‚

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yupi.yupicturebackend.mapper.SpaceMapper">

    <resultMap id="BaseResultMap" type="com.yupi.yupicturebackend.model.entity.Space">
        <id property="id" column="id" jdbcType="BIGINT"/>
        <result property="spaceName" column="spaceName" jdbcType="VARCHAR"/>
        <result property="spaceLevel" column="spaceLevel" jdbcType="INTEGER"/>
        <result property="maxSize" column="maxSize" jdbcType="BIGINT"/>
        <result property="maxCount" column="maxCount" jdbcType="BIGINT"/>
        <result property="totalSize" column="totalSize" jdbcType="BIGINT"/>
        <result property="totalCount" column="totalCount" jdbcType="BIGINT"/>
        <result property="userId" column="userId" jdbcType="BIGINT"/>
        <result property="createTime" column="createTime" jdbcType="TIMESTAMP"/>
        <result property="editTime" column="editTime" jdbcType="TIMESTAMP"/>
        <result property="updateTime" column="updateTime" jdbcType="TIMESTAMP"/>
        <result property="isDelete" column="isDelete" jdbcType="TINYINT"/>
    </resultMap>

    <sql id="Base_Column_List">
        id,spaceName,spaceLevel,
        maxSize,maxCount,totalSize,
        totalCount,userId,createTime,
        editTime,updateTime,isDelete
    </sql>
</mapper>
```

ä¸ç”¨è‡ªå·±æ–°å»ºï¼Œä»…éœ€åœ¨é‡Œé¢æ·»åŠ è‡ªå®šä¹‰çš„ SQL ä»£ç å³å¯ã€‚

è·Ÿæ³¨è§£ç±»ä¼¼ï¼ŒMyBatis XML ä¸­æä¾›äº† `<select>`ã€`<update>`ã€`<insert>`ã€`<delete>` ç­‰è¯­æ³•ï¼Œåœ¨å†…éƒ¨æ·»åŠ è‡ªå®šä¹‰ SQL ï¼Œå³å¯å®ç°æŸ¥è¯¢ã€æ›´æ–°ã€å­˜å‚¨ã€åˆ é™¤ã€‚

ç§»é™¤ä¸Šè¿° Mapper çš„ SQL æ³¨è§£ï¼Œç„¶ååœ¨ XML æ–‡ä»¶ä¸­ç¼–å†™ SQL ç‰‡æ®µï¼Œç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š

```xml
<!-- è·å–å­˜å‚¨ä½¿ç”¨é‡æ’åå‰ N çš„ç©ºé—´ -->
<select id="getTopNSpaceUsage" resultType="com.yupi.Space">
  SELECT id, spaceName, userId, totalSize
  FROM space
  ORDER BY totalSize DESC
  LIMIT #{topN}
</select>

<!-- åˆ é™¤æŸç”¨æˆ·çš„æ‰€æœ‰ç©ºé—´ -->
<delete id="deleteByUserId">
  DELETE FROM space WHERE userId = #{userId}
</delete>
```

éœ€è¦æ³¨æ„ 2 ç‚¹ï¼š

1. Mapper æ¥å£ä¸­çš„æ–¹æ³•åç§°å¿…é¡»ä¸ XML æ–‡ä»¶ä¸­å®šä¹‰çš„ SQL ç‰‡æ®µçš„ id å¯¹åº”ï¼ŒMyBatis æ‰èƒ½æ­£ç¡®è§£æå’ŒåŒ¹é…æ–¹æ³•ã€‚
2. Mapper æ¥å£æ–¹æ³•çš„è¿”å›ç±»å‹éœ€è¦ä¸ XML æ–‡ä»¶ä¸­ resultTypeï¼ˆæˆ– resultMapï¼‰çš„å®šä¹‰ä¿æŒä¸€è‡´ï¼Œä»¥ç¡®ä¿æŸ¥è¯¢ç»“æœèƒ½å¤Ÿæ­£ç¡®æ˜ å°„åˆ°è¿”å›å¯¹è±¡ã€‚

è¿™æ ·ä¸€æ¥ï¼ŒMyBatis åœ¨è¿è¡Œæ—¶ä¼šæ ¹æ® Mapper æ¥å£è§£æå¯¹åº”çš„ XML æ–‡ä»¶ï¼Œé€šè¿‡åŠ¨æ€ä»£ç†æœºåˆ¶ï¼Œå°†æ¥å£æ–¹æ³•ä¸ SQL æ‰§è¡Œé€»è¾‘å…³è”èµ·æ¥ã€‚

### æ‰©å±•çŸ¥è¯† - æŸ¥è¯¢åŠ é€Ÿ

æ•°æ®åˆ†æé€šå¸¸æœ‰ 2 ç§å¤„ç†æ–¹å¼ï¼Œå®æ—¶åˆ†æå’Œç¦»çº¿åˆ†æã€‚

å®æ—¶åˆ†ææ˜¯æŒ‡åœ¨æ•°æ®ç”Ÿæˆçš„åŒæ—¶ï¼Œç«‹å³å¯¹å…¶è¿›è¡Œå¤„ç†å’Œåˆ†æï¼Œä»¥æä¾›å³æ—¶çš„ç»“æœï¼Œè¿™ç§æ–¹å¼é€‚ç”¨äºéœ€è¦å¿«é€Ÿå†³ç­–çš„åœºæ™¯ï¼Œæ¯”å¦‚ç›‘æ§ç³»ç»Ÿä¸­çš„å¼‚å¸¸æ£€æµ‹æˆ–ç”µå•†çš„å®æ—¶æ¨èï¼›ç¦»çº¿æ•°æ®åˆ†æåˆ™æ˜¯åœ¨æ‰¹é‡æ”¶é›†å’Œå­˜å‚¨æ•°æ®åï¼Œè¿›è¡Œå¤æ‚è®¡ç®—å’Œæ·±åº¦åˆ†æï¼Œé€‚åˆæ•°æ®é‡æå¤§ã€ä¸éœ€è¦å³æ—¶ç»“æœçš„åœºæ™¯ï¼Œæ¯”å¦‚ç”Ÿæˆå†å²æŠ¥è¡¨æˆ–æŒ–æ˜æ•°æ®ä¸­çš„æ½œåœ¨ç‰¹å¾ã€‚

å³ä½¿æˆ‘ä»¬æ²¡å­¦è¿‡å¤§æ•°æ®æŠ€æœ¯ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ä¸šåŠ¡é€»è¾‘å±‚çš„ç¼–ç åŠ é€Ÿæ•°æ®æŸ¥è¯¢å’Œåˆ†æï¼Œå…¸å‹çš„è§£å†³æ–¹æ¡ˆå°±æ˜¯ç¼“å­˜ã€‚åˆ©ç”¨ Redis åˆ†å¸ƒå¼ç¼“å­˜æˆ–æœ¬åœ°ç¼“å­˜æ¥å­˜å‚¨å¾€æœŸçš„æŸ¥è¯¢ç»“æœï¼Œå¹¶è®¾å®šä¸€å®šçš„è¿‡æœŸæ—¶é—´ï¼Œå°±èƒ½é¿å…é‡å¤è®¡ç®—å¹¶å¿«é€Ÿå“åº”ã€‚

å½“ç„¶ï¼Œå¯¹äºå®šæœŸçš„åˆ†æè¯‰æ±‚ï¼ˆæ¯”å¦‚è®¡ç®—æ¯æ—¥çš„æ’è¡Œæ¦œï¼‰è¿˜æœ‰ä¸€ç§å…¸å‹çš„æ–¹æ¡ˆï¼Œæ˜¯é€šè¿‡å®šæ—¶ä»»åŠ¡è®¡ç®—æ¯æ—¥çš„ç»“æœå¹¶å­˜å‚¨åœ¨æ•°æ®åº“ä¸­ï¼Œä¹‹åå°±å¯ä»¥æŒ‰ç…§æ—¥æœŸæ¥ç›´æ¥æŸ¥è¯¢æŸå¤©çš„ç»“æœäº†ã€‚

æ¯”å¦‚ä¸Šè¿°éœ€æ±‚ä¸­çš„ â€œç”¨æˆ·ä¸Šä¼ è¡Œä¸ºåˆ†æâ€ï¼Œå°±å¯ä»¥æ¯æ—¥è®¡ç®—æŸä¸ªç©ºé—´çš„ç”¨æˆ·ä¸Šä¼ æƒ…å†µï¼ŒæŸ¥è¯¢æ—¶ç›´æ¥èŒƒå›´æŸ¥è¯¢æ—¥æœŸã€‚

| æ’å | ç»Ÿè®¡æ—¥æœŸ   | ç©ºé—´ ID | ç©ºé—´åç§°       | ç”¨æˆ· ID | æ€»å¤§å° (MB) |
| ---- | ---------- | ------- | -------------- | ------- | ----------- |
| 1    | 2024-12-13 | 1001    | é±¼çš®çš„ä¸ªäººç©ºé—´ | 2001    | 2048        |
| 2    | 2024-12-13 | 1002    | å¼ ä¸‰çš„ä¸ªäººç©ºé—´ | 2002    | 1832        |
| 3    | 2024-12-13 | 1003    | æå››çš„ä¸ªäººç©ºé—´ | 2003    | 1456        |
| 4    | 2024-12-13 | 1004    | å­™äº”çš„ä¸ªäººç©ºé—´ | 2004    | 1387        |
| 5    | 2024-12-13 | 1005    | è€å…­çš„ä¸ªäººç©ºé—´ | 2005    | 1203        |

## å››ã€å‰ç«¯å¼€å‘

å‰ç«¯å¼€å‘å°†åˆ†ä¸ºå‡ ä¸ªæ­¥éª¤ï¼š

1. å¼•å…¥æ•°æ®å¯è§†åŒ–ç»„ä»¶
2. å¼€å‘åˆ†æç»„ä»¶
3. å¼€å‘åˆ†æé¡µé¢

### æ•°æ®å¯è§†åŒ–ç»„ä»¶

[Apache ECharts](https://echarts.apache.org/zh/index.html) æ˜¯ä¸»æµçš„å¼€æºå›¾è¡¨åº“ï¼Œvue-echarts æ˜¯åŸºäº Echarts çš„å°è£…ï¼Œç®€åŒ–äº†åœ¨ Vue é¡¹ç›®ä¸­çš„ä½¿ç”¨ï¼Œæ‰€ä»¥æ¨èä½¿ç”¨ [vue-echarts](https://github.com/ecomfe/vue-echarts) å®ç°æ•°æ®å¯è§†åŒ–ã€‚

å¼•å…¥ç±»åº“ï¼Œæ³¨æ„å¿…é¡»åŒæ—¶å¼•å…¥ Echartsï¼š

```java
npm i echarts vue-echarts
```

åœ¨éœ€è¦ä½¿ç”¨å›¾è¡¨çš„é¡µé¢ JS å¼•å…¥ï¼š

```javascript
import VChart from "vue-echarts";
import "echarts";
```

ç„¶åå°±å¯ä»¥ä½¿ç”¨ç»„ä»¶äº†ï¼Œç¤ºä¾‹ä»£ç ï¼š

```javascript
<v-chart :option="options" style="height: 300px" />
```

ä¸Šè¿°ä»£ç ä¸­ï¼Œoption çš„å€¼åŒ…æ‹¬äº†å›¾è¡¨çš„åŸºæœ¬ä¿¡æ¯ã€å›¾è¡¨çš„æ•°æ®ç­‰ï¼Œå¯ä»¥ä» [ECharts å®˜ç½‘çš„ç¤ºä¾‹](https://echarts.apache.org/examples/zh/index.html) ä¸­å¿«é€Ÿå­¦ä¹ å’Œè·å–ã€‚Echarts æä¾›äº† Playground ç»ƒä¹ ç½‘ç«™ï¼Œå»ºè®®å…ˆåœ¨ç½‘ç«™ä¸Šè°ƒè¯•å‡ºè‡ªå·±æƒ³è¦çš„æ•ˆæœï¼Œå†å°è¯•åœ¨ç¨‹åºä¸­æ„é€  option å¯¹è±¡ï¼š

![img](assets/SzVZt2Q9pjXkuCCp.webp)

ECharts å‚æ•°å¯èƒ½éå¸¸å¤šï¼Œå»ºè®®ä½¿ç”¨ AI å·¥å…·æ­é…å®˜æ–¹æ–‡æ¡£å»äº†è§£ï¼Œæ¯”å¦‚è®© AI å¸®å¿™è§£é‡Š option å„ä¸ªå‚æ•°çš„å«ä¹‰ï¼Œæˆ–è€…æ ¹æ®åç«¯æ¥å£è¿”å›å€¼æ¥ç”Ÿæˆ option é€‰é¡¹ã€‚

![img](assets/PZIdTzhamJ76RyRQ.webp)

### å¼€å‘åˆ†æç»„ä»¶

ç”±äºåˆ†æéœ€æ±‚è¾ƒå¤šï¼Œå¦‚æœéƒ½åœ¨ä¸€ä¸ªé¡µé¢ä¸­ç¼–å†™æ‰€æœ‰çš„åˆ†æç»„ä»¶ä»£ç ï¼Œä¼šè®©é¡µé¢è¿‡äºå¤æ‚ã€‚æ‰€ä»¥æˆ‘ä»¬æŠŠæ¯ä¸ªåˆ†æéœ€æ±‚çš„å›¾è¡¨å±•ç¤ºå’Œæ•°æ®è·å–é€»è¾‘éƒ½å°è£…ä¸ºä¸€ä¸ªç‹¬ç«‹çš„ç»„ä»¶ï¼Œç»Ÿä¸€æ”¾åœ¨ `components/analyze` ç›®å½•ä¸‹ï¼Œä¹‹ååˆ†æé¡µé¢ï¼ˆçˆ¶é¡µé¢ï¼‰å¼•å…¥è¿™äº›ç»„ä»¶å³å¯ã€‚

æ¯ä¸ªç»„ä»¶çš„å¼€å‘æ¨¡å¼éƒ½æ˜¯ç±»ä¼¼çš„ï¼Œå…ˆå®šä¹‰å±æ€§ï¼Œæ¯ä¸ªç»„ä»¶éƒ½è¦æ¥å—çˆ¶ç»„ä»¶ä¼ æ¥çš„æŸ¥è¯¢èŒƒå›´å‚æ•°ï¼Œè¿™æ ·çˆ¶é¡µé¢å¯ä»¥çµæ´»æŒ‡å®šè¦æŸ¥è¯¢çš„ç©ºé—´èŒƒå›´ï¼Œå¹¶ç»Ÿä¸€è®©æ‰€æœ‰åˆ†æå›¾è¡¨é‡æ–°åŠ è½½ã€‚

```typescript
interface Props {
  queryAll?: boolean
  queryPublic?: boolean
  spaceId?: number
}

const props = withDefaults(defineProps<Props>(), {
  queryAll: false,
  queryPublic: false,
})
```

æ¯ä¸ªç»„ä»¶çš„æ ·å¼é£æ ¼å¯ä»¥ç»Ÿä¸€ï¼Œæ¯”å¦‚éƒ½ç”¨å¡ç‰‡è¿›è¡ŒåŒ…è£…ã€æŒ‡å®šæœ€å¤§é«˜åº¦ã€ç»™å›¾è¡¨åº”ç”¨ loading æ•ˆæœï¼š

```vue
<template>
  <div class="space-xxx-analyze">
    <a-card title="åˆ†æéœ€æ±‚åç§°">
      <v-chart :option="options" style="height: 320px" :loading="loading" />
    </a-card>
  </div>
</template>
```

æ¯ä¸ªç»„ä»¶ä¹Ÿéƒ½éœ€è¦åœ¨åŠ è½½æ—¶è°ƒç”¨åç«¯æ¥å£è·å–æ•°æ®ï¼Œå¹¶ä¸”è®¡ç®—å±•ç¤ºå›¾è¡¨éœ€è¦çš„ optionï¼Œä¸åŒçš„éœ€æ±‚å¯¹åº”çš„ä»£ç ä¸åŒï¼Œéœ€è¦å®šåˆ¶å¼€å‘ã€‚

#### 1ã€ç©ºé—´èµ„æºä½¿ç”¨åˆ†æ

é€šè¿‡ç»Ÿè®¡å½“å‰ç©ºé—´å·²ä½¿ç”¨å¤§å°ä¸æ€»é…é¢çš„æ¯”ä¾‹ï¼Œä»¥åŠå›¾ç‰‡æ•°é‡ä¸æœ€å¤§å…è®¸æ•°é‡çš„å æ¯”ï¼Œå¸®åŠ©ç”¨æˆ·ç›´è§‚äº†è§£ç©ºé—´ä½¿ç”¨çŠ¶æ€ï¼ŒåŠæ—¶æ¸…ç†æˆ–å‡çº§ç©ºé—´ã€‚å›¾è¡¨å½¢å¼æ¨èä½¿ç”¨ **ä»ªè¡¨ç›˜** æ¥å±•ç¤ºæ¯”ä¾‹ï¼Œç±»ä¼¼è¿›åº¦æ¡ï¼Œå¯ä»¥æ›´ç›´è§‚åœ°äº†è§£æ¯”ä¾‹ã€‚

æˆ‘ä»¬ä½¿ç”¨çš„ Ant Design ç»„ä»¶åº“ä¸­å°±è‡ªå¸¦äº† [è¿›åº¦æ¡ç»„ä»¶](https://antdv.com/components/progress-cn)ï¼Œæ”¯æŒä»ªè¡¨ç›˜çš„å±•ç¤ºæ–¹å¼ï¼Œæ— éœ€ä½¿ç”¨ EChartsã€‚

1ï¼‰ç¼–å†™è·å–æ•°æ®çš„é€»è¾‘ï¼š

```typescript
// å›¾è¡¨æ•°æ®
const data = ref<API.SpaceUsageAnalyzeResponse>({})
const loading = ref(true)

/**
 * åŠ è½½æ•°æ®
 */
const fetchData = async () => {
  loading.value = true
  const res = await getSpaceUsageAnalyzeUsingPost({
    queryAll: props.queryAll,
    queryPublic: props.queryPublic,
    spaceId: props.spaceId,
  })
  if (res.data.code === 0 && res.data.data) {
    data.value = res.data.data
  } else {
    message.error('è·å–æ•°æ®å¤±è´¥ï¼Œ' + res.data.message)
  }
  loading.value = false
}

/**
 * ç›‘å¬å˜é‡ï¼Œæ”¹å˜æ—¶è§¦å‘æ•°æ®çš„é‡æ–°åŠ è½½
 */
watchEffect(() => {
  fetchData()
})
```

å’Œä¹‹å‰ä¸åŒçš„æ˜¯ï¼Œä¸ºäº†è®©ç»„ä»¶çš„å±æ€§å˜åŒ–æ—¶é‡æ–°åŠ è½½å›¾è¡¨ï¼Œæˆ‘ä»¬ä½¿ç”¨ watchEffect æ¥ç›‘å¬æ‰€æœ‰åŠ¨æ€å˜é‡ï¼Œåªè¦æœ‰ä»»ä½•ä¸€ä¸ªå€¼å‘ç”Ÿå˜åŒ–ï¼Œéƒ½ä¼šé‡æ–°æ‰§è¡Œå°è£…çš„å‡½æ•°ã€‚

2ï¼‰ç¼–å†™å›¾è¡¨ç»“æ„ã€‚è¯¥ç»„ä»¶è¦å±•ç¤ºå­˜å‚¨ç©ºé—´ä½¿ç”¨æ¯”ä¾‹å’Œå›¾ç‰‡æ•°é‡ä½¿ç”¨æ¯”ä¾‹ï¼Œå› æ­¤é‡‡ç”¨ä¸€è¡Œä¸¤åˆ—çš„ [Flex å¸ƒå±€](https://antdv.com/components/flex-cn)ï¼š

```vue
<a-flex gap="middle">
  <a-card title="å­˜å‚¨ç©ºé—´" style="width: 50%">
    <div style="height: 320px; text-align: center">
      <h3>{{ formatSize(data.usedSize) }} / {{ data.maxSize ? formatSize(data.maxSize) : 'æ— é™åˆ¶' }}</h3>
      <a-progress type="dashboard" :percent="data.sizeUsageRatio ?? 0" />
    </div>
  </a-card>
  <a-card title="å›¾ç‰‡æ•°é‡" style="width: 50%">
    <div style="height: 320px; text-align: center">
      <h3>{{ data.usedCount }} / {{ data.maxCount ?? 'æ— é™åˆ¶' }} </h3>
      <a-progress type="dashboard" :percent="data.countUsageRatio ?? 0" />
    </div>
  </a-card>
</a-flex>
```

æ³¨æ„ï¼Œè¦ç»™ percent ç™¾åˆ†æ¯”çš„å€¼è®¾ç½®é»˜è®¤å€¼ï¼Œå¦åˆ™ä¼šå½±å“é¡µé¢çš„åŠ è½½ã€‚

æ•ˆæœå¦‚å›¾ï¼š

![img](assets/US1Rmry14kWx5Pkr.webp)

#### 2ã€ç©ºé—´å›¾ç‰‡åˆ†ç±»åˆ†æ

ç»Ÿè®¡ä¸åŒåˆ†ç±»ä¸‹å›¾ç‰‡çš„æ•°é‡å’Œæ€»å¤§å°å æ¯”ï¼Œå¸®åŠ©ç”¨æˆ·æ¸…æ™°äº†è§£å„åˆ†ç±»çš„èµ„æºåˆ†å¸ƒï¼Œä¼˜åŒ–å­˜å‚¨ç­–ç•¥ã€‚ç”±äºåŒä¸€ä¸ªåˆ†ç±»è¦å±•ç¤ºå¤šä¸ªä¿¡æ¯ï¼Œå¯ä»¥é€‰æ‹© **åˆ†ç»„æ¡å½¢å›¾** æ¥å±•ç¤ºã€‚

1ï¼‰ç¼–å†™è·å–æ•°æ®çš„é€»è¾‘ï¼š

```typescript
// å›¾è¡¨æ•°æ®
const dataList = ref<API.SpaceCategoryAnalyzeResponse[]>([])
const loading = ref(true)

/**
 * åŠ è½½æ•°æ®
 */
const fetchData = async () => {
  loading.value = true
  const res = await getSpaceCategoryAnalyzeUsingPost({
    queryAll: props.queryAll,
    queryPublic: props.queryPublic,
    spaceId: props.spaceId,
  })
  if (res.data.code === 0) {
    dataList.value = res.data.data ?? []
  } else {
    message.error('è·å–æ•°æ®å¤±è´¥ï¼Œ' + res.data.message)
  }
  loading.value = false
}
```

2ï¼‰ç¼–å†™å›¾è¡¨ç»“æ„ï¼š

```vue
<div class="space-category-analyze">
  <a-card title="å›¾åº“åˆ†ç±»å ç”¨">
      <v-chart :option="options" style="height: 320px; max-width: 100%;" :loading="loading" />
  </a-card>
</div>
```

3ï¼‰ç¼–å†™å›¾è¡¨é€‰é¡¹ã€‚æ³¨æ„ï¼Œç”±äº dataList æ˜¯æœ‰ä¸€ä¸ªåŠ è½½è¿‡ç¨‹çš„ï¼Œè¦ä½¿ç”¨ `computed` è®¡ç®—å±æ€§ï¼Œå§‹ç»ˆæ ¹æ® dataList çš„å€¼æ¥è®¡ç®—é€‰é¡¹ï¼š

```typescript
const options = computed(() => {
  const categories = dataList.value.map((item) => item.category)
  const countData = dataList.value.map((item) => item.count)
  const sizeData = dataList.value.map((item) => (item.totalSize / (1024 * 1024)).toFixed(2)) // è½¬ä¸º MB

  return {
    tooltip: { trigger: 'axis' },
    legend: { data: ['å›¾ç‰‡æ•°é‡', 'å›¾ç‰‡æ€»å¤§å°'], top: 'bottom' },
    xAxis: { type: 'category', data: categories },
    yAxis: [
      {
        type: 'value',
        name: 'å›¾ç‰‡æ•°é‡',
        axisLine: { show: true, lineStyle: { color: '#5470C6' } }, // å·¦è½´é¢œè‰²
      },
      {
        type: 'value',
        name: 'å›¾ç‰‡æ€»å¤§å° (MB)',
        position: 'right',
        axisLine: { show: true, lineStyle: { color: '#91CC75' } }, // å³è½´é¢œè‰²
        splitLine: {
          lineStyle: {
            color: '#91CC75', // è°ƒæ•´ç½‘æ ¼çº¿é¢œè‰²
            type: 'dashed', // çº¿æ¡æ ·å¼ï¼šå¯é€‰ 'solid', 'dashed', 'dotted'
          },
        },
      },
    ],
    series: [
      { name: 'å›¾ç‰‡æ•°é‡', type: 'bar', data: countData, yAxisIndex: 0 },
      { name: 'å›¾ç‰‡æ€»å¤§å°', type: 'bar', data: sizeData, yAxisIndex: 1 },
    ],
  }
})
```

ğŸ’¡ è¿™æ®µé€‰é¡¹ä»£ç å®Œå…¨å¯ä»¥å…ˆåˆ©ç”¨ AI ç”Ÿæˆï¼Œå†æ ¹æ®è‡ªå·±çš„éœ€æ±‚å¾®è°ƒæ ·å¼ã€‚

æ•ˆæœå¦‚å›¾ï¼š

![img](assets/stztjeXt3HZfxOf1.webp)

#### 3ã€ç©ºé—´å›¾ç‰‡æ ‡ç­¾åˆ†æ

è§£æç”¨æˆ·å›¾åº“ä¸­çš„æ ‡ç­¾ï¼Œç»Ÿè®¡æ¯ä¸ªæ ‡ç­¾çš„å…³è”å›¾ç‰‡æ•°é‡ã€‚ç”±äºæ ‡ç­¾æ¯”è¾ƒå¤šï¼Œå¯ä»¥ç”¨ **è¯äº‘å›¾** å±•ç¤ºæ‰€æœ‰çš„æ ‡ç­¾ï¼Œå¹¶çªå‡ºå¸¸ç”¨æ ‡ç­¾ï¼Œä¾¿äºä¼˜åŒ–ç®¡ç†å’Œå›¾ç‰‡æœç´¢ã€‚

æ³¨æ„ï¼ŒApache ECharts é»˜è®¤ä¸ä¼šå¼•å…¥è¯äº‘å›¾ç»„ä»¶ï¼Œéœ€è¦æˆ‘ä»¬å®‰è£… [è¯äº‘å›¾](https://github.com/ecomfe/echarts-wordcloud) ä¾èµ–å¹¶å¼•å…¥ï¼š

```typescript
import VChart from 'vue-echarts'
import 'echarts'
import 'echarts-wordcloud'
```

1ï¼‰ç¼–å†™è·å–æ•°æ®çš„é€»è¾‘ï¼š

```typescript
const fetchData = async () => {
  loading.value = true
  const res = await getSpaceTagAnalyzeUsingPost({
    queryAll: props.queryAll,
    queryPublic: props.queryPublic,
    spaceId: props.spaceId,
  })
  if (res.data.code === 0) {
    dataList.value = res.data.data ?? []
  } else {
    message.error('è·å–æ•°æ®å¤±è´¥ï¼Œ' + res.data.message)
  }
  loading.value = false
}
```

2ï¼‰ç¼–å†™å›¾è¡¨ç»“æ„ï¼š

```vue
<div class="space-tag-analyze">
  <a-card title="å›¾åº“æ ‡ç­¾è¯äº‘">
    <v-chart :option="options" style="height: 320px; max-width: 100%;" :loading="loading" />
  </a-card>
</div>
```

3ï¼‰ç¼–å†™å›¾è¡¨é€‰é¡¹ï¼š

```typescript
const options = computed(() => {
  const tagData = dataList.value.map((item) => ({
    name: item.tag,
    value: item.count,
  }))

  return {
    tooltip: {
      trigger: 'item',
      formatter: (params: any) => `${params.name}: ${params.value} æ¬¡`,
    },
    series: [
      {
        type: 'wordCloud',
        gridSize: 10,
        sizeRange: [12, 50], // å­—ä½“å¤§å°èŒƒå›´
        rotationRange: [-90, 90],
        shape: 'circle',
        textStyle: {
          color: () =>
            `rgb(${Math.round(Math.random() * 255)}, ${Math.round(
              Math.random() * 255,
            )}, ${Math.round(Math.random() * 255)})`, // éšæœºé¢œè‰²
        },
        data: tagData,
      },
    ],
  }
})
```

æ•ˆæœå¦‚å›¾ï¼š

![img](assets/SwMXoezwkS2arGOR.webp)

#### 4ã€ç©ºé—´å›¾ç‰‡å¤§å°åˆ†æ

æŒ‰å›¾ç‰‡å¤§å°ï¼ˆå¦‚ <100 KBã€100 KB-1 MBã€>1 MBï¼‰åˆ†æ®µç»Ÿè®¡å›¾ç‰‡æ•°é‡ï¼Œå¸®åŠ©ç”¨æˆ·è¯†åˆ«å¤§ä½“ç§¯å›¾ç‰‡ï¼Œåˆç†åˆ†é…å­˜å‚¨èµ„æºã€‚ç”±äºæŒ‰å›¾ç‰‡å¤§å°åˆ†ç±»çš„æ•°é‡ä¸å¤šï¼Œå¯ä»¥ä½¿ç”¨ **é¥¼å›¾** å±•ç¤ºï¼Œèƒ½å¤Ÿä½“ç°æ¯ç±»å¤§å°å›¾ç‰‡çš„æ•°é‡å æ¯”ã€‚

1ï¼‰ç¼–å†™è·å–æ•°æ®çš„é€»è¾‘ï¼š

```typescript
const fetchData = async () => {
  loading.value = true
  const res = await getSpaceSizeAnalyzeUsingPost({
    queryAll: props.queryAll,
    queryPublic: props.queryPublic,
    spaceId: props.spaceId,
  })
  if (res.data.code === 0) {
    dataList.value = res.data.data ?? []
  } else {
    message.error('è·å–æ•°æ®å¤±è´¥ï¼Œ' + res.data.message)
  }
  loading.value = false
}
```

2ï¼‰ç¼–å†™å›¾è¡¨ç»“æ„ï¼š

```vue
<div class="space-size-analyze">
  <a-card title="ç©ºé—´å›¾ç‰‡å¤§å°åˆ†æ">
    <v-chart :option="options" style="height: 320px; max-width: 100%" :loading="loading" />
  </a-card>
</div>
```

3ï¼‰ç¼–å†™å›¾è¡¨é€‰é¡¹ï¼š

```typescript
const options = computed(() => {
  const pieData = dataList.value.map((item) => ({
    name: item.sizeRange,
    value: item.count,
  }))

  return {
    tooltip: {
      trigger: 'item',
      formatter: '{a} <br/>{b}: {c} ({d}%)',
    },
    legend: {
      top: 'bottom',
    },
    series: [
      {
        name: 'å›¾ç‰‡å¤§å°',
        type: 'pie',
        radius: '50%',
        data: pieData,
      },
    ],
  }
})
```

æ•ˆæœå¦‚å›¾ï¼š

![img](assets/P0pggEqfCrmFVuSD.webp)

#### 5ã€ç”¨æˆ·ä¸Šä¼ è¡Œä¸ºåˆ†æ

ç»Ÿè®¡ç”¨æˆ·æ¯æœˆã€æ¯å‘¨ã€æ¯æ—¥ä¸Šä¼ å›¾ç‰‡çš„æ•°é‡è¶‹åŠ¿ï¼Œå¸®åŠ©ç”¨æˆ·è¯†åˆ«ä¸Šä¼ é«˜å³°æœŸå¹¶ä¼˜åŒ–ç®¡ç†ç­–ç•¥ï¼Œæ¨èä½¿ç”¨ **æŠ˜çº¿å›¾** å‘ˆç°æ—¶é—´åºåˆ—è¶‹åŠ¿ã€‚

1ï¼‰ç¼–å†™è·å–æ•°æ®çš„é€»è¾‘ï¼š

```typescript
const fetchData = async () => {
  loading.value = true
  const res = await getSpaceUserAnalyzeUsingPost({
    queryAll: props.queryAll,
    queryPublic: props.queryPublic,
    spaceId: props.spaceId,
    timeDimension: timeDimension.value,
    userId: userId.value,
  })
  if (res.data.code === 0) {
    dataList.value = res.data.data ?? []
  } else {
    message.error('è·å–æ•°æ®å¤±è´¥ï¼Œ' + res.data.message)
  }
  loading.value = false
}
```

2ï¼‰ç¼–å†™å›¾è¡¨ç»“æ„ï¼š

```typescript
<div class="space-user-analyze">
  <a-card title="ç©ºé—´å›¾ç‰‡ç”¨æˆ·åˆ†æ">
    <v-chart :option="options" style="height: 320px; max-width: 100%" :loading="loading" />
  </a-card>
</div>
```

3ï¼‰ç¼–å†™å›¾è¡¨é€‰é¡¹ï¼š

```typescript
const options = computed(() => {
  const periods = dataList.value.map((item) => item.period) // æ—¶é—´åŒºé—´
  const counts = dataList.value.map((item) => item.count) // ä¸Šä¼ æ•°é‡

  return {
    tooltip: { trigger: 'axis' },
    xAxis: { type: 'category', data: periods, name: 'æ—¶é—´åŒºé—´' },
    yAxis: { type: 'value', name: 'ä¸Šä¼ æ•°é‡' },
    series: [
      {
        name: 'ä¸Šä¼ æ•°é‡',
        type: 'line',
        data: counts,
        smooth: true, // å¹³æ»‘æŠ˜çº¿
        emphasis: {
          focus: 'series',
        },
      },
    ],
  }
})
```

4ï¼‰æ”¯æŒç”¨æˆ·é€‰æ‹©ç»Ÿè®¡çš„æ—¶é—´èŒƒå›´ï¼ˆæ—¥ / å‘¨ / æœˆï¼‰å¹¶æŒ‰ç…§ç”¨æˆ· id ç­›é€‰ã€‚

å…ˆå¼€å‘é¡µé¢ç»“æ„ï¼Œå¯ä»¥åˆ©ç”¨ [Card ç»„ä»¶](https://antdv.com/components/card-cn) çš„æ’æ§½åŠŸèƒ½ï¼Œåœ¨å¡ç‰‡æ ‡é¢˜çš„å³ä¾§å±•ç¤ºæœç´¢è¡¨å•ï¼š

```vue
<a-card title="ç”¨æˆ·ä¸Šä¼ åˆ†æ">
  <v-chart :option="options" style="height: 320px" />
  <template #extra>
    <a-space>
      <a-segmented v-model:value="timeDimension" :options="timeDimensionOptions" />
      <a-input-search placeholder="è¯·è¾“å…¥ç”¨æˆ· id" enter-button="æœç´¢ç”¨æˆ·" @search="doSearch" />
    </a-space>
  </template>
</a-card>
```

å®šä¹‰å˜é‡ï¼Œç”¨äºæ¥å—è¡¨å•é¡¹çš„è¾“å…¥å€¼ï¼Œå¹¶ä¸”ç»™ä¸‹æ‹‰é€‰æ‹©è¡¨å•æä¾›é»˜è®¤é€‰é¡¹ï¼š

```typescript
const userId = ref<string>()
const timeDimension = ref<string>('day')
const timeDimensionOptions = [
  {
    label: 'æ—¥',
    value: 'day',
  },
  {
    label: 'å‘¨',
    value: 'week',
  },
  {
    label: 'æœˆ',
    value: 'month',
  },
]
```

ç¼–å†™æäº¤è¡¨å•çš„å‡½æ•°ï¼Œç‚¹å‡»æœç´¢æ—¶æ›´æ”¹ userId çš„å€¼ï¼š

```typescript
const doSearch = (value: string) => {
  userId.value = value
}
```

æœ€åï¼Œè¡¥å……æœç´¢æ¡ä»¶åˆ°è·å–æ•°æ®çš„å‡½æ•°ä¸­ï¼Œåªè¦å±æ€§æˆ–è€…é€‰é¡¹çš„å€¼å‘ç”Ÿäº†ä¿®æ”¹ï¼Œç«‹åˆ»å°±ä¼šé‡æ–°åŠ è½½ï¼š

```typescript
const res = await getSpaceUserAnalyzeUsingPost({
  queryAll: props.queryAll,
  queryPublic: props.queryPublic,
  spaceId: props.spaceId,
  timeDimension: timeDimension.value,
  userId: userId.value,
})
```

æ•ˆæœå¦‚å›¾ï¼š

![img](assets/9gEXaDDpKTWTjIuc.webp)

#### 6ã€ç©ºé—´ä½¿ç”¨æ’è¡Œåˆ†æ

æŒ‰å­˜å‚¨ä½¿ç”¨é‡æ’åºï¼Œç»Ÿè®¡å ç”¨å­˜å‚¨æœ€å¤šçš„å‰ N ä¸ªç©ºé—´ï¼Œå¸®åŠ©ç®¡ç†å‘˜å¿«é€Ÿå®šä½é«˜å ç”¨ç©ºé—´ï¼Œå¹¶è¯†åˆ«æ½œåœ¨çš„èµ„æºæ»¥ç”¨æˆ–å¼‚å¸¸æƒ…å†µã€‚å¯ä»¥é€‰ç”¨ **æŸ±çŠ¶å›¾**ï¼Œç›´è§‚åœ°å±•ç¤ºæ’åå’Œå­˜å‚¨ä½¿ç”¨é‡ã€‚

1ï¼‰ç¼–å†™è·å–æ•°æ®çš„é€»è¾‘ï¼š

```typescript
const fetchData = async () => {
  loading.value = true
  const res = await getSpaceRankAnalyzeUsingPost({
    queryAll: props.queryAll,
    queryPublic: props.queryPublic,
    spaceId: props.spaceId,
  })
  if (res.data.code === 0) {
    dataList.value = res.data.data ?? []
  } else {
    message.error('è·å–æ•°æ®å¤±è´¥ï¼Œ' + res.data.message)
  }
  loading.value = false
}
```

å¯ä»¥åƒå¼€å‘ç”¨æˆ·ä¸Šä¼ è¡Œä¸ºåˆ†æå›¾è¡¨ä¸€æ ·ï¼Œå¢åŠ ä¸€ä¸ªä¿®æ”¹ topN æŸ¥è¯¢æ¡æ•°çš„è¡¨å•é¡¹ã€‚è¿™é‡Œæˆ‘ä»¬ç®€å•ä¸€ç‚¹ï¼Œå°±å…ˆä¸ä¼  topNï¼Œåç«¯ä¼šå¡«å……é»˜è®¤å€¼ï¼ˆ10 æ¡ï¼‰ã€‚

2ï¼‰ç¼–å†™å›¾è¡¨ç»“æ„ï¼š

```vue
<div class="space-rank-analyze">
  <a-card title="ç©ºé—´ä½¿ç”¨æ’è¡Œ">
    <v-chart :option="options" style="height: 320px" />
  </a-card>
</div>
```

3ï¼‰ç¼–å†™å›¾è¡¨é€‰é¡¹ï¼š

```typescript
const options = computed(() => {
  const spaceNames = dataList.value.map((item) => item.spaceName)
  const usageData = dataList.value.map((item) => (item.totalSize / (1024 * 1024)).toFixed(2)) // è½¬ä¸º MB

  return {
    tooltip: { trigger: 'axis' },
    xAxis: {
      type: 'category',
      data: spaceNames,
    },
    yAxis: {
      type: 'value',
      name: 'ç©ºé—´ä½¿ç”¨é‡ (MB)',
    },
    series: [
      {
        name: 'ç©ºé—´ä½¿ç”¨é‡ (MB)',
        type: 'bar',
        data: usageData,
        itemStyle: {
          color: '#5470C6', // è‡ªå®šä¹‰æŸ±çŠ¶å›¾é¢œè‰²
        },
      },
    ],
  }
})
```

æ•ˆæœå¦‚å›¾ï¼š

![img](assets/P7cCYJh7hRTUFNRr.webp)

### å¼€å‘åˆ†æé¡µé¢

æ–°å»ºä¸€ä¸ªåˆ†æé¡µé¢ï¼Œæ‰€æœ‰å›¾è¡¨ç»„ä»¶éƒ½æ”¾åˆ°è¯¥é¡µé¢ä¸­ã€‚å¯ä»¥é€šè¿‡ URL æŸ¥è¯¢å‚æ•°æ¥è§¦å‘ä¸åŒèŒƒå›´çš„æŸ¥è¯¢ï¼Œæ¯”å¦‚åˆ†ææŸä¸ªç‰¹å®šç©ºé—´ï¼ˆspaceId=xxxï¼‰ã€åˆ†æå…¬å…±å›¾åº“ï¼ˆqueryPublic=1ï¼‰ã€åˆ†æå…¨éƒ¨ç©ºé—´ï¼ˆqueryAll=1ï¼‰ã€‚è¿™æ ·æ— è®ºæ˜¯ç®¡ç†å‘˜åˆ†æå…¨ç©ºé—´ / å…¬å…±å›¾åº“ï¼Œè¿˜æ˜¯ç”¨æˆ·åˆ†ææŸä¸ªç©ºé—´ï¼Œéƒ½å¯ä»¥å¤ç”¨è¯¥é¡µé¢ã€‚

1ï¼‰æ–°å»ºé¡µé¢æ–‡ä»¶å’Œè·¯ç”±ï¼š

```typescript
{
  path: '/space_analyze',
  name: 'ç©ºé—´åˆ†æ',
  component: SpaceAnalyzePage,
}
```

2ï¼‰å¼€å‘é¡µé¢ï¼Œå…ˆå®šä¹‰æŸ¥è¯¢èŒƒå›´å‚æ•°ï¼Œä» URL æŸ¥è¯¢å‚æ•°ä¸­è·å–ï¼š

```typescript
const route = useRoute()

// ç©ºé—´ id
const spaceId = computed(() => {
  return route.query?.spaceId as string
})

// æ˜¯å¦æŸ¥è¯¢æ‰€æœ‰ç©ºé—´
const queryAll = computed(() => {
  return !!route.query?.queryAll
})

// æ˜¯å¦æŸ¥è¯¢å…¬å…±ç©ºé—´
const queryPublic = computed(() => {
  return !!route.query?.queryPublic
})
```

3ï¼‰å¼€å‘é¡µé¢ç»“æ„ï¼Œå¼•å…¥ç»„ä»¶ï¼Œå¹¶ä½¿ç”¨æ …æ ¼ç³»ç»Ÿä¸€è¡Œä¸¤åˆ—å¸ƒå±€ï¼š

```vue
<div id="spaceAnalyzePage">
  <h2>
    ç©ºé—´å›¾åº“åˆ†æ -
    <span v-if="queryAll"> å…¨éƒ¨ç©ºé—´ </span>
    <span v-else-if="queryPublic"> å…¬å…±å›¾åº“ </span>
    <span v-else>
      <a :href="`/space/${spaceId}`" target="_blank">idï¼š{{ spaceId }}</a>
    </span>
  </h2>
  <a-row :gutter="[16, 16]">
    <!-- ç©ºé—´ä½¿ç”¨åˆ†æ -->
    <a-col :xs="24" :md="12">
      <SpaceUsageAnalyze :spaceId="spaceId" :queryAll="queryAll" :queryPublic="queryPublic" />
    </a-col>
    <!-- ç©ºé—´åˆ†ç±»åˆ†æ -->
    <a-col :xs="24" :md="12">
      <SpaceCategoryAnalyze :spaceId="spaceId" :queryAll="queryAll" :queryPublic="queryPublic" />
    </a-col>
    <!-- æ ‡ç­¾åˆ†æ -->
    <a-col :xs="24" :md="12">
      <SpaceTagAnalyze :spaceId="spaceId" :queryAll="queryAll" :queryPublic="queryPublic" />
    </a-col>
    <!-- å›¾ç‰‡å¤§å°åˆ†æ®µåˆ†æ -->
    <a-col :xs="24" :md="12">
      <SpaceSizeAnalyze :spaceId="spaceId" :queryAll="queryAll" :queryPublic="queryPublic" />
    </a-col>
    <!-- ç”¨æˆ·ä¸Šä¼ è¡Œä¸ºåˆ†æ -->
    <a-col :xs="24" :md="12">
      <SpaceUserAnalyze :spaceId="spaceId" :queryAll="queryAll" :queryPublic="queryPublic" />
    </a-col>
    <!-- ç©ºé—´ä½¿ç”¨æ’è¡Œåˆ†æ -->
    <a-col :xs="24" :md="12">
      <SpaceRankAnalyze :spaceId="spaceId" :queryAll="queryAll" :queryPublic="queryPublic" />
    </a-col>
  </a-row>
</div>
```

4ï¼‰æƒé™æ§åˆ¶ï¼Œä»…ç®¡ç†å‘˜æ‰èƒ½çœ‹åˆ° â€œç©ºé—´ä½¿ç”¨æ’è¡Œåˆ†æâ€ã€‚

å…ˆå®šä¹‰æ˜¯å¦ä¸ºç®¡ç†å‘˜å˜é‡ï¼š

```typescript
const loginUserStore = useLoginUserStore()
const loginUser = loginUserStore.loginUser

const isAdmin = computed(() => {
  return loginUser.userRole === 'admin'
})
```

ç»„ä»¶æ·»åŠ  `v-if` å±æ€§ï¼š

```vue
<SpaceRankAnalyze v-if="isAdmin" 
  :spaceId="spaceId" 
  :queryAll="queryAll" 
  :queryPublic="queryPublic" 
/>
```

å…¶ä»–çš„æƒé™æ§åˆ¶åœ¨åç«¯å·²ç»å®ç°äº†ï¼Œæ¯”å¦‚æ™®é€šç”¨æˆ·ä¸èƒ½è®¿é—®å…¶ä»–äººçš„ç©ºé—´ï¼Œæ•ˆæœå¦‚å›¾ï¼š

![img](assets/BMW7uaf0dyuLxSpc.webp)

### è¡¥å……è·³è½¬å…¥å£

ç»™ç”¨æˆ·ç©ºé—´è¯¦æƒ…é¡µã€ç©ºé—´ç®¡ç†é¡µé¢å¢åŠ è·³è½¬åˆ°åˆ†æé¡µçš„å…¥å£ã€‚

1ï¼‰ç”¨æˆ·ç©ºé—´è¯¦æƒ…é¡µè¡¥å……ç©ºé—´åˆ†ææŒ‰é’®ï¼š

```vue
<a-button
  type="primary"
  ghost
  :icon="h(BarChartOutlined)"
  :href="`/space_analyze?spaceId=${id}`"
  target="_blank"
>
  ç©ºé—´åˆ†æ
</a-button>
```

æ•ˆæœå¦‚å›¾ï¼š

![img](assets/d25aFtxXydgdXI4S.webp)

2ï¼‰ç©ºé—´ç®¡ç†æ–°å¢å…¬å…±å›¾åº“åˆ†ææŒ‰é’®ã€å…¨ç©ºé—´åˆ†ææŒ‰é’®ï¼Œå¹¶ä¸”å¯ä»¥ç›´æ¥è·³è½¬åˆ°æŸä¸ªç‰¹å®šçš„ç©ºé—´åˆ†æé¡µã€‚

```vue
<a-space>
  <a-button type="primary" href="/add_space" target="_blank">+ åˆ›å»ºç©ºé—´</a-button>
  <a-button type="primary" ghost href="/space_analyze?queryPublic=1" target="_blank">
    åˆ†æå…¬å…±å›¾åº“
  </a-button>
  <a-button type="primary" ghost href="/space_analyze?queryAll=1" target="_blank">
    åˆ†æå…¨ç©ºé—´
  </a-button>
</a-space>
```

æ“ä½œæ è¡¥å……ï¼š

```vue
<a-button type="link" :href="`/space_analyze?spaceId=${record.id}`" target="_blank">
  åˆ†æ
</a-button>
```

æ•ˆæœå¦‚å›¾ï¼š

![img](assets/esq3lXhg9mFezS67.webp)

## äº”ã€æ‰©å±•

1ã€ç”¨æˆ·è¡Œä¸ºåˆ†ææ”¯æŒåŒç¯æ¯”åˆ†æï¼Œåœ¨åŒä¸€ä¸ªå›¾è¡¨ä¸­å±•ç¤ºä¸¤æ¡æŠ˜çº¿ï¼ˆæ¯”å¦‚ä¸€æ¡æ˜¯ä¸Šå‘¨çš„ï¼Œä¸€æ¡æ˜¯è¿™å‘¨çš„ï¼‰ã€‚

2ã€ã€å‰ç«¯ã€‘ç©ºé—´æ’ååˆ†æå›¾è¡¨ä¸­ï¼Œæ”¯æŒç‚¹å‡»æŸä¸ªç©ºé—´å¿«é€Ÿè·³è½¬æŸ¥çœ‹å•ä¸ªç©ºé—´è¯¦æƒ…

3ã€æ–°å¢åˆ†æéœ€æ±‚ï¼ŒæŒ‰ç…§ç©ºé—´çº§åˆ«å¯¹ç©ºé—´è¿›è¡Œåˆ†ç±»ç»Ÿè®¡ï¼Œåˆ†æä¸åŒçº§åˆ«ç©ºé—´çš„ä½¿ç”¨æƒ…å†µã€‚

4ã€æ–°å¢åˆ†æéœ€æ±‚ï¼Œç®¡ç†å‘˜å¯ä»¥å¯¹ç³»ç»Ÿå†…å›¾ç‰‡çš„å®¡æ ¸çŠ¶æ€è¿›è¡Œåˆ†ç±»ç»Ÿè®¡ï¼Œè¿˜å¯ä»¥æŒ‰æ—¶é—´ç»´åº¦åˆ†æå›¾ç‰‡å®¡æ ¸é‡çš„å˜åŒ–è¶‹åŠ¿ã€‚

5ã€æ–°å¢åˆ†æéœ€æ±‚ï¼Œç®¡ç†å‘˜å¯ä»¥æŒ‰æ—¶é—´ç»Ÿè®¡ç”¨æˆ·çš„ç™»å½•æ¬¡æ•°ã€å›¾ç‰‡ä¸Šä¼ é‡å’Œæ´»è·ƒåº¦çš„å˜åŒ–è¶‹åŠ¿ï¼Œå¸®åŠ©ç®¡ç†å‘˜è¯†åˆ«é«˜æ´»è·ƒç”¨æˆ·ï¼Œå¯¹ç”¨æˆ·è¿›è¡Œåˆ†å±‚ç®¡ç†ã€‚

------

è‡³æ­¤ï¼Œæœ¬é¡¹ç›®çš„ç¬¬äºŒé˜¶æ®µå°±ç»“æŸäº†ï¼Œè¿™ä¸ªé˜¶æ®µï¼Œæˆ‘ä»¬å­¦åˆ°äº†ç©ºé—´æ¨¡å—è®¾è®¡ã€å¤šç»´å›¾ç‰‡æœç´¢ã€AI å›¾ç‰‡ç¼–è¾‘ã€å›¾ç‰‡åˆ†æè¿™ä¸€æ•´å¥—çš„ä¸šåŠ¡æµç¨‹ï¼Œç°åœ¨ä½ å·²ç»èƒ½å¤Ÿç‹¬ç«‹å®Œæˆä¸€ä¸ªç½‘ç›˜ç³»ç»Ÿã€ç§äººç›¸å†Œã€ç§äººä½œå“é›†ã€ç§äººæ¡£æ¡ˆç½‘ç«™å•¦







# 11 - å›¢é˜Ÿç©ºé—´

## æœ¬èŠ‚é‡ç‚¹

ä»æœ¬èŠ‚å¼€å§‹æˆ‘ä»¬å°†è¿›è¡Œé¡¹ç›®ç¬¬ä¸‰é˜¶æ®µ â€”â€” å›¢é˜Ÿç©ºé—´çš„å¼€å‘ï¼Œè®©é¡¹ç›®èƒ½å¤Ÿé¢å‘ B ç«¯ï¼ˆä¼ä¸šï¼‰æä¾›æœåŠ¡ï¼Œæ¯”å¦‚ä½œä¸ºå›¢é˜Ÿå…±äº«ç´ æã€å›¢é˜Ÿæ´»åŠ¨ç›¸å†Œç­‰ï¼Œå¢å¼ºé¡¹ç›®çš„å•†ä¸šä»·å€¼ã€‚

æœ¬èŠ‚å…ˆç»™é¡¹ç›®å¢åŠ å›¢é˜Ÿå…±äº«ç©ºé—´çš„èƒ½åŠ›ï¼Œå¤§çº²ï¼š

- å›¢é˜Ÿç©ºé—´éœ€æ±‚åˆ†æ
- å›¢é˜Ÿç©ºé—´æ–¹æ¡ˆè®¾è®¡
- å›¢é˜Ÿç©ºé—´åç«¯å¼€å‘
- å›¢é˜Ÿç©ºé—´å‰ç«¯å¼€å‘

æœ¬èŠ‚å­¦å®Œåï¼Œä½ åº”è¯¥èƒ½å¤ŸæŒæ¡ä¸€ä¸ªå›¢é˜Ÿåä½œç³»ç»Ÿçš„æ–¹æ¡ˆè®¾è®¡å’Œå¼€å‘ã€‚

â­ï¸ å‹æƒ…æç¤ºï¼Œæœ¬èŠ‚æ¶‰åŠçš„åç«¯æ–°æŠ€æœ¯è¾ƒå¤šï¼Œå­¦ä¹ éš¾åº¦ç•¥å¤§ï¼Œè€Œä¸”ç»†èŠ‚å¾ˆå¤šï¼Œè¯·å‹¿å¿…ä»”ç»†å­¦ä¹ ï¼

## ä¸€ã€éœ€æ±‚åˆ†æ

ä¹‹å‰æˆ‘ä»¬å·²ç»å®Œæˆäº†ç§æœ‰ç©ºé—´æ¨¡å—ï¼Œå›¢é˜Ÿç©ºé—´å’Œå®ƒç±»ä¼¼ï¼Œæˆ‘ä»¬å¯ä»¥æ‹†åˆ†ä¸º 4 ä¸ªéœ€æ±‚ï¼š

1ï¼‰åˆ›å»ºå›¢é˜Ÿå…±äº«ç©ºé—´

ç”¨æˆ·å¯ä»¥åˆ›å»º **æœ€å¤šä¸€ä¸ª** å›¢é˜Ÿå…±äº«ç©ºé—´ï¼Œç”¨äºå›¢é˜Ÿåä½œå’Œèµ„æºå…±äº«ï¼Œç©ºé—´ç®¡ç†å‘˜æ‹¥æœ‰ç§æœ‰ç©ºé—´çš„æ‰€æœ‰èƒ½åŠ›ï¼ŒåŒ…æ‹¬è‡ªç”±ä¸Šä¼ å›¾ç‰‡ã€æ£€ç´¢å›¾ç‰‡ã€ç®¡ç†å›¾ç‰‡ã€åˆ†æç©ºé—´ç­‰ã€‚

2ï¼‰ç©ºé—´æˆå‘˜ç®¡ç†

- æˆå‘˜é‚€è¯·ï¼šç©ºé—´ç®¡ç†å‘˜å¯ä»¥é‚€è¯·æ–°æˆå‘˜åŠ å…¥å›¢é˜Ÿï¼Œå…±äº«ç©ºé—´å†…çš„å›¾ç‰‡ã€‚
- è®¾ç½®æƒé™ï¼šç©ºé—´ç®¡ç†å‘˜å¯ä»¥ä¸ºæˆå‘˜è®¾ç½®ä¸åŒçš„è§’è‰²ï¼ˆå¦‚æŸ¥çœ‹è€…ã€ç¼–è¾‘è€…ã€ç®¡ç†å‘˜ï¼‰ï¼Œæ§åˆ¶æˆå‘˜çš„æƒé™èŒƒå›´ã€‚

3ï¼‰ç©ºé—´æˆå‘˜æƒé™æ§åˆ¶ï¼šä»…ç‰¹å®šè§’è‰²çš„æˆå‘˜å¯è®¿é—®æˆ–æ“ä½œå›¢é˜Ÿç©ºé—´å†…çš„å›¾ç‰‡ã€‚

4ï¼‰ç©ºé—´æ•°æ®ç®¡ç†ï¼šè€ƒè™‘åˆ°å›¢é˜Ÿç©ºé—´çš„å›¾ç‰‡æ•°é‡å¯èƒ½æ¯”è¾ƒå¤šï¼Œå¯ä»¥å¯¹ç‰¹å®šç©ºé—´çš„æ•°æ®è¿›è¡Œå•ç‹¬çš„ç®¡ç†ï¼Œè€Œä¸æ˜¯å’Œå…¬å…±å›¾åº“ã€ç§æœ‰ç©ºé—´çš„å›¾ç‰‡æ··åœ¨ä¸€èµ·ã€‚

## äºŒã€æ–¹æ¡ˆè®¾è®¡

è®©æˆ‘ä»¬å…ˆä¾æ¬¡åˆ†æä¸Šè¿°éœ€æ±‚ï¼Œå¹¶æ€è€ƒå¯¹åº”çš„è§£å†³æ–¹æ¡ˆã€‚

### åˆ›å»ºå›¢é˜Ÿå…±äº«ç©ºé—´

ä¹‹å‰å·²ç»å¼€å‘äº†ç©ºé—´æ¨¡å—ï¼Œå›¢é˜Ÿç©ºé—´å¯ä»¥ç›´æ¥å¤ç”¨ç§æœ‰ç©ºé—´çš„å¤§å¤šæ•°èƒ½åŠ›ã€‚å› æ­¤å¯ä»¥ç»™ç©ºé—´è¡¨æ–°å¢ä¸€ä¸ª spaceType å­—æ®µï¼Œç”¨äºåŒºåˆ†ç§æœ‰å’Œå›¢é˜Ÿç©ºé—´ã€‚

```sql
ALTER TABLE space
    ADD COLUMN spaceType int default 0 not null comment 'ç©ºé—´ç±»å‹ï¼š0-ç§æœ‰ 1-å›¢é˜Ÿ';

CREATE INDEX idx_spaceType ON space (spaceType);
```

### ç©ºé—´æˆå‘˜ç®¡ç†

#### 1ã€ä¸šåŠ¡æµç¨‹

ä¸ºäº†è®©é¡¹ç›®æ›´å®¹æ˜“æ‰©å±•ï¼Œå‡å°‘åŸæœ‰ä»£ç çš„ä¿®æ”¹ï¼Œæˆ‘ä»¬çº¦å®š **åªæœ‰å›¢é˜Ÿç©ºé—´æ‰æœ‰æˆå‘˜çš„æ¦‚å¿µ**ã€‚

1ï¼‰æˆå‘˜é‚€è¯·ï¼šç©ºé—´ç®¡ç†å‘˜å¯ä»¥ç›´æ¥è¾“å…¥æˆå‘˜ id æ¥æ·»åŠ æ–°æˆå‘˜ï¼Œæ— éœ€è¯¥ç”¨æˆ·ç¡®è®¤ï¼Œè¿™æ ·å¯ä»¥æé«˜å¼€å‘æ•ˆç‡ã€‚

2ï¼‰è®¾ç½®æƒé™ï¼šç©ºé—´ç®¡ç†å‘˜å¯ä»¥ä¸ºå·²åŠ å…¥æˆå‘˜è®¾ç½®ä¸åŒçš„è§’è‰²ï¼Œæ§åˆ¶æˆå‘˜çš„æƒé™èŒƒå›´ï¼Œç±»ä¼¼äºç¼–è¾‘æˆå‘˜ä¿¡æ¯ã€‚

#### 2ã€åº“è¡¨è®¾è®¡

ç”±äºç©ºé—´å’Œç”¨æˆ·æ˜¯å¤šå¯¹å¤šçš„å…³ç³»ï¼Œè¿˜è¦åŒæ—¶è®°å½•ç”¨æˆ·åœ¨æŸç©ºé—´çš„è§’è‰²ï¼Œæ‰€ä»¥éœ€è¦æ–°å»ºå…³è”è¡¨ï¼š

```sql
-- ç©ºé—´æˆå‘˜è¡¨
create table if not exists space_user
(
    id         bigint auto_increment comment 'id' primary key,
    spaceId    bigint                                 not null comment 'ç©ºé—´ id',
    userId     bigint                                 not null comment 'ç”¨æˆ· id',
    spaceRole  varchar(128) default 'viewer'          null comment 'ç©ºé—´è§’è‰²ï¼šviewer/editor/admin',
    createTime datetime     default CURRENT_TIMESTAMP not null comment 'åˆ›å»ºæ—¶é—´',
    updateTime datetime     default CURRENT_TIMESTAMP not null on update CURRENT_TIMESTAMP comment 'æ›´æ–°æ—¶é—´',
    -- ç´¢å¼•è®¾è®¡
    UNIQUE KEY uk_spaceId_userId (spaceId, userId), -- å”¯ä¸€ç´¢å¼•ï¼Œç”¨æˆ·åœ¨ä¸€ä¸ªç©ºé—´ä¸­åªèƒ½æœ‰ä¸€ä¸ªè§’è‰²
    INDEX idx_spaceId (spaceId),                    -- æå‡æŒ‰ç©ºé—´æŸ¥è¯¢çš„æ€§èƒ½
    INDEX idx_userId (userId)                       -- æå‡æŒ‰ç”¨æˆ·æŸ¥è¯¢çš„æ€§èƒ½
) comment 'ç©ºé—´ç”¨æˆ·å…³è”' collate = utf8mb4_unicode_ci;
```

æ³¨æ„å‡ ä¸ªç»†èŠ‚ï¼š

1. ç»™ spaceId å’Œ userId æ·»åŠ å”¯ä¸€ç´¢å¼•ï¼Œç¡®ä¿åŒä¸€ç”¨æˆ·åœ¨åŒä¸€ç©ºé—´ä¸­åªèƒ½æœ‰ä¸€ä¸ªè§’è‰²ï¼ˆä¸èƒ½é‡å¤åŠ å…¥ï¼‰ã€‚ç”±äºæœ‰å”¯ä¸€é”®ï¼Œä¸éœ€è¦ä½¿ç”¨é€»è¾‘åˆ é™¤å­—æ®µï¼Œå¦åˆ™æ— æ³•é€€å‡ºåå†é‡æ–°åŠ å…¥ã€‚
2. ç»™å…³è”å­—æ®µæ·»åŠ ç´¢å¼•ï¼Œæé«˜æŸ¥è¯¢æ•ˆç‡
3. ä¸ºäº†è·Ÿç”¨æˆ·è‡ªèº«åœ¨é¡¹ç›®ä¸­çš„è§’è‰² userRole åŒºåˆ†å¼€ï¼Œç©ºé—´è§’è‰²çš„åç§°ä½¿ç”¨ spaceRole

**ä¸ºä¿è¯é€»è¾‘çš„ç»Ÿä¸€ï¼Œåˆ›å»ºå›¢é˜Ÿç©ºé—´æ—¶è¦è‡ªåŠ¨å°†åˆ›å»ºäººä½œä¸ºç©ºé—´ç®¡ç†å‘˜ï¼Œä¿å­˜åˆ°ç©ºé—´æˆå‘˜è¡¨ä¸­ã€‚**

### ç©ºé—´æˆå‘˜æƒé™æ§åˆ¶

ä»…ç‰¹å®šè§’è‰²çš„æˆå‘˜å¯è®¿é—®æˆ–æ“ä½œå›¢é˜Ÿç©ºé—´å†…çš„å›¾ç‰‡ã€‚

å›¢é˜Ÿç©ºé—´çš„æƒé™ç®¡ç†å¯æ¯”ç§æœ‰ç©ºé—´çš„æƒé™å¤æ‚å¤šäº†ï¼Œé™¤äº†åˆ›å»ºäººå¤–è¿˜æœ‰å…¶ä»–æˆå‘˜ï¼Œæ¶‰åŠåˆ°æŸ¥çœ‹å›¾ç‰‡ã€ä¸Šä¼ å›¾ç‰‡ã€ç®¡ç†ç©ºé—´å›¾ç‰‡ã€ç®¡ç†ç©ºé—´ç­‰å¤šç§ä¸åŒçš„æƒé™ã€‚

#### 1ã€RBAC æƒé™æ§åˆ¶

å¯¹äºå¤æ‚çš„æƒé™æ§åˆ¶åœºæ™¯ï¼Œæˆ‘ä»¬å¯ä»¥é‡‡ç”¨ç»å…¸çš„ RBAC æƒé™æ§åˆ¶æ¨¡å‹ï¼ˆåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼ŒRole-Based Access Controlï¼‰ï¼Œæ ¸å¿ƒæ¦‚å¿µåŒ…æ‹¬ **ç”¨æˆ·ã€è§’è‰²ã€æƒé™**ã€‚

- ä¸€ä¸ªç”¨æˆ·å¯ä»¥æœ‰å¤šä¸ªè§’è‰²
- ä¸€ä¸ªè§’è‰²å¯ä»¥æœ‰å¤šä¸ªæƒé™

è¿™æ ·ä¸€æ¥ï¼Œå°±å¯ä»¥çµæ´»åœ°é…ç½®ç”¨æˆ·å…·æœ‰çš„æƒé™äº†ã€‚

![image.png](assets/hZ8uB6fuHoKkNf5h.webp)

ä¸€èˆ¬æ¥è¯´ï¼Œæ ‡å‡†çš„ RBAC å®ç°éœ€è¦ 5 å¼ è¡¨ï¼šç”¨æˆ·è¡¨ã€è§’è‰²è¡¨ã€æƒé™è¡¨ã€ç”¨æˆ·è§’è‰²å…³è”è¡¨ã€è§’è‰²æƒé™å…³è”è¡¨ï¼Œè¿˜æ˜¯æœ‰ä¸€å®šå¼€å‘æˆæœ¬çš„ã€‚ç”±äºæˆ‘ä»¬çš„é¡¹ç›®ä¸­ï¼Œå›¢é˜Ÿç©ºé—´ä¸éœ€è¦é‚£ä¹ˆå¤šè§’è‰²ï¼Œå¯ä»¥ç®€åŒ– RBAC çš„å®ç°æ–¹å¼ï¼Œæ¯”å¦‚å°†è§’è‰²å’Œæƒé™ç›´æ¥å®šä¹‰åˆ°é…ç½®æ–‡ä»¶ä¸­ã€‚

#### 2ã€è§’è‰²å’Œæƒé™å®šä¹‰

æœ¬é¡¹ç›®çš„è§’è‰²ï¼š

| è§’è‰²   | æè¿°                         |
| ------ | ---------------------------- |
| æµè§ˆè€… | ä»…å¯æŸ¥çœ‹ç©ºé—´ä¸­çš„å›¾ç‰‡å†…å®¹     |
| ç¼–è¾‘è€… | å¯æŸ¥çœ‹ã€ä¸Šä¼ å’Œç¼–è¾‘å›¾ç‰‡å†…å®¹   |
| ç®¡ç†å‘˜ | æ‹¥æœ‰ç®¡ç†ç©ºé—´å’Œæˆå‘˜çš„æ‰€æœ‰æƒé™ |

æœ¬é¡¹ç›®çš„æƒé™ï¼š

| æƒé™é”®           | åŠŸèƒ½åç§° | æè¿°                         |
| ---------------- | -------- | ---------------------------- |
| spaceUser:manage | æˆå‘˜ç®¡ç† | ç®¡ç†ç©ºé—´æˆå‘˜ï¼Œæ·»åŠ æˆ–ç§»é™¤æˆå‘˜ |
| picture:view     | æŸ¥çœ‹å›¾ç‰‡ | æŸ¥çœ‹ç©ºé—´ä¸­çš„å›¾ç‰‡å†…å®¹         |
| picture:upload   | ä¸Šä¼ å›¾ç‰‡ | ä¸Šä¼ å›¾ç‰‡åˆ°ç©ºé—´ä¸­             |
| picture:edit     | ä¿®æ”¹å›¾ç‰‡ | ç¼–è¾‘å·²ä¸Šä¼ çš„å›¾ç‰‡ä¿¡æ¯         |
| picture:delete   | åˆ é™¤å›¾ç‰‡ | åˆ é™¤ç©ºé—´ä¸­çš„å›¾ç‰‡             |

è§’è‰²ä¸æƒé™æ˜ å°„ï¼š

| è§’è‰²   | å¯¹åº”æƒé™é”®                                                   | å¯æ‰§è¡ŒåŠŸèƒ½                                       |
| ------ | ------------------------------------------------------------ | ------------------------------------------------ |
| æµè§ˆè€… | picture:view                                                 | æŸ¥çœ‹å›¾ç‰‡                                         |
| ç¼–è¾‘è€… | picture:view, picture:upload, picture:edit, picture:delete   | æŸ¥çœ‹å›¾ç‰‡ã€ä¸Šä¼ å›¾ç‰‡ã€ä¿®æ”¹å›¾ç‰‡ã€åˆ é™¤å›¾ç‰‡           |
| ç®¡ç†å‘˜ | spaceUser:manage, picture:view, picture:upload, picture:edit, picture:delete | æˆå‘˜ç®¡ç†ã€æŸ¥çœ‹å›¾ç‰‡ã€ä¸Šä¼ å›¾ç‰‡ã€ä¿®æ”¹å›¾ç‰‡ã€åˆ é™¤å›¾ç‰‡ |

#### 3ã€æƒé™æ ¡éªŒå®ç°æ–¹æ¡ˆ

RBAC åªæ˜¯ä¸€ç§æƒé™è®¾è®¡æ¨¡å‹ï¼Œæˆ‘ä»¬åœ¨ Java ä»£ç ä¸­å¦‚ä½•å®ç°æƒé™æ ¡éªŒå‘¢ï¼Ÿ6vlRn/br/m8Ymr8D02hZYIBP3pqlW5Sp8qJklXCk9AY=

1ï¼‰æœ€ç›´æ¥çš„æ–¹æ¡ˆæ˜¯åƒä¹‹å‰æ ¡éªŒç§æœ‰ç©ºé—´æƒé™ä¸€æ ·ï¼Œå°è£…ä¸ªå›¢é˜Ÿç©ºé—´çš„æƒé™æ ¡éªŒæ–¹æ³•ï¼›æˆ–è€…ç±»ä¼¼ç”¨æˆ·æƒé™æ ¡éªŒä¸€æ ·ï¼Œå†™ä¸ªæ³¨è§£ + AOP åˆ‡é¢ã€‚

2ï¼‰å¯¹äºå¤æ‚çš„è§’è‰²å’Œæƒé™ç®¡ç†ï¼Œå¯ä»¥é€‰ç”¨ç°æˆçš„ç¬¬ä¸‰æ–¹æƒé™æ ¡éªŒæ¡†æ¶æ¥å®ç°ï¼Œç¼–å†™ä¸€å¥—æƒé™æ ¡éªŒè§„åˆ™ä»£ç åï¼Œå°±èƒ½æ•´ä½“ç®¡ç†ç³»ç»Ÿçš„æƒé™æ ¡éªŒé€»è¾‘äº†ã€‚

å…¶å®åœ¨æœ¬é¡¹ç›®ä¸­ï¼Œç”±äºè§’è‰²å’Œæƒé™ä¸å¤šï¼Œé‡‡ç”¨æ–¹æ¡ˆ 1 å®ç°ä¼šæ›´æ–¹ä¾¿ä¸€äº›ï¼Œæˆ‘ä¹Ÿå»ºè®®å¤§å®¶ä¼˜å…ˆé€‰æ‹©è¿™ç§æ–¹æ¡ˆã€‚æ–¹æ¡ˆ 2 çš„ä»£ç é‡è™½ç„¶æœªå¿…æ¯”æ–¹æ¡ˆ 1 å°‘ï¼Œä½†æ˜¯ä¼šè®©æ•´ä¸ªç³»ç»Ÿçš„æƒé™æ ¡éªŒé€»è¾‘æ›´åŠ æ¸…æ™°ï¼Œä¸ºäº†è®©å¤§å®¶åç»­èƒ½å¤Ÿåº”å¯¹æ›´å¤æ‚çš„æƒé™ç®¡ç†éœ€æ±‚ï¼Œæ­¤å¤„é±¼çš®ç»™å¤§å®¶è®²è§£æ–¹æ¡ˆ 2ï¼Œå¹¶é€‰ç”¨å›½å†…ä¸»æµçš„ [æƒé™æ ¡éªŒæ¡†æ¶ Sa-Token](https://sa-token.cc/doc.html#/start/example) å®ç°ã€‚

### ç©ºé—´æ•°æ®ç®¡ç†

è€ƒè™‘åˆ°å›¢é˜Ÿç©ºé—´çš„å›¾ç‰‡æ•°é‡å¯èƒ½æ¯”è¾ƒå¤šï¼Œå¯ä»¥å¯¹ç‰¹å®šç©ºé—´çš„æ•°æ®è¿›è¡Œå•ç‹¬çš„ç®¡ç†ã€‚

å¦‚ä½•å¯¹æ•°æ®è¿›è¡Œå•ç‹¬çš„ç®¡ç†å‘¢ï¼Ÿ

#### 1ã€å›¾ç‰‡ä¿¡æ¯æ•°æ®

å¯ä»¥ç»™æ¯ä¸ªå›¢é˜Ÿç©ºé—´å•ç‹¬åˆ›å»ºä¸€å¼ å›¾ç‰‡è¡¨ `picture_{spaceId}`ï¼Œä¹Ÿå°±æ˜¯åˆ†åº“åˆ†è¡¨ä¸­çš„ `åˆ†è¡¨`ï¼Œè€Œä¸æ˜¯å’Œå…¬å…±å›¾åº“ã€ç§æœ‰ç©ºé—´çš„å›¾ç‰‡æ··åœ¨ä¸€èµ·ã€‚è¿™æ ·ä¸ä»…æŸ¥è¯¢ç©ºé—´å†…çš„å›¾ç‰‡æ•ˆç‡æ›´é«˜ï¼Œè¿˜ä¾¿äºæ•´ä½“ç®¡ç†å’Œæ¸…ç†ç©ºé—´ã€‚**ä½†æ˜¯è¦æ³¨æ„ï¼Œä»…å¯¹æ——èˆ°ç‰ˆç©ºé—´ç”Ÿæ•ˆï¼Œå¦åˆ™åˆ†è¡¨çš„æ•°é‡ä¼šç‰¹åˆ«å¤šï¼Œåè€Œå¯èƒ½å½±å“æ€§èƒ½ã€‚**

æ³¨æ„ï¼Œæˆ‘ä»¬è¦å®ç°çš„ï¼Œè¿˜ä¸æ˜¯æ™®é€šçš„é™æ€åˆ†è¡¨ï¼Œè€Œæ˜¯ä¼šéšç€æ–°å¢ç©ºé—´ä¸æ–­å¢åŠ åˆ†è¡¨æ•°é‡çš„åŠ¨æ€åˆ†è¡¨ï¼Œä¼šä½¿ç”¨åˆ†åº“åˆ†è¡¨æ¡†æ¶ [Apache ShardingSphere](https://shardingsphere.apache.org/) å¸¦å¤§å®¶å®ç°ã€‚

#### 2ã€å›¾ç‰‡æ–‡ä»¶æ•°æ®

å·²ç»å°†æ¯ä¸ªç©ºé—´çš„å›¾ç‰‡å­˜åˆ°ä¸åŒçš„è·¯å¾„ä¸­äº†ï¼Œå®ç°äº†éš”ç¦»ï¼Œæ— éœ€é¢å¤–å¼€å‘ã€‚



ğŸ’¡ ä½ ä¼šå‘ç°ï¼Œæˆ‘ä»¬åœ¨è®¾è®¡ä¸Šå°±å°†å›¢é˜Ÿç©ºé—´å’Œç§æœ‰ç©ºé—´éš”ç¦»ï¼Œä»…å¯¹å›¢é˜Ÿç©ºé—´åº”ç”¨æˆå‘˜ç®¡ç†ã€æƒé™æ§åˆ¶ã€åŠ¨æ€åˆ†è¡¨ã€‚è¿™æ ·å¯ä»¥å°½é‡å‡å°‘å¯¹åŸæœ‰ä»£ç çš„æ”¹åŠ¨ï¼Œé¿å…å‡ºç°é—®é¢˜ã€‚

## ä¸‰ã€åç«¯å¼€å‘

### åˆ›å»ºå›¢é˜Ÿå…±äº«ç©ºé—´

#### 1ã€æ•°æ®æ¨¡å‹

Spaceã€SpaceVOã€SpaceAddRequestã€SpaceQueryRequest è¡¥å…… spaceType å­—æ®µï¼š

```java
/**
 * ç©ºé—´ç±»å‹ï¼š0-ç§æœ‰ 1-å›¢é˜Ÿ
 */
private Integer spaceType;
```

å®šä¹‰ç©ºé—´ç±»å‹æšä¸¾ï¼š

```java
@Getter
public enum SpaceTypeEnum {

    PRIVATE("ç§æœ‰ç©ºé—´", 0),
    TEAM("å›¢é˜Ÿç©ºé—´", 1);

    private final String text;

    private final int value;

    SpaceTypeEnum(String text, int value) {
        this.text = text;
        this.value = value;
    }

    /**
     * æ ¹æ® value è·å–æšä¸¾
     */
    public static SpaceTypeEnum getEnumByValue(Integer value) {
        if (ObjUtil.isEmpty(value)) {
            return null;
        }
        for (SpaceTypeEnum spaceTypeEnum : SpaceTypeEnum.values()) {
            if (spaceTypeEnum.value == value) {
                return spaceTypeEnum;
            }
        }
        return null;
    }
}
```

#### 2ã€æ–°å»ºå›¢é˜Ÿç©ºé—´

å¯ä»¥ç›´æ¥å¤ç”¨åˆ›å»ºç©ºé—´çš„æ–¹æ³•ï¼Œåªéœ€è¦åšä¸€äº›æ”¹åŠ¨å³å¯ã€‚

1ï¼‰åˆ›å»ºç©ºé—´æ—¶ä¸ºç©ºé—´ç±»å‹æŒ‡å®šé»˜è®¤å€¼ï¼š

```java
// é»˜è®¤å€¼
if (StrUtil.isBlank(spaceAddRequest.getSpaceName())) {
    spaceAddRequest.setSpaceName("é»˜è®¤ç©ºé—´");
}
if (spaceAddRequest.getSpaceLevel() == null) {
    spaceAddRequest.setSpaceLevel(SpaceLevelEnum.COMMON.getValue());
}
if (spaceAddRequest.getSpaceType() == null) {
    spaceAddRequest.setSpaceType(SpaceTypeEnum.PRIVATE.getValue());
}
// åœ¨æ­¤å¤„å°†å®ä½“ç±»å’Œ DTO è¿›è¡Œè½¬æ¢
Space space = new Space();
BeanUtils.copyProperties(spaceAddRequest, space);
// å¡«å……æ•°æ®
this.fillSpaceBySpaceLevel(space);
```

2ï¼‰validSpace æ–¹æ³•è¡¥å……å¯¹ç©ºé—´ç±»å‹çš„æ ¡éªŒï¼š

```java
public void validSpace(Space space, boolean add) {
    Integer spaceType = space.getSpaceType();
    SpaceTypeEnum spaceTypeEnum = SpaceTypeEnum.getEnumByValue(spaceType);
    // è¦åˆ›å»º
    if (add) {
        if (spaceType == null) {
            throw new BusinessException(ErrorCode.PARAMS_ERROR, "ç©ºé—´ç±»å‹ä¸èƒ½ä¸ºç©º");
        }
    }
    // ä¿®æ”¹æ•°æ®æ—¶ï¼Œå¦‚æœè¦æ”¹ç©ºé—´çº§åˆ«
    if (spaceType != null && spaceTypeEnum == null) {
        throw new BusinessException(ErrorCode.PARAMS_ERROR, "ç©ºé—´ç±»å‹ä¸å­˜åœ¨");
    }
}
```

3ï¼‰é™åˆ¶æ¯ä¸ªæ™®é€šç”¨æˆ·ä»…èƒ½åˆ›å»ºä¸€ä¸ªå›¢é˜Ÿç©ºé—´ï¼ˆç®¡ç†å‘˜å¯ä»¥åˆ›å»ºå¤šä¸ªï¼‰ï¼Œç”±äºæ™®é€šç”¨æˆ·ä¹Ÿä»…èƒ½åˆ›å»ºä¸€ä¸ªç§æœ‰ç©ºé—´ï¼Œç›¸å½“äº **æ™®é€šç”¨æˆ·æ¯ç±»ç©ºé—´åªèƒ½åˆ›å»º 1 ä¸ªã€‚**å› æ­¤ï¼Œåªè¦åœ¨åˆ¤æ–­æ˜¯å¦å·²åˆ›å»ºç©ºé—´æ—¶ï¼Œè¡¥å…… spaceType ä½œä¸ºæŸ¥è¯¢æ¡ä»¶å³å¯ï¼š

```java
Long newSpaceId = transactionTemplate.execute(status -> {
    if (!userService.isAdmin(loginUser)) {
        boolean exists = this.lambdaQuery()
                .eq(Space::getUserId, userId)
                .eq(Space::getSpaceType, spaceAddRequest.getSpaceType())
                .exists();
        ThrowUtils.throwIf(exists, ErrorCode.OPERATION_ERROR, "æ¯ä¸ªç”¨æˆ·æ¯ç±»ç©ºé—´ä»…èƒ½åˆ›å»ºä¸€ä¸ª");
    }
    // å†™å…¥æ•°æ®åº“
    boolean result = this.save(space);
    ThrowUtils.throwIf(!result, ErrorCode.OPERATION_ERROR);
    // è¿”å›æ–°å†™å…¥çš„æ•°æ® id
    return space.getId();
});
```

å½“ç„¶ï¼Œè¿™é‡Œçš„é€»è¾‘ä½ å¯ä»¥è‡ªç”±è°ƒæ•´ï¼Œæ¯”å¦‚ä¸å…è®¸ç”¨æˆ·åˆ›å»ºå›¢é˜Ÿç©ºé—´ï¼Œéœ€è¦è”ç³»ç®¡ç†å‘˜æˆ–ä»˜è´¹å¼€é€šã€‚

#### 3ã€æŸ¥è¯¢å›¢é˜Ÿç©ºé—´

ç»™ SpaceService çš„ getQueryWrapper æ–¹æ³•è¡¥å…… spaceType çš„æŸ¥è¯¢æ¡ä»¶ï¼š

```java
Integer spaceType = spaceQueryRequest.getSpaceType();
queryWrapper.eq(ObjUtil.isNotEmpty(spaceType), "spaceType", spaceType);
```

ä¹‹åå‰ç«¯å°±èƒ½å¤ŸæŒ‰ç…§ç©ºé—´ç±»åˆ«è·å–ç©ºé—´åˆ—è¡¨äº†ã€‚

### ç©ºé—´æˆå‘˜ç®¡ç†

ç©ºé—´æˆå‘˜ç®¡ç†çš„å¼€å‘æ¯”è¾ƒç®€å•ï¼Œå…¶å®å°±æ˜¯ â€œå¢åˆ æ”¹æŸ¥â€ã€‚

#### 1ã€æ•°æ®æ¨¡å‹

1ï¼‰é¦–å…ˆåˆ©ç”¨ MyBatisX æ’ä»¶ç”Ÿæˆç©ºé—´æˆå‘˜è¡¨ç›¸å…³çš„åŸºç¡€ä»£ç ï¼ŒåŒ…æ‹¬å®ä½“ç±»ã€Mapperã€Serviceã€‚

ç”¨æˆ·æ¨¡å—ä¸­æœ‰è®²è§£è¯¦ç»†æµç¨‹ï¼Œæ­¤å¤„ä¸å†èµ˜è¿°ã€‚

2ï¼‰æ¯ä¸ªæ“ä½œéƒ½éœ€è¦æä¾›ä¸€ä¸ªè¯·æ±‚ç±»ï¼Œéƒ½æ”¾åœ¨ `model.dto.spaceuser` åŒ…ä¸‹ã€‚bgMhj83Bt96lFcj29lBZCF0o0+YPCGWOWUw0OPyFB/Q=

![img](assets/S4BImEzexA9AyW6R.webp)

æ·»åŠ ç©ºé—´æˆå‘˜è¯·æ±‚ï¼Œç»™ç©ºé—´ç®¡ç†å‘˜ä½¿ç”¨ï¼š

```java
@Data
public class SpaceUserAddRequest implements Serializable {

    /**
     * ç©ºé—´ ID
     */
    private Long spaceId;

    /**
     * ç”¨æˆ· ID
     */
    private Long userId;

    /**
     * ç©ºé—´è§’è‰²ï¼šviewer/editor/admin
     */
    private String spaceRole;

    private static final long serialVersionUID = 1L;
}
```

ç¼–è¾‘ç©ºé—´æˆå‘˜è¯·æ±‚ï¼Œç»™ç©ºé—´ç®¡ç†å‘˜ä½¿ç”¨ï¼Œå¯ä»¥è®¾ç½®ç©ºé—´æˆå‘˜çš„è§’è‰²ï¼š

```java
@Data
public class SpaceUserEditRequest implements Serializable {

    /**
     * id
     */
    private Long id;

    /**
     * ç©ºé—´è§’è‰²ï¼šviewer/editor/admin
     */
    private String spaceRole;

    private static final long serialVersionUID = 1L;
}
```

æŸ¥è¯¢ç©ºé—´æˆå‘˜è¯·æ±‚ï¼Œå¯ä»¥ä¸ç”¨åˆ†é¡µï¼š

```java
@Data
public class SpaceUserQueryRequest implements Serializable {

    /**
     * ID
     */
    private Long id;

    /**
     * ç©ºé—´ ID
     */
    private Long spaceId;

    /**
     * ç”¨æˆ· ID
     */
    private Long userId;

    /**
     * ç©ºé—´è§’è‰²ï¼šviewer/editor/admin
     */
    private String spaceRole;

    private static final long serialVersionUID = 1L;
}
```

3ï¼‰åœ¨ `model.dto.vo` ä¸‹æ–°å»ºç©ºé—´æˆå‘˜çš„è§†å›¾åŒ…è£…ç±»ï¼Œå¯ä»¥é¢å¤–å…³è”ç©ºé—´ä¿¡æ¯å’Œåˆ›å»ºç©ºé—´çš„ç”¨æˆ·ä¿¡æ¯ã€‚è¿˜å¯ä»¥ç¼–å†™ SpaceUser å®ä½“ç±»å’Œè¯¥ VO ç±»çš„è½¬æ¢æ–¹æ³•ï¼Œä¾¿äºåç»­å¿«é€Ÿä¼ å€¼ã€‚

```java
@Data
public class SpaceUserVO implements Serializable {

    /**
     * id
     */
    private Long id;

    /**
     * ç©ºé—´ id
     */
    private Long spaceId;

    /**
     * ç”¨æˆ· id
     */
    private Long userId;

    /**
     * ç©ºé—´è§’è‰²ï¼šviewer/editor/admin
     */
    private String spaceRole;

    /**
     * åˆ›å»ºæ—¶é—´
     */
    private Date createTime;

    /**
     * æ›´æ–°æ—¶é—´
     */
    private Date updateTime;

    /**
     * ç”¨æˆ·ä¿¡æ¯
     */
    private UserVO user;

    /**
     * ç©ºé—´ä¿¡æ¯
     */
    private SpaceVO space;

    private static final long serialVersionUID = 1L;

    /**
     * å°è£…ç±»è½¬å¯¹è±¡
     *
     * @param spaceUserVO
     * @return
     */
    public static SpaceUser voToObj(SpaceUserVO spaceUserVO) {
        if (spaceUserVO == null) {
            return null;
        }
        SpaceUser spaceUser = new SpaceUser();
        BeanUtils.copyProperties(spaceUserVO, spaceUser);
        return spaceUser;
    }

    /**
     * å¯¹è±¡è½¬å°è£…ç±»
     *
     * @param spaceUser
     * @return
     */
    public static SpaceUserVO objToVo(SpaceUser spaceUser) {
        if (spaceUser == null) {
            return null;
        }
        SpaceUserVO spaceUserVO = new SpaceUserVO();
        BeanUtils.copyProperties(spaceUser, spaceUserVO);
        return spaceUserVO;
    }
}
```

4ï¼‰åœ¨ `model.enums` åŒ…ä¸‹æ–°å»ºç©ºé—´è§’è‰²æšä¸¾ï¼š

```java
@Getter
public enum SpaceRoleEnum {

    VIEWER("æµè§ˆè€…", "viewer"),
    EDITOR("ç¼–è¾‘è€…", "editor"),
    ADMIN("ç®¡ç†å‘˜", "admin");

    private final String text;

    private final String value;

    SpaceRoleEnum(String text, String value) {
        this.text = text;
        this.value = value;
    }

    /**
     * æ ¹æ® value è·å–æšä¸¾
     *
     * @param value æšä¸¾å€¼çš„ value
     * @return æšä¸¾å€¼
     */
    public static SpaceRoleEnum getEnumByValue(String value) {
        if (ObjUtil.isEmpty(value)) {
            return null;
        }
        for (SpaceRoleEnum anEnum : SpaceRoleEnum.values()) {
            if (anEnum.value.equals(value)) {
                return anEnum;
            }
        }
        return null;
    }

    /**
     * è·å–æ‰€æœ‰æšä¸¾çš„æ–‡æœ¬åˆ—è¡¨
     *
     * @return æ–‡æœ¬åˆ—è¡¨
     */
    public static List<String> getAllTexts() {
        return Arrays.stream(SpaceRoleEnum.values())
                .map(SpaceRoleEnum::getText)
                .collect(Collectors.toList());
    }

    /**
     * è·å–æ‰€æœ‰æšä¸¾çš„å€¼åˆ—è¡¨
     *
     * @return å€¼åˆ—è¡¨
     */
    public static List<String> getAllValues() {
        return Arrays.stream(SpaceRoleEnum.values())
                .map(SpaceRoleEnum::getValue)
                .collect(Collectors.toList());
    }
}
```

#### 2ã€åŸºç¡€æœåŠ¡å¼€å‘

å¯ä»¥å‚è€ƒå›¾ç‰‡æœåŠ¡çš„å¼€å‘æ–¹æ³•ï¼Œå®Œæˆ SpaceUserService å’Œå®ç°ç±»ï¼Œå¤§å¤šæ•°ä»£ç å¯ä»¥ç›´æ¥å¤ç”¨ã€‚

æˆ‘ä»¬ä¸»è¦å¼€å‘ä¸‹åˆ—æ–¹æ³•ï¼š

1ï¼‰æ·»åŠ ç©ºé—´æˆå‘˜ï¼š

```java
@Override
public long addSpaceUser(SpaceUserAddRequest spaceUserAddRequest) {
    // å‚æ•°æ ¡éªŒ
    ThrowUtils.throwIf(spaceUserAddRequest == null, ErrorCode.PARAMS_ERROR);
    SpaceUser spaceUser = new SpaceUser();
    BeanUtils.copyProperties(spaceUserAddRequest, spaceUser);
    validSpaceUser(spaceUser, true);
    // æ•°æ®åº“æ“ä½œ
    boolean result = this.save(spaceUser);
    ThrowUtils.throwIf(!result, ErrorCode.OPERATION_ERROR);
    return spaceUser.getId();
}
```

2ï¼‰æ ¡éªŒç©ºé—´æˆå‘˜å¯¹è±¡ï¼Œå¢åŠ  add å‚æ•°ç”¨æ¥åŒºåˆ†æ˜¯åˆ›å»ºæ•°æ®æ—¶æ ¡éªŒè¿˜æ˜¯ç¼–è¾‘æ—¶æ ¡éªŒï¼Œåˆ¤æ–­æ¡ä»¶æ˜¯ä¸ä¸€æ ·çš„ã€‚æ¯”å¦‚åˆ›å»ºæˆå‘˜æ—¶è¦æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨ã€‚

```java
@Override
public void validSpaceUser(SpaceUser spaceUser, boolean add) {
    ThrowUtils.throwIf(spaceUser == null, ErrorCode.PARAMS_ERROR);
    // åˆ›å»ºæ—¶ï¼Œç©ºé—´ id å’Œç”¨æˆ· id å¿…å¡«
    Long spaceId = spaceUser.getSpaceId();
    Long userId = spaceUser.getUserId();
    if (add) {
        ThrowUtils.throwIf(ObjectUtil.hasEmpty(spaceId, userId), ErrorCode.PARAMS_ERROR);
        User user = userService.getById(userId);
        ThrowUtils.throwIf(user == null, ErrorCode.NOT_FOUND_ERROR, "ç”¨æˆ·ä¸å­˜åœ¨");
        Space space = spaceService.getById(spaceId);
        ThrowUtils.throwIf(space == null, ErrorCode.NOT_FOUND_ERROR, "ç©ºé—´ä¸å­˜åœ¨");
    }
    // æ ¡éªŒç©ºé—´è§’è‰²
    String spaceRole = spaceUser.getSpaceRole();
    SpaceRoleEnum spaceRoleEnum = SpaceRoleEnum.getEnumByValue(spaceRole);
    if (spaceRole != null && spaceRoleEnum == null) {
        throw new BusinessException(ErrorCode.PARAMS_ERROR, "ç©ºé—´è§’è‰²ä¸å­˜åœ¨");
    }
}
```

è¿˜å¯ä»¥æ ¡éªŒæ˜¯å¦å·²æ·»åŠ è¯¥æˆå‘˜ï¼Œå¯è‡ªè¡Œå®ç°ã€‚

3ï¼‰å°†æŸ¥è¯¢è¯·æ±‚å¯¹è±¡è½¬æ¢ä¸º MyBatis-Plus çš„æŸ¥è¯¢å°è£…å¯¹è±¡ï¼š

```java
@Override
public QueryWrapper<SpaceUser> getQueryWrapper(SpaceUserQueryRequest spaceUserQueryRequest) {
    QueryWrapper<SpaceUser> queryWrapper = new QueryWrapper<>();
    if (spaceUserQueryRequest == null) {
        return queryWrapper;
    }
    // ä»å¯¹è±¡ä¸­å–å€¼
    Long id = spaceUserQueryRequest.getId();
    Long spaceId = spaceUserQueryRequest.getSpaceId();
    Long userId = spaceUserQueryRequest.getUserId();
    String spaceRole = spaceUserQueryRequest.getSpaceRole();
    queryWrapper.eq(ObjUtil.isNotEmpty(id), "id", id);
    queryWrapper.eq(ObjUtil.isNotEmpty(spaceId), "spaceId", spaceId);
    queryWrapper.eq(ObjUtil.isNotEmpty(userId), "userId", userId);
    queryWrapper.eq(ObjUtil.isNotEmpty(spaceRole), "spaceRole", spaceRole);
    return queryWrapper;
}
```

4ï¼‰è·å–ç©ºé—´æˆå‘˜å°è£…ç±»ï¼Œéœ€è¦å…³è”æŸ¥è¯¢ç”¨æˆ·å’Œç©ºé—´çš„ä¿¡æ¯ã€‚

æŸ¥è¯¢å•ä¸ªå°è£…ç±»ï¼š

```java
@Override
public SpaceUserVO getSpaceUserVO(SpaceUser spaceUser, HttpServletRequest request) {
    // å¯¹è±¡è½¬å°è£…ç±»
    SpaceUserVO spaceUserVO = SpaceUserVO.objToVo(spaceUser);
    // å…³è”æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
    Long userId = spaceUser.getUserId();
    if (userId != null && userId > 0) {
        User user = userService.getById(userId);
        UserVO userVO = userService.getUserVO(user);
        spaceUserVO.setUser(userVO);
    }
    // å…³è”æŸ¥è¯¢ç©ºé—´ä¿¡æ¯
    Long spaceId = spaceUser.getSpaceId();
    if (spaceId != null && spaceId > 0) {
        Space space = spaceService.getById(spaceId);
        SpaceVO spaceVO = spaceService.getSpaceVO(space, request);
        spaceUserVO.setSpace(spaceVO);
    }
    return spaceUserVO;
}
```

æŸ¥è¯¢å°è£…ç±»åˆ—è¡¨ï¼š

```java
@Override
public List<SpaceUserVO> getSpaceUserVOList(List<SpaceUser> spaceUserList) {
    // åˆ¤æ–­è¾“å…¥åˆ—è¡¨æ˜¯å¦ä¸ºç©º
    if (CollUtil.isEmpty(spaceUserList)) {
        return Collections.emptyList();
    }
    // å¯¹è±¡åˆ—è¡¨ => å°è£…å¯¹è±¡åˆ—è¡¨
    List<SpaceUserVO> spaceUserVOList = spaceUserList.stream().map(SpaceUserVO::objToVo).collect(Collectors.toList());
    // 1. æ”¶é›†éœ€è¦å…³è”æŸ¥è¯¢çš„ç”¨æˆ· ID å’Œç©ºé—´ ID
    Set<Long> userIdSet = spaceUserList.stream().map(SpaceUser::getUserId).collect(Collectors.toSet());
    Set<Long> spaceIdSet = spaceUserList.stream().map(SpaceUser::getSpaceId).collect(Collectors.toSet());
    // 2. æ‰¹é‡æŸ¥è¯¢ç”¨æˆ·å’Œç©ºé—´
    Map<Long, List<User>> userIdUserListMap = userService.listByIds(userIdSet).stream()
            .collect(Collectors.groupingBy(User::getId));
    Map<Long, List<Space>> spaceIdSpaceListMap = spaceService.listByIds(spaceIdSet).stream()
            .collect(Collectors.groupingBy(Space::getId));
    // 3. å¡«å…… SpaceUserVO çš„ç”¨æˆ·å’Œç©ºé—´ä¿¡æ¯
    spaceUserVOList.forEach(spaceUserVO -> {
        Long userId = spaceUserVO.getUserId();
        Long spaceId = spaceUserVO.getSpaceId();
        // å¡«å……ç”¨æˆ·ä¿¡æ¯
        User user = null;
        if (userIdUserListMap.containsKey(userId)) {
            user = userIdUserListMap.get(userId).get(0);
        }
        spaceUserVO.setUser(userService.getUserVO(user));
        // å¡«å……ç©ºé—´ä¿¡æ¯
        Space space = null;
        if (spaceIdSpaceListMap.containsKey(spaceId)) {
            space = spaceIdSpaceListMap.get(spaceId).get(0);
        }
        spaceUserVO.setSpace(SpaceVO.objToVo(space));
    });
    return spaceUserVOList;
}
```

#### 3ã€æ¥å£å¼€å‘

å‚è€ƒå›¾ç‰‡æ¥å£çš„å¼€å‘æ–¹æ³•ï¼Œå®Œæˆ SpaceUserController ç±»ï¼Œå¤§å¤šæ•°ä»£ç å¯ä»¥ç›´æ¥å¤ç”¨ã€‚

éœ€è¦å¼€å‘çš„æ¥å£åŒ…æ‹¬ï¼š

- æ·»åŠ æˆå‘˜åˆ°ç©ºé—´ï¼šä»…æ‹¥æœ‰æˆå‘˜ç®¡ç†æƒé™çš„ç”¨æˆ·å¯ä½¿ç”¨ã€‚
- ä»ç©ºé—´ç§»é™¤æˆå‘˜ï¼šä»…æ‹¥æœ‰æˆå‘˜ç®¡ç†æƒé™çš„ç”¨æˆ·å¯ä½¿ç”¨ã€‚
- æŸ¥è¯¢æŸä¸ªæˆå‘˜åœ¨ç©ºé—´çš„ä¿¡æ¯ï¼šä»…æ‹¥æœ‰æˆå‘˜ç®¡ç†æƒé™çš„ç”¨æˆ·å¯ä½¿ç”¨ã€‚
- æŸ¥è¯¢ç©ºé—´æˆå‘˜åˆ—è¡¨ï¼šä»…æ‹¥æœ‰æˆå‘˜ç®¡ç†æƒé™çš„ç”¨æˆ·å¯ä½¿ç”¨ã€‚
- ç¼–è¾‘æˆå‘˜ä¿¡æ¯ï¼šä»…æ‹¥æœ‰æˆå‘˜ç®¡ç†æƒé™çš„ç”¨æˆ·å¯ä½¿ç”¨ã€‚
- æŸ¥è¯¢æˆ‘åŠ å…¥çš„å›¢é˜Ÿç©ºé—´åˆ—è¡¨ï¼šæ‰€æœ‰å·²ç™»å½•ç”¨æˆ·å¯ä½¿ç”¨ã€‚

**ç”±äºæˆ‘ä»¬åç»­ä¼šä½¿ç”¨ç»Ÿä¸€çš„æƒé™ç®¡ç†æ¡†æ¶ï¼Œè¿™ä¸ªé˜¶æ®µå¯ä»¥å…ˆåªå®ç°åŠŸèƒ½ï¼Œä¸è¿›è¡Œæƒé™æ ¡éªŒã€‚**

ä»£ç å¦‚ä¸‹ï¼š

```java
@RestController
@RequestMapping("/spaceUser")
@Slf4j
public class SpaceUserController {

    @Resource
    private SpaceUserService spaceUserService;

    @Resource
    private UserService userService;

    /**
     * æ·»åŠ æˆå‘˜åˆ°ç©ºé—´
     */
    @PostMapping("/add")
    public BaseResponse<Long> addSpaceUser(@RequestBody SpaceUserAddRequest spaceUserAddRequest, HttpServletRequest request) {
        ThrowUtils.throwIf(spaceUserAddRequest == null, ErrorCode.PARAMS_ERROR);
        long id = spaceUserService.addSpaceUser(spaceUserAddRequest);
        return ResultUtils.success(id);
    }

    /**
     * ä»ç©ºé—´ç§»é™¤æˆå‘˜
     */
    @PostMapping("/delete")
    public BaseResponse<Boolean> deleteSpaceUser(@RequestBody DeleteRequest deleteRequest,
                                                 HttpServletRequest request) {
        if (deleteRequest == null || deleteRequest.getId() <= 0) {
            throw new BusinessException(ErrorCode.PARAMS_ERROR);
        }
        long id = deleteRequest.getId();
        // åˆ¤æ–­æ˜¯å¦å­˜åœ¨
        SpaceUser oldSpaceUser = spaceUserService.getById(id);
        ThrowUtils.throwIf(oldSpaceUser == null, ErrorCode.NOT_FOUND_ERROR);
        // æ“ä½œæ•°æ®åº“
        boolean result = spaceUserService.removeById(id);
        ThrowUtils.throwIf(!result, ErrorCode.OPERATION_ERROR);
        return ResultUtils.success(true);
    }

    /**
     * æŸ¥è¯¢æŸä¸ªæˆå‘˜åœ¨æŸä¸ªç©ºé—´çš„ä¿¡æ¯
     */
    @PostMapping("/get")
    public BaseResponse<SpaceUser> getSpaceUser(@RequestBody SpaceUserQueryRequest spaceUserQueryRequest) {
        // å‚æ•°æ ¡éªŒ
        ThrowUtils.throwIf(spaceUserQueryRequest == null, ErrorCode.PARAMS_ERROR);
        Long spaceId = spaceUserQueryRequest.getSpaceId();
        Long userId = spaceUserQueryRequest.getUserId();
        ThrowUtils.throwIf(ObjectUtil.hasEmpty(spaceId, userId), ErrorCode.PARAMS_ERROR);
        // æŸ¥è¯¢æ•°æ®åº“
        SpaceUser spaceUser = spaceUserService.getOne(spaceUserService.getQueryWrapper(spaceUserQueryRequest));
        ThrowUtils.throwIf(spaceUser == null, ErrorCode.NOT_FOUND_ERROR);
        return ResultUtils.success(spaceUser);
    }

    /**
     * æŸ¥è¯¢æˆå‘˜ä¿¡æ¯åˆ—è¡¨
     */
    @PostMapping("/list")
    public BaseResponse<List<SpaceUserVO>> listSpaceUser(@RequestBody SpaceUserQueryRequest spaceUserQueryRequest,
                                                         HttpServletRequest request) {
        ThrowUtils.throwIf(spaceUserQueryRequest == null, ErrorCode.PARAMS_ERROR);
        List<SpaceUser> spaceUserList = spaceUserService.list(
                spaceUserService.getQueryWrapper(spaceUserQueryRequest)
        );
        return ResultUtils.success(spaceUserService.getSpaceUserVOList(spaceUserList));
    }

    /**
     * ç¼–è¾‘æˆå‘˜ä¿¡æ¯ï¼ˆè®¾ç½®æƒé™ï¼‰
     */
    @PostMapping("/edit")
    public BaseResponse<Boolean> editSpaceUser(@RequestBody SpaceUserEditRequest spaceUserEditRequest,
                                               HttpServletRequest request) {
        if (spaceUserEditRequest == null || spaceUserEditRequest.getId() <= 0) {
            throw new BusinessException(ErrorCode.PARAMS_ERROR);
        }
        // å°†å®ä½“ç±»å’Œ DTO è¿›è¡Œè½¬æ¢
        SpaceUser spaceUser = new SpaceUser();
        BeanUtils.copyProperties(spaceUserEditRequest, spaceUser);
        // æ•°æ®æ ¡éªŒ
        spaceUserService.validSpaceUser(spaceUser, false);
        // åˆ¤æ–­æ˜¯å¦å­˜åœ¨
        long id = spaceUserEditRequest.getId();
        SpaceUser oldSpaceUser = spaceUserService.getById(id);
        ThrowUtils.throwIf(oldSpaceUser == null, ErrorCode.NOT_FOUND_ERROR);
        // æ“ä½œæ•°æ®åº“
        boolean result = spaceUserService.updateById(spaceUser);
        ThrowUtils.throwIf(!result, ErrorCode.OPERATION_ERROR);
        return ResultUtils.success(true);
    }

    /**
     * æŸ¥è¯¢æˆ‘åŠ å…¥çš„å›¢é˜Ÿç©ºé—´åˆ—è¡¨
     */
    @PostMapping("/list/my")
    public BaseResponse<List<SpaceUserVO>> listMyTeamSpace(HttpServletRequest request) {
        User loginUser = userService.getLoginUser(request);
        SpaceUserQueryRequest spaceUserQueryRequest = new SpaceUserQueryRequest();
        spaceUserQueryRequest.setUserId(loginUser.getId());
        List<SpaceUser> spaceUserList = spaceUserService.list(
                spaceUserService.getQueryWrapper(spaceUserQueryRequest)
        );
        return ResultUtils.success(spaceUserService.getSpaceUserVOList(spaceUserList));
    }
}
```

#### 4ã€åˆ›å»ºå›¢é˜Ÿç©ºé—´æ—¶è‡ªåŠ¨æ–°å¢æˆå‘˜è®°å½•

æ ¹æ®éœ€æ±‚ï¼Œç”¨æˆ·åœ¨åˆ›å»ºå›¢é˜Ÿç©ºé—´æ—¶ï¼Œä¼šé»˜è®¤ä½œä¸ºç©ºé—´çš„ç®¡ç†å‘˜ï¼Œéœ€è¦åœ¨ç©ºé—´æˆå‘˜è¡¨ä¸­æ–°å¢ä¸€æ¡è®°å½•ã€‚

ä¿®æ”¹ addSpace æ–¹æ³•ï¼Œåœ¨äº‹åŠ¡ä¸­è¡¥å……æ’å…¥ç©ºé—´æˆå‘˜è®°å½•ï¼š

```java
// å†™å…¥æ•°æ®åº“
boolean result = this.save(space);
ThrowUtils.throwIf(!result, ErrorCode.OPERATION_ERROR);
// å¦‚æœæ˜¯å›¢é˜Ÿç©ºé—´ï¼Œå…³è”æ–°å¢å›¢é˜Ÿæˆå‘˜è®°å½•
if (SpaceTypeEnum.TEAM.getValue() == spaceAddRequest.getSpaceType()) {
    SpaceUser spaceUser = new SpaceUser();
    spaceUser.setSpaceId(space.getId());
    spaceUser.setUserId(userId);
    spaceUser.setSpaceRole(SpaceRoleEnum.ADMIN.getValue());
    result = spaceUserService.save(spaceUser);
    ThrowUtils.throwIf(!result, ErrorCode.OPERATION_ERROR, "åˆ›å»ºå›¢é˜Ÿæˆå‘˜è®°å½•å¤±è´¥");
}
// è¿”å›æ–°å†™å…¥çš„æ•°æ® id
return space.getId();
```

#### æ‰©å±•

1ï¼‰æ·»åŠ æˆå‘˜åˆ°ç©ºé—´æ—¶ï¼Œå¯ä»¥æ”¯æŒå‘é€é‚€è¯·å’Œå®¡æ‰¹ã€‚

å®ç°æ€è·¯ï¼šç»™ç©ºé—´æˆå‘˜è¡¨æ–°å¢ä¸€ä¸ªé‚€è¯·ç¡®è®¤çŠ¶æ€çš„å­—æ®µ

2ï¼‰ç”±äºç©ºé—´ç®¡ç†å‘˜å¯èƒ½æœ‰å¤šä¸ªï¼Œç©ºé—´æˆå‘˜è¡¨å¯ä»¥è¡¥å……æ·»åŠ æˆå‘˜è‡³ç©ºé—´çš„é‚€è¯·äººå­—æ®µï¼ˆcreateUserIdï¼‰

3ï¼‰ç©ºé—´æˆå‘˜æ“ä½œæ‰§è¡Œå‰å¯ä»¥è¡¥å……ä¸€äº›æ ¡éªŒï¼Œæ¯”å¦‚ï¼š

- åªæœ‰å·²ç»æ˜¯ç©ºé—´æˆå‘˜ï¼Œæ‰èƒ½è¢«ç§»é™¤æˆ–ç¼–è¾‘
- å¦‚æœç¼–è¾‘åçš„è§’è‰²è·Ÿä¹‹å‰ä¸€è‡´ï¼Œå°±ä¸ç”¨æ›´æ–°

### ç©ºé—´æˆå‘˜æƒé™æ§åˆ¶

å¼•å…¥å›¢é˜Ÿç©ºé—´åï¼Œéœ€è¦ç»™ç©ºé—´æ“ä½œã€å›¾ç‰‡æ“ä½œã€ç©ºé—´æˆå‘˜æ“ä½œæ·»åŠ æƒé™æ§åˆ¶é€»è¾‘ã€‚ä¸ºäº†ç®€åŒ–å¼€å‘ï¼ŒåŒæ—¶é˜²æ­¢ä¸€äº›ç©ºé—´é‡è¦ä¿¡æ¯çš„ä¿®æ”¹å†²çªï¼Œç©ºé—´æ“ä½œï¼ˆç©ºé—´ä¿¡æ¯çš„å¢åˆ æ”¹æŸ¥ï¼‰ä»ç„¶å¤ç”¨ä¹‹å‰ç§æœ‰ç©ºé—´çš„æ ¡éªŒé€»è¾‘ â€”â€” ä»…åˆ›å»ºäººå¯æ“ä½œã€‚p87QUult0bZDR05AO5soQVixQ5nCQ+HA+P5tLSHK/hI=

ç”±äºæƒé™æ ¡éªŒå±äºæ•´ä¸ªé¡¹ç›®çš„å…¬å…±æœåŠ¡ï¼Œç»Ÿä¸€æ”¾åœ¨ `manager.auth` åŒ…ä¸­ã€‚

#### 1ã€æƒé™å®šä¹‰

æ ¹æ® RBAC æƒé™æ¨¡å‹ï¼Œéœ€è¦å®šä¹‰è§’è‰²å’Œæƒé™ã€‚

1ï¼‰æ­¤å¤„é€‰ç”¨ JSON é…ç½®æ–‡ä»¶æ¥å®šä¹‰è§’è‰²ã€æƒé™ã€è§’è‰²å’Œæƒé™ä¹‹é—´çš„å…³ç³»ï¼Œç›¸æ¯”ä»æ•°æ®åº“è¡¨ä¸­è·å–ï¼Œå®ç°æ›´æ–¹ä¾¿ï¼ŒæŸ¥è¯¢ä¹Ÿæ›´é«˜æ•ˆã€‚

åœ¨ `resources/biz` ç›®å½•ä¸‹æ–°å»º JSON é…ç½®æ–‡ä»¶ `spaceUserAuthConfig.json`ï¼š

```json
{
  "permissions": [
    {
      "key": "spaceUser:manage",
      "name": "æˆå‘˜ç®¡ç†",
      "description": "ç®¡ç†ç©ºé—´æˆå‘˜ï¼Œæ·»åŠ æˆ–ç§»é™¤æˆå‘˜"
    },
    {
      "key": "picture:view",
      "name": "æŸ¥çœ‹å›¾ç‰‡",
      "description": "æŸ¥çœ‹ç©ºé—´ä¸­çš„å›¾ç‰‡å†…å®¹"
    },
    {
      "key": "picture:upload",
      "name": "ä¸Šä¼ å›¾ç‰‡",
      "description": "ä¸Šä¼ å›¾ç‰‡åˆ°ç©ºé—´ä¸­"
    },
    {
      "key": "picture:edit",
      "name": "ä¿®æ”¹å›¾ç‰‡",
      "description": "ç¼–è¾‘å·²ä¸Šä¼ çš„å›¾ç‰‡ä¿¡æ¯"
    },
    {
      "key": "picture:delete",
      "name": "åˆ é™¤å›¾ç‰‡",
      "description": "åˆ é™¤ç©ºé—´ä¸­çš„å›¾ç‰‡"
    }
  ],
  "roles": [
    {
      "key": "viewer",
      "name": "æµè§ˆè€…",
      "permissions": [
        "picture:view"
      ],
      "description": "æŸ¥çœ‹å›¾ç‰‡"
    },
    {
      "key": "editor",
      "name": "ç¼–è¾‘è€…",
      "permissions": [
        "picture:view",
        "picture:upload",
        "picture:edit",
        "picture:delete"
      ],
      "description": "æŸ¥çœ‹å›¾ç‰‡ã€ä¸Šä¼ å›¾ç‰‡ã€ä¿®æ”¹å›¾ç‰‡ã€åˆ é™¤å›¾ç‰‡"
    },
    {
      "key": "admin",
      "name": "ç®¡ç†å‘˜",
      "permissions": [
        "spaceUser:manage",
        "picture:view",
        "picture:upload",
        "picture:edit",
        "picture:delete"
      ],
      "description": "æˆå‘˜ç®¡ç†ã€æŸ¥çœ‹å›¾ç‰‡ã€ä¸Šä¼ å›¾ç‰‡ã€ä¿®æ”¹å›¾ç‰‡ã€åˆ é™¤å›¾ç‰‡"
    }
  ]
}
```

2ï¼‰åœ¨ `auth.model` åŒ…ä¸‹æ–°å»ºæ•°æ®æ¨¡å‹ï¼Œç”¨äºæ¥æ”¶é…ç½®æ–‡ä»¶çš„å€¼ã€‚

æƒé™é…ç½®ç±»ï¼š

```java
@Data
public class SpaceUserAuthConfig implements Serializable {

    /**
     * æƒé™åˆ—è¡¨
     */
    private List<SpaceUserPermission> permissions;

    /**
     * è§’è‰²åˆ—è¡¨
     */
    private List<SpaceUserRole> roles;

    private static final long serialVersionUID = 1L;
}
```

ç©ºé—´æˆå‘˜æƒé™ï¼š

```java
@Data
public class SpaceUserPermission implements Serializable {

    /**
     * æƒé™é”®
     */
    private String key;

    /**
     * æƒé™åç§°
     */
    private String name;

    /**
     * æƒé™æè¿°
     */
    private String description;

    private static final long serialVersionUID = 1L;

}
```

ç©ºé—´æˆå‘˜è§’è‰²ï¼š

```java
@Data
public class SpaceUserRole implements Serializable {

    /**
     * è§’è‰²é”®
     */
    private String key;

    /**
     * è§’è‰²åç§°
     */
    private String name;

    /**
     * æƒé™é”®åˆ—è¡¨
     */
    private List<String> permissions;

    /**
     * è§’è‰²æè¿°
     */
    private String description;

    private static final long serialVersionUID = 1L;
}
```

3ï¼‰å®šä¹‰ç©ºé—´æˆå‘˜æƒé™å¸¸é‡ç±»ï¼Œä¾¿äºåç»­æ ¡éªŒæƒé™æ—¶ä½¿ç”¨ï¼š

```java
public interface SpaceUserPermissionConstant {
    /**
     * ç©ºé—´ç”¨æˆ·ç®¡ç†æƒé™
     */
    String SPACE_USER_MANAGE = "spaceUser:manage";

    /**
     * å›¾ç‰‡æŸ¥çœ‹æƒé™
     */
    String PICTURE_VIEW = "picture:view";

    /**
     * å›¾ç‰‡ä¸Šä¼ æƒé™
     */
    String PICTURE_UPLOAD = "picture:upload";

    /**
     * å›¾ç‰‡ç¼–è¾‘æƒé™
     */
    String PICTURE_EDIT = "picture:edit";

    /**
     * å›¾ç‰‡åˆ é™¤æƒé™
     */
    String PICTURE_DELETE = "picture:delete";
}
```

4ï¼‰åœ¨ `auth` åŒ…ä¸‹æ–°å»º SpaceUserAuthManagerï¼Œå¯åŠ è½½é…ç½®æ–‡ä»¶åˆ°å¯¹è±¡ï¼Œå¹¶æä¾›æ ¹æ®è§’è‰²è·å–æƒé™åˆ—è¡¨çš„æ–¹æ³•ã€‚

```java
@Component
public class SpaceUserAuthManager {

    @Resource
    private SpaceUserService spaceUserService;

    @Resource
    private UserService userService;

    public static final SpaceUserAuthConfig SPACE_USER_AUTH_CONFIG;

    static {
        String json = ResourceUtil.readUtf8Str("biz/spaceUserAuthConfig.json");
        SPACE_USER_AUTH_CONFIG = JSONUtil.toBean(json, SpaceUserAuthConfig.class);
    }

    /**
     * æ ¹æ®è§’è‰²è·å–æƒé™åˆ—è¡¨
     */
    public List<String> getPermissionsByRole(String spaceUserRole) {
        if (StrUtil.isBlank(spaceUserRole)) {
            return new ArrayList<>();
        }
        // æ‰¾åˆ°åŒ¹é…çš„è§’è‰²
        SpaceUserRole role = SPACE_USER_AUTH_CONFIG.getRoles().stream()
                .filter(r -> spaceUserRole.equals(r.getKey()))
                .findFirst()
                .orElse(null);
        if (role == null) {
            return new ArrayList<>();
        }
        return role.getPermissions();
    }
}
```

#### 2ã€Sa-Token å…¥é—¨

Sa-Token æ˜¯ä¸€ä¸ªè½»é‡çº§ Java æƒé™è®¤è¯æ¡†æ¶ï¼Œç›¸æ¯” Spring Security ç­‰æ›´åŠ ç®€å•æ˜“å­¦ï¼Œç”¨ä½œè€…çš„è¯è¯´ï¼Œä½¿ç”¨è¯¥æ¡†æ¶å¯ä»¥è®©é‰´æƒå˜å¾—ç®€å•ã€ä¼˜é›…~

æ¡†æ¶çš„å­¦ä¹ å¹¶ä¸éš¾ï¼Œå‚è€ƒ [å®˜æ–¹æ–‡æ¡£](https://sa-token.cc/doc.html#/start/example) å°±å¥½ï¼Œç­‰ä¸‹æˆ‘ä»¬è¦å­¦ä¹ å®æˆ˜ Sa-Token çš„ä¸»æµç‰¹æ€§å’Œé«˜çº§ç”¨æ³•ã€‚

1ï¼‰å¼•å…¥ Sa-Tokenï¼š

```xml
<!-- Sa-Token æƒé™è®¤è¯ -->
<dependency>
    <groupId>cn.dev33</groupId>
    <artifactId>sa-token-spring-boot-starter</artifactId>
    <version>1.39.0</version>
</dependency>
```

Sa-Token é»˜è®¤å°†æ•°æ®ï¼ˆæ¯”å¦‚ç”¨æˆ·ç™»å½•æ€ï¼‰ä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œæ­¤æ¨¡å¼è¯»å†™é€Ÿåº¦æœ€å¿«ï¼Œä¸”é¿å…äº†åºåˆ—åŒ–ä¸ååºåˆ—åŒ–å¸¦æ¥çš„æ€§èƒ½æ¶ˆè€—ï¼Œä½†ç¼ºç‚¹æ˜¯é‡å¯åæ•°æ®ä¼šä¸¢å¤±ã€æ— æ³•åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­å…±äº«æ•°æ®ã€‚

æˆ‘ä»¬é¡¹ç›®ä¸­æ—¢ç„¶å·²ç»ä½¿ç”¨äº† Redisï¼Œé‚£ä¹ˆå¯ä»¥ [å‚è€ƒå®˜æ–¹æ–‡æ¡£](https://sa-token.cc/doc.html#/up/integ-redis) è®© Sa-Token æ•´åˆ Redisï¼Œå°†ç”¨æˆ·çš„ç™»å½•æ€ç­‰å†…å®¹ä¿å­˜åœ¨ Redis ä¸­ã€‚

æ­¤å¤„é€‰æ‹© jackson åºåˆ—åŒ–æ–¹å¼æ•´åˆ Redisï¼Œè¿™æ ·å­˜åˆ° Redis çš„æ•°æ®æ˜¯å¯è¯»çš„ï¼š

```xml
<!-- Sa-Token æ•´åˆ Redis ï¼ˆä½¿ç”¨ jackson åºåˆ—åŒ–æ–¹å¼ï¼‰ -->
<dependency>
    <groupId>cn.dev33</groupId>
    <artifactId>sa-token-redis-jackson</artifactId>
    <version>1.39.0</version>
</dependency>
<!-- æä¾›Redisè¿æ¥æ±  -->
<dependency>
    <groupId>org.apache.commons</groupId>
    <artifactId>commons-pool2</artifactId>
</dependency>
```

2ï¼‰äº†è§£ Sa-Token çš„åŸºæœ¬ç”¨æ³•

Sa-Token çš„ä½¿ç”¨æ–¹å¼æ¯”è¾ƒç®€å•ï¼Œé¦–å…ˆæ˜¯ç”¨æˆ·ç™»å½•æ—¶è°ƒç”¨ login æ–¹æ³•ï¼Œäº§ç”Ÿä¸€ä¸ªæ–°çš„ä¼šè¯ï¼š

```java
StpUtil.login(10001);
```

è¿˜å¯ä»¥ç»™ä¼šè¯ä¿å­˜ä¸€äº›ä¿¡æ¯ï¼Œæ¯”å¦‚ç™»å½•ç”¨æˆ·çš„ä¿¡æ¯ï¼š

```java
StpUtil.getSession().set("user", user)
```

æ¥ä¸‹æ¥ä½ å°±å¯ä»¥åˆ¤æ–­ç”¨æˆ·æ˜¯å¦ç™»å½•ã€è·å–ç”¨æˆ·ä¿¡æ¯äº†ï¼Œå¯ä»¥é€šè¿‡ä»£ç è¿›è¡Œåˆ¤æ–­ï¼š

```java
// æ£€éªŒå½“å‰ä¼šè¯æ˜¯å¦å·²ç»ç™»å½•, å¦‚æœæœªç™»å½•ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ï¼š`NotLoginException`
StpUtil.checkLogin();
// è·å–ç”¨æˆ·ä¿¡æ¯
StpUtil.getSession().get("user");
```

ä¹Ÿå¯ä»¥å‚è€ƒ [å®˜æ–¹æ–‡æ¡£](https://sa-token.cc/doc.html#/use/at-check)ï¼Œä½¿ç”¨æ³¨è§£è¿›è¡Œé‰´æƒï¼š

```java
// ç™»å½•æ ¡éªŒï¼šåªæœ‰ç™»å½•ä¹‹åæ‰èƒ½è¿›å…¥è¯¥æ–¹æ³• 
@SaCheckLogin                        
@RequestMapping("info")
public String info() {
    return "æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯";
}
```

è¿™æ˜¯ Sa-Token æœ€åŸºæœ¬çš„ç”¨æ³•ï¼Œä¸‹é¢æˆ‘ä»¬æ­£å¼åœ¨é¡¹ç›®ä¸­ä½¿ç”¨ Sa-Tokenã€‚

#### 3ã€æ–°å»ºç©ºé—´è´¦å·ä½“ç³»

ç›®å‰ï¼Œæˆ‘ä»¬çš„é¡¹ç›®ä¸­å…¶å®å­˜åœ¨ä¸¤å¥—æƒé™æ ¡éªŒä½“ç³»ã€‚ä¸€å¥—æ˜¯æœ€å¼€å§‹å°±æœ‰çš„ï¼Œå¯¹ user è¡¨çš„è§’è‰²è¿›è¡Œæ ¡éªŒï¼Œåˆ†ä¸ºæ™®é€šç”¨æˆ·å’Œç®¡ç†å‘˜ï¼›å¦ä¸€å¥—æ˜¯æœ¬èŠ‚æ–°å­¦ä¹ çš„ï¼Œå¯¹å›¢é˜Ÿç©ºé—´çš„æƒé™è¿›è¡Œæ ¡éªŒã€‚

ä¸ºäº†æ›´è½»æ¾åœ°æ‰©å±•é¡¹ç›®ï¼Œå‡å°‘å¯¹åŸæœ‰ä»£ç çš„æ”¹åŠ¨ï¼Œæˆ‘ä»¬åŸæœ‰çš„ user è¡¨æƒé™æ ¡éªŒä¾ç„¶ä½¿ç”¨è‡ªå®šä¹‰æ³¨è§£ + AOP çš„æ–¹å¼å®ç°ã€‚è€Œå›¢é˜Ÿç©ºé—´æƒé™æ ¡éªŒï¼Œé‡‡ç”¨ Sa-Token æ¥ç®¡ç†ã€‚

ç›¸å½“äºæˆ‘ä»¬ä¸æ˜¯æ•´ä¸ªé¡¹ç›®éƒ½äº¤ç»™ Sa-Tokenï¼Œåªæ˜¯æŠŠ Sa-Token å½“åšå®ç°å›¢é˜Ÿç©ºé—´æƒé™ç®¡ç†çš„å·¥å…·ç½¢äº†ã€‚

è¿™ç§åŒä¸€é¡¹ç›®æœ‰å¤šè´¦å·ä½“ç³»çš„æƒ…å†µä¸‹ï¼Œä¸å»ºè®®ä½¿ç”¨ Sa-Token é»˜è®¤çš„è´¦å·ä½“ç³»ï¼Œè€Œæ˜¯ä½¿ç”¨ Sa-Token æä¾›çš„ [å¤šè´¦å·è®¤è¯ç‰¹æ€§](https://sa-token.cc/doc.html#/up/many-account?id=_5ã€kitæ¨¡å¼)ï¼Œå¯ä»¥å°†å¤šå¥—è´¦å·çš„æˆæƒç»™åŒºåˆ†å¼€ï¼Œè®©å®ƒä»¬äº’ä¸å¹²æ‰°ã€‚

1ï¼‰å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼Œä½¿ç”¨ [Kit æ¨¡å¼](https://sa-token.cc/doc.html#/up/many-account?id=_5ã€kitæ¨¡å¼) å®ç°å¤šè´¦å·è®¤è¯ï¼Œåœ¨ `auth` åŒ…ä¸‹æ–°å»º `StpKit.java`ï¼Œå®šä¹‰ç©ºé—´è´¦å·ä½“ç³»ï¼š

```java
/**
 * StpLogic é—¨é¢ç±»ï¼Œç®¡ç†é¡¹ç›®ä¸­æ‰€æœ‰çš„ StpLogic è´¦å·ä½“ç³»
 * æ·»åŠ  @Component æ³¨è§£çš„ç›®çš„æ˜¯ç¡®ä¿é™æ€å±æ€§ DEFAULT å’Œ SPACE è¢«åˆå§‹åŒ–
 */
@Component
public class StpKit {

    public static final String SPACE_TYPE = "space";

    /**
     * é»˜è®¤åŸç”Ÿä¼šè¯å¯¹è±¡ï¼Œé¡¹ç›®ä¸­ç›®å‰æ²¡ä½¿ç”¨åˆ°
     */
    public static final StpLogic DEFAULT = StpUtil.stpLogic;

    /**
     * Space ä¼šè¯å¯¹è±¡ï¼Œç®¡ç† Space è¡¨æ‰€æœ‰è´¦å·çš„ç™»å½•ã€æƒé™è®¤è¯
     */
    public static final StpLogic SPACE = new StpLogic(SPACE_TYPE);
}
```

ä¹‹åå°±å¯ä»¥åœ¨ä»£ç ä¸­ä½¿ç”¨è´¦å·ä½“ç³»ï¼Œä»¥ä¸‹æ˜¯ç¤ºä¾‹ä»£ç ï¼š

```java
// åœ¨å½“å‰ä¼šè¯è¿›è¡Œ Space è´¦å·ç™»å½•
StpKit.SPACE.login(10001);

// æ£€æµ‹å½“å‰ä¼šè¯æ˜¯å¦ä»¥ Space è´¦å·ç™»å½•ï¼Œå¹¶å…·æœ‰ picture:edit æƒé™
StpKit.SPACE.checkPermission("picture:edit");

// è·å–å½“å‰ Space ä¼šè¯çš„ Session å¯¹è±¡ï¼Œå¹¶è¿›è¡Œå†™å€¼æ“ä½œ 
StpKit.SPACE.getSession().set("user", "ç¨‹åºå‘˜é±¼çš®");
```

2ï¼‰ä¿®æ”¹ç”¨æˆ·æœåŠ¡çš„ userLogin æ–¹æ³•ï¼Œç”¨æˆ·ç™»å½•æˆåŠŸåï¼Œä¿å­˜ç™»å½•æ€åˆ° Sa-Token çš„ç©ºé—´è´¦å·ä½“ç³»ä¸­ï¼š

```java
// 3. è®°å½•ç”¨æˆ·çš„ç™»å½•æ€
request.getSession().setAttribute(USER_LOGIN_STATE, user);
// 4. è®°å½•ç”¨æˆ·ç™»å½•æ€åˆ° Sa-tokenï¼Œä¾¿äºç©ºé—´é‰´æƒæ—¶ä½¿ç”¨ï¼Œæ³¨æ„ä¿è¯è¯¥ç”¨æˆ·ä¿¡æ¯ä¸ SpringSession ä¸­çš„ä¿¡æ¯è¿‡æœŸæ—¶é—´ä¸€è‡´
StpKit.SPACE.login(user.getId());
StpKit.SPACE.getSession().set(USER_LOGIN_STATE, user);
return this.getLoginUserVO(user);
```

#### 4ã€æƒé™è®¤è¯é€»è¾‘

Sa-Token å¼€å‘çš„æ ¸å¿ƒæ˜¯ç¼–å†™æƒé™è®¤è¯ç±»ï¼Œæˆ‘ä»¬éœ€è¦åœ¨è¯¥ç±»ä¸­å®ç° â€œå¦‚ä½•æ ¹æ®ç™»å½•ç”¨æˆ· id è·å–åˆ°ç”¨æˆ·å·²æœ‰çš„è§’è‰²å’Œæƒé™åˆ—è¡¨â€ æ–¹æ³•ã€‚å½“è¦åˆ¤æ–­æŸç”¨æˆ·æ˜¯å¦æœ‰æŸä¸ªè§’è‰²æˆ–æƒé™æ—¶ï¼ŒSa-Token ä¼šå…ˆæ‰§è¡Œæˆ‘ä»¬ç¼–å†™çš„æ–¹æ³•ï¼Œå¾—åˆ°è¯¥ç”¨æˆ·çš„è§’è‰²æˆ–æƒé™åˆ—è¡¨ï¼Œç„¶åè·Ÿéœ€è¦çš„è§’è‰²æƒé™è¿›è¡Œæ¯”å¯¹ã€‚

å‚è€ƒ [å®˜æ–¹æ–‡æ¡£](https://sa-token.cc/doc.html#/use/jur-auth)ï¼Œç¤ºä¾‹æƒé™è®¤è¯ç±»å¦‚ä¸‹ï¼š

```java
/**
 * è‡ªå®šä¹‰æƒé™åŠ è½½æ¥å£å®ç°ç±»
 */
@Component    // ä¿è¯æ­¤ç±»è¢« SpringBoot æ‰«æï¼Œå®Œæˆ Sa-Token çš„è‡ªå®šä¹‰æƒé™éªŒè¯æ‰©å±• 
public class StpInterfaceImpl implements StpInterface {

    /**
     * è¿”å›ä¸€ä¸ªè´¦å·æ‰€æ‹¥æœ‰çš„æƒé™ç é›†åˆ 
     */
    @Override
    public List<String> getPermissionList(Object loginId, String loginType) {
        // æœ¬ list ä»…åšæ¨¡æ‹Ÿï¼Œå®é™…é¡¹ç›®ä¸­è¦æ ¹æ®å…·ä½“ä¸šåŠ¡é€»è¾‘æ¥æŸ¥è¯¢æƒé™
        List<String> list = new ArrayList<String>();    
        list.add("user.add");
        list.add("user.update");
        list.add("user.get");
        list.add("art.*");
        return list;
    }

    /**
     * è¿”å›ä¸€ä¸ªè´¦å·æ‰€æ‹¥æœ‰çš„è§’è‰²æ ‡è¯†é›†åˆ (æƒé™ä¸è§’è‰²å¯åˆ†å¼€æ ¡éªŒ)
     */
    @Override
    public List<String> getRoleList(Object loginId, String loginType) {
        // æœ¬ list ä»…åšæ¨¡æ‹Ÿï¼Œå®é™…é¡¹ç›®ä¸­è¦æ ¹æ®å…·ä½“ä¸šåŠ¡é€»è¾‘æ¥æŸ¥è¯¢è§’è‰²
        List<String> list = new ArrayList<String>();    
        list.add("admin");
        list.add("super-admin");
        return list;
    }
}
```

Sa-Token æ”¯æŒæŒ‰ç…§è§’è‰²å’Œæƒé™æ ¡éªŒï¼Œå¯¹äºæƒé™ä¸å¤šçš„é¡¹ç›®ï¼ŒåŸºäºè§’è‰²æ ¡éªŒå³å¯ï¼›å¯¹äºæƒé™è¾ƒå¤šçš„é¡¹ç›®ï¼Œå»ºè®®æ ¹æ®æƒé™æ ¡éªŒã€‚å¯¹äºæœ¬é¡¹ç›®ï¼Œè™½ç„¶æƒé™å¹¶ä¸å¤šï¼Œä½†æ˜¯è€ƒè™‘åˆ°æ‰©å±•æ€§ï¼Œè¿˜æ˜¯ **é€‰æ‹©æ›´ç»†ç²’åº¦çš„æƒé™æ ¡éªŒ**ï¼Œä¸šåŠ¡å«ä¹‰ä¼šæ›´æ˜ç¡®ã€‚

è§‚å¯Ÿä¸Šè¿°ä»£ç æˆ‘ä»¬ä¼šå‘ç°ï¼Œ`getPermissionList` æ–¹æ³•åªæä¾›äº† loginIdï¼ˆç™»å½•ç”¨æˆ· idï¼‰å’Œ loginTypeï¼ˆè´¦å·ä½“ç³»ï¼‰ä¸¤ä¸ªå‚æ•°ã€‚è¿™ä¼šç»™æˆ‘ä»¬é€ æˆå¾ˆå¤§çš„éš¾åº¦ï¼š

- æˆ‘ä»¬å…‰æœ‰ç”¨æˆ· id æ˜¯æ²¡åŠæ³•è¿›è¡Œæƒé™æ ¡éªŒçš„ï¼Œå› ä¸ºæˆ‘ä»¬è¦ç»™å›¾ç‰‡æ“ä½œå’Œç©ºé—´æˆå‘˜æ“ä½œå¢åŠ æƒé™æ ¡éªŒé€»è¾‘ï¼Œè¿˜éœ€è¦è·å–åˆ°ç©ºé—´ idï¼Œæ‰çŸ¥é“ç”¨æˆ·æ˜¯å¦å…·æœ‰æŸä¸ªå›¢é˜Ÿç©ºé—´çš„æƒé™ã€‚**é‚£ä¹ˆå¦‚ä½•è·å–åˆ°ç©ºé—´ id å‘¢ï¼Ÿ**
- å¦‚æœè¦è¿›è¡Œç»Ÿä¸€çš„æƒé™æ ¡éªŒï¼Œä¹ŸåŒ…æ‹¬äº†å…¬å…±å›¾åº“å’Œç§æœ‰ç©ºé—´ï¼Œæ›´è¦å‘½çš„æ˜¯ï¼Œå…¬å…±å›¾åº“æ˜¯æ²¡æœ‰ç©ºé—´ id çš„ï¼**è¿™å°±æ„å‘³ç€è¦æ ¹æ®æ“ä½œçš„å›¾ç‰‡æƒ…å†µåŠ¨æ€åˆ¤æ–­ã€‚**

æ‰€ä»¥æˆ‘ä»¬è¦è§£å†³çš„å…³é”®é—®é¢˜æœ‰ 2 ä¸ªï¼š

1. å¦‚ä½•åœ¨ Sa-Token ä¸­è·å–å½“å‰è¯·æ±‚æ“ä½œçš„å‚æ•°ï¼Ÿ
2. å¦‚ä½•ç¼–å†™ä¸€å¥—æƒé™æ ¡éªŒé€»è¾‘ï¼ŒåŒæ—¶å…¼å®¹å…¬å…±å›¾åº“ã€ç§æœ‰ç©ºé—´å’Œå›¢é˜Ÿç©ºé—´ï¼Ÿ

**1ï¼‰å…ˆçœ‹ç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œä½¿ç”¨ Sa-Token æœ‰ 2 ç§æ–¹å¼ â€”â€” æ³¨è§£å¼å’Œç¼–ç¨‹å¼ã€‚**

å¦‚æœä½¿ç”¨æ³¨è§£å¼ï¼Œé‚£ä¹ˆåœ¨æ¥å£è¢«è°ƒç”¨æ—¶å°±ä¼šç«‹åˆ»è§¦å‘ Sa-Token çš„æƒé™æ ¡éªŒï¼Œæ­¤æ—¶å‚æ•°åªèƒ½é€šè¿‡ Servlet çš„è¯·æ±‚å¯¹è±¡ä¼ é€’ã€‚

å¦‚æœä½¿ç”¨ç¼–ç¨‹å¼ï¼Œå¯ä»¥åœ¨ä»£ç ä»»æ„ä½ç½®æ‰§è¡Œæƒé™æ ¡éªŒï¼Œåªè¦åœ¨æ‰§è¡Œå‰å°†å‚æ•°æ”¾åˆ°å½“å‰çº¿ç¨‹çš„ä¸Šä¸‹æ–‡ ThreadLocal å¯¹è±¡ä¸­ï¼Œå°±èƒ½åœ¨é‰´æƒæ—¶è·å–åˆ°äº†ã€‚

ä¸ºäº†åç»­æˆ‘ä»¬ç»™æ¥å£æ·»åŠ é‰´æƒæ›´ç›´è§‚æ–¹ä¾¿ï¼Œæˆ‘ä»¬é€‰æ‹©æ³¨è§£å¼é‰´æƒã€‚é‚£å°±æœ‰ä¸€ä¸ªå…³é”®é—®é¢˜ï¼Œä¸åŒæ¥å£çš„è¯·æ±‚å‚æ•°æ˜¯ä¸åŒçš„ï¼Œæœ‰çš„è¯·æ±‚å‚æ•°æœ‰ spaceIdã€æœ‰çš„åªæœ‰ pictureIdï¼Œæ€ä¹ˆåŠå‘¢ï¼Ÿ

æˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€ä¸ª **ä¸Šä¸‹æ–‡ç±»**ï¼Œç”¨äºç»Ÿä¸€æ¥æ”¶è¯·æ±‚ä¸­ä¼ é€’æ¥çš„å‚æ•°ï¼š

```java
/**
 * SpaceUserAuthContext
 * è¡¨ç¤ºç”¨æˆ·åœ¨ç‰¹å®šç©ºé—´å†…çš„æˆæƒä¸Šä¸‹æ–‡ï¼ŒåŒ…æ‹¬å…³è”çš„å›¾ç‰‡ã€ç©ºé—´å’Œç”¨æˆ·ä¿¡æ¯ã€‚
 */
@Data
public class SpaceUserAuthContext {

    /**
     * ä¸´æ—¶å‚æ•°ï¼Œä¸åŒè¯·æ±‚å¯¹åº”çš„ id å¯èƒ½ä¸åŒ
     */
    private Long id;

    /**
     * å›¾ç‰‡ ID
     */
    private Long pictureId;

    /**
     * ç©ºé—´ ID
     */
    private Long spaceId;

    /**
     * ç©ºé—´ç”¨æˆ· ID
     */
    private Long spaceUserId;

    /**
     * å›¾ç‰‡ä¿¡æ¯
     */
    private Picture picture;

    /**
     * ç©ºé—´ä¿¡æ¯
     */
    private Space space;

    /**
     * ç©ºé—´ç”¨æˆ·ä¿¡æ¯
     */
    private SpaceUser spaceUser;
}
```

å¦‚ä½•çŸ¥é“å“ªä¸ªè¯·æ±‚åŒ…å«äº†å“ªäº›å­—æ®µå‘¢ï¼Ÿåˆ«å¿˜äº†ï¼Œæˆ‘ä»¬æ¯ç±»æ“ä½œï¼ˆå›¾ç‰‡ / ç©ºé—´æˆå‘˜ï¼‰çš„è¯·æ±‚å‰ç¼€éƒ½æ˜¯å›ºå®šçš„ï¼Œå¯ä»¥ä»è¯·æ±‚è·¯å¾„ä¸­æå–åˆ°è¦è®¿é—®çš„æ˜¯å“ªä¸ª Controllerï¼Œè€Œæ¯ç±» Controller çš„è¯·æ±‚å‚æ•°ï¼Œéƒ½æ˜¯ä¸€è‡´çš„ã€‚

ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœè®¿é—®åœ°å€æ˜¯ `/api/picture/xxx`ï¼Œé‚£ä¹ˆä¸€å®šæ˜¯è¦è°ƒç”¨ PictureController çš„æ¥å£ï¼Œè¿™äº›æ¥å£çš„ id å­—æ®µéƒ½è¡¨ç¤º pictureIdã€‚æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡è®¿é—®åœ°å€æ¥å†³å®šåº”è¯¥ç»™ä¸Šä¸‹æ–‡ä¼ é€’å“ªäº›å­—æ®µï¼Œä»£ç å¦‚ä¸‹ï¼š

```java
@Value("${server.servlet.context-path}")
private String contextPath;

/**
 * ä»è¯·æ±‚ä¸­è·å–ä¸Šä¸‹æ–‡å¯¹è±¡
 */
private SpaceUserAuthContext getAuthContextByRequest() {
    HttpServletRequest request = ((ServletRequestAttributes) RequestContextHolder.currentRequestAttributes()).getRequest();
    String contentType = request.getHeader(Header.CONTENT_TYPE.getValue());
    SpaceUserAuthContext authRequest;
    // å…¼å®¹ get å’Œ post æ“ä½œ
    if (ContentType.JSON.getValue().equals(contentType)) {
        String body = ServletUtil.getBody(request);
        authRequest = JSONUtil.toBean(body, SpaceUserAuthContext.class);
    } else {
        Map<String, String> paramMap = ServletUtil.getParamMap(request);
        authRequest = BeanUtil.toBean(paramMap, SpaceUserAuthContext.class);
    }
    // æ ¹æ®è¯·æ±‚è·¯å¾„åŒºåˆ† id å­—æ®µçš„å«ä¹‰
    Long id = authRequest.getId();
    if (ObjUtil.isNotNull(id)) {
        String requestUri = request.getRequestURI();
        String partUri = requestUri.replace(contextPath + "/", "");
        String moduleName = StrUtil.subBefore(partUri, "/", false);
        switch (moduleName) {
            case "picture":
                authRequest.setPictureId(id);
                break;
            case "spaceUser":
                authRequest.setSpaceUserId(id);
                break;
            case "space":
                authRequest.setSpaceId(id);
                break;
            default:
        }
    }
    return authRequest;
}
```

æ³¨æ„ï¼Œä¸Šè¿°ä»£ç ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ Hutool çš„å·¥å…·ç±» `ServletUtil` ä» HttpServletRequest ä¸­è·å–åˆ°äº†å‚æ•°ä¿¡æ¯ï¼Œä½†æ˜¯å‘çˆ¹çš„æ˜¯ï¼ŒHttpServletRequest çš„ body å€¼æ˜¯ä¸ªæµï¼Œ**åªæ”¯æŒè¯»å–ä¸€æ¬¡ï¼Œè¯»å®Œå°±æ²¡äº†ï¼**æ‰€ä»¥ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬è¿˜è¦åœ¨ `config` åŒ…ä¸‹è‡ªå®šä¹‰è¯·æ±‚åŒ…è£…ç±»å’Œè¯·æ±‚åŒ…è£…ç±»è¿‡æ»¤å™¨ã€‚è¿™äº›å°±æ˜¯æ ·æ¿ä»£ç äº†ï¼Œå¤§å®¶ç›´æ¥å¤åˆ¶ç²˜è´´å³å¯ï¼Œä¸ç”¨ç¼–ç ã€‚

RequestWrapper è¯·æ±‚åŒ…è£…ç±»ï¼š

```java
/**
 * åŒ…è£…è¯·æ±‚ï¼Œä½¿ InputStream å¯ä»¥é‡å¤è¯»å–
 *
 * @author pine
 */
@Slf4j
public class RequestWrapper extends HttpServletRequestWrapper {

    private final String body;

    public RequestWrapper(HttpServletRequest request) {
        super(request);
        StringBuilder stringBuilder = new StringBuilder();
        try (InputStream inputStream = request.getInputStream(); BufferedReader bufferedReader = new BufferedReader(new InputStreamReader(inputStream))) {
            char[] charBuffer = new char[128];
            int bytesRead = -1;
            while ((bytesRead = bufferedReader.read(charBuffer)) > 0) {
                stringBuilder.append(charBuffer, 0, bytesRead);
            }
        } catch (IOException ignored) {
        }
        body = stringBuilder.toString();
    }

    @Override
    public ServletInputStream getInputStream() throws IOException {
        final ByteArrayInputStream byteArrayInputStream = new ByteArrayInputStream(body.getBytes());
        return new ServletInputStream() {
            @Override
            public boolean isFinished() {
                return false;
            }

            @Override
            public boolean isReady() {
                return false;
            }

            @Override
            public void setReadListener(ReadListener readListener) {
            }

            @Override
            public int read() throws IOException {
                return byteArrayInputStream.read();
            }
        };

    }

    @Override
    public BufferedReader getReader() throws IOException {
        return new BufferedReader(new InputStreamReader(this.getInputStream()));
    }

    public String getBody() {
        return this.body;
    }

}
```

HttpRequestWrapperFilter è¯·æ±‚åŒ…è£…è¿‡æ»¤å™¨ï¼š

```java
/**
 * è¯·æ±‚åŒ…è£…è¿‡æ»¤å™¨
 *
 * @author pine
 */
@Order(1)
@Component
public class HttpRequestWrapperFilter implements Filter {

    @Override
    public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) throws ServletException, IOException {
        if (request instanceof HttpServletRequest) {
            HttpServletRequest servletRequest = (HttpServletRequest) request;
            String contentType = servletRequest.getHeader(Header.CONTENT_TYPE.getValue());
            if (ContentType.JSON.getValue().equals(contentType)) {
                // å¯ä»¥å†ç»†ç²’åº¦ä¸€äº›ï¼Œåªæœ‰éœ€è¦è¿›è¡Œç©ºé—´æƒé™æ ¡éªŒçš„æ¥å£æ‰éœ€è¦åŒ…ä¸€å±‚
                chain.doFilter(new RequestWrapper(servletRequest), response);
            } else {
                chain.doFilter(request, response);
            }
        }
    }

}
```

è¿™æ ·æˆ‘ä»¬å°±èƒ½æ­£å¸¸è·å–åˆ°è¯·æ±‚å‚æ•°äº†~

**2ï¼‰ç¼–å†™é€šç”¨çš„æƒé™æ ¡éªŒé€»è¾‘ï¼Œå…¼å®¹å…¬å…±å›¾åº“ã€ç§æœ‰ç©ºé—´å’Œå›¢é˜Ÿç©ºé—´**

è¿™ä¸ªæ²¡å•¥å¥½è¯´çš„ï¼Œå°±æ˜¯å†™ä¸šåŠ¡é€»è¾‘ï¼Œè€Œä¸”æ˜¯æ¯”è¾ƒå¤æ‚çš„ä¸šåŠ¡é€»è¾‘ï¼Œæ‰€ä»¥å»ºè®®ä¸€å®šè¦å…ˆæŠŠä¸šåŠ¡æµç¨‹æ¢³ç†æ¸…æ¥šï¼Œå†ç¼–å†™ä»£ç ã€‚

ä¸šåŠ¡æµç¨‹å¦‚ä¸‹ï¼š

1. æ ¡éªŒç™»å½•ç±»å‹ï¼šå¦‚æœ `loginType` ä¸æ˜¯ `"space"`ï¼Œç›´æ¥è¿”å›ç©ºæƒé™åˆ—è¡¨ã€‚
2. ç®¡ç†å‘˜æƒé™å¤„ç†ï¼šå¦‚æœå½“å‰ç”¨æˆ·ä¸ºç®¡ç†å‘˜ï¼Œç›´æ¥è¿”å›ç®¡ç†å‘˜æƒé™åˆ—è¡¨ã€‚
3. è·å–ä¸Šä¸‹æ–‡å¯¹è±¡ï¼šä»è¯·æ±‚ä¸­è·å– `SpaceUserAuthContext` ä¸Šä¸‹æ–‡ï¼Œæ£€æŸ¥ä¸Šä¸‹æ–‡å­—æ®µæ˜¯å¦ä¸ºç©ºã€‚**å¦‚æœä¸Šä¸‹æ–‡ä¸­æ‰€æœ‰å­—æ®µå‡ä¸ºç©ºï¼ˆå¦‚æ²¡æœ‰ç©ºé—´æˆ–å›¾ç‰‡ä¿¡æ¯ï¼‰ï¼Œè§†ä¸ºå…¬å…±å›¾åº“æ“ä½œï¼Œç›´æ¥è¿”å›ç®¡ç†å‘˜æƒé™åˆ—è¡¨ã€‚**
4. æ ¡éªŒç™»å½•çŠ¶æ€ï¼šé€šè¿‡ `loginId` è·å–å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯ã€‚å¦‚æœç”¨æˆ·æœªç™»å½•ï¼ŒæŠ›å‡ºæœªæˆæƒå¼‚å¸¸ï¼›å¦åˆ™è·å–ç”¨æˆ·çš„å”¯ä¸€æ ‡è¯† `userId`ï¼Œç”¨äºåç»­æƒé™åˆ¤æ–­ã€‚
5. ä»ä¸Šä¸‹æ–‡ä¸­ä¼˜å…ˆè·å– `SpaceUser` å¯¹è±¡ï¼šå¦‚æœä¸Šä¸‹æ–‡ä¸­å­˜åœ¨ `SpaceUser` å¯¹è±¡ï¼Œç›´æ¥æ ¹æ®å…¶è§’è‰²è·å–æƒé™ç åˆ—è¡¨ã€‚
6. é€šè¿‡ `spaceUserId` è·å–ç©ºé—´ç”¨æˆ·ä¿¡æ¯ï¼šå¦‚æœä¸Šä¸‹æ–‡ä¸­å­˜åœ¨ `spaceUserId`ï¼š

- æŸ¥è¯¢å¯¹åº”çš„ `SpaceUser` æ•°æ®ã€‚å¦‚æœæœªæ‰¾åˆ°ï¼ŒæŠ›å‡ºæ•°æ®æœªæ‰¾åˆ°å¼‚å¸¸ã€‚
- æ ¡éªŒå½“å‰ç™»å½•ç”¨æˆ·æ˜¯å¦å±äºè¯¥ç©ºé—´ï¼Œå¦‚æœä¸æ˜¯ï¼Œè¿”å›ç©ºæƒé™åˆ—è¡¨ã€‚
- å¦åˆ™ï¼Œæ ¹æ®ç™»å½•ç”¨æˆ·åœ¨è¯¥ç©ºé—´çš„è§’è‰²ï¼Œè¿”å›ç›¸åº”çš„æƒé™ç åˆ—è¡¨ã€‚

1. é€šè¿‡ `spaceId` æˆ– `pictureId` è·å–ç©ºé—´æˆ–å›¾ç‰‡ä¿¡æ¯

- å¦‚æœ `spaceId` ä¸å­˜åœ¨ï¼šä½¿ç”¨ `pictureId` æŸ¥è¯¢å›¾ç‰‡ä¿¡æ¯ï¼Œå¹¶é€šè¿‡å›¾ç‰‡çš„ `spaceId` ç»§ç»­åˆ¤æ–­æƒé™ï¼›å¦‚æœ `pictureId` å’Œ `spaceId` å‡ä¸ºç©ºï¼Œé»˜è®¤è§†ä¸ºç®¡ç†å‘˜æƒé™ã€‚
- å¯¹äºå…¬å…±å›¾åº“ï¼š**å¦‚æœå›¾ç‰‡æ˜¯å½“å‰ç”¨æˆ·ä¸Šä¼ çš„ï¼Œæˆ–è€…å½“å‰ç”¨æˆ·ä¸ºç®¡ç†å‘˜**ï¼Œè¿”å›ç®¡ç†å‘˜æƒé™åˆ—è¡¨ï¼›å¦‚æœå›¾ç‰‡ä¸æ˜¯å½“å‰ç”¨æˆ·ä¸Šä¼ çš„ï¼Œè¿”å›ä»…å…è®¸æŸ¥çœ‹çš„æƒé™ç ã€‚

1. è·å– `Space` å¯¹è±¡å¹¶åˆ¤æ–­ç©ºé—´ç±»å‹ï¼šæŸ¥è¯¢ `Space` ä¿¡æ¯ï¼Œå¦‚æœæœªæ‰¾åˆ°ç©ºé—´æ•°æ®ï¼ŒæŠ›å‡ºæ•°æ®æœªæ‰¾åˆ°å¼‚å¸¸ã€‚å¦åˆ™æ ¹æ®ç©ºé—´ç±»å‹è¿›è¡Œåˆ¤æ–­

- ç§æœ‰ç©ºé—´ï¼šä»…ç©ºé—´æ‰€æœ‰è€…å’Œç®¡ç†å‘˜æœ‰æƒé™ï¼ˆå³è¿”å›å…¨éƒ¨æƒé™ï¼‰ï¼Œå…¶ä»–ç”¨æˆ·è¿”å›ç©ºæƒé™åˆ—è¡¨ã€‚
- å›¢é˜Ÿç©ºé—´ï¼šæŸ¥è¯¢ç™»å½•ç”¨æˆ·åœ¨è¯¥ç©ºé—´çš„è§’è‰²ï¼Œå¹¶è¿”å›å¯¹åº”çš„æƒé™ç åˆ—è¡¨ã€‚å¦‚æœç”¨æˆ·ä¸å±äºè¯¥ç©ºé—´ï¼Œè¿”å›ç©ºæƒé™åˆ—è¡¨ã€‚

æ ¹æ®ä¸šåŠ¡æµç¨‹ç¼–å†™ä»£ç ï¼š

```java
public List<String> getPermissionList(Object loginId, String loginType) {
    // åˆ¤æ–­ loginTypeï¼Œä»…å¯¹ç±»å‹ä¸º "space" è¿›è¡Œæƒé™æ ¡éªŒ
    if (!StpKit.SPACE_TYPE.equals(loginType)) {
        return new ArrayList<>();
    }
    // ç®¡ç†å‘˜æƒé™ï¼Œè¡¨ç¤ºæƒé™æ ¡éªŒé€šè¿‡
    List<String> ADMIN_PERMISSIONS = spaceUserAuthManager.getPermissionsByRole(SpaceRoleEnum.ADMIN.getValue());
    // è·å–ä¸Šä¸‹æ–‡å¯¹è±¡
    SpaceUserAuthContext authContext = getAuthContextByRequest();
    // å¦‚æœæ‰€æœ‰å­—æ®µéƒ½ä¸ºç©ºï¼Œè¡¨ç¤ºæŸ¥è¯¢å…¬å…±å›¾åº“ï¼Œå¯ä»¥é€šè¿‡
    if (isAllFieldsNull(authContext)) {
        return ADMIN_PERMISSIONS;
    }
    // è·å– userId
    User loginUser = (User) StpKit.SPACE.getSessionByLoginId(loginId).get(USER_LOGIN_STATE);
    if (loginUser == null) {
        throw new BusinessException(ErrorCode.NO_AUTH_ERROR, "ç”¨æˆ·æœªç™»å½•");
    }
    Long userId = loginUser.getId();
    // ä¼˜å…ˆä»ä¸Šä¸‹æ–‡ä¸­è·å– SpaceUser å¯¹è±¡
    SpaceUser spaceUser = authContext.getSpaceUser();
    if (spaceUser != null) {
        return spaceUserAuthManager.getPermissionsByRole(spaceUser.getSpaceRole());
    }
    // å¦‚æœæœ‰ spaceUserIdï¼Œå¿…ç„¶æ˜¯å›¢é˜Ÿç©ºé—´ï¼Œé€šè¿‡æ•°æ®åº“æŸ¥è¯¢ SpaceUser å¯¹è±¡
    Long spaceUserId = authContext.getSpaceUserId();
    if (spaceUserId != null) {
        spaceUser = spaceUserService.getById(spaceUserId);
        if (spaceUser == null) {
            throw new BusinessException(ErrorCode.NOT_FOUND_ERROR, "æœªæ‰¾åˆ°ç©ºé—´ç”¨æˆ·ä¿¡æ¯");
        }
        // å–å‡ºå½“å‰ç™»å½•ç”¨æˆ·å¯¹åº”çš„ spaceUser
        SpaceUser loginSpaceUser = spaceUserService.lambdaQuery()
                .eq(SpaceUser::getSpaceId, spaceUser.getSpaceId())
                .eq(SpaceUser::getUserId, userId)
                .one();
        if (loginSpaceUser == null) {
            return new ArrayList<>();
        }
        // è¿™é‡Œä¼šå¯¼è‡´ç®¡ç†å‘˜åœ¨ç§æœ‰ç©ºé—´æ²¡æœ‰æƒé™ï¼Œå¯ä»¥å†æŸ¥ä¸€æ¬¡åº“å¤„ç†
        return spaceUserAuthManager.getPermissionsByRole(loginSpaceUser.getSpaceRole());
    }
    // å¦‚æœæ²¡æœ‰ spaceUserIdï¼Œå°è¯•é€šè¿‡ spaceId æˆ– pictureId è·å– Space å¯¹è±¡å¹¶å¤„ç†
    Long spaceId = authContext.getSpaceId();
    if (spaceId == null) {
        // å¦‚æœæ²¡æœ‰ spaceIdï¼Œé€šè¿‡ pictureId è·å– Picture å¯¹è±¡å’Œ Space å¯¹è±¡
        Long pictureId = authContext.getPictureId();
        // å›¾ç‰‡ id ä¹Ÿæ²¡æœ‰ï¼Œåˆ™é»˜è®¤é€šè¿‡æƒé™æ ¡éªŒ
        if (pictureId == null) {
            return ADMIN_PERMISSIONS;
        }
        Picture picture = pictureService.lambdaQuery()
                .eq(Picture::getId, pictureId)
                .select(Picture::getId, Picture::getSpaceId, Picture::getUserId)
                .one();
        if (picture == null) {
            throw new BusinessException(ErrorCode.NOT_FOUND_ERROR, "æœªæ‰¾åˆ°å›¾ç‰‡ä¿¡æ¯");
        }
        spaceId = picture.getSpaceId();
        // å…¬å…±å›¾åº“ï¼Œä»…æœ¬äººæˆ–ç®¡ç†å‘˜å¯æ“ä½œ
        if (spaceId == null) {
            if (picture.getUserId().equals(userId) || userService.isAdmin(loginUser)) {
                return ADMIN_PERMISSIONS;
            } else {
                // ä¸æ˜¯è‡ªå·±çš„å›¾ç‰‡ï¼Œä»…å¯æŸ¥çœ‹
                return Collections.singletonList(SpaceUserPermissionConstant.PICTURE_VIEW);
            }
        }
    }
    // è·å– Space å¯¹è±¡
    Space space = spaceService.getById(spaceId);
    if (space == null) {
        throw new BusinessException(ErrorCode.NOT_FOUND_ERROR, "æœªæ‰¾åˆ°ç©ºé—´ä¿¡æ¯");
    }
    // æ ¹æ® Space ç±»å‹åˆ¤æ–­æƒé™
    if (space.getSpaceType() == SpaceTypeEnum.PRIVATE.getValue()) {
        // ç§æœ‰ç©ºé—´ï¼Œä»…æœ¬äººæˆ–ç®¡ç†å‘˜æœ‰æƒé™
        if (space.getUserId().equals(userId) || userService.isAdmin(loginUser)) {
            return ADMIN_PERMISSIONS;
        } else {
            return new ArrayList<>();
        }
    } else {
        // å›¢é˜Ÿç©ºé—´ï¼ŒæŸ¥è¯¢ SpaceUser å¹¶è·å–è§’è‰²å’Œæƒé™
        spaceUser = spaceUserService.lambdaQuery()
                .eq(SpaceUser::getSpaceId, spaceId)
                .eq(SpaceUser::getUserId, userId)
                .one();
        if (spaceUser == null) {
            return new ArrayList<>();
        }
        return spaceUserAuthManager.getPermissionsByRole(spaceUser.getSpaceRole());
    }
}
```

ä¸Šè¿°ä»£ç ä¾èµ– â€œåˆ¤æ–­æ‰€æœ‰å­—æ®µéƒ½ä¸ºç©ºâ€ çš„æ–¹æ³•ï¼Œé€šè¿‡åå°„è·å–å¯¹è±¡çš„æ‰€æœ‰å­—æ®µï¼Œè¿›è¡Œåˆ¤ç©ºï¼š

```java
private boolean isAllFieldsNull(Object object) {
    if (object == null) {
        return true; // å¯¹è±¡æœ¬èº«ä¸ºç©º
    }
    // è·å–æ‰€æœ‰å­—æ®µå¹¶åˆ¤æ–­æ˜¯å¦æ‰€æœ‰å­—æ®µéƒ½ä¸ºç©º
    return Arrays.stream(ReflectUtil.getFields(object.getClass()))
            // è·å–å­—æ®µå€¼
            .map(field -> ReflectUtil.getFieldValue(object, field))
            // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰å­—æ®µéƒ½ä¸ºç©º
            .allMatch(ObjectUtil::isEmpty);
}
```

OKï¼Œè¿™å°±æ˜¯ Sa-Token åŠ¨æ€æƒé™æ ¡éªŒçš„æ ¸å¿ƒä»£ç ï¼Œä½ ä¼šå‘ç°ç¼–å†™ä¸€å¥—ç»Ÿä¸€çš„æƒé™æ ¡éªŒé€»è¾‘å¹¶ä¸å®¹æ˜“ï¼Œæ‰€ä»¥å®é™…é¡¹ç›®ä¸­è¦ **æŒ‰éœ€ä½¿ç”¨** ç¬¬ä¸‰æ–¹æƒé™æ ¡éªŒæ¡†æ¶ã€‚

ğŸ’¡ æ³¨æ„ï¼Œé‡‡ç”¨æ³¨è§£å¼é‰´æƒ + é€šè¿‡è¯·æ±‚å¯¹è±¡è·å–å‚æ•°æ—¶ï¼Œå¯èƒ½ä¼šé‡å¤æŸ¥è¯¢æ•°æ®åº“ã€‚æ¯”å¦‚ä¸šåŠ¡ä»£ç ä¸­å·²ç»æœ‰æ ¹æ® id æŸ¥è¯¢ç©ºé—´ä¿¡æ¯çš„ä»£ç äº†ï¼Œä½†ä¸ºäº†æƒé™æ ¡éªŒï¼Œä¹ŸæŸ¥åº“è·å–äº†ä¸€æ¬¡ç©ºé—´ä¿¡æ¯ï¼Œä¼šå¯¹æ€§èƒ½é€ æˆå½±å“ã€‚å¦‚æœæƒ³æ›´çµæ´»ã€æ›´é«˜æ€§èƒ½åœ°å®ç°é‰´æƒï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨ç¼–ç¨‹å¼é‰´æƒã€‚è·å–æƒé™çš„æ–¹æ³•å’Œä¸Šä¸‹æ–‡ç±»éƒ½æ˜¯å¯ä»¥å¤ç”¨çš„ï¼Œåªéœ€è¦å°† `getAuthContextByRequest` æ–¹æ³•çš„é€»è¾‘æ”¹ä¸ºä» ThreadLocal ä¸Šä¸‹æ–‡ä¸­è·å–å³å¯ã€‚

åŸºäº ThreadLocal å®ç°ä¸Šä¸‹æ–‡ç®¡ç†çš„ç¤ºä¾‹ä»£ç ï¼š

```java
public class SaTokenContextHolder {

    private static final ThreadLocal<Map<String, Object>> CONTEXT = ThreadLocal.withInitial(HashMap::new);

    // è®¾ç½®ä¸Šä¸‹æ–‡æ•°æ®
    public static void set(String key, Object value) {
        CONTEXT.get().put(key, value);
    }

    // è·å–ä¸Šä¸‹æ–‡æ•°æ®
    public static Object get(String key) {
        return CONTEXT.get().get(key);
    }

    // æ¸…ç†ä¸Šä¸‹æ–‡æ•°æ®ï¼ˆé˜²æ­¢å†…å­˜æ³„æ¼ï¼‰
    public static void clear() {
        CONTEXT.remove();
    }
}
```

#### 5ã€æƒé™æ ¡éªŒæ³¨è§£

é»˜è®¤æƒ…å†µä¸‹ä½¿ç”¨ [æ³¨è§£å¼é‰´æƒ](https://sa-token.cc/doc.html#/use/at-check)ï¼Œéœ€è¦æ–°å»ºé…ç½®ç±»ï¼š

![img](assets/erLCPuesrV9oDMr0.webp)

ä½†ç”±äºæˆ‘ä»¬ä½¿ç”¨äº†å¤šè´¦å·ä½“ç³»ï¼Œæ¯æ¬¡ä½¿ç”¨æ³¨è§£æ—¶éƒ½è¦æŒ‡å®šè´¦å·ä½“ç³»çš„ loginTypeï¼Œä¼šæ¯”è¾ƒéº»çƒ¦ï¼š

```java
@SaCheckLogin(type = StpUserUtil.TYPE)
```

æ‰€ä»¥å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼Œä½¿ç”¨ [æ³¨è§£åˆå¹¶](https://sa-token.cc/doc.html#/up/many-account?id=_7ã€ä½¿ç”¨æ³¨è§£åˆå¹¶ç®€åŒ–ä»£ç ) ç®€åŒ–ä»£ç ã€‚åœ¨ `auth.annotation` åŒ…ä¸‹æ–°å»º Sa-Token é…ç½®ç±»ï¼Œå¼€å¯æ³¨è§£é‰´æƒå’Œæ³¨è§£åˆå¹¶ï¼š

```java
@Configuration
public class SaTokenConfigure implements WebMvcConfigurer {

    // æ³¨å†Œ Sa-Token æ‹¦æˆªå™¨ï¼Œæ‰“å¼€æ³¨è§£å¼é‰´æƒåŠŸèƒ½
    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        // æ³¨å†Œ Sa-Token æ‹¦æˆªå™¨ï¼Œæ‰“å¼€æ³¨è§£å¼é‰´æƒåŠŸèƒ½
        registry.addInterceptor(new SaInterceptor()).addPathPatterns("/**");
    }

    @PostConstruct
    public void rewriteSaStrategy() {
        // é‡å†™Sa-Tokençš„æ³¨è§£å¤„ç†å™¨ï¼Œå¢åŠ æ³¨è§£åˆå¹¶åŠŸèƒ½ 
        SaAnnotationStrategy.instance.getAnnotation = (element, annotationClass) -> {
            return AnnotatedElementUtils.getMergedAnnotation(element, annotationClass);
        };
    }
}
```

ç„¶åå‚è€ƒ [å®˜æ–¹æä¾›çš„ç¤ºä¾‹ä»£ç ](https://gitee.com/dromara/sa-token/blob/master/sa-token-demo/sa-token-demo-case/src/main/java/com/pj/satoken/merge_annotation/SaUserCheckPermission.java#)ï¼Œåœ¨ `auth.annotation` åŒ…ä¸‹æ–°å»ºç©ºé—´è´¦å·ä½“ç³»çš„é‰´æƒæ³¨è§£ï¼š

```java
/**
 * ç©ºé—´æƒé™è®¤è¯ï¼šå¿…é¡»å…·æœ‰æŒ‡å®šæƒé™æ‰èƒ½è¿›å…¥è¯¥æ–¹æ³•
 * <p> å¯æ ‡æ³¨åœ¨å‡½æ•°ã€ç±»ä¸Šï¼ˆæ•ˆæœç­‰åŒäºæ ‡æ³¨åœ¨æ­¤ç±»çš„æ‰€æœ‰æ–¹æ³•ä¸Šï¼‰
 */
@SaCheckPermission(type = StpKit.SPACE_TYPE)
@Retention(RetentionPolicy.RUNTIME)
@Target({ElementType.METHOD, ElementType.TYPE})
public @interface SaSpaceCheckPermission {

    /**
     * éœ€è¦æ ¡éªŒçš„æƒé™ç 
     *
     * @return éœ€è¦æ ¡éªŒçš„æƒé™ç 
     */
    @AliasFor(annotation = SaCheckPermission.class)
    String[] value() default {};

    /**
     * éªŒè¯æ¨¡å¼ï¼šAND | ORï¼Œé»˜è®¤AND
     *
     * @return éªŒè¯æ¨¡å¼
     */
    @AliasFor(annotation = SaCheckPermission.class)
    SaMode mode() default SaMode.AND;

    /**
     * åœ¨æƒé™æ ¡éªŒä¸é€šè¿‡æ—¶çš„æ¬¡è¦é€‰æ‹©ï¼Œä¸¤è€…åªè¦å…¶ä¸€æ ¡éªŒæˆåŠŸå³å¯é€šè¿‡æ ¡éªŒ
     *
     * <p>
     * ä¾‹1ï¼š@SaCheckPermission(value="user-add", orRole="admin")ï¼Œ
     * ä»£è¡¨æœ¬æ¬¡è¯·æ±‚åªè¦å…·æœ‰ user-addæƒé™ æˆ– adminè§’è‰² å…¶ä¸€å³å¯é€šè¿‡æ ¡éªŒã€‚
     * </p>
     *
     * <p>
     * ä¾‹2ï¼š orRole = {"admin", "manager", "staff"}ï¼Œå…·æœ‰ä¸‰ä¸ªè§’è‰²å…¶ä¸€å³å¯ã€‚ <br>
     * ä¾‹3ï¼š orRole = {"admin, manager, staff"}ï¼Œå¿…é¡»ä¸‰ä¸ªè§’è‰²åŒæ—¶å…·å¤‡ã€‚
     * </p>
     *
     * @return /
     */
    @AliasFor(annotation = SaCheckPermission.class)
    String[] orRole() default {};

}
```

ä¹‹åå°±å¯ä»¥ç›´æ¥ä½¿ç”¨è¯¥æ³¨è§£äº†ã€‚

#### 6ã€åº”ç”¨æƒé™æ³¨è§£

è®¤çœŸæ ¸å¯¹ä¸€éå„ä¸ªæ“ä½œæ¥å£çš„ä»£ç ã€ä»¥åŠæ¥å£è°ƒç”¨çš„ Service ä»£ç ï¼ŒåŒ…æ‹¬å›¾ç‰‡æ“ä½œ PictureController å’ŒPictureServiceã€ç©ºé—´æˆå‘˜æ“ä½œ SpaceUserController å’Œ SpaceUserServiceã€‚

1ï¼‰ç»™ Controller æ¥å£è¡¥å……ä¸Šåˆé€‚çš„æƒé™æ³¨è§£ï¼ŒPictureController å›¾ç‰‡æ¥å£ï¼š

```java
// ä¸Šä¼ å›¾ç‰‡ï¼ˆå¯é‡æ–°ä¸Šä¼ ï¼‰
@PostMapping("/upload")
@SaSpaceCheckPermission(value = SpaceUserPermissionConstant.PICTURE_UPLOAD)
public BaseResponse<PictureVO> uploadPicture() {
}

// é€šè¿‡ URL ä¸Šä¼ å›¾ç‰‡ï¼ˆå¯é‡æ–°ä¸Šä¼ ï¼‰
@PostMapping("/upload/url")
@SaSpaceCheckPermission(value = SpaceUserPermissionConstant.PICTURE_UPLOAD)
public BaseResponse<PictureVO> uploadPictureByUrl() {
}

// åˆ é™¤å›¾ç‰‡
@PostMapping("/delete")
@SaSpaceCheckPermission(value = SpaceUserPermissionConstant.PICTURE_DELETE)
public BaseResponse<Boolean> deletePicture() {
}

// ç¼–è¾‘å›¾ç‰‡ï¼ˆç»™ç”¨æˆ·ä½¿ç”¨ï¼‰
@PostMapping("/edit")
@SaSpaceCheckPermission(value = SpaceUserPermissionConstant.PICTURE_EDIT)
public BaseResponse<Boolean> editPicture() {
}

// æ ¹æ®é¢œè‰²æœç´¢å›¾ç‰‡
@PostMapping("/search/color")
@SaSpaceCheckPermission(value = SpaceUserPermissionConstant.PICTURE_VIEW)
public BaseResponse<List<PictureVO>> searchPictureByColor() {
}

// æ‰¹é‡ç¼–è¾‘å›¾ç‰‡
@PostMapping("/edit/batch")
@SaSpaceCheckPermission(value = SpaceUserPermissionConstant.PICTURE_EDIT)
public BaseResponse<Boolean> editPictureByBatch() {
}

// åˆ›å»º AI æ‰©å›¾ä»»åŠ¡
@PostMapping("/out_painting/create_task")
@SaSpaceCheckPermission(value = SpaceUserPermissionConstant.PICTURE_EDIT)
public BaseResponse<CreateOutPaintingTaskResponse> createPictureOutPaintingTask() {
}
```

SpaceUserController æ¥å£ï¼š

```java
// æ·»åŠ æˆå‘˜åˆ°ç©ºé—´
@PostMapping("/add")
@SaSpaceCheckPermission(value = SpaceUserPermissionConstant.SPACE_USER_MANAGE)
public BaseResponse<Long> addSpaceUser() {
}

// ä»ç©ºé—´ç§»é™¤æˆå‘˜
@PostMapping("/delete")
@SaSpaceCheckPermission(value = SpaceUserPermissionConstant.SPACE_USER_MANAGE)
public BaseResponse<Boolean> deleteSpaceUser() {
}

// æŸ¥è¯¢æŸä¸ªæˆå‘˜åœ¨æŸä¸ªç©ºé—´çš„ä¿¡æ¯
@PostMapping("/get")
@SaSpaceCheckPermission(value = SpaceUserPermissionConstant.SPACE_USER_MANAGE)
public BaseResponse<SpaceUser> getSpaceUser() {
}

// æŸ¥è¯¢æˆå‘˜ä¿¡æ¯åˆ—è¡¨
@PostMapping("/list")
@SaSpaceCheckPermission(value = SpaceUserPermissionConstant.SPACE_USER_MANAGE)
public BaseResponse<List<SpaceUserVO>> listSpaceUser() {
}

// ç¼–è¾‘æˆå‘˜ä¿¡æ¯ï¼ˆè®¾ç½®æƒé™ï¼‰
@PostMapping("/edit")
@SaSpaceCheckPermission(value = SpaceUserPermissionConstant.SPACE_USER_MANAGE)
public BaseResponse<Boolean> editSpaceUser() {
}
```

2ï¼‰ç§»é™¤è¿™äº›æ¥å£å’Œç›¸å…³æœåŠ¡åŸæœ¬çš„æƒé™æ ¡éªŒé€»è¾‘ï¼Œæ¯”å¦‚ `PictureService#checkPictureAuth`ï¼Œç¡®ä¿è¯¥æ–¹æ³•å˜æˆäº†ç°è‰²ï¼ˆæœªè¢«ä½¿ç”¨ï¼‰ã€‚

è¿˜æœ‰ PictureServiceImpl çš„ uploadPicture æ–¹æ³•ä¸­çš„æƒé™æ ¡éªŒï¼Œä¹Ÿè¦æ³¨é‡Šæ‰ï¼š

```java
//            // æ ¡éªŒæ˜¯å¦æœ‰ç©ºé—´çš„æƒé™ï¼Œä»…ç©ºé—´ç®¡ç†å‘˜æ‰èƒ½ä¸Šä¼ 
//            if (!loginUser.getId().equals(space.getUserId())) {
//                throw new BusinessException(ErrorCode.NO_AUTH_ERROR, "æ²¡æœ‰ç©ºé—´æƒé™");
//            }

//            // ä»…æœ¬äººæˆ–ç®¡ç†å‘˜å¯ç¼–è¾‘å›¾ç‰‡
//            if (!oldPicture.getUserId().equals(loginUser.getId()) && !userService.isAdmin(loginUser)) {
//                throw new BusinessException(ErrorCode.NO_AUTH_ERROR);
//            }
```

3ï¼‰æ³¨æ„ï¼Œåªè¦åŠ ä¸Šäº† Sa-Token æ³¨è§£ï¼Œæ¡†æ¶å°±ä¼šå¼ºåˆ¶è¦æ±‚ç”¨æˆ·ç™»å½•ï¼Œæœªç™»å½•ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚æ‰€ä»¥é’ˆå¯¹æœªç™»å½•ä¹Ÿå¯ä»¥è°ƒç”¨çš„æ¥å£ï¼Œéœ€è¦æ”¹ä¸ºç¼–ç¨‹å¼æƒé™æ ¡éªŒï¼Œæ¯”å¦‚ getPictureVOById å’Œ listPictureVOByPage æ–¹æ³•ã€‚

```java
@GetMapping("/get/vo")
public BaseResponse<PictureVO> getPictureVOById(long id, HttpServletRequest request) {
    ThrowUtils.throwIf(id <= 0, ErrorCode.PARAMS_ERROR);
    // æŸ¥è¯¢æ•°æ®åº“
    Picture picture = pictureService.getById(id);
    ThrowUtils.throwIf(picture == null, ErrorCode.NOT_FOUND_ERROR);
    // ç©ºé—´çš„å›¾ç‰‡ï¼Œéœ€è¦æ ¡éªŒæƒé™
    Space space = null;
    Long spaceId = picture.getSpaceId();
    if (spaceId != null) {
        boolean hasPermission = StpKit.SPACE.hasPermission(SpaceUserPermissionConstant.PICTURE_VIEW);
        ThrowUtils.throwIf(!hasPermission, ErrorCode.NO_AUTH_ERROR);
    }
    PictureVO pictureVO = pictureService.getPictureVO(picture, request);
    // è·å–å°è£…ç±»
    return ResultUtils.success(pictureVO);
}

@PostMapping("/list/page/vo")
public BaseResponse<Page<PictureVO>> listPictureVOByPage(@RequestBody PictureQueryRequest pictureQueryRequest, HttpServletRequest request) {
    long current = pictureQueryRequest.getCurrent();
    long size = pictureQueryRequest.getPageSize();
    // é™åˆ¶çˆ¬è™«
    ThrowUtils.throwIf(size > 20, ErrorCode.PARAMS_ERROR);
    // ç©ºé—´æƒé™æ ¡éªŒ
    Long spaceId = pictureQueryRequest.getSpaceId();
    // å…¬å¼€å›¾åº“
    if (spaceId == null) {
        // æ™®é€šç”¨æˆ·é»˜è®¤åªèƒ½æŸ¥çœ‹å·²è¿‡å®¡çš„å…¬å¼€æ•°æ®
        pictureQueryRequest.setReviewStatus(PictureReviewStatusEnum.PASS.getValue());
        pictureQueryRequest.setNullSpaceId(true);
    } else {
        boolean hasPermission = StpKit.SPACE.hasPermission(SpaceUserPermissionConstant.PICTURE_VIEW);
        ThrowUtils.throwIf(!hasPermission, ErrorCode.NO_AUTH_ERROR);
    }
    // æŸ¥è¯¢æ•°æ®åº“
    Page<Picture> picturePage = pictureService.page(new Page<>(current, size), pictureService.getQueryWrapper(pictureQueryRequest));
    // è·å–å°è£…ç±»
    return ResultUtils.success(pictureService.getPictureVOPage(picturePage, request));
}
```

#### 7ã€å…¨å±€å¼‚å¸¸å¤„ç†

å¦‚æœ Sa-Token æ ¡éªŒç”¨æˆ·æ²¡æœ‰ç¬¦åˆè¦æ±‚çš„æƒé™ã€æˆ–è€…ç”¨æˆ·æœªç™»å½•ï¼Œå°±ä¼šæŠ›å‡ºå®ƒå®šä¹‰çš„å¼‚å¸¸ï¼Œ[å‚è€ƒæ–‡æ¡£](https://sa-token.cc/doc.html#/fun/exception-code?id=è·å–å¼‚å¸¸ç»†åˆ†çŠ¶æ€ç )ã€‚

éœ€è¦å°†æ¡†æ¶çš„å¼‚å¸¸å…¨å±€å¤„ç†ä¸ºæˆ‘ä»¬è‡ªå·±å®šä¹‰çš„ä¸šåŠ¡å¼‚å¸¸ï¼Œåœ¨å…¨å±€å¼‚å¸¸å¤„ç†å™¨ä¸­æ·»åŠ ä»£ç ï¼š

```java
@ExceptionHandler(NotLoginException.class)
public BaseResponse<?> notLoginException(NotLoginException e) {
    log.error("NotLoginException", e);
    return ResultUtils.error(ErrorCode.NOT_LOGIN_ERROR, e.getMessage());
}

@ExceptionHandler(NotPermissionException.class)
public BaseResponse<?> notPermissionExceptionHandler(NotPermissionException e) {
    log.error("NotPermissionException", e);
    return ResultUtils.error(ErrorCode.NO_AUTH_ERROR, e.getMessage());
}
```

#### 8ã€è¡¥å……è·å–æƒé™çš„æ¥å£

å‰é¢å†™çš„éƒ½æ˜¯åç«¯æƒé™æ ¡éªŒçš„ä»£ç ï¼Œä½†å¯¹äºç”¨æˆ·æ¥è¯´ï¼Œå¦‚æœæ²¡æœ‰ç©ºé—´å›¾ç‰‡çš„ç¼–è¾‘æƒé™ï¼Œè¿›å…¥ç©ºé—´è¯¦æƒ…é¡µæ—¶ä¸åº”è¯¥èƒ½çœ‹åˆ°ç¼–è¾‘æŒ‰é’®ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå‰ç«¯ä¹Ÿéœ€è¦æ ¹æ®ç”¨æˆ·çš„æƒé™æ¥è¿›è¡Œä¸€äº›é¡µé¢å†…å®¹çš„å±•ç¤ºå’Œéšè—ã€‚

å› æ­¤ï¼Œåç«¯éœ€è¦å°†ç”¨æˆ·å…·æœ‰çš„æƒé™è¿”å›ç»™å‰ç«¯ï¼Œå¸®åŠ©å‰ç«¯è¿›è¡Œåˆ¤æ–­ï¼Œè¿™æ ·å°±ä¸ç”¨è®©å‰ç«¯ç¼–å†™å¤æ‚çš„è§’è‰²å’Œæƒé™æ ¡éªŒé€»è¾‘äº†ã€‚

æ€è€ƒä¸‹å…·ä½“çš„ä½¿ç”¨åœºæ™¯ï¼šå¦‚æœæ˜¯å›¢é˜Ÿç©ºé—´ï¼ˆç©ºé—´è¯¦æƒ…é¡µï¼‰æˆ–å›¢é˜Ÿç©ºé—´çš„å›¾ç‰‡ï¼ˆå›¾ç‰‡è¯¦æƒ…é¡µï¼‰ï¼Œè¿”å›ç»™å‰ç«¯ç”¨æˆ·å…·æœ‰çš„æƒé™ï¼ˆæ¯”å¦‚èƒ½å¦ç¼–è¾‘ã€èƒ½å¦ä¸Šä¼ ã€èƒ½å¦åˆ é™¤ã€èƒ½å¦ç®¡ç†æˆå‘˜ï¼‰ã€‚

1ï¼‰æ¯”èµ·æ–°å†™ä¸€ä¸ªè·å–æƒé™çš„æ¥å£ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥åœ¨è¿”å›å›¾ç‰‡æˆ–ç©ºé—´è¯¦æƒ…æ—¶ï¼Œé¢å¤–ä¼ é€’æƒé™åˆ—è¡¨ã€‚ç»™ SpaceVO å’Œ PictureVO æ–°å¢æƒé™åˆ—è¡¨å­—æ®µï¼š

```java
/**
 * æƒé™åˆ—è¡¨
 */
private List<String> permissionList = new ArrayList<>();
```

2ï¼‰åœ¨ SpaceUserAuthManager ä¸­æ–°å¢è·å–æƒé™åˆ—è¡¨çš„æ–¹æ³•ï¼Œæ³¨æ„è¦åŒºåˆ†å…¬å…±å›¾åº“ã€ç§æœ‰ç©ºé—´å’Œå›¢é˜Ÿç©ºé—´ï¼Œå¯¹äºæœ‰æƒé™çš„æƒ…å†µï¼Œå¯ä»¥è¿”å› â€œç®¡ç†å‘˜æƒé™â€ åˆ—è¡¨ã€‚

```java
public List<String> getPermissionList(Space space, User loginUser) {
    if (loginUser == null) {
        return new ArrayList<>();
    }
    // ç®¡ç†å‘˜æƒé™
    List<String> ADMIN_PERMISSIONS = getPermissionsByRole(SpaceRoleEnum.ADMIN.getValue());
    // å…¬å…±å›¾åº“
    if (space == null) {
        if (userService.isAdmin(loginUser)) {
            return ADMIN_PERMISSIONS;
        }
        return new ArrayList<>();
    }
    SpaceTypeEnum spaceTypeEnum = SpaceTypeEnum.getEnumByValue(space.getSpaceType());
    if (spaceTypeEnum == null) {
        return new ArrayList<>();
    }
    // æ ¹æ®ç©ºé—´è·å–å¯¹åº”çš„æƒé™
    switch (spaceTypeEnum) {
        case PRIVATE:
            // ç§æœ‰ç©ºé—´ï¼Œä»…æœ¬äººæˆ–ç®¡ç†å‘˜æœ‰æ‰€æœ‰æƒé™
            if (space.getUserId().equals(loginUser.getId()) || userService.isAdmin(loginUser)) {
                return ADMIN_PERMISSIONS;
            } else {
                return new ArrayList<>();
            }
        case TEAM:
            // å›¢é˜Ÿç©ºé—´ï¼ŒæŸ¥è¯¢ SpaceUser å¹¶è·å–è§’è‰²å’Œæƒé™
            SpaceUser spaceUser = spaceUserService.lambdaQuery()
                    .eq(SpaceUser::getSpaceId, space.getId())
                    .eq(SpaceUser::getUserId, loginUser.getId())
                    .one();
            if (spaceUser == null) {
                return new ArrayList<>();
            } else {
                return getPermissionsByRole(spaceUser.getSpaceRole());
            }
    }
    return new ArrayList<>();
}
```

3ï¼‰ä¿®æ”¹è·å–ç©ºé—´è¯¦æƒ…å’Œå›¾ç‰‡è¯¦æƒ…çš„æ¥å£ getSpaceVOByIdã€getPictureVOByIdï¼Œå¢åŠ è·å–æƒé™åˆ—è¡¨çš„é€»è¾‘ã€‚

è·å–ç©ºé—´è¯¦æƒ…æ¥å£ï¼š

```java
@GetMapping("/get/vo")
public BaseResponse<SpaceVO> getSpaceVOById(long id, HttpServletRequest request) {
    ThrowUtils.throwIf(id <= 0, ErrorCode.PARAMS_ERROR);
    // æŸ¥è¯¢æ•°æ®åº“
    Space space = spaceService.getById(id);
    ThrowUtils.throwIf(space == null, ErrorCode.NOT_FOUND_ERROR);
    SpaceVO spaceVO = spaceService.getSpaceVO(space, request);
    User loginUser = userService.getLoginUser(request);
    List<String> permissionList = spaceUserAuthManager.getPermissionList(space, loginUser);
    spaceVO.setPermissionList(permissionList);
    // è·å–å°è£…ç±»
    return ResultUtils.success(spaceVO);
}
```

è·å–å›¾ç‰‡è¯¦æƒ…æ¥å£ï¼Œæ³¨æ„å³ä½¿ç©ºé—´ id ä¸å­˜åœ¨ï¼ˆå…¬å…±å›¾åº“ï¼‰ä¹Ÿè¦è·å–æƒé™åˆ—è¡¨ï¼Œç®¡ç†å‘˜ä¼šè·å–åˆ°å…¨éƒ¨æƒé™ï¼Œè¿™æ ·å‰ç«¯æ‰èƒ½é¡ºåˆ©å±•ç¤ºå‡ºæ“ä½œæŒ‰é’®ï¼š

```java
@GetMapping("/get/vo")
public BaseResponse<PictureVO> getPictureVOById(long id, HttpServletRequest request) {
    ThrowUtils.throwIf(id <= 0, ErrorCode.PARAMS_ERROR);
    // æŸ¥è¯¢æ•°æ®åº“
    Picture picture = pictureService.getById(id);
    ThrowUtils.throwIf(picture == null, ErrorCode.NOT_FOUND_ERROR);
    // ç©ºé—´çš„å›¾ç‰‡ï¼Œéœ€è¦æ ¡éªŒæƒé™
    Space space = null;
    Long spaceId = picture.getSpaceId();
    if (spaceId != null) {
        boolean hasPermission = StpKit.SPACE.hasPermission(SpaceUserPermissionConstant.PICTURE_VIEW);
        ThrowUtils.throwIf(!hasPermission, ErrorCode.NO_AUTH_ERROR);
        space = spaceService.getById(spaceId);
        ThrowUtils.throwIf(space == null, ErrorCode.NOT_FOUND_ERROR, "ç©ºé—´ä¸å­˜åœ¨");
    }
    // è·å–æƒé™åˆ—è¡¨
    User loginUser = userService.getLoginUser(request);
    List<String> permissionList = spaceUserAuthManager.getPermissionList(space, loginUser);
    PictureVO pictureVO = pictureService.getPictureVO(picture, request);
    pictureVO.setPermissionList(permissionList);
    // è·å–å°è£…ç±»
    return ResultUtils.success(pictureVO);
}
```

#### 9ã€æ¥å£æµ‹è¯•

ç»ˆäºå¼€å‘å®Œäº†ï¼Œæˆ‘ä»¬ä¼šå‘ç°ï¼Œç»†èŠ‚å®åœ¨æ˜¯å¤ªå¤šäº†ï¼Œæ‰€ä»¥ **ä¸€å®šè¦è¿›è¡Œä¸¥æ ¼çš„æµ‹è¯•ï¼ï¼ï¼**

ç”¨ä¸åŒæƒé™çš„ç”¨æˆ·å»éªŒè¯ä¸åŒçš„ç©ºé—´ç±»åˆ«ï¼ˆå…¬å…±å›¾åº“ã€ç§æœ‰ç©ºé—´ã€å›¢é˜Ÿç©ºé—´ï¼‰ã€‚/MBNmaRtUhzDE9b4tB/jsqs1ClvvhzK+S4KVLPihc/I=

å¦‚ä½•æµ‹è¯•å‘¢ï¼Ÿ

å¤§å®¶ç”¨çš„æ¯”è¾ƒå¤šçš„å°±æ˜¯å•å…ƒæµ‹è¯•ï¼Œä½†æ˜¯å•å…ƒæµ‹è¯•æƒ³è¦æµ‹è¯•æºå¸¦ç™»å½•æ€çš„ Controller æ¥å£æ˜¯æ¯”è¾ƒéº»çƒ¦çš„ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥é‡‡ç”¨è‡ªåŠ¨åŒ–æ¥å£æµ‹è¯•ï¼Œæ¯”å¦‚ Postman ç­‰ã€‚

æ­¤å¤„ä¸ºäº†æ–¹ä¾¿ï¼Œæˆ‘ä»¬ç›´æ¥ä½¿ç”¨ IDEA è‡ªå¸¦çš„ REST API æµ‹è¯•ï¼Œå¯ä»¥å°†æµ‹è¯•å‚æ•°å’Œæµ‹è¯•æ¥å£ä¿å­˜ä¸ºæ–‡ä»¶ï¼Œæ¯æ¬¡ä¿®æ”¹ä»£ç åï¼Œæ”¹æ”¹å‚æ•°ï¼Œæ‰§è¡Œæ–‡ä»¶å°±èƒ½æ•´ä½“æµ‹è¯•äº†ã€‚

![img](assets/293LCU0AUz3AANJc.webp)

ç”±äºè¦æµ‹è¯•çš„æƒ…å†µè¾ƒå¤šï¼Œé±¼çš®ç»™å¤§å®¶å‡†å¤‡å¥½äº†æµ‹è¯•ä»£ç ï¼Œç›´æ¥ä¸‹è½½ä½¿ç”¨å³å¯ï¼š[ğŸ“httpTest.zip](https://yuyuanweb.yuque.com/attachments/yuque/0/2024/zip/398476/1735475537929-926babdb-fe15-4718-a4bf-8cb1751ed754.zip)



è‡³æ­¤ï¼Œç©ºé—´æˆå‘˜æƒé™æ§åˆ¶å¼€å‘å®Œæˆï¼Œå¤§å®¶ä¼šå‘ç°è¿˜æ˜¯æŒºéº»çƒ¦çš„ã€‚å…¶å®å¦‚æœæ²¡æœ‰å…¬å…±å›¾åº“çš„æ¦‚å¿µçš„è¯ï¼Œå¼€å‘èµ·æ¥å°±è½»æ¾å¾ˆå¤šã€‚å› æ­¤ Sa-Token ç­‰æƒé™æ¡†æ¶è¦æŒ‰éœ€ä½¿ç”¨ï¼Œæ›´é€‚åˆå¤æ‚çš„ã€ä¼ä¸šå†…éƒ¨çš„æƒé™ç®¡ç†ç³»ç»Ÿã€‚

å¦‚æœä½ æƒ³å¼€å‘èµ·æ¥æ›´è½»æ¾ä¸€äº›ï¼Œæ¨èå…¶ä»–çš„å®ç°æ–¹å¼ï¼š

1. ç›´æ¥å°è£…æƒé™æ ¡éªŒæ–¹æ³•ï¼Œåœ¨ä¸šåŠ¡ä»£ç ä¸­è°ƒç”¨
2. å°†å›¢é˜Ÿç©ºé—´å›¾ç‰‡çš„å¢åˆ æ”¹æŸ¥æå–ä¸ºç‹¬ç«‹çš„æ¥å£ï¼Œå•ç‹¬è¿›è¡Œæƒé™æ ¡éªŒï¼Œä¸å½±å“å…¬å…±å›¾åº“

#### æ‰©å±•

1ï¼‰å¯ä»¥ç»™ç©ºé—´æ“ä½œï¼ˆSpaceControllerï¼‰ã€ç©ºé—´åˆ†ææ“ä½œï¼ˆSpaceAnalyzeControllerï¼‰å¢åŠ ç»Ÿä¸€çš„æƒé™æ ¡éªŒ

### ç©ºé—´æ•°æ®ç®¡ç†

æ ¹æ®éœ€æ±‚å’Œæ–¹æ¡ˆè®¾è®¡ï¼Œæˆ‘ä»¬è¦å°†æ——èˆ°ç‰ˆå›¢é˜Ÿç©ºé—´çš„å›¾ç‰‡æ•°æ®è¿›è¡Œå•ç‹¬ç®¡ç†ï¼Œæ¯ä¸ªå›¢é˜Ÿç©ºé—´çš„å›¾ç‰‡æ•°æ®å­˜å‚¨åˆ°ä¸€å¼ å•ç‹¬çš„è¡¨ä¸­ï¼Œä¹Ÿå°±æ˜¯ **åˆ†è¡¨**ã€‚

#### 1ã€ä»€ä¹ˆæ˜¯åˆ†åº“åˆ†è¡¨ï¼Ÿ

åˆ†åº“åˆ†è¡¨æ˜¯ä¸€ç§å°†æ•°æ®æ‹†åˆ†åˆ°å¤šä¸ªæ•°æ®åº“æˆ–æ•°æ®è¡¨ä¸­çš„è®¾è®¡ç­–ç•¥ï¼Œä¸»è¦ç”¨äºè§£å†³éšç€ä¸šåŠ¡æ•°æ®é‡å’Œè®¿é—®é‡å¢é•¿å¸¦æ¥çš„æ•°æ®åº“æ€§èƒ½é—®é¢˜ã€‚

é€šè¿‡åˆ†åº“åˆ†è¡¨ï¼Œå¯ä»¥å‡å°å•åº“æˆ–å•è¡¨çš„æ•°æ®é‡å’Œè®¿é—®å‹åŠ›ï¼Œä»è€Œæé«˜æŸ¥è¯¢å’Œå†™å…¥æ•ˆç‡ã€å¢å¼ºç³»ç»Ÿçš„é«˜å¹¶å‘èƒ½åŠ›ã€ä¼˜åŒ–å¤§æ•°æ®é‡ä¸‹çš„æ€§èƒ½è¡¨ç°ï¼›åŒæ—¶é™ä½å•ç‚¹æ•…éšœé£é™©ï¼Œå®ç°æ›´å¥½çš„ç³»ç»Ÿæ‰©å±•æ€§å’Œå®¹ç¾èƒ½åŠ›ã€‚

#### 2ã€åˆ†åº“åˆ†è¡¨å®ç°

å¦‚æœè®©æˆ‘ä»¬è‡ªå·±å®ç°åˆ†åº“åˆ†è¡¨ï¼Œåº”è¯¥æ€ä¹ˆåšå‘¢ï¼Ÿ

æ€è·¯ä¸»è¦æ˜¯åŸºäºä¸šåŠ¡éœ€æ±‚è®¾è®¡ **æ•°æ®åˆ†ç‰‡è§„åˆ™**ï¼Œå°†æ•°æ®æŒ‰ä¸€å®šç­–ç•¥ï¼ˆå¦‚å–æ¨¡ã€å“ˆå¸Œã€èŒƒå›´æˆ–æ—¶é—´ï¼‰åˆ†æ•£å­˜å‚¨åˆ°å¤šä¸ªåº“æˆ–è¡¨ä¸­ï¼ŒåŒæ—¶å¼€å‘è·¯ç”±é€»è¾‘æ¥å†³å®šæŸ¥è¯¢æˆ–å†™å…¥æ“ä½œçš„ç›®æ ‡åº“è¡¨ã€‚

![img](assets/OpWEMqE3d53COzF2.webp)

ç®€å•æ¥è¯´ï¼Œå°±æ˜¯å°†æ•°æ®å†™åˆ°ä¸åŒçš„è¡¨ã€å¹¶ä¸”ä»ç›¸åŒçš„è¡¨è¯»å–æ•°æ®ï¼Œå…¶å®é€šè¿‡ç»™ SQL è¡¨åæ‹¼æ¥åŠ¨æ€å‚æ•°å°±èƒ½å®ç°ï¼š

```sql
select * from table_${åˆ†ç‰‡å”¯ä¸€æ ‡è¯†}
```

ä½†è¿™åªæ˜¯æœ€ç®€å•çš„æƒ…å†µï¼Œå®é™…ä¸Šï¼Œåˆ†åº“åˆ†è¡¨è¿˜æ¶‰åŠè·¨åº“è¡¨æŸ¥è¯¢ã€äº‹åŠ¡ä¸€è‡´æ€§ã€åˆ†é¡µèšåˆç­‰å¤æ‚åœºæ™¯ï¼Œè¿˜å¯èƒ½éœ€è¦é…å¥—è®¾è®¡ç›‘æ§ã€æ‰©å®¹å’Œè¿ç§»æ–¹æ¡ˆä»¥ç¡®ä¿ç³»ç»Ÿçš„å¯ç»´æŠ¤æ€§å’Œæ‰©å±•æ€§ã€‚

æ‰€ä»¥ï¼Œä¸å»ºè®®è‡ªå·±å®ç°åˆ†åº“åˆ†è¡¨ã€‚æœ¬é¡¹ç›®ä¸­ï¼Œé±¼çš®å°†ä½¿ç”¨ä¸»æµçš„åˆ†åº“åˆ†è¡¨æ¡†æ¶ [Apache ShardingSphere](https://shardingsphere.apache.org/) å¸¦å¤§å®¶å®ç°ã€‚XJ858sBsdVoQsBlQbSlEZH9bgQFu4XZchClXOymxgUA=

#### 3ã€ShardingSphere åˆ†åº“åˆ†è¡¨

Apache ShardingSphere æä¾›äº†å¼€ç®±å³ç”¨çš„åˆ†ç‰‡ç­–ç•¥ã€çµæ´»çš„é…ç½®èƒ½åŠ›ä»¥åŠå¯¹è·¨åº“æŸ¥è¯¢ã€äº‹åŠ¡ä¸€è‡´æ€§ã€è¯»å†™åˆ†ç¦»ç­‰å¤æ‚åŠŸèƒ½çš„å…¨é¢æ”¯æŒã€‚

å®ƒåˆåˆ†ä¸º 2 å¤§æ ¸å¿ƒæ¨¡å— ShardingSphere-JDBC å’Œ ShardingSphere-Proxyï¼Œæˆ‘ç”¨ä¸€å¼ è¡¨æ ¼æ¥åˆ—ä¸¾ 2 è€…çš„åŒºåˆ«ï¼š

| ç»´åº¦     | ShardingSphere JDBC                | ShardingSphere Proxy                       |
| -------- | ---------------------------------- | ------------------------------------------ |
| è¿è¡Œæ–¹å¼ | åµŒå…¥å¼è¿è¡Œåœ¨åº”ç”¨å†…éƒ¨               | ç‹¬ç«‹ä»£ç†ï¼Œè¿è¡Œåœ¨åº”ç”¨ä¸æ•°æ®åº“ä¹‹é—´           |
| æ€§èƒ½     | ä½ç½‘ç»œå¼€é”€ï¼Œæ€§èƒ½è¾ƒé«˜               | å¼•å…¥ç½‘ç»œå¼€é”€ï¼Œæ€§èƒ½ç•¥ä½sql                  |
| æ”¯æŒè¯­è¨€ | ä»…æ”¯æŒ Java                        | æ”¯æŒå¤šè¯­è¨€ï¼ˆJavaã€Pythonã€Go ç­‰ï¼‰          |
| é…ç½®ç®¡ç† | åˆ†å¸ƒå¼é…ç½®è¾ƒå¤æ‚                   | æ”¯æŒé›†ä¸­é…ç½®å’ŒåŠ¨æ€ç®¡ç†                     |
| æ‰©å±•æ€§   | éšç€åº”ç”¨æ‰©å±•ï¼Œéœ€å•ç‹¬è°ƒæ•´é…ç½®       | ä»£ç†æœåŠ¡é›†ä¸­åŒ–ç®¡ç†ï¼Œæ‰©å±•æ€§å¼º               |
| é€‚ç”¨åœºæ™¯ | å•ä½“æˆ–å°å‹ç³»ç»Ÿï¼Œå¯¹æ€§èƒ½è¦æ±‚é«˜çš„åœºæ™¯ | å¤šè¯­è¨€ã€å¤§å‹åˆ†å¸ƒå¼ç³»ç»Ÿæˆ–éœ€è¦ç»Ÿä¸€ç®¡ç†çš„åœºæ™¯ |

å¯¹å¤§å¤šæ•° Java é¡¹ç›®æ¥è¯´ï¼Œé€‰æ‹© ShardingSphere-JDBC å°±è¶³å¤Ÿäº†ï¼›å¯¹äºè·¨è¯­è¨€çš„å¤§å‹åˆ†å¸ƒå¼é¡¹ç›®ã€æˆ–è€…å…¬å¸å†…æœ‰æŠ€æœ¯éƒ¨é—¨ç»Ÿä¸€ç®¡ç†åŸºç¡€è®¾æ–½çš„æƒ…å†µä¸‹ï¼Œå†è€ƒè™‘ä½¿ç”¨ ShardingSphere-Proxyã€‚

æœ¬é¡¹ç›®ä¹Ÿå°†ä½¿ç”¨ ShardingSphere-JDBCï¼Œåœ¨ä¾èµ–æ–‡ä»¶ä¸­å¼•å…¥ï¼š

```xml
<!-- åˆ†åº“åˆ†è¡¨ -->
<dependency>
    <groupId>org.apache.shardingsphere</groupId>
    <artifactId>shardingsphere-jdbc-core-spring-boot-starter</artifactId>
    <version>5.2.0</version>
</dependency>
```

#### 4ã€åˆ†åº“åˆ†è¡¨ç­–ç•¥ - é™æ€åˆ†è¡¨

åˆ†åº“åˆ†è¡¨çš„ç­–ç•¥æ€»ä½“åˆ†ä¸º 2 ç±»ï¼šé™æ€åˆ†è¡¨å’ŒåŠ¨æ€åˆ†è¡¨ï¼Œä¸‹é¢å…ˆè®²é™æ€åˆ†è¡¨ã€‚Kvj0N9UsvjnA2JCtBYVVlZvRih721R4WfPhhdfsvDfk=

åœ¨è®¾è®¡é˜¶æ®µï¼Œåˆ†è¡¨çš„æ•°é‡å’Œè§„åˆ™å°±æ˜¯å›ºå®šçš„ï¼Œä¸ä¼šæ ¹æ®ä¸šåŠ¡å¢é•¿åŠ¨æ€è°ƒæ•´ï¼Œæ¯”å¦‚ picture_0ã€picture_1ã€‚

åˆ†ç‰‡è§„åˆ™é€šå¸¸åŸºäºæŸä¸€å­—æ®µï¼ˆå¦‚å›¾ç‰‡ idï¼‰é€šè¿‡ç®€å•è§„åˆ™ï¼ˆå¦‚å–æ¨¡ã€èŒƒå›´ï¼‰æ¥å†³å®šæ•°æ®å­˜å‚¨åœ¨å“ªä¸ªè¡¨æˆ–åº“ä¸­ã€‚

è¿™ç§æ–¹å¼çš„ä¼˜ç‚¹æ˜¯ç®€å•ã€å¥½ç†è§£ï¼›ç¼ºç‚¹æ˜¯ä¸åˆ©äºæ‰©å±•ï¼Œéšç€æ•°æ®é‡å¢é•¿ï¼Œå¯èƒ½éœ€è¦æ‰‹åŠ¨è°ƒæ•´åˆ†è¡¨æ•°é‡å¹¶è¿ç§»æ•°æ®ã€‚

ä¸¾ä¸ªä¾‹å­ï¼Œå›¾ç‰‡è¡¨æŒ‰å›¾ç‰‡ id å¯¹ 4 å–æ¨¡æ‹†åˆ†ï¼š

```java
String tableName = "picture_" + (pictureId % 4); // picture_0 ~ picture_3
```

é™æ€åˆ†è¡¨çš„å®ç°å¾ˆç®€å•ï¼Œç›´æ¥åœ¨ `application.yml` ä¸­ç¼–å†™ ShardingSphere çš„é…ç½®å°±èƒ½å®Œæˆåˆ†åº“åˆ†è¡¨ï¼Œæ¯”å¦‚ï¼š

```yaml
rules:
  sharding:
    tables:
      picture:
        actualDataNodes: ds0.picture_${0..2} # 3å¼ åˆ†è¡¨ï¼špicture_0, picture_1, picture_2
        tableStrategy:
          standard:
            shardingColumn: pictureId       # æŒ‰ pictureId åˆ†ç‰‡
            shardingAlgorithmName: pictureIdMod
    shardingAlgorithms:
      pictureIdMod:
        type: INLINE
        props:
          algorithm-expression: picture_${pictureId % 3} # åˆ†ç‰‡è¡¨è¾¾å¼
```

ä½ ç”šè‡³ä¸éœ€è¦ä¿®æ”¹ä»»ä½•ä¸šåŠ¡ä»£ç ï¼Œåœ¨æŸ¥è¯¢ picture è¡¨ï¼ˆä¸€èˆ¬å«é€»è¾‘è¡¨ï¼‰æ—¶ï¼Œæ¡†æ¶ä¼šè‡ªåŠ¨å¸®ä½ ä¿®æ”¹ SQLï¼Œæ ¹æ® pictureId å°†æŸ¥è¯¢è¯·æ±‚è·¯ç”±åˆ°ä¸åŒçš„è¡¨ä¸­ã€‚å¦‚æœè¦è¿›è¡Œåˆ†é¡µå¤šæ¡æ•°æ®æŸ¥è¯¢ï¼Œä½ åªéœ€è¦å†™ä¸€æ¡æŸ¥è¯¢é€»è¾‘è¡¨çš„ SQL è¯­å¥å³å¯ï¼š

```plain
SELECT * FROM picture;
```

å®é™…ä¸Šï¼ŒShardingSphere å°†æŸ¥è¯¢é€»è¾‘è¡¨ `picture` çš„è¯·æ±‚è‡ªåŠ¨è·¯ç”±åˆ°æ‰€æœ‰å®é™…åˆ†è¡¨ picture_1ã€picture_2 ... picture_Nï¼Œè·å–åˆ°æ•°æ®åï¼Œåœ¨ä¸­é—´ä»¶å±‚è‡ªåŠ¨åˆå¹¶ç»“æœå¹¶è¿”å›ç»™åº”ç”¨ç¨‹åºã€‚

#### **5ã€åˆ†åº“åˆ†è¡¨ç­–ç•¥ - åŠ¨æ€åˆ†è¡¨**

åŠ¨æ€åˆ†è¡¨æ˜¯æŒ‡åˆ†è¡¨çš„æ•°é‡å¯ä»¥æ ¹æ®ä¸šåŠ¡éœ€æ±‚æˆ–æ•°æ®é‡åŠ¨æ€å¢åŠ ï¼Œè¡¨çš„ç»“æ„å’Œè§„åˆ™æ˜¯è¿è¡Œæ—¶åŠ¨æ€ç”Ÿæˆçš„ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œæ ¹æ®æ—¶é—´åŠ¨æ€åˆ›å»º picture_2025_01ã€picture_2025_02ã€‚

```java
String tableName = "picture_" + LocalDate.now().format(
    DateTimeFormatter.ofPattern("yyyy_MM")
);
```

æ˜¾ç„¶ï¼ŒåŠ¨æ€åˆ†è¡¨æ›´çµæ´»ã€æ‰©å±•æ€§å¼ºï¼Œé€‚åˆæ•°æ®é‡å¿«é€Ÿå¢é•¿çš„åœºæ™¯ï¼›ä½†ç¼ºç‚¹æ˜¯å®ç°æ›´å¤æ‚ï¼Œéœ€è¦åŠ¨æ€ç”Ÿæˆè¡¨å¹¶ç»´æŠ¤è¡¨çš„å…ƒä¿¡æ¯ã€‚å¦‚æœæ²¡æœ‰æ§åˆ¶å¥½ï¼Œè¯´ä¸å®šåˆ†è¡¨ç‰¹åˆ«å¤šï¼Œåè€Œå½±å“äº†æ•°æ®åº“çš„æ€§èƒ½ã€‚

åŠ¨æ€åˆ†è¡¨çš„å®ç°å°±æ¯”è¾ƒéº»çƒ¦äº†ï¼Œé¦–å…ˆè¦è‡ªå®šä¹‰åˆ†è¡¨ç®—æ³•ç±»ï¼Œè¿˜è¦åœ¨ä»£ç ä¸­ç¼–å†™åŠ¨æ€åˆ›å»ºè¡¨çš„é€»è¾‘ã€‚

è‡ªå®šä¹‰åˆ†è¡¨ç®—æ³•ç±»ï¼š

```java
public class PictureShardingAlgorithm implements StandardShardingAlgorithm<Long> {

    @Override
    public String doSharding(Collection<String> availableTargetNames, PreciseShardingValue<Long> preciseShardingValue) {
        // ç¼–å†™åˆ†è¡¨é€»è¾‘ï¼Œè¿”å›å®é™…è¦æŸ¥è¯¢çš„è¡¨å
        // picture_0 ç‰©ç†è¡¨ï¼Œpicture é€»è¾‘è¡¨
    }

    @Override
    public Collection<String> doSharding(Collection<String> collection, RangeShardingValue<Long> rangeShardingValue) {
        return new ArrayList<>();
    }

    @Override
    public Properties getProps() {
        return null;
    }

    @Override
    public void init(Properties properties) {

    }
}
```

å¯¹äºæˆ‘ä»¬çš„é¡¹ç›®ï¼Œç”±äºç©ºé—´æ˜¯ç”¨æˆ·åŠ¨æ€åˆ›å»ºçš„ï¼Œæ˜¾ç„¶è¦ä½¿ç”¨åŠ¨æ€åˆ†è¡¨ï¼Œä¸‹é¢æ¥å®ç°ã€‚

#### 6ã€åŠ¨æ€åˆ†è¡¨ç®—æ³•å¼€å‘

æ ¹æ®éœ€æ±‚ï¼Œæˆ‘ä»¬å¸Œæœ›å°†æ¯ä¸ªæ——èˆ°ç‰ˆç©ºé—´çš„å›¾ç‰‡å•ç‹¬å­˜æ”¾åœ¨ä¸€èµ·ï¼Œæ˜¾ç„¶æ˜¯æŒ‰ç…§ `spaceId` åˆ†è¡¨ï¼Œé‚£ä¹ˆåˆ†è¡¨çš„åç§°è§„åˆ™ä¸º `picture_${spaceId}`ã€‚

1ï¼‰é¦–å…ˆç¼–å†™åŠ¨æ€åˆ†è¡¨çš„é…ç½®ï¼ŒåŒ…æ‹¬æ•°æ®åº“è¿æ¥ã€åˆ†è¡¨è§„åˆ™ã€åˆ†è¡¨ç®—æ³•ï¼š

```yaml
spring:
  # ç©ºé—´å›¾ç‰‡åˆ†è¡¨
  shardingsphere:
    datasource:
      names: yu_picture
      yu_picture:
        type: com.zaxxer.hikari.HikariDataSource
        driver-class-name: com.mysql.cj.jdbc.Driver
        url: jdbc:mysql://localhost:3306/yu_picture
        username: root
        password: 123456
    rules:
      sharding:
        tables:
          picture:
            actual-data-nodes: yu_picture.picture  # åŠ¨æ€åˆ†è¡¨
            table-strategy:
              standard:
                sharding-column: spaceId
                sharding-algorithm-name: picture_sharding_algorithm  # ä½¿ç”¨è‡ªå®šä¹‰åˆ†ç‰‡ç®—æ³•
        sharding-algorithms:
          picture_sharding_algorithm:
            type: CLASS_BASED
            props:
              strategy: standard
              algorithmClassName: com.yupi.yupicturebackend.manager.sharding.PictureShardingAlgorithm
    props:
      sql-show: true
```

å…¶ä¸­ï¼Œæœ‰å‡ ä¸ªç»†èŠ‚éœ€è¦æ³¨æ„ï¼š

1. `actual-data-nodes` ä¸€èˆ¬æƒ…å†µä¸‹æ˜¯æŒ‡å®šä¸€æ®µåˆ†è¡¨çš„èŒƒå›´ï¼Œæ¯”å¦‚ `yu_picture.picture_${0..9999}` è¡¨ç¤ºæœ‰ picture_0 ~ picture_9999 è¿™ 10000 å¼ åˆ†è¡¨ã€‚ShardingSphere åœ¨æ‰§è¡Œåˆ†è¡¨æŸ¥è¯¢æ—¶ä¼šæ ¡éªŒè¦æŸ¥è¯¢çš„è¡¨ï¼ˆæ¯”å¦‚ picture_123456789ï¼‰æ˜¯å¦åœ¨ actual-data-nodes çš„é…ç½®èŒƒå›´å†…ã€‚ä½†æ˜¯ç”±äº spaceId æ˜¯é•¿æ•´å‹ï¼ŒèŒƒå›´å¤ªå¤§ï¼Œæ— æ³•é€šè¿‡æŒ‡å®šèŒƒå›´å°†æ‰€æœ‰åˆ†è¡¨åç§°åŒ…å«ï¼Œå¯¼è‡´æ— æ³•é€šè¿‡æ¡†æ¶å†…ç½®çš„æ ¡éªŒã€‚æ‰€ä»¥æ­¤å¤„å°† actual-data-nodes çš„å€¼è®¾ç½®ä¸ºé€»è¾‘è¡¨ `yu_picture.picture`ã€‚
2. æŒ‡å®šåˆ†è¡¨å­—æ®µä¸º spaceIdã€åˆ†è¡¨ç®—æ³•ä¸ºè‡ªå®šä¹‰çš„åˆ†ç‰‡ç®—æ³• `picture_sharding_algorithm`ã€‚
3. é…ç½®è‡ªå®šä¹‰åˆ†ç‰‡ç®—æ³•ï¼Œé‡‡ç”¨åŸºäºè‡ªå®šä¹‰ç±»çš„æ–¹å¼å®ç°ï¼Œç®—æ³•çš„ç±»åé…ç½®å¿…é¡»ä¸ºç±»çš„ç»å¯¹è·¯å¾„ã€‚

2ï¼‰ç¼–å†™å›¾ç‰‡åˆ†è¡¨ç®—æ³•ç±»ï¼Œå¿…é¡»å®ç° `StandardShardingAlgorithm` æ¥å£ã€‚æ ¸å¿ƒæ˜¯ç¼–å†™ doSharding æ–¹æ³•ï¼Œæ ¹æ® spaceId è·å–åˆ°å®é™…è¦æŸ¥è¯¢çš„åˆ†è¡¨åï¼Œå¦‚æœ spaceId ä¸å­˜åœ¨åˆ†è¡¨ï¼ˆæ¯”å¦‚æ˜¯ç§æœ‰ç©ºé—´ï¼‰æˆ–è€… spaceId ä¸ºç©ºï¼ˆå…¬å…±å›¾åº“ï¼‰ï¼Œé‚£ä¹ˆå°±ä»åŸè¡¨ï¼ˆé€»è¾‘è¡¨ï¼‰picture æŸ¥è¯¢ã€‚

ä¹‹æ‰€ä»¥è¦åšå…¼å®¹ï¼Œæ˜¯å› ä¸ºè™½ç„¶æˆ‘ä»¬è®¾è®¡ä¸Šåªå¯¹å›¢é˜Ÿç©ºé—´è¿›è¡Œåˆ†åº“åˆ†è¡¨ï¼Œä½†æ˜¯ä¸€æ—¦å¼•å…¥äº†åˆ†åº“åˆ†è¡¨æ¡†æ¶ï¼ŒæŸ¥è¯¢ picture è¡¨æ—¶å°±ä¼šè§¦å‘åˆ†è¡¨é€»è¾‘ã€‚

åœ¨ `manager.sharding` åŒ…ä¸‹æ–°å»ºåˆ†è¡¨ç®—æ³•ç±»ï¼š

```java
public class PictureShardingAlgorithm implements StandardShardingAlgorithm<Long> {

    @Override
    public String doSharding(Collection<String> availableTargetNames, PreciseShardingValue<Long> preciseShardingValue) {
        Long spaceId = preciseShardingValue.getValue();
        String logicTableName = preciseShardingValue.getLogicTableName();
        // spaceId ä¸º null è¡¨ç¤ºæŸ¥è¯¢æ‰€æœ‰å›¾ç‰‡
        if (spaceId == null) {
            return logicTableName;
        }
        // æ ¹æ® spaceId åŠ¨æ€ç”Ÿæˆåˆ†è¡¨å
        String realTableName = "picture_" + spaceId;
        if (availableTargetNames.contains(realTableName)) {
            return realTableName;
        } else {
            return logicTableName;
        }
    }

    @Override
    public Collection<String> doSharding(Collection<String> collection, RangeShardingValue<Long> rangeShardingValue) {
        return new ArrayList<>();
    }

    @Override
    public Properties getProps() {
        return null;
    }

    @Override
    public void init(Properties properties) {

    }
}
```

3ï¼‰å…‰æœ‰ä¸Šè¿°ä»£ç è¿˜ä¸èƒ½å®ŒæˆåŠ¨æ€åˆ†è¡¨ï¼Œå› ä¸º availableTargetNamesï¼ˆå¯ç”¨çš„åˆ†è¡¨ï¼‰å§‹ç»ˆä¸ºé€»è¾‘è¡¨å `picture`ï¼åŸå› åœ¨äº ShardingSphere åœ¨åˆ†ç‰‡é€»è¾‘åˆå§‹åŒ–æ—¶é»˜è®¤è·å–çš„æ˜¯é…ç½®çš„ `actual-data-nodes` ä¸­çš„ç›®æ ‡è¡¨åï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å†™çš„å›ºå®šå€¼ã€‚è¿™æ ·è¿˜æ˜¯æ— æ³•é€šè¿‡ ShardingSphere çš„æŸ¥è¯¢æ ¡éªŒï¼Œæˆ‘ä»¬ä¹Ÿæ²¡åŠæ³•åˆ¤æ–­ spaceId æ˜¯å¦è¦åˆ†è¡¨ï¼š

```java
// availableTargetNames å§‹ç»ˆä¸º pictureï¼Œæ— æ³•è¿”å›çœŸå®çš„åˆ†è¡¨
if (availableTargetNames.contains(realTableName)) {
    return realTableName;
} else {
    return logicTableName;
}
```

æ—¢ç„¶æ¡†æ¶è‡ªèº«ä¸æ”¯æŒåŠ¨æ€ç»´æŠ¤åˆ†è¡¨ï¼Œé‚£æˆ‘ä»¬å¯ä»¥å†™ä¸€ä¸ªåˆ†è¡¨ç®¡ç†å™¨ï¼Œè‡ªå·±æ¥ç»´æŠ¤åˆ†è¡¨åˆ—è¡¨ï¼Œå¹¶æ›´æ–°åˆ° ShardingSphere çš„ `actual-data-nodes` é…ç½®ä¸­ã€‚

åœ¨ `manager.sharding` åŒ…ä¸‹æ–°å»ºåˆ†è¡¨ç®¡ç†å™¨ç±»ï¼š

```java
@Component
@Slf4j
public class DynamicShardingManager {

    @Resource
    private DataSource dataSource;

    @Resource
    private SpaceService spaceService;

    private static final String LOGIC_TABLE_NAME = "picture";

    private static final String DATABASE_NAME = "logic_db"; // é…ç½®æ–‡ä»¶ä¸­çš„æ•°æ®åº“åç§°

    @PostConstruct
    public void initialize() {
        log.info("åˆå§‹åŒ–åŠ¨æ€åˆ†è¡¨é…ç½®...");
        updateShardingTableNodes();
    }

    /**
     * è·å–æ‰€æœ‰åŠ¨æ€è¡¨åï¼ŒåŒ…æ‹¬åˆå§‹è¡¨ picture å’Œåˆ†è¡¨ picture_{spaceId}
     */
    private Set<String> fetchAllPictureTableNames() {
        // ä¸ºäº†æµ‹è¯•æ–¹ä¾¿ï¼Œç›´æ¥å¯¹æ‰€æœ‰å›¢é˜Ÿç©ºé—´åˆ†è¡¨ï¼ˆå®é™…ä¸Šçº¿æ”¹ä¸ºä»…å¯¹æ——èˆ°ç‰ˆç”Ÿæ•ˆï¼‰
        Set<Long> spaceIds = spaceService.lambdaQuery()
                .eq(Space::getSpaceType, SpaceTypeEnum.TEAM.getValue())
                .list()
                .stream()
                .map(Space::getId)
                .collect(Collectors.toSet());
        Set<String> tableNames = spaceIds.stream()
                .map(spaceId -> LOGIC_TABLE_NAME + "_" + spaceId)
                .collect(Collectors.toSet());
        tableNames.add(LOGIC_TABLE_NAME); // æ·»åŠ åˆå§‹é€»è¾‘è¡¨
        return tableNames;
    }

    /**
     * æ›´æ–° ShardingSphere çš„ actual-data-nodes åŠ¨æ€è¡¨åé…ç½®
     */
    private void updateShardingTableNodes() {
        Set<String> tableNames = fetchAllPictureTableNames();
        String newActualDataNodes = tableNames.stream()
                .map(tableName -> "yu_picture." + tableName) // ç¡®ä¿å‰ç¼€åˆæ³•
                .collect(Collectors.joining(","));
        log.info("åŠ¨æ€åˆ†è¡¨ actual-data-nodes é…ç½®: {}", newActualDataNodes);

        ContextManager contextManager = getContextManager();
        ShardingSphereRuleMetaData ruleMetaData = contextManager.getMetaDataContexts()
                .getMetaData()
                .getDatabases()
                .get(DATABASE_NAME)
                .getRuleMetaData();

        Optional<ShardingRule> shardingRule = ruleMetaData.findSingleRule(ShardingRule.class);
        if (shardingRule.isPresent()) {
            ShardingRuleConfiguration ruleConfig = (ShardingRuleConfiguration) shardingRule.get().getConfiguration();
            List<ShardingTableRuleConfiguration> updatedRules = ruleConfig.getTables()
                    .stream()
                    .map(oldTableRule -> {
                        if (LOGIC_TABLE_NAME.equals(oldTableRule.getLogicTable())) {
                            ShardingTableRuleConfiguration newTableRuleConfig = new ShardingTableRuleConfiguration(LOGIC_TABLE_NAME, newActualDataNodes);
                            newTableRuleConfig.setDatabaseShardingStrategy(oldTableRule.getDatabaseShardingStrategy());
                            newTableRuleConfig.setTableShardingStrategy(oldTableRule.getTableShardingStrategy());
                            newTableRuleConfig.setKeyGenerateStrategy(oldTableRule.getKeyGenerateStrategy());
                            newTableRuleConfig.setAuditStrategy(oldTableRule.getAuditStrategy());
                            return newTableRuleConfig;
                        }
                        return oldTableRule;
                    })
                    .collect(Collectors.toList());
            ruleConfig.setTables(updatedRules);
            contextManager.alterRuleConfiguration(DATABASE_NAME, Collections.singleton(ruleConfig));
            contextManager.reloadDatabase(DATABASE_NAME);
            log.info("åŠ¨æ€åˆ†è¡¨è§„åˆ™æ›´æ–°æˆåŠŸï¼");
        } else {
            log.error("æœªæ‰¾åˆ° ShardingSphere çš„åˆ†ç‰‡è§„åˆ™é…ç½®ï¼ŒåŠ¨æ€åˆ†è¡¨æ›´æ–°å¤±è´¥ã€‚");
        }
    }

    /**
     * è·å– ShardingSphere ContextManager
     */
    private ContextManager getContextManager() {
        try (ShardingSphereConnection connection = dataSource.getConnection().unwrap(ShardingSphereConnection.class)) {
            return connection.getContextManager();
        } catch (SQLException e) {
            throw new RuntimeException("è·å– ShardingSphere ContextManager å¤±è´¥", e);
        }
    }
}
```

ä¸Šè¿°ä»£ç è™½ç„¶çœ‹èµ·æ¥æ¯”è¾ƒå¤æ‚ï¼Œä½†å…¶å®ä¸éš¾ç†è§£ï¼Œä¸»è¦åšäº†è¿™ä¹ˆå‡ ä»¶äº‹ï¼š

1. å°†ç®¡ç†å™¨æ³¨å†Œä¸º Beanï¼Œé€šè¿‡ `@PostConstruct` æ³¨è§£ï¼Œåœ¨ Bean åŠ è½½åè·å–æ‰€æœ‰çš„åˆ†è¡¨å¹¶æ›´æ–°é…ç½®ã€‚
2. ç¼–å†™è·å–åˆ†è¡¨åˆ—è¡¨çš„æ–¹æ³•ï¼Œä»æ•°æ®åº“ä¸­æŸ¥è¯¢ç¬¦åˆè¦æ±‚çš„ç©ºé—´åˆ—è¡¨ï¼Œå†è¡¥å……ä¸Šé€»è¾‘è¡¨ï¼Œå°±å¾—åˆ°äº†å®Œæ•´çš„åˆ†è¡¨åˆ—è¡¨ã€‚
3. æ›´æ–° ShardingSphere çš„ actual-data-nodes åŠ¨æ€è¡¨åé…ç½®ã€‚è·å–åˆ° ShardingSphere çš„ ContextManagerï¼Œæ‰¾åˆ°é…ç½®æ–‡ä»¶ä¸­çš„é‚£æ¡è§„åˆ™è¿›è¡Œæ›´æ–°å³å¯ã€‚

4ï¼‰åŠ¨æ€åˆ›å»ºåˆ†è¡¨sql

åœ¨åˆ†è¡¨ç®¡ç†å™¨ä¸­æ–°å¢åŠ¨æ€åˆ›å»ºåˆ†è¡¨çš„æ–¹æ³•ï¼Œé€šè¿‡æ‹¼æ¥ SQL çš„æ–¹å¼åˆ›å»ºå‡ºå’Œ picture è¡¨ç»“æ„ä¸€æ ·çš„åˆ†è¡¨ï¼Œåˆ›å»ºæ–°çš„åˆ†è¡¨åè®°å¾—æ›´æ–°åˆ†è¡¨èŠ‚ç‚¹ã€‚ä»£ç å¦‚ä¸‹ï¼š

```java
public void createSpacePictureTable(Space space) {
    // åŠ¨æ€åˆ›å»ºåˆ†è¡¨
    // ä»…ä¸ºæ——èˆ°ç‰ˆå›¢é˜Ÿç©ºé—´åˆ›å»ºåˆ†è¡¨
    if (space.getSpaceType() == SpaceTypeEnum.TEAM.getValue() && space.getSpaceLevel() == SpaceLevelEnum.FLAGSHIP.getValue()) {
        Long spaceId = space.getId();
        String tableName = "picture_" + spaceId;
        // åˆ›å»ºæ–°è¡¨
        String createTableSql = "CREATE TABLE " + tableName + " LIKE picture";
        try {
            SqlRunner.db().update(createTableSql);
            // æ›´æ–°åˆ†è¡¨
            updateShardingTableNodes();
        } catch (Exception e) {
            log.error("åˆ›å»ºå›¾ç‰‡ç©ºé—´åˆ†è¡¨å¤±è´¥ï¼Œç©ºé—´ id = {}", space.getId());
        }
    }
}
```

æ³¨æ„ï¼Œæƒ³è¦ä½¿ç”¨ MyBatis Plus çš„ SqlRunnerï¼Œå¿…é¡»è¦å¼€å¯é…ç½®ï¼š

```yaml
mybatis-plus:
  global-config:
    enable-sql-runner: true
```

ç„¶ååœ¨åˆ›å»ºç©ºé—´æ—¶ï¼Œè°ƒç”¨è¯¥æ–¹æ³•ï¼š

```java
// å¦‚æœæ˜¯å›¢é˜Ÿç©ºé—´ï¼Œå…³è”æ–°å¢å›¢é˜Ÿæˆå‘˜è®°å½•
if (SpaceTypeEnum.TEAM.getValue() == spaceAddRequest.getSpaceType()) {
    SpaceUser spaceUser = new SpaceUser();
    spaceUser.setSpaceId(space.getId());
    spaceUser.setUserId(userId);
    spaceUser.setSpaceRole(SpaceRoleEnum.ADMIN.getValue());
    result = spaceUserService.save(spaceUser);
    ThrowUtils.throwIf(!result, ErrorCode.OPERATION_ERROR, "åˆ›å»ºå›¢é˜Ÿæˆå‘˜è®°å½•å¤±è´¥");
}
// åˆ›å»ºåˆ†è¡¨
dynamicShardingManager.createSpacePictureTable(space);
// è¿”å›æ–°å†™å…¥çš„æ•°æ® id
return space.getId();
```

è‡³æ­¤ï¼ŒåŠ¨æ€åˆ†è¡¨å°±å¼€å‘å®Œæˆäº†ã€‚

ğŸ’¡ å…¶å® ShardingSphere è¿˜æä¾›äº† **hint å¼ºåˆ¶åˆ†è¡¨è·¯ç”±æœºåˆ¶** æ¥å®ç°åŠ¨æ€åˆ†è¡¨ï¼Œå…è®¸åœ¨ä»£ç ä¸­å¼ºåˆ¶æŒ‡å®šå…·ä½“çš„ç‰©ç†è¡¨ï¼Œä»è€Œè§£å†³åŠ¨æ€åˆ†è¡¨é—®é¢˜ã€‚ä½†ç¼ºç‚¹æ˜¯éœ€è¦åœ¨æ¯æ¬¡æŸ¥è¯¢æˆ–è€…æ“ä½œæ•°æ®æ—¶éƒ½æ˜¾å¼è®¾ç½®è¡¨åï¼Œä¼šç»™ä»£ç å¢åŠ å¾ˆå¤šé¢å¤–é€»è¾‘ï¼Œä¸å¤Ÿä¼˜é›…ã€‚æ‰€ä»¥ä¸é‡‡ç”¨ï¼Œå¤§å®¶äº†è§£ä¸€ä¸‹å³å¯ã€‚

#### 7ã€æµ‹è¯•

åˆ†è¡¨æ˜¯ä¸ªå¯¹ç³»ç»Ÿå½±å“å¾ˆå¤§çš„æ“ä½œï¼Œæ‰€ä»¥è¦è¿›è¡Œä¸¥æ ¼çš„æµ‹è¯•ã€‚

å¦‚æœå¯åŠ¨é¡¹ç›®æ—¶å‡ºç°äº†å¾ªç¯ä¾èµ–ï¼š

![img](assets/FOGRkTfX1XXLWkKY.webp)

å¯ä»¥æ·»åŠ  Lazy æ³¨è§£è§£å†³ï¼š

```java
@Resource
@Lazy
private DynamicShardingManager dynamicShardingManager;
```

1ï¼‰å•ç‹¬æŸ¥è¯¢æŸä¸ªå›¾ç‰‡ï¼Œä¸æŒ‡å®š spaceId æŸ¥è¯¢æ¡ä»¶æ—¶ï¼Œä¼šè‡ªåŠ¨æŸ¥æ‰€æœ‰çš„ picture è¡¨ï¼š

![img](assets/2JdraBgP5mDPFaud.webp)

å†å²æ•°æ®ä¼šè‡ªåŠ¨å…¼å®¹ï¼Œåªè¦æŸ¥åˆ°çš„ spaceId æ²¡æœ‰åˆ†è¡¨ï¼Œéƒ½ä¼šæŸ¥åŸæ¥çš„ picture è¡¨ã€‚åªæœ‰æŒ‡å®š spaceId ä¸”å­˜åœ¨åˆ†è¡¨æ—¶ï¼Œæ‰ä¼šæŸ¥è¯¢ç‰¹å®šçš„å•å¼ åˆ†è¡¨ã€‚

2ï¼‰æŸ¥è¯¢å›¾ç‰‡åˆ—è¡¨ï¼Œä¸æŒ‡å®š spaceId æˆ– nullSpaceIdï¼ˆæŸ¥è¯¢ spaceId ä¸º null çš„å€¼ï¼‰æ—¶ï¼Œä¼šè‡ªåŠ¨æŸ¥æ‰€æœ‰çš„ picture è¡¨ã€‚æ‰€ä»¥æŸ¥è¯¢æ—¶é—´ä¼šéšç€åˆ†è¡¨æ•°å¢åŠ ï¼š

![img](assets/2mitSReFfdIvD6DI.webp)

3ï¼‰æµ‹è¯•æ•°æ®æ’å…¥ã€‚æ’å…¥æ—¶å¦‚æœæƒ³å¾€å…¬å…±ç©ºé—´æ’å…¥ï¼ˆä¸æŒ‡å®š spaceIdï¼‰ï¼Œå°±ä¼šæŠ¥é”™ï¼Œå› ä¸º ShardingSphere ä¸çŸ¥é“è¦æŠŠæ•°æ®æ’å…¥åˆ°å“ªä¸ªè¡¨ä¸­ã€‚

![img](assets/x7NATNEJyEHaGzgp.webp)

**è¿™å°±æ„å‘³ç€ï¼Œå¦‚æœä½ è¦ä½¿ç”¨åˆ†è¡¨ï¼ŒspaceId å¿…é¡»ä¸èƒ½ä¸º nullï¼**

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæ’å…¥æ—¶ä¸€å®šè¦æŒ‡å®š spaceIdï¼Œå¯ä»¥çº¦å®šå…¬å…±ç©ºé—´çš„ spaceId éƒ½ä¸º 0ï¼Œå¹¶ä¸”åœ¨æ’å…¥æ—¶ä¸º spaceId è®¾ç½®é»˜è®¤å€¼ 0ã€‚

```java
// è¡¥å……ç©ºé—´ idï¼Œé»˜è®¤ä¸º 0
if (spaceId == null) {
    picture.setSpaceId(0L);
}
```

**æ³¨æ„ï¼Œå¢åˆ æ”¹æŸ¥æ—¶éƒ½è¦è¡¥å…… spaceIdï¼Œæ‰èƒ½é¿å…æŠ¥é”™å’Œå¤šè¡¨æŸ¥è¯¢å½±å“æ•ˆç‡ã€‚**

æ¯”å¦‚æŸ¥è¯¢å•ä¸ªå›¾ç‰‡ï¼Œæ”¹ä¸ºé€šè¿‡ QueryWrapper æŒ‡å®š spaceId æŸ¥è¯¢ï¼š

```java
// æ„é€  QueryWrapper
QueryWrapper<Picture> queryWrapper = new QueryWrapper<>();
queryWrapper.eq("id", id)         // æ ¹æ®ä¸»é”® id æŸ¥è¯¢
            .eq("spaceId", spaceId); // é™„åŠ  spaceId æ¡ä»¶

// æ‰§è¡ŒæŸ¥è¯¢
Picture picture = pictureService.getOne(queryWrapper);
```

æ„é€ å›¾ç‰‡åˆ†é¡µæŸ¥è¯¢æ¡ä»¶æ—¶ï¼Œå¦‚æœæŸ¥è¯¢å…¬å…±å›¾åº“ï¼ŒspaceId æ”¹ä¸º 0ï¼š

```java
queryWrapper.eq(nullSpaceId, "spaceId", 0);
// queryWrapper.isNull(nullSpaceId, "spaceId");
```

æ›´æ–° / æ‰¹é‡æ›´æ–°å›¾ç‰‡æ—¶ï¼Œè®¾ç½® spaceId ä½œä¸ºæŸ¥è¯¢æ¡ä»¶ï¼š

```java
// æ„é€  UpdateWrapper
UpdateWrapper<Picture> updateWrapper = new UpdateWrapper<>();
updateWrapper.eq("id", picture.getId()) // æŒ‡å®šä¸»é”®æ¡ä»¶ï¼Œæ‰¹é‡æ›´æ–°åˆ™ä½¿ç”¨ in ä¼ é€’å¤šæ¡
             .eq("spaceId", xxx);      // è¡¥å……æ¡ä»¶ spaceId=xxx

// æ‰§è¡Œæ›´æ–°
boolean result = pictureService.update(picture, updateWrapper);
```

åˆ é™¤å›¾ç‰‡æ—¶ï¼Œè®¾ç½® spaceId ä½œä¸ºæŸ¥è¯¢æ¡ä»¶ï¼š

```java
// æ„é€  QueryWrapper
QueryWrapper<Picture> queryWrapper = new QueryWrapper<>();
queryWrapper.eq("id", id)         // æŒ‡å®šä¸»é”® ID
            .eq("spaceId", spaceId); // é™„åŠ  spaceId æ¡ä»¶

// æ‰§è¡Œåˆ é™¤
boolean result = pictureService.remove(queryWrapper);
```

**æ³¨æ„ï¼Œåˆ†è¡¨åï¼Œpicture çš„ spaceId å°†ä¸èƒ½ä¿®æ”¹ï¼ï¼ï¼**

ç»è¿‡å¼€å‘å’Œæµ‹è¯•ï¼Œä½ ä¼šå‘ç°åŠ¨æ€åˆ†åº“åˆ†è¡¨çš„å®ç°éå¸¸éº»çƒ¦ã€‚æŸäº›å•è¡¨çš„æŸ¥è¯¢æ€§èƒ½æ˜¯é«˜äº†ï¼Œä½†æ•´ä½“æŸ¥è¯¢çš„æ€§èƒ½å¯èƒ½ä¼šå‡å°‘ï¼Œæ‰€ä»¥åŸåˆ™ä¸Š **éå¿…è¦ä¸åˆ†è¡¨**ï¼Œä¸€å®šè¦æ‰¾åˆ°åˆé€‚çš„åº”ç”¨åœºæ™¯ã€‚

è€ƒè™‘åˆ°è®©æ›´å¤šåŒå­¦åç»­ç›´æ¥éƒ¨ç½²é¡¹ç›®ï¼Œé™ä½ç†è§£æˆæœ¬ï¼Œæ•™ç¨‹ä¸­å°±ä¸å¸¦å¤§å®¶å®é™…æ‰§è¡Œä¸Šè¿°æ”¹é€ ç»†èŠ‚äº†ï¼Œå¹¶ä¸”æˆ‘å†æ•™å¤§å®¶ä¸€ç§å¯ä»¥å…³é—­åˆ†åº“åˆ†è¡¨çš„æ–¹æ³•ã€‚

#### 8ã€å…³é—­åˆ†åº“åˆ†è¡¨ï¼ˆå¯é€‰ï¼‰

1ï¼‰å¯åŠ¨ç±»æ’é™¤ä¾èµ–ï¼ˆé…ç½®æ–‡ä»¶å¯ä»¥ä¸æ³¨é‡Šï¼‰ï¼š

```java
@SpringBootApplication(exclude = {ShardingSphereAutoConfiguration.class})
```

2ï¼‰æ³¨é‡Šæ‰åˆ†åº“åˆ†è¡¨ç®¡ç†å™¨ç»„ä»¶ DynamicShardingManagerï¼š

![img](assets/oCWKaQJGfAIXWQv3.webp)

3ï¼‰æ³¨é‡Šæ‰ä½¿ç”¨ DynamicShardingManager æ–¹æ³•çš„ä»£ç ï¼Œæ¯”å¦‚ç©ºé—´æœåŠ¡ä¸­å¯¹å…¶çš„å¼•ç”¨ã€åˆ›å»ºåˆ†è¡¨çš„ä»£ç ï¼š

```java
// @Resource
// @Lazy
// private DynamicShardingManager dynamicShardingManager;

// åˆ›å»ºåˆ†è¡¨
// dynamicShardingManager.createSpacePictureTable(space);
```

#### å‚è€ƒæ–‡ç« 

- å…³äºåŠ¨æ€æ›´æ–° actual-data-nodesï¼šhttps://www.yuque.com/linghengqian/meve2v/cgi5en
- ç›¸å…³ issueï¼šhttps://github.com/apache/shardingsphere/issues/21503
- å¼€æºç¤¾åŒºçš„è®¨è®ºï¼šhttps://github.com/apache/shardingsphere/discussions/12258#discussioncomment-3917927

## å››ã€å‰ç«¯å¼€å‘

å›¢é˜Ÿç©ºé—´çš„å‰ç«¯å¼€å‘å·¥ä½œé‡ä¸å¤§ï¼Œå› ä¸ºç»å¤§å¤šæ•°é¡µé¢éƒ½å¯ä»¥å¤ç”¨ç§æœ‰ç©ºé—´ã€‚

### åŸºç¡€ä»£ç 

é¦–å…ˆæ ¹æ®åç«¯çš„æšä¸¾ç±»å’Œå¸¸é‡ï¼Œå®šä¹‰ç©ºé—´ç±»å‹ç›¸å…³å¸¸é‡ã€ç©ºé—´è§’è‰²ç›¸å…³å¸¸é‡ã€ç©ºé—´æƒé™å¸¸é‡ï¼š

```typescript
// ç©ºé—´ç±»å‹æšä¸¾
export const SPACE_TYPE_ENUM = {
  PRIVATE: 0,
  TEAM: 1,
}

// ç©ºé—´ç±»å‹æ–‡æœ¬æ˜ å°„
export const SPACE_TYPE_MAP: Record<number, string> = {
  0: 'ç§æœ‰ç©ºé—´',
  1: 'å›¢é˜Ÿç©ºé—´',
}

// ç©ºé—´ç±»å‹é€‰é¡¹æ˜ å°„
export const SPACE_TYPE_OPTIONS = Object.keys(SPACE_TYPE_MAP).map((key) => {
  const value = Number(key) // å°†å­—ç¬¦ä¸² key è½¬æ¢ä¸ºæ•°å­—
  return {
    label: SPACE_TYPE_MAP[value],
    value,
  }
})

// ç©ºé—´è§’è‰²æšä¸¾
export const SPACE_ROLE_ENUM = {
  VIEWER: "viewer",
  EDITOR: "editor",
  ADMIN: "admin",
} as const;

// ç©ºé—´è§’è‰²æ–‡æœ¬æ˜ å°„
export const SPACE_ROLE_MAP: Record<string, string> = {
  viewer: "æµè§ˆè€…",
  editor: "ç¼–è¾‘è€…",
  admin: "ç®¡ç†å‘˜",
};

// ç©ºé—´è§’è‰²é€‰é¡¹æ˜ å°„
export const SPACE_ROLE_OPTIONS = Object.keys(SPACE_ROLE_MAP).map((key) => {
  return {
    label: SPACE_ROLE_MAP[key],
    value: key,
  };
});

/**
 * ç©ºé—´æƒé™å¸¸é‡
 */
export const SPACE_PERMISSION_ENUM = {
  SPACE_USER_MANAGE: "spaceUser:manage",
  PICTURE_VIEW: "picture:view",
  PICTURE_UPLOAD: "picture:upload",
  PICTURE_EDIT: "picture:edit",
  PICTURE_DELETE: "picture:delete",
} as const;
```

### åˆ›å»ºå›¢é˜Ÿç©ºé—´

#### 1ã€åˆ›å»ºå›¢é˜Ÿç©ºé—´é¡µé¢

å¯ä»¥å¤ç”¨åˆ›å»ºç§æœ‰ç©ºé—´é¡µé¢ï¼Œé€šè¿‡è¯·æ±‚å‚æ•°çš„ type å­—æ®µæ¥åŒºåˆ†åˆ›å»ºå›¢é˜Ÿç©ºé—´ï¼ˆtype=1ï¼‰è¿˜æ˜¯ç§æœ‰ç©ºé—´ï¼ˆä¸ä¼  type æˆ–ä¸º 0ï¼‰ã€‚

1ï¼‰åˆ›å»ºç§æœ‰ç©ºé—´é¡µé¢æ–°å¢ç©ºé—´ç±»åˆ«å˜é‡ï¼š

```typescript
// ç©ºé—´ç±»åˆ«
const spaceType = computed(() => {
  if (route.query?.type) {
    return Number(route.query.type)
  }
  return SPACE_TYPE_ENUM.PRIVATE
})
```

2ï¼‰æäº¤è¡¨å•æ—¶ï¼Œé¢å¤–ä¼ é€’ spaceType å­—æ®µï¼š

```typescript
// åˆ›å»º
res = await addSpaceUsingPost({
  ...formData,
  spaceType: spaceType.value
})
```

3ï¼‰è¿˜å¯ä»¥ä¿®æ”¹æ ‡é¢˜çš„å±•ç¤ºï¼Œä½“ç°å‡ºç©ºé—´ç±»åˆ«ï¼š

```vue
<h2 style="margin-bottom: 16px">
  {{ route.query?.id ? 'ä¿®æ”¹' : 'åˆ›å»º' }}{{ SPACE_TYPE_MAP[spaceType] }}
</h2>
```

æ•ˆæœå¦‚å›¾ï¼š

![img](assets/r0BLXxzEyCGRHx7i.webp)

#### 2ã€åˆ›å»ºå›¢é˜Ÿç©ºé—´å…¥å£

1ï¼‰ç»™å…¨å±€ä¾§è¾¹æ å¢åŠ åˆ›å»ºå›¢é˜ŸæŒ‰é’®ï¼š

```typescript
// å›ºå®šçš„èœå•åˆ—è¡¨
const fixedMenuItems = [
  {
    key: '/',
    label: 'å…¬å…±å›¾åº“',
    icon: () => h(PictureOutlined),
  },
  {
    key: '/my_space',
    label: 'æˆ‘çš„ç©ºé—´',
    icon: () => h(UserOutlined),
  },
  {
    key: '/add_space?type=' + SPACE_TYPE_ENUM.TEAM,
    label: 'åˆ›å»ºå›¢é˜Ÿ',
    icon: () => h(TeamOutlined),
  },
]
```

2ï¼‰ç‚¹å‡»èœå•äº‹ä»¶è¦æ”¹ä¸º `router.push(key)`ï¼Œå¦åˆ™æ— æ³•æºå¸¦å‚æ•°è·³è½¬ï¼š

```typescript
// è·¯ç”±è·³è½¬äº‹ä»¶
const doMenuClick = ({ key }: { key: string }) => {
  router.push(key)
}
```

3ï¼‰åœ¨å…¨å±€ä¾§è¾¹æ ä¸­åŠ è½½ â€œæˆ‘çš„å›¢é˜Ÿç©ºé—´åˆ—è¡¨â€ï¼Œæ¯ä¸ªå›¢é˜Ÿç©ºé—´ä½œä¸ºä¸€ä¸ªèœå•é¡¹å±•ç¤ºã€‚æœ€ç»ˆå±•ç¤ºçš„èœå•é¡¹ = å›ºå®šèœå• + å›¢é˜Ÿç©ºé—´èœå•ï¼Œä»£ç å¦‚ä¸‹ï¼š

```typescript
const teamSpaceList = ref<API.SpaceUserVO[]>([])
const menuItems = computed(() => {
  // æ²¡æœ‰å›¢é˜Ÿç©ºé—´ï¼Œåªå±•ç¤ºå›ºå®šèœå•
  if (teamSpaceList.value.length < 1) {
    return fixedMenuItems;
  }
  // å±•ç¤ºå›¢é˜Ÿç©ºé—´åˆ†ç»„
  const teamSpaceSubMenus = teamSpaceList.value.map((spaceUser) => {
    const space = spaceUser.space
    return {
      key: '/space/' + spaceUser.spaceId,
      label: space?.spaceName,
    }
  })
  const teamSpaceMenuGroup = {
    type: 'group',
    label: 'æˆ‘çš„å›¢é˜Ÿ',
    key: 'teamSpace',
    children: teamSpaceSubMenus,
  }
  return [...fixedMenuItems, teamSpaceMenuGroup]
})

// åŠ è½½å›¢é˜Ÿç©ºé—´åˆ—è¡¨
const fetchTeamSpaceList = async () => {
  const res = await listMyTeamSpaceUsingPost()
  if (res.data.code === 0 && res.data.data) {
    teamSpaceList.value = res.data.data
  } else {
    message.error('åŠ è½½æˆ‘çš„å›¢é˜Ÿç©ºé—´å¤±è´¥ï¼Œ' + res.data.message)
  }
}

/**
 * ç›‘å¬å˜é‡ï¼Œæ”¹å˜æ—¶è§¦å‘æ•°æ®çš„é‡æ–°åŠ è½½
 */
watchEffect(() => {
  // ç™»å½•æ‰åŠ è½½
  if (loginUserStore.loginUser.id) {
    fetchTeamSpaceList()
  }
})
```

æ•ˆæœå¦‚å›¾ï¼š

![img](assets/KdeC66REA9ScoJnJ.webp)

### ç©ºé—´æˆå‘˜ç®¡ç†

#### 1ã€æˆå‘˜ç®¡ç†é¡µé¢å…¥å£

ç©ºé—´è¯¦æƒ…é¡µçš„ç©ºé—´åˆ†ææŒ‰é’®å·¦è¾¹å¢åŠ æˆå‘˜ç®¡ç†æŒ‰é’®ï¼Œç‚¹å‡»åè·³è½¬åˆ°æˆå‘˜ç®¡ç†é¡µé¢ï¼š

```vue
<a-button
  type="primary"
  ghost
  :icon="h(TeamOutlined)"
  :href="`/spaceUserManage/${id}`"
  target="_blank"
>
  æˆå‘˜ç®¡ç†
</a-button>
```

è¯¥é¡µé¢è¿˜æœ‰ä¸€äº›ç»†èŠ‚å¯ä»¥ä¼˜åŒ–ï¼Œæ¯”å¦‚ä¿®æ”¹æ ‡é¢˜å±•ç¤ºï¼ŒåŒºåˆ†ç©ºé—´ç±»åˆ«ï¼š

```vue
<h2>{{ space.spaceName }}ï¼ˆ{{ SPACE_TYPE_MAP[space.spaceType] }}ï¼‰</h2>
```

åˆ‡æ¢ç©ºé—´æ—¶ï¼Œåº”è¯¥é‡æ–°è·å–ç©ºé—´ä¿¡æ¯å’Œå›¾ç‰‡åˆ—è¡¨ã€‚å¯ä»¥ä½¿ç”¨ watch æ¥ç›‘å¬ç©ºé—´ id å˜é‡å®ç°ï¼š

```typescript
watch(
  () => props.id,
  (newSpaceId) => {
    fetchSpaceDetail()
    fetchData()
  },
)
```

æ•ˆæœå¦‚å›¾ï¼š

![img](assets/CUmJ7cFv8d56rQ8S.webp)

#### 2ã€ç©ºé—´æˆå‘˜ç®¡ç†é¡µé¢

å‚è€ƒè¯­é›€çš„ç©ºé—´æˆå‘˜ç®¡ç†ï¼Œé¡µé¢ç»“æ„ä¸ºæ·»åŠ æˆå‘˜è¡¨å• + æˆå‘˜ä¿¡æ¯è¡¨æ ¼ï¼š

![img](assets/InejTLT8R5DKz4TF.webp)

1ï¼‰å¤åˆ¶ç©ºé—´ç®¡ç†é¡µé¢ï¼Œæ–°å»ºè·¯ç”±ï¼Œè¯¥é¡µé¢æ¥å—ç©ºé—´ id ä½œä¸ºåŠ¨æ€å‚æ•°ï¼Œå±•ç¤ºæŸä¸ªç©ºé—´ä¸‹çš„æˆå‘˜åˆ—è¡¨ï¼š

```typescript
{
  path: '/spaceUserManage/:id',
  name: 'ç©ºé—´æˆå‘˜ç®¡ç†',
  component: SpaceUserManagePage,
  props: true,
},
```

è¯¥é¡µé¢ç»å¤§å¤šæ•°ä»£ç éƒ½å¯ä»¥å¤ç”¨ç©ºé—´ç®¡ç†é¡µé¢ï¼Œåªéœ€è¦éµå¾ªæµç¨‹ä¿®æ”¹å³å¯ã€‚

2ï¼‰å®šä¹‰è¡¨æ ¼åˆ—ï¼š

```typescript
// è¡¨æ ¼åˆ—
const columns = [
  {
    title: 'ç”¨æˆ·',
    dataIndex: 'userInfo',
  },
  {
    title: 'è§’è‰²',
    dataIndex: 'spaceRole',
  },
  {
    title: 'åˆ›å»ºæ—¶é—´',
    dataIndex: 'createTime',
  },
  {
    title: 'æ“ä½œ',
    key: 'action',
  },
]
```

3ï¼‰è°ƒç”¨æ¥å£ä»¥è·å–è¡¨æ ¼æ•°æ®ï¼Œæ­¤å¤„ä¸éœ€è¦åˆ†é¡µï¼Œç›´æ¥å±•ç¤ºæ‰€æœ‰æˆå‘˜ï¼š

```typescript
// å®šä¹‰å±æ€§
interface Props {
  id: string
}

const props = defineProps<Props>()

// æ•°æ®
const dataList = ref([])

// è·å–æ•°æ®
const fetchData = async () => {
  const spaceId = props.id
  if (!spaceId) {
    return
  }
  const res = await listSpaceUserUsingPost({
    spaceId,
  })
  if (res.data.data) {
    dataList.value = res.data.data ?? []
  } else {
    message.error('è·å–æ•°æ®å¤±è´¥ï¼Œ' + res.data.message)
  }
}

// é¡µé¢åŠ è½½æ—¶è¯·æ±‚ä¸€æ¬¡
onMounted(() => {
  fetchData()
})
```

4ï¼‰è‡ªå®šä¹‰è¡¨æ ¼åˆ—ï¼Œå±•ç¤ºç”¨æˆ·ä¿¡æ¯ã€ç©ºé—´è§’è‰²ã€åˆ›å»ºæ—¶é—´å’Œæ“ä½œæŒ‰é’®ã€‚ç”±äºå¯ä¿®æ”¹çš„æˆå‘˜ä¿¡æ¯åªæœ‰ â€œè§’è‰²â€ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥å°†ç©ºé—´è§’è‰²æ¸²æŸ“ä¸ºä¸‹æ‹‰æ¡†é€‰æ‹©å™¨ç»„ä»¶ï¼Œä¾¿äºç®¡ç†å‘˜æ“ä½œã€‚

```vue
<a-table :columns="columns" :data-source="dataList">
  <template #bodyCell="{ column, record }">
    <template v-if="column.dataIndex === 'userInfo'">
      <a-space>
        <a-avatar :src="record.user?.userAvatar" />
        {{ record.user?.userName }}
      </a-space>
    </template>
    <template v-if="column.dataIndex === 'spaceRole'">
      <a-select
        v-model:value="record.spaceRole"
        :options="SPACE_ROLE_OPTIONS"
        @change="(value) => editSpaceRole(value, record)"
      />
    </template>
    <template v-else-if="column.dataIndex === 'createTime'">
      {{ dayjs(record.createTime).format('YYYY-MM-DD HH:mm:ss') }}
    </template>
    <template v-else-if="column.key === 'action'">
      <a-space wrap>
        <a-button type="link" danger @click="doDelete(record.id)">åˆ é™¤</a-button>
      </a-space>
    </template>
  </template>
</a-table>
```

ç¼–è¾‘ç©ºé—´è§’è‰²çš„å‡½æ•°ï¼š

```typescript
const editSpaceRole = async (value, record) => {
  const res = await editSpaceUserUsingPost({
    id: record.id,
    spaceRole: value,
  })
  if (res.data.code === 0) {
    message.success('ä¿®æ”¹æˆåŠŸ')
  } else {
    message.error('ä¿®æ”¹å¤±è´¥ï¼Œ' + res.data.message)
  }
}
```

åˆ é™¤æˆå‘˜çš„å‡½æ•°ï¼š

```typescript
const doDelete = async (id: string) => {
  if (!id) {
    return
  }
  const res = await deleteSpaceUserUsingPost({ id })
  if (res.data.code === 0) {
    message.success('åˆ é™¤æˆåŠŸ')
    // åˆ·æ–°æ•°æ®
    fetchData()
  } else {
    message.error('åˆ é™¤å¤±è´¥')
  }
}
```

5ï¼‰åœ¨è¡¨æ ¼ä¸Šæ–¹ç¼–å†™æ·»åŠ æˆå‘˜è¡¨å•ï¼Œé»˜è®¤è§’è‰²æ˜¯ â€œæµè§ˆè€…â€

```vue
<a-form layout="inline" :model="formData" @finish="handleSubmit">
  <a-form-item label="ç”¨æˆ· id" name="userId">
    <a-input v-model:value="formData.userId" placeholder="è¯·è¾“å…¥ç”¨æˆ· id" allow-clear />
  </a-form-item>
  <a-form-item>
    <a-button type="primary" html-type="submit">æ·»åŠ ç”¨æˆ·</a-button>
  </a-form-item>
</a-form>
```

ç¼–å†™è¡¨å•é¡¹å˜é‡å’Œæäº¤å‡½æ•°ï¼š

```typescript
// æ·»åŠ ç”¨æˆ·
const formData = reactive<API.SpaceUserAddRequest>({})

const handleSubmit = async () => {
  const spaceId = props.id
  if (!spaceId) {
    return
  }
  const res = await addSpaceUserUsingPost({
    spaceId,
    ...formData,
  })
  if (res.data.code === 0) {
    message.success('æ·»åŠ æˆåŠŸ')
    // åˆ·æ–°æ•°æ®
    fetchData()
  } else {
    message.error('æ·»åŠ å¤±è´¥ï¼Œ' + res.data.message)
  }
}
```

é¡µé¢æ•ˆæœå¦‚å›¾ï¼š

![img](assets/0ejY0iSCoUeMNMTH.webp)

### æˆå‘˜æƒé™æ§åˆ¶

#### 1ã€éœ€æ±‚æ¢³ç†

éœ€æ±‚ï¼šç”¨æˆ·æ²¡æœ‰æŸä¸ªæ“ä½œæƒé™æ—¶ï¼Œä¸åº”è¯¥çœ‹åˆ°å¯¹åº”çš„æ“ä½œæŒ‰é’®ã€‚

é¦–å…ˆæ¢³ç†ä¸€ä¸‹é¡µé¢å’Œéœ€è¦æ§åˆ¶æƒé™çš„æŒ‰é’®ï¼Œä»¥åŠå¯¹åº”çš„æƒé™ï¼š

1ï¼‰ç©ºé—´è¯¦æƒ…é¡µ

- å›¾ç‰‡ç¼–è¾‘æŒ‰é’®ï¼šéœ€è¦ `picture:edit` æƒé™
- å›¾ç‰‡åˆ é™¤æŒ‰é’®ï¼šéœ€è¦ `picture:delete` æƒé™
- æˆå‘˜ç®¡ç†æŒ‰é’®ï¼šéœ€è¦ `spaceUser:manage` æƒé™
- ç©ºé—´åˆ†ææŒ‰é’®ï¼šéœ€è¦ `spaceUser:manage` æƒé™
- ä¸Šä¼ å›¾ç‰‡æŒ‰é’®ï¼šéœ€è¦ `picture:upload` æƒé™

2ï¼‰å›¾ç‰‡è¯¦æƒ…é¡µ

- å›¾ç‰‡ç¼–è¾‘æŒ‰é’®ï¼šéœ€è¦ `picture:edit` æƒé™
- å›¾ç‰‡åˆ é™¤æŒ‰é’®ï¼šéœ€è¦ `picture:delete` æƒé™

#### 2ã€æƒé™æ§åˆ¶

1ï¼‰ç©ºé—´è¯¦æƒ…é¡µæ–°å¢æƒé™å˜é‡ã€‚ç”±äºæ¯ä¸ªæƒé™æ£€æŸ¥çš„é€»è¾‘éƒ½æ˜¯ä¸€è‡´çš„ï¼ˆåˆ¤æ–­æƒé™åˆ—è¡¨ä¸­æ˜¯å¦åŒ…å«éœ€è¦çš„æƒé™ï¼‰ï¼Œå¯ä»¥ç¼–å†™ä¸€ä¸ªé€šç”¨çš„æƒé™æ£€æŸ¥å‡½æ•°ã€‚

```typescript
// é€šç”¨æƒé™æ£€æŸ¥å‡½æ•°
function createPermissionChecker(permission: string) {
  return computed(() => {
    return (space.value.permissionList ?? []).includes(permission)
  })
}

// å®šä¹‰æƒé™æ£€æŸ¥
const canManageSpaceUser = createPermissionChecker(SPACE_PERMISSION_ENUM.SPACE_USER_MANAGE)
const canUploadPicture = createPermissionChecker(SPACE_PERMISSION_ENUM.PICTURE_UPLOAD)
const canEditPicture = createPermissionChecker(SPACE_PERMISSION_ENUM.PICTURE_EDIT)
const canDeletePicture = createPermissionChecker(SPACE_PERMISSION_ENUM.PICTURE_DELETE)
```

ğŸ’¡ å…¶å®ä¹Ÿå¯ä»¥è®©åç«¯è®¡ç®—å¥½ `canXXX`ï¼Œç„¶åè¿”å›ç»™å‰ç«¯ç›´æ¥ç”¨ï¼Œä¸è¿‡å·®åˆ«ä¸å¤§ã€‚

2ï¼‰ç»™å¯¹åº”çš„æ“ä½œæŒ‰é’®å¢åŠ  `v-if`ï¼Œæ¯”å¦‚åˆ›å»ºå›¾ç‰‡æŒ‰é’®ï¼š

```vue
<a-button
  v-if="canUploadPicture"
  type="primary"
  :href="`/add_picture?spaceId=${id}`"
  target="_blank"
>
  + åˆ›å»ºå›¾ç‰‡
</a-button>
```

3ï¼‰å›¾ç‰‡åˆ—è¡¨ç»„ä»¶æ”¯æŒæ§åˆ¶ç¼–è¾‘å’Œåˆ é™¤æŒ‰é’®çš„éšè—ï¼Œç”±çˆ¶ç»„ä»¶ä¼ é€’å±æ€§ï¼š

```typescript
interface Props {
  dataList?: API.PictureVO[]
  loading?: boolean
  showOp?: boolean
  onReload?: () => void
  canEdit?: boolean
  canDelete?: boolean
}

const props = withDefaults(defineProps<Props>(), {
  dataList: () => [],
  loading: false,
  showOp: false,
  canEdit: false,
  canDelete: false,
})
```

é¡µé¢ä»£ç ï¼š

```vue
<edit-outlined v-if="canEdit" @click="(e) => doEdit(picture, e)" />
<delete-outlined v-if="canDelete" @click="(e) => doDelete(picture, e)" />
```

ç©ºé—´è¯¦æƒ…é¡µå°±å¯ä»¥å°†æƒé™å˜é‡ä¼ é€’ç»™è¯¥ç»„ä»¶äº†ï¼š

```vue
<!-- å›¾ç‰‡åˆ—è¡¨ -->
<PictureList
  :dataList="dataList"
  :loading="loading"
  :onReload="fetchData"
  showOp
  :canEdit="canEditPicture"
  :canDelete="canDeletePicture"
/>
```

4ï¼‰å›¾ç‰‡è¯¦æƒ…é¡µä¹ŸæŒ‰ç…§ä¸Šè¿°æ–¹å¼è¿›è¡Œä¿®æ”¹ï¼Œä¸å†èµ˜è¿°ï¼š

```typescript
// é€šç”¨æƒé™æ£€æŸ¥å‡½æ•°
function createPermissionChecker(permission: string) {
  return computed(() => {
    return (picture.value.permissionList ?? []).includes(permission)
  })
}

// å®šä¹‰æƒé™æ£€æŸ¥
const canEdit = createPermissionChecker(SPACE_PERMISSION_ENUM.PICTURE_EDIT)
const canDelete = createPermissionChecker(SPACE_PERMISSION_ENUM.PICTURE_DELETE)
```

#### 3ã€å‰ç«¯æµ‹è¯•

æ¶‰åŠåˆ°æƒé™çš„æ”¹åŠ¨éƒ½è¦è®¤çœŸæµ‹è¯•ï¼Œå¯ä»¥ä¸»è¦æµ‹è¯•ä»¥ä¸‹æƒ…å†µï¼šbgMhj83Bt96lFcj29lBZCF0o0+YPCGWOWUw0OPyFB/Q=

- æœªç™»å½•æ“ä½œå…¬å…±å›¾åº“ã€ç§æœ‰å›¾åº“ã€å›¢é˜Ÿå›¾åº“
- ç®¡ç†å‘˜æ“ä½œå…¬å…±å›¾åº“ã€ç§æœ‰å›¾åº“ã€å›¢é˜Ÿå›¾åº“
- æ™®é€šç”¨æˆ·æ“ä½œå…¬å…±å›¾åº“ã€ç§æœ‰å›¾åº“ã€åˆ«äººçš„ç§æœ‰å›¾åº“
- åä½œè€…æ“ä½œå›¢é˜Ÿå›¾åº“ï¼Œå¯ä»¥çœ‹åˆ°ç¼–è¾‘å’Œåˆ é™¤æŒ‰é’®ï¼Œä½†çœ‹ä¸åˆ°æˆå‘˜ç®¡ç†æŒ‰é’®
- æµè§ˆè€…æ“ä½œå›¢é˜Ÿå›¾åº“ï¼Œä»…èƒ½æŸ¥çœ‹å›¾ç‰‡ï¼Œçœ‹ä¸åˆ°ç¼–è¾‘å’Œåˆ é™¤æŒ‰é’®

### å…¶ä»–å¼€å‘

#### 1ã€é—®é¢˜ä¿®å¤ - å…¼å®¹å¤šä¸ªç©ºé—´

MySpacePage è·å–æˆ‘çš„ç©ºé—´æ—¶ï¼Œæ”¹ä¸ºè·å– â€œç§æœ‰ç©ºé—´â€ çš„ç¬¬ä¸€ä¸ªï¼š

```typescript
// è·å–ç”¨æˆ·ç©ºé—´ä¿¡æ¯
const res = await listSpaceVoByPageUsingPost({
  userId: loginUser.id,
  current: 1,
  pageSize: 1,
  spaceType: 0,
})
```

#### 2ã€ç©ºé—´ç®¡ç†è¡¥å……ç©ºé—´ç±»åˆ«

è¡¥å……ç©ºé—´ç±»åˆ«åˆ—çš„å®šä¹‰ï¼š

```typescript
{
  title: 'ç©ºé—´ç±»åˆ«',
  dataIndex: 'spaceType',
},
```

è‡ªå®šä¹‰ç©ºé—´ç±»åˆ«åˆ—çš„å±•ç¤ºï¼š

```vue
<!-- ç©ºé—´ç±»åˆ« -->
<template v-if="column.dataIndex === 'spaceType'">
  <a-tag>{{ SPACE_TYPE_MAP[record.spaceType] }}</a-tag>
</template>
```

æ”¯æŒæŒ‰ç±»åˆ«æœç´¢ï¼š

```vue
<a-form-item label="ç©ºé—´ç±»åˆ«" name="spaceType">
  <a-select
      v-model:value="searchParams.spaceType"
      :options="SPACE_TYPE_OPTIONS"
      placeholder="è¯·è¾“å…¥ç©ºé—´ç±»åˆ«"
      style="min-width: 180px"
      allow-clear
  />
</a-form-item>
```

æ•ˆæœå¦‚å›¾ï¼š

![img](assets/lSQs1Fiy4JhSdck7.webp)



ä»¥ä¸Šå°±æ˜¯æœ¬èŠ‚å†…å®¹ï¼Œç»†èŠ‚éå¸¸å¤šï¼Œå¸Œæœ›å¤§å®¶èƒ½å¤ŸæŒæ¡ï¼Œæœ€å¥½æ˜¯è‡ªå·±è¯•ç€æ•²ä¸€éã€‚







# 12 - å›¾ç‰‡ååŒç¼–è¾‘

## æœ¬èŠ‚é‡ç‚¹

ä¸Šä¸€èŠ‚æˆ‘ä»¬å·²ç»å®Œæˆäº†å›¢é˜Ÿç©ºé—´çš„åˆ›å»ºã€æˆå‘˜ç®¡ç†å’Œæƒé™æ§åˆ¶ç­‰åŠŸèƒ½ã€‚ä¸ºäº†æé«˜é¡¹ç›®çš„å•†ä¸šä»·å€¼ï¼Œæœ¬èŠ‚æ¥å®Œæˆæœ¬é¡¹ç›®çš„äº®ç‚¹åŠŸèƒ½ â€”â€” å›¾ç‰‡ååŒç¼–è¾‘ã€‚

å¤§çº²ï¼š

- å›¾ç‰‡ååŒç¼–è¾‘éœ€æ±‚åˆ†æ
- å›¾ç‰‡ååŒç¼–è¾‘æ–¹æ¡ˆè®¾è®¡
- å›¾ç‰‡ååŒç¼–è¾‘åç«¯å¼€å‘
- å›¾ç‰‡ååŒç¼–è¾‘å‰ç«¯å¼€å‘

é€šè¿‡æœ¬èŠ‚ï¼Œä½ å°†å­¦ä¹ åˆ°å¤šäººå®æ—¶åä½œåŠŸèƒ½çš„è®¾è®¡å¼€å‘ï¼Œæ¶‰åŠ WebSocketã€äº‹ä»¶é©±åŠ¨è®¾è®¡ã€Disruptor æ— é”é˜Ÿåˆ—ç­‰æŠ€æœ¯çŸ¥è¯†ã€‚å­¦ä¼šåå†å»å¼€å‘èŠå¤©å®¤ä¹‹ç±»çš„ä¸šåŠ¡ï¼Œéƒ½ä¼šè½»æ¾å¾ˆå¤šã€‚

## ä¸€ã€éœ€æ±‚åˆ†æ

ç°åœ¨å¾ˆå¤šäº§å“éƒ½æœ‰å¤šäººåä½œåŠŸèƒ½ï¼Œæ¯”å¦‚ååŒæ–‡æ¡£ã€ååŒç´ æè®¾è®¡ã€ååŒä»£ç ç¼–è¾‘å™¨ç­‰ç­‰ï¼Œå¯ä»¥æé«˜åä½œçš„æ•ˆç‡ã€‚

å¯¹äºæˆ‘ä»¬çš„é¡¹ç›®ï¼Œæ‰€è°“çš„å›¾ç‰‡ååŒç¼–è¾‘åŠŸèƒ½ï¼Œæ˜¯åœ¨å›¾ç‰‡ç¼–è¾‘çš„åŸºç¡€ä¸Šå¢åŠ äº† â€œååŒâ€ çš„æ¦‚å¿µã€‚å½“ç”¨æˆ·ç¼–è¾‘æŸå¼ å›¾ç‰‡æ—¶ï¼Œå…¶ä»–ç”¨æˆ·å¯ä»¥ **å®æ—¶** çœ‹åˆ°ç¼–è¾‘æ•ˆæœå’Œæ“ä½œæç¤ºã€‚å¦‚å›¾ï¼š

![img](assets/IYbEr41yUlFxYpBy.webp)

æ³¨æ„ï¼Œå› ä¸ºåªæœ‰å›¢é˜Ÿç©ºé—´æ‰ä¼šæœ‰å¤šä¸ªç”¨æˆ·ç¼–è¾‘åŒä¸€å¼ å›¾ç‰‡ï¼Œæ‰€ä»¥è¯¥åŠŸèƒ½åªå¯¹å›¢é˜Ÿç©ºé—´å¼€æ”¾ï¼Œéœ€è¦æˆå‘˜å…·æœ‰ç¼–è¾‘æƒé™ã€‚ååŒçš„å›¾ç‰‡ç¼–è¾‘æ“ä½œåŒ…æ‹¬å·¦æ—‹ã€å³æ—‹ã€æ”¾å¤§ã€ç¼©å°ã€‚

## äºŒã€æ–¹æ¡ˆè®¾è®¡

è™½ç„¶éœ€æ±‚ä»‹ç»å¾ˆç®€å•ï¼Œä½†æ˜¯æ¶‰åŠåˆ°å¤šäººåä½œçš„ä¸šåŠ¡ï¼Œæœ‰å¾ˆå¤šé—®é¢˜éœ€è¦è€ƒè™‘ï¼Œæ¯”å¦‚ï¼š

- å¤šä¸ªç”¨æˆ·ä¹‹é—´å¦‚ä½•è¿›è¡Œäº¤äº’ï¼Ÿ
- å¦‚ä½•é˜²æ­¢åä½œç¼–è¾‘æ—¶å‡ºç°å†²çªï¼Ÿ
- å¦‚ä½•æé«˜åä½œçš„å®æ—¶æ€§ï¼Ÿ

### åä½œäº¤äº’æµç¨‹

å¤šäººåä½œæ—¶ï¼Œæ¯ä¸ªç”¨æˆ·çš„åŠ¨ä½œéƒ½éœ€è¦é€šçŸ¥åˆ°å…¶ä»–ç”¨æˆ·ï¼Œæ”¶åˆ°é€šçŸ¥æ¶ˆæ¯çš„ç”¨æˆ·éœ€è¦è¿›è¡Œç›¸åº”çš„å¤„ç†ã€‚

æ¯”å¦‚ç”¨æˆ· A æ”¾å¤§äº†å›¾ç‰‡ï¼Œå°±éœ€è¦ç»™å…¶ä»–æ­£åœ¨ç¼–è¾‘çš„ç”¨æˆ·å‘é€ â€œå›¾ç‰‡æ”¾å¤§â€ æ¶ˆæ¯ï¼Œå…¶ä»–ç”¨æˆ·æ”¶åˆ°è¿™ä¸ªæ¶ˆæ¯åï¼Œéœ€è¦åŒæ­¥æ”¾å¤§è‡ªå·±ç•Œé¢ä¸Šçš„å›¾ç‰‡ã€‚

è¿™å…¶å®æ˜¯ä¸€ç§ **äº‹ä»¶é©±åŠ¨** çš„æ¶æ„è®¾è®¡æ€æƒ³ï¼Œåä½œç¼–è¾‘ä¸­çš„æ¯ä¸ªç”¨æˆ·åŠ¨ä½œæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ª **äº‹ä»¶**ï¼Œæ‰§è¡ŒåŠ¨ä½œæ—¶ä¼šäº§ç”Ÿäº‹ä»¶å¹¶æäº¤ç»™æœåŠ¡å™¨ï¼›æœåŠ¡å™¨æ”¶åˆ°äº‹ä»¶åï¼Œä¼šè½¬å‘ç»™å…¶ä»–ç”¨æˆ·ï¼›å…¶ä»–ç”¨æˆ·æ”¶åˆ°äº‹ä»¶åï¼Œå°±è¦ä½œä¸ºäº‹ä»¶çš„æ¶ˆè´¹è€…æ¥å¤„ç†äº‹ä»¶ã€‚æµç¨‹å¦‚å›¾ï¼š

![image.png](assets/qB0wqWA3akSsTOz4.webp)

ç›¸æ¯”äºç”Ÿäº§è€…ç›´æ¥è°ƒç”¨æ¶ˆè´¹è€…ï¼Œäº‹ä»¶é©±åŠ¨æ¨¡å‹çš„ä¸»è¦ä¼˜ç‚¹åœ¨äº **è§£è€¦** å’Œ **å¼‚æ­¥æ€§**ã€‚åœ¨äº‹ä»¶é©±åŠ¨æ¨¡å‹ä¸­ï¼Œç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ä¸éœ€è¦ç›´æ¥ä¾èµ–äºå½¼æ­¤çš„å®ç°ï¼Œç”Ÿäº§è€…åªéœ€è§¦å‘äº‹ä»¶å¹¶å°†å…¶å‘é€åˆ°äº‹ä»¶åˆ†å‘å™¨ï¼Œæ¶ˆè´¹è€…åˆ™æ ¹æ®äº‹ä»¶ç±»å‹å¤„ç†é€»è¾‘ã€‚è¿™æ ·å¤šä¸ªæ¶ˆè´¹è€…å¯ä»¥ç‹¬ç«‹å“åº”åŒä¸€äº‹ä»¶ï¼ˆæ¯”å¦‚ä¸€ä¸ªç”¨æˆ·æ—‹è½¬äº†å›¾ç‰‡ï¼Œå…¶ä»–ç”¨æˆ·éƒ½èƒ½åŒæ­¥ï¼‰ï¼Œç³»ç»Ÿæ›´åŠ çµæ´»ï¼Œå¯æ‰©å±•æ€§æ›´å¼ºã€‚æ­¤å¤–ï¼Œäº‹ä»¶é©±åŠ¨è¿˜å¯ä»¥æå‡ç³»ç»Ÿçš„ **å¹¶å‘æ€§p87QUult0bZDR05AO5soQVixQ5nCQ+HA+P5tLSHK/hI=** å’Œ **å®æ—¶æ€§**ï¼Œå¯ä»¥ç†è§£ä¸ºå¤šå¼•å…¥äº†ä¸€ä¸ªä¸­ä»‹æ¥å¸®å¿™ï¼Œé€šè¿‡å¼‚æ­¥æ¶ˆæ¯ä¼ é€’ï¼Œå‡å°‘äº†é˜»å¡å’Œç­‰å¾…ï¼Œèƒ½å¤Ÿæ›´é«˜æ•ˆåœ°å¤„ç†å¤šä¸ªå¹¶å‘ä»»åŠ¡ã€‚

ä¸‹é¢æˆ‘ä»¬æŒ‰ç…§äº‹ä»¶é©±åŠ¨çš„è®¾è®¡ï¼Œæ¥è¯¦ç»†åˆ—ä¸¾åä½œç¼–è¾‘çš„äº¤äº’æµç¨‹ï¼š

| äº‹ä»¶è§¦å‘è€…ï¼ˆç”¨æˆ· A çš„åŠ¨ä½œï¼‰ | äº‹ä»¶ç±»å‹ï¼ˆå‘é€æ¶ˆæ¯ï¼‰ | äº‹ä»¶æ¶ˆè´¹è€…ï¼ˆå…¶ä»–ç”¨æˆ·çš„å¤„ç†ï¼‰      |
| --------------------------- | -------------------- | --------------------------------- |
| ç”¨æˆ· A å»ºç«‹è¿æ¥ï¼ŒåŠ å…¥ç¼–è¾‘   | INFO                 | æ˜¾ç¤ºâ€œç”¨æˆ· A åŠ å…¥ç¼–è¾‘â€çš„é€šçŸ¥       |
| ç”¨æˆ· A æ‰§è¡Œç¼–è¾‘æ“ä½œ         | EDIT_ACTION          | æ”¾å¤§ / ç¼©å° / å·¦æ—‹ / å³æ—‹å½“å‰å›¾ç‰‡ |
| ç”¨æˆ· A æ–­å¼€è¿æ¥ï¼Œç¦»å¼€ç¼–è¾‘   | INFO                 | æ˜¾ç¤ºâ€œç”¨æˆ· A ç¦»å¼€ç¼–è¾‘â€çš„é€šçŸ¥       |

### è§£å†³åä½œå†²çª

#### 1ã€è§£å†³æ–¹æ¡ˆ

å‡è®¾è¿™æ ·ä¸€ç§åœºæ™¯ï¼šé±¼çš®å’Œæè›‹åŒæ—¶å¿«é€Ÿç‚¹å‡»äº†åæ¬¡æ—‹è½¬ï¼Œæœ€ç»ˆçš„ç»“æœä¼šæ˜¯æ€æ ·çš„å‘¢ï¼Ÿ

å¦‚æœæ‰€æœ‰äº‹ä»¶éƒ½æ˜¯æŒ‰é¡ºåºå¤„ç†çš„ï¼Œé‚£ç»“æœå°±å¾ˆæ¸…æ™°äº†ï¼Œä½†äº‹å®ä¸Šï¼Œä¸ºäº†æé«˜æ€§èƒ½å’Œå“åº”é€Ÿåº¦ï¼Œäº‹ä»¶é€šå¸¸æ˜¯ **å¹¶å‘** çš„ï¼Œè€Œä¸æ˜¯ä¸¥æ ¼çš„é¡ºåºæ‰§è¡Œã€‚è¿™ç§å¹¶å‘æ“ä½œä¼šå¼•å‘ **åä½œå†²çª**ï¼Œå¯¼è‡´å…¶ä»–ç”¨æˆ·çœ‹åˆ°çš„æ—‹è½¬æ•ˆæœæ˜¯ä¹±åºçš„ã€‚

é‚£ä¹ˆä½ ä¼šæ€ä¹ˆè§£å†³åä½œå†²çªçš„é—®é¢˜å‘¢ï¼Ÿ

æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸šåŠ¡è®¾è®¡æ¥å‡å°‘å¼€å‘æˆæœ¬ï¼Œæ¯”å¦‚çº¦å®š **åŒä¸€æ—¶åˆ»åªå…è®¸ä¸€ä½ç”¨æˆ·è¿›å…¥ç¼–è¾‘å›¾ç‰‡çš„çŠ¶æ€**ï¼Œæ­¤æ—¶å…¶ä»–ç”¨æˆ·åªèƒ½å®æ—¶æµè§ˆåˆ°ä¿®æ”¹æ•ˆæœï¼Œä½†ä¸èƒ½å‚ä¸ç¼–è¾‘ï¼›è¿›å…¥ç¼–è¾‘çŠ¶æ€çš„ç”¨æˆ·å¯ä»¥é€€å‡ºç¼–è¾‘ï¼Œå…¶ä»–ç”¨æˆ·æ‰å¯ä»¥è¿›å…¥ç¼–è¾‘çŠ¶æ€ã€‚ç±»ä¼¼äºç»™å›¾ç‰‡ç¼–è¾‘è¿™ä¸ªåŠ¨ä½œåŠ äº†ä¸€æŠŠé”ï¼Œç›´æ¥ä»æºå¤´ä¸Šè§£å†³äº†ç¼–è¾‘å†²çªçš„é—®é¢˜ã€‚

æ­¤æ—¶ï¼Œåä½œç¼–è¾‘çš„äº¤äº’æµç¨‹åˆè¦å¢åŠ  2 ä¸ªåŠ¨ä½œ â€”â€” è¿›å…¥ç¼–è¾‘çŠ¶æ€å’Œé€€å‡ºç¼–è¾‘çŠ¶æ€ï¼š



| äº‹ä»¶è§¦å‘è€…ï¼ˆç”¨æˆ· A çš„åŠ¨ä½œï¼‰ | äº‹ä»¶ç±»å‹ï¼ˆå‘é€æ¶ˆæ¯ï¼‰ | äº‹ä»¶æ¶ˆè´¹è€…ï¼ˆå…¶ä»–ç”¨æˆ·çš„å¤„ç†ï¼‰                        |
| --------------------------- | -------------------- | --------------------------------------------------- |
| ç”¨æˆ· A å»ºç«‹è¿æ¥ï¼ŒåŠ å…¥ç¼–è¾‘   | INFO                 | æ˜¾ç¤ºâ€œç”¨æˆ· A åŠ å…¥ç¼–è¾‘â€çš„é€šçŸ¥                         |
| ç”¨æˆ· A è¿›å…¥ç¼–è¾‘çŠ¶æ€         | ENTER_EDIT           | å…¶ä»–ç”¨æˆ·ç•Œé¢æ˜¾ç¤ºâ€œç”¨æˆ· A å¼€å§‹ç¼–è¾‘å›¾ç‰‡â€ï¼Œé”å®šç¼–è¾‘çŠ¶æ€ |
| ç”¨æˆ· A æ‰§è¡Œç¼–è¾‘æ“ä½œ         | EDIT_ACTION          | æ”¾å¤§ / ç¼©å° / å·¦æ—‹ / å³æ—‹å½“å‰å›¾ç‰‡                   |
| ç”¨æˆ· A é€€å‡ºç¼–è¾‘çŠ¶æ€         | EXIT_EDIT            | è§£é”ç¼–è¾‘çŠ¶æ€ï¼Œæç¤ºå…¶ä»–ç”¨æˆ·å¯ä»¥è¿›å…¥ç¼–è¾‘çŠ¶æ€          |
| ç”¨æˆ· A æ–­å¼€è¿æ¥ï¼Œç¦»å¼€ç¼–è¾‘   | INFO                 | æ˜¾ç¤ºâ€œç”¨æˆ· A ç¦»å¼€ç¼–è¾‘â€çš„é€šçŸ¥ï¼Œå¹¶é‡Šæ”¾ç¼–è¾‘çŠ¶æ€         |
| ç”¨æˆ· A å‘é€äº†é”™è¯¯çš„æ¶ˆæ¯     | ERROR                | æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯çš„é€šçŸ¥                                  |

å…¶å®æ ¸å¿ƒæµç¨‹æ˜¯å‰ 5 è¡Œï¼Œä½†æ˜¯è€ƒè™‘åˆ°å‰ç«¯ä¼ é€’äº†é”™è¯¯å‚æ•°çš„æƒ…å†µï¼Œæˆ‘ä»¬æ–°å¢ä¸€ç§ `ERROR` äº‹ä»¶ç±»å‹ï¼Œå¯ç”¨äºå±•ç¤ºé”™è¯¯æç¤ºä¿¡æ¯ã€‚

åœ¨æœ¬é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬å°±é‡‡ç”¨è¿™ç§æ–¹æ¡ˆï¼Œä¸ä»…å®ç°ç®€å•ã€æµç¨‹æ¸…æ™°ï¼Œä¹Ÿå°½æœ€å¤§å¯èƒ½å‡å°‘äº†ç¼–è¾‘å†²çªçš„é£é™©ã€‚

ä½†è¿™ç§æ–¹æ¡ˆçš„ç¼ºç‚¹ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œå‡å°‘äº†å®æ—¶åä½œçš„ä¾¿åˆ©æ€§ï¼Œå¯¹äºåä½œè®¾è®¡ã€åä½œç¼–ç ã€åä½œæ–‡æ¡£çš„åœºæ™¯ï¼ŒåŒä¸€æ—¶é—´åªèƒ½æœ‰ä¸€ä¸ªç”¨æˆ·ç¼–è¾‘ï¼Œæé«˜çš„æ•ˆç‡æœ‰é™ã€‚æ‰€ä»¥è¿™é‡Œå†åˆ†äº«å¦å¤–ä¸€ç§å®æ—¶ååŒç®—æ³•ä½œä¸ºæ‰©å±•çŸ¥è¯†ã€‚

#### 2ã€æ‰©å±•çŸ¥è¯† - OT ç®—æ³•

å®æ—¶ååŒ OT ç®—æ³•ï¼ˆOperational Transformationï¼‰æ˜¯ä¸€ç§æ”¯æŒåˆ†å¸ƒå¼ç³»ç»Ÿä¸­å¤šä¸ªç”¨æˆ·å®æ—¶åä½œç¼–è¾‘çš„æ ¸å¿ƒç®—æ³•ï¼Œå¹¿æ³›åº”ç”¨äºåœ¨çº¿æ–‡æ¡£åä½œç­‰åœºæ™¯ã€‚OT ç®—æ³•çš„ä¸»è¦åŠŸèƒ½æ˜¯è§£å†³å¹¶å‘ç¼–è¾‘å†²çªï¼Œ**ç¡®ä¿ç¼–è¾‘ç»“æœåœ¨æ‰€æœ‰ç”¨æˆ·ç»ˆç«¯ä¸€è‡´**ã€‚

OT ç®—æ³•å…¶å®å¾ˆå¥½ç†è§£ï¼Œå…ˆçœ‹ä¸‹ 3 ä¸ªæ ¸å¿ƒæ¦‚å¿µï¼š

- æ“ä½œ (Operation)ï¼šè¡¨ç¤ºç”¨æˆ·å¯¹åä½œå†…å®¹çš„ä¿®æ”¹ï¼Œæ¯”å¦‚æ’å…¥å­—ç¬¦ã€åˆ é™¤å­—ç¬¦ç­‰ã€‚
- è½¬åŒ– (Transformation)ï¼šå½“å¤šä¸ªç”¨æˆ·åŒæ—¶ç¼–è¾‘å†…å®¹æ—¶ï¼ŒOT ä¼šæ ¹æ®æ“ä½œçš„ä¸Šä¸‹æ–‡å°†å®ƒä»¬è½¬åŒ–ï¼Œä½¿å¾—è¿™äº›æ“ä½œå¯ä»¥æŒ‰ç…§ä¸åŒçš„é¡ºåºåº”ç”¨è€Œç»“æœä¿æŒä¸€è‡´ã€‚
- å› æœä¸€è‡´æ€§ï¼šOT ç®—æ³•ç¡®ä¿æ“ä½œæŒ‰ç…§ç”¨æˆ·çœ‹åˆ°çš„é¡ºåºè¢«æ­£ç¡®æ‰§è¡Œï¼Œå³æ¯ä¸ªç”¨æˆ·çš„æ“ä½œåŸºäºæœ€æ–°çš„å†…å®¹çŠ¶æ€ã€‚

å…¶ä¸­ï¼Œæœ€é‡è¦çš„å°±æ˜¯ **è½¬åŒ–** æ­¥éª¤äº†ï¼Œç›¸å½“äºæœ‰ä¸€ä¸ªè´Ÿè´£äººç»Ÿä¸€æ”¶é›†å¤§å®¶çš„æ“ä½œï¼Œç„¶åæŒ‰ç…§è®¾å®šçš„è§„åˆ™å’Œä¿¡æ¯è¿›è¡Œæ’åºä¸åˆå¹¶ï¼Œæœ€ç»ˆç»™å¤§å®¶ä¸€ä¸ªç»Ÿä¸€çš„ç»“æœã€‚

ä¸¾ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œå‡è®¾åˆå§‹å†…å®¹æ˜¯ `"abc"`ï¼Œç”¨æˆ· A å’Œ B åŒæ—¶è¿›è¡Œç¼–è¾‘ï¼š

- ç”¨æˆ· A åœ¨ä½ç½® `1` æ’å…¥ `"x"`
- ç”¨æˆ· B åœ¨ä½ç½® `2` åˆ é™¤ `"b"`

å¦‚æœä¸ä½¿ç”¨ OT ç®—æ³•ï¼Œç»“æœæ˜¯ï¼š

1. ç”¨æˆ· A æ“ä½œåï¼Œå†…å®¹å˜ä¸º `"axbc"`
2. ç”¨æˆ· B æ“ä½œåï¼Œå†…å®¹å˜ä¸º `"ac"`

å¦‚æœç›´æ¥åº”ç”¨ B çš„æ“ä½œåˆ° A çš„ç»“æœï¼Œå¾—åˆ°çš„æ˜¯ `"ac"`ï¼Œå¯¹äº A æ¥è¯´ï¼Œç›¸å½“äºåˆ é™¤äº† `"b"`ï¼ŒA ä¼šæ„Ÿåˆ°ä¸€è„¸æ‡µé€¼ã€‚

å¦‚æœä½¿ç”¨ OT ç®—æ³•ï¼Œç»“æœæ˜¯ï¼š

1. ç”¨æˆ· A çš„æ“ä½œï¼Œåº”ç”¨åå†…å®¹ä¸º `"axbc"`
2. ç”¨æˆ· B çš„æ“ä½œç»è¿‡ OT è½¬åŒ–ä¸ºåˆ é™¤ `"b"` åœ¨ `"axbc"` ä¸­çš„æ–°ä½ç½®

æœ€ç»ˆç”¨æˆ· A å’Œ B çš„å†…å®¹éƒ½ä¸€è‡´ä¸º `"axc"`ï¼Œç¬¦åˆé¢„æœŸã€‚OT ç®—æ³•ç¡®ä¿æ— è®ºç”¨æˆ·ç¼–è¾‘çš„é¡ºåºå¦‚ä½•ï¼Œæœ€ç»ˆå†…å®¹æ˜¯ä¸€è‡´çš„ã€‚6vlRn/br/m8Ymr8D02hZYIBP3pqlW5Sp8qJklXCk9AY=

å½“ç„¶ï¼Œå…·ä½“çš„ OT ç®—æ³•è¿˜æ˜¯è¦æ ¹æ®éœ€æ±‚æ¥è®¾è®¡äº†ï¼Œåä½œå¯†åº¦è¶Šé«˜ï¼Œç®—æ³•è®¾è®¡éš¾åº¦è¶Šå¤§ã€‚

æ­¤å¤–ï¼Œè¿˜æœ‰ä¸€ç§ä¸ OT ç±»ä¼¼çš„ååŒç®—æ³• CRDTï¼ˆConflict-free Replicated Data Typeï¼‰ï¼Œå…¶é€šè¿‡æ•°å­¦æ¨¡å‹å®ç°æ— éœ€ä¸­å¿ƒåŒ–è½¬åŒ–çš„å†²çªè§£å†³ï¼Œåœ¨ç¦»çº¿åä½œåœºæ™¯ä¸­æ›´å…·ä¼˜åŠ¿ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥è‡ªè¡Œäº†è§£ã€‚

### æé«˜åä½œå®æ—¶æ€§

åœ¨å®æ—¶é€šè®¯çš„ä¸šåŠ¡åœºæ™¯ä¸­ï¼Œå¸¸ç”¨çš„æŠ€æœ¯æ–¹æ¡ˆåŒ…æ‹¬é•¿è½®è¯¢ã€SSE å’Œ WebSocketã€‚ç”±äºæˆ‘ä»¬çš„ä¸šåŠ¡éœ€æ±‚éœ€è¦å®ç°é¢‘ç¹ä¸”é«˜æ•ˆçš„åŒå‘é€šä¿¡ï¼Œå› æ­¤æˆ‘ä»¬é€‰ç”¨ WebSocket æ¥å®ç°å³æ—¶é€šè®¯ã€‚

#### 1ã€ä»€ä¹ˆæ˜¯ WebSocketï¼Ÿ

WebSocket æ˜¯ä¸€ç§ **å…¨åŒå·¥é€šä¿¡åè®®**ï¼Œè®©å®¢æˆ·ç«¯ï¼ˆæ¯”å¦‚æµè§ˆå™¨ï¼‰å’ŒæœåŠ¡å™¨ä¹‹é—´èƒ½å¤Ÿä¿æŒå®æ—¶ã€æŒç»­çš„è¿æ¥ã€‚å’Œä¼ ç»Ÿçš„ HTTP è¯·æ±‚-å“åº”æ¨¡å¼ä¸åŒï¼ŒWebSocket æ˜¯ä¸€æ¡**â€œå¸¸å¼€çš„éš§é“â€**ï¼Œè¿æ¥çš„åŒæ–¹å¯ä»¥éšæ—¶å‘é€å’Œæ¥æ”¶æ•°æ®ï¼Œè€Œä¸éœ€è¦ä¸æ–­å»ºç«‹å’Œå…³é—­è¿æ¥ã€‚

æ‰“ä¸ªæ¯”æ–¹ï¼š

- HTTP å°±åƒç‚¹å¤–å–ï¼š æ¯æ¬¡ä¸‹å•ï¼ˆè¯·æ±‚ï¼‰- åˆ°è´§ï¼ˆå“åº”ï¼‰éƒ½æ˜¯ä¸€æ¬¡ç‹¬ç«‹çš„æ“ä½œï¼Œå®Œæˆåè¿æ¥å…³é—­ã€‚
- WebSocket åƒæ˜¯æ‰“ç”µè¯ï¼šä½ æ‰“é€šäº†ç”µè¯ï¼ˆå»ºç«‹è¿æ¥ï¼‰ï¼Œå¯ä»¥éšæ—¶èŠå¤©ï¼ˆåŒå‘é€šä¿¡ï¼‰ï¼Œç›´åˆ°æŒ‚æ–­ï¼ˆå…³é—­è¿æ¥ï¼‰ã€‚

![img](assets/4zrZHpvfpdM3jxNM.jpg)

#### 2ã€WebSocket çš„åº”ç”¨åœºæ™¯

WebSocket çš„ä¸»è¦ä½œç”¨æ˜¯ **å®ç°å®æ—¶æ•°æ®ä¼ è¾“**ï¼Œé€‚ç”¨äºéœ€è¦é¢‘ç¹äº¤äº’æˆ–è€…å®æ—¶æ›´æ–°æ•°æ®çš„åœºæ™¯ã€‚æ¯”å¦‚ï¼š

- å³æ—¶é€šè®¯ï¼ˆèŠå¤©è½¯ä»¶ã€å®æ—¶åä½œå·¥å…·ï¼‰
- å®æ—¶æ•°æ®æ›´æ–°ï¼ˆè‚¡ç¥¨è¡Œæƒ…ã€ä½“è‚²æ¯”èµ›æ¯”åˆ†ï¼‰
- åœ¨çº¿æ¸¸æˆï¼ˆå¤šäººå®æ—¶äº’åŠ¨ï¼‰
- ç‰©è”ç½‘ï¼ˆè®¾å¤‡çŠ¶æ€å®æ—¶ä¼ è¾“ï¼‰
- ååŒç¼–è¾‘ï¼ˆåƒè¯­é›€è¿™æ ·çš„å¤šäººåä½œç¼–è¾‘ï¼‰

é€šè¿‡ WebSocketï¼Œå®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ä¹‹é—´èƒ½å¤Ÿæ˜¾è‘—å‡å°‘æ¶ˆæ¯ä¼ è¾“çš„å»¶è¿Ÿï¼Œæé«˜é€šä¿¡æ•ˆç‡ï¼ŒåŒæ—¶é™ä½æ•°æ®ä¼ è¾“çš„å¼€é”€ã€‚

#### 3ã€WebSocket å’Œ HTTP çš„å…³ç³»

WebSocket å’Œ HTTP æ˜¯ä¸¤ç§ä¸åŒçš„é€šä¿¡åè®®ï¼Œä½†å®ƒä»¬æ˜¯ç´§å¯†ç›¸å…³çš„ï¼Œéƒ½æ˜¯åŸºäº TCP åè®®ã€éƒ½å¯ä»¥åœ¨åŒæ ·çš„ç«¯å£ä¸Šå·¥ä½œï¼ˆæ¯”å¦‚ 80 å’Œ 443ï¼‰ã€‚

**é¦–å…ˆè¦æ˜ç¡®ï¼ŒWebSocket æ˜¯å»ºç«‹åœ¨ HTTP åŸºç¡€ä¹‹ä¸Šçš„ï¼**WebSocket çš„è¿æ¥éœ€è¦é€šè¿‡ HTTP åè®®å‘èµ·ä¸€ä¸ªæ¡æ‰‹ï¼ˆç§°ä¸º HTTP Upgrade è¯·æ±‚ï¼‰ï¼Œè¿™ä¸ªæ¡æ‰‹è¯·æ±‚æ˜¯ WebSocket å»ºç«‹è¿æ¥çš„å‰æï¼Œè¡¨æ˜å¸Œæœ›åˆ‡æ¢åè®®ï¼›æœåŠ¡å™¨å¦‚æœæ”¯æŒ WebSocketï¼Œä¼šè¿”å›ä¸€ä¸ª HTTP 101 çŠ¶æ€ç ï¼Œè¡¨ç¤ºåè®®åˆ‡æ¢æˆåŠŸã€‚

æ¡æ‰‹å®Œæˆåï¼ŒHTTP åè®®çš„ä½œç”¨ç»“æŸï¼Œé€šä¿¡ä¼šåˆ‡æ¢ä¸º WebSocket åè®®ï¼ŒåŒæ–¹å¯ä»¥å¼€å§‹å…¨åŒå·¥é€šä¿¡ã€‚

äºŒè€…çš„åŒºåˆ«å¦‚ä¸‹ï¼Œå¤§å®¶äº†è§£ä¸€ä¸‹å°±å¥½ï¼š

| å¯¹æ¯”é¡¹       | HTTP                               | WebSocketc                         |
| ------------ | ---------------------------------- | ---------------------------------- |
| é€šä¿¡æ¨¡å¼     | è¯·æ±‚-å“åº”ï¼ˆå•å‘ï¼‰                  | å…¨åŒå·¥é€šä¿¡ï¼ˆåŒå‘ï¼‰                 |
| è¿æ¥çŠ¶æ€     | æ¯æ¬¡è¯·æ±‚åˆ›å»ºæ–°çš„è¿æ¥               | æ¡æ‰‹åä¿æŒæŒç»­è¿æ¥                 |
| æ•°æ®ä¼ è¾“æ•ˆç‡ | æ¯æ¬¡é€šä¿¡éƒ½éœ€è¦å¸¦å®Œæ•´å¤´éƒ¨ï¼Œå¼€é”€å¤§   | æ•°æ®å¸§å°ï¼Œä¼ è¾“é«˜æ•ˆ                 |
| é€‚ç”¨åœºæ™¯     | é™æ€ç½‘é¡µåŠ è½½ã€API è°ƒç”¨ç­‰éå®æ—¶åœºæ™¯ | å®æ—¶äº¤äº’åœºæ™¯ï¼Œå¦‚èŠå¤©ã€æ¸¸æˆã€ç›´æ’­ç­‰ |

#### 4ã€WebSocket åä½œç¼–è¾‘çš„æµç¨‹

é€šè¿‡ WebSocket å®æ—¶é€šä¿¡çš„èƒ½åŠ›ï¼Œå¯ä»¥å°†ç”¨æˆ·çš„ç¼–è¾‘æ“ä½œå‘ç»™ WebSocket æœåŠ¡å™¨ï¼Œå†ç”±æœåŠ¡å™¨è½¬å‘ç»™å…¶ä»–è¿æ¥æœåŠ¡å™¨çš„ç”¨æˆ·å‰ç«¯ï¼Œå‰ç«¯å°±å¯ä»¥æ ¹æ®æ“ä½œå¤„ç†å›¾ç‰‡ã€‚

![img](assets/08WH9YXWWy7bv0JX.webp)

å…·ä½“çš„ä¸šåŠ¡æµç¨‹ï¼š

1. å»ºç«‹è¿æ¥ä¹‹å‰ï¼Œå…ˆè¿›è¡Œç”¨æˆ·æƒé™æ ¡éªŒï¼›æ ¡éªŒé€šè¿‡åï¼Œå°†ç™»å½•ç”¨æˆ·ä¿¡æ¯ã€è¦ç¼–è¾‘çš„å›¾ç‰‡ä¿¡æ¯ä¿å­˜åˆ°è¦å»ºç«‹çš„ WebSocket è¿æ¥çš„ä¼šè¯å±æ€§ä¸­ã€‚
2. å»ºç«‹è¿æ¥æˆåŠŸåï¼Œå°† WebSocket ä¼šè¯ä¿å­˜åˆ°è¯¥å›¾ç‰‡å¯¹åº”çš„ä¼šè¯é›†åˆä¸­ï¼Œä¾¿äºåç»­åˆ†å‘æ¶ˆæ¯ç»™å…¶ä»–ä¼šè¯ã€‚
3. å‰ç«¯å°†æ¶ˆæ¯å‘é€åˆ°åç«¯ï¼Œåç«¯æ ¹æ®æ¶ˆæ¯ç±»å‹åˆ†å‘åˆ°å¯¹åº”çš„å¤„ç†å™¨ã€‚
4. å¤„ç†å™¨å¤„ç†æ¶ˆæ¯ï¼Œå°†å¤„ç†ç»“æœä½œä¸ºæ¶ˆæ¯å‘é€ç»™éœ€è¦çš„ WebSocket å®¢æˆ·ç«¯ã€‚
5. å½“å‰ç«¯æ–­å¼€è¿æ¥æ—¶ï¼Œåˆ é™¤ä¼šè¯é›†åˆä¸­çš„ WebSocket ä¼šè¯ï¼Œé‡Šæ”¾èµ„æºã€‚

![image.png](assets/M8iUYPO4muRGwKBt.webp)

å’Œ HTTP è¯·æ±‚ä¸€æ ·ï¼Œå‰ç«¯å’Œ WebSocket æœåŠ¡å™¨ä¹‹é—´ä¼ è¾“ä¿¡æ¯æ—¶ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ JSON æ ¼å¼å¯¹æ•°æ®è¿›è¡Œåºåˆ—åŒ–ã€‚

#### 5ã€WebSocket çš„å®ç°æ–¹å¼

å¯¹äº Java Spring é¡¹ç›®ï¼Œä¸»è¦æœ‰åŸç”Ÿ WebSocketï¼ˆåŸºäº`WebSocketHandler` å®ç°ï¼‰ã€STOMPã€WebFlux è¿™ 3 ç§å®ç°æ–¹å¼ã€‚

å®ƒä»¬ä¹‹é—´çš„å¯¹æ¯”å¦‚ä¸‹ï¼š

| å®ç°æ–¹å¼                     | ç‰¹ç‚¹                          | ä¼˜ç‚¹                             | ç¼ºç‚¹                                 | é€‚ç”¨åœºæ™¯                       |
| ---------------------------- | ----------------------------- | -------------------------------- | ------------------------------------ | ------------------------------ |
| åŸç”Ÿ WebSocket               | ä½å±‚ APIï¼Œæ‰‹åŠ¨ç®¡ç†è¿æ¥ä¸æ¶ˆæ¯  | è½»é‡ã€çµæ´»ã€é€‚ç”¨äºç®€å•ç‚¹å¯¹ç‚¹é€šä¿¡ | éœ€è¦æ‰‹åŠ¨ç®¡ç†ä¼šè¯å’Œåˆ†å‘ï¼Œä¸æ”¯æŒ STOMP | ç®€å•çš„å®æ—¶æ¨é€ï¼Œä½å¹¶å‘åœºæ™¯     |
| WebSocket + STOMP + SockJS   | åŸºäº STOMPï¼Œæ”¯æŒå‘å¸ƒ/è®¢é˜…æ¨¡å¼ | æ”¯æŒ STOMPã€æ¶ˆæ¯ä»£ç†ã€é€‚é…       | ä¾èµ–å¤–éƒ¨ä»£ç†ï¼Œé…ç½®è¾ƒå¤æ‚             | èŠå¤©å®¤ã€å¤šäººåä½œï¼Œé«˜çº§å®æ—¶åº”ç”¨ |
| WebFlux + Reactive WebSocket | åŸºäº WebFlux çš„å“åº”å¼å®ç°     | é«˜å¹¶å‘ã€éé˜»å¡ã€é€‚ç”¨äºå¤§æµé‡åœºæ™¯ | å­¦ä¹ æ›²çº¿é«˜ï¼Œä¸æ”¯æŒ STOMP             | é«˜å¹¶å‘åœºæ™¯ã€å¤§æ•°æ®æµæ¨é€       |

é±¼çš®çš„é€‰æ‹©å»ºè®®æ˜¯ï¼šå¯¹äºå¤§å¤šæ•°ç®€å•å®æ—¶æ¨é€ï¼Œé€‰ç”¨åŸç”Ÿ WebSocketï¼›å¯¹äºå¤æ‚çš„èŠå¤©å®¤å’ŒååŒç³»ç»Ÿï¼Œé€‰ç”¨ WebSocket + STOMP + SockJSï¼›å¯¹äºé«˜å¹¶å‘ã€ä½å»¶è¿Ÿæ•°æ®æµæ¨é€ï¼Œé€‰ç”¨ WebFlux + Reactive WebSocketã€‚

å¯¹äºæˆ‘ä»¬çš„é¡¹ç›®ï¼Œå¹¶å‘è¦æ±‚ä¸é«˜ï¼Œé€‰æ‹© Spring åŸç”Ÿçš„ WebSocket æ¥é™ä½å¼€å‘æˆæœ¬ã€‚

æ˜ç¡®æ–¹æ¡ˆåï¼Œæˆ‘ä»¬è¿›å…¥åç«¯å¼€å‘ã€‚=

## ä¸‰ã€åç«¯å¼€å‘

### 1ã€å¼•å…¥ WebSocket ä¾èµ–

å¼•å…¥ä¾èµ–ï¼š

```xml
<!-- websocket -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-websocket</artifactId>
</dependency>
```

æ–°å»º `manager.websocket` åŒ…ï¼Œæ‰€æœ‰å’Œ WebSocket ç›¸å…³çš„ä»£ç éƒ½æ”¾åˆ°è¯¥åŒ…ä¸‹ã€‚

### 2ã€å®šä¹‰æ•°æ®æ¨¡å‹

æ–°å»º `websocket.model` åŒ…ï¼Œå­˜æ”¾æ•°æ®æ¨¡å‹ï¼ŒåŒ…æ‹¬è¯·æ±‚ç±»ã€å“åº”ç±»ã€æšä¸¾ç±»ã€‚

1ï¼‰å®šä¹‰å›¾ç‰‡ç¼–è¾‘è¯·æ±‚æ¶ˆæ¯ï¼Œä¹Ÿå°±æ˜¯å‰ç«¯è¦å‘é€ç»™åç«¯çš„å‚æ•°ï¼š

```java
@Data
@NoArgsConstructor
@AllArgsConstructor
public class PictureEditRequestMessage {

    /**
     * æ¶ˆæ¯ç±»å‹ï¼Œä¾‹å¦‚ "ENTER_EDIT", "EXIT_EDIT", "EDIT_ACTION"
     */
    private String type;

    /**
     * æ‰§è¡Œçš„ç¼–è¾‘åŠ¨ä½œ
     */
    private String editAction;
}
```

2ï¼‰å®šä¹‰å›¾ç‰‡ç¼–è¾‘å“åº”æ¶ˆæ¯ï¼Œä¹Ÿå°±æ˜¯åç«¯è¦å‘é€ç»™å‰ç«¯çš„ä¿¡æ¯ï¼š

```java
@Data
@NoArgsConstructor
@AllArgsConstructor
public class PictureEditResponseMessage {

    /**
     * æ¶ˆæ¯ç±»å‹ï¼Œä¾‹å¦‚ "INFO", "ERROR", "ENTER_EDIT", "EXIT_EDIT", "EDIT_ACTION"
     */
    private String type;

    /**
     * ä¿¡æ¯
     */
    private String message;

    /**
     * æ‰§è¡Œçš„ç¼–è¾‘åŠ¨ä½œ
     */
    private String editAction;

    /**
     * ç”¨æˆ·ä¿¡æ¯
     */
    private UserVO user;
}
```

3ï¼‰å®šä¹‰å›¾ç‰‡ç¼–è¾‘æ¶ˆæ¯ç±»å‹æšä¸¾ï¼Œä¾¿äºåç»­æ ¹æ®æ¶ˆæ¯ç±»å‹è¿›è¡Œç›¸åº”çš„å¤„ç†ï¼š6oQFIoMC2vFqWS6BDNDfWm34cANQaqyg4rGukImfAHk=

```java
@Getter
public enum PictureEditMessageTypeEnum {

    INFO("å‘é€é€šçŸ¥", "INFO"),
    ERROR("å‘é€é”™è¯¯", "ERROR"),
    ENTER_EDIT("è¿›å…¥ç¼–è¾‘çŠ¶æ€", "ENTER_EDIT"),
    EXIT_EDIT("é€€å‡ºç¼–è¾‘çŠ¶æ€", "EXIT_EDIT"),
    EDIT_ACTION("æ‰§è¡Œç¼–è¾‘æ“ä½œ", "EDIT_ACTION");

    private final String text;
    private final String value;

    PictureEditMessageTypeEnum(String text, String value) {
        this.text = text;
        this.value = value;
    }

    /**
     * æ ¹æ® value è·å–æšä¸¾
     */
    public static PictureEditMessageTypeEnum getEnumByValue(String value) {
        if (value == null || value.isEmpty()) {
            return null;
        }
        for (PictureEditMessageTypeEnum typeEnum : PictureEditMessageTypeEnum.values()) {
            if (typeEnum.value.equals(value)) {
                return typeEnum;
            }
        }
        return null;
    }
}
```

4ï¼‰å®šä¹‰å›¾ç‰‡ç¼–è¾‘æ“ä½œç±»å‹æšä¸¾ï¼š

```java
@Getter
public enum PictureEditActionEnum {

    ZOOM_IN("æ”¾å¤§æ“ä½œ", "ZOOM_IN"),
    ZOOM_OUT("ç¼©å°æ“ä½œ", "ZOOM_OUT"),
    ROTATE_LEFT("å·¦æ—‹æ“ä½œ", "ROTATE_LEFT"),
    ROTATE_RIGHT("å³æ—‹æ“ä½œ", "ROTATE_RIGHT");

    private final String text;
    private final String value;

    PictureEditActionEnum(String text, String value) {
        this.text = text;
        this.value = value;
    }

    /**
     * æ ¹æ® value è·å–æšä¸¾
     */
    public static PictureEditActionEnum getEnumByValue(String value) {
        if (value == null || value.isEmpty()) {
            return null;
        }
        for (PictureEditActionEnum actionEnum : PictureEditActionEnum.values()) {
            if (actionEnum.value.equals(value)) {
                return actionEnum;
            }
        }
        return null;
    }
}
```

### 3ã€WebSocket æ‹¦æˆªå™¨ - æƒé™æ ¡éªŒ

åœ¨ WebSocket è¿æ¥å‰éœ€è¦è¿›è¡Œæƒé™æ ¡éªŒï¼Œå¦‚æœå‘ç°ç”¨æˆ·æ²¡æœ‰å›¢é˜Ÿç©ºé—´å†…ç¼–è¾‘å›¾ç‰‡çš„æƒé™ï¼Œåˆ™æ‹’ç»æ¡æ‰‹ï¼Œå¯ä»¥é€šè¿‡å®šä¹‰ä¸€ä¸ª WebSocket æ‹¦æˆªå™¨å®ç°è¿™ä¸ªèƒ½åŠ›ã€‚

æ­¤å¤–ï¼Œç”±äº HTTP å’Œ WebSocket çš„åŒºåˆ«ï¼Œæˆ‘ä»¬ä¸èƒ½åœ¨åç»­æ”¶åˆ°å‰ç«¯æ¶ˆæ¯æ—¶ç›´æ¥ä» request å¯¹è±¡ä¸­è·å–åˆ°ç™»å½•ç”¨æˆ·ä¿¡æ¯ï¼Œå› æ­¤ä¹Ÿéœ€è¦é€šè¿‡ WebSocket æ‹¦æˆªå™¨ï¼Œä¸ºå³å°†å»ºç«‹è¿æ¥çš„ WebSocket ä¼šè¯æŒ‡å®šä¸€äº›å±æ€§ï¼Œæ¯”å¦‚ç™»å½•ç”¨æˆ·ä¿¡æ¯ã€ç¼–è¾‘çš„å›¾ç‰‡ id ç­‰ã€‚

ç¼–å†™æ‹¦æˆªå™¨çš„ä»£ç ï¼Œéœ€è¦å®ç° `HandshakeInterceptor` æ¥å£ï¼š

```java
@Component
@Slf4j
public class WsHandshakeInterceptor implements HandshakeInterceptor {

    @Resource
    private UserService userService;

    @Resource
    private PictureService pictureService;

    @Resource
    private SpaceService spaceService;

    @Resource
    private SpaceUserAuthManager spaceUserAuthManager;

    @Override
    public boolean beforeHandshake(@NotNull ServerHttpRequest request, @NotNull ServerHttpResponse response, @NotNull WebSocketHandler wsHandler, @NotNull Map<String, Object> attributes) {
        if (request instanceof ServletServerHttpRequest) {
            HttpServletRequest servletRequest = ((ServletServerHttpRequest) request).getServletRequest();
            // è·å–è¯·æ±‚å‚æ•°
            String pictureId = servletRequest.getParameter("pictureId");
            if (StrUtil.isBlank(pictureId)) {
                log.error("ç¼ºå°‘å›¾ç‰‡å‚æ•°ï¼Œæ‹’ç»æ¡æ‰‹");
                return false;
            }
            User loginUser = userService.getLoginUser(servletRequest);
            if (ObjUtil.isEmpty(loginUser)) {
                log.error("ç”¨æˆ·æœªç™»å½•ï¼Œæ‹’ç»æ¡æ‰‹");
                return false;
            }
            // æ ¡éªŒç”¨æˆ·æ˜¯å¦æœ‰è¯¥å›¾ç‰‡çš„æƒé™
            Picture picture = pictureService.getById(pictureId);
            if (picture == null) {
                log.error("å›¾ç‰‡ä¸å­˜åœ¨ï¼Œæ‹’ç»æ¡æ‰‹");
                return false;
            }
            Long spaceId = picture.getSpaceId();
            Space space = null;
            if (spaceId != null) {
                space = spaceService.getById(spaceId);
                if (space == null) {
                    log.error("ç©ºé—´ä¸å­˜åœ¨ï¼Œæ‹’ç»æ¡æ‰‹");
                    return false;
                }
                if (space.getSpaceType() != SpaceTypeEnum.TEAM.getValue()) {
                    log.info("ä¸æ˜¯å›¢é˜Ÿç©ºé—´ï¼Œæ‹’ç»æ¡æ‰‹");
                    return false;
                }
            }
            List<String> permissionList = spaceUserAuthManager.getPermissionList(space, loginUser);
            if (!permissionList.contains(SpaceUserPermissionConstant.PICTURE_EDIT)) {
                log.error("æ²¡æœ‰å›¾ç‰‡ç¼–è¾‘æƒé™ï¼Œæ‹’ç»æ¡æ‰‹");
                return false;
            }
            // è®¾ç½® attributes
            attributes.put("user", loginUser);
            attributes.put("userId", loginUser.getId());
            attributes.put("pictureId", Long.valueOf(pictureId)); // è®°å¾—è½¬æ¢ä¸º Long ç±»å‹
        }
        return true;
    }

    @Override
    public void afterHandshake(@NotNull ServerHttpRequest request, @NotNull ServerHttpResponse response, @NotNull WebSocketHandler wsHandler, Exception exception) {
    }
}
```

### 4ã€WebSocket å¤„ç†å™¨

æˆ‘ä»¬éœ€è¦å®šä¹‰ WebSocket å¤„ç†å™¨ç±»ï¼Œåœ¨è¿æ¥æˆåŠŸã€è¿æ¥å…³é—­ã€æ¥æ”¶åˆ°å®¢æˆ·ç«¯æ¶ˆæ¯æ—¶è¿›è¡Œç›¸åº”çš„å¤„ç†ã€‚

å¯ä»¥å®ç° TextWebSocketHandler æ¥å£ï¼Œè¿™æ ·å°±èƒ½ä»¥å­—ç¬¦ä¸²çš„æ–¹å¼å‘é€å’Œæ¥å—æ¶ˆæ¯äº†ï¼š

```java
@Component
public class PictureEditHandler extends TextWebSocketHandler {
}
```

1ï¼‰é¦–å…ˆåœ¨å¤„ç†å™¨ç±»ä¸­å®šä¹‰ 2 ä¸ªå¸¸é‡ï¼Œåˆ†åˆ«ä¸ºï¼š

- ä¿å­˜å½“å‰æ­£åœ¨ç¼–è¾‘çš„ç”¨æˆ· idï¼Œæ‰§è¡Œç¼–è¾‘æ“ä½œã€è¿›å…¥æˆ–é€€å‡ºç¼–è¾‘æ—¶éƒ½ä¼šæ ¡éªŒã€‚
- ä¿å­˜å‚ä¸ç¼–è¾‘å›¾ç‰‡çš„ç”¨æˆ· WebSocket ä¼šè¯çš„é›†åˆã€‚

ç”±äºæ¯ä¸ªå›¾ç‰‡çš„åä½œç¼–è¾‘éƒ½æ˜¯ç›¸äº’ç‹¬ç«‹çš„ï¼Œæ‰€ä»¥éœ€è¦ç”¨ Map æ¥åŒºåˆ†æ¯ä¸ªå›¾ç‰‡ id å¯¹åº”çš„æ•°æ®ã€‚ä»£ç å¦‚ä¸‹ï¼š

```java
// æ¯å¼ å›¾ç‰‡çš„ç¼–è¾‘çŠ¶æ€ï¼Œkey: pictureId, value: å½“å‰æ­£åœ¨ç¼–è¾‘çš„ç”¨æˆ· ID
private final Map<Long, Long> pictureEditingUsers = new ConcurrentHashMap<>();

// ä¿å­˜æ‰€æœ‰è¿æ¥çš„ä¼šè¯ï¼Œkey: pictureId, value: ç”¨æˆ·ä¼šè¯é›†åˆ
private final Map<Long, Set<WebSocketSession>> pictureSessions = new ConcurrentHashMap<>();
```

æ³¨æ„ï¼Œç”±äºå¯èƒ½åŒæ—¶æœ‰å¤šä¸ª WebSocket å®¢æˆ·ç«¯å»ºç«‹è¿æ¥å’Œå‘é€æ¶ˆæ¯ï¼Œé›†åˆè¦ä½¿ç”¨å¹¶å‘åŒ…ï¼ˆJUCï¼‰ä¸­çš„ `ConcurrentHashMap`ï¼Œæ¥ä¿è¯çº¿ç¨‹å®‰å…¨ã€‚

2ï¼‰ç”±äºæ¥ä¸‹æ¥å¾ˆå¤šæ¶ˆæ¯éƒ½éœ€è¦ä¼ é€’ç»™æ‰€æœ‰åä½œè€…ï¼Œæ‰€ä»¥å…ˆç¼–å†™ä¸€ä¸ª **å¹¿æ’­æ¶ˆæ¯** çš„æ–¹æ³•ã€‚è¯¥æ–¹æ³•ä¼šæ ¹æ® pictureIdï¼Œå°†å“åº”æ¶ˆæ¯å‘é€ç»™ç¼–è¾‘è¯¥å›¾ç‰‡çš„æ‰€æœ‰ä¼šè¯ã€‚è€ƒè™‘åˆ°å¯èƒ½ä¼šæœ‰æ¶ˆæ¯ä¸éœ€è¦å‘é€ç»™ç¼–è¾‘è€…æœ¬äººçš„æƒ…å†µï¼Œè¯¥æ–¹æ³•è¿˜å¯ä»¥æ¥å— excludeSession å‚æ•°ï¼Œæ”¯æŒæ’é™¤æ‰å‘æŸä¸ªä¼šè¯å‘é€æ¶ˆæ¯ã€‚

ä»£ç å¦‚ä¸‹ï¼š

```java
private void broadcastToPicture(Long pictureId, PictureEditResponseMessage pictureEditResponseMessage, WebSocketSession excludeSession) throws Exception {
    Set<WebSocketSession> sessionSet = pictureSessions.get(pictureId);
    if (CollUtil.isNotEmpty(sessionSet)) {
        // åˆ›å»º ObjectMapper
        ObjectMapper objectMapper = new ObjectMapper();
        // é…ç½®åºåˆ—åŒ–ï¼šå°† Long ç±»å‹è½¬ä¸º Stringï¼Œè§£å†³ä¸¢å¤±ç²¾åº¦é—®é¢˜
        SimpleModule module = new SimpleModule();
        module.addSerializer(Long.class, ToStringSerializer.instance);
        module.addSerializer(Long.TYPE, ToStringSerializer.instance); // æ”¯æŒ long åŸºæœ¬ç±»å‹
        objectMapper.registerModule(module);
        // åºåˆ—åŒ–ä¸º JSON å­—ç¬¦ä¸²
        String message = objectMapper.writeValueAsString(pictureEditResponseMessage);
        TextMessage textMessage = new TextMessage(message);
        for (WebSocketSession session : sessionSet) {
            // æ’é™¤æ‰çš„ session ä¸å‘é€
            if (excludeSession != null && excludeSession.equals(session)) {
                continue;
            }
            if (session.isOpen()) {
                session.sendMessage(textMessage);
            }
        }
    }
}
```

ä¸Šè¿°ä»£ç ä¸­æœ‰ä¸ªå°ç»†èŠ‚ï¼Œç”±äºå‰ç«¯ JS çš„é•¿æ•´æ•°å¯èƒ½ä¼šä¸¢å¤±ç²¾åº¦ï¼Œæ‰€ä»¥ä½¿ç”¨ Jackson è‡ªå®šä¹‰åºåˆ—åŒ–å™¨ï¼Œåœ¨å°†å¯¹è±¡è½¬æ¢ä¸º JSON å­—ç¬¦ä¸²æ—¶ï¼Œå°† Long ç±»å‹è½¬æ¢ä¸º String ç±»å‹ã€‚

å†ç¼–å†™ä¸€ä¸ªä¸æ’é™¤ Sessionï¼Œç»™æ‰€æœ‰ä¼šè¯å¹¿æ’­çš„æ–¹æ³•ï¼š

```java
// å…¨éƒ¨å¹¿æ’­
private void broadcastToPicture(Long pictureId, PictureEditResponseMessage pictureEditResponseMessage) throws Exception {
    broadcastToPicture(pictureId, pictureEditResponseMessage, null);
}
```

3ï¼‰å®ç°è¿æ¥å»ºç«‹æˆåŠŸåæ‰§è¡Œçš„æ–¹æ³•ï¼Œä¿å­˜ä¼šè¯åˆ°é›†åˆä¸­ï¼Œå¹¶ä¸”ç»™å…¶ä»–ä¼šè¯å‘é€æ¶ˆæ¯ï¼š

```java
@Override
public void afterConnectionEstablished(WebSocketSession session) throws Exception {
    // ä¿å­˜ä¼šè¯åˆ°é›†åˆä¸­
    User user = (User) session.getAttributes().get("user");
    Long pictureId = (Long) session.getAttributes().get("pictureId");
    pictureSessions.putIfAbsent(pictureId, ConcurrentHashMap.newKeySet());
    pictureSessions.get(pictureId).add(session);

    // æ„é€ å“åº”
    PictureEditResponseMessage pictureEditResponseMessage = new PictureEditResponseMessage();
    pictureEditResponseMessage.setType(PictureEditMessageTypeEnum.INFO.getValue());
    String message = String.format("%såŠ å…¥ç¼–è¾‘", user.getUserName());
    pictureEditResponseMessage.setMessage(message);
    pictureEditResponseMessage.setUser(userService.getUserVO(user));
    // å¹¿æ’­ç»™åŒä¸€å¼ å›¾ç‰‡çš„ç”¨æˆ·
    broadcastToPicture(pictureId, pictureEditResponseMessage);
}
```

4ï¼‰ç¼–å†™æ¥æ”¶å®¢æˆ·ç«¯æ¶ˆæ¯çš„æ–¹æ³•ï¼Œæ ¹æ®æ¶ˆæ¯ç±»åˆ«æ‰§è¡Œä¸åŒçš„å¤„ç†ï¼š

```java
@Override
protected void handleTextMessage(WebSocketSession session, TextMessage message) throws Exception {
    // å°†æ¶ˆæ¯è§£æä¸º PictureEditMessage
    PictureEditRequestMessage pictureEditRequestMessage = JSONUtil.toBean(message.getPayload(), PictureEditRequestMessage.class);
    String type = pictureEditRequestMessage.getType();
    PictureEditMessageTypeEnum pictureEditMessageTypeEnum = PictureEditMessageTypeEnum.valueOf(type);

    // ä» Session å±æ€§ä¸­è·å–å…¬å…±å‚æ•°
    Map<String, Object> attributes = session.getAttributes();
    User user = (User) attributes.get("user");
    Long pictureId = (Long) attributes.get("pictureId");

    // è°ƒç”¨å¯¹åº”çš„æ¶ˆæ¯å¤„ç†æ–¹æ³•
    switch (pictureEditMessageTypeEnum) {
        case ENTER_EDIT:
            handleEnterEditMessage(pictureEditRequestMessage, session, user, pictureId);
            break;
        case EDIT_ACTION:
            handleEditActionMessage(pictureEditRequestMessage, session, user, pictureId);
            break;
        case EXIT_EDIT:
            handleExitEditMessage(pictureEditRequestMessage, session, user, pictureId);
            break;
        default:
            PictureEditResponseMessage pictureEditResponseMessage = new PictureEditResponseMessage();
            pictureEditResponseMessage.setType(PictureEditMessageTypeEnum.ERROR.getValue());
            pictureEditResponseMessage.setMessage("æ¶ˆæ¯ç±»å‹é”™è¯¯");
            pictureEditResponseMessage.setUser(userService.getUserVO(user));
            session.sendMessage(new TextMessage(JSONUtil.toJsonStr(pictureEditResponseMessage)));
    }
}
```

æ¥ä¸‹æ¥ä¾æ¬¡ç¼–å†™æ¯ä¸ªå¤„ç†æ¶ˆæ¯çš„æ–¹æ³•ã€‚é¦–å…ˆæ˜¯ç”¨æˆ·è¿›å…¥ç¼–è¾‘çŠ¶æ€ï¼Œè¦è®¾ç½®å½“å‰ç”¨æˆ·ä¸ºç¼–è¾‘ç”¨æˆ·ï¼Œå¹¶ä¸”å‘å…¶ä»–å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯ï¼š

```java
public void handleEnterEditMessage(PictureEditRequestMessage pictureEditRequestMessage, WebSocketSession session, User user, Long pictureId) throws Exception {
    // æ²¡æœ‰ç”¨æˆ·æ­£åœ¨ç¼–è¾‘è¯¥å›¾ç‰‡ï¼Œæ‰èƒ½è¿›å…¥ç¼–è¾‘
    if (!pictureEditingUsers.containsKey(pictureId)) {
        // è®¾ç½®å½“å‰ç”¨æˆ·ä¸ºç¼–è¾‘ç”¨æˆ·
        pictureEditingUsers.put(pictureId, user.getId());
        PictureEditResponseMessage pictureEditResponseMessage = new PictureEditResponseMessage();
        pictureEditResponseMessage.setType(PictureEditMessageTypeEnum.ENTER_EDIT.getValue());
        String message = String.format("%så¼€å§‹ç¼–è¾‘å›¾ç‰‡", user.getUserName());
        pictureEditResponseMessage.setMessage(message);
        pictureEditResponseMessage.setUser(userService.getUserVO(user));
        broadcastToPicture(pictureId, pictureEditResponseMessage);
    }
}
```

ç”¨æˆ·æ‰§è¡Œç¼–è¾‘æ“ä½œæ—¶ï¼Œå°†è¯¥æ“ä½œåŒæ­¥ç»™ **é™¤äº†å½“å‰ç”¨æˆ·ä¹‹å¤–** çš„å…¶ä»–å®¢æˆ·ç«¯ï¼Œä¹Ÿå°±æ˜¯è¯´ç¼–è¾‘æ“ä½œä¸ç”¨å†åŒæ­¥ç»™è‡ªå·±ï¼š

```java
public void handleEditActionMessage(PictureEditRequestMessage pictureEditRequestMessage, WebSocketSession session, User user, Long pictureId) throws Exception {
    Long editingUserId = pictureEditingUsers.get(pictureId);
    String editAction = pictureEditRequestMessage.getEditAction();
    PictureEditActionEnum actionEnum = PictureEditActionEnum.getEnumByValue(editAction);
    if (actionEnum == null) {
        return;
    }
    // ç¡®è®¤æ˜¯å½“å‰ç¼–è¾‘è€…
    if (editingUserId != null && editingUserId.equals(user.getId())) {
        PictureEditResponseMessage pictureEditResponseMessage = new PictureEditResponseMessage();
        pictureEditResponseMessage.setType(PictureEditMessageTypeEnum.EDIT_ACTION.getValue());
        String message = String.format("%sæ‰§è¡Œ%s", user.getUserName(), actionEnum.getText());
        pictureEditResponseMessage.setMessage(message);
        pictureEditResponseMessage.setEditAction(editAction);
        pictureEditResponseMessage.setUser(userService.getUserVO(user));
        // å¹¿æ’­ç»™é™¤äº†å½“å‰å®¢æˆ·ç«¯ä¹‹å¤–çš„å…¶ä»–ç”¨æˆ·ï¼Œå¦åˆ™ä¼šé€ æˆé‡å¤ç¼–è¾‘
        broadcastToPicture(pictureId, pictureEditResponseMessage, session);
    }
}
```

ç”¨æˆ·é€€å‡ºç¼–è¾‘æ“ä½œæ—¶ï¼Œç§»é™¤å½“å‰ç”¨æˆ·çš„ç¼–è¾‘çŠ¶æ€ï¼Œå¹¶ä¸”å‘å…¶ä»–å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯ï¼š

```java
public void handleExitEditMessage(PictureEditRequestMessage pictureEditRequestMessage, WebSocketSession session, User user, Long pictureId) throws Exception {
    Long editingUserId = pictureEditingUsers.get(pictureId);
    if (editingUserId != null && editingUserId.equals(user.getId())) {
        // ç§»é™¤å½“å‰ç”¨æˆ·çš„ç¼–è¾‘çŠ¶æ€
        pictureEditingUsers.remove(pictureId);
        // æ„é€ å“åº”ï¼Œå‘é€é€€å‡ºç¼–è¾‘çš„æ¶ˆæ¯é€šçŸ¥
        PictureEditResponseMessage pictureEditResponseMessage = new PictureEditResponseMessage();
        pictureEditResponseMessage.setType(PictureEditMessageTypeEnum.EXIT_EDIT.getValue());
        String message = String.format("%sé€€å‡ºç¼–è¾‘å›¾ç‰‡", user.getUserName());
        pictureEditResponseMessage.setMessage(message);
        pictureEditResponseMessage.setUser(userService.getUserVO(user));
        broadcastToPicture(pictureId, pictureEditResponseMessage);
    }
}
```

5ï¼‰WebSocket è¿æ¥å…³é—­æ—¶ï¼Œéœ€è¦ç§»é™¤å½“å‰ç”¨æˆ·çš„ç¼–è¾‘çŠ¶æ€ã€å¹¶ä¸”ä»é›†åˆä¸­åˆ é™¤å½“å‰ä¼šè¯ï¼Œè¿˜å¯ä»¥ç»™å…¶ä»–å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯é€šçŸ¥ï¼š

```java
@Override
public void afterConnectionClosed(WebSocketSession session, @NotNull CloseStatus status) throws Exception {
    Map<String, Object> attributes = session.getAttributes();
    Long pictureId = (Long) attributes.get("pictureId");
    User user = (User) attributes.get("user");
    // ç§»é™¤å½“å‰ç”¨æˆ·çš„ç¼–è¾‘çŠ¶æ€
    handleExitEditMessage(null, session, user, pictureId);

    // åˆ é™¤ä¼šè¯
    Set<WebSocketSession> sessionSet = pictureSessions.get(pictureId);
    if (sessionSet != null) {
        sessionSet.remove(session);
        if (sessionSet.isEmpty()) {
            pictureSessions.remove(pictureId);
        }
    }

    // å“åº”
    PictureEditResponseMessage pictureEditResponseMessage = new PictureEditResponseMessage();
    pictureEditResponseMessage.setType(PictureEditMessageTypeEnum.INFO.getValue());
    String message = String.format("%sç¦»å¼€ç¼–è¾‘", user.getUserName());
    pictureEditResponseMessage.setMessage(message);
    pictureEditResponseMessage.setUser(userService.getUserVO(user));
    broadcastToPicture(pictureId, pictureEditResponseMessage);
}
```

ğŸ’¡ ç”±äºå¤„ç†å™¨çš„ä»£ç å¹¶ä¸å¤æ‚ï¼Œè€Œä¸”å¤„ç†é€»è¾‘ä¸­ä½¿ç”¨åˆ°äº†å½“å‰ç±»çš„å…¨å±€å˜é‡ï¼Œæ‰€ä»¥é±¼çš®æ²¡æœ‰é€‰æ‹©å°†æ¯ä¸ªå¤„ç†å™¨å°è£…ä¸ºå•ç‹¬çš„ç±»ã€‚å¤§å®¶ä¹Ÿå¯ä»¥å°†æ¯ä¸ªå¤„ç†å™¨å°è£…ä¸ºå•ç‹¬çš„ç±»ï¼ˆç›¸å½“äºè®¾è®¡æ¨¡å¼ä¸­çš„ç­–ç•¥æ¨¡å¼ï¼‰ï¼Œå¹¶ä¸”æ ¹æ®æ¶ˆæ¯ç±»åˆ«è°ƒç”¨ä¸åŒçš„å¤„ç†å™¨ç±»ã€‚

### 5ã€WebSocket é…ç½®

ç±»ä¼¼äºç¼–å†™ Spring MVC çš„ Controller æ¥å£ï¼Œå¯ä»¥ä¸ºæŒ‡å®šçš„è·¯å¾„é…ç½®å¤„ç†å™¨å’Œæ‹¦æˆªå™¨ï¼š

```java
@Configuration
@EnableWebSocket
public class WebSocketConfig implements WebSocketConfigurer {

    @Resource
    private PictureEditHandler pictureEditHandler;

    @Resource
    private WsHandshakeInterceptor wsHandshakeInterceptor;

    @Override
    public void registerWebSocketHandlers(WebSocketHandlerRegistry registry) {
        // websocket
        registry.addHandler(pictureEditHandler, "/ws/picture/edit")
                .addInterceptors(wsHandshakeInterceptor)
                .setAllowedOrigins("*");
    }
}
```

ä¹‹åï¼Œå‰ç«¯å°±å¯ä»¥é€šè¿‡ WebSocket è¿æ¥é¡¹ç›®å¯åŠ¨ç«¯å£çš„ `/ws/picture/edit` è·¯å¾„äº†ã€‚

### æ‰©å±•çŸ¥è¯† - Disruptor ä¼˜åŒ–

#### 1ã€ç°å­˜çš„ç³»ç»Ÿé—®é¢˜

WebSocket é€šå¸¸æ˜¯é•¿è¿æ¥ï¼Œæ¯ä¸ªå®¢æˆ·ç«¯éƒ½éœ€è¦å ç”¨æœåŠ¡å™¨èµ„æºã€‚åœ¨ Spring WebSocket ä¸­ï¼Œæ¯ä¸ª WebSocket è¿æ¥ï¼ˆå®¢æˆ·ç«¯ï¼‰å¯¹åº”ä¸€ä¸ªç‹¬ç«‹çš„ `WebSocketSession`ï¼Œæ¶ˆæ¯çš„å¤„ç†æ˜¯åœ¨è¯¥ `WebSocketSession` æ‰€å±çš„çº¿ç¨‹ä¸­æ‰§è¡Œã€‚

å¦‚æœ **åŒä¸€ä¸ª** WebSocket è¿æ¥ï¼ˆå®¢æˆ·ç«¯ï¼‰è¿ç»­å‘é€å¤šæ¡æ¶ˆæ¯ï¼ŒæœåŠ¡å™¨ä¼š **æŒ‰ç…§æ¥æ”¶çš„é¡ºåºä¾æ¬¡åŒæ­¥å¤„ç†**ï¼Œè€Œä¸æ˜¯å¹¶å‘æ‰§è¡Œã€‚è¿™æ˜¯ä¸ºäº†ä¿è¯æ¯ä¸ªå®¢æˆ·ç«¯çš„æ¶ˆæ¯å¤„ç†æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚

å¯ä»¥åœ¨ `handleTextMessage` æ–¹æ³•ä¸­å¢åŠ  `Thread.sleep` æ¥æµ‹è¯•ä¸€ä¸‹ã€‚è¿ç»­ç‚¹å‡»å¤šæ¬¡ç¼–è¾‘æ“ä½œï¼Œä¼šå‘ç°æ¯éš”ä¸€æ®µæ—¶é—´æ–¹æ³•æ‰ä¼šæ‰§è¡Œä¸€æ¬¡ã€‚

è™½ç„¶å¤šä¸ªå®¢æˆ·ç«¯çš„æ¶ˆæ¯å¤„ç†æ˜¯å¯ä»¥å¹¶å‘æ‰§è¡Œçš„ï¼Œä½†æ˜¯æ¥å—æ¶ˆæ¯å’Œå…·ä½“å¤„ç†æŸä¸ªæ¶ˆæ¯ä½¿ç”¨çš„æ˜¯ **åŒä¸€ä¸ªçº¿ç¨‹**ã€‚å¦‚æœå¤„ç†æ¶ˆæ¯çš„è€—æ—¶æ¯”è¾ƒé•¿ï¼Œå¹¶å‘é‡åˆæ¯”è¾ƒé«˜ï¼Œå¯èƒ½ä¼šå¯¼è‡´ç³»ç»Ÿå“åº”æ—¶é—´å˜é•¿ï¼Œç”šè‡³å› ä¸ºèµ„æºè€—å°½è€ŒæœåŠ¡å´©æºƒã€‚

ğŸ’¡ ä¸ºäº†ä¾¿äºç†è§£ï¼Œå¯ä»¥ç±»æ¯”ä¸€ä¸‹è°ƒç”¨ Spring MVC çš„æŸä¸ªæ¥å£æ—¶ï¼Œå¦‚æœè¯¥æ¥å£å†…éƒ¨çš„è€—æ—¶è¾ƒé•¿ï¼Œè¯·æ±‚çº¿ç¨‹å°±ä¼šä¸€ç›´é˜»å¡ï¼Œæœ€ç»ˆå¯¼è‡´ Tomcat è¯·æ±‚è¿æ¥æ•°è€—å°½ã€‚

æ€ä¹ˆè§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿæœ€ç®€å•çš„æ–¹æ³•å°±æ˜¯å¼€ä¸€ä¸ªçº¿ç¨‹ä¸“é—¨æ¥å¼‚æ­¥å¤„ç†æ¶ˆæ¯ã€‚ä½†æ˜¯æˆ‘ä»¬è¿˜è¦ä¿è¯æ“ä½œæ˜¯æŒ‰ç…§é¡ºåºåŒæ­¥ç»™å…¶ä»–å®¢æˆ·ç«¯çš„ï¼Œå› æ­¤è¿˜éœ€è¦å¼•å…¥ä¸€ä¸ªé˜Ÿåˆ—ï¼Œå°†ä»»åŠ¡æŒ‰ç…§é¡ºåºæ”¾åˆ°é˜Ÿåˆ—ä¸­ï¼Œäº¤ç»™çº¿ç¨‹å»å¤„ç†ã€‚

![img](assets/Yzod4kWq4lISfEh1.webp)

å…¶å®ä¸Šè¿°çš„å¼‚æ­¥æ“ä½œ + ä»ä»»åŠ¡é˜Ÿåˆ—å–ä»»åŠ¡æ‰§è¡Œï¼Œä½¿ç”¨çº¿ç¨‹æ± å°±å¯ä»¥å®ç°äº†ã€‚

ä½†å¯¹äºååŒç¼–è¾‘åœºæ™¯ï¼Œéœ€è¦å°½å¯èƒ½åœ°ä¿è¯ä½å»¶è¿Ÿï¼Œå› æ­¤æˆ‘ä»¬é€‰ç”¨ä¸€ç§é«˜çº§æŠ€æœ¯ **Disruptor** æ— é”é˜Ÿåˆ—æ¥å‡å°‘çº¿ç¨‹ä¸Šä¸‹æ–‡çš„åˆ‡æ¢ï¼Œèƒ½å¤Ÿåœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ä¿æŒä½å»¶è¿Ÿå’Œé«˜ååé‡ã€‚

æ­¤å¤–ï¼Œä½¿ç”¨ Disruptor è¿˜æœ‰ä¸€ä¸ªä¼˜ç‚¹ï¼Œå¯ä»¥å°†ä»»åŠ¡æ”¾åˆ°é˜Ÿåˆ—ä¸­ï¼Œé€šè¿‡ä¼˜é›…åœæœºæœºåˆ¶ï¼Œåœ¨æœåŠ¡åœæ­¢å‰æ‰§è¡Œå®Œæ‰€æœ‰çš„ä»»åŠ¡ï¼Œå†é€€å‡ºæœåŠ¡ï¼Œé˜²æ­¢æ¶ˆæ¯ä¸¢å¤±ã€‚

#### 2ã€Disruptor ä»‹ç»

[Disruptor](https://lmax-exchange.github.io/disruptor/#_what_is_the_disruptor) æ˜¯ä¸€ç§é«˜æ€§èƒ½çš„å¹¶å‘æ¡†æ¶ï¼Œç”± LMAXï¼ˆä¸€ä¸ªé‡‘èäº¤æ˜“ç³»ç»Ÿå…¬å¸ï¼‰å¼€å‘ï¼Œå®ƒæ˜¯ä¸€ç§ **æ— é”çš„ç¯å½¢é˜Ÿåˆ—** æ•°æ®ç»“æ„ï¼Œç”¨äºè§£å†³é«˜ååé‡å’Œä½å»¶è¿Ÿåœºæ™¯ä¸­çš„å¹¶å‘é—®é¢˜ã€‚æ”¯æŒç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼ï¼Œå¯ä½œä¸ºæ¶ˆæ¯é˜Ÿåˆ—ä½¿ç”¨ï¼Œé€‚ç”¨äºé‡‘èäº¤æ˜“ã€å®æ—¶æ•°æ®å¤„ç†ã€æ¸¸æˆäº‹ä»¶ç­‰å¯¹å¹¶å‘å’Œå®

å®ƒæœ€å¤§çš„ç‰¹ç‚¹å°±æ˜¯å¿«ã€å»¶è¿Ÿä½ï¼Œéå¸¸ä½ï¼

![img](assets/5QTaf3NxCuoov8sW.png)

Disruptor çš„æ ¸å¿ƒæ€æƒ³æ˜¯åŸºäºå›ºå®šå¤§å°çš„ **ç¯å½¢ç¼“å†²åŒº**ï¼ˆRing Bufferï¼‰ï¼Œå¹¶é€šè¿‡åºåˆ—åŒ–æ§åˆ¶è®¿é—®ï¼Œä»¥é¿å…ä¼ ç»Ÿé˜Ÿåˆ—ä¸­å¸¸è§çš„é”ç«äº‰é—®é¢˜ã€‚

å®ƒä¸»è¦é€šè¿‡ä»¥ä¸‹å‡ ç‚¹å®ç°é«˜æ€§èƒ½çš„æ¶ˆæ¯ä¼ é€’æœºåˆ¶ï¼š

1. ç¯å½¢ç¼“å†²åŒºï¼šä½¿ç”¨å›ºå®šå¤§å°çš„æ•°ç»„ï¼Œå¯ä»¥å¤ç”¨å†…å­˜ï¼Œé¿å…äº†é¢‘ç¹çš„å†…å­˜åˆ†é…å’Œåƒåœ¾å›æ”¶ã€‚
2. æ— é”è®¾è®¡ï¼šä¾èµ– CASï¼ˆCompare-And-Swapï¼‰å’Œå†…å­˜å±éšœï¼Œè€Œä¸æ˜¯ä¼ ç»Ÿçš„é”ï¼Œé™ä½äº†çº¿ç¨‹åˆ‡æ¢çš„å¼€é”€ã€‚
3. ç¼“å­˜å‹å¥½ï¼šæœ€å¤§åŒ–åˆ©ç”¨ CPU çš„ç¼“å­˜å±€éƒ¨æ€§ï¼Œæé«˜è®¿é—®é€Ÿåº¦ã€‚
4. åºåˆ—å·æœºåˆ¶ï¼šé€šè¿‡åºåˆ—å·ç®¡ç†ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„è®¿é—®ï¼Œä¿è¯æ•°æ®ä¸€è‡´æ€§ã€‚
5. å¤šæ¶ˆè´¹è€…æ¨¡å¼ï¼šæ”¯æŒå¤šæ¶ˆè´¹è€…å…±äº«åŒä¸€ç¯å½¢ç¼“å†²åŒºï¼Œå¹¶èƒ½é…ç½®ä¸åŒçš„æ¶ˆè´¹ç­–ç•¥ï¼ˆå¦‚ä¾èµ–å…³ç³»ã€å¹¶è¡Œæ¶ˆè´¹ç­‰ï¼‰ã€‚

Disruptor ä¸ä¼ ç»Ÿé˜Ÿåˆ—å¯¹æ¯”ï¼š

| ç‰¹æ€§     | Disruptor                  | BlockingQueuesqWmWU     |
| -------- | -------------------------- | ----------------------- |
| å¹¶å‘æ§åˆ¶ | æ— é”ï¼ˆCAS + å†…å­˜å±éšœï¼‰     | åŸºäºé”ï¼ˆReentrantLockï¼‰ |
| å†…å­˜ç®¡ç† | å›ºå®šé•¿åº¦çš„ç¯å½¢æ•°ç»„         | åŠ¨æ€æ•°ç»„æˆ–é“¾è¡¨          |
| æ€§èƒ½     | æé«˜ï¼ˆç™¾ä¸‡çº§åˆ«æ¶ˆæ¯/ç§’ï¼‰    | è¾ƒä½ï¼ˆæ•°ä¸‡æ¶ˆæ¯/ç§’ï¼‰     |
| å»¶è¿Ÿ     | çº³ç§’çº§åˆ«                   | æ¯«ç§’çº§åˆ«                |
| GC å‹åŠ›  | æä½ï¼ˆæ•°æ®å¤ç”¨ï¼‰           | è¾ƒé«˜ï¼ˆé¢‘ç¹åˆ›å»ºæ–°å¯¹è±¡ï¼‰q |
| é€‚ç”¨åœºæ™¯ | é«˜é¢‘å®æ—¶æ¶ˆæ¯å¤„ç†ã€é‡‘èç³»ç»Ÿ | ä¸€èˆ¬ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹X   |

#### 3ã€Disruptor æ ¸å¿ƒæ¦‚å¿µä¸å·¥ä½œæµç¨‹

å…ˆäº†è§£ Disruptor çš„æ ¸å¿ƒæ¦‚å¿µï¼š

- RingBufferï¼ˆç¯å½¢ç¼“å†²åŒºï¼‰ï¼šå›ºå®šå¤§å°çš„å¾ªç¯æ•°ç»„ï¼Œç”¨äºå­˜å‚¨æ•°æ®é¡¹ï¼Œç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…å…±äº«è¯¥æ•°æ®ç»“æ„ã€‚
- Eventï¼ˆäº‹ä»¶ï¼‰ï¼šå­˜å‚¨åœ¨ `RingBuffer` ä¸­çš„æ•°æ®å¯¹è±¡ï¼Œç”¨äºè¡¨ç¤ºè¦ä¼ é€’çš„æ¶ˆæ¯æˆ–æ•°æ®ã€‚
- Producerï¼ˆç”Ÿäº§è€…ï¼‰ï¼šè´Ÿè´£å‘ `RingBuffer` å†™å…¥æ•°æ®çš„è§’è‰²ã€‚
- Consumerï¼ˆæ¶ˆè´¹è€…ï¼‰ï¼šä» `RingBuffer` ä¸­è¯»å–å¹¶å¤„ç†æ•°æ®çš„è§’è‰²ã€‚
- Sequencerï¼ˆåºåˆ—å™¨ï¼‰ï¼šç®¡ç†ç”Ÿäº§è€…ä¸æ¶ˆè´¹è€…çš„ç´¢å¼•ï¼Œç¡®ä¿å¹¶å‘å®‰å…¨çš„åºåˆ—ç®¡ç†ã€‚
- SequenceBarrierï¼ˆåºåˆ—å±éšœï¼‰ï¼šæ§åˆ¶æ¶ˆè´¹è€…ç­‰å¾…æ•°æ®å¯ç”¨çš„æœºåˆ¶ï¼Œç¡®ä¿æ•°æ®å®Œæ•´æ€§ã€‚
- WaitStrategyï¼ˆç­‰å¾…ç­–ç•¥ï¼‰ï¼šå®šä¹‰æ¶ˆè´¹è€…å¦‚ä½•ç­‰å¾…æ–°çš„æ•°æ®ï¼ˆå¦‚è‡ªæ—‹ã€è‡ªé€‚åº”ç­‰å¾…ç­‰ï¼‰ã€‚
- EventProcessorï¼ˆäº‹ä»¶å¤„ç†å™¨ï¼‰ï¼šé›†æˆäº† `Consumer` å’Œ `SequenceBarrier`ï¼Œç”¨äºæ›´é«˜çº§çš„æ¶ˆè´¹æ§åˆ¶ã€‚

è€Œ Disruptor æ˜¯å°è£…äº† `RingBuffer`ã€`Producer` å’Œ `Consumer` çš„æ ¸å¿ƒç®¡ç†ç±»ï¼Œç”¨äºåè°ƒæ‰€æœ‰ç»„ä»¶çš„è¿è¡Œã€‚

ä¸‹é¢æˆ‘ä¸¾ä¾‹æ¥è¯´æ˜ Disruptor çš„å·¥ä½œæµç¨‹ï¼š

1. ç¯å½¢é˜Ÿåˆ—åˆå§‹åŒ–ï¼šåˆ›å»ºä¸€ä¸ªå›ºå®šå¤§å°ä¸º 8 çš„ RingBufferï¼ˆç´¢å¼•èŒƒå›´ 0-7ï¼‰ï¼Œæ¯ä¸ªæ ¼å­å­˜å‚¨ä¸€ä¸ªå¯å¤ç”¨çš„äº‹ä»¶å¯¹è±¡ï¼Œåºå·åˆå§‹ä¸º 0ã€‚
2. ç”Ÿäº§è€…å†™å…¥æ•°æ®ï¼šç”Ÿäº§è€…ç”³è¯·ç´¢å¼• 0ï¼ˆåºå· 0ï¼‰ï¼Œå°†æ•°æ® "A" å†™å…¥äº‹ä»¶å¯¹è±¡ï¼Œæäº¤ååºå·é€’å¢ä¸º 1ï¼Œä¸‹ä¸€ä¸ªå†™å…¥ç´¢å¼•å˜ä¸º 1ã€‚
3. æ¶ˆè´¹è€…è¯»å–æ•°æ®ï¼šæ¶ˆè´¹è€…æ£€æŸ¥ç´¢å¼• 0ï¼ˆåºå· 0ï¼‰ï¼Œè¯»å–æ•°æ® "A"ï¼Œå¤„ç†åæäº¤ï¼Œåºå·é€’å¢ä¸º 1ï¼Œä¸‹ä¸€ä¸ªè¯»å–ç´¢å¼•å˜ä¸º 1ã€‚
4. ç¯å½¢é˜Ÿåˆ—å¾ªç¯ä½¿ç”¨ï¼šå½“ç”Ÿäº§è€…å†™å…¥åˆ°ç´¢å¼• 7ï¼ˆåºå· 7ï¼‰åï¼Œç´¢å¼•å›åˆ° 0ï¼ˆåºå· 8ï¼‰ï¼Œå½¢æˆå¾ªç¯å­˜å‚¨ï¼Œ**ä½†åºå·ä¼šæŒç»­è‡ªå¢ä»¥åŒºåˆ†æ•°æ®çš„å…ˆåé¡ºåºã€‚**
5. é˜²æ­¢æ•°æ®è¦†ç›–ï¼šå¦‚æœç”Ÿäº§è€…è¿½ä¸Šæ¶ˆè´¹è€…ï¼Œæ¶ˆè´¹è€…å°šæœªå¤„ç†å®Œæ•°æ®ï¼Œç”Ÿäº§è€…ä¼šç­‰å¾…ï¼Œç¡®ä¿æ•°æ®ä¸è¢«è¦†ç›–ã€‚

ä¸‹å›¾æ˜¯ä¸€ä¸ª Disruptor ç”Ÿäº§è€…çš„æ¨¡å‹ï¼Œä»…ä¾›å‚è€ƒï¼Œäº†è§£ä¸€ä¸‹å³å¯ï¼š

![img](assets/FuKxPOZJBFGeGqaG.webp)

å…¶å®å¯¹å¤§å®¶æ¥è¯´ï¼Œå…ˆå°† Disruptor å½“åšä¸€ä¸ªé«˜æ€§èƒ½çš„é˜Ÿåˆ—æ¥ä½¿ç”¨å°±å¯ä»¥äº†ï¼Œå¯ä»¥å‘é˜Ÿåˆ—ä¸­æ·»åŠ äº‹ä»¶å¹¶å®šä¹‰å¤„ç†æ–¹å¼ã€‚æ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥é˜…è¯» [è¿™ç¯‡æ–‡ç« ](https://juejin.cn/post/6844903648875528206) æ·±å…¥äº†è§£ Disruptor æ€§èƒ½é«˜çš„åŸå› ã€‚

ä¸‹é¢æˆ‘ä»¬æ¥å¼•å…¥ Disruptor æ¥ä¼˜åŒ–ä»£ç ã€‚

#### 4ã€Disruptor å®æˆ˜

1ï¼‰å¼•å…¥ Disruptor ä¾èµ–

```xml
<!-- é«˜æ€§èƒ½æ— é”é˜Ÿåˆ— -->
<dependency>
    <groupId>com.lmax</groupId>
    <artifactId>disruptor</artifactId>
    <version>3.4.2</version>
</dependency>
```

2ï¼‰å®šä¹‰äº‹ä»¶

äº‹ä»¶æ˜¯ Disruptor æ‰§è¡Œçš„æ ¸å¿ƒå•ä½ï¼Œåœ¨ `websocket.disruptor` åŒ…ä¸­æ–°å»º PictureEditEvent ç±»ï¼Œå……å½“äº†ä¸Šä¸‹æ–‡å®¹å™¨ï¼Œæ‰€æœ‰å¤„ç†æ¶ˆæ¯æ‰€éœ€çš„æ•°æ®éƒ½è¢«å°è£…åœ¨å…¶ä¸­ã€‚

```java
@Data
public class PictureEditEvent {

    /**
     * æ¶ˆæ¯
     */
    private PictureEditRequestMessage pictureEditRequestMessage;

    /**
     * å½“å‰ç”¨æˆ·çš„ session
     */
    private WebSocketSession session;
    
    /**
     * å½“å‰ç”¨æˆ·
     */
    private User user;

    /**
     * å›¾ç‰‡ id
     */
    private Long pictureId;

}
```

3ï¼‰å®šä¹‰äº‹ä»¶å¤„ç†å™¨ï¼ˆæ¶ˆè´¹è€…ï¼‰

è¿™é‡ŒåŸºæœ¬ä¸Šæ˜¯æŠŠ `PictureEditHandler` åˆ†å‘æ¶ˆæ¯çš„é€»è¾‘æ¬äº†è¿‡æ¥ï¼Œå®ƒçš„ä½œç”¨å°±æ˜¯å°†ä¸åŒç±»å‹çš„æ¶ˆæ¯åˆ†å‘åˆ°å¯¹åº”çš„å¤„ç†å™¨ä¸­ã€‚

```java
@Slf4j
@Component
public class PictureEditEventWorkHandler implements WorkHandler<PictureEditEvent> {

    @Resource
    @Lazy
    private PictureEditHandler pictureEditHandler;

    @Resource
    private UserService userService;

    @Override
    public void onEvent(PictureEditEvent event) throws Exception {
        PictureEditRequestMessage pictureEditRequestMessage = event.getPictureEditRequestMessage();
        WebSocketSession session = event.getSession();
        User user = event.getUser();
        Long pictureId = event.getPictureId();
        // è·å–åˆ°æ¶ˆæ¯ç±»åˆ«
        String type = pictureEditRequestMessage.getType();
        PictureEditMessageTypeEnum pictureEditMessageTypeEnum = PictureEditMessageTypeEnum.valueOf(type);
        // è°ƒç”¨å¯¹åº”çš„æ¶ˆæ¯å¤„ç†æ–¹æ³•
        switch (pictureEditMessageTypeEnum) {
            case ENTER_EDIT:
                pictureEditHandler.handleEnterEditMessage(pictureEditRequestMessage, session, user, pictureId);
                break;
            case EDIT_ACTION:
                pictureEditHandler.handleEditActionMessage(pictureEditRequestMessage, session, user, pictureId);
                break;
            case EXIT_EDIT:
                pictureEditHandler.handleExitEditMessage(pictureEditRequestMessage, session, user, pictureId);
                break;
            default:
                PictureEditResponseMessage pictureEditResponseMessage = new PictureEditResponseMessage();
                pictureEditResponseMessage.setType(PictureEditMessageTypeEnum.ERROR.getValue());
                pictureEditResponseMessage.setMessage("æ¶ˆæ¯ç±»å‹é”™è¯¯");
                pictureEditResponseMessage.setUser(userService.getUserVO(user));
                session.sendMessage(new TextMessage(JSONUtil.toJsonStr(pictureEditResponseMessage)));
        }
    }
}
```

4ï¼‰æ·»åŠ  Disruptor é…ç½®ç±»ï¼Œå°†æˆ‘ä»¬åˆšå®šä¹‰çš„äº‹ä»¶åŠå¤„ç†å™¨å…³è”åˆ° Disruptor å®ä¾‹ä¸­ï¼š

```java
@Configuration
public class PictureEditEventDisruptorConfig {

    @Resource
    private PictureEditEventWorkHandler pictureEditEventWorkHandler;

    @Bean("pictureEditEventDisruptor")
    public Disruptor<PictureEditEvent> messageModelRingBuffer() {
        // ringBuffer çš„å¤§å°
        int bufferSize = 1024 * 256;
        Disruptor<PictureEditEvent> disruptor = new Disruptor<>(
                PictureEditEvent::new,
                bufferSize,
                ThreadFactoryBuilder.create().setNamePrefix("pictureEditEventDisruptor").build()
        );
        // è®¾ç½®æ¶ˆè´¹è€…
        disruptor.handleEventsWithWorkerPool(pictureEditEventWorkHandler);
        // å¼€å¯ disruptor
        disruptor.start();
        return disruptor;
    }
}
```

5ã€å®šä¹‰äº‹ä»¶ç”Ÿäº§è€…

ç”Ÿäº§è€…è´Ÿè´£å°†æ•°æ®ï¼ˆäº‹ä»¶ï¼‰å‘åˆ° Disruptor çš„ç¯å½¢ç¼“å†²åŒºä¸­ã€‚ä¸ºäº†ä¿è¯åœ¨åœæœºæ—¶æ‰€æœ‰çš„æ¶ˆæ¯éƒ½èƒ½å¤Ÿè¢«å¤„ç†ï¼Œæˆ‘ä»¬é€šè¿‡ `shutdown` æ–¹æ³•å®Œæˆ Disruptor çš„ä¼˜é›…åœæœºã€‚

```java
@Component
@Slf4j
public class PictureEditEventProducer {

    @Resource
    Disruptor<PictureEditEvent> pictureEditEventDisruptor;

    public void publishEvent(PictureEditRequestMessage pictureEditRequestMessage, WebSocketSession session, User user, Long pictureId) {
        RingBuffer<PictureEditEvent> ringBuffer = pictureEditEventDisruptor.getRingBuffer();
        // è·å–å¯ä»¥ç”Ÿæˆçš„ä½ç½®
        long next = ringBuffer.next();
        PictureEditEvent pictureEditEvent = ringBuffer.get(next);
        pictureEditEvent.setSession(session);
        pictureEditEvent.setPictureEditRequestMessage(pictureEditRequestMessage);
        pictureEditEvent.setUser(user);
        pictureEditEvent.setPictureId(pictureId);
        // å‘å¸ƒäº‹ä»¶
        ringBuffer.publish(next);
    }

    /**
     * ä¼˜é›…åœæœº
     */
    @PreDestroy
    public void close() {
        pictureEditEventDisruptor.shutdown();
    }
}
```

6ã€ä¿®æ”¹ PictureEditHandler çš„åŸæœ‰é€»è¾‘ï¼Œæ”¹ä¸ºä½¿ç”¨äº‹ä»¶ç”Ÿäº§è€…ï¼š

```java
@Resource
private PictureEditEventProducer pictureEditEventProducer;

@Override
protected void handleTextMessage(WebSocketSession session, TextMessage message) throws Exception {
    // å°†æ¶ˆæ¯è§£æä¸º PictureEditMessage
    PictureEditRequestMessage pictureEditRequestMessage = JSONUtil.toBean(message.getPayload(), PictureEditRequestMessage.class);
    // ä» Session å±æ€§ä¸­è·å–å…¬å…±å‚æ•°
    Map<String, Object> attributes = session.getAttributes();
    User user = (User) attributes.get("user");
    Long pictureId = (Long) attributes.get("pictureId");
    // ç”Ÿäº§æ¶ˆæ¯
    pictureEditEventProducer.publishEvent(pictureEditRequestMessage, session, user, pictureId);
}
```

è¿™æ ·ï¼Œæˆ‘ä»¬å°±å®ç°äº†åŸºäº Disruptor çš„å¼‚æ­¥æ¶ˆæ¯å¤„ç†æœºåˆ¶ï¼Œå°†åŸæœ‰çš„åŒæ­¥æ¶ˆæ¯åˆ†å‘é€»è¾‘æ”¹é€ ä¸ºé«˜æ•ˆè§£è€¦çš„å¼‚æ­¥å¤„ç†æ¨¡å‹ï¼Œä¹Ÿæ›´æœ‰åˆ©äºä»£ç çš„æ‰©å±•ã€‚

### æ‰©å±•

1ã€ä¸ºé˜²æ­¢æ¶ˆæ¯ä¸¢å¤±ï¼Œå¯ä»¥ä½¿ç”¨ Redis ç­‰é«˜æ€§èƒ½å­˜å‚¨ä¿å­˜æ‰§è¡Œçš„æ“ä½œè®°å½•ã€‚

ç›®å‰å¦‚æœå›¾ç‰‡å·²ç»è¢«ç¼–è¾‘äº†ï¼Œæ–°ç”¨æˆ·åŠ å…¥ç¼–è¾‘æ—¶æ²¡åŠæ³•æŸ¥çœ‹åˆ°å·²ç¼–è¾‘çš„çŠ¶æ€ï¼Œè¿™ä¸€ç‚¹ä¹Ÿå¯ä»¥åˆ©ç”¨ Redis ä¿å­˜æ“ä½œè®°å½•æ¥è§£å†³ï¼Œæ–°ç”¨æˆ·åŠ å…¥ç¼–è¾‘æ—¶è¯»å– Redis çš„æ“ä½œè®°å½•å³å¯ã€‚

2ã€æ¯ç§ç±»å‹çš„æ¶ˆæ¯å¤„ç†å¯ä»¥å°è£…ä¸ºç‹¬ç«‹çš„ Handler å¤„ç†å™¨ç±»ï¼Œä¹Ÿå°±æ˜¯é‡‡ç”¨ç­–ç•¥æ¨¡å¼ã€‚

3ã€æ”¯æŒåˆ†å¸ƒå¼ WebSocketã€‚å®ç°æ€è·¯å¾ˆç®€å•ï¼Œåªéœ€è¦ä¿è¯è¦ç¼–è¾‘åŒä¸€å›¾ç‰‡çš„ç”¨æˆ·è¿æ¥çš„æ˜¯ç›¸åŒçš„æœåŠ¡å™¨å³å¯ï¼Œå’Œæ¸¸æˆåˆ†æœåŠ¡å™¨å¤§åŒºã€èŠå¤©å®¤åˆ†æˆ¿é—´æ˜¯ç±»ä¼¼çš„åŸç†ã€‚

4ã€ä¸€äº›å°é—®é¢˜çš„ä¼˜åŒ–ï¼šæ¯”å¦‚ WebSocket è¿æ¥å»ºç«‹ä¹‹åï¼Œå¦‚æœç”¨æˆ·é€€å‡ºäº†ç™»å½•ï¼Œè¿™æ—¶ WebSocket çš„è¿æ¥æ˜¯æ²¡æœ‰æ–­å¼€çš„ã€‚ä¸è¿‡å½±å“å¹¶ä¸å¤§ï¼Œå¤§å®¶å¯ä»¥æ€è€ƒä¸‹æ€ä¹ˆå¤„ç†ã€‚

## å››ã€å‰ç«¯å¼€å‘

å‰ç«¯å¼€å‘ä¸»è¦é›†ä¸­åœ¨åŸºç¡€å›¾ç‰‡ç¼–è¾‘ç»„ä»¶ `ImageCropper.vue` ä¸­ã€‚

### 1ã€åŸºç¡€ä»£ç 

é¦–å…ˆæ ¹æ®åç«¯çš„æšä¸¾ç±»å’Œå¸¸é‡ï¼Œåœ¨ `picture.ts` ä¸­å®šä¹‰å›¾ç‰‡ç¼–è¾‘æ¶ˆæ¯ç±»å‹ã€å›¾ç‰‡ç¼–è¾‘åŠ¨ä½œï¼š

```typescript
export const PICTURE_EDIT_MESSAGE_TYPE_ENUM = {
  INFO: 'INFO',
  ERROR: 'ERROR',
  ENTER_EDIT: 'ENTER_EDIT',
  EXIT_EDIT: 'EXIT_EDIT',
  EDIT_ACTION: 'EDIT_ACTION',
};

export const PICTURE_EDIT_MESSAGE_TYPE_MAP = {
  INFO: 'å‘é€é€šçŸ¥',
  ERROR: 'å‘é€é”™è¯¯',
  ENTER_EDIT: 'è¿›å…¥ç¼–è¾‘çŠ¶æ€',
  EXIT_EDIT: 'é€€å‡ºç¼–è¾‘çŠ¶æ€',
  EDIT_ACTION: 'æ‰§è¡Œç¼–è¾‘æ“ä½œ',
};

export const PICTURE_EDIT_ACTION_ENUM = {
  ZOOM_IN: 'ZOOM_IN',
  ZOOM_OUT: 'ZOOM_OUT',
  ROTATE_LEFT: 'ROTATE_LEFT',
  ROTATE_RIGHT: 'ROTATE_RIGHT',
};

export const PICTURE_EDIT_ACTION_MAP = {
  ZOOM_IN: 'æ”¾å¤§æ“ä½œ',
  ZOOM_OUT: 'ç¼©å°æ“ä½œ',
  ROTATE_LEFT: 'å·¦æ—‹æ“ä½œ',
  ROTATE_RIGHT: 'å³æ—‹æ“ä½œ',
};
```

### 2ã€WebSocket å‰ç«¯åŸºç¡€ä»£ç 

ä¸ºäº†è®©é¡µé¢æˆ–ç»„ä»¶çš„ä»£ç ä¸­èƒ½å¤Ÿæ›´æ–¹ä¾¿åœ°ä½¿ç”¨ WebSocket è¿æ¥ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆåœ¨ `utils` ç›®å½•ä¸‹ç¼–å†™é€‚ç”¨äºå›¾ç‰‡ç¼–è¾‘ WebSocket è¿æ¥çš„å·¥å…·ç±»ã€‚å®šä¹‰äº†ï¼š

- è¿æ¥ WebSocket çš„åœ°å€
- WebSocket å„ä¸ªäº‹ä»¶çš„å¤„ç†å‡½æ•°ï¼Œæ¯”å¦‚è¿æ¥æˆåŠŸå’Œè¿æ¥å…³é—­äº‹ä»¶ï¼Œè·Ÿåç«¯å¯¹åº”
- å‘ WebSocket æœåŠ¡ç«¯å‘é€æ¶ˆæ¯çš„å‡½æ•°ç­‰

ä»£ç å¦‚ä¸‹ï¼Œè¿™æ®µå±äºæ ·æ¿ä»£ç ï¼Œå¤§å®¶äº†è§£ä¸€ä¸‹å³å¯ï¼Œä¸å¿…è‡ªå·±æ•²ï¼š

```typescript
export default class PictureEditWebSocket {
  private pictureId: number
  private socket: WebSocket | null
  private eventHandlers: any

  constructor(pictureId: number) {
    this.pictureId = pictureId // å½“å‰ç¼–è¾‘çš„å›¾ç‰‡ ID
    this.socket = null // WebSocket å®ä¾‹
    this.eventHandlers = {} // è‡ªå®šä¹‰äº‹ä»¶å¤„ç†å™¨
  }

  /**
   * åˆå§‹åŒ– WebSocket è¿æ¥
   */
  connect() {
    const url = `ws://localhost:8123/api/ws/picture/edit?pictureId=${this.pictureId}`
    this.socket = new WebSocket(url)

    // è®¾ç½®æºå¸¦ cookie
    this.socket.binaryType = 'blob'

    // ç›‘å¬è¿æ¥æˆåŠŸäº‹ä»¶
    this.socket.onopen = () => {
      console.log('WebSocket è¿æ¥å·²å»ºç«‹')
      this.triggerEvent('open')
    }

    // ç›‘å¬æ¶ˆæ¯äº‹ä»¶
    this.socket.onmessage = (event) => {
      const message = JSON.parse(event.data)
      console.log('æ”¶åˆ°æ¶ˆæ¯:', message)

      // æ ¹æ®æ¶ˆæ¯ç±»å‹è§¦å‘å¯¹åº”äº‹ä»¶
      const type = message.type
      this.triggerEvent(type, message)
    }

    // ç›‘å¬è¿æ¥å…³é—­äº‹ä»¶
    this.socket.onclose = (event) => {
      console.log('WebSocket è¿æ¥å·²å…³é—­:', event)
      this.triggerEvent('close', event)
    }

    // ç›‘å¬é”™è¯¯äº‹ä»¶
    this.socket.onerror = (error) => {
      console.error('WebSocket å‘ç”Ÿé”™è¯¯:', error)
      this.triggerEvent('error', error)
    }
  }

  /**
   * å…³é—­ WebSocket è¿æ¥
   */
  disconnect() {
    if (this.socket) {
      this.socket.close()
      console.log('WebSocket è¿æ¥å·²æ‰‹åŠ¨å…³é—­')
    }
  }

  /**
   * å‘é€æ¶ˆæ¯åˆ°åç«¯
   * @param {Object} message æ¶ˆæ¯å¯¹è±¡
   */
  sendMessage(message: object) {
    if (this.socket && this.socket.readyState === WebSocket.OPEN) {
      this.socket.send(JSON.stringify(message))
      console.log('æ¶ˆæ¯å·²å‘é€:', message)
    } else {
      console.error('WebSocket æœªè¿æ¥ï¼Œæ— æ³•å‘é€æ¶ˆæ¯:', message)
    }
  }

  /**
   * æ·»åŠ è‡ªå®šä¹‰äº‹ä»¶ç›‘å¬
   * @param {string} type æ¶ˆæ¯ç±»å‹
   * @param {Function} handler æ¶ˆæ¯å¤„ç†å‡½æ•°
   */
  on(type: string, handler: (data?: any) => void) {
    if (!this.eventHandlers[type]) {
      this.eventHandlers[type] = []
    }
    this.eventHandlers[type].push(handler)
  }

  /**
   * è§¦å‘äº‹ä»¶
   * @param {string} type æ¶ˆæ¯ç±»å‹
   * @param {Object} data æ¶ˆæ¯æ•°æ®
   */
  triggerEvent(type: string, data?: any) {
    const handlers = this.eventHandlers[type]
    if (handlers) {
      handlers.forEach((handler: any) => handler(data))
    }
  }
}
```

ä¸Šè¿°ä»£ç ä¸­æ¯”è¾ƒå·§å¦™çš„æ˜¯ï¼Œæˆ‘ä»¬è‡ªå®šä¹‰äº†ä¸€å¥—äº‹ä»¶ç›‘å¬æœºåˆ¶ï¼Œä½¿ç”¨å·¥å…·ç±»çš„ç»„ä»¶å¯ä»¥é€šè¿‡ `on` æ–¹æ³•æ³¨å†Œäº‹ä»¶å¤„ç†å‡½æ•°ï¼Œç„¶åé€šè¿‡ `triggerEvent` å‡½æ•°è§¦å‘äº‹ä»¶å¤„ç†å‡½æ•°ã€‚

### 3ã€å›¾ç‰‡ç¼–è¾‘ç»„ä»¶å¼€å‘

1ï¼‰å®šä¹‰å“åº”å¼å˜é‡ï¼ŒåŒ…æ‹¬æ­£åœ¨ç¼–è¾‘çš„ç”¨æˆ·ã€ç”¨æˆ·æ˜¯å¦å¯ä»¥è¿›å…¥ç¼–è¾‘ã€ç”¨æˆ·æ˜¯å¦å¯ä»¥é€€å‡ºç¼–è¾‘ï¼Œè¿™äº›å˜é‡ä¼šç”¨äºæ§åˆ¶é¡µé¢çš„å±•ç¤ºå’Œç¼–è¾‘æŒ‰é’®æ˜¯å¦å¯ç‚¹å‡»ï¼š

```typescript
// --------- å®æ—¶ç¼–è¾‘ ---------
const loginUserStore = useLoginUserStore()
let loginUser = loginUserStore.loginUser
// æ­£åœ¨ç¼–è¾‘çš„ç”¨æˆ·
const editingUser = ref<API.UserVO>()
// æ²¡æœ‰ç”¨æˆ·æ­£åœ¨ç¼–è¾‘ä¸­ï¼Œå¯è¿›å…¥ç¼–è¾‘
const canEnterEdit = computed(() => {
  return !editingUser.value
})
// æ­£åœ¨ç¼–è¾‘çš„ç”¨æˆ·æ˜¯æœ¬äººï¼Œå¯é€€å‡ºç¼–è¾‘
const canExitEdit = computed(() => {
  return editingUser.value?.id === loginUser.id
})
// å¯ä»¥ç¼–è¾‘
const canEdit = computed(() => {
  return editingUser.value?.id === loginUser.id
})
```

2ï¼‰å¼€å‘ååŒç¼–è¾‘æ“ä½œç›¸å…³çš„æŒ‰é’®å…ƒç´ ï¼š

```vue
<!-- ååŒç¼–è¾‘æ“ä½œ -->
<div class="image-edit-actions">
  <a-space>
    <a-button v-if="editingUser" disabled> {{ editingUser.userName }}æ­£åœ¨ç¼–è¾‘</a-button>
    <a-button v-if="canEnterEdit" type="primary" ghost @click="enterEdit">è¿›å…¥ç¼–è¾‘</a-button>
    <a-button v-if="canExitEdit" danger ghost @click="exitEdit">é€€å‡ºç¼–è¾‘</a-button>
  </a-space>
</div>
```

ç»™æ‰€æœ‰çš„å›¾ç‰‡ç¼–è¾‘æ“ä½œæŒ‰é’®è¡¥å……ç¦ç”¨çŠ¶æ€ï¼Œå¦‚æœæœ‰å…¶ä»–äººåœ¨ç¼–è¾‘ï¼Œåˆ™ç¦ç”¨æŒ‰é’®ï¼š

```vue
<a-space>
  <a-button @click="rotateLeft" :disabled="!canEdit">å‘å·¦æ—‹è½¬</a-button>
  <a-button @click="rotateRight" :disabled="!canEdit">å‘å³æ—‹è½¬</a-button>
  <a-button @click="changeScale(1)" :disabled="!canEdit">æ”¾å¤§</a-button>
  <a-button @click="changeScale(-1)" :disabled="!canEdit">ç¼©å°</a-button>
  <a-button type="primary" :loading="loading" :disabled="!canEdit" @click="handleConfirm">
    ç¡®è®¤
  </a-button>
</a-space>
```

æ•ˆæœå¦‚å›¾ï¼š

![img](assets/G0fSuKsquBbF8SOS.webp)

3ï¼‰åˆå§‹åŒ– WebSocket è¿æ¥ï¼Œç»‘å®šäº‹ä»¶ï¼š

```typescript
let websocket: PictureEditWebSocket | null

// åˆå§‹åŒ– WebSocket è¿æ¥ï¼Œç»‘å®šäº‹ä»¶
const initWebsocket = () => {
  const pictureId = props.picture?.id
  if (!pictureId || !visible.value) {
    return
  }
  // é˜²æ­¢ä¹‹å‰çš„è¿æ¥æœªé‡Šæ”¾
  if (websocket) {
    websocket.disconnect()
  }
  // åˆ›å»º WebSocket å®ä¾‹
  websocket = new PictureEditWebSocket(pictureId)
  // å»ºç«‹ WebSocket è¿æ¥
  websocket.connect()

  // ç›‘å¬é€šçŸ¥æ¶ˆæ¯
  websocket.on(PICTURE_EDIT_MESSAGE_TYPE_ENUM.INFO, (msg) => {
    console.log('æ”¶åˆ°é€šçŸ¥æ¶ˆæ¯ï¼š', msg)
    message.info(msg.message)
  })

  // ç›‘å¬é”™è¯¯æ¶ˆæ¯
  websocket.on(PICTURE_EDIT_MESSAGE_TYPE_ENUM.ERROR, (msg) => {
    console.log('æ”¶åˆ°é”™è¯¯æ¶ˆæ¯ï¼š', msg)
    message.error(msg.message)
  })

  // ç›‘å¬è¿›å…¥ç¼–è¾‘çŠ¶æ€æ¶ˆæ¯
  websocket.on(PICTURE_EDIT_MESSAGE_TYPE_ENUM.ENTER_EDIT, (msg) => {
    console.log('æ”¶åˆ°è¿›å…¥ç¼–è¾‘çŠ¶æ€æ¶ˆæ¯ï¼š', msg)
    message.info(msg.message)
    editingUser.value = msg.user
  })

  // ç›‘å¬ç¼–è¾‘æ“ä½œæ¶ˆæ¯
  websocket.on(PICTURE_EDIT_MESSAGE_TYPE_ENUM.EDIT_ACTION, (msg) => {
    console.log('æ”¶åˆ°ç¼–è¾‘æ“ä½œæ¶ˆæ¯ï¼š', msg)
    message.info(msg.message)
    switch (msg.editAction) {
      case PICTURE_EDIT_ACTION_ENUM.ROTATE_LEFT:
        cropperRef.value.rotateLeft()
        break
      case PICTURE_EDIT_ACTION_ENUM.ROTATE_RIGHT:
        cropperRef.value.rotateRight()
        break
      case PICTURE_EDIT_ACTION_ENUM.ZOOM_IN:
        cropperRef.value.changeScale(1)
        break
      case PICTURE_EDIT_ACTION_ENUM.ZOOM_OUT:
        cropperRef.value.changeScale(-1)
        break
    }
  })

  // ç›‘å¬é€€å‡ºç¼–è¾‘çŠ¶æ€æ¶ˆæ¯
  websocket.on(PICTURE_EDIT_MESSAGE_TYPE_ENUM.EXIT_EDIT, (msg) => {
    console.log('æ”¶åˆ°é€€å‡ºç¼–è¾‘çŠ¶æ€æ¶ˆæ¯ï¼š', msg)
    message.info(msg.message)
    editingUser.value = undefined
  })
}

watchEffect(() => {
  initWebsocket()
})

onUnmounted(() => {
  // æ–­å¼€è¿æ¥
  if (websocket) {
    websocket.disconnect()
  }
  editingUser.value = undefined
})

// å…³é—­å¼¹çª—
const closeModal = () => {
  visible.value = false
  // æ–­å¼€è¿æ¥
  if (websocket) {
    websocket.disconnect()
  }
  editingUser.value = undefined
}
```

ä¸Šè¿°ä»£ç ä¸­çš„å‡ ä¸ªæ³¨æ„äº‹é¡¹ï¼š

1. å®šä¹‰äº†æ”¶åˆ°æ¶ˆæ¯åçš„äº‹ä»¶å¤„ç†å‡½æ•°ï¼Œæ¯”å¦‚æ”¶åˆ°ç¼–è¾‘æ“ä½œæ¶ˆæ¯æ—¶ï¼Œè°ƒç”¨å›¾ç‰‡ç¼–è¾‘å™¨ç»„ä»¶çš„å¯¹åº”æ“ä½œæ–¹æ³•ï¼Œæ¥åŒæ­¥ç¼–è¾‘ç»“æœã€‚æ”¶åˆ°æœ‰ç”¨æˆ·è¿›å…¥ç¼–è¾‘çŠ¶æ€çš„æ¶ˆæ¯æ—¶ï¼Œè®¾ç½® editingUser çš„å€¼ï¼›æ”¶åˆ°æœ‰ç”¨æˆ·é€€å‡ºç¼–è¾‘çŠ¶æ€çš„æ¶ˆæ¯æ—¶ï¼Œæ¸…ç©º editingUser çš„å€¼ã€‚
2. åŠæ—¶é‡Šæ”¾ WebSocket è¿æ¥å’Œèµ„æºï¼šåœ¨ç»„ä»¶é”€æ¯æ—¶ï¼ˆonUnmounted å‡½æ•°ï¼‰ã€å¼¹çª—å…³é—­æ—¶ï¼ˆcloseModal å‡½æ•°ï¼‰ã€é‡æ–°è¿æ¥æ—¶ï¼ˆinitWebsocket å‡½æ•°å¼€å¤´ï¼‰éƒ½è¦é‡Šæ”¾è¿æ¥å¹¶é‡ç½®æ­£åœ¨ç¼–è¾‘çš„ç”¨æˆ·ã€‚

4ï¼‰ç¼–è¾‘å‘é€ WebSocket æ¶ˆæ¯çš„å‡½æ•°ï¼ŒåŒ…æ‹¬è¿›å…¥ç¼–è¾‘çŠ¶æ€ã€é€€å‡ºç¼–è¾‘çŠ¶æ€ã€æ‰§è¡Œç¼–è¾‘å›¾ç‰‡æ“ä½œï¼š

```typescript
// è¿›å…¥ç¼–è¾‘çŠ¶æ€
const enterEdit = () => {
  if (websocket) {
    // å‘é€è¿›å…¥ç¼–è¾‘çŠ¶æ€çš„æ¶ˆæ¯
    websocket.sendMessage({
      type: PICTURE_EDIT_MESSAGE_TYPE_ENUM.ENTER_EDIT,
    })
  }
}

// é€€å‡ºç¼–è¾‘çŠ¶æ€
const exitEdit = () => {
  if (websocket) {
    // å‘é€é€€å‡ºç¼–è¾‘çŠ¶æ€çš„æ¶ˆæ¯
    websocket.sendMessage({
      type: PICTURE_EDIT_MESSAGE_TYPE_ENUM.EXIT_EDIT,
    })
  }
}

// ç¼–è¾‘å›¾ç‰‡æ“ä½œ
const editAction = (action: string) => {
  if (websocket) {
    // å‘é€ç¼–è¾‘æ“ä½œçš„è¯·æ±‚
    websocket.sendMessage({
      type: PICTURE_EDIT_MESSAGE_TYPE_ENUM.EDIT_ACTION,
      editAction: action,
    })
  }
}
```

æ‰€æœ‰ç¼–è¾‘å›¾ç‰‡çš„æ“ä½œéƒ½è¦è¡¥å……ä¸Šå‘é€ WebSocket æ¶ˆæ¯ï¼š

```typescript
// å‘å·¦æ—‹è½¬
const rotateLeft = () => {
  cropperRef.value.rotateLeft()
  editAction(PICTURE_EDIT_ACTION_ENUM.ROTATE_LEFT)
}

// å‘å³æ—‹è½¬
const rotateRight = () => {
  cropperRef.value.rotateRight()
  editAction(PICTURE_EDIT_ACTION_ENUM.ROTATE_RIGHT)
}

// ç¼©æ”¾
const changeScale = (num: number) => {
  cropperRef.value.changeScale(num)
  if (num > 0) {
    editAction(PICTURE_EDIT_ACTION_ENUM.ZOOM_IN)
  } else {
    editAction(PICTURE_EDIT_ACTION_ENUM.ZOOM_OUT)
  }
}
```

### 4ã€ååŒç¼–è¾‘èŒƒå›´æ§åˆ¶

åªæœ‰å›¢é˜Ÿç©ºé—´æ‰æ”¯æŒåä½œç¼–è¾‘ï¼Œå¦åˆ™è¿˜æ˜¯è·Ÿä¹‹å‰ä¸€æ ·ï¼Œé»˜è®¤å°±è¿›å…¥å¯ç¼–è¾‘çŠ¶æ€ã€‚

ä¸ºæ­¤ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ `ImageCropper` ç»„ä»¶ä¸­è·å–åˆ°ç©ºé—´ä¿¡æ¯ï¼Œå¹¶åˆ¤æ–­æ˜¯å¦ä¸ºå›¢é˜Ÿç©ºé—´ã€‚

1ï¼‰å¯ä»¥ç”±å¼•å…¥è¯¥ç»„ä»¶çš„çˆ¶é¡µé¢ `AddPicturePage` è·å–ç©ºé—´ä¿¡æ¯ï¼š

```typescript
const space = ref<API.SpaceVO>()

// è·å–ç©ºé—´ä¿¡æ¯
const fetchSpace = async () => {
  // è·å–æ•°æ®
  if (spaceId.value) {
    const res = await getSpaceVoByIdUsingGet({
      id: spaceId.value,
    })
    if (res.data.code === 0 && res.data.data) {
      space.value = res.data.data
    }
  }
}

watchEffect(() => {
  fetchSpace()
})
```

ç„¶åä¼ å…¥ç»™ç»„ä»¶ï¼š

```typescript
<ImageCropper
  ref="imageCropperRef"
  :imageUrl="picture?.url"
  :picture="picture"
  :spaceId="spaceId"
  :space="space"
  :onSuccess="onSuccess"
/>
```

2ï¼‰åœ¨å›¾ç‰‡ç¼–è¾‘ç»„ä»¶ä¸­æ–°å¢ space å±æ€§ï¼š

```typescript
interface Props {
  imageUrl?: string
  picture?: API.PictureVO
  spaceId?: number
  space?: API.SpaceVO
  onSuccess?: (newPicture: API.PictureVO) => void
}
```

ç„¶åå°±å¯ä»¥æ ¹æ® space åˆ¤æ–­æ˜¯å¦ä¸ºå›¢é˜Ÿç©ºé—´äº†ï¼Œå®šä¹‰ä¸€ä¸ªå˜é‡ä¾¿äºå¤ç”¨ï¼š

```typescript
// æ˜¯å¦ä¸ºå›¢é˜Ÿç©ºé—´
const isTeamSpace = computed(() => {
  return props.space?.spaceType === SPACE_TYPE_ENUM.TEAM;
})
```

3ï¼‰ä½¿ç”¨è¯¥å˜é‡æ¥æ§åˆ¶ååŒç¼–è¾‘çš„èŒƒå›´ï¼ŒåŒ…æ‹¬æ˜¯å¦å¯ç¼–è¾‘ã€æ˜¯å¦åˆå§‹åŒ– WebSocket è¿æ¥ï¼š

```typescript
// å¯ä»¥ç¼–è¾‘
const canEdit = computed(() => {
  // ä¸æ˜¯å›¢é˜Ÿç©ºé—´ï¼Œåˆ™é»˜è®¤å¯ç¼–è¾‘
  if (!isTeamSpace.value) {
    return true
  }
  return editingUser.value?.id === loginUser.id
})

watchEffect(() => {
  // å›¢é˜Ÿç©ºé—´æ‰åˆå§‹åŒ–
  if (isTeamSpace.value) {
    initWebsocket()
  }
})
```

ä»¥åŠæ˜¯å¦å±•ç¤ºååŒç¼–è¾‘æ“ä½œçš„æŒ‰é’®ï¼š

```vue
<!-- ååŒç¼–è¾‘æ“ä½œ -->
<div class="image-edit-actions" v-if="isTeamSpace">
</div>
```

### 5ã€æµ‹è¯•

OKï¼Œæ¥ä¸‹æ¥å°±å¯ä»¥æ„‰å¿«åœ°æµ‹è¯•äº†ã€‚å¯ä»¥ä¾æ¬¡éªŒè¯ï¼š

1. ç¼–è¾‘åŠŸèƒ½æ˜¯å¦å¯ä»¥æ­£å¸¸ä½¿ç”¨ï¼Œèƒ½å¦æ­£å¸¸è¿›å…¥å’Œé€€å‡ºç¼–è¾‘çŠ¶æ€ã€å¹¶ä¿å­˜å›¾ç‰‡
2. éªŒè¯èµ„æºèƒ½å¦æ­£å¸¸é‡Šæ”¾
3. éªŒè¯ç”¨æˆ·ç¼–è¾‘æ—¶ï¼Œå…¶ä»–ç”¨æˆ·èƒ½å¦å®æ—¶æŸ¥çœ‹åˆ°æ•ˆæœ
4. éªŒè¯ç”¨æˆ·ç¼–è¾‘æ—¶ï¼Œå…¶ä»–ç”¨æˆ·æ˜¯å¦å¯ä»¥ç¼–è¾‘
5. éªŒè¯ç”¨æˆ· A é€€å‡ºç¼–è¾‘æˆ–å…³é—­å¼¹çª—åï¼Œå…¶ä»–ç”¨æˆ·æ˜¯å¦å¯ä»¥è¿›å…¥ç¼–è¾‘ï¼›ç”¨æˆ· A å†æ¬¡è¿›å…¥æ—¶ï¼Œèƒ½å¦è·Ÿå…¶ä»–ç”¨æˆ·çš„æ“ä½œä¿æŒåŒæ­¥ã€‚

æ•ˆæœå¦‚å›¾ï¼š

![img](assets/qfGuwnA6naWypcpO.webp)

### æ‰©å±•

1ã€æ”¯æŒ WebSocket æ–­çº¿é‡è¿ï¼Œåº”å¯¹æœåŠ¡å™¨çªç„¶å®•æœºçš„æƒ…å†µ

2ã€å¦‚æœæ²¡æœ‰ç”¨æˆ·è¿›å…¥ç¼–è¾‘çŠ¶æ€ï¼Œæ‰“å¼€å›¾ç‰‡ç¼–è¾‘å¼¹çª—æ—¶è‡ªåŠ¨è¿›å…¥ç¼–è¾‘ï¼Œä¸éœ€è¦æ‰‹åŠ¨ç‚¹å‡»æŒ‰é’®è¿›å…¥ç¼–è¾‘

3ã€æ–°å¢ä¸€ä¸ªâ€œç”¨æˆ·ä¿å­˜â€äº‹ä»¶ï¼ŒæŸç”¨æˆ·ç‚¹å‡»ä¿å­˜åï¼Œå…³é—­å…¶ä»–ç”¨æˆ·çš„ç¼–è¾‘å¼¹çª—ï¼Œå¹¶ä¸”æ›´æ–°å½“å‰å±•ç¤ºçš„å›¾ç‰‡

4ã€å¯èƒ½è¿˜ä¼šæœ‰ä¸€äº›ç»†èŠ‚é—®é¢˜ï¼Œæ¯”å¦‚æ–°ç”¨æˆ·æ‰“å¼€ç¼–è¾‘å¼¹çª—æ—¶ï¼Œæ— æ³•è·å–åˆ°æ­£åœ¨ç¼–è¾‘çš„ç”¨æˆ·ä¿¡æ¯ã€ä¹Ÿæ— æ³•è·å–åˆ°å½“å‰å·²ç¼–è¾‘çš„å›¾ç‰‡çŠ¶æ€ï¼Œå¤§å®¶å¯ä»¥è‡ªè¡Œæµ‹è¯•å’Œä¼˜åŒ–ã€‚

5ã€å¯ä»¥é€šè¿‡ä¼ é€’ CSS æ ·å¼çš„æ–¹å¼å®ç°è£åˆ‡æ¡†åŒºåŸŸçš„å®æ—¶åä½œã€‚ä½†å…¶å®ç§»åŠ¨ç¼–è¾‘æ¡†æ—¶å¹¶æ²¡æœ‰ä¿®æ”¹å›¾ç‰‡ï¼Œæ‰€ä»¥ä½œç”¨ä¸æ˜¯å¾ˆå¤§ã€‚

------

ä»¥ä¸Šå°±æ˜¯æœ¬æœŸæ•™ç¨‹ï¼Œå¸Œæœ›å¤§å®¶é€šè¿‡è¿™äº›ç¤ºä¾‹å›¾ç‰‡ååŒç¼–è¾‘æ“ä½œï¼Œå­¦ä¼šå®æ—¶ååŒä¸šåŠ¡çš„è®¾è®¡å’Œå¼€å‘æ–¹æ³•ï¼Œä»¥åå¼€å‘æ›´å¤æ‚çš„å®æ—¶åä½œç³»ç»Ÿéƒ½æ˜¯ç±»ä¼¼çš„~









# 13 - DDD é‡æ„

## æœ¬èŠ‚é‡ç‚¹

ä¹‹å‰æˆ‘ä»¬å·²ç»å®Œæˆäº†æœ¬é¡¹ç›®çš„åŠŸèƒ½å¼€å‘ã€‚ç”±äºæœ¬é¡¹ç›®åŠŸèƒ½ä¸°å¯Œã€ä»£ç é‡å¤§ï¼Œå¦‚æœæ˜¯åœ¨ä¼ä¸šä¸­ç»´æŠ¤å¼€å‘çš„é¡¹ç›®ï¼Œä¼ ç»Ÿçš„ MVC æ¶æ„å¯èƒ½ä¼šè®©åç»­çš„å¼€å‘åä½œè¶Šæ¥è¶Šå›°éš¾ã€‚æ‰€ä»¥æœ¬èŠ‚é±¼çš®è¦ä» 0 å¸¦å¤§å®¶å­¦ä¹ ä¸€ç§æ–°çš„æ¶æ„è®¾è®¡æ¨¡å¼ â€”â€” DDD é¢†åŸŸé©±åŠ¨è®¾è®¡ã€‚

å¤§çº²ï¼š

- è½¯ä»¶æ¶æ„æ¨¡å¼çš„æ¼”è¿›
- DDD é¢†åŸŸé©±åŠ¨è®¾è®¡æ¦‚å¿µ
- DDD æ¶æ„è®¾è®¡
- é¡¹ç›® DDD é‡æ„

é€šè¿‡æœ¬èŠ‚ï¼Œä½ å°†æŒæ¡ DDD é¢†åŸŸé©±åŠ¨æ¶æ„è®¾è®¡ï¼ŒæŒæ¡å¿«é€Ÿçš„ã€æ ‡å‡†çš„ã€é€šç”¨çš„é‡æ„ä¼ ç»Ÿ MVC é¡¹ç›®ä¸º DDD æ¶æ„é¡¹ç›®çš„æ–¹æ³•ï¼Œå­¦ä¼šä¹‹åå‡ ä¹ä»»ä½•é¡¹ç›®éƒ½èƒ½è½»æ¾æ”¹é€ ä¸º DDD é¡¹ç›®ã€‚

## ä¸€ã€è½¯ä»¶æ¶æ„æ¨¡å¼çš„æ¼”è¿›

åœ¨å­¦ä¹  DDD ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆçŸ¥æ™“è½¯ä»¶æ¶æ„æ¨¡å¼çš„æ¼”è¿›ä¹‹è·¯ã€‚

ä¸ºäº†åº”å¯¹è½¯ä»¶ç³»ç»Ÿæ—¥ç›Šå¤æ‚åŒ–çš„éœ€æ±‚ï¼Œä»æœ€åˆçš„ç®€å•ä¼ ç»Ÿå•ä½“æ¶æ„åˆ°å¦‚ä»Šå¤æ‚çš„åˆ†å¸ƒå¼å’Œå¾®æœåŠ¡æ¶æ„ï¼Œè½¯ä»¶æ¶æ„çš„æ¼”å˜ç»å†äº†å¤šä¸ªé˜¶æ®µï¼Œä¸»è¦æœ‰ä»¥ä¸‹ä¸‰ä¸ªå…¸å‹é˜¶æ®µï¼š

### ä¼ ç»Ÿå•ä½“æ¶æ„

æ‰€æœ‰çš„åº”ç”¨åŠŸèƒ½éƒ½é›†æˆåœ¨ä¸€ä¸ªå•ä¸€çš„åº”ç”¨ç¨‹åºä¸­ï¼Œæ‰€æœ‰æ¨¡å—å’Œç»„ä»¶éƒ½åœ¨åŒä¸€ä¸ªè¿›ç¨‹å†…è¿è¡Œï¼Œè¯·æ±‚ç›´æ¥æ“ä½œæ•°æ®åº“ï¼Œä¸è¿›è¡Œä»£ç åˆ†å±‚ï¼Œæ˜“äºå¼€å‘å’Œéƒ¨ç½²ï¼Œå°¤å…¶é€‚åˆå°å‹æˆ–ç®€å•çš„åº”ç”¨ã€‚

éšç€ä¸šåŠ¡å¢é•¿å’Œéœ€æ±‚å˜æ›´ï¼Œå•ä½“æ¶æ„å˜å¾—éš¾ä»¥æ‰©å±•å’Œç»´æŠ¤ã€‚ä¸åŒåŠŸèƒ½çš„æ¨¡å—è€¦åˆåœ¨ä¸€èµ·ï¼Œå¯¼è‡´æ›´æ–°æŸä¸ªåŠŸèƒ½å¯èƒ½å½±å“åˆ°æ•´ä¸ªç³»ç»Ÿã€‚

![img](assets/FoNugm2bROzeGac0.webp)

### åˆ†å±‚æ¶æ„

åº”ç”¨è¢«åˆ’åˆ†ä¸ºä¸åŒçš„å±‚ï¼ˆå¦‚ä¸šåŠ¡æ¥å…¥å±‚ã€ä¸šåŠ¡é€»è¾‘å±‚ã€æ•°æ®è®¿é—®å±‚ç­‰ï¼‰ï¼Œæ¯ä¸€å±‚è´Ÿè´£ç‰¹å®šçš„åŠŸèƒ½ï¼Œå±‚ä¸å±‚ä¹‹é—´é€šè¿‡æ¥å£è¿›è¡Œäº¤äº’ï¼Œä¿ƒè¿›äº†æ¨¡å—åŒ–å’ŒèŒè´£åˆ†ç¦»ï¼Œä¾¿äºç®¡ç†å’Œç»´æŠ¤ã€‚

ä½†å±‚ä¸å±‚ä¹‹é—´çš„ç´§å¯†è€¦åˆé™åˆ¶äº†çµæ´»æ€§ï¼Œä¸”éšç€ç³»ç»Ÿçš„å¤æ‚åº¦å¢åŠ ï¼Œå¯èƒ½å¯¼è‡´æ€§èƒ½ä¸‹é™å’Œç»´æŠ¤éš¾åº¦å¢åŠ ï¼Œå¹¶ä¸”å®ƒçš„å¯æ‰©å±•æ€§å’Œå¼¹æ€§ä¼¸ç¼©æ€§å·®ã€‚

![img](assets/U7BixyZLi9YRzY4R.webp)

### å¾®æœåŠ¡æ¶æ„

å°†ç³»ç»Ÿæ‹†åˆ†ä¸ºå¤šä¸ªå°è€Œç‹¬ç«‹çš„æœåŠ¡ï¼Œæ¯ä¸ªæœåŠ¡è´Ÿè´£å¤„ç†ä¸€ç»„ç‰¹å®šçš„åŠŸèƒ½ï¼Œæ¯ä¸ªæœåŠ¡é€šå¸¸ç”±ç‹¬ç«‹çš„å›¢é˜Ÿå¼€å‘ã€éƒ¨ç½²å’Œç»´æŠ¤ï¼ŒæœåŠ¡ä¹‹é—´é€šè¿‡è½»é‡çº§åè®®ï¼ˆå¦‚ HTTPã€è‡ªå®šä¹‰åè®®æˆ–æ¶ˆæ¯é˜Ÿåˆ—ï¼‰è¿›è¡Œé€šä¿¡ã€‚

æœåŠ¡ä¹‹é—´ç‹¬ç«‹ï¼Œæ˜“äºæ‰©å±•å’Œç»´æŠ¤ã€‚æ¯ä¸ªå¾®æœåŠ¡éƒ½å¯ä»¥ç‹¬ç«‹éƒ¨ç½²ã€å¼€å‘å’Œæ‰©å±•ï¼Œä¸”æ˜“äºä½¿ç”¨ä¸åŒçš„æŠ€æœ¯æ ˆã€‚

![img](assets/2JQqmcomgyjtorrS.webp)

## äºŒã€DDD é¢†åŸŸé©±åŠ¨è®¾è®¡æ¦‚å¿µ

### ä»€ä¹ˆæ˜¯ DDDï¼Ÿ

DDDï¼ˆé¢†åŸŸé©±åŠ¨è®¾è®¡ï¼ŒDomain-Driven Designï¼‰ **æ˜¯ä¸€ç§è½¯ä»¶å¼€å‘æ–¹æ³•è®ºå’Œè®¾è®¡æ€æƒ³**ã€‚DDD é€šè¿‡é¢†åŸŸé©±åŠ¨è®¾è®¡æ–¹æ³•å®šä¹‰é¢†åŸŸæ¨¡å‹ï¼Œ**ä»è€Œç¡®å®šä¸šåŠ¡å’Œåº”ç”¨çš„è¾¹ç•Œ**ï¼Œä¿è¯ä¸šåŠ¡æ¨¡å‹å’Œä»£ç æ¨¡å‹çš„ä¸€è‡´æ€§ã€‚

å› ä¸º DDD ä¸»è¦åº”ç”¨åœ¨å¾®æœåŠ¡æ¶æ„åœºæ™¯ï¼Œæ‰€ä»¥æƒ³è¦æ›´å¥½çš„ç†è§£ DDD çš„æ¦‚å¿µï¼Œéœ€è¦ç»“åˆå¾®æœåŠ¡æ¶æ„æ¥çœ‹ï¼š

- DDD æ˜¯ä¸€ç§è®¾è®¡æ€æƒ³ï¼Œ**ç¡®å®šä¸šåŠ¡å’Œåº”ç”¨çš„è¾¹ç•Œ**
- å¾®æœåŠ¡æ¶æ„éœ€è¦ **å°†ç³»ç»Ÿæ‹†åˆ†ä¸ºå¤šä¸ªå°è€Œç‹¬ç«‹çš„æœåŠ¡**

æ˜¯ä¸æ˜¯æœ‰ç‚¹æ„Ÿè§‰äº†ï¼Ÿå·²ç»çŸ¥é“ DDD æ˜¯ç”¨æ¥åšä»€ä¹ˆçš„äº†ï¼Ÿ

å¾®æœåŠ¡çš„æ‹†åˆ†ä¸€ç›´æ˜¯ä¸šç•Œçš„ä¸€ä¸ªéš¾é¢˜ï¼šå¾®æœåŠ¡æ‹†åˆ†çš„ç²’åº¦åº”è¯¥å¤šå¤§ï¼ŸæœåŠ¡åˆ°åº•åº”è¯¥å¦‚ä½•æ‹†åˆ†ï¼ŸæœåŠ¡ä¹‹é—´çš„è¾¹ç•Œå¦‚ä½•å®šä¹‰ï¼Ÿ

æœ‰äººå¯èƒ½è®¤ä¸ºï¼Œå¾®æœåŠ¡ä¸å°±æ˜¯æ‹†å°±å®Œäº‹äº†ï¼Ÿä¸éœ€è¦ç®¡é‚£ä¹ˆå¤šï¼å®é™…ä¸Šå¾®æœåŠ¡çš„æ‹†åˆ†æ˜¯é—¨ â€œè‰ºæœ¯â€ï¼š

- æœåŠ¡æ‹†åˆ†çš„å¤ªç»†ï¼Œé¡¹ç›®å¤æ‚åº¦ä¼šè¿‡é«˜ï¼Œæ¥å£çš„è°ƒç”¨æˆæœ¬ã€æœåŠ¡è¿ç»´æˆæœ¬å¤§å¹…ä¸Šå‡ã€‚
- æœåŠ¡æ‹†åˆ†çš„å¤ªç²—ï¼Œä¸šåŠ¡è¾¹ç•Œå˜å¾—æ¨¡ç³Šï¼ŒæœåŠ¡çš„è€¦åˆåº¦è¿˜æ˜¯è¿‡é«˜ï¼Œå¤±å»äº†å¾®æœåŠ¡çš„ä¼˜åŠ¿ã€‚

è€Œ DDD å°±æ˜¯ä¸€ä¸ªæ–¹æ³•è®ºï¼ŒæŒ‡å¯¼æˆ‘ä»¬æ ¹æ®é¢†åŸŸæ¨¡å‹ç¡®å®šä¸šåŠ¡çš„è¾¹ç•Œï¼Œä»è€Œåˆ’åˆ†å‡ºåº”ç”¨çš„è¾¹ç•Œï¼Œæœ€ç»ˆè½å®æˆæœåŠ¡çš„è¾¹ç•Œã€ä»£ç çš„è¾¹ç•Œã€‚

æœ¬è¯¾ç¨‹è™½ç„¶æ²¡æœ‰æ¶‰åŠåˆ°å¾®æœåŠ¡ï¼Œä½†æ˜¯ä¸å¦¨ç¢åˆ©ç”¨ DDD æ€æƒ³æ‹†åˆ†ä»£ç æ¶æ„ã€‚æœ€ç»ˆæƒ³è¦å˜æˆå¾®æœåŠ¡æ¶æ„ä»…éœ€æŠ½ç¦»åŒ…ä¸­çš„ä»£ç ç‹¬ç«‹éƒ¨ç½²å³å¯ã€‚

#### DDD çš„ç›®æ ‡

1. é€šè¿‡é¢†åŸŸæ¨¡å‹å®ç°ä¸šåŠ¡éœ€æ±‚ï¼šå¼€å‘è€…ä¸é¢†åŸŸä¸“å®¶å…±åŒç†è§£ä¸šåŠ¡éœ€æ±‚ï¼Œå½¢æˆå…±äº«è¯­è¨€å¹¶æ„å»ºæ¨¡å‹ã€‚
2. æé«˜ç³»ç»Ÿçš„çµæ´»æ€§ä¸å¯ç»´æŠ¤æ€§ï¼šé€šè¿‡åˆç†åˆ’åˆ†é™ç•Œä¸Šä¸‹æ–‡ï¼Œå‡å°‘ç³»ç»Ÿçš„è€¦åˆåº¦ï¼Œä½¿å¾—ä¸åŒæ¨¡å—æˆ–å­ç³»ç»Ÿå¯ä»¥ç‹¬ç«‹æ¼”åŒ–ã€‚
3. æ”¯æŒå¤æ‚ä¸šåŠ¡é€»è¾‘çš„è¡¨è¾¾ï¼šé€šè¿‡æ·±å…¥çš„ä¸šåŠ¡å»ºæ¨¡ï¼Œä½¿å¾—å¤æ‚çš„ä¸šåŠ¡é€»è¾‘èƒ½å¤Ÿæ¸…æ™°ã€å‡†ç¡®åœ°åæ˜ åœ¨ä»£ç ä¸­ã€‚

**æ€»ç»“ä¸€ä¸‹ï¼Œå°±æ˜¯è®©ç³»ç»Ÿæ›´è´´åˆä¸šåŠ¡ï¼Œè®©å¤§å‹ç³»ç»Ÿæ›´åˆ©äºç‹¬ç«‹å»ºè®¾å’Œç»´æŠ¤ã€‚**

#### DDD çš„é€‚ç”¨åœºæ™¯

- ä¸šåŠ¡å¤æ‚çš„ç³»ç»Ÿï¼šå¦‚é‡‘èç³»ç»Ÿã€ç”µå•†å¹³å°ç­‰ï¼Œæ¶‰åŠçš„ä¸šåŠ¡é€»è¾‘å¤æ‚ä¸”é¢‘ç¹å˜åŒ–ã€‚
- éœ€è¦ä¸å¤šä¸ªéƒ¨é—¨æˆ–å›¢é˜Ÿåˆä½œçš„é¡¹ç›®ï¼šDDD å¼ºè°ƒè·¨éƒ¨é—¨åä½œï¼Œé€‚ç”¨äºå¤šæ–¹å‚ä¸çš„å¤§å‹é¡¹ç›®ã€‚
- é•¿å‘¨æœŸã€é•¿æœŸç»´æŠ¤çš„é¡¹ç›®ï¼šDDD å¼ºè°ƒå¯ç»´æŠ¤æ€§ä¸æ¼”åŒ–ï¼Œé€‚åˆéœ€è¦é•¿æœŸç»´æŠ¤å’Œæ‰©å±•çš„ç³»ç»Ÿã€‚

**æ€»ç»“ä¸€ä¸‹ï¼Œå¤§å‹çš„ã€è·¨éƒ¨é—¨åä½œçš„ã€é•¿æœŸç»´æŠ¤çš„å¤æ‚é¡¹ç›®ã€‚**

### DDD çš„å»ºè®¾

DDD ä¼šå…ˆå»ºç«‹é¢†åŸŸæ¨¡å‹ï¼Œæ ¹æ®ä¸šåŠ¡åˆ’åˆ†é¢†åŸŸè¾¹ç•Œï¼Œè¿›è€Œç¡®å®šå¾®æœåŠ¡çš„è¾¹ç•Œï¼Œç„¶åå†æ ¹æ®é¢†åŸŸåˆ†å—ç¼–ç å®ç°ã€‚

å®é™…ä¸Š DDD çš„å»ºè®¾åŒ…æ‹¬ **æˆ˜ç•¥è®¾è®¡** å’Œ **æˆ˜æœ¯è®¾è®¡** ä¸¤éƒ¨åˆ†ã€‚

ä¸‹é¢è¿™äº›å†…å®¹å¯¹æ²¡æœ‰å‚åŠ è¿‡ä¼ä¸šå·¥ä½œçš„åŒå­¦æ¥è¯´ä¼šæœ‰äº›éš¾ç†è§£ï¼Œå­¦ä¹ æ—¶å¯ä»¥è·³è¿‡ã€‚

#### æˆ˜ç•¥è®¾è®¡

ä»ä¸šåŠ¡å‡ºå‘ï¼Œå»ºç«‹é¢†åŸŸæ¨¡å‹ï¼Œç»Ÿä¸€é™ç•Œä¸Šä¸‹æ–‡ã€‚

è®¾è®¡æ—¶ï¼Œéœ€è¦å…ˆè¿›è¡Œäº‹ä»¶é£æš´ï¼ˆç±»ä¼¼äºå¤´è„‘é£æš´ï¼‰ï¼Œé‚€è¯·é¢†åŸŸä¸“å®¶ã€æ¶æ„å¸ˆã€å¼€å‘äººå‘˜ã€æµ‹è¯•äººå‘˜ã€äº§å“ç»ç†ã€é¡¹ç›®ç»ç†ç­‰å›¢é˜Ÿäººå‘˜ä¸€èµ·å‚åŠ è®¨è®ºã€‚

æè¿°ä¸ªåœºæ™¯ï¼Œå¤§å®¶åœ¨ä¼šè®®å®¤é‡Œï¼Œæä¸€ä¸ªå¤§ç™½æ¿ï¼Œå‚ä¸è€…ä»¬å°†è‡ªå·±çš„æƒ³æ³•å’Œæ„è§å†™åœ¨è´´çº¸é‡Œå¹¶ç½—åˆ—åˆ°ç™½æ¿ä¸Šï¼Œå¤§å®¶ **å…ˆå‘æ•£æ€ç»´** è¿›è¡Œè®¨è®ºã€è®°å½•ã€‚

ä¸»è¦è®¨è®ºçš„å†…å®¹æ˜¯ï¼šç³»ç»Ÿä¼šæ¶‰åŠå“ªäº›ä¸šåŠ¡ï¼Œå“ªä¸ªä¸šåŠ¡åŠ¨ä½œä¼šè§¦å‘å¦ä¸€ä¸ªä¸šåŠ¡çš„ä»€ä¹ˆåŠ¨ä½œï¼Œå…¶é—´çš„è¾“å…¥æ˜¯ä»€ä¹ˆï¼Ÿè¾“å‡ºæ˜¯ä»€ä¹ˆï¼Ÿ

é€šè¿‡è¿™ç±»åˆ†ææŠŠæ‰€æœ‰çš„ä¸šåŠ¡ã€ä¸šåŠ¡è¡Œä¸ºã€ä¸šåŠ¡ç»“æœéƒ½ç½—åˆ—å‡ºæ¥ï¼Œæ‹†åˆ†å‡ºé¢†åŸŸæ¨¡å‹ä¸­çš„äº‹ä»¶ã€å‘½ä»¤ã€å®ä½“ç­‰é¢†åŸŸå¯¹è±¡ã€‚ç„¶åæ¢³ç†è¿™äº›é¢†åŸŸå¯¹è±¡ä¹‹é—´çš„å…³ç³»ï¼Œä»ä¸åŒç»´åº¦è¿›è¡Œèšç±»ï¼Œå½¢æˆèšåˆã€èšåˆæ ¹ã€é™ç•Œä¸Šä¸‹æ–‡ç­‰ï¼Œè¿™ä¸ªè¿‡ç¨‹å°±æ˜¯ **æ”¶æ•›ã€‚** é™ç•Œä¸Šä¸‹æ–‡å¯ä»¥ç®€å•ç†è§£ä¸ºå¾®æœåŠ¡çš„è¾¹ç•Œï¼Œå°†å…¶æ˜ å°„åˆ°ä»£ç æ¨¡å‹ï¼Œå°±å®Œæˆäº†å¾®æœåŠ¡çš„æ‹†åˆ†ã€‚

ğŸ’¡ äº‹ä»¶é£æš´å®é™…ä¸Šä¼šåˆ©ç”¨å¸¸è§çš„äº§å“è®¾è®¡å’Œç”¨æˆ·ä½“éªŒåˆ†ææ–¹æ³•ï¼Œæ¯”å¦‚ï¼š

- ç”¨ä¾‹åˆ†æï¼šå¯¹ç³»ç»ŸåŠŸèƒ½éœ€æ±‚è¿›è¡Œæè¿°ï¼Œä»¥ç¡®å®šç³»ç»Ÿå¦‚ä½•ä¸å¤–éƒ¨å‚ä¸è€…ï¼ˆå³ç”¨æˆ·æˆ–å…¶ä»–ç³»ç»Ÿï¼‰è¿›è¡Œäº¤äº’
- åœºæ™¯åˆ†æï¼šé€šè¿‡è®¾å®šå…·ä½“çš„æƒ…å¢ƒæˆ–æƒ…æ™¯ï¼Œæ¥æ¢è®¨ç”¨æˆ·å¦‚ä½•åœ¨ä¸åŒçš„ç¯å¢ƒä¸‹ä½¿ç”¨äº§å“æˆ–ç³»ç»Ÿ
- ç”¨æˆ·æ—…ç¨‹åˆ†æï¼šä»ç”¨æˆ·çš„è§’åº¦ï¼Œæç»˜ç”¨æˆ·åœ¨ä½¿ç”¨äº§å“æˆ–æœåŠ¡çš„è¿‡ç¨‹ä¸­ï¼Œä»å¼€å§‹åˆ°ç»“æŸçš„ä¸€ç³»åˆ—æ­¥éª¤æˆ–è¡Œä¸º

#### æˆ˜æœ¯è®¾è®¡

ä»æŠ€æœ¯å®ç°å‡ºå‘ï¼Œå°†é¢†åŸŸæ¨¡å‹å’Œä»£ç æ¨¡å‹è¿›è¡Œæ˜ å°„

è¿™ä¸ªé˜¶æ®µå°±æ˜¯å®Œæˆä»£ç è½åœ°ï¼ŒåŒ…æ‹¬èšåˆã€èšåˆæ ¹ã€å®ä½“ã€å€¼å¯¹è±¡ç­‰ä»£ç é€»è¾‘çš„è®¾è®¡ä¸å®ç°ã€‚

### DDD ä½“ç³»åè¯è§£æ

#### 1ã€é¢†åŸŸ

é¢†åŸŸæŒ‡ç³»ç»Ÿå…³æ³¨çš„ä¸šåŠ¡é¢†åŸŸæˆ–é—®é¢˜ç©ºé—´ï¼Œå…·ä½“çš„é¢†åŸŸä¸å…¬å¸æˆ–ç»„ç»‡çš„æ ¸å¿ƒä¸šåŠ¡æœ‰å…³ã€‚

å®é™…ä¸Šåœ¨ DDD ä¸­ **é¢†åŸŸå°±æ˜¯ç”¨æ¥ç¡®å®šèŒƒå›´**ï¼Œè€ŒèŒƒå›´å°±æ˜¯è¾¹ç•Œã€‚

ä¸€ä¸ªé¢†åŸŸåˆå¯ä»¥åˆ†ä¸ºå¤šä¸ªå­é¢†åŸŸï¼Œæ¯ä¸ªå­é¢†åŸŸä»£è¡¨ç³»ç»Ÿçš„ä¸€éƒ¨åˆ†ä¸šåŠ¡ã€‚

è€Œå­åŸŸæ ¹æ®é‡è¦ç¨‹åº¦å’ŒåŠŸèƒ½ç‰¹æ€§ï¼Œå¯åˆ’åˆ†ä¸ºï¼š

- é€šç”¨åŸŸï¼šæŒ‡ç³»ç»Ÿä¸­ä¸€äº›é€šç”¨çš„ã€ä¸ç‰¹å®šäºæŸä¸€ä¸šåŠ¡çš„é¢†åŸŸï¼Œå®ƒä»¬åœ¨å¤šä¸ªä¸åŒé¢†åŸŸæˆ–ç³»ç»Ÿä¸­éƒ½æœ‰åº”ç”¨ã€‚ï¼ˆä¾‹å¦‚æ”¯ä»˜ã€æ—¥å¿—ç®¡ç†ï¼‰
- æ”¯æ’‘åŸŸï¼šæŒ‡åœ¨ç³»ç»Ÿä¸­èµ·åˆ°æ”¯æŒä½œç”¨ï¼Œä½†å¹¶ä¸æ˜¯ç›´æ¥é©±åŠ¨ä¸šåŠ¡ä»·å€¼çš„éƒ¨åˆ†ï¼ˆä¾‹å¦‚ç½‘å…³ï¼‰
- æ ¸å¿ƒåŸŸï¼šæŒ‡ç³»ç»Ÿä¸­æœ€å…³é”®çš„éƒ¨åˆ†ï¼Œæ˜¯ä¸šåŠ¡çš„æ ¸å¿ƒç«äº‰åŠ›æ‰€åœ¨ï¼Œèƒ½å¤Ÿä¸ºä¼ä¸šå¸¦æ¥æœ€å¤§çš„ä»·å€¼

ğŸ’¡ è¿™é‡Œéœ€è¦æ³¨æ„ï¼Œåœ¨ä¸åŒä¸šåŠ¡ï¼ˆå…¬å¸ä¸­ï¼‰ä¸‰ç±»å­åŸŸæ˜¯æœ‰åŒºåˆ«çš„ï¼Œä¾‹å¦‚åœ¨æ™®é€šå…¬å¸ä¸­éœ€è¦è°ƒç”¨ç¬¬ä¸‰æ–¹æ”¯ä»˜ï¼Œé‚£ä¹ˆæ”¯ä»˜æ˜¯é€šç”¨åŸŸï¼Œä½†æ˜¯å¯¹äºæ”¯ä»˜å…¬å¸ï¼ˆä¾‹å¦‚æ”¯ä»˜å®ï¼‰æ¥è¯´æ”¯ä»˜æ˜¯å®ƒä»¬çš„æ ¸å¿ƒåŸŸã€‚

#### 2ã€é™ç•Œä¸Šä¸‹æ–‡

æ˜¯æŒ‡ä¸€ä¸ªæ˜ç¡®çš„è¾¹ç•Œï¼Œè§„å®šäº†æŸä¸ªå­é¢†åŸŸçš„ä¸šåŠ¡æ¨¡å‹å’Œè¯­è¨€ï¼Œç¡®ä¿åœ¨è¯¥ä¸Šä¸‹æ–‡å†…çš„æœ¯è¯­ã€è§„åˆ™ã€æ¨¡å‹ä¸ä¸å…¶ä»–ä¸Šä¸‹æ–‡å†²çªã€‚

åœ¨äº‹ä»¶é£æš´è®¨è®ºè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬éœ€è¦å®Œæˆé€šç”¨è¯­è¨€çš„ç»Ÿä¸€ã€‚ä¾‹å¦‚ç”µå•†åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬ç»Ÿä¸€å«ç‰©å“ä¸ºå•†å“ã€å°†ç”¨æˆ·è´­ä¹°å•†å“çš„è¡Œä¸ºå«ä¸‹å•ã€‚

æˆ‘ä»¬éƒ½çŸ¥é“è¯­è¨€éœ€è¦æœ‰è¯­ä¹‰ç¯å¢ƒã€‚ä¸åŒè¯­ä¹‰ç¯å¢ƒä¸‹ï¼ŒåŒä¸€ä¸ªè¯­è¨€è¡¨è¾¾çš„æ„æ€æ˜¯ä¸åŒçš„ã€‚æ¯”å¦‚ï¼š

- â€œæˆ‘åƒå¾—å¾ˆé¥±ï¼Œç°åœ¨ä¸èƒ½åŠ¨äº†â€ï¼šè¿™é‡Œçš„â€œåƒå¾—å¾ˆé¥±â€è¡¨ç¤ºçš„æ˜¯ â€œåƒåˆ°è‚šå­å¾ˆæ»¡â€ï¼Œå­—é¢æ„æ€æ˜¯ â€œæˆ‘å·²ç»åƒå¾—å¾ˆé¥±äº†ï¼Œåƒä¸ä¸‹äº†â€
- â€œæˆ‘åƒå¾—å¾ˆé¥±ï¼Œä»Šå¤©çš„æ¼”è®²è®©äººå……å®â€ï¼šè¿™é‡Œçš„ â€œåƒå¾—å¾ˆé¥±â€ å¹¶éå­—é¢ä¸Šçš„ â€œåƒå¾—é¥±â€ï¼Œè€Œæ˜¯æ¯”å–» â€œå¾—åˆ°äº†å¾ˆå¤§çš„æ»¡è¶³â€ï¼Œè¡¨ç°å‡ºå†…å¿ƒçš„å……å®æ„Ÿã€‚

è€Œé™ç•Œä¸Šä¸‹æ–‡å®é™…ä¸Šå°±ç±»ä¼¼äºè¯­ä¹‰ç¯å¢ƒã€‚é€šç”¨è¯­è¨€éœ€è¦ä¸šåŠ¡è¾¹ç•Œï¼Œé™ç•Œä¸Šä¸‹æ–‡å°±æ˜¯å®šä¹‰äº†ä¸šåŠ¡çš„è¾¹ç•Œï¼Œä¹Ÿå°±æ˜¯é¢†åŸŸçš„è¾¹ç•Œã€‚

ç”µå•†è¯­ä¹‰ä¸‹ç§°ä¹‹ä¸ºå•†å“çš„ä¸œè¥¿ï¼Œåˆ°è¿è¾“è¯­ä¹‰ä¸‹å®ƒå°±å˜æˆäº†è´§ç‰©ã€‚å› æ­¤æˆ‘ä»¬éœ€è¦æ˜ç¡®é™ç•Œä¸Šä¸‹æ–‡ï¼Œåœ¨è¿™ä¸ªä¸Šä¸‹æ–‡ä¸­å›¢é˜Ÿå†…éƒ¨äººå‘˜å¯¹æŸä¸€é¢†åŸŸå¯¹è±¡ã€é¢†åŸŸäº‹ä»¶çš„è®¤çŸ¥æ˜¯ä¸€è‡´çš„ã€æ²¡æœ‰æ­§ä¹‰çš„ã€‚

#### 3ã€å®ä½“

ä¸€èˆ¬ä¸šåŠ¡å¯¹è±¡ï¼Œä¸”å…·æœ‰å”¯ä¸€æ ‡è¯†å¯¹è±¡éƒ½æ˜¯å®ä½“ã€‚åœ¨ä»£ç ä¸­æ‰€è°“çš„å”¯ä¸€æ ‡è¯†å°±æ˜¯ IDï¼Œä¾‹å¦‚ï¼Œè®¢å•æœ‰è®¢å• IDï¼Œç”¨æˆ·æœ‰ç”¨æˆ· IDï¼Œå®ƒä»¬éƒ½æ˜¯å…¸å‹çš„å®ä½“ã€‚

**å®ä½“çš„å…³é”®ç‚¹å°±åœ¨äºå”¯ä¸€æ ‡è¯†**ï¼Œéšç€ç”Ÿå‘½å‘¨æœŸçš„å˜åŒ–ï¼Œå®ä½“ä¸­çš„å±æ€§å¯èƒ½ä¼šæ”¹å˜ï¼Œä¾‹å¦‚è®¢å•å¯ä»¥ä»æœªå®Œæˆå˜æˆå·²å®Œæˆï¼Œä½†æ˜¯å…¶ ID ä¸ä¼šæ”¹å˜ã€‚

å®ä½“æ˜ å°„åˆ°ä»£ç ä¸­å°±æ˜¯å®ä½“ç±»ã€‚é€šå¸¸é‡‡ç”¨ **å……è¡€æ¨¡å‹** æ¥å®ç°ï¼Œå³ä¸è¿™ä¸ªå®ä½“ç›¸å…³çš„æ‰€æœ‰ä¸šåŠ¡é€»è¾‘éƒ½å†™åœ¨å®ä½“ç±»ä¸­ã€‚

å¦‚æœéœ€è¦è·¨å¤šä¸ªå®ä½“æ‰èƒ½å®Œæˆçš„ä¸šåŠ¡é€»è¾‘ï¼Œä¼šå†™åœ¨é¢†åŸŸæœåŠ¡ä¸­ã€‚

#### 4ã€å€¼å¯¹è±¡

å€¼å¯¹è±¡æ²¡æœ‰å”¯ä¸€æ ‡è¯†ï¼Œåˆ›å»ºåå°±ä¸å…è®¸ä¿®æ”¹äº†ï¼Œåªèƒ½ç”¨å¦å¤–ä¸€ä¸ªå€¼å¯¹è±¡æ¥è¿›è¡Œ **æ•´ä½“æ›¿æ¢**ã€‚é€šå¸¸ç”¨äºæè¿°å¯¹è±¡çš„å±æ€§ï¼Œç”¨äºå¯¹å®ä½“çš„çŠ¶æ€å’Œç‰¹å¾è¿›è¡Œæè¿°ã€‚

éå¸¸å…¸å‹çš„å€¼å¯¹è±¡å°±æ˜¯åœ°å€ã€‚æ¯”å¦‚ç”¨æˆ·å®ä½“å¯¹è±¡æœ‰åœ°å€è¿™ä¸ªå±æ€§ï¼Œé‚£ä¹ˆè¿™ä¸ªåœ°å€å°±æ˜¯å€¼å¯¹è±¡ï¼Œå®ƒæ²¡æœ‰å”¯ä¸€æ ‡è¯†ï¼Œä¸”åˆ›å»ºåå°±ä¸å…è®¸ä¿®æ”¹å…¶æœ¬èº«çš„å€¼ã€‚å¦‚æœç”¨æˆ·éœ€è¦ä¿®æ”¹åœ°å€ï¼Œé‚£ä¹ˆè¿™ä¸ªå±æ€§æ˜¯è¢«æ•´ä½“æ›¿æ¢çš„ï¼ˆæ¢æ–°çš„åœ°å€å€¼å¯¹è±¡ï¼‰ã€‚

æ‹¥æœ‰è¿™æ ·ç‰¹æ€§çš„å¯¹è±¡ï¼Œå°±æ˜¯å€¼å¯¹è±¡ã€‚

ğŸ’¡ å®ä½“å’Œå€¼å¯¹è±¡å¹¶ä¸æ˜¯ä¸€æˆä¸å˜çš„ï¼Œæ¯”å¦‚å¯¹ç”µè„‘ä¸»æœºæ¥è¯´ï¼Œæ˜¾å¡æ˜¯ä¸€ä¸ªå€¼å¯¹è±¡ï¼Œæ˜¾å¡åäº†å°±æ¢ä¸€ä¸ªï¼Œè€Œå¯¹æ˜¾å¡å‚å•†æ¥è¯´ï¼Œæ˜¾å¡æ˜¯å®ä½“ï¼Œå®ƒä»¬æœ‰ç¼–å·éœ€è¦è¿½è¸ªå’Œç®¡ç†çš„ã€‚

#### 5ã€èšåˆ

å®ä½“å’Œå€¼å¯¹è±¡æ˜¯åŸºç¡€çš„é¢†åŸŸå¯¹è±¡ï¼Œèšåˆå°†å¤šä¸ªå®ä½“å’Œå€¼å¯¹è±¡ç»„åˆæˆä¸€ä¸ªæ•´ä½“ï¼Œå®ç°é«˜å†…èšä½è€¦åˆã€‚

ç®€å•æ¥è¯´å®ä½“å’Œå€¼å¯¹è±¡æ˜¯ä¸ªä½“ï¼Œä¸ªä½“ä¸ä¸ªä½“ä¹‹é—´çš„åˆä½œéœ€è¦è¢«â€œé¢†å¯¼â€ï¼Œè€Œèšåˆå°±æ˜¯å°†å®ƒä»¬ç»„ç»‡èµ·æ¥ååŒå·¥ä½œï¼Œè¿™æ ·æ‰èƒ½ä¿è¯èšåˆå†…æ•°æ®çš„ä¸€è‡´æ€§ï¼ˆç»„ç»‡ç»Ÿä¸€å£å¾„ï¼‰ã€‚å®ƒå¯ä»¥ä½œä¸ºå¾®æœåŠ¡æ‹†åˆ†çš„æœ€å°å•ä½ã€‚

èšåˆè¿˜æ˜¯æ•°æ®ä¿®æ”¹å’ŒæŒä¹…åŒ–çš„åŸºæœ¬å•ä½ï¼Œå®ç°æ•°æ®çš„æŒä¹…åŒ–å­˜å‚¨ã€‚

#### 6ã€èšåˆæ ¹

èšåˆæ ¹å°±å¥½æ¯”èšåˆå†…çš„å¸¦å¤´äººï¼Œèšåˆå†…çš„å¤šä¸ªå®ä½“ä¸ä¼šç›´æ¥å¯¹å¤–æä¾›æ¥å£è®¿é—®ï¼Œè€Œæ˜¯ç”±èšåˆæ ¹ç»Ÿä¸€æä¾›å¯¹å¤–æ¥å£ã€‚

**ä¸€ä¸ªèšåˆå†…åªä¼šæœ‰ä¸€ä¸ªèšåˆæ ¹**ï¼Œèšåˆæ ¹é€šè¿‡å¯¹è±¡å¼•ç”¨çš„æ–¹å¼ç»„ç»‡èšåˆå†…çš„å®ä½“å’Œå€¼å¯¹è±¡ï¼Œèšåˆæ ¹ä¹‹é—´çš„åˆä½œæ˜¯é€šè¿‡ ID å…³è”çš„ã€‚

è¿™é‡Œéœ€è¦æ³¨æ„ï¼šèšåˆæ ¹ä¹Ÿæ˜¯ä¸€ä¸ªå®ä½“ï¼Œä¹Ÿå…·æœ‰ä¸šåŠ¡å±æ€§å’Œä¸šåŠ¡é€»è¾‘å’Œå”¯ä¸€æ ‡è¯†ã€‚

ä¾‹å¦‚è®¢å•åŸŸå†…åªæœ‰è®¢å•å’Œè®¢å•å­é¡¹ä¸¤ä¸ªå®ä½“ï¼Œé‚£ä¸ªè®¢å•å°±æ˜¯è¿™ä¸ªåŸŸä¸­çš„èšåˆæ ¹ã€‚

#### 7ã€é¢†åŸŸæœåŠ¡

èšåˆæ ¹å¯ä»¥å®ç°è·¨å¤šä¸ªå®ä½“çš„å¤æ‚ä¸šåŠ¡è¡Œä¸ºï¼Œä½†æ˜¯ä¸ºäº†å®ç°é«˜å†…èšå’Œä½è€¦åˆï¼Œèšåˆæ ¹å†…éƒ¨åº”è¯¥æ›´èšç„¦ä¸è‡ªèº«å¼ºå…³è”çš„ä¸šåŠ¡è¡Œä¸ºï¼Œå¤æ‚çš„è·¨å¤šå®ä½“çš„ä¸šåŠ¡å¯ä»¥æ”¾åœ¨é¢†åŸŸæœåŠ¡ä¸­å®ç°ã€‚

é¢†åŸŸæœåŠ¡æ˜¯æŒ‡é‚£äº› **ä¸èƒ½å½’å±äºæŸä¸ªå•ä¸€å®ä½“æˆ–å€¼å¯¹è±¡ï¼Œä½†åˆå±äºé¢†åŸŸæ¨¡å‹çš„ä¸€éƒ¨åˆ†** çš„ä¸šåŠ¡é€»è¾‘ã€‚é¢†åŸŸæœåŠ¡å°è£…äº†å¯¹é¢†åŸŸå¯¹è±¡è¿›è¡Œæ“ä½œçš„æ ¸å¿ƒä¸šåŠ¡è§„åˆ™ï¼Œé€šå¸¸ç”¨äºå¤„ç†è·¨å¤šä¸ªå®ä½“çš„æ“ä½œï¼Œæˆ–è€…å½“ä¸šåŠ¡é€»è¾‘æ— æ³•ç›´æ¥å½’å±äºæŸä¸ªç‰¹å®šèšåˆæ—¶ã€‚

ä¾‹å¦‚ä¸€ä¸ªè®¢å•ç³»ç»Ÿï¼Œéœ€è¦å¤„ç†è®¢å•æ”¯ä»˜åŠŸèƒ½ï¼Œè€Œæ”¯ä»˜æ¶‰åŠè®¢å•ã€ç”¨æˆ·è´¦æˆ·ã€æ”¯ä»˜ä¿¡æ¯ç­‰å¤šä¸ªå®ä½“ï¼Œè¿™ä¸ªæ”¯ä»˜æ“ä½œä¸å¤ªå¥½å½’å±æŸä¸ªå®ä½“ï¼Œè¿™æ ·çš„é€»è¾‘å°±å¯ä»¥æ”¾åˆ°é¢†åŸŸæœåŠ¡ä¸­ã€‚

```java
public class PaymentService {
    public void processPayment(Order order, PaymentDetails paymentDetails, Account account) {
        // å¤„ç†æ”¯ä»˜é€»è¾‘
        // è°ƒç”¨å¤šä¸ªå®ä½“æ–¹æ³•æ¥å¤„ç†æ”¯ä»˜è¿‡ç¨‹
    }
}
```

é‚£èšåˆæ ¹æ›´é€‚åˆæ€æ ·çš„è·¨å®ä½“çš„ä¸šåŠ¡å‘¢ï¼Ÿ

ä¾‹å¦‚ä½ æœ‰ä¸€ä¸ªâ€œè®¢å•â€èšåˆï¼Œå…¶ä¸­åŒ…å«è®¢å•æ¡ç›®ã€æ”¯ä»˜ä¿¡æ¯ç­‰ï¼ŒOrder ä½œä¸ºèšåˆæ ¹ï¼Œè´Ÿè´£ç®¡ç†è®¢å•æ¡ç›®å’Œç¡®ä¿è®¢å•çš„å®Œæ•´æ€§ã€‚ä½ ä¸èƒ½ç›´æ¥è®¿é—®è®¢å•æ¡ç›®ï¼ˆå¦‚ OrderItemï¼‰ï¼Œå¿…é¡»é€šè¿‡ Order èšåˆæ ¹æ¥è¿›è¡Œæ“ä½œã€‚

```java
public class Order {
    private List<OrderItem> items;
    private PaymentDetails paymentDetails;

    public void addItem(OrderItem item) {
        // æ£€æŸ¥å•†å“æ•°é‡ã€ä»·æ ¼ç­‰ä¸šåŠ¡è§„åˆ™
        this.items.add(item);
    }

    public List<OrderItem> getOrderItems() {
        //....
    }

    // å…¶ä»–èšåˆå†…éƒ¨çš„ä¸€è‡´æ€§æ ¡éªŒ
}
```

#### DDD å»ºæ¨¡æ€»ç»“

ç»“åˆä¸Šé¢çš„åè¯è§£æï¼Œæˆ‘ä»¬å›é¡¾ä¸€ä¸‹ DDD å»ºæ¨¡çš„æµç¨‹ã€‚

é¦–å…ˆæˆ‘ä»¬éœ€è¦é¢†åŸŸå»ºæ¨¡ï¼Œæ­¤æ—¶ä¼šè¿›è¡Œäº‹ä»¶é£æš´ï¼Œé€šè¿‡ç”¨ä¾‹åˆ†æã€åœºæ™¯åˆ†æç­‰æ–¹å¼åˆ—å‡ºæ‰€æœ‰çš„ä¸šåŠ¡è¡Œä¸ºä¸äº‹ä»¶ï¼Œæ‰¾å‡ºäº§ç”Ÿè¿™äº›è¡Œä¸ºçš„é¢†åŸŸå¯¹è±¡ï¼ŒåŒ…æ‹¬å®ä½“ä¸å€¼å¯¹è±¡ã€‚æ¢³ç†è¿™äº›é¢†åŸŸå¯¹è±¡ä¹‹é—´çš„å…³ç³»ï¼Œä»å®ä½“ä¸­æ‰¾å‡ºèšåˆæ ¹ï¼Œå†æ ¹æ®èšåˆæ ¹çš„ä¸šåŠ¡ï¼Œæ‰¾å¯»ä¸å…¶ä¸šåŠ¡ç´§å¯†å…³è”å…¶å®ƒå®ä½“ä¸å€¼å¯¹è±¡ï¼Œä»è€Œå½¢æˆèšåˆã€‚å¤šä¸ªèšåˆä¹‹é—´æ ¹æ®ä¸šåŠ¡ç›¸å…³æ€§åˆå¯ä»¥åˆ’å‡ºé™ç•Œä¸Šä¸‹æ–‡ã€‚

å¯ä»¥é€šè¿‡ â€œå¼€å…¬å¸â€ çš„æ¯”å–»æ¥å¸®åŠ©å¤§å®¶ç†è§£ DDDã€‚é¢†åŸŸå°±åƒå…¬å¸çš„è¡Œä¸šï¼Œå†³å®šäº†å…¬å¸æ‰€ä»äº‹çš„æ ¸å¿ƒä¸šåŠ¡ï¼›é™ç•Œä¸Šä¸‹æ–‡æ˜¯å…¬å¸å†…éƒ¨çš„å„ä¸ªéƒ¨é—¨ï¼Œæ¯ä¸ªéƒ¨é—¨æœ‰ç‹¬ç«‹çš„èŒè´£å’Œè§„åˆ™ï¼›å®ä½“æ˜¯å…¬å¸ä¸­çš„å‘˜å·¥ï¼Œå…·æœ‰å”¯ä¸€æ ‡è¯†å’Œç”Ÿå‘½å‘¨æœŸï¼›å€¼å¯¹è±¡æ˜¯å‘˜å·¥çš„åœ°å€æˆ–ç”µè¯ç­‰å±æ€§ï¼Œåªæœ‰å€¼çš„æ„ä¹‰ï¼Œæ²¡æœ‰ç‹¬ç«‹çš„èº«ä»½ï¼›èšåˆæ˜¯éƒ¨é—¨ï¼Œç”±å¤šä¸ªå®ä½“å’Œå€¼å¯¹è±¡ç»„æˆï¼Œèšåˆæ ¹ï¼ˆå¦‚éƒ¨é—¨ç»ç†ï¼‰æ˜¯éƒ¨é—¨çš„å…¥å£ï¼Œç¡®ä¿éƒ¨é—¨å†…éƒ¨çš„ä¸€è‡´æ€§ï¼›é¢†åŸŸæœåŠ¡åˆ™æ˜¯è·¨éƒ¨é—¨çš„èŒèƒ½æœåŠ¡ï¼Œæ¯”å¦‚ HR æˆ– IT æœåŠ¡ï¼Œä¸ºå„éƒ¨é—¨æä¾›æ”¯æŒå’Œåä½œã€‚

## ä¸‰ã€DDD æ¶æ„è®¾è®¡

### å……è¡€æ¨¡å‹å’Œè´«è¡€æ¨¡å‹

è´«è¡€æ¨¡å‹å’Œå……è¡€æ¨¡å‹æ˜¯ä¸¤ç§é¢å‘å¯¹è±¡è®¾è®¡æ¨¡å¼ï¼Œç”¨äºæè¿°å¯¹è±¡çš„èŒè´£åˆ’åˆ†å’Œå¯¹è±¡æ˜¯å¦åŒ…å«è¡Œä¸ºé€»è¾‘ã€‚

æˆ‘ä»¬å¸¸è§çš„å¯¹è±¡å†…éƒ¨çš„å®ç°éå¸¸ç®€å•ï¼Œä»…åŒ…å«æ•°æ®å±æ€§å’Œç®€å•çš„ `getter`/`setter` æ–¹æ³•ï¼Œæ¢å¥è¯è¯´ï¼Œè¿™äº›å¯¹è±¡æ˜¯ä¸€ä¸ªçº¯ç²¹çš„â€œæ•°æ®å®¹å™¨â€ï¼Œå®ƒä»…è´Ÿè´£ä¿å­˜æ•°æ®ï¼Œè€Œä¸åŒ…å«ä»»ä½•ä¸šåŠ¡è¡Œä¸ºã€‚

ä»é¢†åŸŸæ¨¡å‹è®¾è®¡è§’åº¦æ¥è¯´ï¼Œè¿™æ ·çš„è®¾è®¡ç§°ä¸ºè´«è¡€æ¨¡å‹ï¼Œåå‘äºä¼ ç»Ÿåˆ†å±‚æ¶æ„çš„è®¾è®¡ï¼›ä¸ä¹‹å¯¹åº”çš„æ˜¯å……è¡€æ¨¡å‹ï¼Œå¼ºè°ƒé¢å‘å¯¹è±¡çš„ç³»ç»Ÿè®¾è®¡ã€‚

ä¸¤ç§æ¨¡å‹çš„åˆ†ç±»æœ¬è´¨æ˜¯å¯¹é¢†åŸŸå¯¹è±¡ä¸­ â€œæ•°æ®ä¸è¡Œä¸ºçš„èŒè´£åˆ’åˆ†â€ çš„ä¸åŒç†è§£ã€‚åæ˜ äº†åœ¨è½¯ä»¶è®¾è®¡ä¸­ï¼Œå¦‚ä½•ç»„ç»‡é¢†åŸŸå¯¹è±¡çš„æ•°æ®å’Œè¡Œä¸ºï¼Œä»¥åŠå¦‚ä½•åˆ†é…ä¸šåŠ¡é€»è¾‘çš„ä¸åŒè®¾è®¡æ€è·¯ã€‚

å……è¡€æ¨¡å‹æ˜¯æŒ‡é¢†åŸŸå¯¹è±¡ä¸ä»…åŒ…å«æ•°æ®ï¼ˆå±æ€§ï¼‰ï¼Œè¿˜åŒ…å«å¤„ç†è¿™äº›æ•°æ®çš„ä¸šåŠ¡é€»è¾‘ã€‚æ¢å¥è¯è¯´ï¼Œå……è¡€æ¨¡å‹çš„é¢†åŸŸå¯¹è±¡æ˜¯â€œå……è¡€â€çš„ï¼Œå®ƒä»¬ä¸ä»…æœ‰çŠ¶æ€ï¼ˆæ•°æ®ï¼‰ï¼Œè¿˜æœ‰è¡Œä¸ºï¼ˆä¸šåŠ¡æ–¹æ³•ï¼‰ã€‚

è´«è¡€æ¨¡å‹åˆ™æ˜¯æŒ‡é¢†åŸŸå¯¹è±¡ä»…åŒ…å«æ•°æ®ï¼Œä¸åŒ…å«ä»»ä½•ä¸šåŠ¡é€»è¾‘ï¼Œæ‰€æœ‰çš„ä¸šåŠ¡é€»è¾‘éƒ½æ”¾åœ¨å•ç‹¬çš„æœåŠ¡ç±»ä¸­ï¼ˆé€šå¸¸æ˜¯åº”ç”¨å±‚æˆ–é¢†åŸŸæœåŠ¡å±‚ï¼‰ã€‚é¢†åŸŸå¯¹è±¡æœ¬èº«æ˜¯ â€œè´«è¡€â€ çš„ï¼Œåªæœ‰çŠ¶æ€ï¼Œæ²¡æœ‰è¡Œä¸ºã€‚

æ€»ç»“æ¥çœ‹ï¼š

- **å……è¡€æ¨¡å‹** é€‚åˆå¤æ‚ä¸šåŠ¡ï¼Œä¸šåŠ¡é€»è¾‘å’Œæ•°æ®ç´§å¯†ç»“åˆï¼Œç¬¦åˆé¢å‘å¯¹è±¡è®¾è®¡çš„åŸåˆ™ã€‚
- **è´«è¡€æ¨¡å‹** é€‚åˆç®€å•ä¸šåŠ¡ï¼Œå…³æ³¨ç‚¹åˆ†ç¦»ï¼Œæ•°æ®å’Œä¸šåŠ¡é€»è¾‘åˆ†å¼€ï¼Œé¢†åŸŸå¯¹è±¡ä»…è´Ÿè´£å­˜å‚¨æ•°æ®ï¼ŒæœåŠ¡ç±»è´Ÿè´£ä¸šåŠ¡é€»è¾‘ã€‚

ä¸‹é¢ç”¨ä»£ç ä¸¾ä¾‹ï¼Œå¤§å®¶å°±çŸ¥é“å®ƒä»¬çš„åŒºåˆ«äº†ã€‚

#### ä»£ç ç¤ºä¾‹

å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªè®¢å•ç³»ç»Ÿï¼ŒOrder æ˜¯é¢†åŸŸå¯¹è±¡ï¼ŒåŒ…å«äº†è®¢å•çš„çŠ¶æ€å’Œç›¸å…³çš„ä¸šåŠ¡é€»è¾‘ã€‚

1ï¼‰å……è¡€æ¨¡å‹ä»£ç ç¤ºä¾‹

åœ¨å……è¡€æ¨¡å‹ä¸­ï¼ŒOrder å¯¹è±¡åŒ…å«äº†ä¸šåŠ¡é€»è¾‘ï¼ˆå¦‚ pay å’Œ cancel æ–¹æ³•ï¼‰ï¼Œè¿™äº›æ–¹æ³•å¯¹è®¢å•çš„çŠ¶æ€è¿›è¡Œæ“ä½œï¼Œç›´æ¥å°†æ•°æ®å’Œè¡Œä¸ºç»“åˆåœ¨ä¸€èµ·ã€‚

```java
public class Order {
    private String orderId;
    private double totalAmount;
    private boolean isPaid;

    public Order(String orderId, double totalAmount) {
        this.orderId = orderId;
        this.totalAmount = totalAmount;
        this.isPaid = false;
    }

    public void pay() {
        if (this.isPaid) {
            throw new IllegalStateException("Order is already paid");
        }
        this.isPaid = true;
    }

    public void cancel() {
        if (this.isPaid) {
            throw new IllegalStateException("Cannot cancel a paid order");
        }
        // Perform cancellation logic
    }

    public boolean isPaid() {
        return isPaid;
    }

    public double getTotalAmount() {
        return totalAmount;
    }
}
```

2ï¼‰è´«è¡€æ¨¡å‹ä»£ç ç¤ºä¾‹

åœ¨è´«è¡€æ¨¡å‹ä¸­ï¼ŒOrder å¯¹è±¡åªåŒ…å«æ•°æ®ï¼ˆçŠ¶æ€ï¼‰ï¼Œè€Œæ‰€æœ‰çš„ä¸šåŠ¡é€»è¾‘ï¼ˆå¦‚ payOrder å’Œ cancelOrderï¼‰éƒ½è¢«ç§»åˆ°äº†å¤–éƒ¨çš„ OrderService æœåŠ¡ç±»ä¸­ã€‚

```java
public class Order {
    private String orderId;
    private double totalAmount;
    private boolean isPaid;

    public Order(String orderId, double totalAmount) {
        this.orderId = orderId;
        this.totalAmount = totalAmount;
        this.isPaid = false;
    }

    public String getOrderId() {
        return orderId;
    }

    public double getTotalAmount() {
        return totalAmount;
    }

    public boolean isPaid() {
        return isPaid;
    }

    public void setPaid(boolean paid) {
        isPaid = paid;
    }
}

public class OrderService {
    public void payOrder(Order order) {
        if (order.isPaid()) {
            throw new IllegalStateException("Order is already paid");
        }
        order.setPaid(true);
    }

    public void cancelOrder(Order order) {
        if (order.isPaid()) {
            throw new IllegalStateException("Cannot cancel a paid order");
        }
        // Perform cancellation logic
    }
}
```

#### äºŒè€…å¯¹æ¯”

| ç‰¹ç‚¹         | è´«è¡€æ¨¡å‹                         | å……è¡€æ¨¡å‹                         |
| ------------ | -------------------------------- | -------------------------------- |
| å°è£…æ€§       | æ•°æ®å’Œé€»è¾‘åˆ†ç¦»                   | æ•°æ®å’Œé€»è¾‘å°è£…åœ¨åŒä¸€å¯¹è±¡å†…       |
| èŒè´£åˆ†ç¦»     | æœåŠ¡ç±»è´Ÿè´£ä¸šåŠ¡é€»è¾‘ï¼Œå¯¹è±¡è´Ÿè´£æ•°æ® | å¯¹è±¡åŒæ—¶è´Ÿè´£æ•°æ®å’Œè‡ªèº«çš„ä¸šåŠ¡é€»è¾‘ |
| é€‚ç”¨åœºæ™¯     | ç®€å•çš„å¢åˆ æ”¹æŸ¥ã€DTO ä¼ è¾“å¯¹è±¡     | å¤æ‚çš„é¢†åŸŸé€»è¾‘å’Œä¸šåŠ¡å»ºæ¨¡         |
| ä¼˜ç‚¹         | ç®€å•æ˜“ç”¨ï¼ŒèŒè´£æ¸…æ™°               | é«˜å†…èšï¼Œç¬¦åˆé¢å‘å¯¹è±¡è®¾è®¡æ€æƒ³     |
| ç¼ºç‚¹         | æœåŠ¡å±‚è‡ƒè‚¿ï¼Œé¢†åŸŸæ¨¡å‹å¼±åŒ–         | å¤æ‚åº¦å¢åŠ ï¼Œä¸é€‚åˆç®€å•åœºæ™¯       |
| é¢å‘å¯¹è±¡åŸåˆ™ | è¿åå°è£…åŸåˆ™                     | ç¬¦åˆå°è£…åŸåˆ™                     |

åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œè´«è¡€æ¨¡å‹å’Œå……è¡€æ¨¡å‹å¹¶éäº’ç›¸æ’æ–¥ã€‚é€šå¸¸å¯ä»¥ç»“åˆä¸¤è€…çš„ä¼˜ç‚¹ï¼š

- ä½¿ç”¨å……è¡€æ¨¡å‹ä½œä¸ºé¢†åŸŸæ¨¡å‹ï¼Œå°è£…å¤æ‚çš„ä¸šåŠ¡é€»è¾‘ã€‚
- ä½¿ç”¨è´«è¡€æ¨¡å‹ä½œä¸ºæ•°æ®ä¼ è¾“å¯¹è±¡ï¼ˆDTOï¼‰ï¼Œåœ¨ç³»ç»Ÿä¹‹é—´ä¼ è¾“æ•°æ®ã€‚

#### æ‰©å±•çŸ¥è¯† - ç¼ºè¡€æ¨¡å‹å’Œæ¶¨è¡€æ¨¡å‹

1ï¼‰ç¼ºè¡€æ¨¡å‹

ä¸Šé¢è´«è¡€æ¨¡å‹çš„ç¤ºä¾‹å¯ä»¥è§†ä¸ºç¼ºè¡€æ¨¡å‹çš„ä¸€ç§è¡¨ç°å½¢å¼ã€‚ç¼ºè¡€æ¨¡å‹å®é™…ä¸Šæ˜¯è´«è¡€æ¨¡å‹çš„è¿›ä¸€æ­¥ç®€åŒ–æˆ–æç«¯åŒ–ç‰ˆæœ¬ã€‚

åœ¨ç¼ºè¡€æ¨¡å‹ä¸­ï¼Œä¸ä»…å¯¹è±¡æ²¡æœ‰ä¸šåŠ¡é€»è¾‘ï¼Œç”šè‡³æœåŠ¡å±‚ä¹Ÿç¼ºä¹çœŸæ­£çš„ä¸šåŠ¡é€»è¾‘ï¼Œç³»ç»Ÿçš„æ•´ä½“è®¾è®¡è¶‹å‘äº CRUDï¼ˆå¢åˆ æ”¹æŸ¥ï¼‰å¼€å‘ï¼Œä¼šå°†æ‰€æœ‰é€»è¾‘è½¬ç§»åˆ°å¤–éƒ¨ã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œé¢†åŸŸå¯¹è±¡ä¸åŒ…å«ä»»ä½•ä¸šåŠ¡é€»è¾‘å³å¯ç§°ä¸ºè´«è¡€æ¨¡å‹ï¼Œæ— éœ€åˆ»æ„å¼ºè°ƒæ˜¯å¦å±äºç¼ºè¡€æ¨¡å‹ï¼Œé™¤éæ˜¯åœ¨è´«è¡€æ¨¡å‹ä¸ç¼ºè¡€æ¨¡å‹å¯¹æ¯”çš„è¯­å¢ƒä¸­ã€‚

2ï¼‰æ¶¨è¡€æ¨¡å‹

æ¶¨è¡€æ¨¡å‹åˆ™æ˜¯å……è¡€æ¨¡å‹çš„æç«¯åŒ–è¡¨ç°ï¼Œä¸ä»…å°†æ‰€æœ‰æ ¸å¿ƒä¸šåŠ¡é€»è¾‘é›†ä¸­äºé¢†åŸŸæ¨¡å‹ä¸­ï¼Œç”šè‡³è¿éæ ¸å¿ƒé€»è¾‘ï¼ˆå¦‚æ•°æ®åº“äº‹åŠ¡å¤„ç†ã€æƒé™æ ¡éªŒç­‰ï¼‰ä¹Ÿå…¨éƒ¨åŒ…å«å…¶ä¸­ã€‚

åœ¨å®é™…åº”ç”¨ä¸­ï¼Œ**ç¼ºè¡€æ¨¡å‹å’Œæ¶¨è¡€æ¨¡å‹å¹¶ä¸å¸¸ç”¨ï¼Œè¿™é‡Œä»…åšæ‰©å±•äº†è§£**ã€‚æˆ‘ä»¬é€šå¸¸åªéœ€å…³æ³¨è´«è¡€æ¨¡å‹å’Œå……è¡€æ¨¡å‹çš„è®¾è®¡å–èˆå³å¯ã€‚

### DDD çš„åˆ†å±‚æ¶æ„

åœ¨é¢†åŸŸé©±åŠ¨è®¾è®¡ï¼ˆDDDï¼‰ä¸­ï¼Œåˆ†å±‚æ¶æ„æ¨¡å‹æ˜¯ä¸€ç§å¸¸è§çš„è®¾è®¡æ¨¡å¼ï¼Œç”¨äºç»„ç»‡å’Œç®¡ç†ç³»ç»Ÿçš„å¤æ‚æ€§ã€‚é€šè¿‡å°†åº”ç”¨åˆ†ä¸ºä¸åŒçš„å±‚æ¬¡ï¼Œæ¯ä¸€å±‚éƒ½æœ‰æ¸…æ™°çš„è´£ä»»å’Œè§’è‰²ï¼Œä»è€Œä¿ƒè¿›äº†ä»£ç çš„é«˜å†…èšã€ä½è€¦åˆå’Œå¯ç»´æŠ¤æ€§ã€‚

DDD çš„åˆ†å±‚æ¶æ„ä¸»è¦æœ‰å››å±‚ï¼š**ç”¨æˆ·æ¥å£å±‚**ã€**åº”ç”¨å±‚**ã€**é¢†åŸŸå±‚**ã€**åŸºç¡€è®¾æ–½å±‚**ã€‚æ¯å±‚è´Ÿè´£ä¸åŒçš„èŒè´£ï¼Œåè°ƒå·¥ä½œä»¥å®ç°ç³»ç»Ÿçš„æ•´ä½“åŠŸèƒ½ã€‚

é™¤åŸºç¡€è®¾æ–½å±‚å¤–ï¼Œä¸¥æ ¼æ¥è¯´æ¯å±‚åªèƒ½ä¸ **ç›´æ¥ä¸‹å±‚** äº§ç”Ÿä¾èµ–ï¼Œå³é¢†åŸŸå±‚åªèƒ½è¢«åº”ç”¨å±‚è°ƒç”¨ï¼Œåº”ç”¨å±‚åªèƒ½è¢«ç”¨æˆ·æ¥å£å±‚è°ƒç”¨ã€‚

å½“ç„¶ä¹Ÿæœ‰ **æ¾æ•£åˆ†å±‚æ¶æ„**ï¼Œå±‚ä¸å±‚ä¹‹é—´çš„ä¾èµ–å’Œäº¤äº’æ›´åŠ çµæ´»ï¼Œä¸ä¸¥æ ¼åˆ†éš”ã€‚é€‚ç”¨äºå¿«é€Ÿå¼€å‘ï¼Œä½†éšç€ç³»ç»Ÿå¤æ‚åº¦çš„å¢åŠ ï¼Œå¯èƒ½å˜å¾—éš¾ä»¥ç»´æŠ¤ã€‚

![img](assets/LcPiN4L7MY3uBndm.webp)

1ï¼‰ç”¨æˆ·æ¥å£å±‚

ä¹Ÿå«è¡¨ç¤ºå±‚æˆ– Web å±‚ï¼Œä¸»è¦è´Ÿè´£ä¸å¤–éƒ¨ï¼ˆç”¨æˆ·ã€API ç­‰ï¼‰çš„äº¤äº’ã€‚å®ƒçš„ä¸»è¦èŒè´£æ˜¯æ¥æ”¶ç”¨æˆ·è¾“å…¥å¹¶è¿”å›ç³»ç»Ÿçš„è¾“å‡ºã€‚è¡¨ç¤ºå±‚ä¸åŒ…å«ä¸šåŠ¡é€»è¾‘ï¼Œè€Œæ˜¯å°†ç”¨æˆ·çš„è¯·æ±‚è½¬å‘åˆ°åº”ç”¨å±‚å¤„ç†ï¼Œå¹¶å°†å¤„ç†ç»“æœè¿”å›ç»™ç”¨æˆ·ã€‚

2ï¼‰åº”ç”¨å±‚

åº”ç”¨å±‚ä¸»è¦ç”¨æ¥åè°ƒé¢†åŸŸå±‚çš„é€»è¾‘å’ŒåŸºç¡€è®¾æ–½å±‚çš„èµ„æºã€‚åº”ç”¨å±‚ä¸åŒ…å«ä¸šåŠ¡è§„åˆ™æˆ–ä¸šåŠ¡é€»è¾‘ï¼Œä½†ä¼šè°ƒç”¨é¢†åŸŸå±‚çš„æœåŠ¡è¿›è¡ŒæœåŠ¡ç¼–æ’ä¸ç»„åˆï¼Œæ¥å®ç°ç‰¹å®šçš„ä¸šåŠ¡ã€‚

å¦‚æœæœ‰å¯¹å…¶ä»–æœåŠ¡çš„è¿œç¨‹è°ƒç”¨ï¼Œä¹Ÿæ”¾åœ¨è¿™å±‚å®ç°ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œæƒé™æ ¡éªŒã€äº‹åŠ¡ã€äº‹ä»¶ç­‰æ“ä½œä¹Ÿéƒ½å¯ä»¥æ”¾åœ¨è¿™å±‚è¿›è¡Œå®ç°ã€‚

3ï¼‰é¢†åŸŸå±‚

é¢†åŸŸå±‚æ˜¯æ•´ä¸ªæ¶æ„çš„æ ¸å¿ƒï¼ŒåŒ…å«äº†åº”ç”¨çš„ä¸šåŠ¡é€»è¾‘ã€è§„åˆ™å’Œç­–ç•¥ã€‚å®ƒå®šä¹‰äº†æ ¸å¿ƒçš„é¢†åŸŸæ¨¡å‹ï¼ŒåŒ…æ‹¬èšåˆæ ¹ã€å®ä½“ã€å€¼å¯¹è±¡ã€é¢†åŸŸæœåŠ¡ç­‰ã€‚

é¢†åŸŸå±‚çš„ç›®çš„æ˜¯å°†ä¸šåŠ¡éœ€æ±‚è½¬åŒ–ä¸ºä»£ç ï¼Œå¹¶ç¡®ä¿ä¸šåŠ¡è§„åˆ™åœ¨åº”ç”¨ä¸­å¾—ä»¥æ‰§è¡Œã€‚è¯¥å±‚çš„è®¾è®¡å¼ºè°ƒä¸ä¸šåŠ¡é¢†åŸŸçš„ç´§å¯†è€¦åˆï¼Œæ˜¯ DDD ä¸­çš„é‡ç‚¹ã€‚

4ï¼‰åŸºç¡€è®¾æ–½å±‚

åŸºç¡€è®¾æ–½å±‚æä¾›æŠ€æœ¯æ”¯æŒå’ŒæŒä¹…åŒ–æœåŠ¡ï¼Œé‡‡ç”¨ä¾èµ–å€’ç½®è®¾è®¡ï¼Œå°è£…åŸºç¡€èµ„æºã€‚è´Ÿè´£ä¸å¤–éƒ¨ç³»ç»Ÿï¼ˆå¦‚æ•°æ®åº“ã€æ¶ˆæ¯é˜Ÿåˆ—ã€ç¼“å­˜ç­‰ï¼‰çš„äº¤äº’ã€‚åŸºç¡€è®¾æ–½å±‚çš„ä¸»è¦èŒè´£æ˜¯å®ç°åº”ç”¨å±‚å’Œé¢†åŸŸå±‚æ‰€éœ€è¦çš„æŠ€æœ¯æœåŠ¡ï¼Œå¦‚æ•°æ®å­˜å‚¨ã€é‚®ä»¶å‘é€ã€æ—¥å¿—è®°å½•ç­‰ç­‰ã€‚

ä¾èµ–å€’ç½®è®¾è®¡å®é™…ä¸ŠæŒ‡çš„æ˜¯å„å±‚å¯¹åŸºç¡€èµ„æºï¼ˆå¦‚æ•°æ®åº“ï¼‰ä»…ä¾èµ–å…¶æ¥å£è€Œä¸æ˜¯å…·ä½“çš„å®ç°ï¼Œå‡è®¾åç»­æ›¿æ¢åŸºç¡€èµ„æºï¼ˆæ•°æ®åº“ï¼‰ï¼Œä»…éœ€æ›¿æ¢å…·ä½“å®ç°ï¼Œä¸éœ€è¦ä¿®æ”¹å„å±‚ä¾èµ–çš„ä»£ç ã€‚

#### ä¸‰å±‚æ¶æ„åˆ° DDD å››å±‚æ¶æ„çš„è½¬åŒ–

ä¸‰å±‚æ¶æ„æ˜¯ä¼ ç»Ÿçš„æ¶æ„æ¨¡å¼ï¼Œç»“åˆ SpringMVC é€šå¸¸ç”±ä»¥ä¸‹ä¸‰å±‚ç»„æˆï¼š

- è¡¨ç¤ºå±‚ï¼ˆController å±‚ï¼‰ï¼šå¤„ç† HTTP è¯·æ±‚ï¼Œè°ƒç”¨ä¸šåŠ¡å±‚çš„æœåŠ¡ï¼Œè¿”å›è§†å›¾æˆ–æ•°æ®ã€‚
- ä¸šåŠ¡é€»è¾‘å±‚ï¼ˆService å±‚ï¼‰ï¼šå°è£…æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼Œæ‰§è¡Œä¸šåŠ¡æ“ä½œã€‚
- æ•°æ®è®¿é—®å±‚ï¼ˆRepository å±‚ï¼‰ï¼šè´Ÿè´£ä¸æ•°æ®åº“äº¤äº’ï¼Œæ‰§è¡Œæ•°æ®çš„æŒä¹…åŒ–å’ŒæŸ¥æ‰¾ã€‚

è½¬åŒ– DDD å››å±‚æ¶æ„æ˜ å°„å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![img](assets/39EQxDS0JNf22dBk.webp)

ä¸»è¦æ”¹é€ ç‚¹å°±æ˜¯ä¸šåŠ¡é€»è¾‘å±‚çš„ Serviceï¼Œæ ¹æ®èšåˆæ‹†åˆ†åˆ°åº”ç”¨å±‚çš„åº”ç”¨æœåŠ¡ä¸é¢†åŸŸå±‚çš„é¢†åŸŸæœåŠ¡ï¼Œéƒ¨åˆ†ä¸šåŠ¡é€»è¾‘è¿˜ä¼šä»¥å……è¡€æ¨¡å‹ä¸‹æ²‰åˆ° Entity ä¸­ã€‚

æ¥ç€å°±æ˜¯æ•°æ®è®¿é—®å±‚çš„æ”¹é€ ï¼Œæ ¹æ®ä¾èµ–å€’ç½®åŸåˆ™ï¼Œ**æ•°æ®åº“çš„è®¿é—®æ¥å£ä¼šè¢«æ”¾åˆ°é¢†åŸŸå±‚ä¸­ï¼ˆå› ä¸ºå±äºè¡Œä¸ºï¼‰**ï¼Œå…·ä½“çš„è®¿é—®å®ç°åˆ™æ˜¯åœ¨åŸºç¡€è®¾æ–½å±‚å†…ï¼ˆä¸ºè¡Œä¸ºæä¾›æ”¯æŒï¼‰ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œç¬¬ä¸‰æ–¹å·¥å…·ã€Commonã€Config ç­‰éƒ½æ”¾åœ¨åŸºç¡€è®¾æ–½å±‚ä¸­ã€‚

### DDD ä»£ç æ¶æ„

é¦–å…ˆæ˜ç¡®ä¸€ç‚¹ï¼Œ**DDD ä»£ç æ¶æ„å¹¶æ²¡æœ‰ç»Ÿä¸€çš„æ ‡å‡†**ï¼Œä¸åŒå…¬å¸çš„æ¶æ„éƒ½æ˜¯ä¸ä¸€æ ·çš„ï¼ä½†æ˜¯æ ¸å¿ƒçš„æ€æƒ³éƒ½æ˜¯å¤§å·®ä¸å·®çš„ï¼Œä»…ä¸€äº›ç»†èŠ‚æœ‰è°ƒæ•´ã€‚

æŒ‰ç…§å››å±‚æ¶æ„ï¼Œæˆ‘ä»¬å¯ä»¥å»ºç«‹ interfacesï¼ˆç”¨æˆ·æ¥å£å±‚ï¼‰ã€applicationï¼ˆåº”ç”¨å±‚ï¼‰ã€domainï¼ˆé¢†åŸŸå±‚ï¼‰ã€infrastructureï¼ˆåŸºç¡€è®¾æ–½å±‚ï¼‰ è¿™ 4 ä¸ªåŒ…ã€‚

![img](assets/6tg4nlXeTiTmEBtj.webp)

interface æ˜¯ Java å…³é”®å­—ï¼Œå› æ­¤åŒ…ååŠ äº†ä¸ª sã€‚

#### 1ã€interface

è¯¥å±‚ä¸»è¦è´Ÿè´£ä¸å¤–éƒ¨ç³»ç»Ÿäº¤äº’ï¼ŒåŒ…æ‹¬ç”¨æˆ·ç•Œé¢ï¼ˆUIï¼‰ã€APIæ¥å£ã€è¯·æ±‚çš„æ¥æ”¶å’Œå“åº”çš„è¿”å›ç­‰ã€‚å®ƒä½œä¸ºé¢†åŸŸå±‚ä¸å¤–éƒ¨ä¸–ç•Œçš„æ¥å£ï¼Œç¡®ä¿é¢†åŸŸé€»è¾‘çš„è§£è€¦ã€‚

å­˜æ”¾çš„ä»£ç ï¼š

- æ§åˆ¶å™¨ï¼ˆControllerï¼‰ï¼šå¤„ç†HTTPè¯·æ±‚ï¼Œè´Ÿè´£è·¯ç”±å’Œè¯·æ±‚çš„è½¬å‘ã€‚
- REST API æ¥å£ï¼šå®šä¹‰æš´éœ²ç»™å¤–éƒ¨ç³»ç»Ÿçš„æœåŠ¡æ¥å£ã€‚
- è¯·æ±‚å’Œå“åº”å¯¹è±¡ï¼šç”¨äºä¸å¤–éƒ¨ç³»ç»Ÿäº¤æ¢æ•°æ®ã€‚

#### 2ã€application

è¯¥å±‚è´Ÿè´£åè°ƒå¤šä¸ªé¢†åŸŸå¯¹è±¡çš„æ“ä½œï¼Œå®Œæˆåº”ç”¨çº§çš„ä»»åŠ¡ã€‚å®ƒå……å½“é¢†åŸŸå±‚ä¸ç”¨æˆ·æ¥å£å±‚ä¹‹é—´çš„æ¡¥æ¢ï¼Œè°ƒç”¨é¢†åŸŸå±‚ä¸­çš„ä¸šåŠ¡é€»è¾‘ï¼Œå¹¶å°†ç»“æœè¿”å›ç»™ç”¨æˆ·æ¥å£å±‚ã€‚åº”ç”¨å±‚çš„èŒè´£æ˜¯å®ç°å…·ä½“ç”¨ä¾‹ï¼Œè€Œä¸åŒ…å«ä¸šåŠ¡è§„åˆ™ã€‚

å­˜æ”¾çš„ä»£ç ï¼š

- åº”ç”¨æœåŠ¡ï¼ˆApplication Serviceï¼‰ï¼šè´Ÿè´£ç»„ç»‡å’Œåè°ƒé¢†åŸŸå¯¹è±¡ï¼Œå¤„ç†è·¨å¤šä¸ªèšåˆçš„æ“ä½œï¼Œé€šå¸¸è¡¨ç¤ºåº”ç”¨ä¸­çš„å…·ä½“åŠŸèƒ½ï¼Œå¦‚â€œä¸‹è®¢å•â€æˆ–â€œæ³¨å†Œç”¨æˆ·â€ã€‚

#### 3ã€domain

è¯¥å±‚åŒ…å«æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼Œå®ƒæ˜¯ç³»ç»Ÿçš„æ ¸å¿ƒéƒ¨åˆ†ï¼Œè´Ÿè´£æ¨¡å‹çš„å®šä¹‰å’Œä¸šåŠ¡è§„åˆ™çš„å®ç°ã€‚é¢†åŸŸå±‚ä¸­çš„æ¨¡å‹ä»£è¡¨ç€ä¸šåŠ¡æ¦‚å¿µï¼Œé€šå¸¸ä¼šåŒ…æ‹¬èšåˆã€å®ä½“å’Œå€¼å¯¹è±¡ã€‚è¿™ä¸ªå±‚ä¸ä¾èµ–äºä»»ä½•å¤–éƒ¨æŠ€æœ¯æˆ–æ¡†æ¶ï¼Œå®ƒä¸“æ³¨äºä¸šåŠ¡æœ¬èº«ã€‚

å­˜æ”¾çš„ä»£ç ï¼š

- èšåˆï¼šä¸€ä¸ªèšåˆç”±å¤šä¸ªå®ä½“å’Œå€¼å¯¹è±¡æ„æˆï¼Œå®ƒä»¬ä¹‹é—´æœ‰ç€ä¸€è‡´çš„ä¸šåŠ¡è§„åˆ™ï¼Œ**ä¸€èˆ¬åŒ…åå°±ä»£è¡¨ä¸€ä¸ªèšåˆ**ã€‚
- å®ä½“ï¼šå…·æœ‰å”¯ä¸€æ ‡è¯†ç¬¦ï¼ˆIDï¼‰çš„å¯¹è±¡ã€‚
- å€¼å¯¹è±¡ï¼šæ²¡æœ‰èº«ä»½æ ‡è¯†ä¸”æ˜¯ä¸å¯å˜çš„å¯¹è±¡ï¼Œé€šå¸¸ç”¨äºè¡¨ç¤ºæŸä¸ªæ¦‚å¿µçš„å±æ€§ã€‚
- é¢†åŸŸæœåŠ¡ï¼šå½“æŸä¸ªä¸šåŠ¡é€»è¾‘æ— æ³•å½’å±åˆ°æŸä¸ªå®ä½“æˆ–èšåˆæ—¶ï¼Œä½¿ç”¨é¢†åŸŸæœåŠ¡æ¥å°è£…è¿™äº›ä¸šåŠ¡é€»è¾‘ã€‚
- é¢†åŸŸäº‹ä»¶ï¼šè¡¨ç¤ºé¢†åŸŸä¸­å‘ç”Ÿçš„æŸä¸ªé‡è¦äº‹ä»¶ï¼Œå¦‚â€œè®¢å•å·²æ”¯ä»˜â€ã€‚
- ä»“å‚¨æ¥å£ï¼šå®šä¹‰èµ„æºè®¿é—®çš„æ¥å£
- æŒä¹…åŒ–å¯¹è±¡ï¼šPOï¼ˆæ•°æ®åº“æŸ¥è¯¢é€»è¾‘ä¸å¤æ‚æ—¶ï¼Œå¯ä»¥çœç•¥ï¼‰

#### 4ã€infrastructure

è¯¥å±‚æä¾›æŠ€æœ¯æ”¯æŒï¼Œæ˜¯æ‰€æœ‰å…¶ä»–å±‚çš„åŸºç¡€è®¾æ–½ã€‚å®ƒåŒ…å«æ•°æ®åº“æ“ä½œã€æ¶ˆæ¯é˜Ÿåˆ—ã€ç¼“å­˜ã€æ–‡ä»¶å­˜å‚¨ç­‰ç¬¬ä¸‰æ–¹ä¾èµ–ã€‚åŸºç¡€è®¾æ–½å±‚å®ç°äº†ä¸å¤–éƒ¨ç³»ç»Ÿçš„äº¤äº’ï¼Œä½†ä¸åŒ…å«ä¸šåŠ¡é€»è¾‘ã€‚

å­˜æ”¾çš„ä»£ç ï¼š

- æŒä¹…åŒ–ï¼šå¦‚ä½¿ç”¨ JPA æˆ– MyBatis ç­‰æŠ€æœ¯å®ç°æ•°æ®åº“çš„è®¿é—®ã€‚
- å¤–éƒ¨ç³»ç»Ÿé›†æˆï¼šä¸å¤–éƒ¨æœåŠ¡æˆ–ç³»ç»Ÿçš„é€šä¿¡ï¼Œå¦‚è°ƒç”¨æ–‡ä»¶å­˜å‚¨ã€‚
- å·¥å…·ç±»å’ŒåŸºç¡€è®¾æ–½ç»„ä»¶ï¼šæä¾›è¯¸å¦‚æ—¥å¿—ã€å®šæ—¶ä»»åŠ¡ã€é‚®ä»¶å‘é€ç­‰åŠŸèƒ½ã€‚

#### é¡¹ç›®ç›®å½•ç»“æ„ç¤ºä¾‹

main/java åŒ…ä¸‹ï¼š

- applicationï¼ˆåº”ç”¨å±‚ï¼‰
- domainï¼ˆé¢†åŸŸå±‚ï¼‰
- orderï¼ˆè®¢å•èšåˆï¼‰
- entityï¼ˆå®ä½“ï¼‰
- valueObjectï¼ˆå€¼å¯¹è±¡ï¼‰
- eventï¼ˆäº‹ä»¶ï¼‰
- repositoryï¼ˆä»“å‚¨ï¼‰
- serviceï¼ˆé¢†åŸŸæœåŠ¡ï¼‰
- userï¼ˆç”¨æˆ·èšåˆï¼‰
- infrastructureï¼ˆåŸºç¡€è®¾æ–½å±‚ï¼‰
- apiï¼ˆå¤–éƒ¨æ¥å£ï¼‰
- configï¼ˆé…ç½®ï¼‰
- mqï¼ˆæ¶ˆæ¯é˜Ÿåˆ—ï¼‰
- repositoryï¼ˆä»“å‚¨å®ç°ï¼‰
- facadeï¼ˆä»“å‚¨æ¥å£ï¼‰
- poï¼ˆæŒä¹…åŒ–å¯¹è±¡ï¼‰
- utilï¼ˆå·¥å…·ç±»ï¼‰
- interfacesï¼ˆç”¨æˆ·æ¥å£å±‚ï¼‰
- assemblerï¼ˆå¯¹è±¡è½¬åŒ–ç±»ï¼‰
- dtoï¼ˆä¼ è¾“å¯¹è±¡ï¼‰
- controllerï¼ˆæä¾›ç»™ç”¨æˆ·ç•Œé¢ã€å¤–éƒ¨æœåŠ¡çš„æ¥å£ï¼‰
- sharedï¼ˆå…±äº«æ¨¡å—ï¼‰
- Application é¡¹ç›®ä¸»ç±»ï¼ˆæˆ–å¯åŠ¨ç±»ï¼‰

æ­¤å¤–ï¼Œå®ç° DDD çš„è¿‡ç¨‹ä¸­ï¼Œè¿˜å¯èƒ½ä¼šç”¨åˆ°å·¥å‚å’Œä»“å‚¨æ¨¡å¼ã€‚

- å·¥å‚ï¼šç”¨äºåˆ›å»ºèšåˆå’Œå®ä½“ï¼Œå› ä¸ºèšåˆæ ¹ä¸èšåˆå†…çš„å®ä½“ã€å€¼å¯¹è±¡å…³ç³»æ¯”è¾ƒå¤æ‚ï¼Œä¸ºäº†ç¡®ä¿å¯¹è±¡åˆ›å»ºçš„ä¸€è‡´æ€§å’Œå®Œæ•´æ€§ä¼šä½¿ç”¨å·¥å‚æ¨¡å¼æ¥åˆ›å»ºé¢†åŸŸå¯¹è±¡ï¼ˆé€šå¸¸ä»æ•°æ®åº“è·å– PO æŒä¹…åŒ–å¯¹è±¡åï¼Œé€šè¿‡å·¥å‚æ¨¡å¼åˆ›å»º DO é¢†åŸŸå¯¹è±¡ï¼‰ã€‚
- ä»“å‚¨ï¼šç”¨äºæŒä¹…åŒ–é¢†åŸŸå¯¹è±¡ï¼ˆå¦‚å®ä½“å’Œèšåˆï¼‰ï¼Œå®ƒå°è£…äº†æ•°æ®åº“æ“ä½œï¼Œä½¿å¾—ä¸šåŠ¡é€»è¾‘ä¸æ•°æ®å­˜å‚¨åˆ†ç¦»ã€‚

## å››ã€é¡¹ç›® DDD é‡æ„

ä¸‹é¢æˆ‘ä»¬è¦å°†é¡¹ç›®é‡æ„ä¸º DDD æ¨¡å¼ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸ä»…æ¶‰åŠåˆ°ç›®å½•ç»“æ„çš„æ”¹é€ ï¼Œè¿˜æ¶‰åŠåˆ°å¤§é‡æ–¹æ³•çš„é‡æ„ã€ä»£ç çš„æ”¹é€ ç­‰ã€‚

åœ¨å¼€å§‹ä¹‹å‰æ˜ç¡®ä¸€ç‚¹ï¼š**DDD é¡¹ç›®çš„æ”¹é€ æ²¡æœ‰ä¸€ä¸ªç»å¯¹çš„æ ‡å‡†ï¼**ä¸€å®šè¦æ ¹æ®å®é™…é¡¹ç›®çš„éœ€æ±‚å’Œå¤æ‚åº¦ç»¼åˆè¯„ä¼°æ”¹é€ çš„é€»è¾‘ã€‚

æ¥çœ‹ä¸‹æ”¹é€ åçš„é¡¹ç›®åŒ…ç»“æ„ï¼Œæœ‰ä¸ªå°è±¡å³å¯ï¼Œä¸‹é¢å¸¦å¤§å®¶ä¾æ¬¡å®æˆ˜ï¼š

![img](assets/oguuc5KMni0VlEuq.webp)

### æ”¹é€ æ–¹æ¡ˆ

#### 1ã€é¢†åŸŸåˆ’åˆ†

é¦–å…ˆï¼Œä»ç³»ç»Ÿçš„åŠŸèƒ½ç‚¹å‡ºå‘ï¼Œå¹¶ä¸”è€ƒè™‘åˆ°è¦åˆ©äºæ‹†åˆ†ï¼Œå°†ç³»ç»Ÿåˆ’åˆ†ä¸ºä»¥ä¸‹ 3 ä¸ªé¢†åŸŸï¼š

1. ç”¨æˆ·é¢†åŸŸï¼ˆUser Domainï¼‰ï¼Œç”¨æˆ·æ³¨å†Œã€ç™»å½•ã€è·å–ä¸ªäººä¿¡æ¯ç­‰ç­‰ç”¨æˆ·ç›¸å…³åŠŸèƒ½æ”¾åœ¨è¿™ä¸ªé¢†åŸŸä¸­ã€‚
2. å›¾ç‰‡é¢†åŸŸï¼ˆPicture Domainï¼‰ï¼ŒåŒ…æ‹¬å›¾ç‰‡ä¸Šä¼ ã€åˆ é™¤ã€ç¼–è¾‘ã€URL ä¸Šä¼ ã€æ‰¹é‡ç®¡ç†ç­‰åŠŸèƒ½ã€‚
3. ç©ºé—´é¢†åŸŸï¼ˆSpace Domainï¼‰ï¼ŒåŒ…æ‹¬ç©ºé—´åˆ›å»ºã€ç©ºé—´ç®¡ç†ã€ç©ºé—´åˆ†æã€ç©ºé—´æˆå‘˜ç®¡ç†ç­‰ã€‚

#### 2ã€æ”¹é€ æ–¹æ¡ˆ

ä¸€èˆ¬é¡¹ç›®çš„é‡æ„éƒ½è¦æœ‰åºè¿›è¡Œï¼Œæ‰€ä»¥æˆ‘ä»¬è¦å…ˆ **æµ…å±‚æ”¹é€ **ï¼Œä¹Ÿå°±æ˜¯å°†åŸæœ‰ä»£ç ç§»åŠ¨åˆ°ä¸åŒçš„ç›®å½•ä¸­ï¼Œä½†æ˜¯å°½é‡ä¸æ”¹å˜ä»£ç å†…å®¹æœ¬èº«ã€‚æœ‰äº›åšä¸»å°±æ˜¯è¿™ä¹ˆåšçš„ï¼Œå…¶å®æ˜¯ä¸€ç§çœäº‹å„¿çš„æ–¹æ³•ï¼Œä¸èƒ½è¯´è¿™æ ·æ”¹é€ å°±é”™äº†ï¼Œä½†æ•ˆæœå°±æ˜¯â€œé¡¹ç›®çœ‹èµ·æ¥åƒæ˜¯ DDD æ¶æ„è®¾è®¡â€ï¼Œå®é™…ä¸Šç¼ºå°‘çµé­‚ã€‚

æ‰€ä»¥åœ¨åˆ’åˆ†ç›®å½•åï¼Œè¿˜è¦ **æ·±å±‚æ”¹é€ **ï¼Œæ¯”å¦‚å°†åŸæœ‰çš„ Service å±‚æœåŠ¡è¿›è¡Œæ‹†åˆ†ï¼Œå°†å¯¹è±¡è½¬æ¢ç±»ä»£ç ç§»åŠ¨åˆ° interfaces å±‚çš„ assembler ä¸­ã€å°†ç®€å•çš„ä¸šåŠ¡é€»è¾‘ç§»åŠ¨åˆ° domain.entity å®ä½“ç±»ä¸­ã€å°†è·¨é¢†åŸŸè°ƒç”¨çš„æ–¹æ³•ç§»åŠ¨åˆ° application.service åº”ç”¨æœåŠ¡ä¸­ç­‰ç­‰ã€‚

å¤§å®¶æ€è€ƒä¸€ä¸‹ï¼Œå¦‚æœè®©ä½ æ¥æ”¹é€  DDD é¡¹ç›®ï¼Œä½ å…·ä½“ä¼šæ€ä¹ˆæ‰§è¡Œå‘¢ï¼Ÿ

æ˜¯å…ˆæŠŠ DDD ç›®å½•ç»“æ„å»ºå¥½ï¼Œåˆ†ä¸º 4 ä¸ªå±‚ï¼Œç„¶åä¾æ¬¡ä¸€å±‚ä¸€å±‚åœ°å®Œæˆ infrastructureã€domainã€applicationã€interface å±‚çš„ä»£ç ä¹ˆï¼Ÿ

è¿™å…¶å®æ˜¯ä¼ ç»Ÿçš„æ­£å‘æ€ç»´ï¼ŒæŒ‰ç…§ç›®æ ‡çš„ç›®å½•ç»“æ„æ¥é‡æ„ã€‚ä½†æ˜¯è¿™æ ·é‡æ„å¯èƒ½ä¼šå‡ºç°ä¸€ä¸ªé—®é¢˜ï¼Œæ¯”å¦‚æˆ‘åœ¨å¼€å‘ domain å±‚çš„æ—¶å€™ï¼Œæœ‰äº› service çš„æ–¹æ³•å¯èƒ½è¦ç§»åŠ¨åˆ° application å±‚æˆ–è€… interface å±‚ï¼Œè¿™å°±ä¼šå¯¼è‡´æˆ‘ä»¬å¼€å‘æ—¶ç»å¸¸è¦åœ¨å„å±‚çš„ç›®å½•ä¸­è¿›è¡Œè·³è½¬ï¼Œå¢åŠ äº†å¤æ‚åº¦ã€‚

æ‰€ä»¥è¿™é‡Œé±¼çš®ç»“åˆè‡ªå·±çš„ç»éªŒï¼Œç»™å¤§å®¶åˆ†äº«ä¸€ç§åˆå¿«é€Ÿã€åˆè½»æ¾ã€åˆè§„èŒƒçš„æ”¹é€ æ–¹æ³•ã€‚è®©æˆ‘ä»¬ä½¿ç”¨ **é€†å‘æ€ç»´**ï¼Œè¿˜åŸæˆ‘ä»¬æœ€åˆä» 0 å¼€å‘æœ¬é¡¹ç›®çš„æµç¨‹ï¼Œ**æ ¹æ®ç°æœ‰ä»£ç è¿›è¡Œæ‹†åˆ†ï¼Œè€Œä¸æ˜¯æŒ‰ç…§ç‰¹å®šçš„åˆ†å±‚ä¸€å±‚ä¸€å±‚æ‹†**ã€‚

ä¸¾ä¸ªä¾‹å­ï¼Œæ‹†åˆ†åŸé¡¹ç›® model åŒ…çš„æ—¶å€™ï¼Œå¯ä»¥æŠŠ entity æ”¾åˆ° domain å±‚ä¸­ï¼ŒæŠŠ dto å’Œ vo æ”¾åˆ° interface å±‚ä¸­ã€‚

è¿™æ ·ä¸ä»…æ€è·¯æ¸…æ™°ï¼Œä¸å®¹æ˜“é—æ¼ä»£ç ï¼Œè€Œä¸”æŒ‰ç…§ model => mapper => service => controller çš„é¡ºåºæ‹†åˆ†ï¼Œæ¯ä¸€å±‚éƒ½ä¸ä¼šç¼ºå°‘å¯¹ä¸‹ä¸€å±‚çš„ä¾èµ–ï¼Œä¸ä¼šå‡ºç°ç±»ä¸å­˜åœ¨çš„æƒ…å†µï¼Œèƒ½å¤Ÿå¤§å¹…æé«˜æ•ˆç‡ã€‚

æ­¤å¤–ï¼Œå»ºè®®å¤§å®¶ä¸€ä¸ªé¢†åŸŸä¸€ä¸ªé¢†åŸŸåœ°é‡æ„ï¼Œè€Œä¸æ˜¯ä¸€æ¬¡æ€§æŠŠå¤šä¸ªé¢†åŸŸçš„ä»£ç åŒæ—¶æ”¹é€ ï¼Œè¿™æ ·å‡ºäº†é—®é¢˜å°±ä¸å¥½è¿˜åŸäº†ã€‚

ğŸ’¡ DDD é‡æ„çš„æ€è·¯éƒ½æ˜¯ä¸€è‡´çš„ï¼Œå®Œæ•´é‡æ„æ•´ä¸ªé¡¹ç›®è‡³å°‘éœ€è¦å¥½å‡ ä¸ªå°æ—¶ï¼Œæ€§ä»·æ¯”ä¸é«˜ï¼Œå¤§å®¶åªéœ€è¦é‡ç‚¹å­¦ä¹ ä¸€ä¸ªé¢†åŸŸçš„é‡æ„å³å¯ã€‚

ä¸‹é¢æˆ‘ä»¬è¿›å…¥é¡¹ç›®é‡æ„ã€‚

### æ–°å»ºé¡¹ç›®

é¦–å…ˆåŸºäºåŸæœ‰çš„é¡¹ç›®å¤åˆ¶ä¸€ä¸ªæ–°çš„é¡¹ç›®ï¼Œç„¶åæ–°å»ºä¸€ä¸ªæ ¹åŒ…ï¼Œè€Œä¸æ˜¯æ”¹é€ åŸæœ‰çš„åŒ…ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å¯ä»¥æŒç»­å°†åŸæœ‰åŒ…çš„ä»£ç ç§»åŠ¨åˆ°æ–°åŒ…ä¸­ï¼Œä»è€Œæé«˜é‡æ„æ•ˆç‡ã€‚

éœ€è¦å…ˆå°† Spring Boot çš„å¯åŠ¨ç±»ç§»åŠ¨åˆ°æ–°åŒ…ä¸­ï¼Œåç»­æ‰èƒ½å¯åŠ¨é¡¹ç›®ã€‚

### åŸºç¡€è®¾æ–½å±‚

infrastructure å±‚æ˜¯å­˜æ”¾åŸºç¡€è®¾æ–½çš„ä»£ç ï¼Œä¹Ÿå°±æ˜¯é€šç”¨çš„ä»£ç ï¼Œæ‰€ä»¥è¦ä¼˜å…ˆé‡æ„ï¼Œæ­¥éª¤å¦‚ä¸‹ï¼š

1ï¼‰ç§»åŠ¨é€šç”¨ä»£ç ï¼šå…ˆæŠŠ annotationã€aopã€commonã€configã€exception åŒ…æ”¾åˆ° `infrastructure` åŒ…ä¸‹

2ï¼‰ç§»åŠ¨æ•°æ®è®¿é—®å±‚ mapper åŒ…ã€‚**æ³¨æ„ï¼Œè¦åŒæ­¥ä¿®æ”¹ MyBatisPlusConfig æ‰«æ mapper çš„åŒ…åï¼**

```java
@MapperScan("com.yupi.yupicture.infrastructure.mapper")
public class MyBatisPlusConfig {}
```

3ï¼‰å°† CosManager ç§»åŠ¨åˆ° api åŒ…ä¸­ï¼Œå› ä¸ºè¯¥ç±»ä¸»è¦æ˜¯è´Ÿè´£è°ƒç”¨ç¬¬ä¸‰æ–¹å¯¹è±¡å­˜å‚¨ APIï¼Œå’Œä¸šåŠ¡æ— å…³ï¼ˆå¯ä»¥æ”¹åä¸º CosApiï¼‰ã€‚

è¿™æ ·åŸåŒ…çš„æœ€å¤–å±‚å°±åªæœ‰ constantã€modelã€serviceã€controllerã€manager åŒ…äº†ï¼Œé‡æ„åçš„ `infrastructure` åŒ…ç»“æ„å¦‚å›¾ï¼š

![img](assets/qEyWZbltzb2pRKKL.webp)

ğŸ’¡ ä¸ºä»€ä¹ˆ Mapper åº”è¯¥æ”¾åœ¨ infrastructure å±‚ï¼Ÿ

1. èŒè´£åˆ’åˆ†ï¼šdomain å±‚æ˜¯ä¸šåŠ¡é€»è¾‘çš„æ ¸å¿ƒï¼Œåº”è¯¥ä¸“æ³¨äºé¢†åŸŸæ¨¡å‹å’Œä¸šåŠ¡è§„åˆ™ï¼Œé¿å…å¼•å…¥ä»»ä½•æŠ€æœ¯å®ç°çš„ç»†èŠ‚ã€‚
   infrastructure å±‚æ˜¯ç”¨æ¥å®ç°æŠ€æœ¯ç»†èŠ‚çš„ï¼ŒåŒ…æ‹¬æ•°æ®åº“è®¿é—®ã€ç¬¬ä¸‰æ–¹æœåŠ¡é›†æˆã€ç¼“å­˜å®ç°ç­‰ã€‚è€Œ MyBatis Plus çš„ Mapper ç±»å°±æ˜¯ä¸€ç§æ•°æ®åº“è®¿é—®çš„å®ç°ç»†èŠ‚ã€‚
2. ä¸ DDD çš„è®¾è®¡åŸåˆ™ä¿æŒä¸€è‡´ï¼šåœ¨ DDD ä¸­ï¼Œdomain å±‚çš„èŒè´£æ˜¯ç‹¬ç«‹äºæŠ€æœ¯å®ç°çš„ï¼Œä¸èƒ½ç›´æ¥ä¾èµ–å…·ä½“çš„æ¡†æ¶æˆ–æŒä¹…åŒ–æŠ€æœ¯ã€‚å°† Mapper æ”¾åœ¨ infrastructure å±‚ï¼Œå¯ä»¥é¿å…æŠ€æœ¯ç»†èŠ‚ â€œæ±¡æŸ“â€ é¢†åŸŸå±‚ï¼Œä¿æŒé¢†åŸŸæ¨¡å‹çš„çº¯ç²¹æ€§ã€‚

### ç”¨æˆ·é¢†åŸŸ

ä¸‹é¢æˆ‘ä»¬å…ˆæ‹†åˆ†é¡¹ç›®çš„æ ¸å¿ƒæ¨¡å— â€”â€” ç”¨æˆ·é¢†åŸŸï¼Œè¿™ä¸ªé¢†åŸŸæˆ‘ä¼šæ‹†åˆ†åœ°ç›¸å¯¹ç»†ä¸€äº›ï¼Œå¸¦å¤§å®¶å­¦ä¹ æ ‡å‡†çš„ DDD é‡æ„æ–¹æ³•ã€‚å­¦ä¼šè¿™ä¸€ä¸ªé¢†åŸŸä¹‹åï¼Œå…¶ä»–çš„é¢†åŸŸé‡æ„å°±å¾ˆç®€å•äº†ã€‚

#### 1ã€é‡æ„ model åŒ…

æŒ‰ç…§ä¸‹é¢çš„è§„åˆ™ï¼Œå°†åŸå§‹ model åŒ…ä¸­çš„ä»£ç ç§»åŠ¨åˆ°å¯¹åº”çš„æ–°ä½ç½®ï¼š

| åŸå§‹åŒ…         | é‡æ„åçš„åŒ…              | å¤‡æ³¨                          |
| -------------- | ----------------------- | ----------------------------- |
| model.entity   | domain.user.entity      | User ç±»                       |
| model.enums    | domain.user.valueobject | UserRoleEnum æšä¸¾ç±»           |
| model.dto.user | interfaces.dto.user     | è¯·æ±‚å°è£…ç±»                    |
| model.vo       | interfaces.vo.user      | å“åº”å°è£…ç±»LoginUserVOã€UserVO |

#### 2ã€é‡æ„ constant åŒ…

| åŸå§‹åŒ…   | é‡æ„åçš„åŒ…           | å¤‡æ³¨            |
| -------- | -------------------- | --------------- |
| constant | domain.user.constant | UserConstant ç±» |

#### 3ã€é‡æ„æ•°æ®è®¿é—®å±‚

æ ¹æ®å‰é¢è®²è¿‡çš„ä¾èµ–å€’ç½®åŸåˆ™ï¼Œåœ¨é¢†åŸŸåŒ…ä¸‹æ–°å»º `repository` åŒ…ï¼Œå®šä¹‰ä¸æ•°æ®åº“äº¤äº’çš„æ¥å£ï¼Œç„¶ååœ¨ `infrastructure.repository` ä¸­å†™ç›¸åº”çš„å®ç°ã€‚

ç”±äºæˆ‘ä»¬çš„é¡¹ç›®ä¸­ä½¿ç”¨äº† MyBatis Plus æ¡†æ¶ï¼Œå¯ä»¥è®©æ¥å£ç›´æ¥ç»§æ‰¿å…¶æä¾›çš„ IService æ¥å£ï¼Œæ¥å£çš„å®ç°ç»§æ‰¿ ServiceImpl ç±»ï¼Œè¿™æ ·å°±ç›´æ¥æ‹¥æœ‰äº†ä¸€æ‰¹æ“ä½œæ•°æ®åº“çš„æ–¹æ³•ï¼Œç®€åŒ–å¼€å‘ã€‚

æ–°å¢ UserRepository æ¥å£ï¼š

```java
package com.yupi.yupicture.domain.user.repository;

public interface UserRepository extends IService<User> {
}
```

æ–°å¢ UserRepositoryImpl å®ç°ç±»ï¼š

```java
package com.yupi.yupicture.infrastructure.repository;

@Service
public class UserRepositoryImpl extends ServiceImpl<UserMapper, User> implements UserRepository {
}
```

UserMapper ä¹‹å‰å·²ç»ç§»åŠ¨åˆ°äº† infrastructure åŒ…ä¸­ï¼Œä½œä¸ºå®ç°ä¸­çš„ä¸€éƒ¨åˆ†ã€‚

#### 4ã€é‡æ„ Service

Service å±‚çš„é‡æ„æ˜¯ç›¸å¯¹æœ€éº»çƒ¦çš„ï¼Œä½†æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ä¸€äº›å°æŠ€å·§å¤§å¹…æé«˜é‡æ„æ•ˆç‡ã€‚

1ï¼‰é¦–å…ˆï¼Œç›´æ¥åœ¨ IDE ä¸­ç§»åŠ¨ Service æ¥å£å’Œå®ç°ç±»åˆ°åº”ç”¨æœåŠ¡å±‚ã€‚

| åŸå§‹ç±»                       | é‡æ„åçš„ç±»                                          | å¤‡æ³¨           |
| ---------------------------- | --------------------------------------------------- | -------------- |
| service.UserService          | application.service.UserApplicationService          | åº”ç”¨æœåŠ¡æ¥å£   |
| service.impl.UserServiceImpl | application.service.impl.UserApplicationServiceImpl | åº”ç”¨æœåŠ¡å®ç°ç±» |

ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšå‘¢ï¼Ÿå› ä¸ºåº”ç”¨æœåŠ¡å±‚æ˜¯å¯ä¾›å…¶ä»–é¢†åŸŸè°ƒç”¨çš„ï¼Œè€Œä¹‹å‰çš„ Service ä¹Ÿæ˜¯å¯ä¾›å…¶ä»– Service è°ƒç”¨çš„ã€‚ç›´æ¥ç§»åŠ¨åï¼ŒIDE ä¼š **è‡ªåŠ¨é‡æ„ä»£ç **ï¼Œå°†å¯¹åŸå§‹æœåŠ¡æ¥å£çš„è°ƒç”¨æ”¹ä¸ºæ–°åº”ç”¨æœåŠ¡æ¥å£çš„è°ƒç”¨ï¼Œå‡å°‘äº†æ‰‹åŠ¨ä¿®æ”¹çš„ä»£ç é‡ã€‚

2ï¼‰å¤åˆ¶ Service æ¥å£å’Œå®ç°ç±»ä¸ºé¢†åŸŸæœåŠ¡å±‚ï¼š

| åŸå§‹ç±»                       | é‡æ„åçš„ç±»                                     | å¤‡æ³¨           |
| ---------------------------- | ---------------------------------------------- | -------------- |
| service.UserService          | domain.user.service.UserDomainService          | é¢†åŸŸæœåŠ¡æ¥å£   |
| service.impl.UserServiceImpl | domain.user.service.impl.UserDomainServiceImpl | é¢†åŸŸæœåŠ¡å®ç°ç±» |

ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšå‘¢ï¼Ÿå› ä¸ºé¢†åŸŸæœåŠ¡å±‚æ˜¯ç¼–å†™æ ¸å¿ƒä¸šåŠ¡é€»è¾‘çš„ä½ç½®ï¼Œä¹Ÿéœ€è¦è¢«åº”ç”¨æœåŠ¡å±‚è°ƒç”¨ï¼Œæ‰€ä»¥å…ˆæŠŠåŸæ¥çš„ Service æ¥å£å’Œå®ç°ç±»å¤åˆ¶è¿‡æ¥ï¼Œä¾¿äºç­‰ä¼šå„¿æŒ‰éœ€ä¿ç•™ä»£ç æˆ–æ‹†åˆ†ä»£ç ã€‚

3ï¼‰é‡æ„åº”ç”¨æœåŠ¡å±‚

application å±‚ä¸»è¦åšé¢†åŸŸæœåŠ¡çš„ç¼–æ’ï¼Œäº‹åŠ¡ä¸€èˆ¬ä¹Ÿäº¤ç”± application å±‚æ¥æ§åˆ¶ã€‚

åº”ç”¨æœåŠ¡å±‚éµå¾ªçš„åŸåˆ™ï¼š

- å°†ä¸šåŠ¡é€»è¾‘ä¸‹æ²‰åˆ° **é¢†åŸŸæœåŠ¡æˆ–å®ä½“ç±»** ä¸­ï¼Œåº”ç”¨æœåŠ¡å±‚éœ€è¦è°ƒç”¨é¢†åŸŸæœåŠ¡æˆ–å®ä½“ç±»æ¥å®Œæˆä¸šåŠ¡é€»è¾‘ã€‚
- å¦‚æœæŸä¸ªæ–¹æ³•éœ€è¦è°ƒç”¨å…¶ä»–åº”ç”¨æœåŠ¡ï¼ˆåœ¨å•ä¸ªé¢†åŸŸå†…æ— æ³•å®Œæˆï¼‰ï¼Œé‚£ä¹ˆè¯¥æ–¹æ³•ä¸èƒ½æ”¾åˆ°é¢†åŸŸæœåŠ¡ä¸­ï¼Œè€Œæ˜¯ä¿ç•™åœ¨åº”ç”¨æœåŠ¡ä¸­ï¼Œå› ä¸ºåŸåˆ™ä¸Šé¢†åŸŸæœåŠ¡ä¸åº”è¯¥è°ƒç”¨åº”ç”¨æœåŠ¡ã€‚
- è´Ÿè´£ä¸ºæ¥å£å±‚æä¾›è°ƒç”¨æ”¯æŒï¼Œå› ä¸ºåŸåˆ™ä¸Šæ¥å£å±‚åªèƒ½è°ƒç”¨åº”ç”¨æœåŠ¡å±‚ã€‚

æ¯”å¦‚ç”¨æˆ·æ³¨å†Œæ–¹æ³•ï¼ŒåŒ…å«äº†æ ¡éªŒå’Œæ‰§è¡Œæ³¨å†Œä¸¤éƒ¨åˆ†ä¸šåŠ¡é€»è¾‘ã€‚æ ¡éªŒé€»è¾‘ä¸æ¶‰åŠè°ƒç”¨æ•°æ®åº“ï¼Œæ˜¯å¯¹å®ä½“æœ¬èº«çš„æ ¡éªŒï¼Œæ‰€ä»¥å¯ä»¥ä¸‹æ²‰åˆ° User å®ä½“ä¸­ï¼›æ‰§è¡Œæ³¨å†Œéœ€è¦æ“ä½œæ•°æ®åº“ï¼Œå¯ä»¥ä¸‹æ²‰åˆ°é¢†åŸŸæœåŠ¡ UserDomainService ä¸­ã€‚è€Œåº”ç”¨æœåŠ¡å±‚è¦åšçš„å°±æ˜¯ç»„åˆè¿™äº›è°ƒç”¨ï¼Œå¹¶ä¸” **å¢åŠ äº‹åŠ¡** ç­‰ç‰¹æ€§ï¼Œå¾—åˆ°å®Œæ•´çš„åº”ç”¨æœåŠ¡æ–¹æ³•ã€‚ç”¨æˆ·ç™»å½•æ–¹æ³•åŒç†ã€‚

ç»™ User å®ä½“è¡¥å……æ–¹æ³•ï¼š

```java
/**
 * æ ¡éªŒç”¨æˆ·æ³¨å†Œ
 *
 * @param userAccount
 * @param userPassword
 * @param checkPassword
 */
public static void validUserRegister(String userAccount, String userPassword, String checkPassword) {
    // 1. æ ¡éªŒ
    if (StrUtil.hasBlank(userAccount, userPassword, checkPassword)) {
        throw new BusinessException(ErrorCode.PARAMS_ERROR, "å‚æ•°ä¸ºç©º");
    }
    if (userAccount.length() < 4) {
        throw new BusinessException(ErrorCode.PARAMS_ERROR, "ç”¨æˆ·è´¦å·è¿‡çŸ­");
    }
    if (userPassword.length() < 8 || checkPassword.length() < 8) {
        throw new BusinessException(ErrorCode.PARAMS_ERROR, "ç”¨æˆ·å¯†ç è¿‡çŸ­");
    }
    if (!userPassword.equals(checkPassword)) {
        throw new BusinessException(ErrorCode.PARAMS_ERROR, "ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´");
    }
}

/**
 * æ ¡éªŒç”¨æˆ·ç™»å½•
 *
 * @param userAccount
 * @param userPassword
 */
public static void validUserLogin(String userAccount, String userPassword) {
    if (StrUtil.hasBlank(userAccount, userPassword)) {
        throw new BusinessException(ErrorCode.PARAMS_ERROR, "å‚æ•°ä¸ºç©º");
    }
    if (userAccount.length() < 4) {
        throw new BusinessException(ErrorCode.PARAMS_ERROR, "è´¦å·é”™è¯¯");
    }
    if (userPassword.length() < 8) {
        throw new BusinessException(ErrorCode.PARAMS_ERROR, "å¯†ç é”™è¯¯");
    }
}
```

åº”ç”¨æœåŠ¡å±‚çš„ä»£ç å¦‚ä¸‹ï¼Œè¡¥å……äº†å¾ˆå¤š interfaces å±‚éœ€è¦è°ƒç”¨çš„æ–¹æ³•ï¼ˆæ¯”å¦‚ getUserByIdï¼‰ï¼š

```java
@Service
@Slf4j
public class UserApplicationServiceImpl implements UserApplicationService {

    @Resource
    private UserDomainService userDomainService;

    @Override
    @Transactional
    public long userRegister(UserRegisterRequest userRegisterRequest) {
        ThrowUtils.throwIf(userRegisterRequest == null, ErrorCode.PARAMS_ERROR);
        String userAccount = userRegisterRequest.getUserAccount();
        String userPassword = userRegisterRequest.getUserPassword();
        String checkPassword = userRegisterRequest.getCheckPassword();
        // æ ¡éªŒ
        User.validUserRegister(userAccount, userPassword, checkPassword);
        return userDomainService.userRegister(userAccount, userPassword, checkPassword);
    }

    @Override
    public LoginUserVO userLogin(UserLoginRequest userLoginRequest, HttpServletRequest request) {
        ThrowUtils.throwIf(userLoginRequest == null, ErrorCode.PARAMS_ERROR);
        String userAccount = userLoginRequest.getUserAccount();
        String userPassword = userLoginRequest.getUserPassword();
        // æ ¡éªŒ
        User.validUserLogin(userAccount, userPassword);
        return userDomainService.userLogin(userAccount, userPassword, request);
    }

    /**
     * è·å–å½“å‰ç™»å½•ç”¨æˆ·
     */
    @Override
    public User getLoginUser(HttpServletRequest request) {
        return userDomainService.getLoginUser(request);
    }

    /**
     * ç”¨æˆ·æ³¨é”€
     */
    @Override
    public boolean userLogout(HttpServletRequest request) {
        ThrowUtils.throwIf(request == null, ErrorCode.PARAMS_ERROR);
        return userDomainService.userLogout(request);
    }

    @Override
    public LoginUserVO getLoginUserVO(User user) {
        return userDomainService.getLoginUserVO(user);
    }

    @Override
    public UserVO getUserVO(User user) {
        return userDomainService.getUserVO(user);
    }

    @Override
    public List<UserVO> getUserVOList(List<User> userList) {
        return userDomainService.getUserVOList(userList);
    }

    @Override
    public QueryWrapper<User> getQueryWrapper(UserQueryRequest userQueryRequest) {
        return userDomainService.getQueryWrapper(userQueryRequest);
    }

    @Override
    public long addUser(User user) {
        return userDomainService.addUser(user);
    }

    @Override
    public User getUserById(long id) {
        ThrowUtils.throwIf(id <= 0, ErrorCode.PARAMS_ERROR);
        User user = userDomainService.getById(id);
        ThrowUtils.throwIf(user == null, ErrorCode.NOT_FOUND_ERROR);
        return user;
    }

    @Override
    public UserVO getUserVOById(long id) {
        return userDomainService.getUserVO(getUserById(id));
    }

    @Override
    public boolean deleteUser(DeleteRequest deleteRequest) {
        if (deleteRequest == null || deleteRequest.getId() <= 0) {
            throw new BusinessException(ErrorCode.PARAMS_ERROR);
        }
        return userDomainService.removeById(deleteRequest.getId());
    }

    @Override
    public void updateUser(User user) {
        boolean result = userDomainService.updateById(user);
        ThrowUtils.throwIf(!result, ErrorCode.OPERATION_ERROR);
    }

    @Override
    public Page<UserVO> listUserVOByPage(UserQueryRequest userQueryRequest) {
        ThrowUtils.throwIf(userQueryRequest == null, ErrorCode.PARAMS_ERROR);
        long current = userQueryRequest.getCurrent();
        long size = userQueryRequest.getPageSize();
        Page<User> userPage = userDomainService.page(new Page<>(current, size),
                userDomainService.getQueryWrapper(userQueryRequest));
        Page<UserVO> userVOPage = new Page<>(current, size, userPage.getTotal());
        List<UserVO> userVO = userDomainService.getUserVOList(userPage.getRecords());
        userVOPage.setRecords(userVO);
        return userVOPage;
    }

    @Override
    public List<User> listByIds(Set<Long> userIdSet) {
        return userDomainService.listByIds(userIdSet);
    }

    @Override
    public String getEncryptPassword(String userPassword) {
        return userDomainService.getEncryptPassword(userPassword);
    }
}
```

ğŸ’¡ å°æŠ€å·§ï¼šåªè¦å‘ç°ä¸è°ƒç”¨å…¶ä»–åº”ç”¨æœåŠ¡çš„æ–¹æ³•ã€å¹¶ä¸”ä¸è°ƒç”¨ â€œå½“å‰ç±»ä¸­ä¾èµ–å…¶ä»–åº”ç”¨æœåŠ¡â€ çš„æ–¹æ³•ï¼Œå°±å¯ä»¥æ”¹ä¸ºè°ƒç”¨é¢†åŸŸæœåŠ¡ï¼›å¦åˆ™è¯¥æ–¹æ³•éœ€è¦åœ¨åº”ç”¨æœåŠ¡ä¸­å®ç°ã€‚

4ï¼‰é‡æ„é¢†åŸŸæœåŠ¡å±‚

é¢†åŸŸæœåŠ¡å±‚éµå¾ªçš„åŸåˆ™ï¼š

- éœ€è¦è°ƒç”¨æ•°æ®åº“æœåŠ¡ï¼ˆrepositoryï¼‰æˆ–åŸºç¡€è®¾æ–½å±‚ï¼ˆinfrastructureï¼‰æ¥å®Œæˆä¸šåŠ¡é€»è¾‘
- å¯ä»¥æ ¹æ®éœ€è¦ï¼Œå°†å’Œå®ä½“å¼ºç›¸å…³çš„ä¸šåŠ¡é€»è¾‘ä¸‹æ²‰åˆ° **å®ä½“ç±»** ä¸­

æ¯”å¦‚ç”¨æˆ·æ³¨å†Œå’Œç”¨æˆ·ç™»å½•æ–¹æ³•ï¼Œæ— éœ€å†åŒ…å«æ ¡éªŒé€»è¾‘ï¼ˆå·²ç»ä¸‹æ²‰åˆ°äº† User å®ä½“ç±»ä¸­ï¼‰ï¼Œåªéœ€è¦è°ƒç”¨ UserRepository æ‰§è¡Œæ•°æ®åº“æ“ä½œå³å¯ã€‚

åƒ `isAdmin` è¿™æ ·æ ¹æ® User å¯¹è±¡è¿›è¡Œåˆ¤æ–­çš„æ–¹æ³•ï¼Œå¯ä»¥ä¸‹æ²‰åˆ° User å®ä½“ç±»ä¸­ï¼š

```java
/**
 * æ˜¯å¦ä¸ºç®¡ç†å‘˜
 *
 * @return
 */
public boolean isAdmin() {
    return UserRoleEnum.ADMIN.getValue().equals(this.getUserRole());
}
```

é¢†åŸŸæœåŠ¡å±‚çš„ä»£ç å¦‚ä¸‹ï¼Œè¡¥å……äº†å¾ˆå¤šåº”ç”¨æœåŠ¡å±‚éœ€è¦è°ƒç”¨çš„æ–¹æ³•ï¼ˆæ¯”å¦‚ getByIdï¼‰ï¼š

```java
@Service
@Slf4j
public class UserDomainServiceImpl implements UserDomainService {

    @Resource
    private UserRepository userRepository;

    @Override
    public long userRegister(String userAccount, String userPassword, String checkPassword) {
        // æ£€æŸ¥æ˜¯å¦é‡å¤
        QueryWrapper<User> queryWrapper = new QueryWrapper<>();
        queryWrapper.eq("userAccount", userAccount);
        long count = userRepository.getBaseMapper().selectCount(queryWrapper);
        if (count > 0) {
            throw new BusinessException(ErrorCode.PARAMS_ERROR, "è´¦å·é‡å¤");
        }
        // åŠ å¯†
        String encryptPassword = getEncryptPassword(userPassword);
        // æ’å…¥æ•°æ®
        User user = new User();
        user.setUserAccount(userAccount);
        user.setUserPassword(encryptPassword);
        user.setUserName("æ— å");
        user.setUserRole(UserRoleEnum.USER.getValue());
        boolean saveResult = userRepository.save(user);
        if (!saveResult) {
            throw new BusinessException(ErrorCode.SYSTEM_ERROR, "æ³¨å†Œå¤±è´¥ï¼Œæ•°æ®åº“é”™è¯¯");
        }
        return user.getId();
    }

    @Override
    public LoginUserVO userLogin(String userAccount, String userPassword, HttpServletRequest request) {
        // 2. åŠ å¯†
        String encryptPassword = getEncryptPassword(userPassword);
        // æŸ¥è¯¢ç”¨æˆ·æ˜¯å¦å­˜åœ¨
        QueryWrapper<User> queryWrapper = new QueryWrapper<>();
        queryWrapper.eq("userAccount", userAccount);
        queryWrapper.eq("userPassword", encryptPassword);
        User user = userRepository.getBaseMapper().selectOne(queryWrapper);
        // ç”¨æˆ·ä¸å­˜åœ¨
        if (user == null) {
            log.info("user login failed, userAccount cannot match userPassword");
            throw new BusinessException(ErrorCode.PARAMS_ERROR, "ç”¨æˆ·ä¸å­˜åœ¨æˆ–å¯†ç é”™è¯¯");
        }
        // 3. è®°å½•ç”¨æˆ·çš„ç™»å½•æ€
        request.getSession().setAttribute(USER_LOGIN_STATE, user);
        // 4. è®°å½•ç”¨æˆ·ç™»å½•æ€åˆ° Sa-tokenï¼Œä¾¿äºç©ºé—´é‰´æƒæ—¶ä½¿ç”¨ï¼Œæ³¨æ„ä¿è¯è¯¥ç”¨æˆ·ä¿¡æ¯ä¸ SpringSession ä¸­çš„ä¿¡æ¯è¿‡æœŸæ—¶é—´ä¸€è‡´
        StpKit.SPACE.login(user.getId());
        StpKit.SPACE.getSession().set(USER_LOGIN_STATE, user);
        return this.getLoginUserVO(user);
    }

    /**
     * è·å–å½“å‰ç™»å½•ç”¨æˆ·
     */
    @Override
    public User getLoginUser(HttpServletRequest request) {
        // å…ˆåˆ¤æ–­æ˜¯å¦å·²ç™»å½•
        Object userObj = request.getSession().getAttribute(USER_LOGIN_STATE);
        User currentUser = (User) userObj;
        if (currentUser == null || currentUser.getId() == null) {
            throw new BusinessException(ErrorCode.NOT_LOGIN_ERROR);
        }
        // ä»æ•°æ®åº“æŸ¥è¯¢ï¼ˆè¿½æ±‚æ€§èƒ½çš„è¯å¯ä»¥æ³¨é‡Šï¼Œç›´æ¥è¿”å›ä¸Šè¿°ç»“æœï¼‰
        long userId = currentUser.getId();
        currentUser = userRepository.getById(userId);
        if (currentUser == null) {
            throw new BusinessException(ErrorCode.NOT_LOGIN_ERROR);
        }
        return currentUser;
    }

    /**
     * ç”¨æˆ·æ³¨é”€
     */
    @Override
    public boolean userLogout(HttpServletRequest request) {
        // å…ˆåˆ¤æ–­æ˜¯å¦å·²ç™»å½•
        Object userObj = request.getSession().getAttribute(USER_LOGIN_STATE);
        if (userObj == null) {
            throw new BusinessException(ErrorCode.OPERATION_ERROR, "æœªç™»å½•");
        }
        // ç§»é™¤ç™»å½•æ€
        request.getSession().removeAttribute(USER_LOGIN_STATE);
        StpKit.SPACE.logout();
        return true;
    }

    @Override
    public LoginUserVO getLoginUserVO(User user) {
        if (user == null) {
            return null;
        }
        LoginUserVO loginUserVO = new LoginUserVO();
        BeanUtils.copyProperties(user, loginUserVO);
        return loginUserVO;
    }

    @Override
    public UserVO getUserVO(User user) {
        if (user == null) {
            return null;
        }
        UserVO userVO = new UserVO();
        BeanUtils.copyProperties(user, userVO);
        return userVO;
    }

    @Override
    public List<UserVO> getUserVOList(List<User> userList) {
        if (CollUtil.isEmpty(userList)) {
            return new ArrayList<>();
        }
        return userList.stream().map(this::getUserVO).collect(Collectors.toList());
    }

    @Override
    public QueryWrapper<User> getQueryWrapper(UserQueryRequest userQueryRequest) {
        if (userQueryRequest == null) {
            throw new BusinessException(ErrorCode.PARAMS_ERROR, "è¯·æ±‚å‚æ•°ä¸ºç©º");
        }
        Long id = userQueryRequest.getId();
        String userAccount = userQueryRequest.getUserAccount();
        String userName = userQueryRequest.getUserName();
        String userProfile = userQueryRequest.getUserProfile();
        String userRole = userQueryRequest.getUserRole();
        String sortField = userQueryRequest.getSortField();
        String sortOrder = userQueryRequest.getSortOrder();
        QueryWrapper<User> queryWrapper = new QueryWrapper<>();
        queryWrapper.eq(ObjUtil.isNotNull(id), "id", id);
        queryWrapper.eq(StrUtil.isNotBlank(userRole), "userRole", userRole);
        queryWrapper.like(StrUtil.isNotBlank(userAccount), "userAccount", userAccount);
        queryWrapper.like(StrUtil.isNotBlank(userName), "userName", userName);
        queryWrapper.like(StrUtil.isNotBlank(userProfile), "userProfile", userProfile);
        queryWrapper.orderBy(StrUtil.isNotEmpty(sortField), sortOrder.equals("ascend"), sortField);
        return queryWrapper;
    }

    @Override
    public String getEncryptPassword(String userPassword) {
        // ç›å€¼ï¼Œæ··æ·†å¯†ç 
        final String SALT = "yupi";
        return DigestUtils.md5DigestAsHex((SALT + userPassword).getBytes());
    }

    @Override
    public Long addUser(User user) {
        // é»˜è®¤å¯†ç  12345678
        final String DEFAULT_PASSWORD = "12345678";
        String encryptPassword = this.getEncryptPassword(DEFAULT_PASSWORD);
        user.setUserPassword(encryptPassword);
        boolean result = userRepository.save(user);
        ThrowUtils.throwIf(!result, ErrorCode.OPERATION_ERROR);
        return user.getId();
    }

    @Override
    public Boolean removeById(Long id) {
        return userRepository.removeById(id);
    }

    @Override
    public boolean updateById(User user) {
        return userRepository.updateById(user);
    }

    @Override
    public User getById(long id) {
        return userRepository.getById(id);
    }

    @Override
    public Page<User> page(Page<User> userPage, QueryWrapper<User> queryWrapper) {
        return userRepository.page(userPage, queryWrapper);
    }

    @Override
    public List<User> listByIds(Set<Long> userIdSet) {
        return userRepository.listByIds(userIdSet);
    }
}
```

ğŸ’¡ å°æŠ€å·§

1. ä¿®æ”¹é¢†åŸŸæœåŠ¡æ—¶ï¼Œå¦‚æœå‘ç°æŸä¸ªæ–¹æ³•æ²¡è¢« application è°ƒç”¨ï¼ˆIDE æ˜¾ç¤ºç°è‰²ï¼‰ï¼Œå°±å¯ä»¥ç›´æ¥ç§»é™¤æ‰ã€‚
2. å¦‚æœæƒ³èŠ‚çœé‡å¤ç¼–å†™å¢åˆ æ”¹æŸ¥ç­‰æ ·æ¿ä»£ç çš„æ—¶é—´ï¼Œåº”ç”¨æœåŠ¡æˆ–é¢†åŸŸæœåŠ¡ä¹Ÿå¯ä»¥ç›´æ¥ç»§æ‰¿ MyBatis Plus çš„æ¥å£å’Œå®ç°ç±»ï¼Œè¿™æ ·è™½ç„¶ DDD ç›®å½•ç»“æ„ä¸æ˜¯ 100% æ ‡å‡†ï¼Œä½†æ˜¯èƒ½å¤§å¹…å‡å°‘å¼€å‘æˆæœ¬ã€‚

#### 5ã€é‡æ„ Controller

1ï¼‰é¦–å…ˆå°†åŸå§‹ UserController ç§»åŠ¨ä¸º `interfaces.controller.UserController` ç±»ã€‚

2ï¼‰ä¸ºä¿è¯æ¥å£å±‚çš„ç²¾ç®€ï¼Œéœ€è¦å°†å…¶ä¸­çš„ä»£ç ä¸‹æ²‰åˆ° **è½¬æ¢ç±»å’Œåº”ç”¨æœåŠ¡** ä¸­ã€‚é¦–å…ˆç¼–å†™è½¬æ¢ç±» `interfaces.assembler.UserAssembler`ï¼Œè´Ÿè´£å°† DTO è½¬ä¸ºå®ä½“ç±»ï¼š

```java
/**
 * ç”¨æˆ·å¯¹è±¡è½¬æ¢
 */
public class UserAssembler {

    public static User toUserEntity(UserAddRequest request) {
        User user = new User();
        BeanUtils.copyProperties(request, user);
        return user;
    }

    public static User toUserEntity(UserUpdateRequest request) {
        User user = new User();
        BeanUtils.copyProperties(request, user);
        return user;
    }
}
```

3ï¼‰å°† Controller çš„ä»£ç ä¸‹æ²‰åˆ°åº”ç”¨æœåŠ¡ä¸­ï¼Œè°ƒç”¨åº”ç”¨æœåŠ¡å’Œ Assembler æ¥å¤„ç†è¯·æ±‚ã€‚å¯èƒ½ä¼šæ¶‰åŠåˆ°åº”ç”¨æœåŠ¡æ–¹æ³•çš„å‚æ•°ä¿®æ”¹ï¼Œä»£ç å¦‚ä¸‹ï¼š

```java
/**
 * ç”¨æˆ·æ¥å£
 */
@RestController
@RequestMapping("/user")
public class UserController {

    @Resource
    private UserApplicationService userApplicationService;

    // region ç™»å½•ç›¸å…³

    /**
     * ç”¨æˆ·æ³¨å†Œ
     */
    @PostMapping("/register")
    public BaseResponse<Long> userRegister(@RequestBody UserRegisterRequest userRegisterRequest) {
        long result = userApplicationService.userRegister(userRegisterRequest);
        return ResultUtils.success(result);
    }

    /**
     * ç”¨æˆ·ç™»å½•
     */
    @PostMapping("/login")
    public BaseResponse<LoginUserVO> userLogin(@RequestBody UserLoginRequest userLoginRequest, HttpServletRequest request) {
        LoginUserVO loginUserVO = userApplicationService.userLogin(userLoginRequest, request);
        return ResultUtils.success(loginUserVO);
    }

    /**
     * ç”¨æˆ·æ³¨é”€
     */
    @PostMapping("/logout")
    public BaseResponse<Boolean> userLogout(HttpServletRequest request) {
        boolean result = userApplicationService.userLogout(request);
        return ResultUtils.success(result);
    }

    /**
     * è·å–å½“å‰ç™»å½•ç”¨æˆ·
     */
    @GetMapping("/get/login")
    public BaseResponse<LoginUserVO> getLoginUser(HttpServletRequest request) {
        User user = userApplicationService.getLoginUser(request);
        return ResultUtils.success(userApplicationService.getLoginUserVO(user));
    }

    // endregion

    // region å¢åˆ æ”¹æŸ¥

    /**
     * åˆ›å»ºç”¨æˆ·
     */
    @PostMapping("/add")
    @AuthCheck(mustRole = UserConstant.ADMIN_ROLE)
    public BaseResponse<Long> addUser(@RequestBody UserAddRequest userAddRequest) {
        ThrowUtils.throwIf(userAddRequest == null, ErrorCode.PARAMS_ERROR);
        User userEntity = UserAssembler.toUserEntity(userAddRequest);
        return ResultUtils.success(userApplicationService.addUser(userEntity));
    }

    /**
     * æ ¹æ® id è·å–ç”¨æˆ·ï¼ˆä»…ç®¡ç†å‘˜ï¼‰
     */
    @GetMapping("/get")
    @AuthCheck(mustRole = UserConstant.ADMIN_ROLE)
    public BaseResponse<User> getUserById(long id) {
        User user = userApplicationService.getUserById(id);
        return ResultUtils.success(user);
    }

    /**
     * æ ¹æ® id è·å–åŒ…è£…ç±»
     */
    @GetMapping("/get/vo")
    public BaseResponse<UserVO> getUserVOById(long id) {
        return ResultUtils.success(userApplicationService.getUserVOById(id));
    }

    /**
     * åˆ é™¤ç”¨æˆ·
     */
    @PostMapping("/delete")
    @AuthCheck(mustRole = UserConstant.ADMIN_ROLE)
    public BaseResponse<Boolean> deleteUser(@RequestBody DeleteRequest deleteRequest) {
        boolean b = userApplicationService.deleteUser(deleteRequest);
        return ResultUtils.success(b);
    }

    /**
     * æ›´æ–°ç”¨æˆ·
     */
    @PostMapping("/update")
    @AuthCheck(mustRole = UserConstant.ADMIN_ROLE)
    public BaseResponse<Boolean> updateUser(@RequestBody UserUpdateRequest userUpdateRequest) {
        ThrowUtils.throwIf(userUpdateRequest == null, ErrorCode.PARAMS_ERROR);
        User userEntity = UserAssembler.toUserEntity(userUpdateRequest);
        userApplicationService.updateUser(userEntity);
        return ResultUtils.success(true);
    }

    /**
     * åˆ†é¡µè·å–ç”¨æˆ·å°è£…åˆ—è¡¨ï¼ˆä»…ç®¡ç†å‘˜ï¼‰
     *
     * @param userQueryRequest æŸ¥è¯¢è¯·æ±‚å‚æ•°
     */
    @PostMapping("/list/page/vo")
    @AuthCheck(mustRole = UserConstant.ADMIN_ROLE)
    public BaseResponse<Page<UserVO>> listUserVOByPage(@RequestBody UserQueryRequest userQueryRequest) {
        Page<UserVO> userVOPage = userApplicationService.listUserVOByPage(userQueryRequest);
        return ResultUtils.success(userVOPage);
    }

    // endregion
}
```

è¿™æ ·ä¸€æ¥ï¼Œæ¥å£çš„ä»£ç ä¿æŒäº†æè‡´çš„ç²¾ç®€ã€‚

ğŸ’¡ å‰é¢ä¹Ÿæåˆ°äº†ï¼Œå¦‚æœè§‰å¾—ä¸€å±‚ä¸€å±‚è¡¥å……è°ƒç”¨æ–¹æ³•è¿‡äºéº»çƒ¦ï¼Œå¯ä»¥ç›´æ¥ç»™åº”ç”¨æœåŠ¡æˆ–é¢†åŸŸæœåŠ¡ç»§æ‰¿ MyBatis Plus çš„ IService å’Œ ServiceImplï¼Œä¾¿äºä¸Šä¸€å±‚è°ƒç”¨ã€‚

#### 6ã€å…¶ä»–ä»£ç å…¼å®¹

å°è¯•å¯åŠ¨é¡¹ç›®ï¼Œåº”è¯¥ä¼šå‡ºç°ç¼–è¯‘é”™è¯¯ï¼Œæˆ‘ä»¬æ ¹æ®æŠ¥é”™æç¤ºä¾æ¬¡è§£å†³å³å¯ã€‚æ¯”å¦‚ä¿®æ”¹ä¸‹é¢å‡ ä¸ªé—®é¢˜ï¼š

1ï¼‰ä¿®æ”¹ isAdmin çš„è°ƒç”¨ï¼Œæ”¹ä¸ºè°ƒç”¨å¯¹è±¡çš„æ–¹æ³•ï¼š

```java
åŸå§‹ï¼šuserApplicationService.isAdmin(loginUser)
æ”¹ä¸ºï¼šloginUser.isAdmin()
```

2ï¼‰ç»™ç”¨æˆ·åº”ç”¨æœåŠ¡ UserApplicationService è¡¥å……å…¶ä»–åº”ç”¨æœåŠ¡éœ€è¦çš„æ–¹æ³•ï¼Œæ¯”å¦‚ listByIdsã€‚

é™¤éè€ƒè™‘åˆ°å¼€å‘æ—¶é—´æˆæœ¬çš„é—®é¢˜ï¼Œå¦åˆ™å…¶ä»–åº”ç”¨æœåŠ¡å°½é‡è°ƒç”¨åº”ç”¨æœåŠ¡å±‚çš„æ–¹æ³•ï¼Œè€Œä¸æ˜¯é¢†åŸŸæœåŠ¡å±‚ã€‚

æœ€ç»ˆï¼Œå°è¯•å¯åŠ¨é¡¹ç›®ï¼Œåªè¦ä¸æŠ¥ç¼–è¯‘é”™è¯¯ï¼Œå°±ç®—æ˜¯é‡æ„å®Œæˆäº†ï¼Œå³ä½¿é¡¹ç›®å¯åŠ¨ä¸èµ·æ¥ä¹Ÿä¸ç”¨åœ¨æ„ï¼Œå› ä¸ºæˆ‘ä»¬æœ‰äº›æœåŠ¡è¿˜æ²¡æœ‰é‡æ„å®Œã€‚

### å›¾ç‰‡é¢†åŸŸ

é€šè¿‡ç”¨æˆ·é¢†åŸŸï¼Œç›¸ä¿¡å¤§å®¶å·²ç»å­¦ä¼šé¢†åŸŸçš„æ‹†åˆ†æ–¹æ³•äº†ï¼Œæ¥ä¸‹æ¥å›¾ç‰‡é¢†åŸŸå’Œç©ºé—´é¢†åŸŸå°±ä¸å¸¦å¤§å®¶æ‹†åˆ†å¾—é‚£ä¹ˆç»†èŠ‚äº†ï¼Œæˆ‘ä»¬ç®€å•å°†é¡¹ç›®è¿›è¡Œé‡æ„å³å¯ã€‚

#### 1ã€é‡æ„ model åŒ…

æŒ‰ç…§ä¸‹é¢çš„è§„åˆ™ï¼Œå°†åŸå§‹ model åŒ…ä¸­çš„ä»£ç ç§»åŠ¨åˆ°å¯¹åº”çš„æ–°ä½ç½®ï¼š

| åŸå§‹åŒ…            | é‡æ„åçš„åŒ…                 | å¤‡æ³¨                                     |
| ----------------- | -------------------------- | ---------------------------------------- |
| model.entity      | domain.picture.entity      | Picture ç±»                               |
| model.enums       | domain.picture.valueobject | PictureReviewStatusEnum æšä¸¾ç±»           |
| model.dto.picture | interfaces.dto.picture     | è¯·æ±‚å°è£…ç±»                               |
| model.vo          | interfaces.vo.picture      | å“åº”å°è£…ç±» PictureVOã€PictureTagCategory |

#### 2ã€é‡æ„æ•°æ®è®¿é—®å±‚

æ ¹æ®å‰é¢è®²è¿‡çš„ä¾èµ–å€’ç½®åŸåˆ™ï¼Œåœ¨é¢†åŸŸåŒ…ä¸‹æ–°å»º `repository` åŒ…ï¼Œå®šä¹‰ä¸æ•°æ®åº“äº¤äº’çš„æ¥å£ï¼Œç„¶ååœ¨ `infrastructure.repository` ä¸­å†™ç›¸åº”çš„å®ç°ã€‚

ç”±äºæˆ‘ä»¬çš„é¡¹ç›®ä¸­ä½¿ç”¨äº† MyBatis Plus æ¡†æ¶ï¼Œå¯ä»¥è®©æ¥å£ç›´æ¥ç»§æ‰¿å…¶æä¾›çš„ IService æ¥å£ï¼Œæ¥å£çš„å®ç°ç»§æ‰¿ ServiceImpl ç±»ï¼Œè¿™æ ·å°±ç›´æ¥æ‹¥æœ‰äº†ä¸€æ‰¹æ“ä½œæ•°æ®åº“çš„æ–¹æ³•ï¼Œç®€åŒ–å¼€å‘ã€‚

æ–°å¢ PictureRepository æ¥å£ï¼š

```java
package com.yupi.yupicture.domain.picture.repository;

public interface PictureRepository extends IService<Picture> {
}
```

æ–°å¢ PictureRepositoryImpl å®ç°ç±»ï¼š

```java
package com.yupi.yupicture.infrastructure.repository;

@Service
public class PictureRepositoryImpl extends ServiceImpl<PictureMapper, Picture> implements PictureRepository {
}
```

PictureMapper ä¹‹å‰å·²ç»ç§»åŠ¨åˆ°äº† infrastructure åŒ…ä¸­ï¼Œä½œä¸ºå®ç°ä¸­çš„ä¸€éƒ¨åˆ†ã€‚

#### 3ã€é‡æ„ Service

Service å±‚çš„é‡æ„æ˜¯ç›¸å¯¹æœ€éº»çƒ¦çš„ï¼Œä½†æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ä¸€äº›å°æŠ€å·§å¤§å¹…æé«˜é‡æ„æ•ˆç‡ã€‚

1ï¼‰é¦–å…ˆï¼Œç›´æ¥åœ¨ IDE ä¸­ç§»åŠ¨ Service æ¥å£å’Œå®ç°ç±»åˆ°åº”ç”¨æœåŠ¡å±‚ã€‚

| åŸå§‹ç±»                          | é‡æ„åçš„ç±»                                             | å¤‡æ³¨           |
| ------------------------------- | ------------------------------------------------------ | -------------- |
| service.PictureService          | application.service.PictureApplicationService          | åº”ç”¨æœåŠ¡æ¥å£   |
| service.impl.PictureServiceImpl | application.service.impl.PictureApplicationServiceImpl | åº”ç”¨æœåŠ¡å®ç°ç±» |

ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšå‘¢ï¼Ÿå› ä¸ºåº”ç”¨æœåŠ¡å±‚æ˜¯å¯ä¾›å…¶ä»–é¢†åŸŸè°ƒç”¨çš„ï¼Œè€Œä¹‹å‰çš„ Service ä¹Ÿæ˜¯å¯ä¾›å…¶ä»– Service è°ƒç”¨çš„ã€‚ç›´æ¥ç§»åŠ¨åï¼ŒIDE ä¼š **è‡ªåŠ¨é‡æ„ä»£ç **ï¼Œå°†å¯¹åŸå§‹æœåŠ¡æ¥å£çš„è°ƒç”¨æ”¹ä¸ºæ–°åº”ç”¨æœåŠ¡æ¥å£çš„è°ƒç”¨ï¼Œå‡å°‘äº†æ‰‹åŠ¨ä¿®æ”¹çš„ä»£ç é‡ã€‚

2ï¼‰å¤åˆ¶ Service æ¥å£å’Œå®ç°ç±»ä¸ºé¢†åŸŸæœåŠ¡å±‚ï¼š

| åŸå§‹ç±»                          | é‡æ„åçš„ç±»                                        | å¤‡æ³¨           |
| ------------------------------- | ------------------------------------------------- | -------------- |
| service.PictureService          | domain.user.service.PictureDomainService          | é¢†åŸŸæœåŠ¡æ¥å£   |
| service.impl.PictureServiceImpl | domain.user.service.impl.PictureDomainServiceImpl | é¢†åŸŸæœåŠ¡å®ç°ç±» |

ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšå‘¢ï¼Ÿå› ä¸ºé¢†åŸŸæœåŠ¡å±‚æ˜¯ç¼–å†™æ ¸å¿ƒä¸šåŠ¡é€»è¾‘çš„ä½ç½®ï¼Œä¹Ÿéœ€è¦è¢«åº”ç”¨æœåŠ¡å±‚è°ƒç”¨ï¼Œæ‰€ä»¥å…ˆæŠŠåŸæ¥çš„ Service æ¥å£å’Œå®ç°ç±»å¤åˆ¶è¿‡æ¥ï¼Œä¾¿äºç­‰ä¼šå„¿æŒ‰éœ€ä¿ç•™ä»£ç æˆ–æ‹†åˆ†ä»£ç ã€‚

3ï¼‰é‡æ„åº”ç”¨æœåŠ¡å±‚

application å±‚ä¸»è¦åšé¢†åŸŸæœåŠ¡çš„ç¼–æ’ï¼Œå¦‚æœï¼Œäº‹åŠ¡ä¸€èˆ¬ä¹Ÿäº¤ç”± application å±‚æ¥æ§åˆ¶ã€‚

åº”ç”¨æœåŠ¡å±‚éµå¾ªçš„åŸåˆ™ï¼š

- å°†ä¸šåŠ¡é€»è¾‘ä¸‹æ²‰åˆ° **é¢†åŸŸæœåŠ¡æˆ–å®ä½“ç±»** ä¸­ï¼Œåº”ç”¨æœåŠ¡å±‚éœ€è¦è°ƒç”¨é¢†åŸŸæœåŠ¡æˆ–å®ä½“ç±»æ¥å®Œæˆä¸šåŠ¡é€»è¾‘ã€‚
- å¦‚æœæŸä¸ªæ–¹æ³•éœ€è¦è°ƒç”¨å…¶ä»–åº”ç”¨æœåŠ¡ï¼ˆåœ¨å•ä¸ªé¢†åŸŸå†…æ— æ³•å®Œæˆï¼‰ï¼Œé‚£ä¹ˆè¯¥æ–¹æ³•ä¸èƒ½æ”¾åˆ°é¢†åŸŸæœåŠ¡ä¸­ï¼Œè€Œæ˜¯ä¿ç•™åœ¨åº”ç”¨æœåŠ¡ä¸­ï¼Œå› ä¸ºåŸåˆ™ä¸Šé¢†åŸŸæœåŠ¡ä¸åº”è¯¥è°ƒç”¨åº”ç”¨æœåŠ¡ã€‚
- è´Ÿè´£ä¸ºæ¥å£å±‚æä¾›è°ƒç”¨æ”¯æŒï¼Œå› ä¸ºåŸåˆ™ä¸Šæ¥å£å±‚åªèƒ½è°ƒç”¨åº”ç”¨æœåŠ¡å±‚ã€‚

éµå¾ªåŸåˆ™ï¼Œå°† getPictureVOã€getPictureVOPage æ–¹æ³•çš„å®ç°ä¿ç•™åœ¨ PictureApplicationServiceImpl ä¸­ï¼Œå› ä¸ºå®ƒä»¬éƒ½è°ƒç”¨äº†å…¶ä»–åº”ç”¨æœåŠ¡ userApplicationServiceã€‚å…¶ä»–æ–¹æ³•å¯ä»¥ä¸‹æ²‰åˆ°é¢†åŸŸæœåŠ¡ä¸­ï¼Œåº”ç”¨æœåŠ¡å±‚çš„ä»£ç å¦‚ä¸‹ï¼š

```java
@Service
@Slf4j
public class PictureApplicationServiceImpl extends ServiceImpl<PictureMapper, Picture> implements PictureApplicationService {

    @Resource
    private PictureDomainService pictureDomainService;

    @Resource
    private UserApplicationService userApplicationService;

    @Override
    public PictureVO uploadPicture(Object inputSource, PictureUploadRequest pictureUploadRequest, User loginUser) {
        return pictureDomainService.uploadPicture(inputSource, pictureUploadRequest, loginUser);
    }

    @Override
    public void validPicture(Picture picture) {
        pictureDomainService.validPicture(picture);
    }

    @Override
    public QueryWrapper<Picture> getQueryWrapper(PictureQueryRequest pictureQueryRequest) {
        return pictureDomainService.getQueryWrapper(pictureQueryRequest);
    }

    /**
     * è·å–å›¾ç‰‡ VO
     */
    @Override
    public PictureVO getPictureVO(Picture picture, HttpServletRequest request) {
        // å¯¹è±¡è½¬å°è£…ç±»
        PictureVO pictureVO = PictureVO.objToVo(picture);
        // å…³è”æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
        Long userId = picture.getUserId();
        if (userId != null && userId > 0) {
            User user = userApplicationService.getUserById(userId);
            UserVO userVO = userApplicationService.getUserVO(user);
            pictureVO.setUser(userVO);
        }
        return pictureVO;
    }

    /**
     * åˆ†é¡µè·å–å›¾ç‰‡å°è£…
     */
    @Override
    public Page<PictureVO> getPictureVOPage(Page<Picture> picturePage, HttpServletRequest request) {
        List<Picture> pictureList = picturePage.getRecords();
        Page<PictureVO> pictureVOPage = new Page<>(picturePage.getCurrent(), picturePage.getSize(), picturePage.getTotal());
        if (CollUtil.isEmpty(pictureList)) {
            return pictureVOPage;
        }
        // å¯¹è±¡åˆ—è¡¨ => å°è£…å¯¹è±¡åˆ—è¡¨
        List<PictureVO> pictureVOList = pictureList.stream().map(PictureVO::objToVo).collect(Collectors.toList());
        // 1. å…³è”æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
        Set<Long> userIdSet = pictureList.stream().map(Picture::getUserId).collect(Collectors.toSet());
        Map<Long, List<User>> userIdUserListMap = userApplicationService.listByIds(userIdSet).stream()
                .collect(Collectors.groupingBy(User::getId));
        // 2. å¡«å……ä¿¡æ¯
        pictureVOList.forEach(pictureVO -> {
            Long userId = pictureVO.getUserId();
            User user = null;
            if (userIdUserListMap.containsKey(userId)) {
                user = userIdUserListMap.get(userId).get(0);
            }
            pictureVO.setUser(userApplicationService.getUserVO(user));
        });
        pictureVOPage.setRecords(pictureVOList);
        return pictureVOPage;
    }

    @Override
    public void doPictureReview(PictureReviewRequest pictureReviewRequest, User loginUser) {
        pictureDomainService.doPictureReview(pictureReviewRequest, loginUser);
    }

    @Override
    public void fillReviewParams(Picture picture, User loginUser) {
        pictureDomainService.fillReviewParams(picture, loginUser);
    }

    @Override
    public int uploadPictureByBatch(PictureUploadByBatchRequest pictureUploadByBatchRequest, User loginUser) {
        return pictureDomainService.uploadPictureByBatch(pictureUploadByBatchRequest, loginUser);
    }

    @Override
    public void clearPictureFile(Picture oldPicture) {
        pictureDomainService.clearPictureFile(oldPicture);
    }

    @Override
    public void deletePicture(long pictureId, User loginUser) {
        pictureDomainService.deletePicture(pictureId, loginUser);
    }

    @Override
    public void checkPictureAuth(User loginUser, Picture picture) {
        pictureDomainService.checkPictureAuth(loginUser, picture);
    }

    @Override
    public void editPicture(Picture picture, User loginUser) {
        pictureDomainService.editPicture(picture, loginUser);
    }

    @Override
    public List<PictureVO> searchPictureByColor(Long spaceId, String picColor, User loginUser) {
        return pictureDomainService.searchPictureByColor(spaceId, picColor, loginUser);
    }

    @Override
    public void editPictureByBatch(PictureEditByBatchRequest pictureEditByBatchRequest, User loginUser) {
        pictureDomainService.editPictureByBatch(pictureEditByBatchRequest, loginUser);
    }

    @Override
    public CreateOutPaintingTaskResponse createPictureOutPaintingTask(CreatePictureOutPaintingTaskRequest createPictureOutPaintingTaskRequest, User loginUser) {
        return pictureDomainService.createPictureOutPaintingTask(createPictureOutPaintingTaskRequest, loginUser);
    }
}
```

ç”±äº interfaces å±‚è¦è°ƒç”¨åº”ç”¨æœåŠ¡å±‚æ¥å®ç°åŠŸèƒ½ï¼Œä¸ºäº†æ–¹ä¾¿ï¼Œå¯ä»¥ç›´æ¥è®©å›¾ç‰‡åº”ç”¨æœåŠ¡ç»§æ‰¿ MyBatis Plus çš„æ¥å£å’Œå®ç°ç±»ï¼Œå‡å°‘æ ·æ¿å¢åˆ æ”¹æŸ¥æ–¹æ³•çš„ç¼–å†™ï¼ˆæ¯”å¦‚ getByIdï¼‰ã€‚

ğŸ’¡ å°æŠ€å·§ï¼šåªè¦å‘ç°ä¸è°ƒç”¨å…¶ä»–åº”ç”¨æœåŠ¡çš„æ–¹æ³•ã€å¹¶ä¸”ä¸è°ƒç”¨ â€œå½“å‰ç±»ä¸­ä¾èµ–å…¶ä»–åº”ç”¨æœåŠ¡â€ çš„æ–¹æ³•ï¼Œå°±å¯ä»¥æ”¹ä¸ºè°ƒç”¨é¢†åŸŸæœåŠ¡ï¼›å¦åˆ™è¯¥æ–¹æ³•éœ€è¦åœ¨åº”ç”¨æœåŠ¡ä¸­å®ç°ã€‚

4ï¼‰é‡æ„é¢†åŸŸæœåŠ¡å±‚

é¢†åŸŸæœåŠ¡å±‚éµå¾ªçš„åŸåˆ™ï¼š

- éœ€è¦è°ƒç”¨æ•°æ®åº“æœåŠ¡ï¼ˆrepositoryï¼‰æˆ–åŸºç¡€è®¾æ–½å±‚ï¼ˆinfrastructureï¼‰æ¥å®Œæˆä¸šåŠ¡é€»è¾‘
- å¯ä»¥æ ¹æ®éœ€è¦ï¼Œå°†å’Œå®ä½“å¼ºç›¸å…³çš„ä¸šåŠ¡é€»è¾‘ä¸‹æ²‰åˆ° **å®ä½“ç±»** ä¸­

éµå¾ªåŸåˆ™ç¼–å†™é¢†åŸŸæœåŠ¡å±‚çš„ä»£ç ï¼Œç”±äºä»£ç é‡è¾ƒå¤§ï¼Œä¸‹é¢åªåˆ—ä¸¾å…³é”®ä¿®æ”¹ï¼š

```java
@Service
@Slf4j
public class PictureDomainServiceImpl
        implements PictureDomainService {

    @Resource
    private PictureRepository pictureRepository;

    /**
     * ä¸Šä¼ å›¾ç‰‡
     */
    @Override
    public PictureVO uploadPicture(Object inputSource, PictureUploadRequest pictureUploadRequest, User loginUser) {
        // ...
        // å¦‚æœæ˜¯æ›´æ–°å›¾ç‰‡ï¼Œéœ€è¦æ ¡éªŒå›¾ç‰‡æ˜¯å¦å­˜åœ¨
        if (pictureId != null) {
            Picture oldPicture = pictureRepository.getById(pictureId);
            ThrowUtils.throwIf(oldPicture == null, ErrorCode.NOT_FOUND_ERROR, "å›¾ç‰‡ä¸å­˜åœ¨");
        }
        transactionTemplate.execute(status -> {
            boolean result = pictureRepository.saveOrUpdate(picture);
            ThrowUtils.throwIf(!result, ErrorCode.OPERATION_ERROR, "å›¾ç‰‡ä¸Šä¼ å¤±è´¥");
        });
    }

    /**
     * æ ¡éªŒæ•°æ®
     *
     * @param picture å›¾ç‰‡
     */
    @Override
    public void validPicture(Picture picture) {
    }

    /**
     * è·å–æŸ¥è¯¢æ¡ä»¶
     */
    @Override
    public QueryWrapper<Picture> getQueryWrapper(PictureQueryRequest pictureQueryRequest) {    
    }

    /**
     * å›¾ç‰‡å®¡æ ¸
     *
     * @param pictureReviewRequest
     * @param loginUser
     */
    @Override
    public void doPictureReview(PictureReviewRequest pictureReviewRequest, User loginUser) {
        // åˆ¤æ–­æ˜¯å¦å­˜åœ¨
        Picture oldPicture = pictureRepository.getById(id);
        boolean result = pictureRepository.updateById(updatePicture);
        ThrowUtils.throwIf(!result, ErrorCode.OPERATION_ERROR);
    }

    @Override
    public void fillReviewParams(Picture picture, User loginUser) {
    }

    @Override
    public int uploadPictureByBatch(PictureUploadByBatchRequest pictureUploadByBatchRequest, User loginUser) {
    }

    @Async
    @Override
    public void clearPictureFile(Picture oldPicture) {
        long count = pictureRepository.lambdaQuery()
                .eq(Picture::getUrl, pictureUrl)
                .count();
    }

    @Override
    public void deletePicture(long pictureId, User loginUser) {
        // åˆ¤æ–­æ˜¯å¦å­˜åœ¨
        Picture oldPicture = pictureRepository.getById(pictureId);
        ThrowUtils.throwIf(oldPicture == null, ErrorCode.NOT_FOUND_ERROR);
        // todo å¼€å¯äº‹åŠ¡
        transactionTemplate.execute(status -> {
            // æ“ä½œæ•°æ®åº“
            boolean result = pictureRepository.removeById(pictureId);
            return true;
        });
    }

    /**
     * ç©ºé—´æƒé™æ ¡éªŒ
     *
     * @param loginUser
     * @param picture
     */
    @Override
    public void checkPictureAuth(User loginUser, Picture picture) {
    }

    @Override
    public void editPicture(Picture picture, User loginUser) {
        Picture oldPicture = pictureRepository.getById(id);
        // æ“ä½œæ•°æ®åº“
        boolean result = pictureRepository.updateById(picture);
        ThrowUtils.throwIf(!result, ErrorCode.OPERATION_ERROR);
    }

    @Override
    public List<PictureVO> searchPictureByColor(Long spaceId, String picColor, User loginUser) {
        // æŸ¥è¯¢è¯¥ç©ºé—´ä¸‹æ‰€æœ‰å›¾ç‰‡ï¼ˆå¿…é¡»æœ‰ä¸»è‰²è°ƒï¼‰
        List<Picture> pictureList = pictureRepository.lambdaQuery()
                .eq(Picture::getSpaceId, spaceId)
                .isNotNull(Picture::getPicColor)
                .list();
    }


    /**
     * æ‰¹é‡ç¼–è¾‘å›¾ç‰‡åˆ†ç±»å’Œæ ‡ç­¾
     */
    @Override
    @Transactional(rollbackFor = Exception.class)
    public void editPictureByBatch(PictureEditByBatchRequest pictureEditByBatchRequest, User loginUser) {
        // æŸ¥è¯¢æŒ‡å®šå›¾ç‰‡ï¼Œä»…é€‰æ‹©éœ€è¦çš„å­—æ®µ
        List<Picture> pictureList = pictureRepository.lambdaQuery()
                .select(Picture::getId, Picture::getSpaceId)
                .eq(Picture::getSpaceId, spaceId)
                .in(Picture::getId, pictureIdList)
                .list();
    }

    /**
     * nameRule æ ¼å¼ï¼šå›¾ç‰‡{åºå·}
     *
     * @param pictureList
     * @param nameRule
     */
    private void fillPictureWithNameRule(List<Picture> pictureList, String nameRule) {
    }

    @Override
    public CreateOutPaintingTaskResponse createPictureOutPaintingTask(CreatePictureOutPaintingTaskRequest createPictureOutPaintingTaskRequest, User loginUser) {
        Picture picture = Optional.ofNullable(pictureRepository.getById(pictureId))
            .orElseThrow(() -> new BusinessException(ErrorCode.NOT_FOUND_ERROR));
    }
}
```

æ³¨æ„ï¼Œå…¶å® validPicture æ–¹æ³•æ˜¯å¯ä»¥ç§»åŠ¨åˆ° Picture å®ä½“ç±»ä¸­çš„ï¼Œå¤§å®¶å¯è‡ªè¡Œæ“ä½œã€‚

ğŸ’¡ å°æŠ€å·§

1. ä¿®æ”¹é¢†åŸŸæœåŠ¡æ—¶ï¼Œå¦‚æœå‘ç°æŸä¸ªæ–¹æ³•æ²¡è¢« application è°ƒç”¨ï¼ˆIDE æ˜¾ç¤ºç°è‰²ï¼‰ï¼Œå°±å¯ä»¥ç›´æ¥ç§»é™¤æ‰ã€‚
2. å¦‚æœæƒ³èŠ‚çœé‡å¤ç¼–å†™å¢åˆ æ”¹æŸ¥ç­‰æ ·æ¿ä»£ç çš„æ—¶é—´ï¼Œåº”ç”¨æœåŠ¡æˆ–é¢†åŸŸæœåŠ¡ä¹Ÿå¯ä»¥ç›´æ¥ç»§æ‰¿ MyBatis Plus çš„æ¥å£å’Œå®ç°ç±»ï¼Œè¿™æ ·è™½ç„¶ DDD ç›®å½•ç»“æ„ä¸æ˜¯ 100% æ ‡å‡†ï¼Œä½†æ˜¯èƒ½å¤§å¹…å‡å°‘å¼€å‘æˆæœ¬ã€‚

#### 4ã€é‡æ„ Controller

1ï¼‰é¦–å…ˆå°†åŸå§‹ PictureController ç§»åŠ¨ä¸º `interfaces.controller.PictureController` ç±»ã€‚

2ï¼‰ä¸ºä¿è¯æ¥å£å±‚çš„ç²¾ç®€ï¼Œéœ€è¦å°†å…¶ä¸­çš„ä»£ç ä¸‹æ²‰åˆ° **è½¬æ¢ç±»å’Œåº”ç”¨æœåŠ¡** ä¸­ã€‚é¦–å…ˆç¼–å†™è½¬æ¢ç±» `interfaces.assembler.PictureAssembler`ï¼Œè´Ÿè´£å°† DTO è½¬ä¸ºå®ä½“ç±»ï¼š

```java
public class PictureAssembler {

    public static Picture toPictureEntity(PictureEditRequest request) {
        Picture picture = new Picture();
        BeanUtils.copyProperties(request, picture);
        // æ³¨æ„å°† list è½¬ä¸º string
        picture.setTags(JSONUtil.toJsonStr(request.getTags()));
        return picture;
    }

    public static Picture toPictureEntity(PictureUpdateRequest request) {
        Picture picture = new Picture();
        BeanUtils.copyProperties(request, picture);
        // æ³¨æ„å°† list è½¬ä¸º string
        picture.setTags(JSONUtil.toJsonStr(request.getTags()));
        return picture;
    }
}
```

3ï¼‰å°† Controller çš„ä»£ç ä¸‹æ²‰åˆ°åº”ç”¨æœåŠ¡ä¸­ï¼Œè°ƒç”¨åº”ç”¨æœåŠ¡å’Œ Assembler æ¥å¤„ç†è¯·æ±‚ï¼Œå¯èƒ½ä¼šæ¶‰åŠåˆ°åº”ç”¨æœåŠ¡æ–¹æ³•çš„å‚æ•°ä¿®æ”¹ã€‚å…¶ä¸­ updatePictureã€editPicture æ˜¯æ”¹é€ çš„é‡ç‚¹ï¼Œéœ€è¦è°ƒç”¨ Assembler å’Œåº”ç”¨æœåŠ¡å±‚å®ŒæˆåŠŸèƒ½ï¼Œä¸‹é¢åªåˆ—ä¸¾ä¿®æ”¹çš„å…³é”®ä»£ç ï¼š

```java
@RestController
@RequestMapping("/picture")
@Slf4j
public class PictureController {

    @Resource
    private PictureApplicationService pictureApplicationService;

    @Resource
    private UserApplicationService userApplicationService;

    // region å¢åˆ æ”¹æŸ¥

    /**
     * ä¸Šä¼ å›¾ç‰‡ï¼ˆå¯é‡æ–°ä¸Šä¼ ï¼‰
     */
    @PostMapping("/upload")
    @SaSpaceCheckPermission(value = SpaceUserPermissionConstant.PICTURE_UPLOAD)
    public BaseResponse<PictureVO> uploadPicture(@RequestPart("file") MultipartFile multipartFile, PictureUploadRequest pictureUploadRequest, HttpServletRequest request) {
        User loginUser = userApplicationService.getLoginUser(request);
        PictureVO pictureVO = pictureApplicationService.uploadPicture(multipartFile, pictureUploadRequest, loginUser);
        return ResultUtils.success(pictureVO);
    }

    /**
     * é€šè¿‡ URL ä¸Šä¼ å›¾ç‰‡ï¼ˆå¯é‡æ–°ä¸Šä¼ ï¼‰
     */
    @PostMapping("/upload/url")
    @SaSpaceCheckPermission(value = SpaceUserPermissionConstant.PICTURE_UPLOAD)
    public BaseResponse<PictureVO> uploadPictureByUrl(@RequestBody PictureUploadRequest pictureUploadRequest, HttpServletRequest request) {
        User loginUser = userApplicationService.getLoginUser(request);
        String fileUrl = pictureUploadRequest.getFileUrl();
        PictureVO pictureVO = pictureApplicationService.uploadPicture(fileUrl, pictureUploadRequest, loginUser);
        return ResultUtils.success(pictureVO);
    }

    /**
     * åˆ é™¤å›¾ç‰‡
     */
    @PostMapping("/delete")
    @SaSpaceCheckPermission(value = SpaceUserPermissionConstant.PICTURE_DELETE)
    public BaseResponse<Boolean> deletePicture(@RequestBody DeleteRequest deleteRequest, HttpServletRequest request) {
        User loginUser = userApplicationService.getLoginUser(request);
        pictureApplicationService.deletePicture(deleteRequest.getId(), loginUser);
        return ResultUtils.success(true);
    }

    /**
     * æ›´æ–°å›¾ç‰‡ï¼ˆä»…ç®¡ç†å‘˜å¯ç”¨ï¼‰
     */
    @PostMapping("/update")
    @AuthCheck(mustRole = UserConstant.ADMIN_ROLE)
    public BaseResponse<Boolean> updatePicture(@RequestBody PictureUpdateRequest pictureUpdateRequest, HttpServletRequest request) {
        // å°†å®ä½“ç±»å’Œ DTO è¿›è¡Œè½¬æ¢
        Picture picture = PictureAssembler.toPictureEntity(pictureUpdateRequest);
        // æ•°æ®æ ¡éªŒ
        pictureApplicationService.validPicture(picture);
        // åˆ¤æ–­æ˜¯å¦å­˜åœ¨
        long id = pictureUpdateRequest.getId();
        Picture oldPicture = pictureApplicationService.getById(id);
        ThrowUtils.throwIf(oldPicture == null, ErrorCode.NOT_FOUND_ERROR);
        // è¡¥å……å®¡æ ¸å‚æ•°
        User loginUser = userApplicationService.getLoginUser(request);
        pictureApplicationService.fillReviewParams(picture, loginUser);
        // æ“ä½œæ•°æ®åº“
        boolean result = pictureApplicationService.updateById(picture);
        ThrowUtils.throwIf(!result, ErrorCode.OPERATION_ERROR);
        return ResultUtils.success(true);
    }

    /**
     * æ ¹æ® id è·å–å›¾ç‰‡ï¼ˆä»…ç®¡ç†å‘˜å¯ç”¨ï¼‰
     */
    @GetMapping("/get")
    @AuthCheck(mustRole = UserConstant.ADMIN_ROLE)
    public BaseResponse<Picture> getPictureById(long id, HttpServletRequest request) {
        // æŸ¥è¯¢æ•°æ®åº“
        Picture picture = pictureApplicationService.getById(id);
    }

    /**
     * æ ¹æ® id è·å–å›¾ç‰‡ï¼ˆå°è£…ç±»ï¼‰
     */
    @GetMapping("/get/vo")
    public BaseResponse<PictureVO> getPictureVOById(long id, HttpServletRequest request) {
        // æŸ¥è¯¢æ•°æ®åº“
        Picture picture = pictureApplicationService.getById(id);
        // è·å–æƒé™åˆ—è¡¨
        User loginUser = userApplicationService.getLoginUser(request);
        List<String> permissionList = spaceUserAuthManager.getPermissionList(space, loginUser);
        PictureVO pictureVO = pictureApplicationService.getPictureVO(picture, request);
        pictureVO.setPermissionList(permissionList);
        // è·å–å°è£…ç±»
        return ResultUtils.success(pictureVO);
    }

    /**
     * åˆ†é¡µè·å–å›¾ç‰‡åˆ—è¡¨ï¼ˆä»…ç®¡ç†å‘˜å¯ç”¨ï¼‰
     */
    @PostMapping("/list/page")
    @AuthCheck(mustRole = UserConstant.ADMIN_ROLE)
    public BaseResponse<Page<Picture>> listPictureByPage(@RequestBody PictureQueryRequest pictureQueryRequest) {
        // æŸ¥è¯¢æ•°æ®åº“
        Page<Picture> picturePage = pictureApplicationService.page(new Page<>(current, size), pictureApplicationService.getQueryWrapper(pictureQueryRequest));
        return ResultUtils.success(picturePage);
    }

    /**
     * åˆ†é¡µè·å–å›¾ç‰‡åˆ—è¡¨ï¼ˆå°è£…ç±»ï¼‰
     */
    @PostMapping("/list/page/vo")
    public BaseResponse<Page<PictureVO>> listPictureVOByPage(@RequestBody PictureQueryRequest pictureQueryRequest, HttpServletRequest request) {
        // æŸ¥è¯¢æ•°æ®åº“
        Page<Picture> picturePage = pictureApplicationService.page(new Page<>(current, size), pictureApplicationService.getQueryWrapper(pictureQueryRequest));
        // è·å–å°è£…ç±»
        return ResultUtils.success(pictureApplicationService.getPictureVOPage(picturePage, request));
    }

    /**
     * ç¼–è¾‘å›¾ç‰‡ï¼ˆç»™ç”¨æˆ·ä½¿ç”¨ï¼‰
     */
    @PostMapping("/edit")
    @SaSpaceCheckPermission(value = SpaceUserPermissionConstant.PICTURE_EDIT)
    public BaseResponse<Boolean> editPicture(@RequestBody PictureEditRequest pictureEditRequest, HttpServletRequest request) {
        User loginUser = userApplicationService.getLoginUser(request);
        // å°†å®ä½“ç±»å’Œ DTO è¿›è¡Œè½¬æ¢
        Picture picture = PictureAssembler.toPictureEntity(pictureEditRequest);
        pictureApplicationService.editPicture(picture, loginUser);
        return ResultUtils.success(true);
    }

    // endregion

    /**
     * è¿”å›é¢„ç½®çš„æ ‡ç­¾å’Œåˆ†ç±»
     */
    @GetMapping("/tag_category")
    public BaseResponse<PictureTagCategory> listPictureTagCategory() {
    }

    /**
     * å®¡æ ¸
     */
    @PostMapping("/review")
    @AuthCheck(mustRole = UserConstant.ADMIN_ROLE)
    public BaseResponse<Boolean> doPictureReview(@RequestBody PictureReviewRequest pictureReviewRequest, HttpServletRequest request) {
        User loginUser = userApplicationService.getLoginUser(request);
        pictureApplicationService.doPictureReview(pictureReviewRequest, loginUser);
        return ResultUtils.success(true);
    }

    /**
     * æ‰¹é‡æŠ“å–å’Œåˆ›å»ºå›¾ç‰‡
     */
    @PostMapping("/upload/batch")
    @AuthCheck(mustRole = UserConstant.ADMIN_ROLE)
    public BaseResponse<Integer> uploadPictureByBatch(@RequestBody PictureUploadByBatchRequest pictureUploadByBatchRequest, HttpServletRequest request) {
        User loginUser = userApplicationService.getLoginUser(request);
        Integer uploadCount = pictureApplicationService.uploadPictureByBatch(pictureUploadByBatchRequest, loginUser);
        return ResultUtils.success(uploadCount);
    }

    /**
     * ä»¥å›¾æœå›¾
     */
    @PostMapping("/search/picture")
    public BaseResponse<List<ImageSearchResult>> searchPictureByPicture(@RequestBody SearchPictureByPictureRequest searchPictureByPictureRequest) {
        Picture oldPicture = pictureApplicationService.getById(pictureId);
        ThrowUtils.throwIf(oldPicture == null, ErrorCode.NOT_FOUND_ERROR);
        List<ImageSearchResult> resultList = ImageSearchApiFacade.searchImage(oldPicture.getUrl());
        return ResultUtils.success(resultList);
    }

    /**
     * æ ¹æ®é¢œè‰²æœç´¢å›¾ç‰‡
     */
    @PostMapping("/search/color")
    @SaSpaceCheckPermission(value = SpaceUserPermissionConstant.PICTURE_VIEW)
    public BaseResponse<List<PictureVO>> searchPictureByColor(@RequestBody SearchPictureByColorRequest searchPictureByColorRequest, HttpServletRequest request) {
        User loginUser = userApplicationService.getLoginUser(request);
        List<PictureVO> result = pictureApplicationService.searchPictureByColor(spaceId, picColor, loginUser);
        return ResultUtils.success(result);
    }

    /**
     * æ‰¹é‡ç¼–è¾‘å›¾ç‰‡
     */
    @PostMapping("/edit/batch")
    @SaSpaceCheckPermission(value = SpaceUserPermissionConstant.PICTURE_EDIT)
    public BaseResponse<Boolean> editPictureByBatch(@RequestBody PictureEditByBatchRequest pictureEditByBatchRequest, HttpServletRequest request) {
        User loginUser = userApplicationService.getLoginUser(request);
        pictureApplicationService.editPictureByBatch(pictureEditByBatchRequest, loginUser);
        return ResultUtils.success(true);
    }

    /**
     * åˆ›å»º AI æ‰©å›¾ä»»åŠ¡
     */
    @PostMapping("/out_painting/create_task")
    @SaSpaceCheckPermission(value = SpaceUserPermissionConstant.PICTURE_EDIT)
    public BaseResponse<CreateOutPaintingTaskResponse> createPictureOutPaintingTask(
            @RequestBody CreatePictureOutPaintingTaskRequest createPictureOutPaintingTaskRequest,
            HttpServletRequest request) {
        User loginUser = userApplicationService.getLoginUser(request);
        CreateOutPaintingTaskResponse response = pictureApplicationService.createPictureOutPaintingTask(createPictureOutPaintingTaskRequest, loginUser);
        return ResultUtils.success(response);
    }

    /**
     * æŸ¥è¯¢ AI æ‰©å›¾ä»»åŠ¡
     */
    @GetMapping("/out_painting/get_task")
    public BaseResponse<GetOutPaintingTaskResponse> getPictureOutPaintingTask(String taskId) {
    }
}
```

è¿™æ ·ä¸€æ¥ï¼Œæ¥å£çš„ä»£ç æ›´åŠ ç²¾ç®€ã€‚

ğŸ’¡ å‰é¢ä¹Ÿæåˆ°äº†ï¼Œå¦‚æœè§‰å¾—ä¸€å±‚ä¸€å±‚è¡¥å……è°ƒç”¨æ–¹æ³•è¿‡äºéº»çƒ¦ï¼Œå¯ä»¥ç›´æ¥ç»™åº”ç”¨æœåŠ¡æˆ–é¢†åŸŸæœåŠ¡ç»§æ‰¿ MyBatis Plus çš„ IService å’Œ ServiceImplï¼Œä¾¿äºä¸Šä¸€å±‚è°ƒç”¨ã€‚

#### 5ã€å…¶ä»–ä»£ç å…¼å®¹

å°è¯•å¯åŠ¨é¡¹ç›®ï¼Œå¯èƒ½ä¼šå‡ºç°ç¼–è¯‘é”™è¯¯ï¼Œæˆ‘ä»¬æ ¹æ®æŠ¥é”™æç¤ºä¾æ¬¡è§£å†³å³å¯ã€‚

æœ€ç»ˆï¼Œå°è¯•å¯åŠ¨é¡¹ç›®ï¼Œåªè¦ä¸æŠ¥ç¼–è¯‘é”™è¯¯ï¼Œå°±ç®—æ˜¯é‡æ„å®Œæˆäº†ï¼Œå³ä½¿é¡¹ç›®å¯åŠ¨ä¸èµ·æ¥ä¹Ÿä¸ç”¨åœ¨æ„ï¼Œå› ä¸ºæˆ‘ä»¬æœ‰äº›æœåŠ¡è¿˜æ²¡æœ‰é‡æ„å®Œã€‚

### ç©ºé—´é¢†åŸŸ

åŒ…æ‹¬ç©ºé—´ã€ç©ºé—´åˆ†æã€ç©ºé—´æˆå‘˜ç®¡ç†è¿™ 3 ç±»æ ¸å¿ƒåŠŸèƒ½ï¼Œæˆ‘ä»¬ç®€å•å°†é¡¹ç›®è¿›è¡Œé‡æ„å³å¯ã€‚

#### 1ã€é‡æ„ model åŒ…

æŒ‰ç…§ä¸‹é¢çš„è§„åˆ™ï¼Œå°†åŸå§‹ model åŒ…ä¸­çš„ä»£ç ç§»åŠ¨åˆ°å¯¹åº”çš„æ–°ä½ç½®ï¼š

| åŸå§‹åŒ…          | é‡æ„åçš„åŒ…               | å¤‡æ³¨                                                |
| --------------- | ------------------------ | --------------------------------------------------- |
| model.entity    | domain.space.entity      | Spaceã€SpaceUser ç±»                                 |
| model.enums     | domain.space.valueobject | SpaceLevelEnumã€SpaceRoleEnumã€SpaceTypeEnum æšä¸¾ç±» |
| model.dto.space | interfaces.dto.space     | è¯·æ±‚å°è£…ç±»                                          |
| model.vo        | interfaces.vo.space      | å“åº”å°è£…ç±» SpaceVOã€SpaceUserVO                     |

#### 2ã€é‡æ„æ•°æ®è®¿é—®å±‚

æ ¹æ®å‰é¢è®²è¿‡çš„ä¾èµ–å€’ç½®åŸåˆ™ï¼Œåœ¨é¢†åŸŸåŒ…ä¸‹æ–°å»º `repository` åŒ…ï¼Œå®šä¹‰ä¸æ•°æ®åº“äº¤äº’çš„æ¥å£ï¼Œç„¶ååœ¨ `infrastructure.repository` ä¸­å†™ç›¸åº”çš„å®ç°ã€‚

ç”±äºæˆ‘ä»¬çš„é¡¹ç›®ä¸­ä½¿ç”¨äº† MyBatis Plus æ¡†æ¶ï¼Œå¯ä»¥è®©æ¥å£ç›´æ¥ç»§æ‰¿å…¶æä¾›çš„ IService æ¥å£ï¼Œæ¥å£çš„å®ç°ç»§æ‰¿ ServiceImpl ç±»ï¼Œè¿™æ ·å°±ç›´æ¥æ‹¥æœ‰äº†ä¸€æ‰¹æ“ä½œæ•°æ®åº“çš„æ–¹æ³•ï¼Œç®€åŒ–å¼€å‘ã€‚

æ–°å¢ SpaceRepository å’Œ SpaceUserRepository æ¥å£ï¼š

```java
package com.yupi.yupicture.domain.space.repository;

public interface SpaceRepository extends IService<Space> {
}
package com.yupi.yupicture.domain.space.repository;

public interface SpaceUserRepository extends IService<SpaceUser> {
}
```

æ–°å¢ SpaceRepositoryImpl å’Œ SpaceUserRepositoryImpl å®ç°ç±»ï¼š

```java
package com.yupi.yupicture.infrastructure.repository;

@Service
public class SpaceRepositoryImpl extends ServiceImpl<SpaceMapper, Space> implements SpaceRepository {
}
package com.yupi.yupicture.infrastructure.repository;

@Service
public class SpaceUserRepositoryImpl extends ServiceImpl<SpaceUserMapper, SpaceUser> implements SpaceUserRepository {
}
```

SpaceMapper å’Œ SpaceUserMapper ä¹‹å‰å·²ç»ç§»åŠ¨åˆ°äº† infrastructure åŒ…ä¸­ï¼Œä½œä¸ºå®ç°ä¸­çš„ä¸€éƒ¨åˆ†ã€‚

#### 3ã€é‡æ„ Service

Service å±‚çš„é‡æ„æ˜¯ç›¸å¯¹æœ€éº»çƒ¦çš„ï¼Œä½†æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ä¸€äº›å°æŠ€å·§å¤§å¹…æé«˜é‡æ„æ•ˆç‡ã€‚

1ï¼‰é¦–å…ˆï¼Œç›´æ¥åœ¨ IDE ä¸­ç§»åŠ¨ Service æ¥å£å’Œå®ç°ç±»åˆ°åº”ç”¨æœåŠ¡å±‚ï¼ŒåŒ…æ‹¬ 3 ä¸ªæ¥å£å’Œå®ç°ç±»ï¼š

| åŸå§‹ç±»                               | é‡æ„åçš„ç±»                                                  | å¤‡æ³¨           |
| ------------------------------------ | ----------------------------------------------------------- | -------------- |
| service.SpaceService                 | application.service.SpaceApplicationService                 | åº”ç”¨æœåŠ¡æ¥å£   |
| service.SpaceUserService             | application.service.SpaceUserApplicationService             | åº”ç”¨æœåŠ¡æ¥å£   |
| service.SpaceAnalyzeService          | application.service.SpaceAnalyzeApplicationService          | åº”ç”¨æœåŠ¡æ¥å£   |
| service.impl.SpaceServiceImpl        | application.service.impl.SpaceApplicationServiceImpl        | åº”ç”¨æœåŠ¡å®ç°ç±» |
| service.impl.SpaceUserServiceImpl    | application.service.impl.SpaceUserApplicationServiceImpl    | åº”ç”¨æœåŠ¡å®ç°ç±» |
| service.impl.SpaceAnalyzeServiceImpl | application.service.impl.SpaceAnalyzeApplicationServiceImpl | åº”ç”¨æœåŠ¡å®ç°ç±» |

ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšå‘¢ï¼Ÿå› ä¸ºåº”ç”¨æœåŠ¡å±‚æ˜¯å¯ä¾›å…¶ä»–é¢†åŸŸè°ƒç”¨çš„ï¼Œè€Œä¹‹å‰çš„ Service ä¹Ÿæ˜¯å¯ä¾›å…¶ä»– Service è°ƒç”¨çš„ã€‚ç›´æ¥ç§»åŠ¨åï¼ŒIDE ä¼š **è‡ªåŠ¨é‡æ„ä»£ç **ï¼Œå°†å¯¹åŸå§‹æœåŠ¡æ¥å£çš„è°ƒç”¨æ”¹ä¸ºæ–°åº”ç”¨æœåŠ¡æ¥å£çš„è°ƒç”¨ï¼Œå‡å°‘äº†æ‰‹åŠ¨ä¿®æ”¹çš„ä»£ç é‡ã€‚

2ï¼‰å¤åˆ¶ Service æ¥å£å’Œå®ç°ç±»ä¸ºé¢†åŸŸæœåŠ¡å±‚ï¼ŒåŒ…æ‹¬ç©ºé—´æœåŠ¡å’Œç©ºé—´æˆå‘˜æœåŠ¡ã€‚ä¸éœ€è¦ SpaceAnalayzeDomainServiceï¼Œå› ä¸ºå®ç°åˆ†æåŠŸèƒ½ä¾èµ–çš„æ˜¯ Space å’Œ Picture åº”ç”¨æœåŠ¡ï¼Œè€Œä¸æ˜¯ä¾èµ– SpaceAnalayzeRepositoryï¼ˆæ ¹æœ¬æ²¡æœ‰ç©ºé—´åˆ†æè¡¨ï¼‰ã€‚

| åŸå§‹ç±»                            | é‡æ„åçš„ç±»                                          | å¤‡æ³¨           |
| --------------------------------- | --------------------------------------------------- | -------------- |
| service.SpaceService              | domain.user.service.SpaceDomainService              | é¢†åŸŸæœåŠ¡æ¥å£   |
| service.SpaceUserService          | domain.user.service.SpaceUserDomainService          | é¢†åŸŸæœåŠ¡æ¥å£   |
| service.impl.SpaceServiceImpl     | domain.user.service.impl.SpaceDomainServiceImpl     | é¢†åŸŸæœåŠ¡å®ç°ç±» |
| service.impl.SpaceUserServiceImpl | domain.user.service.impl.SpaceUserDomainServiceImpl | é¢†åŸŸæœåŠ¡å®ç°ç±» |

ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšå‘¢ï¼Ÿå› ä¸ºé¢†åŸŸæœåŠ¡å±‚æ˜¯ç¼–å†™æ ¸å¿ƒä¸šåŠ¡é€»è¾‘çš„ä½ç½®ï¼Œä¹Ÿéœ€è¦è¢«åº”ç”¨æœåŠ¡å±‚è°ƒç”¨ï¼Œæ‰€ä»¥å…ˆæŠŠåŸæ¥çš„ Service æ¥å£å’Œå®ç°ç±»å¤åˆ¶è¿‡æ¥ï¼Œä¾¿äºç­‰ä¼šå„¿æŒ‰éœ€ä¿ç•™ä»£ç æˆ–æ‹†åˆ†ä»£ç ã€‚

3ï¼‰é‡æ„åº”ç”¨æœåŠ¡å±‚

application å±‚ä¸»è¦åšé¢†åŸŸæœåŠ¡çš„ç¼–æ’ï¼Œå¦‚æœï¼Œäº‹åŠ¡ä¸€èˆ¬ä¹Ÿäº¤ç”± application å±‚æ¥æ§åˆ¶ã€‚

åº”ç”¨æœåŠ¡å±‚éµå¾ªçš„åŸåˆ™ï¼š

- å°†ä¸šåŠ¡é€»è¾‘ä¸‹æ²‰åˆ° **é¢†åŸŸæœåŠ¡æˆ–å®ä½“ç±»** ä¸­ï¼Œåº”ç”¨æœåŠ¡å±‚éœ€è¦è°ƒç”¨é¢†åŸŸæœåŠ¡æˆ–å®ä½“ç±»æ¥å®Œæˆä¸šåŠ¡é€»è¾‘ã€‚
- å¦‚æœæŸä¸ªæ–¹æ³•éœ€è¦è°ƒç”¨å…¶ä»–åº”ç”¨æœåŠ¡ï¼ˆåœ¨å•ä¸ªé¢†åŸŸå†…æ— æ³•å®Œæˆï¼‰ï¼Œé‚£ä¹ˆè¯¥æ–¹æ³•ä¸èƒ½æ”¾åˆ°é¢†åŸŸæœåŠ¡ä¸­ï¼Œè€Œæ˜¯ä¿ç•™åœ¨åº”ç”¨æœåŠ¡ä¸­ï¼Œå› ä¸ºåŸåˆ™ä¸Šé¢†åŸŸæœåŠ¡ä¸åº”è¯¥è°ƒç”¨åº”ç”¨æœåŠ¡ã€‚
- è´Ÿè´£ä¸ºæ¥å£å±‚æä¾›è°ƒç”¨æ”¯æŒï¼Œå› ä¸ºåŸåˆ™ä¸Šæ¥å£å±‚åªèƒ½è°ƒç”¨åº”ç”¨æœåŠ¡å±‚ã€‚

éµå¾ªåŸåˆ™ï¼Œå°† getSpaceUserVOListã€getSpaceUserVOã€validSpaceUserã€addSpaceUserã€getSpaceVOPageã€getSpaceVOã€addSpace ä»¥åŠç©ºé—´åˆ†ææœåŠ¡æ–¹æ³•çš„å®ç°ä¿ç•™åœ¨ ApplicationServiceImpl ä¸­ï¼Œå› ä¸ºå®ƒä»¬éƒ½è°ƒç”¨äº†å…¶ä»–åº”ç”¨æœåŠ¡ï¼ˆæ¯”å¦‚ userApplicationServiceï¼‰ã€‚å…¶ä»–æ–¹æ³•å¯ä»¥ä¸‹æ²‰åˆ°é¢†åŸŸæœåŠ¡ä¸­ï¼Œä»¥ SpaceApplicationService ä¸ºä¾‹ï¼Œåº”ç”¨æœåŠ¡å±‚çš„ä»£ç å¦‚ä¸‹ï¼š

```java
@Service
public class SpaceApplicationServiceImpl extends ServiceImpl<SpaceMapper, Space> implements SpaceApplicationService {

    @Resource
    private SpaceDomainService spaceDomainService;

    @Resource
    private TransactionTemplate transactionTemplate;

    @Resource
    private UserApplicationService userApplicationService;

    @Resource
    @Lazy
    private SpaceUserApplicationService spaceUserApplicationService;

    @Override
    public long addSpace(SpaceAddRequest spaceAddRequest, User loginUser) {
        // ä¿ç•™åŸæœ¬å®ç°
    }

    /**
     * è·å–æŸ¥è¯¢æ¡ä»¶
     */
    @Override
    public QueryWrapper<Space> getQueryWrapper(SpaceQueryRequest spaceQueryRequest) {
        return spaceDomainService.getQueryWrapper(spaceQueryRequest);
    }

    /**
     * è·å–ç©ºé—´ VO
     */
    @Override
    public SpaceVO getSpaceVO(Space space, HttpServletRequest request) {
        // ä¿ç•™åŸæœ¬å®ç°
    }

    /**
     * åˆ†é¡µè·å–ç©ºé—´å°è£…
     */
    @Override
    public Page<SpaceVO> getSpaceVOPage(Page<Space> spacePage, HttpServletRequest request) {
        // ä¿ç•™åŸæœ¬å®ç°
    }

    @Override
    public void fillSpaceBySpaceLevel(Space space) {
        spaceDomainService.fillSpaceBySpaceLevel(space);
    }

    @Override
    public void checkSpaceAuth(User loginUser, Space space) {
        spaceDomainService.checkSpaceAuth(loginUser, space);
    }
}
```

ç”±äº interfaces å±‚è¦è°ƒç”¨åº”ç”¨æœåŠ¡å±‚æ¥å®ç°åŠŸèƒ½ï¼Œä¸ºäº†æ–¹ä¾¿ï¼Œå¯ä»¥ç›´æ¥è®©ç©ºé—´åº”ç”¨æœåŠ¡ç»§æ‰¿ MyBatis Plus çš„æ¥å£å’Œå®ç°ç±»ï¼Œå‡å°‘æ ·æ¿å¢åˆ æ”¹æŸ¥æ–¹æ³•çš„ç¼–å†™ï¼ˆæ¯”å¦‚ getByIdï¼‰ã€‚

ğŸ’¡ å°æŠ€å·§ï¼šåªè¦å‘ç°ä¸è°ƒç”¨å…¶ä»–åº”ç”¨æœåŠ¡çš„æ–¹æ³•ã€å¹¶ä¸”ä¸è°ƒç”¨ â€œå½“å‰ç±»ä¸­ä¾èµ–å…¶ä»–åº”ç”¨æœåŠ¡â€ çš„æ–¹æ³•ï¼Œå°±å¯ä»¥æ”¹ä¸ºè°ƒç”¨é¢†åŸŸæœåŠ¡ï¼›å¦åˆ™è¯¥æ–¹æ³•éœ€è¦åœ¨åº”ç”¨æœåŠ¡ä¸­å®ç°ã€‚

4ï¼‰é‡æ„é¢†åŸŸæœåŠ¡å±‚

é¢†åŸŸæœåŠ¡å±‚éµå¾ªçš„åŸåˆ™ï¼š

- éœ€è¦è°ƒç”¨æ•°æ®åº“æœåŠ¡ï¼ˆrepositoryï¼‰æˆ–åŸºç¡€è®¾æ–½å±‚ï¼ˆinfrastructureï¼‰æ¥å®Œæˆä¸šåŠ¡é€»è¾‘
- å¯ä»¥æ ¹æ®éœ€è¦ï¼Œå°†å’Œå®ä½“å¼ºç›¸å…³çš„ä¸šåŠ¡é€»è¾‘ä¸‹æ²‰åˆ° **å®ä½“ç±»** ä¸­

æ¯”å¦‚ validSpace æ–¹æ³•å¯ä»¥ä¸‹æ²‰åˆ°å®ä½“ç±»ä¸­ï¼Œå› ä¸ºæ ¡éªŒé€»è¾‘ä¸æ¶‰åŠè°ƒç”¨æ•°æ®åº“ï¼Œæ˜¯å¯¹å®ä½“æœ¬èº«çš„æ ¡éªŒã€‚

éµå¾ªåŸåˆ™ç¼–å†™é¢†åŸŸæœåŠ¡å±‚çš„ä»£ç ï¼Œä»¥ SpaceDomainServiceImpl ä¸ºä¾‹ï¼š

```java
@Service
public class SpaceDomainServiceImpl extends ServiceImpl<SpaceMapper, Space> implements SpaceDomainService {
    
    /**
     * è·å–æŸ¥è¯¢æ¡ä»¶
     */
    @Override
    public QueryWrapper<Space> getQueryWrapper(SpaceQueryRequest spaceQueryRequest) {
        // ä¿ç•™åŸæœ‰å®ç°
    }

    @Override
    public void fillSpaceBySpaceLevel(Space space) {
        // ä¿®æ”¹çº§åˆ«æ—¶ï¼Œè‡ªåŠ¨å¡«å……æ•°æ®
        SpaceLevelEnum spaceLevelEnum = SpaceLevelEnum.getEnumByValue(space.getSpaceLevel());
        if (spaceLevelEnum != null) {
            long maxSize = spaceLevelEnum.getMaxSize();
            if (space.getMaxSize() == null) {
                space.setMaxSize(maxSize);
            }
            long maxCount = spaceLevelEnum.getMaxCount();
            if (space.getMaxCount() == null) {
                space.setMaxCount(maxCount);
            }
        }
    }

    /**
     * ç©ºé—´æƒé™æ ¡éªŒ
     *
     * @param loginUser
     * @param space
     */
    @Override
    public void checkSpaceAuth(User loginUser, Space space) {
        // ä¿ç•™åŸæœ‰å®ç°
    }
}
```

å…¶å®ä¸Šè¿°ä»£ç ä¸­ï¼Œè¿˜å¯ä»¥è¿›ä¸€æ­¥å°†æ–¹æ³•ä¸‹æ²‰åˆ°å®ä½“ç±»ä¸­å“¦ï¼Œåº”è¯¥ä¸‹æ²‰å“ªä¸ªæ–¹æ³•å‘¢ï¼Ÿ

ğŸ’¡ å°æŠ€å·§

1. ä¿®æ”¹é¢†åŸŸæœåŠ¡æ—¶ï¼Œå¦‚æœå‘ç°æŸä¸ªæ–¹æ³•æ²¡è¢« application è°ƒç”¨ï¼ˆIDE æ˜¾ç¤ºç°è‰²ï¼‰ï¼Œå°±å¯ä»¥ç›´æ¥ç§»é™¤æ‰ã€‚
2. å¦‚æœæƒ³èŠ‚çœé‡å¤ç¼–å†™å¢åˆ æ”¹æŸ¥ç­‰æ ·æ¿ä»£ç çš„æ—¶é—´ï¼Œåº”ç”¨æœåŠ¡æˆ–é¢†åŸŸæœåŠ¡ä¹Ÿå¯ä»¥ç›´æ¥ç»§æ‰¿ MyBatis Plus çš„æ¥å£å’Œå®ç°ç±»ï¼Œè¿™æ ·è™½ç„¶ DDD ç›®å½•ç»“æ„ä¸æ˜¯ 100% æ ‡å‡†ï¼Œä½†æ˜¯èƒ½å¤§å¹…å‡å°‘å¼€å‘æˆæœ¬ã€‚

#### 4ã€é‡æ„ Controller

1ï¼‰é¦–å…ˆå°†åŸå§‹çš„ç©ºé—´ç›¸å…³çš„ 3 ä¸ª Controller ç§»åŠ¨åˆ° `interfaces.controller` åŒ…ä¸­ã€‚

2ï¼‰ä¸ºä¿è¯æ¥å£å±‚çš„ç²¾ç®€ï¼Œéœ€è¦å°†å…¶ä¸­çš„ä»£ç ä¸‹æ²‰åˆ° **è½¬æ¢ç±»å’Œåº”ç”¨æœåŠ¡** ä¸­ã€‚é¦–å…ˆç¼–å†™è½¬æ¢ç±» `interfaces.assembler.SpaceAssembler` å’Œ `SpaceUserAssembler`ï¼Œè´Ÿè´£å°† DTO è½¬ä¸ºå®ä½“ç±»ï¼š

```java
public class SpaceAssembler {

    public static Space toSpaceEntity(SpaceAddRequest request) {
        Space space = new Space();
        BeanUtils.copyProperties(request, space);
        return space;
    }

    public static Space toSpaceEntity(SpaceUpdateRequest request) {
        Space space = new Space();
        BeanUtils.copyProperties(request, space);
        return space;
    }

    public static Space toSpaceEntity(SpaceEditRequest request) {
        Space space = new Space();
        BeanUtils.copyProperties(request, space);
        return space;
    }
}
public class SpaceUserAssembler {

    public static SpaceUser toSpaceUserEntity(SpaceUserAddRequest request) {
        SpaceUser spaceUser = new SpaceUser();
        BeanUtils.copyProperties(request, spaceUser);
        return spaceUser;
    }

    public static SpaceUser toSpaceUserEntity(SpaceUserEditRequest request) {
        SpaceUser spaceUser = new SpaceUser();
        BeanUtils.copyProperties(request, spaceUser);
        return spaceUser;
    }
}
```

3ï¼‰å°† Controller çš„ä»£ç ä¸‹æ²‰åˆ°åº”ç”¨æœåŠ¡ä¸­ï¼Œè°ƒç”¨åº”ç”¨æœåŠ¡å’Œ Assembler æ¥å¤„ç†è¯·æ±‚ï¼Œå¯èƒ½ä¼šæ¶‰åŠåˆ°åº”ç”¨æœåŠ¡æ–¹æ³•çš„å‚æ•°ä¿®æ”¹ã€‚å…¶ä¸­ updateSpaceã€editSpace æ˜¯æ”¹é€ çš„é‡ç‚¹ï¼Œéœ€è¦è°ƒç”¨ Assembler å’Œåº”ç”¨æœåŠ¡å±‚å®ŒæˆåŠŸèƒ½ï¼Œä¸‹é¢åªåˆ—ä¸¾ä¿®æ”¹çš„å…³é”®ä»£ç ï¼š

```java
@RestController
@RequestMapping("/space")
@Slf4j
public class SpaceController {

    @Resource
    private SpaceApplicationService spaceApplicationService;

    @Resource
    private UserApplicationService userApplicationService;

    @Resource
    private SpaceUserAuthManager spaceUserAuthManager;

    // region å¢åˆ æ”¹æŸ¥

    /**
     * åˆ›å»ºç©ºé—´
     */
    @PostMapping("/add")
    public BaseResponse<Long> addSpace(@RequestBody SpaceAddRequest spaceAddRequest, HttpServletRequest request) {
        // å¡«å……é»˜è®¤å€¼
        User loginUser = userApplicationService.getLoginUser(request);
        // è¿”å›æ–°å†™å…¥çš„æ•°æ® id
        long newSpaceId = spaceApplicationService.addSpace(spaceAddRequest, loginUser);
    }

    /**
     * åˆ é™¤ç©ºé—´
     */
    @PostMapping("/delete")
    public BaseResponse<Boolean> deleteSpace(@RequestBody DeleteRequest deleteRequest, HttpServletRequest request) {
        User loginUser = userApplicationService.getLoginUser(request);
        long id = deleteRequest.getId();
        // åˆ¤æ–­æ˜¯å¦å­˜åœ¨
        Space oldSpace = spaceApplicationService.getById(id);
        ThrowUtils.throwIf(oldSpace == null, ErrorCode.NOT_FOUND_ERROR);
        // ä»…æœ¬äººæˆ–ç®¡ç†å‘˜å¯åˆ é™¤
        spaceApplicationService.checkSpaceAuth(loginUser, oldSpace);
        // æ“ä½œæ•°æ®åº“
        boolean result = spaceApplicationService.removeById(id);
    }

    /**
     * æ›´æ–°ç©ºé—´ï¼ˆä»…ç®¡ç†å‘˜å¯ç”¨ï¼‰
     */
    @PostMapping("/update")
    @AuthCheck(mustRole = UserConstant.ADMIN_ROLE)
    public BaseResponse<Boolean> updateSpace(@RequestBody SpaceUpdateRequest spaceUpdateRequest) {
        // å°†å®ä½“ç±»å’Œ DTO è¿›è¡Œè½¬æ¢
        Space space = SpaceAssembler.toSpaceEntity(spaceUpdateRequest);
        // è‡ªåŠ¨å¡«å……æ•°æ®
        spaceApplicationService.fillSpaceBySpaceLevel(space);
        // æ•°æ®æ ¡éªŒ
        space.validSpace(false);
        // åˆ¤æ–­æ˜¯å¦å­˜åœ¨
        long id = spaceUpdateRequest.getId();
        Space oldSpace = spaceApplicationService.getById(id);
        ThrowUtils.throwIf(oldSpace == null, ErrorCode.NOT_FOUND_ERROR);
        // æ“ä½œæ•°æ®åº“
        boolean result = spaceApplicationService.updateById(space);
    }


    /**
     * æ ¹æ® id è·å–ç©ºé—´ï¼ˆä»…ç®¡ç†å‘˜å¯ç”¨ï¼‰
     */
    @GetMapping("/get")
    @AuthCheck(mustRole = UserConstant.ADMIN_ROLE)
    public BaseResponse<Space> getSpaceById(long id, HttpServletRequest request) {
        // æŸ¥è¯¢æ•°æ®åº“
        Space space = spaceApplicationService.getById(id);
    }

    /**
     * æ ¹æ® id è·å–ç©ºé—´ï¼ˆå°è£…ç±»ï¼‰
     */
    @GetMapping("/get/vo")
    public BaseResponse<SpaceVO> getSpaceVOById(long id, HttpServletRequest request) {
        // æŸ¥è¯¢æ•°æ®åº“
        Space space = spaceApplicationService.getById(id);
        ThrowUtils.throwIf(space == null, ErrorCode.NOT_FOUND_ERROR);
        SpaceVO spaceVO = spaceApplicationService.getSpaceVO(space, request);
        User loginUser = userApplicationService.getLoginUser(request);
    }

    /**
     * åˆ†é¡µè·å–ç©ºé—´åˆ—è¡¨ï¼ˆä»…ç®¡ç†å‘˜å¯ç”¨ï¼‰
     */
    @PostMapping("/list/page")
    @AuthCheck(mustRole = UserConstant.ADMIN_ROLE)
    public BaseResponse<Page<Space>> listSpaceByPage(@RequestBody SpaceQueryRequest spaceQueryRequest) {
        // æŸ¥è¯¢æ•°æ®åº“
        Page<Space> spacePage = spaceApplicationService.page(new Page<>(current, size),
                spaceApplicationService.getQueryWrapper(spaceQueryRequest));
    }

    /**
     * åˆ†é¡µè·å–ç©ºé—´åˆ—è¡¨ï¼ˆå°è£…ç±»ï¼‰
     */
    @PostMapping("/list/page/vo")
    public BaseResponse<Page<SpaceVO>> listSpaceVOByPage(@RequestBody SpaceQueryRequest spaceQueryRequest,
                                                         HttpServletRequest request) {
        // æŸ¥è¯¢æ•°æ®åº“
        Page<Space> spacePage = spaceApplicationService.page(new Page<>(current, size),
                spaceApplicationService.getQueryWrapper(spaceQueryRequest));
        // è·å–å°è£…ç±»
        return ResultUtils.success(spaceApplicationService.getSpaceVOPage(spacePage, request));
    }

    /**
     * ç¼–è¾‘ç©ºé—´ï¼ˆç»™ç”¨æˆ·ä½¿ç”¨ï¼‰
     */
    @PostMapping("/edit")
    public BaseResponse<Boolean> editSpace(@RequestBody SpaceEditRequest spaceEditRequest, HttpServletRequest request) {
        // åœ¨æ­¤å¤„å°†å®ä½“ç±»å’Œ DTO è¿›è¡Œè½¬æ¢
        Space space = SpaceAssembler.toSpaceEntity(spaceEditRequest);
        // è®¾ç½®ç¼–è¾‘æ—¶é—´
        space.setEditTime(new Date());
        // æ•°æ®æ ¡éªŒ
        space.validSpace(false);
        User loginUser = userApplicationService.getLoginUser(request);
        // åˆ¤æ–­æ˜¯å¦å­˜åœ¨
        long id = spaceEditRequest.getId();
        Space oldSpace = spaceApplicationService.getById(id);
        ThrowUtils.throwIf(oldSpace == null, ErrorCode.NOT_FOUND_ERROR);
        // ä»…æœ¬äººæˆ–ç®¡ç†å‘˜å¯ç¼–è¾‘
        spaceApplicationService.checkSpaceAuth(loginUser, oldSpace);
        // æ“ä½œæ•°æ®åº“
        boolean result = spaceApplicationService.updateById(space);
    }

    // endregion

    /**
     * æŸ¥è¯¢ç©ºé—´çº§åˆ«åˆ—è¡¨
     */
    @GetMapping("/list/level")
    public BaseResponse<List<SpaceLevel>> listSpaceLevel() {
        // ä¿ç•™åŸæœ‰å®ç°
    }

}
```

è¿™æ ·ä¸€æ¥ï¼Œæ¥å£çš„ä»£ç æ›´åŠ ç²¾ç®€ã€‚å…¶å®è¿˜å¯ä»¥è¿›ä¸€æ­¥è§„èŒƒ DDD çš„æ¶æ„ï¼Œæ¯”å¦‚ä¸Šé¢æœ‰çš„æ–¹æ³•çš„å®ç°è¿˜å¯ä»¥è¿›ä¸€æ­¥ä¸‹æ²‰ï¼Œæ˜¯å“ªäº›æ–¹æ³•å‘¢ï¼Ÿ

ğŸ’¡ å‰é¢ä¹Ÿæåˆ°äº†ï¼Œå¦‚æœè§‰å¾—ä¸€å±‚ä¸€å±‚è¡¥å……è°ƒç”¨æ–¹æ³•è¿‡äºéº»çƒ¦ï¼Œå¯ä»¥ç›´æ¥ç»™åº”ç”¨æœåŠ¡æˆ–é¢†åŸŸæœåŠ¡ç»§æ‰¿ MyBatis Plus çš„ IService å’Œ ServiceImplï¼Œä¾¿äºä¸Šä¸€å±‚è°ƒç”¨ã€‚

#### 5ã€å…¶ä»–ä»£ç å…¼å®¹

å°è¯•å¯åŠ¨é¡¹ç›®ï¼Œå¯èƒ½ä¼šå‡ºç°ç¼–è¯‘é”™è¯¯ï¼Œæˆ‘ä»¬æ ¹æ®æŠ¥é”™æç¤ºä¾æ¬¡è§£å†³å³å¯ã€‚

æœ€ç»ˆï¼Œå°è¯•å¯åŠ¨é¡¹ç›®ï¼Œåªè¦ä¸æŠ¥ç¼–è¯‘é”™è¯¯ï¼Œå°±ç®—æ˜¯é‡æ„å®Œæˆäº†ï¼Œå³ä½¿é¡¹ç›®å¯åŠ¨ä¸èµ·æ¥ä¹Ÿä¸ç”¨åœ¨æ„ï¼Œå› ä¸ºæˆ‘ä»¬æœ‰äº›æœåŠ¡è¿˜æ²¡æœ‰é‡æ„å®Œã€‚

### å…¬å…±æœåŠ¡

ç°åœ¨åªå‰©ä¸‹å…¬å…±æœåŠ¡ manager åŒ…çš„ä»£ç æ²¡æœ‰æ‹†åˆ†äº†ï¼Œæ¥ä¸‹æ¥çš„ç›®æ ‡å°±æ˜¯å¯¹ manager åŒ…çš„ä»£ç è¿›è¡Œé‡æ„ã€‚

é‡æ„å‰ï¼Œæˆ‘ä»¬è¦å…ˆç†è§£å…¬å…±æœåŠ¡çš„æœ¬è´¨ï¼š

- è·¨é¢†åŸŸï¼šå…¬å…±æœåŠ¡é€šå¸¸é€‚ç”¨äºå¤šä¸ªé¢†åŸŸï¼Œå¦‚é‰´æƒã€æ—¥å¿—ã€é€šçŸ¥ç­‰ã€‚
- å¯å¤ç”¨æ€§ï¼šä¸åº”è¯¥ç»‘å®šåˆ°å•ä¸€çš„é¢†åŸŸæ¨¡å‹æˆ–ç”¨ä¾‹ã€‚
- æ— ä¸šåŠ¡å«ä¹‰ï¼šä¸å…·ä½“çš„ä¸šåŠ¡æ— å…³ï¼Œä»…æä¾›é€šç”¨çš„æŠ€æœ¯èƒ½åŠ›ã€‚

æ³¨æ„ï¼Œå…·ä½“æƒ…å†µå…·ä½“åˆ†æï¼Œå¦‚æœæŸä¸ªæœåŠ¡è¢«å„ä¸ªé¢†åŸŸæˆ–åº”ç”¨è°ƒç”¨ï¼Œé‚£ä¹ˆå®ƒä¹Ÿä¸èƒ½å’Œä»»ä½•ä¸€ä¸ªé¢†åŸŸç»‘å®šï¼Œå¤„ç†æ–¹å¼ä¹Ÿå¯ä»¥å’Œå…¬å…±æœåŠ¡ç±»ä¼¼ã€‚

å»ºè®®æ ¹æ®æœåŠ¡ **å’Œä¸šåŠ¡çš„ç»“åˆç¨‹åº¦**ï¼ˆé€šç”¨ç¨‹åº¦ï¼‰å†³å®šå°† manager åŒ…çš„ä»£ç ç§»åŠ¨åˆ°å“ªä¸ªä½ç½®ã€‚å¦‚æœå…¬å…±æœåŠ¡ä¸ä¾èµ–å…¶ä»–é¢†åŸŸæˆ–åº”ç”¨æœåŠ¡ï¼Œå¯ä»¥æ”¾åˆ° `infrastructure.common` åŒ…ä¸­ï¼›ä½†å¦‚æœä¾èµ–è¿™äº›æœåŠ¡ï¼Œå¯ä»¥æ”¾åˆ°æ ¹åŒ…ä¸‹çš„ `shared` åŒ…ä¸­ï¼Œä»¥ä¾›æ‰€æœ‰å±‚ä½¿ç”¨ã€‚è¿™ç§æ–¹å¼èƒ½æ›´å¥½åœ°æ”¯æŒæ¨¡å—åŒ–ç®¡ç†å’Œè§£è€¦ã€‚

å›å½’åˆ°æœ¬é¡¹ç›®ï¼Œæ­¥éª¤å¦‚ä¸‹ï¼š

1. å¯ä»¥å…ˆå°† `model.dto.file` å’Œ `FileManager` ç§»åŠ¨åˆ° `manager.upload` åŒ…ä¸­ï¼Œç”±äºè¯¥åŒ…ä¸ä¾èµ–ä»»ä½•åº”ç”¨æœåŠ¡ï¼Œå¯ä»¥ç›´æ¥ç§»åŠ¨åˆ° `infrastructure.manager` åŒ…ä¸­ï¼Œä½œä¸ºåŸºç¡€è®¾æ–½ã€‚
2. authã€websocketã€sharding åŒ…ä¾èµ–å¤šä¸ªåº”ç”¨æœåŠ¡ï¼ˆæˆ–è€…å’Œå¤šä¸ªé¢†åŸŸé€»è¾‘ç›¸å…³ï¼‰ï¼Œå› æ­¤å°†è¿™äº› â€œå…¬å…±æœåŠ¡â€ ä½œä¸ºç‹¬ç«‹çš„ `shared` åŒ…ï¼Œæ”¾åˆ°æ ¹åŒ…ä¸‹ã€‚

### å‰©ä½™ä»£ç 

å¯¹å…¶ä»–å‰©ä½™ä»£ç è¿›è¡Œæ•´ç†ï¼Œæ¯”å¦‚å°† FileControllerã€MainController ç­‰ä»£ç ç§»åŠ¨åˆ°æ–°çš„ controller åŒ…ä¸­ã€‚

**é‡æ„å®Œæˆåï¼Œæ³¨æ„å°†ä»£ç ä¸­çš„åŸåŒ…åå…¨éƒ¨æ”¹ä¸ºæ–°çš„åŒ…åã€‚**æ¯”å¦‚ Mapper æ‰«æè·¯å¾„ã€é…ç½®æ–‡ä»¶æŒ‡å®šçš„åˆ†åº“åˆ†è¡¨ç®—æ³•è·¯å¾„ã€æ¥å£æ–‡æ¡£è·¯å¾„ç­‰ã€‚

## äº”ã€æ€»ç»“

é€šè¿‡ä¸Šè¿° DDD ç†è®ºçš„å­¦ä¹ ï¼Œä»¥åŠé¡¹ç›®é‡æ„å®æˆ˜ï¼Œç›¸ä¿¡å¤§å®¶å·²ç»å¯¹ DDD æœ‰äº†ä¸€å®šçš„ç†è§£ã€‚å»ºè®®å¤§å®¶å…ˆå›é¡¾ä¸€ä¸‹é±¼çš®åˆ†äº«çš„é‡æ„æ–¹æ³•ï¼ˆæ ¹æ®ç°æœ‰ä»£ç æ‹†åˆ† + é€ä¸ªé¢†åŸŸæ‹†åˆ† + åˆ©ç”¨å¥½ IDE é‡æ„ + æ–¹æ³•ä¸‹æ²‰ï¼‰ï¼Œç„¶åè‡ªå·±è·Ÿç€æ•™ç¨‹å®æ“ä¸€é DDD é‡æ„ï¼Œå¹¶ä¸”å¯ä»¥å°è¯•è¿›ä¸€æ­¥å¯¹å›¾ç‰‡é¢†åŸŸå’Œç©ºé—´é¢†åŸŸè¿›è¡Œæ‹†åˆ†ã€‚

ä½†å…¶å®å¤§å®¶åº”è¯¥ä¹Ÿæ„Ÿå—åˆ°äº†ï¼Œå…¶å® DDD å¹¶ä¸æ˜¯å¤šä¹ˆâ€œé«˜å¤§ä¸Šâ€çš„çŸ¥è¯†ï¼Œæœ‰ç‚¹ç±»ä¼¼äºåœ¨ä¼ ç»Ÿåˆ†å±‚æ¶æ„çš„åŸºç¡€ä¸Šå¤šå¢åŠ äº†ä¸€å±‚ â€œåº”ç”¨æœåŠ¡å±‚â€ï¼Œå¯¹äºéå¤§å‹é¡¹ç›®æ¥è¯´ï¼Œåè€Œå¢åŠ äº†é¢å¤–çš„ç¼–ç ã€‚å› æ­¤è™½ç„¶å¤§å®¶å­¦ä¼šäº† DDDï¼Œå®é™…çš„åº”ç”¨åœºæ™¯ä¹Ÿå¹¶ä¸å¤šï¼Œä¸€å®šè¦æŒ‰éœ€ä½¿ç”¨ã€‚

è‡³æ­¤ï¼Œæœ¬é¡¹ç›®çš„ç¼–ç éƒ¨åˆ†å…¨éƒ¨å®Œæˆï¼Œä¹‹åæˆ‘ä»¬å°±å°†æœ¬é¡¹ç›®éƒ¨ç½²ä¸Šçº¿ã€‚
